class BaseVisualizer{constructor(t=null,e={}){if(this.constructor===BaseVisualizer)throw new Error("BaseVisualizer is abstract and cannot be instantiated directly");this.config={backgroundColor:"#000000",sensitivity:1,smoothing:.8,debug:!1,force2d:!0,style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"-1"},...e},t instanceof HTMLCanvasElement?this.canvas=t:(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),Object.assign(this.canvas.style,this.config.style)),this.width=window.innerWidth,this.height=window.innerHeight,this.dpr=1,this.config.force2d?(this.gl=null,this.ctx=this.canvas.getContext("2d")):(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.ctx=this.gl?null:this.canvas.getContext("2d")),this.animationId=null,this.isAnimating=!1,this.overlayCanvases=new Map,this.nextOverlayZIndex=1,this.currentAudioData=null,this.previousAudioData=null,this.smoothedAmplitude=0,this.smoothedBands={low:0,mid:0,high:0},this.fps=0,this.lastFrameTime=performance.now(),this.boundResize=this.resizeCanvas.bind(this),window.addEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",this.boundResize),this.setupCanvas(),this.init()}setupCanvas(){let t,e;"undefined"!=typeof window&&window.visualViewport?(t=window.visualViewport.width,e=window.visualViewport.height):(t=window.innerWidth,e=window.innerHeight),this.width=t,this.height=e,this.canvas.width=t*this.dpr,this.canvas.height=e*this.dpr,this.gl?this.gl.viewport(0,0,this.canvas.width,this.canvas.height):(this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr))}resizeCanvas(){this.setupCanvas();for(let[t,e]of this.overlayCanvases)this._resizeOverlayCanvas(e);"function"==typeof this.onResize&&this.onResize()}createOverlay(t,e=null){if(this.overlayCanvases.has(t))return this.overlayCanvases.get(t);const i=document.createElement("canvas");i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.zIndex=null!==e?e:this.nextOverlayZIndex++,i.style.pointerEvents="none",document.body.appendChild(i);const s=i.getContext("2d");this._resizeOverlayCanvas({canvas:i,ctx:s});const n={canvas:i,ctx:s};return this.overlayCanvases.set(t,n),n}getOverlay(t){return this.overlayCanvases.get(t)||null}removeOverlay(t){const e=this.overlayCanvases.get(t);e&&(e.canvas&&e.canvas.parentNode&&e.canvas.parentNode.removeChild(e.canvas),this.overlayCanvases.delete(t))}_resizeOverlayCanvas(t){const e=window.devicePixelRatio||1;t.canvas.width=this.width*e,t.canvas.height=this.height*e,t.ctx.setTransform(1,0,0,1,0,0),t.ctx.scale(e,e)}async init(){}update(t){t&&(this.previousAudioData=this.currentAudioData,this.currentAudioData=t,"function"==typeof this.onUpdate&&this.onUpdate(t))}render(){this.gl?(this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)):this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)),"function"==typeof this.onRender&&this.onRender(),this.config.debug&&this.renderDebug()}renderDebug(){const t=performance.now();if(this.fps=1e3/(t-this.lastFrameTime),this.lastFrameTime=t,this.ctx)for(const t in this.currentAudioData){this.ctx.fillStyle="#00ff00",this.ctx.font="12px Arial";let e=this.currentAudioData[t]??0;"number"==typeof e&&(e=e.toFixed(3),this.ctx.fillText(`${t}: ${e}`,10,20+16*Object.keys(this.currentAudioData).indexOf(t)))}}tracedObjects=[];async loadTracedObjects(t){this.tracedObjects=[];const e=t.map(t=>new Promise((e,i)=>{if(t instanceof File){const s=new FileReader;s.onload=t=>{try{const i=JSON.parse(t.target.result);this.tracedObjects.push(...this._normalizeShapesArray(i)),e()}catch(t){i(t)}},s.onerror=i,s.readAsText(t)}else"string"==typeof t?fetch(t).then(t=>t.json()).then(t=>{this.tracedObjects.push(...this._normalizeShapesArray(t)),e()}).catch(i):i(new Error("Unsupported type for traced object"))}));return Promise.all(e)}_normalizeShapesArray(t){return t.map(t=>{const e=[...t.points,...t.holes.flatMap(t=>t.points)],i=e.map(t=>t[0]),s=e.map(t=>t[1]),n=Math.min(...i),a=Math.max(...i),o=Math.min(...s),h=a-n||1,r=Math.max(...s)-o||1,l=n+h/2,c=o+r/2,d=1/Math.max(h,r),v=t=>t.map(([t,e])=>[(t-l)*d,(e-c)*d]);return{name:t.name||null,points:v(t.points),holes:t.holes.map(t=>({name:t.name||null,points:v(t.points)}))}})}drawTracedObject(t,e,i,s,n,a="rgba(255,165,0,0.5)",o="#ff9900"){if(!this.tracedObjects||e>=this.tracedObjects.length)return;const h=this.tracedObjects[e];this.drawTracedShape(t,h,i,s,n,a,o)}drawTracedShape(t,e,i,s,n,a=null,o="rgba(255,165,0,1)",h="#ff9900"){t.beginPath();const r=e.points.map(([t,e])=>[i+t*n,s+e*n]);if(r.length>0){t.moveTo(r[0][0],r[0][1]);for(let e=1;e<r.length;e++)t.lineTo(r[e][0],r[e][1]);t.closePath()}for(const o of e.holes){const e=a?.[o.name]??1,h=o.points.map(([t,a])=>[i+t*n*e,s+a*n*e]);if(h.length>0){t.moveTo(h[0][0],h[0][1]);for(let e=1;e<h.length;e++)t.lineTo(h[e][0],h[e][1]);t.closePath()}}t.fillStyle=o,t.fill("evenodd"),t.strokeStyle=h,t.lineWidth=2,t.stroke()}start(){if(this.isAnimating)return;this.isAnimating=!0;const t=()=>{this.isAnimating&&(this.render(),this.animationId=requestAnimationFrame(t))};t()}stop(){this.isAnimating=!1,this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null}destroy(){this.stop(),window.removeEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",this.boundResize),this.ctx&&this.ctx.clearRect(0,0,this.width,this.height),this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(let[t,e]of this.overlayCanvases)e.canvas&&e.canvas.parentNode&&e.canvas.parentNode.removeChild(e.canvas);this.overlayCanvases.clear(),document.body.removeChild(this.canvas),document.querySelector("body").style.overflow="hidden"}lerp(t,e,i){return t+(e-t)*i}map(t,e,i,s,n){return(t-e)*(n-s)/(i-e)+s}constrain(t,e,i){return Math.min(Math.max(t,e),i)}drawText(t,e,i,s="#fff"){this.ctx&&(this.ctx.fillStyle=s,this.ctx.fillText(t,e,i))}}