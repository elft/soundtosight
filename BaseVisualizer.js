class BaseVisualizer{constructor(t=null,i={}){if(this.constructor===BaseVisualizer)throw new Error("BaseVisualizer is abstract and cannot be instantiated directly");this.config={backgroundColor:"#000000",sensitivity:1,smoothing:.8,debug:!1,force2d:!0,style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"-1"},...i},t instanceof HTMLCanvasElement?this.canvas=t:(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),Object.assign(this.canvas.style,this.config.style)),this.width=window.innerWidth,this.height=window.innerHeight,this.dpr=1,this.config.force2d?(this.gl=null,this.ctx=this.canvas.getContext("2d")):(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.ctx=this.gl?null:this.canvas.getContext("2d")),this.animationId=null,this.isAnimating=!1,this.overlayCanvases=new Map,this.nextOverlayZIndex=1,this.currentAudioData=null,this.previousAudioData=null,this.mediaDuration=null,this.mediaTime=null,this.smoothedAmplitude=0,this.smoothedBands={low:0,mid:0,high:0},this.fps=0,this.lastFrameTime=performance.now(),this.boundResize=this.resizeCanvas.bind(this),window.addEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",this.boundResize),this.setupCanvas(),this.init()}setupCanvas(){let t,i;"undefined"!=typeof window&&window.visualViewport?(t=window.visualViewport.width,i=window.visualViewport.height):(t=window.innerWidth,i=window.innerHeight),this.width=t,this.height=i,this.canvas.width=t*this.dpr,this.canvas.height=i*this.dpr,this.gl?this.gl.viewport(0,0,this.canvas.width,this.canvas.height):(this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr))}resizeCanvas(){this.setupCanvas();for(let[t,i]of this.overlayCanvases)this._resizeOverlayCanvas(i);"function"==typeof this.onResize&&this.onResize()}createOverlay(t,i=null){if(this.overlayCanvases.has(t))return this.overlayCanvases.get(t);const e=document.createElement("canvas");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex=null!==i?i:this.nextOverlayZIndex++,e.style.pointerEvents="none",document.body.appendChild(e);const s=e.getContext("2d");this._resizeOverlayCanvas({canvas:e,ctx:s});const n={canvas:e,ctx:s};return this.overlayCanvases.set(t,n),n}removeOverlay(t){const i=this.overlayCanvases.get(t);i&&(i.canvas&&i.canvas.parentNode&&i.canvas.parentNode.removeChild(i.canvas),this.overlayCanvases.delete(t))}_resizeOverlayCanvas(t){t.canvas.width=1*this.width,t.canvas.height=1*this.height,t.ctx.setTransform(1,0,0,1,0,0),t.ctx.scale(1,1)}async init(){}update(t){t&&(this.previousAudioData=this.currentAudioData,this.currentAudioData=t,this.mediaDuration=Number.isFinite(t?.mediaDuration)?t.mediaDuration:null,this.mediaTime=Number.isFinite(t?.mediaTime)?t.mediaTime:null,"function"==typeof this.onUpdate&&this.onUpdate(t))}render(){this.gl?(this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)):this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)),"function"==typeof this.onRender&&this.onRender(),this.config.debug&&this.renderDebug()}renderDebug(){const t=performance.now();if(this.fps=1e3/(t-this.lastFrameTime),this.lastFrameTime=t,this.ctx)for(const t in this.currentAudioData){this.ctx.fillStyle="#00ff00",this.ctx.font="12px Arial";let i=this.currentAudioData[t]??0;"number"==typeof i&&(i=i.toFixed(3),this.ctx.fillText(`${t}: ${i}`,10,20+16*Object.keys(this.currentAudioData).indexOf(t)))}}start(){if(this.isAnimating)return;this.isAnimating=!0;const t=()=>{this.isAnimating&&(this.render(),this.animationId=requestAnimationFrame(t))};t()}stop(){this.isAnimating=!1,this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null}destroy(){this.stop(),window.removeEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",this.boundResize),this.ctx&&this.ctx.clearRect(0,0,this.width,this.height),this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(let[t,i]of this.overlayCanvases)i.canvas&&i.canvas.parentNode&&i.canvas.parentNode.removeChild(i.canvas);this.overlayCanvases.clear(),document.body.removeChild(this.canvas),document.querySelector("body").style.overflow="hidden"}lerp(t,i,e){return t+(i-t)*e}map(t,i,e,s,n){return e===i?s:(t-i)*(n-s)/(e-i)+s}constrain(t,i,e){return Math.min(Math.max(t,i),e)}clamp(t,i,e){const s=Number.isFinite(t)?t:i;return this.constrain(s,i,e)}smooth(t,i,e=.1){const s=Number.isFinite(t)?t:0;return s+((Number.isFinite(i)?i:0)-s)*e}dbTo01(t,i=-60,e=0){const s=Number.isFinite(t)?t:i,n=e-i||1;return this.constrain((s-i)/n,0,1)}attackRelease(t=0,i=0,e=1/60,s=.04,n=.25){const a=Number.isFinite(t)?t:0,h=Number.isFinite(i)?i:0,o=h>a?s:n;return a+(h-a)*(1-Math.exp(-e/Math.max(1e-4,o)))}smoothstep(t,i,e){if(t===i)return i;const s=this.constrain((e-t)/(i-t),0,1);return s*s*(3-2*s)}}