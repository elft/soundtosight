class BaseVisualizer{constructor(t=null,i={}){if(this.constructor===BaseVisualizer)throw new Error("BaseVisualizer is abstract and cannot be instantiated directly");this.config={backgroundColor:"#000000",sensitivity:1,smoothing:.8,debug:!1,force2d:!0,style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"-1"},...i},t instanceof HTMLCanvasElement?this.canvas=t:(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),Object.assign(this.canvas.style,this.config.style)),this.width=window.innerWidth,this.height=window.innerHeight;const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);this.dpr=e?.5:window.devicePixelRatio||1,this.config.force2d?(this.gl=null,this.ctx=this.canvas.getContext("2d")):(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.ctx=this.gl?null:this.canvas.getContext("2d")),this.animationId=null,this.isAnimating=!1,this.overlayCanvases=new Map,this.nextOverlayZIndex=1,this.currentAudioData=null,this.previousAudioData=null,this.smoothedAmplitude=0,this.smoothedBands={low:0,mid:0,high:0},this.fps=0,this.lastFrameTime=performance.now(),this.boundResize=this.resizeCanvas.bind(this),window.addEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",this.boundResize),this.setupCanvas(),this.init()}setupCanvas(){let t,i;"undefined"!=typeof window&&window.visualViewport?(t=window.visualViewport.width,i=window.visualViewport.height):(t=window.innerWidth,i=window.innerHeight),this.width=t,this.height=i,this.canvas.width=t*this.dpr,this.canvas.height=i*this.dpr,this.gl?this.gl.viewport(0,0,this.canvas.width,this.canvas.height):(this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr))}resizeCanvas(){this.setupCanvas();for(let[t,i]of this.overlayCanvases)this._resizeOverlayCanvas(i);"function"==typeof this.onResize&&this.onResize()}createOverlay(t,i=null){if(this.overlayCanvases.has(t))return this.overlayCanvases.get(t);const e=document.createElement("canvas");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex=null!==i?i:this.nextOverlayZIndex++,e.style.pointerEvents="none",document.body.appendChild(e);const s=e.getContext("2d");this._resizeOverlayCanvas({canvas:e,ctx:s});const n={canvas:e,ctx:s};return this.overlayCanvases.set(t,n),n}getOverlay(t){return this.overlayCanvases.get(t)||null}removeOverlay(t){const i=this.overlayCanvases.get(t);i&&(i.canvas&&i.canvas.parentNode&&i.canvas.parentNode.removeChild(i.canvas),this.overlayCanvases.delete(t))}_resizeOverlayCanvas(t){const i=window.devicePixelRatio||1;t.canvas.width=this.width*i,t.canvas.height=this.height*i,t.ctx.setTransform(1,0,0,1,0,0),t.ctx.scale(i,i)}init(){}update(t){t&&(this.previousAudioData=this.currentAudioData,this.currentAudioData=t,"function"==typeof this.onUpdate&&this.onUpdate(t))}render(){this.gl?(this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)):this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)),"function"==typeof this.onRender&&this.onRender(),this.config.debug&&this.renderDebug()}renderDebug(){const t=performance.now();if(this.fps=1e3/(t-this.lastFrameTime),this.lastFrameTime=t,!this.ctx)return;const i=this.currentAudioData||{},e=(i.rms??0).toFixed(3),s=(i.bassEnergy??0).toFixed(3),n=(i.midEnergy??0).toFixed(3),a=(i.trebleEnergy??0).toFixed(3),h=(i.spectralFlux??0).toFixed(3),o=i.tempo??0,r=(i.beatPhase??0).toFixed(2),l=(i.stereoBalance??0).toFixed(2);this.ctx.fillStyle="red",this.ctx.fillText(`FPS: ${this.fps.toFixed(1)}`,10,20),this.ctx.fillText(`RMS: ${e}`,10,36),this.ctx.fillText(`Bass: ${s}`,10,52),this.ctx.fillText(`Mid: ${n}`,10,68),this.ctx.fillText(`Treble: ${a}`,10,84),this.ctx.fillText(`Flux: ${h}`,10,100),this.ctx.fillText(`Tempo: ${o} BPM`,10,116),this.ctx.fillText(`Phase: ${r}`,10,132),this.ctx.fillText(`Stereo: ${l}`,10,148)}start(){if(this.isAnimating)return;this.isAnimating=!0;const t=()=>{this.isAnimating&&(this.render(),this.animationId=requestAnimationFrame(t))};t()}stop(){this.isAnimating=!1,this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null}destroy(){this.stop(),window.removeEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",this.boundResize),this.ctx&&this.ctx.clearRect(0,0,this.width,this.height),this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(let[t,i]of this.overlayCanvases)i.canvas&&i.canvas.parentNode&&i.canvas.parentNode.removeChild(i.canvas);this.overlayCanvases.clear(),document.body.removeChild(this.canvas),document.querySelector("body").style.overflow="hidden"}lerp(t,i,e){return t+(i-t)*e}map(t,i,e,s,n){return(t-i)*(n-s)/(e-i)+s}constrain(t,i,e){return Math.min(Math.max(t,i),e)}drawText(t,i,e,s="#fff"){this.ctx&&(this.ctx.fillStyle=s,this.ctx.fillText(t,i,e))}}