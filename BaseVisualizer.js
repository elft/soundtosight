class BaseVisualizer{static meta={description:"Abstract base visualizer class",tags:[]};constructor(t=null,e={}){if(this.constructor===BaseVisualizer)throw new Error("BaseVisualizer is abstract and cannot be instantiated directly");this.config={backgroundColor:"#000000",sensitivity:1,smoothing:.8,debug:!1,force2d:!0,style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"-1"},...e},t instanceof HTMLCanvasElement?this.canvas=t:(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),Object.assign(this.canvas.style,this.config.style)),this.width=window.innerWidth,this.height=window.innerHeight,this.dpr=1,this.config.force2d?(this.gl=null,this.ctx=this.canvas.getContext("2d")):(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.ctx=this.gl?null:this.canvas.getContext("2d")),this.animationId=null,this.isAnimating=!1,this.overlayCanvases=new Map,this.nextOverlayZIndex=1,this.currentAudioData=null,this.previousAudioData=null,this.mediaDuration=null,this.mediaTime=null,this.smoothedAmplitude=0,this.smoothedBands={low:0,mid:0,high:0},this.fps=0,this.lastFrameTime=performance.now(),this.boundResize=this.resizeCanvas.bind(this),window.addEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",this.boundResize),this._initAudioTriggers(),this.setupCanvas(),this.init()}setupCanvas(){let t,e;"undefined"!=typeof window&&window.visualViewport?(t=window.visualViewport.width,e=window.visualViewport.height):(t=window.innerWidth,e=window.innerHeight),this.width=t,this.height=e,this.canvas.width=t*this.dpr,this.canvas.height=e*this.dpr,this.gl?this.gl.viewport(0,0,this.canvas.width,this.canvas.height):(this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr))}resizeCanvas(){this.setupCanvas();for(let[t,e]of this.overlayCanvases)this._resizeOverlayCanvas(e);"function"==typeof this.onResize&&this.onResize()}createOverlay(t,e=null){if(this.overlayCanvases.has(t))return this.overlayCanvases.get(t);const i=document.createElement("canvas");i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.zIndex=null!==e?e:this.nextOverlayZIndex++,i.style.pointerEvents="none",document.body.appendChild(i);const s=i.getContext("2d");this._resizeOverlayCanvas({canvas:i,ctx:s});const a={canvas:i,ctx:s};return this.overlayCanvases.set(t,a),a}removeOverlay(t){const e=this.overlayCanvases.get(t);e&&(e.canvas&&e.canvas.parentNode&&e.canvas.parentNode.removeChild(e.canvas),this.overlayCanvases.delete(t))}_resizeOverlayCanvas(t){t.canvas.width=1*this.width,t.canvas.height=1*this.height,t.ctx.setTransform(1,0,0,1,0,0),t.ctx.scale(1,1)}async init(){}update(t){t&&(this.previousAudioData=this.currentAudioData,this.currentAudioData=t,this._updateAudioCues(t),this.mediaDuration=Number.isFinite(t?.mediaDuration)?t.mediaDuration:null,this.mediaTime=Number.isFinite(t?.mediaTime)?t.mediaTime:null,"function"==typeof this.onUpdate&&this.onUpdate(t))}render(){this.gl?(this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)):this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)),"function"==typeof this.onRender&&this.onRender(),this.config.debug&&this.renderDebug()}renderDebug(){const t=performance.now();if(this.fps=1e3/(t-this.lastFrameTime),this.lastFrameTime=t,this.ctx)for(const t in this.currentAudioData){this.ctx.fillStyle="#00ff00",this.ctx.font="12px Arial";let e=this.currentAudioData[t]??0;"number"==typeof e&&(e=e.toFixed(3),this.ctx.fillText(`${t}: ${e}`,10,20+16*Object.keys(this.currentAudioData).indexOf(t)))}}start(){if(this.isAnimating)return;this.isAnimating=!0;const t=()=>{this.isAnimating&&(this.render(),this.animationId=requestAnimationFrame(t))};t()}stop(){this.isAnimating=!1,this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null}destroy(){this.stop(),window.removeEventListener("resize",this.boundResize),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",this.boundResize),this.ctx&&this.ctx.clearRect(0,0,this.width,this.height),this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(let[t,e]of this.overlayCanvases)e.canvas&&e.canvas.parentNode&&e.canvas.parentNode.removeChild(e.canvas);this.overlayCanvases.clear(),document.body.removeChild(this.canvas),document.querySelector("body").style.overflow="hidden"}lerp(t,e,i){return t+(e-t)*i}map(t,e,i,s,a){return i===e?s:(t-e)*(a-s)/(i-e)+s}constrain(t,e,i){return Math.min(Math.max(t,e),i)}clamp(t,e,i){const s=Number.isFinite(t)?t:e;return this.constrain(s,e,i)}smooth(t,e,i=.1){const s=Number.isFinite(t)?t:0;return s+((Number.isFinite(e)?e:0)-s)*i}dbTo01(t,e=-60,i=0){const s=Number.isFinite(t)?t:e,a=i-e||1;return this.constrain((s-e)/a,0,1)}attackRelease(t=0,e=0,i=1/60,s=.04,a=.25){const n=Number.isFinite(t)?t:0,r=Number.isFinite(e)?e:0,o=r>n?s:a;return n+(r-n)*(1-Math.exp(-i/Math.max(1e-4,o)))}_initAudioTriggers(){this.audioTriggers={dropStart:!1,dropBloom:!1,dropScore:0,melodyChange:!1,melodyChangeScore:0},this._cueState={prev:null,lastDropT:-1}}_updateAudioCues(t){if(!t)return;const e=t.time??.001*performance.now(),i=this._cueState.prev||t,s=(t.subBassEnergy??0)+(t.bassEnergy??0)-((i.subBassEnergy??0)+(i.bassEnergy??0)),a=(t.midSideRatio??0)-(i.midSideRatio??0),n=(i.interchannelCorrelation??0)-(t.interchannelCorrelation??0),r=(t.centroid??0)-(i.centroid??0),o=(t.spectralRolloff85??t.spectralRolloff95??0)-(i.spectralRolloff85??i.spectralRolloff95??0),h=(i.flatness??0)-(t.flatness??0),l=t.energyChangeIntensity??Math.abs((t.energy??0)-(i.energy??0)),d=.35*(t.isBeat?1:0)+6*Math.max(0,l-.035)*.25+3*Math.max(0,s)*.25+2*Math.max(0,(t.spectralFlux??0)-(i.spectralFlux??0))*.15,c=d>.65;c&&(this._cueState.lastDropT=e);const u=e-(this._cueState.lastDropT??-999),m=(u>=0&&u<=.5?1:0)*(2.5*Math.max(0,a)+1.5*Math.max(0,n))>.2,v=t.melodyChangeScore??.3*Math.max(0,r)+.25*Math.max(0,o)+.2*Math.max(0,h)+.25*Math.max(0,(t.spectralFlux??0)-(i.spectralFlux??0)),p=v>.85;this.audioTriggers={dropStart:c,dropBloom:m,dropScore:+d.toFixed(3),melodyChange:p,melodyChangeScore:+v.toFixed(3)},this._cueState.prev=t}smoothstep(t,e,i){if(t===e)return e;const s=this.constrain((i-t)/(e-t),0,1);return s*s*(3-2*s)}}