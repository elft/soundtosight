const PLAYER_ART_PLACEHOLDER_CLASS="player-artwork--empty",PLAYER_SOURCE_CONFIG={none:{label:"No source",icon:"ðŸŽµ"},file:{label:"Upload",icon:"ðŸ“"},mic:{label:"Microphone",icon:"ðŸŽ¤"},soundcloud:{label:"SoundCloud",icon:"â˜ï¸",iconImg:"./images/soundcloud.png"},demo:{label:"Demo track",icon:"ðŸŽ§"}};class VvavyApp{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.visualizerManifest=[],this.visualizerMetadataByName=new Map,this.canvas=null,this.fileInput=null,this.playPauseBtn=null,this.fileSelectBtn=null,this.visualizerSelect=null,this.visualSearchBar=null,this.visualizerSearchInput=null,this.visualizerSearchSummary=null,this.visualInfoSummary=null,this.visualSearchDropdown=null,this.visualizerSearchMatches=[],this.imageUploadBtn=null,this.sourcePickerBtn=null,this.playerDock=null,this.playerArtwork=null,this.playerArtworkWrapper=null,this.playerTitleEl=null,this.playerArtistEl=null,this.playerArtistPrefixEl=null,this.playerCurrentTimeEl=null,this.playerDurationEl=null,this.playerDurationWrapper=null,this.playerDurationDivider=null,this.playerSourceIndicatorIcon=null,this.currentTrackDurationMs=null,this.playerSourceIndicatorLabel=null,this.playerControlsToggle=null,this.playerControlsPanel=null,this.visualSearchToggleBtn=null,this.currentSourceType=null,this.visualSelectionGrid=null,this.sourceSelectionGrid=null,this.visualSelectionSection=null,this.sourceSelectionSection=null,this.selectionHubElement=null,this.visualCardElements=new Map,this.sourceCardElements=new Map,this._searchInitialized=!1,this.onboardingCompleted=!1,this.isPlaybackActive=!1,this.visualDropdownHideTimeout=null,this._dropdownBound=!1,this.selectionHubManual=!1,this.isSourceSelectionOpen=!1,this.visualSelectionTriggeredFromUI=!1,this.selectionHubDismissed=!1,this.selectionHubAutoHidden=!1,this.visualSearchPanelOpen=!1,this.playerControlsOpen=!1,this.handlePlayerControlsPointerDown=this.handlePlayerControlsPointerDown.bind(this),this.handlePlayerControlsKeydown=this.handlePlayerControlsKeydown.bind(this),this.handleSourceOutsidePointerDown=this.handleSourceOutsidePointerDown.bind(this),this.handleVisualSearchOutsidePointer=this.handleVisualSearchOutsidePointer.bind(this),this.emitVisualVisibilityEvent=this.emitVisualVisibilityEvent.bind(this),this.quickStartModal=null,this.quickStartCloseBtn=null,this.quickStartStartBtn=null,this.quickStartStatusEl=null,this.demoAudioPromise=null,this.storageKeys={onboarding:"vvavyOnboardingSeen",soundCloudToken:"vvavySoundCloudToken",soundCloudHistory:"vvavySoundCloudHistory",termsAccepted:"vvavyAccepted",termsVersion:"vvavyTermsVersion"},this.onboardingStorageKey=this.storageKeys.onboarding,this.termsVersionStorageKey=this.storageKeys.termsVersion,this.isInitialized=!1,this.currentVisualizerName=null,this.soundCloudModal=null,this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="",this.soundCloudTokenStorageKey=this.storageKeys.soundCloudToken,this.soundCloudTokenSafetyWindowMs=15e3,this.soundCloudTokenCache=null,this.soundCloudRecentTracksKey=this.storageKeys.soundCloudHistory,this.soundCloudHistoryCache=null,this.soundCloudHistoryLimit=20,this.init()}getStorageItem(e,t){if(!e||!Array.isArray(t))return null;for(const i of t)if(i)try{const t=e.getItem(i);if(null!==t)return t}catch(e){}return null}setStorageItem(e,t,i){if(e&&t)try{e.setItem(t,i)}catch(e){}}getBooleanStorageValue(e,t){return"true"===this.getStorageItem(e,t)}markTermsAccepted({version:e}={}){if(this.setStorageItem(localStorage,this.storageKeys.termsAccepted,"true"),e){const t=this.termsVersionStorageKey||"vvavyTermsVersion";this.setStorageItem(localStorage,t,String(e))}this.updateVisualSearchVisibility()}hasCompletedOnboarding(){return Boolean(this.onboardingCompleted)}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);const e=1024;await this.audioManager.init(e),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(e){}this.populateAvailableVisualizers(),this.setupVisualizerSearch(),this.setupEventListeners(),this.setupDragAndDrop(),await this.checkSoundCloudAvailability(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const t=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(t)){await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t),this.updateVisualizerSummaryForSelection(t),this.highlightActiveVisualizer(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName)}else if(this.availableVisualizers.size>0){const e=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e),this.updateVisualizerSummaryForSelection(e),this.highlightActiveVisualizer(e);const t=this.visualizerMetadataByName.get(e);t&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=t.displayName)}const i=this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted]);let a=!1;try{a="true"===this.getStorageItem(sessionStorage,[this.onboardingStorageKey])}catch(e){a=!1}i&&!a&&this.showGettingStartedOverlay(),a&&(this.onboardingCompleted=!0),this.isInitialized=!0,this.updateVisualSearchVisibility(),this.loadDemoAudioSilently()}catch(e){}}async checkSoundCloudAvailability(){try{const e=await fetch("/api/soundcloud/status",{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Status ${e.status}`);const t=await e.json(),i=Boolean(t?.enabled),a=t?.reason||"";this.soundCloudEnabled=i,this.soundCloudAvailabilityMessage=a;const s=i?"SoundCloud streaming is ready. Search for any track to jump straight into the visuals.":a||"Start the Vvavy server to enable SoundCloud integration.";this.setSourceAvailability("soundcloud",i,s)}catch(e){this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="Start the Vvavy server to enable SoundCloud integration.",this.setSourceAvailability("soundcloud",!1,this.soundCloudAvailabilityMessage)}}getCachedSoundCloudToken(){if(this.soundCloudTokenCache?.accessToken)return this.soundCloudTokenCache;try{const e=this.getStorageItem(sessionStorage,[this.soundCloudTokenStorageKey]);if(!e)return null;const t=JSON.parse(e);if(t&&"object"==typeof t&&t.accessToken)return this.soundCloudTokenCache=t,t}catch(e){}return null}storeSoundCloudToken(e){this.soundCloudTokenCache=e;const t=JSON.stringify(e);this.setStorageItem(sessionStorage,this.soundCloudTokenStorageKey,t)}clearSoundCloudToken(){this.soundCloudTokenCache=null;try{sessionStorage.removeItem(this.soundCloudTokenStorageKey)}catch(e){}}getSoundCloudHistory(){if(!Array.isArray(this.soundCloudHistoryCache)){let e=[];try{const t=this.getStorageItem(sessionStorage,[this.soundCloudRecentTracksKey]);if(t){const i=JSON.parse(t);Array.isArray(i)&&(e=i)}}catch(e){}this.soundCloudHistoryCache=e}return Array.isArray(this.soundCloudHistoryCache)?this.soundCloudHistoryCache.slice():[]}setSoundCloudHistory(e){const t=Array.isArray(e)?e.slice(0,this.soundCloudHistoryLimit):[];this.soundCloudHistoryCache=t;const i=JSON.stringify(t);if(this.setStorageItem(sessionStorage,this.soundCloudRecentTracksKey,i),this.soundCloudModal?.renderHistory)try{this.soundCloudModal.renderHistory(this.getSoundCloudHistory())}catch(e){}}rememberSoundCloudTrack(e){if(!e||"object"!=typeof e)return;const t=null!=e.id?String(e.id):"",i=e.permalinkUrl?String(e.permalinkUrl):"";if(!t&&!i)return;const a={id:t||null,permalinkUrl:i||null,title:e.title||"Untitled track",artist:e.author?.username||null,artworkUrl:e.artworkUrl||null,duration:"number"==typeof e.duration?e.duration:null,lastPlayed:Date.now()},s=this.getSoundCloudHistory().filter(e=>{if(!e||"object"!=typeof e)return!1;const t=a.id&&e.id&&String(e.id)===a.id,i=a.permalinkUrl&&e.permalinkUrl&&e.permalinkUrl===a.permalinkUrl;return!(t||i)});s.unshift(a),this.setSoundCloudHistory(s.slice(0,this.soundCloudHistoryLimit))}async getSoundCloudToken(e=!1){if(!e){const e=this.getCachedSoundCloudToken();if(e?.accessToken&&Number.isFinite(e.expiresAt)&&Date.now()+this.soundCloudTokenSafetyWindowMs<e.expiresAt)return e.accessToken}let t;try{t=await fetch("/api/soundcloud/token",{method:"GET",credentials:"same-origin"})}catch(e){throw new Error("Failed to contact SoundCloud token endpoint.")}if(!t?.ok){let e=`Token request failed (status ${t?.status??"unknown"})`;try{const i=await t.json();i?.error&&(e=i.error)}catch(e){}throw new Error(e)}let i=null;try{i=await t.json()}catch(e){throw new Error("Failed to parse SoundCloud token response.")}if(!i?.accessToken)throw new Error("SoundCloud token response did not include an access token.");const a=Number(i.expiresIn),s=Date.now()+(Number.isFinite(a)&&a>0?1e3*a:36e5),r={accessToken:i.accessToken,expiresAt:s};return this.storeSoundCloudToken(r),r.accessToken}buildSoundCloudUrl(e,t){const i=/^https?:\/\//i.test(e)?new URL(e):new URL(e,"https://api.soundcloud.com");return t&&"object"==typeof t&&Object.entries(t).forEach(([e,t])=>{if(null==t)return;const a=Array.isArray(t)?t:[t];i.searchParams.delete(e),a.forEach(t=>{const a=null==t?"":String(t);i.searchParams.append(e,a)})}),i.toString()}async performSoundCloudFetch(e,{method:t="GET",headers:i={},query:a,body:s,expectJson:r=!0}={},n=0){const o=this.buildSoundCloudUrl(e,a),l=await this.getSoundCloudToken(n>0),u={...i,Authorization:`Bearer ${l}`};r&&!u.Accept?u.Accept="application/json":r||u.Accept||(u.Accept="*/*");const d={method:t,headers:u,credentials:"omit"};let c;null!=s&&("object"!=typeof s||s instanceof Blob||s instanceof FormData?d.body=s:(d.body=JSON.stringify(s),d.headers["Content-Type"]||(d.headers["Content-Type"]="application/json")));try{c=await fetch(o,d)}catch(e){throw new Error(`SoundCloud request failed: ${e.message||e}`)}if(401===c.status&&0===n)return this.clearSoundCloudToken(),this.performSoundCloudFetch(e,{method:t,headers:i,query:a,body:s,expectJson:r},n+1);if(!c.ok){let e="";try{e=await c.text()}catch(t){e=""}const t=e?`: ${e}`:"";throw new Error(`SoundCloud request failed (${c.status})${t}`)}if(!r)return c;const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(e){throw new Error(`Failed to parse SoundCloud response: ${e.message}`)}}async fetchSoundCloudAPI(e,t={}){return this.performSoundCloudFetch(e,t)}sanitizeSoundCloudTrackId(e){if(null==e)return"";const t=String(e).trim();if(!t)return"";if(/^soundcloud:tracks:/i.test(t)){const e=t.split(":");return e[e.length-1]}return t}pickBestSoundCloudTranscoding(e){if(!Array.isArray(e)||!e.length)return null;const t=e.find(e=>"progressive"===e?.format?.protocol);return t||(e.find(e=>"hls"===e?.format?.protocol)||e[0])}selectPreferredStreamUrl(e){if(!e||"object"!=typeof e)return null;const t=[e.http_mp3_128_url,e.http_mp3_64_url,e.http_opus_64_url,e.hls_mp3_128_url,e.hls_mp3_64_url,e.hls_opus_64_url,e.hls_url,e.progressive_mp3_url,e.preview_mp3_128_url,e.url];for(const e of t)if(e&&"string"==typeof e)return e;return null}async fetchSoundCloudStreamData(e){if(!e?.id&&!this.sanitizeSoundCloudTrackId(e))throw new Error("Unable to determine SoundCloud track ID.");const t=[];e?.stream_url&&t.push(e.stream_url);let i=null;for(const e of t)if(e)try{const t=await this.fetchSoundCloudAPI(e,{expectJson:!1});if(!t){i=new Error("SoundCloud stream endpoint returned no response.");continue}const a=t.headers;if((a?.get&&a.get("content-type")||"").includes("application/json")){let e=null;try{e=await t.json()}catch(e){i=e}const a=this.selectPreferredStreamUrl(e);if(a)return{streamUrl:a,data:e};i=new Error("SoundCloud stream response did not include a usable URL.");continue}const s=()=>{try{t.body?.cancel?.()}catch(e){}},r=a?.get?a.get("location"):null;if(r)return s(),{streamUrl:r,data:null};if(t.url)return s(),{streamUrl:t.url,data:null};i=new Error("SoundCloud stream endpoint returned an unexpected response.")}catch(e){i=e}if(i)throw i;throw new Error("SoundCloud stream URL is unavailable.")}async fetchSoundCloudTrackById(e){const t=this.sanitizeSoundCloudTrackId(e);if(!t)throw new Error("Track ID is required.");const i=await this.fetchSoundCloudAPI("/tracks",{query:{ids:t}}),a=Array.isArray(i)?i:[];if(!a.length)throw new Error("Track not found on SoundCloud.");return a[0]}async fetchSoundCloudTranscodingUrl(e){if(!e)throw new Error("Transcoding URL is required.");return this.performSoundCloudFetch(e,{expectJson:!0})}openSoundCloudModal(){const e=this.ensureSoundCloudModal();e.form?.reset();const t=this.getSoundCloudHistory();if(e.setLoading?.(!1),e.sortedResults=[],e.nextHref=null,e.totalAvailable=0,e.currentPage=1,e.fetchingMorePromise=null,e.searchQuery="","function"==typeof e.renderResults&&e.renderResults([]),"function"==typeof e.updatePaginationControls&&e.updatePaginationControls(),"function"==typeof e.renderHistory)try{e.renderHistory(t)}catch(e){}e.hasSearched=!1,e.searchInProgress=!1,e.input&&(e.input.disabled=!1),e.cancel&&(e.cancel.disabled=!1),e.overlay.classList.add("active"),setTimeout(()=>{e.input?.focus()},60)}ensureSoundCloudModal(){if(this.soundCloudModal)return this.soundCloudModal;const e=document.createElement("div");e.className="soundcloud-overlay",e.innerHTML='\n            <div class="soundcloud-modal" role="dialog" aria-modal="true">\n                <div class="soundcloud-modal-content">\n                    <form class="soundcloud-modal-form">\n                        <label class="soundcloud-modal-label" for="soundcloudSearchInput">Search SoundCloud</label>\n                        <div class="soundcloud-modal-search-row">\n                            <input type="text" id="soundcloudSearchInput" class="soundcloud-modal-input" name="soundcloudSearch" placeholder="Search for artists, tracks, or genres" autocomplete="off" />\n                            <button type="submit" class="soundcloud-modal-search">Search</button>\n                        </div>\n                    </form>\n                    <div class="soundcloud-modal-body">\n                        <section class="soundcloud-modal-main" aria-label="SoundCloud search results">\n                            <div class="soundcloud-history-header">\n                                <h3>Search Results</h3>\n                            </div>\n                            <div class="soundcloud-modal-status" aria-live="polite"></div>\n                            <div class="soundcloud-modal-results" role="listbox" aria-label="SoundCloud search results"></div>\n                            <div class="soundcloud-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn prev" aria-label="Previous page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn next" aria-label="Next page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                        <section id="soundcloud-modal-history" class="soundcloud-modal-main" aria-label="Recently played SoundCloud tracks">\n                            <div class="soundcloud-history-header">\n                                <h3>Recently Played</h3>\n                            </div>\n                            <div id="soundcloud-history-list" class="soundcloud-modal-results"></div>\n                            <div class="soundcloud-pagination soundcloud-history-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn prev" aria-label="Previous history page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info soundcloud-history-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn next" aria-label="Next history page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                    </div>\n                </div>\n                <div class="modal-footer soundcloud-modal-footer">\n                    <button type="button" class="soundcloud-modal-cancel">Close</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=e.querySelector(".soundcloud-modal-main"),i=e.querySelector("#soundcloud-modal-history"),a={overlay:e,form:e.querySelector(".soundcloud-modal-form"),input:e.querySelector("#soundcloudSearchInput"),cancel:e.querySelector(".soundcloud-modal-cancel"),closeBtn:e.querySelector(".soundcloud-modal-close"),status:e.querySelector(".soundcloud-modal-status"),searchBtn:e.querySelector(".soundcloud-modal-search"),results:e.querySelector(".soundcloud-modal-results"),historySection:i,historyList:i?.querySelector("#soundcloud-history-list")||null,pagination:t?.querySelector(".soundcloud-pagination")||null,paginationPrev:t?.querySelector(".soundcloud-page-btn.prev")||null,paginationNext:t?.querySelector(".soundcloud-page-btn.next")||null,paginationInfo:t?.querySelector(".soundcloud-page-info")||null,historyPagination:i?.querySelector(".soundcloud-history-pagination")||null,historyPaginationPrev:i?.querySelector(".soundcloud-history-page-btn.prev")||null,historyPaginationNext:i?.querySelector(".soundcloud-history-page-btn.next")||null,historyPaginationInfo:i?.querySelector(".soundcloud-history-page-info")||null,currentResults:[],hasSearched:!1,searchInProgress:!1,sortedResults:[],pageSize:10,currentPage:1,nextHref:null,totalAvailable:0,fetchingMorePromise:null,searchQuery:"",historyEntries:[],historyPageSize:10,historyCurrentPage:1},s=(e,t=!1)=>{a.status&&(a.status.textContent=e||"",a.status.classList.toggle("error",Boolean(e&&t)))},r=e=>{a.cancel&&(a.cancel.disabled=e),a.input&&(a.input.disabled=e),a.searchBtn&&(a.searchBtn.disabled=e)},n=e=>{const t=Math.max(0,Math.floor((Number(e)||0)/1e3));return`${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`},o=(()=>{try{return new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1})}catch(e){return null}})(),l=e=>{if(!e)return{tracks:[],nextHref:null,total:0};if(Array.isArray(e))return{tracks:e,nextHref:null,total:e.length};const t=Array.isArray(e.collection)?e.collection:null,i=Array.isArray(e.tracks)?e.tracks:null,a=e.next_href||e.nextHref||null,s=[e.total_results,e.total,e.collection_size,Array.isArray(t)?t.length:null,Array.isArray(i)?i.length:null].find(e=>"number"==typeof e&&e>=0);return t?{tracks:t,nextHref:a,total:"number"==typeof s?s:t.length}:i?{tracks:i,nextHref:a,total:"number"==typeof s?s:i.length}:{tracks:[],nextHref:a,total:"number"==typeof s?s:0}},u=()=>{if(!a.pagination)return;const e=a.sortedResults.length>0;if(a.pagination.style.display=e?"flex":"none",!e)return a.paginationInfo&&(a.paginationInfo.textContent="Page 1"),a.paginationPrev&&(a.paginationPrev.disabled=!0),void(a.paginationNext&&(a.paginationNext.disabled=!0));const t=Math.max(a.sortedResults.length,a.totalAvailable||0),i=Math.max(1,Math.ceil(t/a.pageSize));if(a.currentPage=Math.min(Math.max(a.currentPage,1),i),a.paginationPrev&&(a.paginationPrev.disabled=a.currentPage<=1),a.paginationNext){const e=Math.ceil(a.sortedResults.length/a.pageSize),t=a.currentPage>=e;a.paginationNext.disabled=t&&!a.nextHref||0===a.sortedResults.length}if(a.paginationInfo)if(a.sortedResults.length){const e=(a.currentPage-1)*a.pageSize+1,t=Math.min(a.currentPage*a.pageSize,a.sortedResults.length),i=Math.max(a.sortedResults.length,a.totalAvailable||0),s=a.nextHref&&i<=a.sortedResults.length?`${a.sortedResults.length}+`:i;a.paginationInfo.textContent=`Page ${a.currentPage} â€¢ ${e}-${t} of ${s}`}else a.paginationInfo.textContent="Page 1"},d=()=>{if(!a.sortedResults.length)return p([]),void u();s("");const e=Math.max(1,Math.ceil(a.sortedResults.length/a.pageSize));a.currentPage>e&&(a.currentPage=e);const t=(a.currentPage-1)*a.pageSize,i=t+a.pageSize,r=a.sortedResults.slice(t,i);p(r),u()},c=(e=[],{append:t=!1,nextHref:i=null,total:s=null}={})=>{const r=Array.isArray(e)?e:[],n=t?a.sortedResults.concat(r):r;a.sortedResults=((e=[])=>e.filter(e=>e&&"object"==typeof e).slice().sort((e,t)=>{const i=Number(e?.playback_count)||0,a=Number(t?.playback_count)||0;return i===a?0:a-i}))(((e=[])=>{const t=new Set,i=[];return e.forEach(e=>{if(!e||"object"!=typeof e)return;const a=null!=e.id?`id:${e.id}`:null,s=e.permalink_url||e.permalinkUrl||"",r=a||(s?`url:${s}`:null);r&&t.has(r)||(r&&t.add(r),i.push(e))}),i})(n)),t||(a.currentPage=1),a.totalAvailable="number"==typeof s&&s>=0?Math.max(s,a.sortedResults.length):t?Math.max(a.totalAvailable||0,a.sortedResults.length):a.sortedResults.length,a.nextHref=i||null,d()},h=async()=>{if(!a.nextHref)return!1;if(a.fetchingMorePromise)return await a.fetchingMorePromise,!0;const e=a.status?.textContent||"";return a.fetchingMorePromise=(async()=>{r(!0),s("Loading more SoundCloud tracks...");try{const e=await this.fetchSoundCloudAPI(a.nextHref,{query:{linked_partitioning:"1"}}),{tracks:t,nextHref:i,total:r}=l(e);c(t,{append:!0,nextHref:i,total:r}),a.sortedResults.length?s(""):s("No additional tracks found.")}catch(e){s(e?.message||"Failed to load more SoundCloud tracks.",!0),a.nextHref=null}finally{!a.sortedResults.length&&e&&s(e),r(!1),a.fetchingMorePromise=null}})(),await a.fetchingMorePromise,a.sortedResults.length>0},p=(e=[])=>{if(a.currentResults=Array.isArray(e)?e:[],!a.results)return;if(a.results.innerHTML="",a.results.scrollTop=0,!a.currentResults.length){if(a.hasSearched&&!a.searchInProgress){const e=document.createElement("div");e.className="soundcloud-results-empty",e.textContent="No tracks found. Try another search term.",a.results.appendChild(e)}return}const t=document.createElement("div");t.className="soundcloud-results-list",a.currentResults.forEach(e=>{if(!e||"object"!=typeof e)return;const i=document.createElement("button");i.type="button",i.className="soundcloud-search-item",i.dataset.trackId=null!=e.id?String(e.id):"",i.dataset.trackPermalink=e.permalink_url||e.permalinkUrl||"",i.dataset.trackTitle=e.title||"",i.setAttribute("role","option"),i.setAttribute("aria-selected","false");const a=document.createElement("div");a.className="soundcloud-search-item-text";const s=document.createElement("div");s.className="soundcloud-search-title",s.textContent=e.title||"Untitled track";const r=document.createElement("div");r.className="soundcloud-search-meta";const l=[];e.user?.username&&l.push(e.user.username),e.duration&&l.push(n(e.duration));const u=(e=>{const t=Number(e);if(!Number.isFinite(t)||t<0)return null;if(o)return o.format(t);try{return t.toLocaleString()}catch(e){return String(t)}})(e.playback_count);u&&l.push(`${u} plays`),r.textContent=l.join(" â€¢ "),a.appendChild(s),a.appendChild(r);const d=document.createElement("span");d.className="soundcloud-search-play",d.textContent="â–¶",i.appendChild(a),i.appendChild(d),i.dataset.trackId||i.dataset.trackPermalink||(i.disabled=!0),t.appendChild(i)}),a.results.appendChild(t)},m=()=>{if(!a.historyPagination)return;const e=a.historyEntries.length,t=e>0;if(a.historyPagination.style.display=t?"flex":"none",!t)return a.historyPaginationInfo&&(a.historyPaginationInfo.textContent="Page 1"),a.historyPaginationPrev&&(a.historyPaginationPrev.disabled=!0),void(a.historyPaginationNext&&(a.historyPaginationNext.disabled=!0));const i=Math.max(1,Math.ceil(e/a.historyPageSize));if(a.historyCurrentPage=Math.min(Math.max(a.historyCurrentPage,1),i),a.historyPaginationPrev&&(a.historyPaginationPrev.disabled=a.historyCurrentPage<=1),a.historyPaginationNext&&(a.historyPaginationNext.disabled=a.historyCurrentPage>=i),a.historyPaginationInfo){const t=(a.historyCurrentPage-1)*a.historyPageSize+1,i=Math.min(a.historyCurrentPage*a.historyPageSize,e);a.historyPaginationInfo.textContent=`Page ${a.historyCurrentPage} â€¢ ${t}-${i} of ${e}`}},y=()=>{if(!a.historyList)return;a.historyList.innerHTML="";const e=a.historyEntries;if(!e.length){a.historySection&&a.historySection.classList.add("soundcloud-history-empty");const e=document.createElement("div");return e.className="soundcloud-history-empty",e.textContent="Play SoundCloud tracks to build your recent history.",a.historyList.appendChild(e),void m()}a.historySection&&a.historySection.classList.remove("soundcloud-history-empty");const t=Math.max(1,Math.ceil(e.length/a.historyPageSize));a.historyCurrentPage=Math.min(Math.max(a.historyCurrentPage,1),t);const i=(a.historyCurrentPage-1)*a.historyPageSize,s=i+a.historyPageSize,r=e.slice(i,s),o=document.createElement("div");o.className="soundcloud-history-items",r.forEach(e=>{if(!e||"object"!=typeof e)return;const t=document.createElement("button");t.type="button",t.className="soundcloud-history-item soundcloud-search-item",t.dataset.trackId=null!=e.id?String(e.id):"",t.dataset.trackPermalink=e.permalinkUrl||"",t.dataset.trackTitle=e.title||"",t.setAttribute("role","option"),t.setAttribute("aria-selected","false");const i=document.createElement("div");i.className="soundcloud-search-item-text";const a=document.createElement("div");a.className="soundcloud-search-title",a.textContent=e.title||"Untitled track";const s=document.createElement("div");s.className="soundcloud-search-meta";const r=[];e.artist&&r.push(e.artist),e.duration&&r.push(n(e.duration)),r.push("Recently played"),s.textContent=r.join(" â€¢ "),i.appendChild(a),i.appendChild(s),t.appendChild(i),o.appendChild(t)}),a.historyList.appendChild(o),m()},S=(e=this.getSoundCloudHistory(),{preservePage:t=!1}={})=>{const i=Array.isArray(e)?e.filter(e=>e&&"object"==typeof e).sort((e,t)=>(Number(t.lastPlayed)||0)-(Number(e.lastPlayed)||0)):[];i.length>this.soundCloudHistoryLimit&&(i.length=this.soundCloudHistoryLimit),a.historyEntries=i;const s=Math.max(1,Math.ceil(i.length/a.historyPageSize));a.historyCurrentPage=t?Math.min(Math.max(a.historyCurrentPage,1),s):1,y(),!t&&a.historyList&&(a.historyList.scrollTop=0)},g=()=>{e.classList.remove("active"),a.form&&a.form.reset(),s(""),r(!1),a.hasSearched=!1,a.searchInProgress=!1,a.sortedResults=[],a.nextHref=null,a.totalAvailable=0,a.currentPage=1,a.fetchingMorePromise=null,a.searchQuery="",p([]),u(),S(this.getSoundCloudHistory())};a.close=g,a.setStatus=s,a.setLoading=r,a.renderResults=p,a.renderHistory=S,a.updatePaginationControls=u,a.paginationPrev?.addEventListener("click",e=>{e.preventDefault(),a.searchInProgress||a.currentPage<=1||(a.currentPage=Math.max(1,a.currentPage-1),d(),a.results?.scrollTo({top:0,behavior:"smooth"}))}),a.paginationNext?.addEventListener("click",async e=>{if(e.preventDefault(),a.searchInProgress)return;const t=a.currentPage+1,i=(t-1)*a.pageSize+1;a.sortedResults.length<i&&a.nextHref&&(a.paginationNext.disabled=!0,await h()),t<=Math.max(1,Math.ceil(a.sortedResults.length/a.pageSize))&&(a.currentPage=t),d(),a.results?.scrollTo({top:0,behavior:"smooth"})}),a.historyPaginationPrev?.addEventListener("click",e=>{e.preventDefault(),a.historyCurrentPage<=1||(a.historyCurrentPage=Math.max(1,a.historyCurrentPage-1),y(),a.historyList?.scrollTo({top:0,behavior:"smooth"}))}),a.historyPaginationNext?.addEventListener("click",e=>{e.preventDefault();const t=Math.max(1,Math.ceil(a.historyEntries.length/a.historyPageSize));a.historyCurrentPage>=t||(a.historyCurrentPage=Math.min(t,a.historyCurrentPage+1),y(),a.historyList?.scrollTo({top:0,behavior:"smooth"}))});const v=async()=>{const e=a.input?.value?.trim();if(!e)return s("Enter a search term to continue.",!0),!1;if(e.length<3)return s("Search term must be at least 3 characters.",!0),!1;a.hasSearched=!0,a.searchInProgress=!0,a.searchQuery=e,a.sortedResults=[],a.currentPage=1,a.nextHref=null,a.totalAvailable=0,p([]),u(),s("Searching SoundCloud..."),r(!0);try{const t=Math.min(5*a.pageSize,50),i=await this.fetchSoundCloudAPI("/tracks",{query:{q:e,limit:String(t),linked_partitioning:"1"}}),{tracks:r,nextHref:n,total:o}=l(i);return c(r,{append:!1,nextHref:n,total:o}),a.sortedResults.length||n?(s(""),a.sortedResults.length>0||Boolean(n)):(s("No tracks found. Try another search.",!0),!1)}catch(e){return s(e?.message||"Failed to search SoundCloud.",!0),a.sortedResults=[],a.nextHref=null,p([]),u(),!1}finally{a.searchInProgress=!1,r(!1),d()}};a.closeBtn?.addEventListener("click",g),a.cancel?.addEventListener("click",e=>{e.preventDefault(),g()}),e.addEventListener("click",t=>{t.target===e&&g()}),a.searchBtn?.addEventListener("click",async e=>{e.preventDefault(),await v()});const f=async e=>{if(!e)return;const t=e.dataset.trackId,i=e.dataset.trackPermalink||t;if(!i)return void s("Unable to load this track.",!0);const a=e.dataset.trackTitle||"SoundCloud track";s(`Loading "${a}"...`),r(!0);try{const e=await this.resolveSoundCloudTrack(i);g(),await this.loadSoundCloudTrack(e,{pauseBeforeLoad:!0,autoPlay:!0})}catch(e){s(e?.message||"Failed to load SoundCloud track.",!0),r(!1)}};return a.results?.addEventListener("click",async e=>{const t=e.target.closest(".soundcloud-search-item");e.preventDefault(),await f(t)}),a.historyList?.addEventListener("click",async e=>{const t=e.target.closest(".soundcloud-history-item");t&&(e.preventDefault(),await f(t))}),a.form?.addEventListener("submit",async e=>{e.preventDefault(),await v()}),S(this.getSoundCloudHistory()),u(),this.soundCloudModal=a,a}async resolveSoundCloudTrack(e){const t=(e||"").trim();if(!t)throw new Error("Please provide a SoundCloud track reference.");let i=null,a=null;const s=this.sanitizeSoundCloudTrackId(t);if(/^[0-9]+$/.test(s)&&s)a=s,i=await this.fetchSoundCloudTrackById(a);else{let e;try{e=await this.fetchSoundCloudAPI("/resolve",{query:{url:t}})}catch(e){throw new Error(e?.message||"Failed to resolve SoundCloud track.")}if(!e)throw new Error("SoundCloud resolve returned no data.");if("track"===e.kind)i=e,a=this.sanitizeSoundCloudTrackId(e.id);else{if(!e.location)throw new Error(`Resolved resource is not a track (${e.kind||"unknown"}).`);try{const t=new URL(e.location,"https://api.soundcloud.com").pathname.split("/").filter(Boolean);if(a=this.sanitizeSoundCloudTrackId(t[t.length-1]),!a)throw new Error("Unable to determine track ID from SoundCloud resolve response.");i=await this.fetchSoundCloudTrackById(a)}catch(e){throw new Error(e?.message||"Failed to follow SoundCloud resolve redirect.")}}if(!i?.media){const e=i?.id||a;if(!e)throw new Error("Unable to determine SoundCloud track ID.");i=await this.fetchSoundCloudTrackById(e)}}if(!i)throw new Error("Failed to load SoundCloud track data.");if(!1===i.streamable)throw new Error("This SoundCloud track does not permit streaming via the API.");if("string"==typeof i.policy&&"block"===i.policy.toLowerCase())throw new Error("SoundCloud has blocked API streaming for this track.");let r=null,n=null,o=null;try{const e=await this.fetchSoundCloudStreamData(i);r=e?.streamUrl||null,n=e?.data||null}catch(e){}if(!r){const e=i.media?.transcodings||[],t=this.pickBestSoundCloudTranscoding(e);if(!t?.url)throw new Error("Track has no available streamable formats.");let a;try{a=await this.fetchSoundCloudTranscodingUrl(t.url)}catch(e){throw new Error(e?.message||"Failed to obtain SoundCloud stream URL.")}const s=this.selectPreferredStreamUrl(a)||a?.url||null;if(!s)throw new Error("SoundCloud did not return a usable stream URL for this track.");r=s,n=a||null,o=t}return{id:i.id,title:i.title,duration:i.duration,permalinkUrl:i.permalink_url||i.permalinkUrl||null,artworkUrl:i.artwork_url||i.user?.avatar_url||null,author:i.user?{id:i.user.id,username:i.user.username,permalink:i.user.permalink_url||null,avatarUrl:i.user.avatar_url||null}:null,streamUrl:r,streamMetadata:n,waveformUrl:i.waveform_url||null,media:{format:o?.format||null,preset:o?.preset||null,quality:o?.quality||null,protocol:o?.format?.protocol||o?.protocol||n?.protocol||null,streamType:n?.stream_type||null}}}async pausePlayback({stopVisualizer:e=!0,includeMic:t=!1}={}){try{this.audioManager&&(this.audioManager.isPlaying&&this.audioManager.pause(),t&&this.audioManager.isMicActive&&(await this.audioManager.stopMicrophone(),this.hideNowPlaying()))}catch(e){}finally{e&&this.currentVisualizer?.isAnimating&&!this.audioManager?.isPlaying&&!this.audioManager?.isMicActive&&this.currentVisualizer.stop(),this.updateControlButtons(!1,this.audioManager?.isMicActive)}}async loadSoundCloudTrack(e,{pauseBeforeLoad:t=!0,autoPlay:i=!1}={}){if(!e?.streamUrl)throw new Error("SoundCloud stream is unavailable for this track.");const a=this.showLoadingMessage("Loading SoundCloud track...");try{t?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),await this.audioManager.loadStreamFromUrl(e.streamUrl),this.rememberSoundCloudTrack(e),this.hideLoadingMessage(a),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint();const s=e.author?.username||"SoundCloud",r="string"==typeof e.permalinkUrl?e.permalinkUrl:e.permalink_url,n=e.author?.permalink,o=e.artworkUrl||e.artwork_url||e.author?.avatarUrl||null,l=e.author?.avatarUrl||null,u="string"==typeof r&&/^https?:\/\//i.test(r),d="string"==typeof n&&/^https?:\/\//i.test(n);!e.artworkUrl&&o&&(e.artworkUrl=o),l&&e.author&&!e.author.avatarUrl&&(e.author.avatarUrl=l),this.updateNowPlaying(e.title||"Unknown Track",s,{source:"soundcloud",isSoundCloud:!0,trackUrl:u?r:null,artistUrl:d?n:null,trackLinkLabel:u?"Listen on SoundCloud":"Creator on SoundCloud",artworkUrl:o,artistImageUrl:l,duration:e.duration}),this.updateControlButtons(!1,!1),(i||!t)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(e){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150)}catch(e){throw this.hideLoadingMessage(a),e}}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const e="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const t=await fetch(e,{method:"HEAD"});if(!t.ok)throw new Error(`Demo audio not found (status ${t.status})`);const i=await fetch(e);if(!i.ok)throw new Error(`Failed to fetch demo audio (status ${i.status})`);const a=await i.blob(),s=new File([a],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=s,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),s})().catch(e=>{throw this.demoAudioFile=null,e});try{return await this.demoAudioPromise}catch(e){return this.demoAudioPromise=null,null}}initializeDOMElements(){this.quickStartModal=document.getElementById("quickStartModal"),this.quickStartCloseBtn=document.getElementById("quickStartCloseBtn"),this.quickStartStartBtn=document.getElementById("quickStartStartBtn"),this.quickStartStatusEl=document.getElementById("quickStartStatus"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.visualSearchBar=document.getElementById("visualSearchBar"),this.visualizerSearchInput=document.getElementById("visualizerSearch"),this.visualizerSearchSummary=document.getElementById("visualizerSearchSummary"),this.visualInfoSummary=document.getElementById("visualInfoSummary"),this.visualSearchDropdown=document.getElementById("visualSearchDropdown"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.playerDock=document.getElementById("playerDock"),this.playerArtwork=document.getElementById("playerArtwork"),this.playerArtworkWrapper=this.playerArtwork?this.playerArtwork.closest(".player-artwork"):document.querySelector(".player-artwork"),this.playerTitleEl=document.getElementById("playerTitle"),this.playerArtistEl=document.getElementById("playerArtist"),this.playerArtistPrefixEl=document.querySelector(".player-artist-prefix"),this.playerCurrentTimeEl=document.getElementById("playerCurrentTime"),this.playerDurationEl=document.getElementById("playerDuration"),this.playerDurationWrapper=document.getElementById("playerDurationWrapper"),this.playerDurationDivider=document.getElementById("playerDurationDivider"),this.playerSourceIndicatorIcon=document.getElementById("playerSourceIndicatorIcon"),this.playerSourceIndicatorLabel=document.getElementById("playerSourceIndicatorLabel"),this.playerControlsToggle=document.getElementById("playerControlsToggle"),this.playerControlsPanel=document.getElementById("playerControlsPanel"),this.visualSearchToggleBtn=document.getElementById("visualSearchToggleBtn"),this.sourcePickerBtn=document.getElementById("sourcePickerBtn"),this.visualSelectionGrid=document.getElementById("visualSelectionGrid"),this.sourceSelectionGrid=document.getElementById("sourceSelectionGrid"),this.visualSelectionSection=document.getElementById("visualSelectionSection"),this.sourceSelectionSection=document.getElementById("sourceSelectionSection"),this.selectionHubElement=document.getElementById("selectionHub"),this.selectionHubElement&&(this.selectionHubElement.classList.add("hidden"),this.selectionHubAutoHidden=!0),this.visualizerSelect&&(this.visualizerSelect.classList.add("offscreen"),this.visualizerSelect.setAttribute("aria-hidden","true"),this.visualizerSelect.setAttribute("tabindex","-1")),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.quickStartStartBtn&&this.quickStartStartBtn.addEventListener("click",()=>this.handleQuickStartStart()),this.quickStartCloseBtn&&this.quickStartCloseBtn.addEventListener("click",()=>this.hideQuickStartModal()),this.quickStartModal&&(this.quickStartModal.setAttribute("aria-hidden","true"),this.quickStartModal.addEventListener("click",e=>{e.target===this.quickStartModal&&this.hideQuickStartModal(!1)})),this.bindSelectionHandlers(),this.setupPlayerControlsToggle(),this.setupVisualSearchToggle(),this.sourcePickerBtn&&this.sourcePickerBtn.addEventListener("click",()=>{this.setPlayerControlsExpanded(!1),this.focusSelectionSection("source",{exclusive:!0})}),this.updateVisualSearchVisibility(),this.setVisualSearchDimmed(!0),this.hideNowPlaying(),this.updateSelectionHubVisibility()}setupPlayerControlsToggle(){this.playerControlsToggle&&this.playerControlsPanel&&this.playerControlsToggle.addEventListener("click",()=>{const e="true"===this.playerControlsToggle.getAttribute("aria-expanded");this.setPlayerControlsExpanded(!e)})}setupVisualSearchToggle(){this.visualSearchToggleBtn&&this.visualSearchToggleBtn.addEventListener("click",()=>{this.toggleVisualSearchPanel()})}setPlayerControlsExpanded(e){if(!this.playerControlsToggle||!this.playerControlsPanel)return;const t=Boolean(e);t!==this.playerControlsOpen&&(this.playerControlsOpen=t,this.playerControlsToggle.setAttribute("aria-expanded",t?"true":"false"),this.playerControlsToggle.setAttribute("aria-label",t?"Hide player controls":"Show player controls"),t?(this.playerControlsPanel.removeAttribute("hidden"),document.addEventListener("pointerdown",this.handlePlayerControlsPointerDown,!0),document.addEventListener("keydown",this.handlePlayerControlsKeydown,!0)):(this.playerControlsPanel.setAttribute("hidden",""),document.removeEventListener("pointerdown",this.handlePlayerControlsPointerDown,!0),document.removeEventListener("keydown",this.handlePlayerControlsKeydown,!0)))}handlePlayerControlsPointerDown(e){if(!this.playerControlsPanel||!this.playerControlsToggle)return;const t=e.target;this.playerControlsPanel.contains(t)||this.playerControlsToggle.contains(t)||this.setPlayerControlsExpanded(!1)}handlePlayerControlsKeydown(e){"Escape"===e.key&&this.setPlayerControlsExpanded(!1)}async loadVisualizer(e){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const t=this.availableVisualizers.get(e);if(!t)throw new Error(`Visualizer not found: ${e}`);if(this.currentVisualizer=new t.class(null,{}),this.currentVisualizerName=e,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(e){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(e=>{this.currentVisualizer?.update&&this.currentVisualizer.update(e),this.updatePlayerTimeline(e),this.selectionHubManual||this.selectionHubDismissed||this.dismissSelectionHub()}),this.audioManager.setPlayStateChangeCallback((e,t)=>{this.currentVisualizer&&(!e&&!t||this.currentVisualizer.isAnimating?e||t||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(e,t);const i=Boolean(e||t),a=this.isPlaybackActive;this.isPlaybackActive=i,t?this.setActiveSource("mic"):e||this.audioManager?.audioElement||this.setActiveSource(null),this.setVisualSearchDimmed(i),i&&(this.onboardingCompleted=!0,this.hideGettingStartedOverlay()),a!==this.isPlaybackActive&&this.refreshVisualSearchSummary(),this.updateSelectionHubVisibility()})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(e){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(e){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.fileSelectBtn?.addEventListener("click",async()=>{await this.handleFileSelection()}),this.fileInput?.addEventListener("change",e=>{const t=e.target.files[0];t?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(t.name)?this.loadAudioFile(t,{pauseBeforeLoad:!0,autoPlay:!0}):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",async e=>{const t=e.target.value;if(t&&t!==this.currentVisualizerName)try{this.visualSelectionTriggeredFromUI=!0,await this.switchVisualizer(t)}catch(e){}}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideOnboardingOverlay()})}setupDragAndDrop(){["dragenter","dragover"].forEach(e=>{document.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(e.dataTransfer?.types||[]).includes("Files")&&this.showOnboardingOverlay()})}),document.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),0===e.clientX&&0===e.clientY&&this.hideOnboardingOverlay()}),document.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),this.hideOnboardingOverlay(),this.hideGettingStartedOverlay();const t=Array.from(e.dataTransfer?.files||[]).find(e=>e.type.startsWith("audio/"));t&&(this.pausePlayback({stopVisualizer:!0,includeMic:!0}).catch(()=>{}),this.loadAudioFile(t,{pauseBeforeLoad:!0,autoPlay:!0}))})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.emitVisualVisibilityEvent({active:!1,reason:"tab-hidden"}),this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.emitVisualVisibilityEvent({active:!0,reason:"tab-visible"}),this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.emitVisualVisibilityEvent({active:!1,reason:"pagehide"}),this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.emitVisualVisibilityEvent({active:!0,reason:"pageshow"}),this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){this.availableVisualizers.clear(),this.visualizerMetadataByName=new Map,this.visualizerManifest=[];const e="undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)?window.VISUALIZERS_MANIFEST:null;e&&e.forEach(e=>{const t=e.name,i=window[t];if("function"!=typeof i)return;const a={name:t,displayName:e.displayName||t.replace(/Visualizer$/,""),file:e.file,description:"string"==typeof e.description?e.description:"",tags:Array.isArray(e.tags)?e.tags:[]};this.visualizerMetadataByName.set(t,a),this.visualizerManifest.push(a),this.availableVisualizers.set(t,{...a,class:i})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(e=>{const t=e.value,i=window[t];if("function"!=typeof i)return;const a=this.visualizerMetadataByName.get(t);if(a)return void this.availableVisualizers.set(t,{...a,class:i});const s=e.dataset?.tags||"",r=s?s.split(",").map(e=>e.trim()).filter(Boolean):[],n={name:t,displayName:e.textContent||t.replace(/Visualizer$/,""),file:null,description:e.dataset?.description||"",tags:r};this.visualizerMetadataByName.set(t,n),this.visualizerManifest.push(n),this.availableVisualizers.set(t,{...n,class:i})}),this.renderVisualSelectionCards()}bindSelectionHandlers(){this.sourceSelectionGrid&&(this.sourceCardElements=new Map,this.sourceSelectionGrid.querySelectorAll("[data-source-card]").forEach(e=>{const t=e.dataset.sourceCard;t&&(this.sourceCardElements.set(t,e),e.setAttribute("role","button"),e.setAttribute("tabindex","0"))}),this.sourceSelectionGrid.addEventListener("click",e=>{const t=e.target.closest("[data-source-card]");if(!t||t.classList.contains("selection-card--disabled"))return;const i=t.dataset.sourceCard;i&&(e.preventDefault(),this.handleSourceSelection(i))}),this.sourceSelectionGrid.addEventListener("keydown",e=>{if("Enter"!==e.key&&" "!==e.key)return;const t=e.target.closest("[data-source-card]");if(!t||t.classList.contains("selection-card--disabled"))return;const i=t.dataset.sourceCard;i&&(e.preventDefault(),this.handleSourceSelection(i))})),this.visualSelectionGrid&&(this.visualSelectionGrid.addEventListener("click",e=>{const t=e.target.closest("[data-visual-card]");if(!t)return;const i=t.dataset.visualCard;i&&i!==this.currentVisualizerName&&(e.preventDefault(),this.visualSelectionTriggeredFromUI=!0,this.switchVisualizer(i))}),this.visualSelectionGrid.addEventListener("keydown",e=>{if("Enter"!==e.key&&" "!==e.key)return;const t=e.target.closest("[data-visual-card]");if(!t)return;const i=t.dataset.visualCard;i&&i!==this.currentVisualizerName&&(e.preventDefault(),this.visualSelectionTriggeredFromUI=!0,this.switchVisualizer(i))}))}renderVisualSelectionCards(){if(!this.visualSelectionGrid)return;this.visualSelectionGrid.innerHTML="",this.visualCardElements=new Map;const e=this.visualizerManifest||[],t=document.createDocumentFragment();e.forEach(e=>{const i=document.createElement("button");i.type="button",i.className="selection-card",i.dataset.visualCard=e.name,i.setAttribute("role","button"),i.setAttribute("tabindex","0");const a=e.description||"Abstract visual experience",s=Array.isArray(e.tags)?e.tags.slice(0,4):[];i.innerHTML=`\n                <div class="selection-card__header">\n                    <span class="selection-card__icon">âœ¨</span>\n                    <h3 class="selection-card__title">${e.displayName}</h3>\n                </div>\n                <p class="selection-card__description">${a}</p>\n                ${s.length?`<div class="selection-card__meta">${s.map(e=>`<span class="selection-card__tag">${e}</span>`).join("")}</div>`:""}\n            `,t.appendChild(i),this.visualCardElements.set(e.name,i)}),this.visualSelectionGrid.appendChild(t),this.highlightActiveVisualizer(this.currentVisualizerName)}highlightActiveVisualizer(e){this.visualCardElements.forEach((t,i)=>{const a=i===e;t.classList.toggle("selection-card--active",a),t.setAttribute("aria-pressed",a?"true":"false")}),this.updateSelectionHubVisibility()}focusSelectionSection(e,{exclusive:t=!1}={}){let i=null;"source"===e?i=this.sourceSelectionSection:"visual"===e&&(i=this.visualSelectionSection);const a=!this.selectionHubElement?.classList.contains("hidden");if("source"===e&&this.selectionHubManual&&a)return void this.closeSourceSelection(!0);if(t?("source"===e?this.visualSelectionSection?.classList.add("selection-section--hidden"):"visual"===e&&this.sourceSelectionSection?.classList.add("selection-section--hidden"),"source"===e&&this.sourceSelectionSection?.classList.remove("selection-section--hidden"),"visual"===e&&this.visualSelectionSection?.classList.remove("selection-section--hidden")):(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden")),this.selectionHubElement&&(this.selectionHubManual=!0,this.selectionHubElement.classList.remove("hidden")),"source"===e?(this.selectionHubDismissed=!1,this.selectionHubElement?.classList.add("selection-hub--modal")):(this.selectionHubElement?.classList.remove("selection-hub--modal"),this.selectionHubDismissed||this.dismissSelectionHub()),"source"===e?this.openSourceSelection():this.teardownSourceSelectionOutsideHandler(),!i)return;const s=t;try{i.scrollIntoView({behavior:"smooth",block:s?"nearest":"center"})}catch(e){i.scrollIntoView({behavior:"smooth"})}i.classList.add("selection-section--pulse"),setTimeout(()=>i.classList.remove("selection-section--pulse"),1200),this.updateSelectionHubVisibility()}updateSelectionHubVisibility(){if(!this.selectionHubElement)return;const e=Boolean(this.currentVisualizerName),t=Boolean(this.currentSourceType)||Boolean(this.audioManager?.audioElement)||Boolean(this.audioManager?.isMicActive),i=this.selectionHubDismissed||!this.selectionHubManual&&e&&t;this.selectionHubManual||(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden"),this.teardownSourceSelectionOutsideHandler()),this.selectionHubElement.classList.toggle("hidden",i),i&&(this.selectionHubAutoHidden=!0)}openSourceSelection(){this.isSourceSelectionOpen||(this.isSourceSelectionOpen=!0,document.addEventListener("pointerdown",this.handleSourceOutsidePointerDown,!0))}teardownSourceSelectionOutsideHandler(){this.isSourceSelectionOpen&&(this.isSourceSelectionOpen=!1,document.removeEventListener("pointerdown",this.handleSourceOutsidePointerDown,!0))}closeSourceSelection(e=!1){(e||this.isSourceSelectionOpen)&&(this.teardownSourceSelectionOutsideHandler(),this.selectionHubManual=!1,this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden"),this.selectionHubElement?.classList.remove("selection-hub--modal"),this.selectionHubDismissed=!0,this.updateSelectionHubVisibility())}handleSourceOutsidePointerDown(e){this.isSourceSelectionOpen&&(this.sourceSelectionSection?.contains(e.target)||this.sourcePickerBtn?.contains(e.target)||this.closeSourceSelection(!0))}toggleVisualSearchPanel(e){this.visualSearchToggleBtn&&this.visualSearchBar&&(("boolean"==typeof e?e:!this.visualSearchPanelOpen)?this.openVisualSearchPanel():this.closeVisualSearchPanel())}openVisualSearchPanel(){this.visualSearchBar&&this.visualSearchToggleBtn&&!this.visualSearchPanelOpen&&(this.isGettingStartedActive()||(this.visualSearchPanelOpen=!0,this.visualSearchToggleBtn.classList.add("player-btn--active"),this.visualSearchToggleBtn.setAttribute("aria-pressed","true"),this.setVisualSearchDimmed(!1),this.updateVisualSearchVisibility(),this.visualizerSearchInput?.focus(),document.addEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0)))}closeVisualSearchPanel({focusToggle:e=!1}={}){this.visualSearchPanelOpen&&(this.visualSearchPanelOpen=!1,this.visualSearchToggleBtn?.classList.remove("player-btn--active"),this.visualSearchToggleBtn?.setAttribute("aria-pressed","false"),this.setVisualSearchDimmed(!0),this.updateVisualSearchVisibility(),this.visualizerSearchInput?.blur(),this.hideVisualSearchDropdown({immediate:!0}),document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0),e&&this.visualSearchToggleBtn?.focus())}handleVisualSearchOutsidePointer(e){if(!this.visualSearchPanelOpen)return;const t=this.visualSearchBar?.contains(e.target),i=this.visualSearchToggleBtn?.contains(e.target);t||i||this.closeVisualSearchPanel()}dismissSelectionHub(){this.selectionHubDismissed||(this.selectionHubDismissed=!0,this.selectionHubManual=!1,this.selectionHubElement?.classList.remove("selection-hub--modal"),this.updateSelectionHubVisibility())}emitVisualVisibilityEvent(e={}){if("undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;let t;try{t=new CustomEvent("vvavy:visual-visibility",{detail:{active:Boolean(e.active),reason:e.reason||"unknown",timestamp:"undefined"!=typeof performance&&"function"==typeof performance.now?performance.now():Date.now()}})}catch(e){return}window.dispatchEvent(t)}renderVisualSearchDropdown(e=[],t=""){if(!this.visualSearchDropdown)return;const i=this.visualSearchDropdown;i.innerHTML="";const a=(t||"").trim(),s=e.slice(0,14);if(!s.length){if(!a)return void i.classList.add("hidden");const e=document.createElement("div");return e.className="visual-search-item visual-search-item--empty",e.textContent="No visuals match that search.",i.appendChild(e),void i.classList.remove("hidden")}const r=document.createDocumentFragment();s.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="visual-search-item",t.dataset.visualName=e.name,t.dataset.displayName=e.displayName;const i=Array.isArray(e.tags)?e.tags.slice(0,3):[],a=e.description?`<div class="visual-search-item__description">${e.description}</div>`:"",s=i.length?`<div class="visual-search-item__tags">${i.map(e=>`<span>${e}</span>`).join("")}</div>`:"";t.innerHTML=`\n                <div class="visual-search-item__title">${e.displayName}</div>\n                ${a}\n                ${s}\n            `,r.appendChild(t)}),i.appendChild(r),i.classList.remove("hidden")}showVisualSearchDropdown(){this.visualSearchDropdown&&0!==this.visualSearchDropdown.childElementCount&&(this.visualSearchDropdown.classList.remove("hidden"),this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout))}hideVisualSearchDropdown({immediate:e=!1}={}){if(!this.visualSearchDropdown)return;const t=()=>this.visualSearchDropdown.classList.add("hidden");e?t():(this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout),this.visualDropdownHideTimeout=setTimeout(t,120))}async handleSourceSelection(e){this.setPlayerControlsExpanded(!1);try{switch(e){case"soundcloud":await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.showSoundCloudOrAlert(this.sourceCardElements.get("soundcloud"),{hideOnboarding:!0,hideOverlay:!0});break;case"file":await this.handleFileSelection();break;case"mic":await this.handleMicrophoneSelection()}}catch(e){}finally{this.closeSourceSelection(!0)}}async handleFileSelection(){this.hideQuickStartModal(),await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.fileInput?.click()}async handleMicrophoneSelection(){if(this.audioManager){if(this.hideQuickStartModal(),this.audioManager.isMicActive)return await this.audioManager.stopMicrophone(),this.hideNowPlaying(),this.updateControlButtons(this.audioManager.isPlaying,!1),void this.updateSelectionHubVisibility();try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(e=>setTimeout(e,50)),await this.audioManager.startMicrophone(),this.hideAudioContextHint(),this.showMicrophoneNowPlaying()}catch(e){alert("Microphone access denied or unavailable.")}finally{this.updateControlButtons(this.audioManager.isPlaying,this.audioManager.isMicActive)}this.updateSelectionHubVisibility()}}setSourceAvailability(e,t,i=""){let a=null;"soundcloud"===e?a=this.sourceCardElements.get("soundcloud"):"file"===e?a=this.sourceCardElements.get("file"):"mic"===e&&(a=this.sourceCardElements.get("mic")),a&&(a.disabled=!t,!t&&i?(a.dataset.soundcloudReason=i,a.setAttribute("title",i)):(delete a.dataset.soundcloudReason,a.removeAttribute("title")));const s=this.sourceCardElements?.get(e);s&&(s.classList.toggle("selection-card--disabled",!t),t?(s.removeAttribute("aria-disabled"),s.removeAttribute("data-soundcloud-reason")):(s.setAttribute("aria-disabled","true"),i&&(s.dataset.soundcloudReason=i)))}showSoundCloudOrAlert(e,{hideOnboarding:t=!0}={}){if(!this.soundCloudEnabled){const t=e?.dataset?.soundcloudReason||this.soundCloudAvailabilityMessage||"SoundCloud integration is currently unavailable.";return void alert(t)}t&&this.hideQuickStartModal(!1),this.openSoundCloudModal()}setupVisualizerSearch(){this.visualizerSearchInput&&(this._searchInitialized?this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}):(this._searchInitialized=!0,this.visualizerSearchInput.addEventListener("input",e=>{this.applyVisualizerSearch(e.target.value,{showDropdown:!0}),this.showVisualSearchDropdown(),this.dismissSelectionHub()}),this.visualizerSearchInput.addEventListener("focus",()=>{const e=this.visualizerSearchInput.value.trim();e?this.applyVisualizerSearch(e,{showDropdown:!0}):this.applyVisualizerSearch("",{showDropdown:!0}),this.showVisualSearchDropdown(),this.dismissSelectionHub()}),this.visualizerSearchInput.addEventListener("keydown",e=>{if("Enter"===e.key){const t=this.visualizerSearchMatches[0];t&&(e.preventDefault(),this.visualizerSelect&&(this.visualizerSelect.value=t.name),this.visualSelectionTriggeredFromUI=!0,this.switchVisualizer(t.name),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0}),this.dismissSelectionHub(),this.selectionHubElement?.classList.remove("selection-hub--modal"))}else"Escape"===e.key&&(this.visualizerSearchInput.value="",this.applyVisualizerSearch("",{showDropdown:!1}),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0}))}),this.visualizerSearchInput.addEventListener("blur",()=>{this.visualizerSearchInput.value.trim()||this.updateVisualizerSummaryForSelection(this.currentVisualizerName),this.hideVisualSearchDropdown(),this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.dismissSelectionHub()}),this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}),this.visualSearchDropdown&&!this._dropdownBound&&(this.visualSearchDropdown.addEventListener("click",e=>{const t=e.target.closest(".visual-search-item");if(!t||t.classList.contains("visual-search-item--empty"))return;const i=t.dataset.visualName,a=t.dataset.displayName||"";a&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=a),this.hideVisualSearchDropdown({immediate:!0}),i&&i!==this.currentVisualizerName&&(this.visualSelectionTriggeredFromUI=!0,this.switchVisualizer(i)),this.visualizerSearchInput?.blur(),this.dismissSelectionHub(),this.selectionHubElement?.classList.remove("selection-hub--modal")}),document.addEventListener("click",e=>{if(!this.visualSearchDropdown)return;const t=this.visualSearchBar?.contains(e.target),i=this.visualSearchDropdown.contains(e.target);t||i||this.hideVisualSearchDropdown({immediate:!0})}),this._dropdownBound=!0)))}applyVisualizerSearch(e="",{showDropdown:t}={}){const i=(e||"").toLowerCase().trim(),a=i.split(/\s+/).filter(Boolean),s=this.visualizerManifest||[];let r;r=a.length?s.map(e=>{const t=[e.name,e.displayName,e.description,...e.tags||[]].filter(Boolean).map(e=>e.toLowerCase());let i=0;for(const e of a){let a=0;for(const i of t)i.includes(e)&&(a=i===e?Math.max(a,3):i.startsWith(e)?Math.max(a,2):Math.max(a,1));if(0===a)return null;i+=a}return{entry:e,score:i}}).filter(Boolean).sort((e,t)=>t.score!==e.score?t.score-e.score:e.entry.displayName.localeCompare(t.entry.displayName)).map(e=>e.entry):s.slice(),this.visualizerSearchMatches=r,this.updateVisualizerSelectOptions(r,i),("boolean"==typeof t?t:document.activeElement===this.visualizerSearchInput)?this.renderVisualSearchDropdown(r,i):this.hideVisualSearchDropdown({immediate:!0}),this.updateVisualizerSearchSummary(r,i)}updateVisualizerSelectOptions(e,t){if(!this.visualizerSelect)return;const i=t.length>0&&e.length>0,a=new Set(e.map(e=>e.name));if(Array.from(this.visualizerSelect.options).forEach(e=>{if(i){const t=a.has(e.value);e.hidden=!t,e.disabled=!t}else e.hidden=!1,e.disabled=!1}),!i)return this.visualizerSelect.classList.remove("search-active","search-no-match"),void(this.currentVisualizerName&&this.availableVisualizers.has(this.currentVisualizerName)&&(this.visualizerSelect.value=this.currentVisualizerName));if(e.length){const t=e[0];this.visualizerSelect.value=t.name,this.visualizerSelect.classList.add("search-active"),this.visualizerSelect.classList.remove("search-no-match")}else this.visualizerSelect.classList.remove("search-active"),this.visualizerSelect.classList.add("search-no-match")}updateVisualizerSearchSummary(e,t){if(this.visualizerSearchInput&&(!t||e.length?this.visualizerSearchInput.classList.remove("no-results"):this.visualizerSearchInput.classList.add("no-results")),!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(!t)return void this.updateVisualizerSummaryForSelection(this.currentVisualizerName);if(!e.length)return this.visualizerSearchSummary.textContent="No visuals match that search.",void this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent);const i=e[0],a=i.description?`${i.displayName}: ${i.description}`:i.displayName,s=i.tags&&i.tags.length?` (${i.tags.slice(0,3).join(" â€¢ ")})`:"";this.visualizerSearchSummary.textContent=`Top match: ${a}${s}`,this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualizerSummaryForSelection(e){if(!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(Boolean(this.visualizerSearchInput?.value?.trim()))return;if(!e)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const t=this.visualizerMetadataByName.get(e);if(!t)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const i=t.description?`${t.displayName}: ${t.description}`:t.displayName,a=t.tags&&t.tags.length?` (${t.tags.slice(0,3).join(" â€¢ ")})`:"";this.visualizerSearchSummary.textContent=`${i}${a}`,this.visualizerSearchInput?.classList.remove("no-results"),this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualInfoSummary(e){if(this.visualInfoSummary){if(this.isPlaybackActive)return void(this.visualInfoSummary.textContent="");const t="Use the visual search bar above to change scenes.";this.visualInfoSummary.textContent=e||t}}updateVisualSearchVisibility(){if(!this.visualSearchBar)return;const e=Boolean(document.querySelector("#welcomeModal.active")),t=this.isGettingStartedActive();let i=!1;try{i=!this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted])}catch(e){i=!0}const a=e||t||i,s=a||!this.visualSearchPanelOpen;this.visualSearchBar.classList.toggle("hidden",s),this.visualSearchBar.setAttribute("aria-hidden",s?"true":"false"),s&&(this.setVisualSearchDimmed(!0),this.visualSearchPanelOpen&&a&&(this.visualSearchPanelOpen=!1,this.visualSearchToggleBtn?.classList.remove("player-btn--active"),this.visualSearchToggleBtn?.setAttribute("aria-pressed","false"),document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0)))}setVisualSearchDimmed(e=!0){if(!this.visualSearchBar)return;const t=e&&!this.visualSearchPanelOpen;this.visualSearchBar.classList.toggle("dimmed",t)}refreshVisualSearchSummary(){const e=this.visualizerSearchInput?.value?.trim();e?this.applyVisualizerSearch(e,{showDropdown:!1}):this.updateVisualizerSummaryForSelection(this.currentVisualizerName)}formatTime(e){if(!Number.isFinite(e)||e<0)return"0:00";const t=Math.floor(e);return`${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`}updatePlayerTimeline(e=null){if(!this.playerCurrentTimeEl||!this.playerDurationEl)return;const t=this.audioManager?.audioElement||null,i=Boolean(this.audioManager?.isMicActive);let a=Number.isFinite(e?.mediaTime)?e.mediaTime:null;!Number.isFinite(a)&&t&&(a=t.currentTime),(!Number.isFinite(a)||a<0)&&(a=0);let s=null;if(Number.isFinite(e?.mediaDuration)&&e.mediaDuration>0?s=e.mediaDuration:Number.isFinite(this.currentTrackDurationMs)&&this.currentTrackDurationMs>0?s=this.currentTrackDurationMs/1e3:t&&Number.isFinite(t.duration)&&t.duration>0&&t.duration!==1/0&&(s=t.duration),i)return this.playerCurrentTimeEl.textContent="LIVE",this.playerDurationEl.textContent="",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),void(this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"));this.playerCurrentTimeEl.textContent=this.formatTime(a),Number.isFinite(s)&&s>0?(this.playerDurationEl.textContent=this.formatTime(s),this.playerDurationDivider&&(this.playerDurationDivider.style.display=""),this.playerDock&&this.playerDock.classList.remove("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","false")):(this.playerDurationEl.textContent="--:--",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"))}async loadAudioFile(e,{pauseBeforeLoad:t=!1,autoPlay:i=!1}={}){try{const a=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(e),t?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(e){}await this.audioManager.loadFile(e),this.hideLoadingMessage(a),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),(i||!t)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(e){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150)}catch(e){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(e){let t=e.name.replace(/\.[^/.]+$/,""),i="Unknown Artist";const a=t.match(/(.+?)\s*-\s*(.+)/);a&&(i=a[1].trim(),t=a[2].trim()),this.updateNowPlaying(t,i,{source:"file"})}setActiveSource(e){const t=e&&PLAYER_SOURCE_CONFIG[e]?e:"none";this.currentSourceType="none"===t?null:t;const i=PLAYER_SOURCE_CONFIG[t],a="soundcloud"===t,s=this.playerSourceIndicatorLabel?.parentElement||this.playerSourceIndicatorIcon?.parentElement||null;if(s&&s.classList.toggle("hidden",!a),this.playerDock&&this.playerDock.classList.toggle("player-dock--source-hidden",!a),this.playerSourceIndicatorLabel&&(this.playerSourceIndicatorLabel.textContent=i.label),this.playerSourceIndicatorIcon){for(;this.playerSourceIndicatorIcon.firstChild;)this.playerSourceIndicatorIcon.removeChild(this.playerSourceIndicatorIcon.firstChild);if(a)if(i.iconImg){const e=document.createElement("img");e.src=i.iconImg,e.alt="",e.decoding="async",e.className="player-source-indicator-icon-img",this.playerSourceIndicatorIcon.appendChild(e)}else i.icon?this.playerSourceIndicatorIcon.textContent=i.icon:this.playerSourceIndicatorIcon.textContent=PLAYER_SOURCE_CONFIG.none.icon}if(this.sourceCardElements&&this.sourceCardElements.size&&this.sourceCardElements.forEach((e,i)=>{e&&(e.classList.toggle("selection-card--active",t===i),e.setAttribute("aria-pressed",t===i?"true":"false"))}),this.sourcePickerBtn){const e=i.label&&i.label!==PLAYER_SOURCE_CONFIG.none.label?` (current: ${i.label})`:"";this.sourcePickerBtn.setAttribute("aria-label",`Choose audio source${e}`)}this.teardownSourceSelectionOutsideHandler(),this.selectionHubManual=!1,this.updateSelectionHubVisibility()}updateNowPlaying(e,t,i={}){const a=(e,t)=>{if("string"==typeof e){const t=e.trim();if(t.length)return t}return t},s=e=>{if("string"!=typeof e)return null;const t=e.trim();return t&&(/^https?:\/\//i.test(t)||/^data:image\//i.test(t)||/^blob:/i.test(t))?t:null},r=Boolean(i?.isSoundCloud),n=i?.source&&PLAYER_SOURCE_CONFIG[i.source]?i.source:r?"soundcloud":i?.source,o=s(i?.trackUrl),l=s(i?.artistUrl),u=(a(i?.trackLinkLabel,"View on SoundCloud"),s(i?.artworkUrl)),d=s(i?.artistImageUrl),c=u||d||null,h=a(e,"No track loaded"),p=a(t,r?"Unknown Creator":"Unknown Artist");this.playerDock&&(this.playerDock.classList.toggle("player-dock--soundcloud",r),this.playerDock.classList.toggle("player-dock--live",Boolean(i?.isLive))),this.playerTitleEl&&(this.playerTitleEl.textContent=h,o?(this.playerTitleEl.href=o,this.playerTitleEl.target="_blank",this.playerTitleEl.rel="noopener"):(this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel"))),this.playerArtistEl&&(this.playerArtistEl.textContent=p,l?(this.playerArtistEl.href=l,this.playerArtistEl.target="_blank",this.playerArtistEl.rel="noopener"):(this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel"))),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!p),this.playerArtworkWrapper&&this.playerArtworkWrapper.removeAttribute("hidden"),this.playerArtwork?c?(this.playerArtwork.src!==c&&(this.playerArtwork.src=c),this.playerArtwork.alt=`${h} by ${p} artwork`,this.playerArtwork.hidden=!1,this.playerArtworkWrapper?.classList.remove("player-artwork--empty")):this.clearPlayerArtwork():c||(this.playerArtworkWrapper?.classList.add("player-artwork--empty"),this.playerArtworkWrapper?.setAttribute("hidden",""));const m="number"==typeof i?.duration&&Number.isFinite(i.duration)&&i.duration>0?i.duration:null;this.currentTrackDurationMs=m,n?this.setActiveSource(n):this.currentSourceType||this.setActiveSource(null),this.updatePlayerTimeline()}showMicrophoneNowPlaying(){this.updateNowPlaying("Microphone","Live input",{source:"mic",isLive:!0}),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.updateSelectionHubVisibility()}hideNowPlaying(){this.currentTrackDurationMs=null,this.playerTitleEl&&(this.playerTitleEl.textContent="No track loaded",this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel")),this.playerArtistEl&&(this.playerArtistEl.textContent="â€”",this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel")),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.clearPlayerArtwork(),this.playerDock&&(this.playerDock.classList.add("player-dock--no-duration"),this.playerDock.classList.remove("player-dock--soundcloud"),this.playerDock.classList.remove("player-dock--live")),this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"),this.setActiveSource(null),this.updatePlayerTimeline()}clearPlayerArtwork(){this.playerArtworkWrapper&&(this.playerArtworkWrapper.classList.add("player-artwork--empty"),this.playerArtworkWrapper.setAttribute("hidden","")),this.playerArtwork&&(this.playerArtwork.hidden=!0,this.playerArtwork.removeAttribute("src"),this.playerArtwork.alt="")}showLoadingMessage(e){const t=document.createElement("div");return t.className="loading-message",t.innerHTML=`<div class="loading-content"><div class="loading-spinner">ðŸŽ§</div><p>${e}</p></div>`,document.body.appendChild(t),t}hideLoadingMessage(e){e?.parentNode?e.parentNode.removeChild(e):document.querySelectorAll(".loading-message").forEach(e=>e.remove())}updateControlButtons(e,t){if(this.playPauseBtn){const t=this.playPauseBtn.querySelector(".btn-icon"),i=this.playPauseBtn.querySelector(".btn-label");t&&(t.textContent=e?"â¸":"â–¶"),i&&(i.textContent=e?"Pause":"Play"),this.playPauseBtn.setAttribute("aria-label",e?"Pause":"Play");const a=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),s=!!this.demoAudioFile;(a||e)&&this.playPauseBtn.classList.remove("initial-pulse");const r=a||s||e;this.playPauseBtn.disabled=!r,a&&!e?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}this.updatePlayerTimeline()}getDefaultVisualizerName(){const e="undefined"!=typeof window?window.DEFAULT_VISUALIZER:null;if(e&&this.availableVisualizers.has(e))return e;const t=this.availableVisualizers.keys().next();return t&&!t.done?t.value:null}showQuickStartModal({force:e=!1}={}){this.quickStartModal&&(this.onboardingCompleted&&!e||(this.quickStartModal.classList.add("active"),this.quickStartModal.setAttribute("aria-hidden","false"),document.body.classList.add("quickstart-active"),this.selectionHubManual=!1,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="",this.quickStartStatusEl.classList.remove("quickstart-status--error")),this.updateVisualSearchVisibility()))}hideQuickStartModal(e=!0){if(this.quickStartModal){if(this.quickStartModal.classList.remove("active"),this.quickStartModal.setAttribute("aria-hidden","true"),document.body.classList.remove("quickstart-active"),e){this.onboardingCompleted=!0;try{this.setStorageItem(sessionStorage,this.onboardingStorageKey,"true")}catch(e){}}this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.updateVisualSearchVisibility()}}async handleQuickStartStart(){if(this.quickStartStartBtn){this.quickStartStartBtn.disabled=!0,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Loading demo trackâ€¦",this.quickStartStatusEl.classList.remove("quickstart-status--error"));try{const e=this.getDefaultVisualizerName();e&&e!==this.currentVisualizerName&&await this.switchVisualizer(e);let t=this.demoAudioFile;if(t||(t=await this.loadDemoAudioSilently()),!t)throw new Error("Demo audio unavailable");this.audioManager?.isMicActive&&await this.audioManager.stopMicrophone(),await this.loadAudioFile(t,{pauseBeforeLoad:!0,autoPlay:!0}),this.demoAudioFile=null,this.hideQuickStartModal(!0)}catch(e){this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Quick start failed. Please choose a visual and audio source manually.",this.quickStartStatusEl.classList.add("quickstart-status--error"))}finally{this.quickStartStartBtn.disabled=!1}}}showGettingStartedOverlay({remember:e=!0}={}){this.hasCompletedOnboarding()||this.showQuickStartModal({force:!0})}hideGettingStartedOverlay(){this.hideQuickStartModal()}isGettingStartedActive(){return this.quickStartModal?.classList.contains("active")||!1}showOnboardingOverlay({force:e=!1}={}){!e&&this.hasCompletedOnboarding()||this.showQuickStartModal({force:e})}hideOnboardingOverlay(){this.hideQuickStartModal()}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(e){if(!this.availableVisualizers.has(e))return void(this.visualSelectionTriggeredFromUI=!1);await this.loadVisualizer(e),this.updateVisualizerSummaryForSelection(e);const t=this.visualizerMetadataByName.get(e);t&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=t.displayName),this.selectionHubManual=!1,this.highlightActiveVisualizer(e),this.hideVisualSearchDropdown({immediate:!0}),this.refreshVisualSearchSummary(),this.imageUploadBtn.style.display="ImageVisualizer"===e||"WebGLImageExplosionVisualizer"===e?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showOnboardingOverlay(),this.visualSelectionTriggeredFromUI&&"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches&&this.focusSelectionSection("source",{exclusive:!0}),this.visualSearchPanelOpen&&this.closeVisualSearchPanel(),this.visualSelectionTriggeredFromUI=!1}destroy(){if(this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0),this.soundCloudModal?.overlay)try{this.soundCloudModal.overlay.remove()}catch(e){}this.soundCloudModal=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new VvavyApp;return window.vvavy=e,e};window.visualizersLoaded?e():window.addEventListener("visualizersReady",e)});