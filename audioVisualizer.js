class VvavyApp{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.canvas=null,this.dropOverlay=null,this.fileInput=null,this.gettingStartedOverlay=null,this.playPauseBtn=null,this.stopBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.soundcloudBtn=null,this.visualizerSelect=null,this.imageUploadBtn=null,this.menuToggle=null,this.menuPanel=null,this.showHelpOverlayBtn=null,this.onboardingDemoBtn=null,this.onboardingUploadBtn=null,this.onboardingMicBtn=null,this.onboardingSoundCloudBtn=null,this.soundCloudAvailabilityHintEl=null,this.soundCloudHero=null,this.demoAudioPromise=null,this.isProcessingDemoStart=!1,this.storageKeys={onboarding:"vvavyOnboardingSeen",soundCloudToken:"vvavySoundCloudToken",soundCloudHistory:"vvavySoundCloudHistory",termsAccepted:"vvavyAccepted"},this.onboardingStorageKey=this.storageKeys.onboarding,this.isInitialized=!1,this.currentVisualizerName=null,this.soundCloudModal=null,this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="",this.soundCloudTokenStorageKey=this.storageKeys.soundCloudToken,this.soundCloudTokenSafetyWindowMs=15e3,this.soundCloudTokenCache=null,this.soundCloudRecentTracksKey=this.storageKeys.soundCloudHistory,this.soundCloudHistoryCache=null,this.soundCloudHistoryLimit=20,this.init()}getStorageItem(t,e){if(!t||!Array.isArray(e))return null;for(const a of e)if(a)try{const e=t.getItem(a);if(null!==e)return e}catch(t){}return null}setStorageItem(t,e,a){if(t&&e)try{t.setItem(e,a)}catch(t){}}getBooleanStorageValue(t,e){return"true"===this.getStorageItem(t,e)}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);const t=1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupEventListeners(),this.setupDragAndDrop(),await this.checkSoundCloudAvailability(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(e))await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e);else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t)}this.menuToggle&&(this.menuToggle.style.display="inline-flex");const a=this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted]);let o=!1;try{o="true"===this.getStorageItem(sessionStorage,[this.onboardingStorageKey])}catch(t){o=!1}a&&!o?this.showGettingStartedOverlay():!a||this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay(),this.isInitialized=!0,this.loadDemoAudioSilently()}catch(t){}}async checkSoundCloudAvailability(){try{const t=await fetch("/api/soundcloud/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json(),a=Boolean(e?.enabled),o=e?.reason||"";this.soundCloudEnabled=a,this.soundCloudAvailabilityMessage=o;const i=a?"SoundCloud streaming is ready. Search for any track to jump straight into the visuals.":o||"Start the Vvavy server to enable SoundCloud integration.";this.soundcloudBtn&&(a?(this.soundcloudBtn.style.display="flex",this.soundcloudBtn.disabled=!1,delete this.soundcloudBtn.dataset.soundcloudReason):(o?this.soundcloudBtn.dataset.soundcloudReason=o:delete this.soundcloudBtn.dataset.soundcloudReason,this.soundcloudBtn.style.display="none")),this.onboardingSoundCloudBtn&&(this.onboardingSoundCloudBtn.disabled=!a,a?(delete this.onboardingSoundCloudBtn.dataset.soundcloudReason,this.onboardingSoundCloudBtn.removeAttribute("aria-disabled"),this.onboardingSoundCloudBtn.removeAttribute("title")):(i&&(this.onboardingSoundCloudBtn.dataset.soundcloudReason=i,this.onboardingSoundCloudBtn.title=i),this.onboardingSoundCloudBtn.setAttribute("aria-disabled","true"))),this.dropSoundCloudBtn&&(a?(delete this.dropSoundCloudBtn.dataset.soundcloudReason,this.dropSoundCloudBtn.removeAttribute("aria-disabled")):(i&&(this.dropSoundCloudBtn.dataset.soundcloudReason=i),this.dropSoundCloudBtn.setAttribute("aria-disabled","true"))),this.soundCloudAvailabilityHintEl&&(this.soundCloudAvailabilityHintEl.textContent=i),this.soundCloudHero&&this.soundCloudHero.classList.toggle("soundcloud-hero-disabled",!a)}catch(t){this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="Start the Vvavy server to enable SoundCloud integration.",this.soundcloudBtn&&(this.soundcloudBtn.style.display="none"),this.onboardingSoundCloudBtn&&(this.onboardingSoundCloudBtn.disabled=!0,this.onboardingSoundCloudBtn.dataset.soundcloudReason=this.soundCloudAvailabilityMessage,this.onboardingSoundCloudBtn.title=this.soundCloudAvailabilityMessage,this.onboardingSoundCloudBtn.setAttribute("aria-disabled","true")),this.dropSoundCloudBtn&&(this.dropSoundCloudBtn.dataset.soundcloudReason=this.soundCloudAvailabilityMessage,this.dropSoundCloudBtn.setAttribute("aria-disabled","true")),this.soundCloudAvailabilityHintEl&&(this.soundCloudAvailabilityHintEl.textContent=this.soundCloudAvailabilityMessage),this.soundCloudHero&&this.soundCloudHero.classList.add("soundcloud-hero-disabled")}}getCachedSoundCloudToken(){if(this.soundCloudTokenCache?.accessToken)return this.soundCloudTokenCache;try{const t=this.getStorageItem(localStorage,[this.soundCloudTokenStorageKey]);if(!t)return null;const e=JSON.parse(t);if(e&&"object"==typeof e&&e.accessToken)return this.soundCloudTokenCache=e,e}catch(t){}return null}storeSoundCloudToken(t){this.soundCloudTokenCache=t,this.setStorageItem(localStorage,this.soundCloudTokenStorageKey,JSON.stringify(t))}clearSoundCloudToken(){this.soundCloudTokenCache=null;try{localStorage.removeItem(this.soundCloudTokenStorageKey)}catch(t){}}getSoundCloudHistory(){if(!Array.isArray(this.soundCloudHistoryCache)){let t=[];try{const e=this.getStorageItem(localStorage,[this.soundCloudRecentTracksKey,this.storageKeys.legacySoundCloudHistory]);if(e){const a=JSON.parse(e);Array.isArray(a)&&(t=a)}}catch(t){}this.soundCloudHistoryCache=t}return Array.isArray(this.soundCloudHistoryCache)?this.soundCloudHistoryCache.slice():[]}setSoundCloudHistory(t){const e=Array.isArray(t)?t.slice(0,this.soundCloudHistoryLimit):[];if(this.soundCloudHistoryCache=e,this.setStorageItem(localStorage,this.soundCloudRecentTracksKey,JSON.stringify(e)),this.soundCloudModal?.renderHistory)try{this.soundCloudModal.renderHistory(this.getSoundCloudHistory())}catch(t){}}rememberSoundCloudTrack(t){if(!t||"object"!=typeof t)return;const e=null!=t.id?String(t.id):"",a=t.permalinkUrl?String(t.permalinkUrl):"";if(!e&&!a)return;const o={id:e||null,permalinkUrl:a||null,title:t.title||"Untitled track",artist:t.author?.username||null,artworkUrl:t.artworkUrl||null,duration:"number"==typeof t.duration?t.duration:null,lastPlayed:Date.now()},i=this.getSoundCloudHistory().filter(t=>{if(!t||"object"!=typeof t)return!1;const e=o.id&&t.id&&String(t.id)===o.id,a=o.permalinkUrl&&t.permalinkUrl&&t.permalinkUrl===o.permalinkUrl;return!(e||a)});i.unshift(o),this.setSoundCloudHistory(i.slice(0,this.soundCloudHistoryLimit))}async getSoundCloudToken(t=!1){if(!t){const t=this.getCachedSoundCloudToken();if(t?.accessToken&&Number.isFinite(t.expiresAt)&&Date.now()+this.soundCloudTokenSafetyWindowMs<t.expiresAt)return t.accessToken}let e;try{e=await fetch("/api/soundcloud/token",{method:"GET",credentials:"same-origin"})}catch(t){throw new Error("Failed to contact SoundCloud token endpoint.")}if(!e?.ok){let t=`Token request failed (status ${e?.status??"unknown"})`;try{const a=await e.json();a?.error&&(t=a.error)}catch(t){}throw new Error(t)}let a=null;try{a=await e.json()}catch(t){throw new Error("Failed to parse SoundCloud token response.")}if(!a?.accessToken)throw new Error("SoundCloud token response did not include an access token.");const o=Number(a.expiresIn),i=Date.now()+(Number.isFinite(o)&&o>0?1e3*o:36e5),n={accessToken:a.accessToken,expiresAt:i};return this.storeSoundCloudToken(n),n.accessToken}buildSoundCloudUrl(t,e){const a=/^https?:\/\//i.test(t)?new URL(t):new URL(t,"https://api.soundcloud.com");return e&&"object"==typeof e&&Object.entries(e).forEach(([t,e])=>{if(null==e)return;const o=Array.isArray(e)?e:[e];a.searchParams.delete(t),o.forEach(e=>{const o=null==e?"":String(e);a.searchParams.append(t,o)})}),a.toString()}async performSoundCloudFetch(t,{method:e="GET",headers:a={},query:o,body:i,expectJson:n=!0}={},s=0){const r=this.buildSoundCloudUrl(t,o),l=await this.getSoundCloudToken(s>0),d={...a,Authorization:`Bearer ${l}`};n&&!d.Accept?d.Accept="application/json":n||d.Accept||(d.Accept="*/*");const u={method:e,headers:d,credentials:"omit"};let c;null!=i&&("object"!=typeof i||i instanceof Blob||i instanceof FormData?u.body=i:(u.body=JSON.stringify(i),u.headers["Content-Type"]||(u.headers["Content-Type"]="application/json")));try{c=await fetch(r,u)}catch(t){throw new Error(`SoundCloud request failed: ${t.message||t}`)}if(401===c.status&&0===s)return this.clearSoundCloudToken(),this.performSoundCloudFetch(t,{method:e,headers:a,query:o,body:i,expectJson:n},s+1);if(!c.ok){let t="";try{t=await c.text()}catch(e){t=""}const e=t?`: ${t}`:"";throw new Error(`SoundCloud request failed (${c.status})${e}`)}if(!n)return c;const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(t){throw new Error(`Failed to parse SoundCloud response: ${t.message}`)}}async fetchSoundCloudAPI(t,e={}){return this.performSoundCloudFetch(t,e)}sanitizeSoundCloudTrackId(t){if(null==t)return"";const e=String(t).trim();if(!e)return"";if(/^soundcloud:tracks:/i.test(e)){const t=e.split(":");return t[t.length-1]}return e}pickBestSoundCloudTranscoding(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(t=>"progressive"===t?.format?.protocol);return e||(t.find(t=>"hls"===t?.format?.protocol)||t[0])}selectPreferredStreamUrl(t){if(!t||"object"!=typeof t)return null;const e=[t.http_mp3_128_url,t.http_mp3_64_url,t.http_opus_64_url,t.hls_mp3_128_url,t.hls_mp3_64_url,t.hls_opus_64_url,t.hls_url,t.progressive_mp3_url,t.preview_mp3_128_url,t.url];for(const t of e)if(t&&"string"==typeof t)return t;return null}async fetchSoundCloudStreamData(t){if(!t?.id&&!this.sanitizeSoundCloudTrackId(t))throw new Error("Unable to determine SoundCloud track ID.");const e=[];t?.stream_url&&e.push(t.stream_url);let a=null;for(const t of e)if(t)try{const e=await this.fetchSoundCloudAPI(t,{expectJson:!1});if(!e){a=new Error("SoundCloud stream endpoint returned no response.");continue}const o=e.headers;if((o?.get&&o.get("content-type")||"").includes("application/json")){let t=null;try{t=await e.json()}catch(t){a=t}const o=this.selectPreferredStreamUrl(t);if(o)return{streamUrl:o,data:t};a=new Error("SoundCloud stream response did not include a usable URL.");continue}const i=()=>{try{e.body?.cancel?.()}catch(t){}},n=o?.get?o.get("location"):null;if(n)return i(),{streamUrl:n,data:null};if(e.url)return i(),{streamUrl:e.url,data:null};a=new Error("SoundCloud stream endpoint returned an unexpected response.")}catch(t){a=t}if(a)throw a;throw new Error("SoundCloud stream URL is unavailable.")}async fetchSoundCloudTrackById(t){const e=this.sanitizeSoundCloudTrackId(t);if(!e)throw new Error("Track ID is required.");const a=await this.fetchSoundCloudAPI("/tracks",{query:{ids:e}}),o=Array.isArray(a)?a:[];if(!o.length)throw new Error("Track not found on SoundCloud.");return o[0]}async fetchSoundCloudTranscodingUrl(t){if(!t)throw new Error("Transcoding URL is required.");return this.performSoundCloudFetch(t,{expectJson:!0})}openSoundCloudModal(){const t=this.ensureSoundCloudModal();t.form?.reset();const e=this.getSoundCloudHistory();if(t.setLoading?.(!1),t.sortedResults=[],t.nextHref=null,t.totalAvailable=0,t.currentPage=1,t.fetchingMorePromise=null,t.searchQuery="","function"==typeof t.renderResults&&t.renderResults([]),"function"==typeof t.updatePaginationControls&&t.updatePaginationControls(),"function"==typeof t.renderHistory)try{t.renderHistory(e)}catch(t){}t.hasSearched=!1,t.searchInProgress=!1,t.input&&(t.input.disabled=!1),t.cancel&&(t.cancel.disabled=!1),t.overlay.classList.add("active"),setTimeout(()=>{t.input?.focus()},60)}ensureSoundCloudModal(){if(this.soundCloudModal)return this.soundCloudModal;const t=document.createElement("div");t.className="soundcloud-overlay",t.innerHTML='\n            <div class="soundcloud-modal" role="dialog" aria-modal="true">\n                <div class="soundcloud-modal-content">\n                    <form class="soundcloud-modal-form">\n                        <label class="soundcloud-modal-label" for="soundcloudSearchInput">Search SoundCloud</label>\n                        <div class="soundcloud-modal-search-row">\n                            <input type="text" id="soundcloudSearchInput" class="soundcloud-modal-input" name="soundcloudSearch" placeholder="Search for artists, tracks, or genres" autocomplete="off" />\n                            <button type="submit" class="soundcloud-modal-search">Search</button>\n                        </div>\n                    </form>\n                    <div class="soundcloud-modal-body">\n                        <section class="soundcloud-modal-main" aria-label="SoundCloud search results">\n                            <div class="soundcloud-history-header">\n                                <h3>Search Results</h3>\n                            </div>\n                            <div class="soundcloud-modal-status" aria-live="polite"></div>\n                            <div class="soundcloud-modal-results" role="listbox" aria-label="SoundCloud search results"></div>\n                            <div class="soundcloud-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn prev" aria-label="Previous page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn next" aria-label="Next page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                        <section id="soundcloud-modal-history" class="soundcloud-modal-main" aria-label="Recently played SoundCloud tracks">\n                            <div class="soundcloud-history-header">\n                                <h3>Recently Played</h3>\n                            </div>\n                            <div id="soundcloud-history-list" class="soundcloud-modal-results"></div>\n                            <div class="soundcloud-pagination soundcloud-history-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn prev" aria-label="Previous history page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info soundcloud-history-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn next" aria-label="Next history page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                    </div>\n                </div>\n                <div class="modal-footer soundcloud-modal-footer">\n                    <button type="button" class="soundcloud-modal-cancel">Close</button>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const e=t.querySelector(".soundcloud-modal-main"),a=t.querySelector("#soundcloud-modal-history"),o={overlay:t,form:t.querySelector(".soundcloud-modal-form"),input:t.querySelector("#soundcloudSearchInput"),cancel:t.querySelector(".soundcloud-modal-cancel"),closeBtn:t.querySelector(".soundcloud-modal-close"),status:t.querySelector(".soundcloud-modal-status"),searchBtn:t.querySelector(".soundcloud-modal-search"),results:t.querySelector(".soundcloud-modal-results"),historySection:a,historyList:a?.querySelector("#soundcloud-history-list")||null,pagination:e?.querySelector(".soundcloud-pagination")||null,paginationPrev:e?.querySelector(".soundcloud-page-btn.prev")||null,paginationNext:e?.querySelector(".soundcloud-page-btn.next")||null,paginationInfo:e?.querySelector(".soundcloud-page-info")||null,historyPagination:a?.querySelector(".soundcloud-history-pagination")||null,historyPaginationPrev:a?.querySelector(".soundcloud-history-page-btn.prev")||null,historyPaginationNext:a?.querySelector(".soundcloud-history-page-btn.next")||null,historyPaginationInfo:a?.querySelector(".soundcloud-history-page-info")||null,currentResults:[],hasSearched:!1,searchInProgress:!1,sortedResults:[],pageSize:10,currentPage:1,nextHref:null,totalAvailable:0,fetchingMorePromise:null,searchQuery:"",historyEntries:[],historyPageSize:10,historyCurrentPage:1},i=(t,e=!1)=>{o.status&&(o.status.textContent=t||"",o.status.classList.toggle("error",Boolean(t&&e)))},n=t=>{o.cancel&&(o.cancel.disabled=t),o.input&&(o.input.disabled=t),o.searchBtn&&(o.searchBtn.disabled=t)},s=t=>{const e=Math.max(0,Math.floor((Number(t)||0)/1e3));return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`},r=(()=>{try{return new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1})}catch(t){return null}})(),l=t=>{if(!t)return{tracks:[],nextHref:null,total:0};if(Array.isArray(t))return{tracks:t,nextHref:null,total:t.length};const e=Array.isArray(t.collection)?t.collection:null,a=Array.isArray(t.tracks)?t.tracks:null,o=t.next_href||t.nextHref||null,i=[t.total_results,t.total,t.collection_size,Array.isArray(e)?e.length:null,Array.isArray(a)?a.length:null].find(t=>"number"==typeof t&&t>=0);return e?{tracks:e,nextHref:o,total:"number"==typeof i?i:e.length}:a?{tracks:a,nextHref:o,total:"number"==typeof i?i:a.length}:{tracks:[],nextHref:o,total:"number"==typeof i?i:0}},d=()=>{if(!o.pagination)return;const t=o.sortedResults.length>0;if(o.pagination.style.display=t?"flex":"none",!t)return o.paginationInfo&&(o.paginationInfo.textContent="Page 1"),o.paginationPrev&&(o.paginationPrev.disabled=!0),void(o.paginationNext&&(o.paginationNext.disabled=!0));const e=Math.max(o.sortedResults.length,o.totalAvailable||0),a=Math.max(1,Math.ceil(e/o.pageSize));if(o.currentPage=Math.min(Math.max(o.currentPage,1),a),o.paginationPrev&&(o.paginationPrev.disabled=o.currentPage<=1),o.paginationNext){const t=Math.ceil(o.sortedResults.length/o.pageSize),e=o.currentPage>=t;o.paginationNext.disabled=e&&!o.nextHref||0===o.sortedResults.length}if(o.paginationInfo)if(o.sortedResults.length){const t=(o.currentPage-1)*o.pageSize+1,e=Math.min(o.currentPage*o.pageSize,o.sortedResults.length),a=Math.max(o.sortedResults.length,o.totalAvailable||0),i=o.nextHref&&a<=o.sortedResults.length?`${o.sortedResults.length}+`:a;o.paginationInfo.textContent=`Page ${o.currentPage} • ${t}-${e} of ${i}`}else o.paginationInfo.textContent="Page 1"},u=()=>{if(!o.sortedResults.length)return g([]),void d();i("");const t=Math.max(1,Math.ceil(o.sortedResults.length/o.pageSize));o.currentPage>t&&(o.currentPage=t);const e=(o.currentPage-1)*o.pageSize,a=e+o.pageSize,n=o.sortedResults.slice(e,a);g(n),d()},c=(t=[],{append:e=!1,nextHref:a=null,total:i=null}={})=>{const n=Array.isArray(t)?t:[],s=e?o.sortedResults.concat(n):n;o.sortedResults=((t=[])=>t.filter(t=>t&&"object"==typeof t).slice().sort((t,e)=>{const a=Number(t?.playback_count)||0,o=Number(e?.playback_count)||0;return a===o?0:o-a}))(((t=[])=>{const e=new Set,a=[];return t.forEach(t=>{if(!t||"object"!=typeof t)return;const o=null!=t.id?`id:${t.id}`:null,i=t.permalink_url||t.permalinkUrl||"",n=o||(i?`url:${i}`:null);n&&e.has(n)||(n&&e.add(n),a.push(t))}),a})(s)),e||(o.currentPage=1),o.totalAvailable="number"==typeof i&&i>=0?Math.max(i,o.sortedResults.length):e?Math.max(o.totalAvailable||0,o.sortedResults.length):o.sortedResults.length,o.nextHref=a||null,u()},h=async()=>{if(!o.nextHref)return!1;if(o.fetchingMorePromise)return await o.fetchingMorePromise,!0;const t=o.status?.textContent||"";return o.fetchingMorePromise=(async()=>{n(!0),i("Loading more SoundCloud tracks...");try{const t=await this.fetchSoundCloudAPI(o.nextHref,{query:{linked_partitioning:"1"}}),{tracks:e,nextHref:a,total:n}=l(t);c(e,{append:!0,nextHref:a,total:n}),o.sortedResults.length?i(""):i("No additional tracks found.")}catch(t){i(t?.message||"Failed to load more SoundCloud tracks.",!0),o.nextHref=null}finally{!o.sortedResults.length&&t&&i(t),n(!1),o.fetchingMorePromise=null}})(),await o.fetchingMorePromise,o.sortedResults.length>0},g=(t=[])=>{if(o.currentResults=Array.isArray(t)?t:[],!o.results)return;if(o.results.innerHTML="",o.results.scrollTop=0,!o.currentResults.length){if(o.hasSearched&&!o.searchInProgress){const t=document.createElement("div");t.className="soundcloud-results-empty",t.textContent="No tracks found. Try another search term.",o.results.appendChild(t)}return}const e=document.createElement("div");e.className="soundcloud-results-list",o.currentResults.forEach(t=>{if(!t||"object"!=typeof t)return;const a=document.createElement("button");a.type="button",a.className="soundcloud-search-item",a.dataset.trackId=null!=t.id?String(t.id):"",a.dataset.trackPermalink=t.permalink_url||t.permalinkUrl||"",a.dataset.trackTitle=t.title||"",a.setAttribute("role","option"),a.setAttribute("aria-selected","false");const o=document.createElement("div");o.className="soundcloud-search-item-text";const i=document.createElement("div");i.className="soundcloud-search-title",i.textContent=t.title||"Untitled track";const n=document.createElement("div");n.className="soundcloud-search-meta";const l=[];t.user?.username&&l.push(t.user.username),t.duration&&l.push(s(t.duration));const d=(t=>{const e=Number(t);if(!Number.isFinite(e)||e<0)return null;if(r)return r.format(e);try{return e.toLocaleString()}catch(t){return String(e)}})(t.playback_count);d&&l.push(`${d} plays`),n.textContent=l.join(" • "),o.appendChild(i),o.appendChild(n);const u=document.createElement("span");u.className="soundcloud-search-play",u.textContent="▶",a.appendChild(o),a.appendChild(u),a.dataset.trackId||a.dataset.trackPermalink||(a.disabled=!0),e.appendChild(a)}),o.results.appendChild(e)},y=()=>{if(!o.historyPagination)return;const t=o.historyEntries.length,e=t>0;if(o.historyPagination.style.display=e?"flex":"none",!e)return o.historyPaginationInfo&&(o.historyPaginationInfo.textContent="Page 1"),o.historyPaginationPrev&&(o.historyPaginationPrev.disabled=!0),void(o.historyPaginationNext&&(o.historyPaginationNext.disabled=!0));const a=Math.max(1,Math.ceil(t/o.historyPageSize));if(o.historyCurrentPage=Math.min(Math.max(o.historyCurrentPage,1),a),o.historyPaginationPrev&&(o.historyPaginationPrev.disabled=o.historyCurrentPage<=1),o.historyPaginationNext&&(o.historyPaginationNext.disabled=o.historyCurrentPage>=a),o.historyPaginationInfo){const e=(o.historyCurrentPage-1)*o.historyPageSize+1,a=Math.min(o.historyCurrentPage*o.historyPageSize,t);o.historyPaginationInfo.textContent=`Page ${o.historyCurrentPage} • ${e}-${a} of ${t}`}},p=()=>{if(!o.historyList)return;o.historyList.innerHTML="";const t=o.historyEntries;if(!t.length){o.historySection&&o.historySection.classList.add("soundcloud-history-empty");const t=document.createElement("div");return t.className="soundcloud-history-empty",t.textContent="Play SoundCloud tracks to build your recent history.",o.historyList.appendChild(t),void y()}o.historySection&&o.historySection.classList.remove("soundcloud-history-empty");const e=Math.max(1,Math.ceil(t.length/o.historyPageSize));o.historyCurrentPage=Math.min(Math.max(o.historyCurrentPage,1),e);const a=(o.historyCurrentPage-1)*o.historyPageSize,i=a+o.historyPageSize,n=t.slice(a,i),r=document.createElement("div");r.className="soundcloud-history-items",n.forEach(t=>{if(!t||"object"!=typeof t)return;const e=document.createElement("button");e.type="button",e.className="soundcloud-history-item soundcloud-search-item",e.dataset.trackId=null!=t.id?String(t.id):"",e.dataset.trackPermalink=t.permalinkUrl||"",e.dataset.trackTitle=t.title||"",e.setAttribute("role","option"),e.setAttribute("aria-selected","false");const a=document.createElement("div");a.className="soundcloud-search-item-text";const o=document.createElement("div");o.className="soundcloud-search-title",o.textContent=t.title||"Untitled track";const i=document.createElement("div");i.className="soundcloud-search-meta";const n=[];t.artist&&n.push(t.artist),t.duration&&n.push(s(t.duration)),n.push("Recently played"),i.textContent=n.join(" • "),a.appendChild(o),a.appendChild(i),e.appendChild(a),r.appendChild(e)}),o.historyList.appendChild(r),y()},m=(t=this.getSoundCloudHistory(),{preservePage:e=!1}={})=>{const a=Array.isArray(t)?t.filter(t=>t&&"object"==typeof t).sort((t,e)=>(Number(e.lastPlayed)||0)-(Number(t.lastPlayed)||0)):[];a.length>this.soundCloudHistoryLimit&&(a.length=this.soundCloudHistoryLimit),o.historyEntries=a;const i=Math.max(1,Math.ceil(a.length/o.historyPageSize));o.historyCurrentPage=e?Math.min(Math.max(o.historyCurrentPage,1),i):1,p(),!e&&o.historyList&&(o.historyList.scrollTop=0)},f=()=>{t.classList.remove("active"),o.form&&o.form.reset(),i(""),n(!1),o.hasSearched=!1,o.searchInProgress=!1,o.sortedResults=[],o.nextHref=null,o.totalAvailable=0,o.currentPage=1,o.fetchingMorePromise=null,o.searchQuery="",g([]),d(),m(this.getSoundCloudHistory())};o.close=f,o.setStatus=i,o.setLoading=n,o.renderResults=g,o.renderHistory=m,o.updatePaginationControls=d,o.paginationPrev?.addEventListener("click",t=>{t.preventDefault(),o.searchInProgress||o.currentPage<=1||(o.currentPage=Math.max(1,o.currentPage-1),u(),o.results?.scrollTo({top:0,behavior:"smooth"}))}),o.paginationNext?.addEventListener("click",async t=>{if(t.preventDefault(),o.searchInProgress)return;const e=o.currentPage+1,a=(e-1)*o.pageSize+1;o.sortedResults.length<a&&o.nextHref&&(o.paginationNext.disabled=!0,await h()),e<=Math.max(1,Math.ceil(o.sortedResults.length/o.pageSize))&&(o.currentPage=e),u(),o.results?.scrollTo({top:0,behavior:"smooth"})}),o.historyPaginationPrev?.addEventListener("click",t=>{t.preventDefault(),o.historyCurrentPage<=1||(o.historyCurrentPage=Math.max(1,o.historyCurrentPage-1),p(),o.historyList?.scrollTo({top:0,behavior:"smooth"}))}),o.historyPaginationNext?.addEventListener("click",t=>{t.preventDefault();const e=Math.max(1,Math.ceil(o.historyEntries.length/o.historyPageSize));o.historyCurrentPage>=e||(o.historyCurrentPage=Math.min(e,o.historyCurrentPage+1),p(),o.historyList?.scrollTo({top:0,behavior:"smooth"}))});const v=async()=>{const t=o.input?.value?.trim();if(!t)return i("Enter a search term to continue.",!0),!1;if(t.length<3)return i("Search term must be at least 3 characters.",!0),!1;o.hasSearched=!0,o.searchInProgress=!0,o.searchQuery=t,o.sortedResults=[],o.currentPage=1,o.nextHref=null,o.totalAvailable=0,g([]),d(),i("Searching SoundCloud..."),n(!0);try{const e=Math.min(5*o.pageSize,50),a=await this.fetchSoundCloudAPI("/tracks",{query:{q:t,limit:String(e),linked_partitioning:"1"}}),{tracks:n,nextHref:s,total:r}=l(a);return c(n,{append:!1,nextHref:s,total:r}),o.sortedResults.length||s?(i(""),o.sortedResults.length>0||Boolean(s)):(i("No tracks found. Try another search.",!0),!1)}catch(t){return i(t?.message||"Failed to search SoundCloud.",!0),o.sortedResults=[],o.nextHref=null,g([]),d(),!1}finally{o.searchInProgress=!1,n(!1),u()}};o.closeBtn?.addEventListener("click",f),o.cancel?.addEventListener("click",t=>{t.preventDefault(),f()}),t.addEventListener("click",e=>{e.target===t&&f()}),o.searchBtn?.addEventListener("click",async t=>{t.preventDefault(),await v()});const C=async t=>{if(!t)return;const e=t.dataset.trackId,a=t.dataset.trackPermalink||e;if(!a)return void i("Unable to load this track.",!0);const o=t.dataset.trackTitle||"SoundCloud track";i(`Loading "${o}"...`),n(!0);try{const t=await this.resolveSoundCloudTrack(a);f(),await this.loadSoundCloudTrack(t,{pauseBeforeLoad:!0,autoPlay:!0})}catch(t){i(t?.message||"Failed to load SoundCloud track.",!0),n(!1)}};return o.results?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-search-item");t.preventDefault(),await C(e)}),o.historyList?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-history-item");e&&(t.preventDefault(),await C(e))}),o.form?.addEventListener("submit",async t=>{t.preventDefault(),await v()}),m(this.getSoundCloudHistory()),d(),this.soundCloudModal=o,o}async resolveSoundCloudTrack(t){const e=(t||"").trim();if(!e)throw new Error("Please provide a SoundCloud track reference.");let a=null,o=null;const i=this.sanitizeSoundCloudTrackId(e);if(/^[0-9]+$/.test(i)&&i)o=i,a=await this.fetchSoundCloudTrackById(o);else{let t;try{t=await this.fetchSoundCloudAPI("/resolve",{query:{url:e}})}catch(t){throw new Error(t?.message||"Failed to resolve SoundCloud track.")}if(!t)throw new Error("SoundCloud resolve returned no data.");if("track"===t.kind)a=t,o=this.sanitizeSoundCloudTrackId(t.id);else{if(!t.location)throw new Error(`Resolved resource is not a track (${t.kind||"unknown"}).`);try{const e=new URL(t.location,"https://api.soundcloud.com").pathname.split("/").filter(Boolean);if(o=this.sanitizeSoundCloudTrackId(e[e.length-1]),!o)throw new Error("Unable to determine track ID from SoundCloud resolve response.");a=await this.fetchSoundCloudTrackById(o)}catch(t){throw new Error(t?.message||"Failed to follow SoundCloud resolve redirect.")}}if(!a?.media){const t=a?.id||o;if(!t)throw new Error("Unable to determine SoundCloud track ID.");a=await this.fetchSoundCloudTrackById(t)}}if(!a)throw new Error("Failed to load SoundCloud track data.");if(!1===a.streamable)throw new Error("This SoundCloud track does not permit streaming via the API.");if("string"==typeof a.policy&&"block"===a.policy.toLowerCase())throw new Error("SoundCloud has blocked API streaming for this track.");let n=null,s=null,r=null;try{const t=await this.fetchSoundCloudStreamData(a);n=t?.streamUrl||null,s=t?.data||null}catch(t){}if(!n){const t=a.media?.transcodings||[],e=this.pickBestSoundCloudTranscoding(t);if(!e?.url)throw new Error("Track has no available streamable formats.");let o;try{o=await this.fetchSoundCloudTranscodingUrl(e.url)}catch(t){throw new Error(t?.message||"Failed to obtain SoundCloud stream URL.")}const i=this.selectPreferredStreamUrl(o)||o?.url||null;if(!i)throw new Error("SoundCloud did not return a usable stream URL for this track.");n=i,s=o||null,r=e}return{id:a.id,title:a.title,duration:a.duration,permalinkUrl:a.permalink_url||a.permalinkUrl||null,artworkUrl:a.artwork_url||a.user?.avatar_url||null,author:a.user?{id:a.user.id,username:a.user.username,permalink:a.user.permalink_url||null,avatarUrl:a.user.avatar_url||null}:null,streamUrl:n,streamMetadata:s,waveformUrl:a.waveform_url||null,media:{format:r?.format||null,preset:r?.preset||null,quality:r?.quality||null,protocol:r?.format?.protocol||r?.protocol||s?.protocol||null,streamType:s?.stream_type||null}}}async pausePlayback({stopVisualizer:t=!0,includeMic:e=!1}={}){try{this.audioManager&&(this.audioManager.isPlaying&&this.audioManager.pause(),e&&this.audioManager.isMicActive&&await this.audioManager.stopMicrophone())}catch(t){}finally{t&&this.currentVisualizer?.isAnimating&&!this.audioManager?.isPlaying&&!this.audioManager?.isMicActive&&this.currentVisualizer.stop(),this.updateControlButtons(!1,this.audioManager?.isMicActive)}}async loadSoundCloudTrack(t,{pauseBeforeLoad:e=!0,autoPlay:a=!1}={}){if(!t?.streamUrl)throw new Error("SoundCloud stream is unavailable for this track.");const o=this.showLoadingMessage("Loading SoundCloud track...");try{e?await this.pausePlayback():this.audioManager.isPlaying&&this.audioManager.pause(),await this.audioManager.loadStreamFromUrl(t.streamUrl),this.rememberSoundCloudTrack(t),this.hideLoadingMessage(o),this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.hideAudioContextHint();const i=t.author?.username||"SoundCloud",n="string"==typeof t.permalinkUrl?t.permalinkUrl:t.permalink_url,s=t.author?.permalink,r=t.artworkUrl||t.artwork_url||t.author?.avatarUrl||null,l=t.author?.avatarUrl||null,d="string"==typeof n&&/^https?:\/\//i.test(n),u="string"==typeof s&&/^https?:\/\//i.test(s);!t.artworkUrl&&r&&(t.artworkUrl=r),l&&t.author&&!t.author.avatarUrl&&(t.author.avatarUrl=l),this.updateNowPlaying(t.title||"Unknown Track",i,{source:"soundcloud",isSoundCloud:!0,trackUrl:d?n:null,artistUrl:u?s:null,logoLinkUrl:d?n:u?s:"https://soundcloud.com",trackLinkLabel:d?"Listen on SoundCloud":"Creator on SoundCloud",artworkUrl:r,artistImageUrl:l}),this.updateControlButtons(!1,!1),(a||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},a?220:150)}catch(t){throw this.hideLoadingMessage(o),t}}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const t="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const e=await fetch(t,{method:"HEAD"});if(!e.ok)throw new Error(`Demo audio not found (status ${e.status})`);const a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch demo audio (status ${a.status})`);const o=await a.blob(),i=new File([o],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=i,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),i})().catch(t=>{throw this.demoAudioFile=null,t});try{return await this.demoAudioPromise}catch(t){return this.demoAudioPromise=null,null}}setButtonLoadingState(t,e,a="Loading…"){if(t)if(t.classList.contains("cta-track"))e?(t.classList.add("cta-track--loading"),t.setAttribute("aria-busy","true"),t.disabled=!0):(t.classList.remove("cta-track--loading"),t.removeAttribute("aria-busy"),t.disabled=!1);else if(e)t.dataset.originalLabel||(t.dataset.originalLabel=t.textContent.trim()),t.setAttribute("data-loading","true"),t.textContent=a,t.disabled=!0;else{const e=t.dataset.originalLabel;e&&(t.textContent=e),t.removeAttribute("data-loading"),t.disabled=!1}}async startDemoFromOnboarding(){if(this.isProcessingDemoStart)return;this.isProcessingDemoStart=!0;const t=this.onboardingDemoBtn,e=t?.querySelector("strong"),a=t?.querySelector("small"),o=e?.textContent||"Play Demo Track",i=a?.textContent||"See the visualizer in action instantly";t&&(t.disabled=!0),e&&(e.textContent="Loading demo..."),a&&(a.textContent="Preparing audio magic");try{const t=await this.loadDemoAudioSilently();if(!t)throw new Error("Demo audio unavailable");this.hideGettingStartedOverlay(),this.hideDropOverlay(),await this.loadAudioFile(t,{pauseBeforeLoad:!0,autoPlay:!0}),this.demoAudioFile=null}catch(t){alert("Demo track isn't available right now. Try uploading your own audio instead."),this.showDropOverlay()}finally{t&&(t.disabled=!1),e&&(e.textContent=o),a&&(a.textContent=i),this.isProcessingDemoStart=!1}}async playDemoTrackFromCTA(t,{pauseBeforeLoad:e=!0}={}){this.setButtonLoadingState(t,!0,"Loading demo…");try{const t=await this.loadDemoAudioSilently();if(!t)throw new Error("Demo audio unavailable");this.hideGettingStartedOverlay(),this.hideDropOverlay(),await this.loadAudioFile(t,{pauseBeforeLoad:e,autoPlay:!0}),this.demoAudioFile=null}catch(t){alert("Demo track isn't available right now. Try browsing SoundCloud or uploading your own audio.")}finally{this.setButtonLoadingState(t,!1)}}async startRecommendedSoundCloudTrack(t=null,{pauseBeforeLoad:e=!0}={}){const a=window.RECOMMENDED_SOUNDCLOUD_TRACK||null;if(!a)return void this.openSoundCloudModal();const o=(a.permalinkUrl||a.permalink_url||a.id||"").toString().trim();if(!o)return void this.openSoundCloudModal();this.setButtonLoadingState(t,!0,"Loading…");let i,n=this.showLoadingMessage("Contacting SoundCloud...");try{i=await this.resolveSoundCloudTrack(o)}catch(t){return n&&this.hideLoadingMessage(n),void alert("Unable to reach the recommended SoundCloud track right now. Try browsing SoundCloud instead.")}n&&(this.hideLoadingMessage(n),n=null),a.artworkUrl&&!i.artworkUrl&&(i.artworkUrl=a.artworkUrl),a.artist&&(i.author=i.author||{},i.author.username||(i.author.username=a.artist)),a.permalinkUrl&&!i.permalinkUrl&&(i.permalinkUrl=a.permalinkUrl);try{await this.loadSoundCloudTrack(i,{pauseBeforeLoad:e,autoPlay:!0})}catch(t){alert("The recommended SoundCloud track could not be played. Please browse SoundCloud instead.")}finally{this.setButtonLoadingState(t,!1)}}initializeDOMElements(){this.dropOverlay=document.getElementById("dropOverlay"),this.dropUploadCard=document.getElementById("dropUploadCard"),this.dropUploadBrowseBtn=document.getElementById("dropUploadBrowseBtn"),this.dropSoundCloudBtn=document.getElementById("dropSoundCloudBtn"),this.recommendedSoundCloudBtn=document.getElementById("playRecommendedSoundcloudBtn"),this.demoTrackBtn=document.getElementById("playDemoTrackBtn"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.stopBtn=document.getElementById("stopBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.soundcloudBtn=document.getElementById("soundcloudBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.menuToggle=document.getElementById("menuToggle"),this.menuPanel=document.querySelector(".menu-panel"),this.menuToggle&&(this.menuToggle.classList.add("menu-toggle-idle"),this.menuToggle.hasAttribute("aria-expanded")||this.menuToggle.setAttribute("aria-expanded","false")),this.showHelpOverlayBtn=document.getElementById("showHelpOverlayBtn"),this.onboardingDemoBtn=document.getElementById("startDemoBtn"),this.onboardingUploadBtn=document.getElementById("startUploadBtn"),this.onboardingMicBtn=document.getElementById("startMicBtn"),this.onboardingSoundCloudBtn=document.getElementById("startSoundCloudBtn"),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.dropUploadCard&&this.fileInput&&this.dropUploadCard.addEventListener("click",t=>{t.target.closest(".cta-track")||t.target.closest("button")||(this.pausePlayback({stopVisualizer:!0}).catch(()=>{}),this.fileInput.click())}),this.dropUploadBrowseBtn&&this.fileInput&&this.dropUploadBrowseBtn.addEventListener("click",t=>{t.stopPropagation(),this.pausePlayback({stopVisualizer:!0}).catch(()=>{}),this.fileInput.click()})}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t)}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e),(t||e)&&this.hideGettingStartedOverlay()})}setupEventListeners(){const t=(t,{hideOnboarding:e=!0,hideDrop:a=!0}={})=>{if(!this.soundCloudEnabled){const e=t?.dataset?.soundcloudReason||this.soundcloudBtn?.dataset?.soundcloudReason||this.onboardingSoundCloudBtn?.dataset?.soundcloudReason||this.dropSoundCloudBtn?.dataset?.soundcloudReason||this.soundCloudAvailabilityMessage||"SoundCloud integration is currently unavailable.";return void alert(e)}e&&this.hideGettingStartedOverlay(),a&&this.hideDropOverlay(),this.openSoundCloudModal()};this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(t){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.stopBtn?.addEventListener("click",()=>{this.audioManager.stop({unload:!0}),this.hideNowPlaying(),this.showDropOverlay(),this.updateControlButtons(!1,!1)}),this.micBtn?.addEventListener("click",async()=>{if(this.audioManager.isMicActive)return this.audioManager.stopMicrophone();const t=this.micBtn.querySelector(".btn-icon"),e=this.micBtn.querySelector(".btn-label"),a=t?t.textContent:"🎤",o=e?e.textContent:"Microphone";t&&(t.textContent="⏳"),e&&(e.textContent="Loading..."),this.micBtn.disabled=!0;try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideDropOverlay(),this.hideAudioContextHint(),this.hideNowPlaying()}catch(i){alert("Microphone access denied or unavailable."),t&&(t.textContent=a),e&&(e.textContent=o)}finally{this.micBtn.disabled=!1}}),this.fileSelectBtn?.addEventListener("click",async()=>{await this.pausePlayback({stopVisualizer:!0}),this.fileInput?.click()}),this.soundcloudBtn?.addEventListener("click",async()=>{await this.pausePlayback({stopVisualizer:!0}),t(this.soundcloudBtn)}),this.onboardingSoundCloudBtn?.addEventListener("click",async()=>{await this.pausePlayback({stopVisualizer:!0}),t(this.onboardingSoundCloudBtn)}),this.dropSoundCloudBtn?.addEventListener("click",async e=>{e.stopPropagation(),await this.pausePlayback({stopVisualizer:!0}),t(this.dropSoundCloudBtn)}),this.recommendedSoundCloudBtn?.addEventListener("click",async e=>{e.preventDefault();const a=e.currentTarget;this.soundCloudEnabled?(await this.pausePlayback({stopVisualizer:!0}),await this.startRecommendedSoundCloudTrack(a,{pauseBeforeLoad:!0})):t(a,{hideOnboarding:!1,hideDrop:!1})}),this.demoTrackBtn?.addEventListener("click",async t=>{t.preventDefault(),await this.pausePlayback({stopVisualizer:!0}),await this.playDemoTrackFromCTA(t.currentTarget,{pauseBeforeLoad:!0})}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",async t=>{const e=t.target.value;if(e&&e!==this.currentVisualizerName)try{await this.switchVisualizer(e)}catch(t){}}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),this.showHelpOverlayBtn?.addEventListener("click",()=>{this.showGettingStartedOverlay({remember:!1})}),this.onboardingDemoBtn?.addEventListener("click",async()=>{await this.pausePlayback({stopVisualizer:!0}),this.startDemoFromOnboarding()}),this.onboardingUploadBtn?.addEventListener("click",async()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),await this.pausePlayback({stopVisualizer:!0}),this.fileInput?.click()}),this.onboardingMicBtn?.addEventListener("click",()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.micBtn?.click()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.hideDropOverlay()})}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showDropOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideDropOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideDropOverlay(),this.hideGettingStartedOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&(this.pausePlayback({stopVisualizer:!0}).catch(()=>{}),this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}))})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){"undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)&&window.VISUALIZERS_MANIFEST.forEach(t=>{const e=t.name,a=window[e];"function"==typeof a&&this.availableVisualizers.set(e,{name:e,class:a,file:t.file})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,a=window[e];"function"==typeof a&&this.availableVisualizers.set(e,{name:e,class:a})})}async loadAudioFile(t,{pauseBeforeLoad:e=!1,autoPlay:a=!1}={}){try{const o=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),e?await this.pausePlayback():this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(o),this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),(a||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},a?220:150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),a="Unknown Artist";const o=e.match(/(.+?)\s*-\s*(.+)/);o&&(a=o[1].trim(),e=o[2].trim()),this.updateNowPlaying(e,a)}updateNowPlaying(t,e,a={}){const o=document.getElementById("nowPlaying"),i=document.getElementById("trackTitle"),n=document.getElementById("trackArtist"),s=document.getElementById("trackArtwork"),r=document.querySelector("#nowPlaying .track-artist-prefix"),l=document.getElementById("soundCloudAttribution"),d=document.getElementById("soundCloudLogoLink"),u=document.getElementById("soundCloudTrackLink"),c=(t,e)=>{if("string"==typeof t){const e=t.trim();if(e.length)return e}return e},h=t=>{if("string"!=typeof t)return null;const e=t.trim();return e&&(/^https?:\/\//i.test(e)||/^data:image\//i.test(e)||/^blob:/i.test(e))?e:null},g=Boolean(a?.isSoundCloud),y=h(a?.trackUrl),p=h(a?.artistUrl),m=h(a?.logoLinkUrl)||y||p||"https://soundcloud.com",f=c(a?.trackLinkLabel,"View on SoundCloud"),v=h(a?.artworkUrl),C=h(a?.artistImageUrl),S=v||C||null,b=c(t,"Unknown Track"),k=c(e,g?"Unknown Creator":"Unknown Artist");if(o&&i&&n&&(i.textContent=b,n.textContent=k,o.style.display="block"),i&&(y?(i.href=y,i.target="_blank",i.rel="noopener"):(i.removeAttribute("href"),i.removeAttribute("target"),i.removeAttribute("rel"))),s&&(S?(s.src!==S&&(s.src=S),s.alt=`${b} by ${k} artwork`,s.hidden=!1,s.style.display=""):(s.hidden=!0,s.style.display="none",s.removeAttribute("src"),s.alt="")),n&&(p?(n.href=p,n.target="_blank",n.rel="noopener"):(n.removeAttribute("href"),n.removeAttribute("target"),n.removeAttribute("rel"))),r&&(r.hidden=!k),l)if(g){if(l.hidden=!1,l.setAttribute("data-source","soundcloud"),l.style.display="flex",d&&(d.href=m,d.target="_blank",d.rel="noopener",d.setAttribute("aria-label","SoundCloud attribution")),u){const t=y||m;u.href=t,u.target="_blank",u.rel="noopener",u.textContent=f,u.setAttribute("aria-label",`Open SoundCloud source for ${b}`)}}else l.hidden=!0,l.style.display="none",l.removeAttribute("data-source"),d&&(d.removeAttribute("href"),d.removeAttribute("target"),d.removeAttribute("rel"),d.removeAttribute("aria-label")),u&&(u.removeAttribute("href"),u.removeAttribute("target"),u.removeAttribute("rel"),u.removeAttribute("aria-label"))}hideNowPlaying(){const t=document.getElementById("nowPlaying");t&&(t.style.display="none")}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">🎧</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),a=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"⏸":"▶"),a&&(a.textContent=t?"Pause":"Play");const o=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),i=!!this.demoAudioFile;(o||t)&&this.playPauseBtn.classList.remove("initial-pulse");const n=o||i||t;this.playPauseBtn.disabled=!n,o&&!t?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}if(this.stopBtn&&(this.stopBtn.disabled=!t&&!e),this.micBtn){const t=this.micBtn.querySelector(".btn-icon"),a=this.micBtn.querySelector(".btn-label");t&&(t.textContent=e?"🔴":"🎤"),a&&(a.textContent=e?"Stop Mic":"Microphone")}if(this.menuToggle){const a=Boolean(t||e);this.menuToggle.classList.toggle("menu-toggle-active",a),this.menuToggle.classList.toggle("menu-toggle-idle",!a)}}showGettingStartedOverlay({remember:t=!0}={}){if(t)try{this.setStorageItem(sessionStorage,this.onboardingStorageKey,"true")}catch(t){}this.showDropOverlay()}hideGettingStartedOverlay(){this.hideDropOverlay()}isGettingStartedActive(){return this.dropOverlay?.classList.contains("active")||!1}showDropOverlay(){this.dropOverlay?.classList.contains("active")||(this.dropOverlay?.classList.add("active"),document.body.classList.add("drop-overlay-active"))}hideDropOverlay(){this.dropOverlay?.classList.remove("active","drag-over"),document.body.classList.remove("drop-overlay-active")}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){this.availableVisualizers.has(t)&&(await this.loadVisualizer(t),this.imageUploadBtn.style.display="ImageVisualizer"===t||"WebGLImageExplosionVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay())}destroy(){if(this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.soundCloudModal?.overlay)try{this.soundCloudModal.overlay.remove()}catch(t){}this.soundCloudModal=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{const t=()=>{const t=new VvavyApp;return window.vvavy=t,t};window.visualizersLoaded?t():window.addEventListener("visualizersReady",t)});