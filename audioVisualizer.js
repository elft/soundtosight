class SoundToSight{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.frameStatusEl=null,this.canvas=null,this.dropOverlay=null,this.fileInput=null,this.playPauseBtn=null,this.stopBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.visualizerSelect=null,this.imageUploadBtn=null,this.menuToggle=null,this.menuPanel=null,this.isInitialized=!1,this.currentVisualizerName=null,this.init()}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager;const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?512:1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupEventListeners(),this.setupDragAndDrop(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(e))await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e);else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t)}this.menuToggle&&(this.menuToggle.style.display="inline-flex"),!("true"===localStorage.getItem("soundToSightAccepted"))||this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay(),this.isInitialized=!0,this.loadDemoAudioSilently()}catch(t){}}async loadDemoAudioSilently(){const t="./demo/spatial-soundscapes.mp3";try{if((await fetch(t,{method:"HEAD"})).ok){const e=await fetch(t),i=await e.blob(),a=new File([i],"spatial-soundscapes.mp3",{type:"audio/mpeg"});await this.extractAndDisplayMetadata(a),this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),await this.audioManager.loadFile(a),this.hideDropOverlay(),this.updateControlButtons(!1,!1)}}catch(t){}}initializeDOMElements(){this.dropOverlay=document.getElementById("dropOverlay"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.stopBtn=document.getElementById("stopBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.menuToggle=document.getElementById("menuToggle"),this.menuPanel=document.querySelector(".menu-panel"),this.canvas=null,this.dropOverlay&&this.fileInput&&(this.dropOverlay.style.cursor="pointer",this.dropOverlay.addEventListener("click",t=>{t.dataTransfer||this.fileInput.click()}))}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t)}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e)})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.stopBtn?.addEventListener("click",()=>{this.audioManager.stop(),this.hideNowPlaying()}),this.micBtn?.addEventListener("click",async()=>{if(this.audioManager.isMicActive)return this.audioManager.stopMicrophone();const t=this.micBtn.querySelector(".btn-icon"),e=this.micBtn.querySelector(".btn-label"),i=t?t.textContent:"üé§",a=e?e.textContent:"Microphone";t&&(t.textContent="‚è≥"),e&&(e.textContent="Loading..."),this.micBtn.disabled=!0;try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideDropOverlay(),this.hideAudioContextHint(),this.hideNowPlaying()}catch(s){alert("Microphone access denied or unavailable."),t&&(t.textContent=i),e&&(e.textContent=a)}finally{this.micBtn.disabled=!1}}),this.fileSelectBtn?.addEventListener("click",()=>{this.fileInput?.click()}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",t=>{const e=t.target.value;e&&e!==this.currentVisualizerName&&this.switchVisualizer(e)}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()})}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showDropOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideDropOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideDropOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&this.loadAudioFile(e)})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){"undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)&&window.VISUALIZERS_MANIFEST.forEach(t=>{const e=t.name,i=window[e];"function"==typeof i&&this.availableVisualizers.set(e,{name:e,class:i,file:t.file})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,i=window[e];"function"==typeof i&&this.availableVisualizers.set(e,{name:e,class:i})})}async loadAudioFile(t){try{const e=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(e),this.hideDropOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,!1)}},150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),i="Unknown Artist";const a=e.match(/(.+?)\s*-\s*(.+)/);a&&(i=a[1].trim(),e=a[2].trim()),this.updateNowPlaying(e,i)}updateNowPlaying(t,e){const i=document.getElementById("nowPlaying"),a=document.getElementById("trackTitle"),s=document.getElementById("trackArtist");i&&a&&s&&(a.textContent=t||"Unknown Track",s.textContent=e||"Unknown Artist",i.style.display="block")}hideNowPlaying(){const t=document.getElementById("nowPlaying");t&&(t.style.display="none")}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">üéß</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),i=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"‚è∏":"‚ñ∂"),i&&(i.textContent=t?"Pause":"Play");const a=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive);this.playPauseBtn.disabled=!a&&!t}if(this.stopBtn&&(this.stopBtn.disabled=!t&&!e),this.micBtn){const t=this.micBtn.querySelector(".btn-icon"),i=this.micBtn.querySelector(".btn-label");t&&(t.textContent=e?"üî¥":"üé§"),i&&(i.textContent=e?"Stop Mic":"Microphone")}}showDropOverlay(){this.dropOverlay?.classList.add("active"),document.body.classList.add("drop-overlay-active")}hideDropOverlay(){this.dropOverlay?.classList.remove("active","drag-over"),document.body.classList.remove("drop-overlay-active")}showAudioContextHint(){if(!this.audioManager.isContextInitialized){const t=document.querySelector(".drop-content");if(t&&!t.querySelector(".audio-hint")){const e=document.createElement("div");e.className="audio-hint",e.innerHTML='<p style="color:#ffd700;font-size:14px;margin-top:10px;">üéµ Tap to enable audio context</p>',t.appendChild(e)}}try{const t=document.createElement("div");Object.assign(t.style,{position:"fixed",left:"12px",bottom:"12px",padding:"8px 10px",background:"rgba(0,0,0,0.7)",color:"#fff",borderRadius:"8px",fontFamily:"monospace",fontSize:"12px",zIndex:2147483646,pointerEvents:"none",opacity:"0.9"}),t.id="frameStatusOverlay",t.textContent="frames: --",document.body.appendChild(t),this.frameStatusEl=t}catch(t){}}showToast(t,e=3e3){try{const i=document.createElement("div");Object.assign(i.style,{position:"fixed",left:"50%",bottom:"24px",transform:"translateX(-50%) translateY(0px)",background:"rgba(0,0,0,0.85)",color:"#fff",padding:"10px 16px",borderRadius:"20px",zIndex:2147483646,fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, sans-serif",fontSize:"13px",boxShadow:"0 6px 18px rgba(0,0,0,0.35)",opacity:"0",transition:"opacity 180ms ease, transform 180ms ease"}),i.textContent=t,document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.style.transform="translateX(-50%) translateY(-6px)"}),setTimeout(()=>{try{i.style.opacity="0",i.style.transform="translateX(-50%) translateY(0px)",setTimeout(()=>{try{i.remove()}catch(t){}},200)}catch(t){}},e)}catch(t){}}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){this.availableVisualizers.has(t)&&(await this.loadVisualizer(t),this.imageUploadBtn.style.display="ImageVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay())}destroy(){this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{window.visualizersLoaded?window.soundToSight=new SoundToSight:window.addEventListener("visualizersReady",()=>window.soundToSight=new SoundToSight)});