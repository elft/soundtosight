const PLAYER_ART_PLACEHOLDER_CLASS="player-artwork--empty",PLAYER_SOURCE_CONFIG={none:{label:"No source",icon:"🎵"},file:{label:"Upload",icon:"📁"},mic:{label:"Microphone",icon:"🎤"},soundcloud:{label:"SoundCloud",icon:"☁️",iconImg:"./images/soundcloud.png"},demo:{label:"Demo track",icon:"🎧"}},FALLBACK_EXPORT_PRESETS={vertical1080x1920:{id:"vertical1080x1920",label:"Vertical 1080x1920 (9:16 - Mobile Devices)",width:1080,height:1920,fps:45},horizontal1920x1080:{id:"horizontal1920x1080",label:"Horizontal 1920x1080 (16:9 - Larger Devices)",width:1920,height:1080,fps:45},square1080x1080:{id:"square1080x1080",label:"Square 1080x1080 (1:1 - Not sure style)",width:1080,height:1080,fps:45}},EXPORT_FPS_OPTIONS=[24,30,45,60,90],PAID_EXPORT_PLAN_KEYS=new Set(["pro","paid","premium","plus"]);class VvavyApp{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.visualizerManifest=[],this.visualizerMetadataByName=new Map,this.canvas=null,this.fileInput=null,this.playPauseBtn=null,this.fileSelectBtn=null,this.visualizerSelect=null,this.visualSearchBar=null,this.visualizerSearchInput=null,this.visualizerSearchSummary=null,this.visualInfoSummary=null,this.visualSearchDropdown=null,this.visualizerSearchMatches=[],this.imageUploadBtn=null,this.sourcePickerBtn=null,this.playerDock=null,this.playerArtwork=null,this.playerArtworkWrapper=null,this.playerTitleEl=null,this.playerArtistEl=null,this.playerArtistPrefixEl=null,this.playerCurrentTimeEl=null,this.playerDurationEl=null,this.playerDurationWrapper=null,this.playerDurationDivider=null,this.playerSourceIndicatorIcon=null,this.currentTrackDurationMs=null,this.playerControlsToggle=null,this.playerControlsPanel=null,this.visualSearchToggleBtn=null,this.quickShareBtn=null,this.currentSourceType=null,this.visualSelectionGrid=null,this.sourceSelectionGrid=null,this.visualSelectionSection=null,this.sourceSelectionSection=null,this.selectionHubElement=null,this.visualCardElements=new Map,this.sourceCardElements=new Map,this._searchInitialized=!1,this.onboardingCompleted=!1,this.isPlaybackActive=!1,this.visualDropdownHideTimeout=null,this._dropdownBound=!1,this._visualSearchDropdownResizeBound=!1,this.selectionHubManual=!1,this.isSourceSelectionOpen=!1,this.visualSelectionTriggeredFromUI=!1,this.visualSelectionTriggerSource=null,this.selectionHubDismissed=!1,this.selectionHubAutoHidden=!1,this.visualSearchPanelOpen=!1,this.playerControlsOpen=!1,this.exportAvailabilityChecked=!1,this.exportsEnabled=!1,this.exportDisabledReason="",this.recordingScriptsLoaded=!1,this._recordingBundleLoadingPromise=null,this.exportSetupPromise=null,this.videoExportManager=null,this.exportControlsContainer=null,this.exportStartButton=null,this.exportStopButton=null,this._exportActionPending=!1,this.exportWidgetToggleBtn=null,this.exportWidget=null,this.exportWidgetCloseBtn=null,this.exportWidgetCollapseBtn=null,this.exportPresetSelect=null,this.exportPresetSummary=null,this.exportFpsSelect=null,this.exportDurationInput=null,this.exportFilenameInput=null,this.exportWatermarkCheckbox=null,this.exportStatusLabel=null,this.exportCountdownRow=null,this.exportTimeRemainingLabel=null,this.exportMiniStatus=null,this.exportMiniStopBtn=null,this.exportMiniTimeLabel=null,this.exportWidgetVisible=!1,this.exportWidgetCollapsed=!1,this.exportCountdownInterval=null,this.exportCountdownEndsAt=null,this._exportStatusResetHandle=null,this._exportPresetCatalog={...FALLBACK_EXPORT_PRESETS},this._lastExportResult=null,this._exportStatusLocked=!1,this._exportFpsManuallySet=!1,this._exportWidgetResizeHandler=null,this.subscriptionPlan="free",this.subscriptionPlanFetched=!1,this.subscriptionPlanFetchPromise=null,this.exportEntitlements=this.buildExportEntitlements(this.subscriptionPlan),this.handlePlayerControlsPointerDown=this.handlePlayerControlsPointerDown.bind(this),this.handlePlayerControlsKeydown=this.handlePlayerControlsKeydown.bind(this),this.handleSourceOutsidePointerDown=this.handleSourceOutsidePointerDown.bind(this),this.handleVisualSearchOutsidePointer=this.handleVisualSearchOutsidePointer.bind(this),this.emitVisualVisibilityEvent=this.emitVisualVisibilityEvent.bind(this),this.handleExportStartClick=this.handleExportStartClick.bind(this),this.handleExportStopClick=this.handleExportStopClick.bind(this),this.handleExportsReadyEvent=this.handleExportsReadyEvent.bind(this),this.handleExportRecordingEvent=this.handleExportRecordingEvent.bind(this),this.handleExportWidgetToggle=this.handleExportWidgetToggle.bind(this),this.handleExportWidgetClose=this.handleExportWidgetClose.bind(this),this.handleExportPresetChange=this.handleExportPresetChange.bind(this),this.handleExportFpsChange=this.handleExportFpsChange.bind(this),this.handleExportDurationChange=this.handleExportDurationChange.bind(this),this.refreshExportCountdown=this.refreshExportCountdown.bind(this),this.handleQuickShareClick=this.handleQuickShareClick.bind(this),this.boundUpdateVisualSearchDropdownMaxHeight=this.updateVisualSearchDropdownMaxHeight.bind(this),this.quickStartModal=null,this.quickStartCloseBtn=null,this.quickStartStartBtn=null,this.quickStartStatusEl=null,this.demoAudioPromise=null,this.storageKeys={onboarding:"vvavyOnboardingSeen",soundCloudToken:"vvavySoundCloudToken",soundCloudHistory:"vvavySoundCloudHistory",termsAccepted:"vvavyAccepted",termsVersion:"vvavyTermsVersion"},this.onboardingStorageKey=this.storageKeys.onboarding,this.termsVersionStorageKey=this.storageKeys.termsVersion,this.isInitialized=!1,this.currentVisualizerName=null,this.soundCloudModal=null,this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="",this.soundCloudTokenStorageKey=this.storageKeys.soundCloudToken,this.soundCloudTokenSafetyWindowMs=15e3,this.soundCloudTokenCache=null,this.soundCloudRecentTracksKey=this.storageKeys.soundCloudHistory,this.soundCloudHistoryCache=null,this.soundCloudHistoryLimit=20,this.currentSoundCloudTrack=null,this.quickShareButtonDefaultLabel="Quick Share",this.quickShareFeedbackTimeout=null,this.quickLaunchIntent=this.detectQuickLaunchIntent(),this.quickLaunchPending=Boolean(this.quickLaunchIntent?.requested),this.quickLaunchSelectionHubWasHidden=!1,this.init()}getStorageItem(t,e){if(!t||!Array.isArray(e))return null;for(const i of e)if(i)try{const e=t.getItem(i);if(null!==e)return e}catch(t){}return null}setStorageItem(t,e,i){if(t&&e)try{t.setItem(e,i)}catch(t){}}getBooleanStorageValue(t,e){return"true"===this.getStorageItem(t,e)}markTermsAccepted({version:t}={}){if(this.setStorageItem(localStorage,this.storageKeys.termsAccepted,"true"),t){const e=this.termsVersionStorageKey||"vvavyTermsVersion";this.setStorageItem(localStorage,e,String(t))}this.updateVisualSearchVisibility()}hasCompletedOnboarding(){return Boolean(this.onboardingCompleted)}async init(){try{this.initializeDOMElements(),this.quickLaunchPending&&this.applyQuickLaunchUIState(),this.audioManager=new AudioManager,this.exportSetupPromise=this.prepareVideoExportCapability(),"undefined"!=typeof window&&(window.vvavyExportReady=this.exportSetupPromise),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);const t=1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupVisualizerSearch(),this.setupEventListeners(),this.setupDragAndDrop(),await this.checkSoundCloudAvailability(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=await this.applyLaunchParamsFromQuery(this.quickLaunchIntent?.lookup),i=Boolean(e?.visualHandled),s=Boolean(e?.visualHandled||e?.audioHandled);if(document.body?.classList.remove("vvavy-quick-launch"),!s&&this.quickLaunchSelectionHubWasHidden&&this.selectionHubElement?(this.selectionHubElement.classList.remove("hidden"),this.quickLaunchSelectionHubWasHidden=!1):s&&(this.quickLaunchSelectionHubWasHidden=!1),!i){const t=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(t)){await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t),this.updateVisualizerSummaryForSelection(t),this.highlightActiveVisualizer(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName)}else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t),this.updateVisualizerSummaryForSelection(t),this.highlightActiveVisualizer(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName)}}const a=this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted]);let r=!1;try{r="true"===this.getStorageItem(sessionStorage,[this.onboardingStorageKey])}catch(t){r=!1}s||!a||r||this.showGettingStartedOverlay(),r&&(this.onboardingCompleted=!0),this.isInitialized=!0,this.updateVisualSearchVisibility(),this.loadDemoAudioSilently()}catch(t){}}async ensureRecordingBundleLoaded(){this.recordingScriptsLoaded||"undefined"==typeof window||("function"!=typeof window.VideoExportManager?(this._recordingBundleLoadingPromise||(this._recordingBundleLoadingPromise=new Promise((t,e)=>{const i=document.querySelector("script[data-vvavy-recording-bundle]");if(i)return i.addEventListener("load",()=>{this.recordingScriptsLoaded=!0,t()},{once:!0}),void i.addEventListener("error",()=>{this.recordingScriptsLoaded=!1,this._recordingBundleLoadingPromise=null,e(new Error("Failed to load recording bundle scripts."))},{once:!0});const s=document.createElement("script");s.type="module",s.src="./recording/VideoExportManager.js",s.dataset.vvavyRecordingBundle="true",s.onload=()=>{this.recordingScriptsLoaded=!0,t()},s.onerror=()=>{this.recordingScriptsLoaded=!1,this._recordingBundleLoadingPromise=null,e(new Error("Failed to load recording bundle scripts."))},document.head.appendChild(s)})),await this._recordingBundleLoadingPromise):this.recordingScriptsLoaded=!0)}async prepareVideoExportCapability(){if(this.exportAvailabilityChecked)return this.exportsEnabled;"undefined"!=typeof window&&(window.vvavyRecorder=null);try{const t=await fetch("/api/exports/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json(),i=Boolean(e?.enabled);if(this.exportsEnabled=i,this.exportDisabledReason=e?.reason||"","undefined"!=typeof window&&(window.vvavyExportsEnabled=i,window.vvavyExportStatus={enabled:i,reason:this.exportDisabledReason}),!i)return this.exportAvailabilityChecked=!0,this.destroyExportControls(),this.updateExportWidgetAvailability(!0),"undefined"!=typeof window&&(window.vvavyRecorder=null,window.vvavyStartRecording=void 0,window.vvavyStopRecording=void 0),!1;if(await this.ensureRecordingBundleLoaded(),!this.videoExportManager){let t=null;if("undefined"!=typeof window&&"function"==typeof window.VideoExportManager)t=window.VideoExportManager;else if("function"==typeof VideoExportManager)t=VideoExportManager;else if("undefined"!=typeof window)try{const e=await import("./recording/VideoExportManager.js");t=e?.VideoExportManager||window.VideoExportManager||null}catch(t){}t&&(this.videoExportManager=new t(this),this.ensureExportControls(),"undefined"!=typeof window&&(window.vvavyRecorder=this.videoExportManager,window.vvavyStartRecording=async(t="vertical1080x1920",e={})=>{if(!this.videoExportManager)throw new Error("Video export manager is not ready.");const{maxDurationMs:i=3e4,watermark:s=!0,...a}=e??{};this.setExportActionPending(!0);try{const e=await this.videoExportManager.start({presetId:t,maxDurationMs:i,watermark:s,...a});return this.syncExportControlsState(),e}finally{this.setExportActionPending(!1),this.syncExportControlsState()}},window.vvavyStopRecording=async()=>{if(!this.videoExportManager)throw new Error("Video export manager is not ready.");this.setExportActionPending(!0);try{const t=await this.videoExportManager.stop();return this.syncExportControlsState(),t}finally{this.setExportActionPending(!1),this.syncExportControlsState()}}))}return this.ensureExportControls(),this.updateExportWidgetAvailability(!0),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("vvavy:exports-ready",{detail:{enabled:this.exportsEnabled,reason:this.exportDisabledReason,manager:this.videoExportManager||null}})),this.exportAvailabilityChecked=!0,!0}catch(t){return this.exportAvailabilityChecked=!0,this.exportsEnabled=!1,this.exportDisabledReason=t?.message||"Failed to check export availability.",this.updateExportWidgetAvailability(!0),"undefined"!=typeof window&&(window.vvavyExportsEnabled=!1,window.vvavyExportStatus={enabled:!1,reason:this.exportDisabledReason},window.vvavyRecorder=null,window.vvavyStartRecording=void 0,window.vvavyStopRecording=void 0),this.destroyExportControls(),!1}}setExportActionPending(t){this._exportActionPending=Boolean(t),this.syncExportControlsState()}ensureExportControls(){if("undefined"!=typeof document)if(this.exportsEnabled&&this.videoExportManager){if(!this.exportControlsContainer){const t=this.exportControlsContainer||this.exportWidget?.querySelector('[data-role="export-controls"]');if(!t)return;this.exportControlsContainer=t,this.exportStartButton=this.exportStartButton||t.querySelector("#exportStartBtn"),this.exportStopButton=this.exportStopButton||t.querySelector("#exportStopBtn"),this.exportStartButton&&this.exportStartButton.addEventListener("click",this.handleExportStartClick),this.exportStopButton&&this.exportStopButton.addEventListener("click",this.handleExportStopClick)}this.syncExportControlsState()}else this.destroyExportControls()}destroyExportControls(){this.exportStartButton&&this.exportStartButton.removeEventListener("click",this.handleExportStartClick),this.exportStopButton&&this.exportStopButton.removeEventListener("click",this.handleExportStopClick),this.exportControlsContainer?.parentNode&&this.exportControlsContainer!==this.exportWidget?.querySelector('[data-role="export-controls"]')&&this.exportControlsContainer.parentNode.removeChild(this.exportControlsContainer),this.exportControlsContainer=null,this.exportStartButton=null,this.exportStopButton=null,this._exportActionPending=!1}syncExportControlsState(){if(!this.exportControlsContainer)return;const t=this.videoExportManager?.isRecording?.()??!1,e=this._exportActionPending;this.exportControlsContainer.classList.toggle("is-recording",t),this.exportControlsContainer.classList.toggle("is-busy",e),this.exportStartButton&&(this.exportStartButton.disabled=e||t||!this.videoExportManager,this.exportStartButton.classList.toggle("hidden",t),this.exportStartButton.textContent=e&&!t?"Starting...":"Start Export"),this.exportStopButton&&(this.exportStopButton.disabled=e||!t,this.exportStopButton.classList.toggle("hidden",!t),this.exportStopButton.textContent=e&&t?"Stopping...":"Stop Export"),t?this.lockExportStatus("Recording in progress…"):e||this.updateExportWidgetAvailability()}handleExportStartClick(t){t?.preventDefault?.(),this.startExportRecording()}handleExportStopClick(t){t?.preventDefault?.(),this.stopExportRecording()}async startExportRecording(t={}){if(!this.exportsEnabled)return void this.setExportStatus(this.exportDisabledReason||"Exports unavailable.",{isError:!0,autoResetMs:5e3});if(this.videoExportManager||await this.prepareVideoExportCapability(),!this.videoExportManager||this.videoExportManager.isRecording?.())return void this.syncExportControlsState();try{await this.ensureSubscriptionPlan()}catch(t){}const e=this.getSelectedExportOptions(t),{presetId:i,maxDurationMs:s,watermark:a,fps:r,fileName:o}=e;this._lastExportResult=null,this.setExportActionPending(!0);try{await this.videoExportManager.start({presetId:i,maxDurationMs:s,watermark:a,fps:r,fileName:o}),this.lockExportStatus("Recording in progress…"),this.startExportCountdown(s),this.isMobileViewport()&&this.setExportWidgetCollapsed(!0)}catch(t){this.unlockExportStatus("Failed to start export.",{isError:!0,autoResetMs:5e3})}finally{this.setExportActionPending(!1),this.syncExportControlsState(),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}}async stopExportRecording(){if(!this.videoExportManager?.isRecording?.())return void this.syncExportControlsState();this.setExportActionPending(!0);let t=null;try{t=await this.videoExportManager.stop(),this.handleExportCompleted(t)}catch(t){this.stopExportCountdown(),this.unlockExportStatus("Failed to stop export.",{isError:!0,autoResetMs:5e3})}finally{this.setExportActionPending(!1),this.syncExportControlsState(),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}}handleExportCompleted(t){if(this.stopExportCountdown(),!t)return void this.updateExportWidgetAvailability(!0);this._lastExportResult=t;const e=this.resolveExportFilename(t);let i=`Export saved as ${e}`;!1===t.audioIncluded&&(i+=" (visual-only export)"),this.unlockExportStatus(i,{autoResetMs:6e3}),this.autoDownloadExportResult(t,e),window.setTimeout(()=>{this._lastExportResult=null,this.updateExportWidgetAvailability(!0)},6200)}handleExportsReadyEvent(t){const e=t?.detail||{};"boolean"==typeof e.enabled&&(this.exportsEnabled=e.enabled),e.manager&&(this.videoExportManager=e.manager),this.exportsEnabled&&this.videoExportManager?this.ensureExportControls():this.destroyExportControls(),this.syncExportControlsState(),this.updateExportWidgetAvailability(!0)}handleExportRecordingEvent(t){const e=t?.detail||{};if(e.manager&&!this.videoExportManager&&(this.videoExportManager=e.manager),"boolean"==typeof e.isRecording)if(e.isRecording){const t="function"==typeof e.manager?.getActiveRecordingMeta?e.manager.getActiveRecordingMeta():this.videoExportManager?.getActiveRecordingMeta?.();if(t?.maxDurationMs){const e=Math.max(0,performance.now()-(t.startedAt||performance.now())),i=Math.max(0,t.maxDurationMs-e);this.startExportCountdown(i||t.maxDurationMs)}this.lockExportStatus("Recording in progress…")}else this.stopExportCountdown(),this._exportActionPending||this._lastExportResult||this.updateExportWidgetAvailability(!0);this.syncExportControlsState(),(e.isRecording||!e.isRecording&&!this._lastExportResult)&&this.updateExportWidgetAvailability(!0),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}async checkSoundCloudAvailability(){try{const t=await fetch("/api/soundcloud/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json(),i=Boolean(e?.enabled),s=e?.reason||"";this.soundCloudEnabled=i,this.soundCloudAvailabilityMessage=s;const a=i?"SoundCloud streaming is ready. Search for any track to jump straight into the visuals.":s||"Start the Vvavy server to enable SoundCloud integration.";this.setSourceAvailability("soundcloud",i,a)}catch(t){this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="Start the Vvavy server to enable SoundCloud integration.",this.setSourceAvailability("soundcloud",!1,this.soundCloudAvailabilityMessage)}}getCachedSoundCloudToken(){if(this.soundCloudTokenCache?.accessToken)return this.soundCloudTokenCache;try{const t=this.getStorageItem(sessionStorage,[this.soundCloudTokenStorageKey]);if(!t)return null;const e=JSON.parse(t);if(e&&"object"==typeof e&&e.accessToken)return this.soundCloudTokenCache=e,e}catch(t){}return null}storeSoundCloudToken(t){this.soundCloudTokenCache=t;const e=JSON.stringify(t);this.setStorageItem(sessionStorage,this.soundCloudTokenStorageKey,e)}clearSoundCloudToken(){this.soundCloudTokenCache=null;try{sessionStorage.removeItem(this.soundCloudTokenStorageKey)}catch(t){}}getSoundCloudHistory(){if(!Array.isArray(this.soundCloudHistoryCache)){let t=[];try{const e=this.getStorageItem(sessionStorage,[this.soundCloudRecentTracksKey]);if(e){const i=JSON.parse(e);Array.isArray(i)&&(t=i)}}catch(t){}this.soundCloudHistoryCache=t}return Array.isArray(this.soundCloudHistoryCache)?this.soundCloudHistoryCache.slice():[]}setSoundCloudHistory(t){const e=Array.isArray(t)?t.slice(0,this.soundCloudHistoryLimit):[];this.soundCloudHistoryCache=e;const i=JSON.stringify(e);if(this.setStorageItem(sessionStorage,this.soundCloudRecentTracksKey,i),this.soundCloudModal?.renderHistory)try{this.soundCloudModal.renderHistory(this.getSoundCloudHistory())}catch(t){}}rememberSoundCloudTrack(t){if(!t||"object"!=typeof t)return;const e=null!=t.id?String(t.id):"",i=t.permalinkUrl?String(t.permalinkUrl):"";if(!e&&!i)return;const s={id:e||null,permalinkUrl:i||null,title:t.title||"Untitled track",artist:t.author?.username||null,artworkUrl:t.artworkUrl||null,duration:"number"==typeof t.duration?t.duration:null,lastPlayed:Date.now()},a=this.getSoundCloudHistory().filter(t=>{if(!t||"object"!=typeof t)return!1;const e=s.id&&t.id&&String(t.id)===s.id,i=s.permalinkUrl&&t.permalinkUrl&&t.permalinkUrl===s.permalinkUrl;return!(e||i)});a.unshift(s),this.setSoundCloudHistory(a.slice(0,this.soundCloudHistoryLimit))}async getSoundCloudToken(t=!1){if(!t){const t=this.getCachedSoundCloudToken();if(t?.accessToken&&Number.isFinite(t.expiresAt)&&Date.now()+this.soundCloudTokenSafetyWindowMs<t.expiresAt)return t.accessToken}let e;try{e=await fetch("/api/soundcloud/token",{method:"GET",credentials:"same-origin"})}catch(t){throw new Error("Failed to contact SoundCloud token endpoint.")}if(!e?.ok){let t=`Token request failed (status ${e?.status??"unknown"})`;try{const i=await e.json();i?.error&&(t=i.error)}catch(t){}throw new Error(t)}let i=null;try{i=await e.json()}catch(t){throw new Error("Failed to parse SoundCloud token response.")}if(!i?.accessToken)throw new Error("SoundCloud token response did not include an access token.");const s=Number(i.expiresIn),a=Date.now()+(Number.isFinite(s)&&s>0?1e3*s:36e5),r={accessToken:i.accessToken,expiresAt:a};return this.storeSoundCloudToken(r),r.accessToken}buildSoundCloudUrl(t,e){const i=/^https?:\/\//i.test(t)?new URL(t):new URL(t,"https://api.soundcloud.com");return e&&"object"==typeof e&&Object.entries(e).forEach(([t,e])=>{if(null==e)return;const s=Array.isArray(e)?e:[e];i.searchParams.delete(t),s.forEach(e=>{const s=null==e?"":String(e);i.searchParams.append(t,s)})}),i.toString()}async performSoundCloudFetch(t,{method:e="GET",headers:i={},query:s,body:a,expectJson:r=!0}={},o=0){const n=this.buildSoundCloudUrl(t,s),l=await this.getSoundCloudToken(o>0),u={...i,Authorization:`Bearer ${l}`};r&&!u.Accept?u.Accept="application/json":r||u.Accept||(u.Accept="*/*");const d={method:e,headers:u,credentials:"omit"};let h;null!=a&&("object"!=typeof a||a instanceof Blob||a instanceof FormData?d.body=a:(d.body=JSON.stringify(a),d.headers["Content-Type"]||(d.headers["Content-Type"]="application/json")));try{h=await fetch(n,d)}catch(t){throw new Error(`SoundCloud request failed: ${t.message||t}`)}if(401===h.status&&0===o)return this.clearSoundCloudToken(),this.performSoundCloudFetch(t,{method:e,headers:i,query:s,body:a,expectJson:r},o+1);if(!h.ok){let t="";try{t=await h.text()}catch(e){t=""}const e=t?`: ${t}`:"";throw new Error(`SoundCloud request failed (${h.status})${e}`)}if(!r)return h;const c=await h.text();if(!c)return null;try{return JSON.parse(c)}catch(t){throw new Error(`Failed to parse SoundCloud response: ${t.message}`)}}async fetchSoundCloudAPI(t,e={}){return this.performSoundCloudFetch(t,e)}sanitizeSoundCloudTrackId(t){if(null==t)return"";const e=String(t).trim();if(!e)return"";if(/^soundcloud:tracks:/i.test(e)){const t=e.split(":");return t[t.length-1]}return e}pickBestSoundCloudTranscoding(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(t=>"progressive"===t?.format?.protocol);return e||(t.find(t=>"hls"===t?.format?.protocol)||t[0])}selectPreferredStreamUrl(t){if(!t||"object"!=typeof t)return null;const e=[t.http_mp3_128_url,t.http_mp3_64_url,t.http_opus_64_url,t.hls_mp3_128_url,t.hls_mp3_64_url,t.hls_opus_64_url,t.hls_url,t.progressive_mp3_url,t.preview_mp3_128_url,t.url];for(const t of e)if(t&&"string"==typeof t)return t;return null}async fetchSoundCloudStreamData(t){if(!t?.id&&!this.sanitizeSoundCloudTrackId(t))throw new Error("Unable to determine SoundCloud track ID.");const e=[];t?.stream_url&&e.push(t.stream_url);let i=null;for(const t of e)if(t)try{const e=await this.fetchSoundCloudAPI(t,{expectJson:!1});if(!e){i=new Error("SoundCloud stream endpoint returned no response.");continue}const s=e.headers;if((s?.get&&s.get("content-type")||"").includes("application/json")){let t=null;try{t=await e.json()}catch(t){i=t}const s=this.selectPreferredStreamUrl(t);if(s)return{streamUrl:s,data:t};i=new Error("SoundCloud stream response did not include a usable URL.");continue}const a=()=>{try{e.body?.cancel?.()}catch(t){}},r=s?.get?s.get("location"):null;if(r)return a(),{streamUrl:r,data:null};if(e.url)return a(),{streamUrl:e.url,data:null};i=new Error("SoundCloud stream endpoint returned an unexpected response.")}catch(t){i=t}if(i)throw i;throw new Error("SoundCloud stream URL is unavailable.")}async fetchSoundCloudTrackById(t){const e=this.sanitizeSoundCloudTrackId(t);if(!e)throw new Error("Track ID is required.");const i=await this.fetchSoundCloudAPI("/tracks",{query:{ids:e}}),s=Array.isArray(i)?i:[];if(!s.length)throw new Error("Track not found on SoundCloud.");return s[0]}async fetchSoundCloudTranscodingUrl(t){if(!t)throw new Error("Transcoding URL is required.");return this.performSoundCloudFetch(t,{expectJson:!0})}openSoundCloudModal(){const t=this.ensureSoundCloudModal();t.form?.reset();const e=this.getSoundCloudHistory();if(t.setLoading?.(!1),t.sortedResults=[],t.nextHref=null,t.totalAvailable=0,t.currentPage=1,t.fetchingMorePromise=null,t.searchQuery="","function"==typeof t.renderResults&&t.renderResults([]),"function"==typeof t.updatePaginationControls&&t.updatePaginationControls(),"function"==typeof t.renderHistory)try{t.renderHistory(e)}catch(t){}t.hasSearched=!1,t.searchInProgress=!1,t.input&&(t.input.disabled=!1),t.cancel&&(t.cancel.disabled=!1),t.overlay.classList.add("active"),setTimeout(()=>{t.input?.focus()},60)}ensureSoundCloudModal(){if(this.soundCloudModal)return this.soundCloudModal;const t=document.createElement("div");t.className="soundcloud-overlay",t.innerHTML='\n            <div class="soundcloud-modal" role="dialog" aria-modal="true">\n                <div class="soundcloud-modal-content">\n                    <form class="soundcloud-modal-form">\n                        <label class="soundcloud-modal-label" for="soundcloudSearchInput">Search SoundCloud</label>\n                        <div class="soundcloud-modal-search-row">\n                            <input type="text" id="soundcloudSearchInput" class="soundcloud-modal-input" name="soundcloudSearch" placeholder="Search for artists, tracks, or genres" autocomplete="off" />\n                            <button type="submit" class="soundcloud-modal-search">Search</button>\n                        </div>\n                    </form>\n                    <div class="soundcloud-modal-body">\n                        <section class="soundcloud-modal-main" aria-label="SoundCloud search results">\n                            <div class="soundcloud-history-header">\n                                <h3>Search Results</h3>\n                            </div>\n                            <div class="soundcloud-modal-status" aria-live="polite"></div>\n                            <div class="soundcloud-modal-results" role="listbox" aria-label="SoundCloud search results"></div>\n                            <div class="soundcloud-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn prev" aria-label="Previous page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn next" aria-label="Next page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                        <section id="soundcloud-modal-history" class="soundcloud-modal-main" aria-label="Recently played SoundCloud tracks">\n                            <div class="soundcloud-history-header">\n                                <h3>Recently Played</h3>\n                            </div>\n                            <div id="soundcloud-history-list" class="soundcloud-modal-results"></div>\n                            <div class="soundcloud-pagination soundcloud-history-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn prev" aria-label="Previous history page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info soundcloud-history-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn next" aria-label="Next history page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                    </div>\n                </div>\n                <div class="modal-footer soundcloud-modal-footer">\n                    <button type="button" class="soundcloud-modal-cancel">Close</button>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const e=t.querySelector(".soundcloud-modal-main"),i=t.querySelector("#soundcloud-modal-history"),s={overlay:t,form:t.querySelector(".soundcloud-modal-form"),input:t.querySelector("#soundcloudSearchInput"),cancel:t.querySelector(".soundcloud-modal-cancel"),closeBtn:t.querySelector(".soundcloud-modal-close"),status:t.querySelector(".soundcloud-modal-status"),searchBtn:t.querySelector(".soundcloud-modal-search"),results:t.querySelector(".soundcloud-modal-results"),historySection:i,historyList:i?.querySelector("#soundcloud-history-list")||null,pagination:e?.querySelector(".soundcloud-pagination")||null,paginationPrev:e?.querySelector(".soundcloud-page-btn.prev")||null,paginationNext:e?.querySelector(".soundcloud-page-btn.next")||null,paginationInfo:e?.querySelector(".soundcloud-page-info")||null,historyPagination:i?.querySelector(".soundcloud-history-pagination")||null,historyPaginationPrev:i?.querySelector(".soundcloud-history-page-btn.prev")||null,historyPaginationNext:i?.querySelector(".soundcloud-history-page-btn.next")||null,historyPaginationInfo:i?.querySelector(".soundcloud-history-page-info")||null,currentResults:[],hasSearched:!1,searchInProgress:!1,sortedResults:[],pageSize:10,currentPage:1,nextHref:null,totalAvailable:0,fetchingMorePromise:null,searchQuery:"",historyEntries:[],historyPageSize:10,historyCurrentPage:1},a=(t,e=!1)=>{s.status&&(s.status.textContent=t||"",s.status.classList.toggle("error",Boolean(t&&e)))},r=t=>{s.cancel&&(s.cancel.disabled=t),s.input&&(s.input.disabled=t),s.searchBtn&&(s.searchBtn.disabled=t)},o=t=>{const e=Math.max(0,Math.floor((Number(t)||0)/1e3));return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`},n=(()=>{try{return new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1})}catch(t){return null}})(),l=t=>{if(!t)return{tracks:[],nextHref:null,total:0};if(Array.isArray(t))return{tracks:t,nextHref:null,total:t.length};const e=Array.isArray(t.collection)?t.collection:null,i=Array.isArray(t.tracks)?t.tracks:null,s=t.next_href||t.nextHref||null,a=[t.total_results,t.total,t.collection_size,Array.isArray(e)?e.length:null,Array.isArray(i)?i.length:null].find(t=>"number"==typeof t&&t>=0);return e?{tracks:e,nextHref:s,total:"number"==typeof a?a:e.length}:i?{tracks:i,nextHref:s,total:"number"==typeof a?a:i.length}:{tracks:[],nextHref:s,total:"number"==typeof a?a:0}},u=()=>{if(!s.pagination)return;const t=s.sortedResults.length>0;if(s.pagination.style.display=t?"flex":"none",!t)return s.paginationInfo&&(s.paginationInfo.textContent="Page 1"),s.paginationPrev&&(s.paginationPrev.disabled=!0),void(s.paginationNext&&(s.paginationNext.disabled=!0));const e=Math.max(s.sortedResults.length,s.totalAvailable||0),i=Math.max(1,Math.ceil(e/s.pageSize));if(s.currentPage=Math.min(Math.max(s.currentPage,1),i),s.paginationPrev&&(s.paginationPrev.disabled=s.currentPage<=1),s.paginationNext){const t=Math.ceil(s.sortedResults.length/s.pageSize),e=s.currentPage>=t;s.paginationNext.disabled=e&&!s.nextHref||0===s.sortedResults.length}if(s.paginationInfo)if(s.sortedResults.length){const t=(s.currentPage-1)*s.pageSize+1,e=Math.min(s.currentPage*s.pageSize,s.sortedResults.length),i=Math.max(s.sortedResults.length,s.totalAvailable||0),a=s.nextHref&&i<=s.sortedResults.length?`${s.sortedResults.length}+`:i;s.paginationInfo.textContent=`Page ${s.currentPage} • ${t}-${e} of ${a}`}else s.paginationInfo.textContent="Page 1"},d=()=>{if(!s.sortedResults.length)return p([]),void u();a("");const t=Math.max(1,Math.ceil(s.sortedResults.length/s.pageSize));s.currentPage>t&&(s.currentPage=t);const e=(s.currentPage-1)*s.pageSize,i=e+s.pageSize,r=s.sortedResults.slice(e,i);p(r),u()},h=(t=[],{append:e=!1,nextHref:i=null,total:a=null}={})=>{const r=Array.isArray(t)?t:[],o=e?s.sortedResults.concat(r):r;s.sortedResults=((t=[])=>t.filter(t=>t&&"object"==typeof t).slice().sort((t,e)=>{const i=Number(t?.playback_count)||0,s=Number(e?.playback_count)||0;return i===s?0:s-i}))(((t=[])=>{const e=new Set,i=[];return t.forEach(t=>{if(!t||"object"!=typeof t)return;const s=null!=t.id?`id:${t.id}`:null,a=t.permalink_url||t.permalinkUrl||"",r=s||(a?`url:${a}`:null);r&&e.has(r)||(r&&e.add(r),i.push(t))}),i})(o)),e||(s.currentPage=1),s.totalAvailable="number"==typeof a&&a>=0?Math.max(a,s.sortedResults.length):e?Math.max(s.totalAvailable||0,s.sortedResults.length):s.sortedResults.length,s.nextHref=i||null,d()},c=async()=>{if(!s.nextHref)return!1;if(s.fetchingMorePromise)return await s.fetchingMorePromise,!0;const t=s.status?.textContent||"";return s.fetchingMorePromise=(async()=>{r(!0),a("Loading more SoundCloud tracks...");try{const t=await this.fetchSoundCloudAPI(s.nextHref,{query:{linked_partitioning:"1"}}),{tracks:e,nextHref:i,total:r}=l(t);h(e,{append:!0,nextHref:i,total:r}),s.sortedResults.length?a(""):a("No additional tracks found.")}catch(t){a(t?.message||"Failed to load more SoundCloud tracks.",!0),s.nextHref=null}finally{!s.sortedResults.length&&t&&a(t),r(!1),s.fetchingMorePromise=null}})(),await s.fetchingMorePromise,s.sortedResults.length>0},p=(t=[])=>{if(s.currentResults=Array.isArray(t)?t:[],!s.results)return;if(s.results.innerHTML="",s.results.scrollTop=0,!s.currentResults.length){if(s.hasSearched&&!s.searchInProgress){const t=document.createElement("div");t.className="soundcloud-results-empty",t.textContent="No tracks found. Try another search term.",s.results.appendChild(t)}return}const e=document.createElement("div");e.className="soundcloud-results-list",s.currentResults.forEach(t=>{if(!t||"object"!=typeof t)return;const i=document.createElement("button");i.type="button",i.className="soundcloud-search-item",i.dataset.trackId=null!=t.id?String(t.id):"",i.dataset.trackPermalink=t.permalink_url||t.permalinkUrl||"",i.dataset.trackTitle=t.title||"",i.setAttribute("role","option"),i.setAttribute("aria-selected","false");const s=document.createElement("div");s.className="soundcloud-search-item-text";const a=document.createElement("div");a.className="soundcloud-search-title",a.textContent=t.title||"Untitled track";const r=document.createElement("div");r.className="soundcloud-search-meta";const l=[];t.user?.username&&l.push(t.user.username),t.duration&&l.push(o(t.duration));const u=(t=>{const e=Number(t);if(!Number.isFinite(e)||e<0)return null;if(n)return n.format(e);try{return e.toLocaleString()}catch(t){return String(e)}})(t.playback_count);u&&l.push(`${u} plays`),r.textContent=l.join(" • "),s.appendChild(a),s.appendChild(r);const d=document.createElement("span");d.className="soundcloud-search-play",d.textContent="▶",i.appendChild(s),i.appendChild(d),i.dataset.trackId||i.dataset.trackPermalink||(i.disabled=!0),e.appendChild(i)}),s.results.appendChild(e)},m=()=>{if(!s.historyPagination)return;const t=s.historyEntries.length,e=t>0;if(s.historyPagination.style.display=e?"flex":"none",!e)return s.historyPaginationInfo&&(s.historyPaginationInfo.textContent="Page 1"),s.historyPaginationPrev&&(s.historyPaginationPrev.disabled=!0),void(s.historyPaginationNext&&(s.historyPaginationNext.disabled=!0));const i=Math.max(1,Math.ceil(t/s.historyPageSize));if(s.historyCurrentPage=Math.min(Math.max(s.historyCurrentPage,1),i),s.historyPaginationPrev&&(s.historyPaginationPrev.disabled=s.historyCurrentPage<=1),s.historyPaginationNext&&(s.historyPaginationNext.disabled=s.historyCurrentPage>=i),s.historyPaginationInfo){const e=(s.historyCurrentPage-1)*s.historyPageSize+1,i=Math.min(s.historyCurrentPage*s.historyPageSize,t);s.historyPaginationInfo.textContent=`Page ${s.historyCurrentPage} • ${e}-${i} of ${t}`}},S=()=>{if(!s.historyList)return;s.historyList.innerHTML="";const t=s.historyEntries;if(!t.length){s.historySection&&s.historySection.classList.add("soundcloud-history-empty");const t=document.createElement("div");return t.className="soundcloud-history-empty",t.textContent="Play SoundCloud tracks to build your recent history.",s.historyList.appendChild(t),void m()}s.historySection&&s.historySection.classList.remove("soundcloud-history-empty");const e=Math.max(1,Math.ceil(t.length/s.historyPageSize));s.historyCurrentPage=Math.min(Math.max(s.historyCurrentPage,1),e);const i=(s.historyCurrentPage-1)*s.historyPageSize,a=i+s.historyPageSize,r=t.slice(i,a),n=document.createElement("div");n.className="soundcloud-history-items",r.forEach(t=>{if(!t||"object"!=typeof t)return;const e=document.createElement("button");e.type="button",e.className="soundcloud-history-item soundcloud-search-item",e.dataset.trackId=null!=t.id?String(t.id):"",e.dataset.trackPermalink=t.permalinkUrl||"",e.dataset.trackTitle=t.title||"",e.setAttribute("role","option"),e.setAttribute("aria-selected","false");const i=document.createElement("div");i.className="soundcloud-search-item-text";const s=document.createElement("div");s.className="soundcloud-search-title",s.textContent=t.title||"Untitled track";const a=document.createElement("div");a.className="soundcloud-search-meta";const r=[];t.artist&&r.push(t.artist),t.duration&&r.push(o(t.duration)),r.push("Recently played"),a.textContent=r.join(" • "),i.appendChild(s),i.appendChild(a),e.appendChild(i),n.appendChild(e)}),s.historyList.appendChild(n),m()},g=(t=this.getSoundCloudHistory(),{preservePage:e=!1}={})=>{const i=Array.isArray(t)?t.filter(t=>t&&"object"==typeof t).sort((t,e)=>(Number(e.lastPlayed)||0)-(Number(t.lastPlayed)||0)):[];i.length>this.soundCloudHistoryLimit&&(i.length=this.soundCloudHistoryLimit),s.historyEntries=i;const a=Math.max(1,Math.ceil(i.length/s.historyPageSize));s.historyCurrentPage=e?Math.min(Math.max(s.historyCurrentPage,1),a):1,S(),!e&&s.historyList&&(s.historyList.scrollTop=0)},y=()=>{t.classList.remove("active"),s.form&&s.form.reset(),a(""),r(!1),s.hasSearched=!1,s.searchInProgress=!1,s.sortedResults=[],s.nextHref=null,s.totalAvailable=0,s.currentPage=1,s.fetchingMorePromise=null,s.searchQuery="",p([]),u(),g(this.getSoundCloudHistory())};s.close=y,s.setStatus=a,s.setLoading=r,s.renderResults=p,s.renderHistory=g,s.updatePaginationControls=u,s.paginationPrev?.addEventListener("click",t=>{t.preventDefault(),s.searchInProgress||s.currentPage<=1||(s.currentPage=Math.max(1,s.currentPage-1),d(),s.results?.scrollTo({top:0,behavior:"smooth"}))}),s.paginationNext?.addEventListener("click",async t=>{if(t.preventDefault(),s.searchInProgress)return;const e=s.currentPage+1,i=(e-1)*s.pageSize+1;s.sortedResults.length<i&&s.nextHref&&(s.paginationNext.disabled=!0,await c()),e<=Math.max(1,Math.ceil(s.sortedResults.length/s.pageSize))&&(s.currentPage=e),d(),s.results?.scrollTo({top:0,behavior:"smooth"})}),s.historyPaginationPrev?.addEventListener("click",t=>{t.preventDefault(),s.historyCurrentPage<=1||(s.historyCurrentPage=Math.max(1,s.historyCurrentPage-1),S(),s.historyList?.scrollTo({top:0,behavior:"smooth"}))}),s.historyPaginationNext?.addEventListener("click",t=>{t.preventDefault();const e=Math.max(1,Math.ceil(s.historyEntries.length/s.historyPageSize));s.historyCurrentPage>=e||(s.historyCurrentPage=Math.min(e,s.historyCurrentPage+1),S(),s.historyList?.scrollTo({top:0,behavior:"smooth"}))});const v=async()=>{const t=s.input?.value?.trim();if(!t)return a("Enter a search term to continue.",!0),!1;if(t.length<3)return a("Search term must be at least 3 characters.",!0),!1;s.hasSearched=!0,s.searchInProgress=!0,s.searchQuery=t,s.sortedResults=[],s.currentPage=1,s.nextHref=null,s.totalAvailable=0,p([]),u(),a("Searching SoundCloud..."),r(!0);try{const e=Math.min(5*s.pageSize,50),i=await this.fetchSoundCloudAPI("/tracks",{query:{q:t,limit:String(e),linked_partitioning:"1"}}),{tracks:r,nextHref:o,total:n}=l(i);return h(r,{append:!1,nextHref:o,total:n}),s.sortedResults.length||o?(a(""),s.sortedResults.length>0||Boolean(o)):(a("No tracks found. Try another search.",!0),!1)}catch(t){return a(t?.message||"Failed to search SoundCloud.",!0),s.sortedResults=[],s.nextHref=null,p([]),u(),!1}finally{s.searchInProgress=!1,r(!1),d()}};s.closeBtn?.addEventListener("click",y),s.cancel?.addEventListener("click",t=>{t.preventDefault(),y()}),t.addEventListener("click",e=>{e.target===t&&y()}),s.searchBtn?.addEventListener("click",async t=>{t.preventDefault(),await v()});const x=async t=>{if(!t)return;const e=t.dataset.trackId,i=t.dataset.trackPermalink||e;if(!i)return void a("Unable to load this track.",!0);const s=t.dataset.trackTitle||"SoundCloud track";a(`Loading "${s}"...`),r(!0);try{const t=await this.resolveSoundCloudTrack(i);y(),await this.loadSoundCloudTrack(t,{pauseBeforeLoad:!0,autoPlay:!0})}catch(t){a(t?.message||"Failed to load SoundCloud track.",!0),r(!1)}};return s.results?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-search-item");t.preventDefault(),await x(e)}),s.historyList?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-history-item");e&&(t.preventDefault(),await x(e))}),s.form?.addEventListener("submit",async t=>{t.preventDefault(),await v()}),g(this.getSoundCloudHistory()),u(),this.soundCloudModal=s,s}async resolveSoundCloudTrack(t){const e=(t||"").trim();if(!e)throw new Error("Please provide a SoundCloud track reference.");let i=null,s=null;const a=this.sanitizeSoundCloudTrackId(e);if(/^[0-9]+$/.test(a)&&a)s=a,i=await this.fetchSoundCloudTrackById(s);else{let t;try{t=await this.fetchSoundCloudAPI("/resolve",{query:{url:e}})}catch(t){throw new Error(t?.message||"Failed to resolve SoundCloud track.")}if(!t)throw new Error("SoundCloud resolve returned no data.");if("track"===t.kind)i=t,s=this.sanitizeSoundCloudTrackId(t.id);else{if(!t.location)throw new Error(`Resolved resource is not a track (${t.kind||"unknown"}).`);try{const e=new URL(t.location,"https://api.soundcloud.com").pathname.split("/").filter(Boolean);if(s=this.sanitizeSoundCloudTrackId(e[e.length-1]),!s)throw new Error("Unable to determine track ID from SoundCloud resolve response.");i=await this.fetchSoundCloudTrackById(s)}catch(t){throw new Error(t?.message||"Failed to follow SoundCloud resolve redirect.")}}if(!i?.media){const t=i?.id||s;if(!t)throw new Error("Unable to determine SoundCloud track ID.");i=await this.fetchSoundCloudTrackById(t)}}if(!i)throw new Error("Failed to load SoundCloud track data.");if(!1===i.streamable)throw new Error("This SoundCloud track does not permit streaming via the API.");if("string"==typeof i.policy&&"block"===i.policy.toLowerCase())throw new Error("SoundCloud has blocked API streaming for this track.");let r=null,o=null,n=null;try{const t=await this.fetchSoundCloudStreamData(i);r=t?.streamUrl||null,o=t?.data||null}catch(t){}if(!r){const t=i.media?.transcodings||[],e=this.pickBestSoundCloudTranscoding(t);if(!e?.url)throw new Error("Track has no available streamable formats.");let s;try{s=await this.fetchSoundCloudTranscodingUrl(e.url)}catch(t){throw new Error(t?.message||"Failed to obtain SoundCloud stream URL.")}const a=this.selectPreferredStreamUrl(s)||s?.url||null;if(!a)throw new Error("SoundCloud did not return a usable stream URL for this track.");r=a,o=s||null,n=e}return{id:i.id,title:i.title,duration:i.duration,permalinkUrl:i.permalink_url||i.permalinkUrl||null,artworkUrl:i.artwork_url||i.user?.avatar_url||null,author:i.user?{id:i.user.id,username:i.user.username,permalink:i.user.permalink_url||null,avatarUrl:i.user.avatar_url||null}:null,streamUrl:r,streamMetadata:o,waveformUrl:i.waveform_url||null,media:{format:n?.format||null,preset:n?.preset||null,quality:n?.quality||null,protocol:n?.format?.protocol||n?.protocol||o?.protocol||null,streamType:o?.stream_type||null}}}async pausePlayback({stopVisualizer:t=!0,includeMic:e=!1}={}){try{this.audioManager&&(this.audioManager.isPlaying&&this.audioManager.pause(),e&&this.audioManager.isMicActive&&(await this.audioManager.stopMicrophone(),this.hideNowPlaying()))}catch(t){}finally{t&&this.currentVisualizer?.isAnimating&&!this.audioManager?.isPlaying&&!this.audioManager?.isMicActive&&this.currentVisualizer.stop(),this.updateControlButtons(!1,this.audioManager?.isMicActive)}}async loadSoundCloudTrack(t,{pauseBeforeLoad:e=!0,autoPlay:i=!1}={}){if(!t?.streamUrl)throw new Error("SoundCloud stream is unavailable for this track.");const s=this.showLoadingMessage("Loading SoundCloud track...");try{e?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),await this.audioManager.loadStreamFromUrl(t.streamUrl),this.rememberSoundCloudTrack(t),this.hideLoadingMessage(s),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint();const a=t.author?.username||"SoundCloud",r="string"==typeof t.permalinkUrl?t.permalinkUrl:t.permalink_url,o=t.author?.permalink,n=t.artworkUrl||t.artwork_url||t.author?.avatarUrl||null,l=t.author?.avatarUrl||null,u="string"==typeof r&&/^https?:\/\//i.test(r),d="string"==typeof o&&/^https?:\/\//i.test(o);!t.artworkUrl&&n&&(t.artworkUrl=n),l&&t.author&&!t.author.avatarUrl&&(t.author.avatarUrl=l),this.updateNowPlaying(t.title||"Unknown Track",a,{source:"soundcloud",isSoundCloud:!0,trackUrl:u?r:null,artistUrl:d?o:null,trackLinkLabel:u?"Listen on SoundCloud":"Creator on SoundCloud",artworkUrl:n,artistImageUrl:l,duration:t.duration}),this.updateControlButtons(!1,!1),(i||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150);const h=this.sanitizeSoundCloudTrackId(t.id);this.currentSoundCloudTrack={id:h||null,title:t.title||"",permalinkUrl:t.permalinkUrl||t.permalink_url||null,artist:t.author?.username||null},this.updateShareButtonState()}catch(t){throw this.hideLoadingMessage(s),t}}buildQuickShareUrl(){if("undefined"==typeof window)return null;if(!this.currentVisualizerName)return null;const t=this.sanitizeSoundCloudTrackId(this.currentSoundCloudTrack?.id||this.currentSoundCloudTrack?.permalinkUrl||"");if(!t)return null;const e=new URL(window.location.pathname,window.location.origin);return e.searchParams.set("visual",this.currentVisualizerName),e.searchParams.set("audioSource","soundcloud"),e.searchParams.set("uuid",t),e.searchParams.set("autoplay","true"),e.toString()}getActiveVisualizerShareLabel(){if(!this.currentVisualizerName)return"VVavy Visualizer";try{const t=this.visualizerMetadataByName?.get(this.currentVisualizerName);if(t?.displayName)return`${t.displayName} Visualizer`.trim()}catch(t){}return`${this.currentVisualizerName.replace(/Visualizer$/i,"")||this.currentVisualizerName} Visualizer`.trim()}resetQuickShareButtonLabel(){if(!this.quickShareBtn)return;this.quickShareBtn.textContent=this.quickShareButtonDefaultLabel;const t=(this.currentSoundCloudTrack?.title||"").trim(),e=this.getActiveVisualizerShareLabel(),i="soundcloud"===this.currentSourceType&&t?`Share "${t}" with the ${e}`:"Share current SoundCloud visual";this.quickShareBtn.setAttribute("aria-label",i)}updateShareButtonState(){if(!this.quickShareBtn)return;const t="soundcloud"===this.currentSourceType&&Boolean(this.currentSoundCloudTrack?.id)&&Boolean(this.currentVisualizerName);!t&&this.quickShareFeedbackTimeout&&(clearTimeout(this.quickShareFeedbackTimeout),this.quickShareFeedbackTimeout=null),this.quickShareBtn.disabled=!t,t?this.quickShareBtn.removeAttribute("title"):this.quickShareBtn.setAttribute("title","Load a SoundCloud track to share"),this.quickShareFeedbackTimeout||this.resetQuickShareButtonLabel()}showQuickShareFeedback(t,e=2e3){this.quickShareBtn&&(this.quickShareFeedbackTimeout&&(clearTimeout(this.quickShareFeedbackTimeout),this.quickShareFeedbackTimeout=null),this.quickShareBtn.textContent=t,this.quickShareBtn.setAttribute("aria-label",t),"undefined"!=typeof window&&e>0&&(this.quickShareFeedbackTimeout=window.setTimeout(()=>{this.quickShareFeedbackTimeout=null,this.resetQuickShareButtonLabel(),this.updateShareButtonState()},e)))}fallbackCopyToClipboard(t){if("undefined"==typeof document)return!1;try{const e=document.createElement("textarea");e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),e.select();const i=document.execCommand("copy");return document.body.removeChild(e),i}catch(t){return!1}}async handleQuickShareClick(t){if(t?.preventDefault&&t.preventDefault(),!this.quickShareBtn||this.quickShareBtn.disabled)return;const e=this.buildQuickShareUrl();if(!e)return void this.showQuickShareFeedback("Share unavailable",2200);const i="undefined"!=typeof navigator?navigator:null;if(i&&"function"==typeof i.share){const t={url:e};try{if(!i.canShare||i.canShare(t))return await i.share(t),void this.showQuickShareFeedback("Share sent!",2e3)}catch(t){if("AbortError"===t?.name)return}}try{if(i?.clipboard?.writeText)return await i.clipboard.writeText(e),void this.showQuickShareFeedback("Link copied!",2200)}catch(t){}this.fallbackCopyToClipboard(e)?this.showQuickShareFeedback("Link copied!",2200):"undefined"!=typeof window&&"function"==typeof window.prompt?(window.prompt("Share this SoundCloud link:",e),this.showQuickShareFeedback("Link ready to share",2200)):this.showQuickShareFeedback("Share failed",2200)}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const t="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const e=await fetch(t,{method:"HEAD"});if(!e.ok)throw new Error(`Demo audio not found (status ${e.status})`);const i=await fetch(t);if(!i.ok)throw new Error(`Failed to fetch demo audio (status ${i.status})`);const s=await i.blob(),a=new File([s],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=a,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),a})().catch(t=>{throw this.demoAudioFile=null,t});try{return await this.demoAudioPromise}catch(t){return this.demoAudioPromise=null,null}}detectQuickLaunchIntent(){if("undefined"==typeof window)return{requested:!1,lookup:{}};const t=window.location?.search||"";if(!t)return{requested:!1,lookup:{}};let e;try{e=new URLSearchParams(t)}catch(t){return{requested:!1,lookup:{}}}const i={};e.forEach((t,e)=>{"string"==typeof e&&(i[e.toLowerCase()]=t)});const s=i.visual?String(i.visual).trim():"",a=i.audiosource||i.audio||i.source?String(i.audiosource||i.audio||i.source).trim():"";return{requested:Boolean(s||a),lookup:i}}applyQuickLaunchUIState(){document.body?.classList.add("vvavy-quick-launch"),this.quickStartModal&&(this.quickStartModal.classList.remove("active"),this.quickStartModal.setAttribute("aria-hidden","true")),document.body?.classList.remove("quickstart-active"),this.selectionHubElement?(this.quickLaunchSelectionHubWasHidden=!this.selectionHubElement.classList.contains("hidden"),this.selectionHubElement.classList.add("hidden")):this.quickLaunchSelectionHubWasHidden=!1,this.selectionHubManual=!1,this.playPauseBtn?.classList.remove("initial-pulse")}async applyLaunchParamsFromQuery(t=null){const e={visualHandled:!1,audioHandled:!1};if("undefined"==typeof window)return e;let i=t||null;if(!i||0===Object.keys(i).length){const t=window.location?.search||"";if(!t)return e;let s;try{s=new URLSearchParams(t)}catch(t){return e}if(!s||!s.entries().next)return e;i={},s.forEach((t,e)=>{"string"==typeof e&&(i[e.toLowerCase()]=t)})}const s=(i.visual||"").trim(),a=(i.audiosource||i.audio||i.source||"").trim().toLowerCase(),r=(i.uuid||i.track||i.id||i.url||"").trim(),o=(i.autoplay||"").trim().toLowerCase(),n=!("0"===o||"false"===o||"no"===o);if(s){const t=this.resolveVisualizerAlias(s);if(t)try{await this.switchVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t);const i=this.visualizerMetadataByName.get(t);i&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=i.displayName),e.visualHandled=!0}catch(t){}}if(a)switch(a){case"soundcloud":case"sc":if(!this.soundCloudEnabled)break;if(!r)break;try{const t=await this.resolveSoundCloudTrack(r);await this.loadSoundCloudTrack(t,{pauseBeforeLoad:!0,autoPlay:n}),e.audioHandled=!0}catch(t){}break;case"mic":case"microphone":e.audioHandled=await this.quickLaunchMicrophone();break;case"demo":e.audioHandled=await this.quickLaunchDemoAudio(n);break;case"none":case"off":e.audioHandled=!0}return(e.visualHandled||e.audioHandled)&&(this.hideQuickStartModal(!0),this.hideAudioContextHint(),this.dismissSelectionHub(),this.onboardingCompleted=!0,this.playPauseBtn?.classList.remove("initial-pulse"),this.updateVisualSearchVisibility(),this.updateSelectionHubVisibility()),this.quickLaunchPending=!1,e}_canonicalizeVisualizerName(t){return(t||"").toString().toLowerCase().replace(/visualizer$/i,"").replace(/[^a-z0-9]/g,"")}resolveVisualizerAlias(t){if(!t)return null;const e=this._canonicalizeVisualizerName(t);if(!e)return null;const i=Array.from(this.availableVisualizers.keys());for(const t of i){if(this._canonicalizeVisualizerName(t)===e)return t;const i=this.visualizerMetadataByName.get(t);if(i&&this._canonicalizeVisualizerName(i.displayName)===e)return t}const s=`${e}visualizer`;for(const t of i)if(this._canonicalizeVisualizerName(t)+"visualizer"===s)return t;return null}async quickLaunchMicrophone(){if(!this.audioManager)return!1;try{return await this.pausePlayback({includeMic:!0}),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideAudioContextHint(),this.showMicrophoneNowPlaying(),this.updateControlButtons(this.audioManager.isPlaying,this.audioManager.isMicActive),!0}catch(t){return!1}}async quickLaunchDemoAudio(t=!0){try{let e=this.demoAudioFile;return e||(e=await this.loadDemoAudioSilently()),!!e&&(this.audioManager?.isMicActive&&await this.audioManager.stopMicrophone(),await this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:t}),this.demoAudioFile=null,!0)}catch(t){return!1}}initializeDOMElements(){const t="undefined"!=typeof window&&window.VvavyDomRegistry?window.VvavyDomRegistry.getAll(!0):{};for(const[e,i]of Object.entries(t))this[e]=i;if(this.playerArtworkWrapper=this.playerArtwork?.closest(".player-artwork")||t.playerArtworkWrapper||document.querySelector(".player-artwork"),this.selectionHubElement&&(this.selectionHubElement.classList.add("hidden"),this.selectionHubAutoHidden=!0),this.visualizerSelect&&(this.visualizerSelect.classList.add("offscreen"),this.visualizerSelect.setAttribute("aria-hidden","true"),this.visualizerSelect.setAttribute("tabindex","-1")),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.quickStartStartBtn&&this.quickStartStartBtn.addEventListener("click",()=>this.handleQuickStartStart()),this.quickStartCloseBtn&&this.quickStartCloseBtn.addEventListener("click",()=>this.hideQuickStartModal()),this.quickStartModal&&(this.quickStartModal.setAttribute("aria-hidden","true"),this.quickStartModal.addEventListener("click",t=>{t.target===this.quickStartModal&&this.hideQuickStartModal(!1)})),this.bindSelectionHandlers(),this.setupPlayerControlsToggle(),this.setupVisualSearchToggle(),this.setupExportWidget(),this.sourcePickerBtn&&this.sourcePickerBtn.addEventListener("click",()=>{this.setPlayerControlsExpanded(!1),this.focusSelectionSection("source",{exclusive:!0})}),this.quickShareBtn){const t=this.quickShareBtn.textContent?.trim();t&&(this.quickShareButtonDefaultLabel=t),this.quickShareBtn.addEventListener("click",this.handleQuickShareClick)}this.updateShareButtonState(),this.updateVisualSearchVisibility(),this.setVisualSearchDimmed(!0),this.hideNowPlaying(),this.updateSelectionHubVisibility()}setupPlayerControlsToggle(){this.playerControlsToggle&&this.playerControlsPanel&&this.playerControlsToggle.addEventListener("click",()=>{const t="true"===this.playerControlsToggle.getAttribute("aria-expanded");this.setPlayerControlsExpanded(!t)})}setupVisualSearchToggle(){this.visualSearchToggleBtn&&this.visualSearchToggleBtn.addEventListener("click",()=>{this.setPlayerControlsExpanded(!1),this.toggleVisualSearchPanel()})}setupExportWidget(){this.exportWidgetToggleBtn&&this.exportWidget&&(this.exportWidget.classList.remove("hidden"),this.exportWidget.setAttribute("aria-hidden","true"),this.exportWidgetToggleBtn.addEventListener("click",this.handleExportWidgetToggle),this.exportWidgetCloseBtn&&this.exportWidgetCloseBtn.addEventListener("click",this.handleExportWidgetClose),this.exportWidgetCollapseBtn&&this.exportWidgetCollapseBtn.addEventListener("click",()=>{this.setPlayerControlsExpanded(!1),this.setExportWidgetCollapsed(!this.exportWidgetCollapsed)}),this.exportPresetSelect&&(this.populateExportPresetOptions(),this.exportPresetSelect.addEventListener("change",this.handleExportPresetChange)),this.exportFpsSelect&&(this.populateExportFpsOptions(),this.exportFpsSelect.addEventListener("change",this.handleExportFpsChange)),this.exportDurationInput&&(this.exportDurationInput.addEventListener("change",this.handleExportDurationChange),this.exportDurationInput.addEventListener("input",this.handleExportDurationChange)),this.exportFilenameInput&&this.exportFilenameInput.addEventListener("blur",()=>{this.exportFilenameInput&&(this.exportFilenameInput.value=this.exportFilenameInput.value.trim())}),this.exportMiniStopBtn&&this.exportMiniStopBtn.addEventListener("click",()=>{this.stopExportRecording()}),"undefined"!=typeof window&&(this._exportWidgetResizeHandler=()=>this.handleExportWidgetResize(),window.addEventListener("resize",this._exportWidgetResizeHandler,{passive:!0}),this.handleExportWidgetResize()),this.refreshExportEntitlements(),this.updateExportPresetSummary(),this.updateExportWidgetAvailability(),this.syncMiniStatus(),this.updateExportWidgetFloatingState())}handleExportWidgetToggle(){this.setPlayerControlsExpanded(!1),this.setExportWidgetVisible(!this.exportWidgetVisible)}handleExportWidgetClose(){this.setExportWidgetVisible(!1)}isMobileViewport(){if("undefined"==typeof window)return!1;if(window.matchMedia)try{return window.matchMedia("(max-width: 960px)").matches}catch(t){}return(window.innerWidth||0)<=960}setExportWidgetCollapsed(t,{force:e=!1}={}){const i=Boolean(t),s=!(!e&&!this.isMobileViewport())&&i,a=this.exportWidgetCollapsed;if(this.exportWidgetCollapsed=s,this.exportWidget&&this.exportWidget.classList.toggle("export-widget--collapsed",this.exportWidgetCollapsed),this.exportWidgetCollapseBtn){this.exportWidgetCollapseBtn.setAttribute("aria-pressed",this.exportWidgetCollapsed?"true":"false"),this.exportWidgetCollapseBtn.setAttribute("aria-label",this.exportWidgetCollapsed?"Expand export controls":"Collapse export controls");const t=this.exportWidgetCollapseBtn.querySelector("span");t&&(t.textContent=this.exportWidgetCollapsed?"▴":"▾")}a!==this.exportWidgetCollapsed&&(this.applyExportEntitlementLocks(),this.updateExportPresetSummary()),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}handleExportWidgetResize(){const t=this.isMobileViewport();this.exportWidgetCollapseBtn&&(t?(this.exportWidgetCollapseBtn.setAttribute("aria-hidden","false"),this.exportWidgetCollapseBtn.removeAttribute("tabindex")):(this.exportWidgetCollapseBtn.setAttribute("aria-hidden","true"),this.exportWidgetCollapseBtn.setAttribute("tabindex","-1"))),!t&&this.exportWidgetCollapsed&&this.setExportWidgetCollapsed(!1,{force:!0}),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}syncMiniStatus(){if(!this.exportMiniStatus)return;const t=this.videoExportManager?.isRecording?.()??!1,e=t&&this.isMobileViewport()&&(!this.exportWidgetVisible||this.exportWidgetCollapsed);this.exportMiniStatus.setAttribute("aria-hidden",e?"false":"true"),this.exportMiniStopBtn&&(this.exportMiniStopBtn.disabled=!t),e||this.updateMiniStatusTime(0)}updateMiniStatusTime(t){if(!this.exportMiniTimeLabel)return;const e=Math.max(0,Math.ceil(Number(t)||0));this.exportMiniTimeLabel.textContent=`${e}s`}updateExportWidgetFloatingState(){if(this.exportWidget)if(this.isMobileViewport()&&this.exportWidgetCollapsed){this.exportWidget.classList.add("export-widget--floating");const t=this.playerDock?.getBoundingClientRect?.().height,e=Number.isFinite(t)?Math.max(48,Math.round(t)):72;this.exportWidget.style.height=`${e}px`}else this.exportWidget.classList.remove("export-widget--floating"),this.exportWidget.style.height=""}normalizeSubscriptionPlan(t){const e=String(t||"").toLowerCase();return"pro"===e||PAID_EXPORT_PLAN_KEYS.has(e)?"pro":"free"}applySubscriptionPlan(t){const e=this.normalizeSubscriptionPlan(t);e!==this.subscriptionPlan&&(this.subscriptionPlan=e,this.subscriptionPlanFetched=!0,this.refreshExportEntitlements(),this.updateExportPresetSummary(),this.updateExportWidgetAvailability(),this.syncMiniStatus(),this.updateExportWidgetFloatingState())}async ensureSubscriptionPlan(){if(this.subscriptionPlanFetched)return this.subscriptionPlan;if(this.subscriptionPlanFetchPromise)return this.subscriptionPlanFetchPromise;const t=(async()=>{try{const t=await fetch("/api/subscription/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json();if(!e||"object"!=typeof e||"string"!=typeof e.plan)throw new Error("Invalid subscription payload");this.applySubscriptionPlan(e.plan)}catch(t){this.applySubscriptionPlan("free")}finally{this.subscriptionPlanFetchPromise=null}return this.subscriptionPlan})();return this.subscriptionPlanFetchPromise=t,t}isPaidSubscriptionPlan(t=this.subscriptionPlan){const e=String(t||"").toLowerCase();return"pro"===e||PAID_EXPORT_PLAN_KEYS.has(e)}getCurrentExportAudioPolicy(){const t="soundcloud"===this.currentSourceType,e=this.isPaidSubscriptionPlan();return{isSoundCloud:t,isPaid:e,includeAudio:!t||e,requiresUpgrade:t&&!e}}shouldIncludeAudioInExport(){return this.getCurrentExportAudioPolicy().includeAudio}buildExportEntitlements(t=this.subscriptionPlan){const e=this.isPaidSubscriptionPlan(t),i=e?300:30;return{plan:e?"pro":"free",isPaid:e,minDurationSeconds:5,maxDurationSeconds:i,defaultDurationSeconds:i,defaultFps:60,canEditDuration:e,canEditFps:e,canToggleWatermark:e}}refreshExportEntitlements(){this.exportEntitlements=this.buildExportEntitlements(this.subscriptionPlan),this.applyExportEntitlementLocks()}applyExportEntitlementLocks(){const t=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan);if(this.exportWatermarkCheckbox&&(this.exportWatermarkCheckbox.disabled=!t.canToggleWatermark,t.canToggleWatermark?this.exportWatermarkCheckbox.removeAttribute("aria-disabled"):(this.exportWatermarkCheckbox.checked=!0,this.exportWatermarkCheckbox.setAttribute("aria-disabled","true")),this.exportWatermarkCheckbox.title=t.canToggleWatermark?"":"Available on paid plans"),this.exportFpsSelect){const e=Number(this.exportFpsSelect.value),i=t.canEditFps&&Number.isFinite(e)?e:t.defaultFps;this.exportFpsSelect.disabled=!t.canEditFps,this.exportFpsSelect.value=String(i),this.exportFpsSelect.title=t.canEditFps?"":"Available on paid plans"}if(this.exportDurationInput){const e=Number(this.exportDurationInput.value),i=Number.isFinite(e)?e:t.defaultDurationSeconds,s=Math.min(t.maxDurationSeconds,Math.max(t.minDurationSeconds,i));this.exportDurationInput.disabled=!t.canEditDuration,this.exportDurationInput.value=String(t.canEditDuration?s:t.defaultDurationSeconds),this.exportDurationInput.max=String(t.maxDurationSeconds),this.exportDurationInput.min=String(t.minDurationSeconds),this.exportDurationInput.title=t.canEditDuration?"":"Available on paid plans"}}setExportWidgetVisible(t){if(!this.exportWidget)return;const e=Boolean(t);e!==this.exportWidgetVisible&&(this.exportWidgetVisible=e,this.exportWidgetToggleBtn&&(this.exportWidgetToggleBtn.setAttribute("aria-pressed",e?"true":"false"),this.exportWidgetToggleBtn.setAttribute("aria-label",e?"Hide export controls":"Show export controls")),this.exportWidget.setAttribute("aria-hidden",e?"false":"true"),e&&(this.subscriptionPlanFetched||this.subscriptionPlanFetchPromise||this.ensureSubscriptionPlan().catch(()=>{}),this.refreshExportEntitlements(),this.exportWidget.focus?.(),this.exportAvailabilityChecked?this.updateExportWidgetAvailability(!0):(this.setExportStatus("Checking export availability…"),this.prepareVideoExportCapability().catch(t=>{this.updateExportWidgetAvailability(!0)}))),this.syncMiniStatus(),this.updateExportWidgetFloatingState())}populateExportPresetOptions(){if(!this.exportPresetSelect)return;const t=this.exportPresetSelect,e=t.value,i=this.getExportPresetCatalog();t.innerHTML="";for(const e of Object.values(i)){const i=document.createElement("option");i.value=e.id,i.textContent=e.label||e.id,t.appendChild(i)}const s=i[e]?e:Object.keys(i)[0];s&&(t.value=s),i[s]&&!this._exportFpsManuallySet&&this.exportFpsSelect&&(this.exportFpsSelect.value=String(i[s].fps||60)),this.exportEntitlements?.canEditFps||(this._exportFpsManuallySet=!1)}populateExportFpsOptions(){if(!this.exportFpsSelect)return;const t=this.exportFpsSelect,e=parseInt(t.value,10);t.innerHTML="";const i=new Set(EXPORT_FPS_OPTIONS);Number.isFinite(e)&&i.add(e);const s=this.getExportPresetCatalog();for(const t of Object.values(s))Number.isFinite(t.fps)&&i.add(t.fps);const a=Array.from(i).sort((t,e)=>t-e),r=this.exportPresetSelect?s?.[this.exportPresetSelect.value]?.fps:void 0,o=Number.isFinite(e)?e:Number.isFinite(r)?r:a[a.length-1]||60;for(const e of a){const i=document.createElement("option");i.value=String(e),i.textContent=`${e} fps`,e===o&&(i.selected=!0),t.appendChild(i)}!Number.isFinite(o)&&a.length&&(t.value=String(a[a.length-1]))}getExportPresetCatalog(){let t=null;"undefined"!=typeof window&&(t=window.RENDER_PRESETS||window.VideoExportManager?.RENDER_PRESETS||this.videoExportManager?.constructor?.RENDER_PRESETS||null);const e={...FALLBACK_EXPORT_PRESETS};if(t&&"object"==typeof t)for(const[i,s]of Object.entries(t)){if(!s)continue;const t=s.id||i;e[t]={id:t,label:s.label||t,width:s.width??FALLBACK_EXPORT_PRESETS[i]?.width??1080,height:s.height??FALLBACK_EXPORT_PRESETS[i]?.height??1920,fps:s.fps??FALLBACK_EXPORT_PRESETS[i]?.fps??60}}return this._exportPresetCatalog=e,e}updateExportPresetSummary(){if(!this.exportPresetSummary||!this.exportPresetSelect)return;const t=this._exportPresetCatalog,e=t?.[this.exportPresetSelect.value],i=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan);let s="";if(e){const t=Number(this.exportFpsSelect?.value),a=Number.isFinite(t)?t:e.fps||i.defaultFps,r=Number(this.exportDurationInput?.value),o=Number.isFinite(r)?r:i.defaultDurationSeconds;s=`${e.width}×${e.height} • ${a} fps • ${o}s`}this.exportPresetSummary.textContent=s}handleExportPresetChange(){const t=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan);if(this._exportFpsManuallySet=!1,t.canEditFps){const e=this._exportPresetCatalog,i=e?.[this.exportPresetSelect?.value];i&&this.exportFpsSelect&&(this.exportFpsSelect.value=String(i.fps||t.defaultFps))}this.applyExportEntitlementLocks(),this.updateExportPresetSummary()}handleExportFpsChange(){if(!this.exportEntitlements?.canEditFps)return this.applyExportEntitlementLocks(),void this.updateExportPresetSummary();this._exportFpsManuallySet=!0,this.updateExportPresetSummary()}handleExportDurationChange(){if(!this.exportDurationInput)return;const t=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan),e=Number(this.exportDurationInput.value);if(!t.canEditDuration||!Number.isFinite(e))return this.exportDurationInput.value=String(t.defaultDurationSeconds),void this.updateExportPresetSummary();const i=(s=e,Math.min(t.maxDurationSeconds,Math.max(t.minDurationSeconds,Math.round(s))));var s;i!==e&&(this.exportDurationInput.value=String(i)),this.updateExportPresetSummary()}updateExportWidgetAvailability(t=!1){if(!this.exportStatusLabel)return;if(this._exportStatusLocked&&!t)return;this.refreshExportEntitlements();const e=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan);if(!this.exportAvailabilityChecked)return this.setExportStatus("Exports ready when recording bundle loads…"),void this.syncMiniStatus();if(!this.exportsEnabled){const t=this.exportDisabledReason||"Exports are currently unavailable.";return this.setExportStatus(t,{isError:!0}),this.exportStartButton&&(this.exportStartButton.disabled=!0),void this.syncMiniStatus()}if(!this.videoExportManager)return this.setExportStatus("Preparing recorder…"),this.exportStartButton&&(this.exportStartButton.disabled=!0),void this.syncMiniStatus();if(this.videoExportManager?.isRecording?.())return this.lockExportStatus("Recording in progress…"),this.exportStartButton&&(this.exportStartButton.disabled=!0),this.exportStopButton&&(this.exportStopButton.disabled=!1),void this.syncMiniStatus();const i=this.getCurrentExportAudioPolicy();let s;s=i.isSoundCloud&&!i.includeAudio?"Audio sourced from SoundCloud save visuals only (audio muted).":i.isSoundCloud&&i.includeAudio?"SoundCloud exports can include audio when you already hold the rights.":e.isPaid?"Ready to export your visual":"Exports run 30s at 60 fps with watermark",this.unlockExportStatus(s,{autoResetMs:0}),this.populateExportPresetOptions(),this.populateExportFpsOptions(),this.applyExportEntitlementLocks(),this.updateExportPresetSummary(),this.exportStartButton&&(this.exportStartButton.disabled=this._exportActionPending||!this.videoExportManager,this.exportStartButton.classList.remove("hidden")),this.exportStopButton&&!this.videoExportManager?.isRecording?.()&&(this.exportStopButton.disabled=!0,this.exportStopButton.classList.add("hidden")),this.syncMiniStatus(),this.updateExportWidgetFloatingState()}setExportStatus(t,{isError:e=!1,autoResetMs:i=0}={}){this.exportStatusLabel&&(this.exportStatusLabel.textContent=t||"",this.exportStatusLabel.classList.toggle("export-widget__status--error",Boolean(e)),this._exportStatusResetHandle&&(clearTimeout(this._exportStatusResetHandle),this._exportStatusResetHandle=null),i>0&&(this._exportStatusResetHandle=window.setTimeout(()=>{this._exportStatusResetHandle=null,this._exportStatusLocked||this.updateExportWidgetAvailability(!0)},i)))}lockExportStatus(t,e={}){this._exportStatusLocked=!0,this.setExportStatus(t,e)}unlockExportStatus(t,e={}){this._exportStatusLocked=!1,this.setExportStatus(t,e)}startExportCountdown(t){if(!this.exportCountdownRow||!this.exportTimeRemainingLabel)return;this.exportCountdownEndsAt=performance.now()+t,this.exportCountdownRow.hidden=!1;const e=Math.max(0,Math.ceil(t/1e3));this.exportTimeRemainingLabel.textContent=`${e}s`,this.updateMiniStatusTime(e),this.refreshExportCountdown(),this.exportCountdownInterval&&clearInterval(this.exportCountdownInterval),this.exportCountdownInterval=window.setInterval(this.refreshExportCountdown,250)}stopExportCountdown(){this.exportCountdownInterval&&(clearInterval(this.exportCountdownInterval),this.exportCountdownInterval=null),this.exportCountdownRow&&(this.exportCountdownRow.hidden=!0),this.exportTimeRemainingLabel&&(this.exportTimeRemainingLabel.textContent="0s"),this.updateMiniStatusTime(0)}refreshExportCountdown(){if(!this.exportTimeRemainingLabel)return;if(!this.exportCountdownEndsAt)return this.exportTimeRemainingLabel.textContent="0s",void this.updateMiniStatusTime(0);const t=Math.max(0,this.exportCountdownEndsAt-performance.now()),e=Math.max(0,Math.ceil(t/1e3));this.exportTimeRemainingLabel.textContent=`${e}s`,this.updateMiniStatusTime(e),t<=.5&&this.stopExportCountdown()}getSelectedExportOptions(t={}){const e=this.getExportPresetCatalog(),i=Object.keys(e)[0]||"vertical1080x1920",s=t.presetId||this.exportPresetSelect?.value||i,a=e[s]||e[i],r=this.exportEntitlements||this.buildExportEntitlements(this.subscriptionPlan),o=null!=t.fps?t.fps:Number(this.exportFpsSelect?.value);let n=Number.isFinite(o)?Math.round(o):a?.fps??r.defaultFps;r.canEditFps?n=Math.min(120,Math.max(10,n)):(n=r.defaultFps,this.exportFpsSelect&&(this.exportFpsSelect.value=String(n)));const l=t.durationSeconds??t.maxDurationMs,u="number"==typeof l?l>1e3?l/1e3:l:Number(this.exportDurationInput?.value);let d=Number.isFinite(u)?u:r.defaultDurationSeconds;d=Math.min(r.maxDurationSeconds,Math.max(r.minDurationSeconds,Math.round(d))),r.canEditDuration||(d=r.defaultDurationSeconds),this.exportDurationInput&&(this.exportDurationInput.value=String(d));const h=Math.round(1e3*d),c=!r.canToggleWatermark||(null!=t.watermark?Boolean(t.watermark):!this.exportWatermarkCheckbox||!1!==this.exportWatermarkCheckbox.checked);!r.canToggleWatermark&&this.exportWatermarkCheckbox&&(this.exportWatermarkCheckbox.checked=!0);const p=(null!=t.fileName?String(t.fileName):this.exportFilenameInput?.value||"").trim();return{presetId:a?.id||s||i,fps:n,maxDurationMs:h,watermark:c,fileName:p||null,durationSeconds:d}}resolveExportFilename(t){if(!t)return"vvavy-export.webm";const e=t.mimeType||"video/webm",i=this.extensionFromMime(e),s=t.fileName&&t.fileName.trim()||this.exportFilenameInput?.value?.trim()||`vvavy-export-${(new Date).toISOString().slice(0,10)}`,a=this.stripExtension(s,i);return this.exportFilenameInput&&(this.exportFilenameInput.value=a),a.endsWith(i)?a:`${a}${i}`}autoDownloadExportResult(t,e){if(!t?.url)return;const i=document.createElement("a");i.href=t.url,i.download=e,i.rel="noopener",i.style.display="none",document.body.appendChild(i),i.click(),requestAnimationFrame(()=>{i.parentNode&&i.parentNode.removeChild(i)}),window.setTimeout(()=>{try{URL.revokeObjectURL(t.url)}catch(t){}},4e3)}extensionFromMime(t){return t?t.includes("mp4")?".mp4":t.includes("webm")?".webm":t.includes("ogg")?".ogv":".webm":".webm"}stripExtension(t,e){if(!t)return"vvavy-export";const i=e?.startsWith(".")?e:`.${e||""}`;return t.toLowerCase().endsWith(i.toLowerCase())?t.slice(0,-i.length):t}setPlayerControlsExpanded(t){if(!this.playerControlsToggle||!this.playerControlsPanel)return;const e=Boolean(t);e!==this.playerControlsOpen&&(this.playerControlsOpen=e,this.playerControlsToggle.setAttribute("aria-expanded",e?"true":"false"),this.playerControlsToggle.setAttribute("aria-label",e?"Hide player controls":"Show player controls"),e?(this.playerControlsPanel.removeAttribute("hidden"),document.addEventListener("pointerdown",this.handlePlayerControlsPointerDown,!0),document.addEventListener("keydown",this.handlePlayerControlsKeydown,!0)):(this.playerControlsPanel.setAttribute("hidden",""),document.removeEventListener("pointerdown",this.handlePlayerControlsPointerDown,!0),document.removeEventListener("keydown",this.handlePlayerControlsKeydown,!0)),this.updateVisualSearchDropdownMaxHeight())}handlePlayerControlsPointerDown(t){if(!this.playerControlsPanel||!this.playerControlsToggle)return;const e=t.target;this.playerControlsPanel.contains(e)||this.playerControlsToggle.contains(e)||this.setPlayerControlsExpanded(!1)}handlePlayerControlsKeydown(t){"Escape"===t.key&&this.setPlayerControlsExpanded(!1)}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start(),this.updateShareButtonState()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t),this.updatePlayerTimeline(t),this.selectionHubManual||this.selectionHubDismissed||this.dismissSelectionHub()}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e);const i=Boolean(t||e),s=this.isPlaybackActive;this.isPlaybackActive=i,e?this.setActiveSource("mic"):t||this.audioManager?.audioElement||this.setActiveSource(null),this.setVisualSearchDimmed(i),i&&(this.onboardingCompleted=!0,this.hideGettingStartedOverlay()),s!==this.isPlaybackActive&&this.refreshVisualSearchSummary(),this.updateSelectionHubVisibility()})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(t){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.fileSelectBtn?.addEventListener("click",async()=>{await this.handleFileSelection()}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",async t=>{const e=t.target.value;if(e&&e!==this.currentVisualizerName)try{this.visualSelectionTriggeredFromUI=!0,this.visualSelectionTriggerSource="dropdown",await this.switchVisualizer(e)}catch(t){}}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.hideOnboardingOverlay()}),"undefined"!=typeof window&&(window.addEventListener("vvavy:exports-ready",this.handleExportsReadyEvent),window.addEventListener("vvavy:export-recording-state",this.handleExportRecordingEvent))}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showOnboardingOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideOnboardingOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideOnboardingOverlay(),this.hideGettingStartedOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&(this.pausePlayback({stopVisualizer:!0,includeMic:!0}).catch(()=>{}),this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}))})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.emitVisualVisibilityEvent({active:!1,reason:"tab-hidden"}),this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.emitVisualVisibilityEvent({active:!0,reason:"tab-visible"}),this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.emitVisualVisibilityEvent({active:!1,reason:"pagehide"}),this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.emitVisualVisibilityEvent({active:!0,reason:"pageshow"}),this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){this.availableVisualizers.clear(),this.visualizerMetadataByName=new Map,this.visualizerManifest=[];const t="undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)?window.VISUALIZERS_MANIFEST:null;t&&t.forEach(t=>{const e=t.name,i=window[e];if("function"!=typeof i)return;const s={name:e,displayName:t.displayName||e.replace(/Visualizer$/,""),file:t.file,description:"string"==typeof t.description?t.description:"",tags:Array.isArray(t.tags)?t.tags:[]};this.visualizerMetadataByName.set(e,s),this.visualizerManifest.push(s),this.availableVisualizers.set(e,{...s,class:i})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,i=window[e];if("function"!=typeof i)return;const s=this.visualizerMetadataByName.get(e);if(s)return void this.availableVisualizers.set(e,{...s,class:i});const a=t.dataset?.tags||"",r=a?a.split(",").map(t=>t.trim()).filter(Boolean):[],o={name:e,displayName:t.textContent||e.replace(/Visualizer$/,""),file:null,description:t.dataset?.description||"",tags:r};this.visualizerMetadataByName.set(e,o),this.visualizerManifest.push(o),this.availableVisualizers.set(e,{...o,class:i})}),this.renderVisualSelectionCards()}bindSelectionHandlers(){this.sourceSelectionGrid&&(this.sourceCardElements=new Map,this.sourceSelectionGrid.querySelectorAll("[data-source-card]").forEach(t=>{const e=t.dataset.sourceCard;e&&(this.sourceCardElements.set(e,t),t.setAttribute("role","button"),t.setAttribute("tabindex","0"))}),this.bindInteractiveGrid(this.sourceSelectionGrid,"[data-source-card]",t=>{if(t.classList.contains("selection-card--disabled"))return;const e=t.dataset.sourceCard;e&&this.handleSourceSelection(e)})),this.visualSelectionGrid&&this.bindInteractiveGrid(this.visualSelectionGrid,"[data-visual-card]",t=>{const e=t.dataset.visualCard;e&&e!==this.currentVisualizerName&&(this.visualSelectionTriggeredFromUI=!0,this.visualSelectionTriggerSource="visual-card",this.switchVisualizer(e))})}bindInteractiveGrid(t,e,i){if(!t)return;const s=t=>{const s=t.target.closest(e);return s?(t.preventDefault(),i(s,t)):null};t.addEventListener("click",s),t.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||s(t)})}renderVisualSelectionCards(){if(!this.visualSelectionGrid)return;this.visualSelectionGrid.innerHTML="",this.visualCardElements=new Map;const t=this.visualizerManifest||[],e=document.createDocumentFragment();t.forEach(t=>{const i=document.createElement("button");i.type="button",i.className="selection-card",i.dataset.visualCard=t.name,i.setAttribute("role","button"),i.setAttribute("tabindex","0");const s=t.description||"Abstract visual experience",a=Array.isArray(t.tags)?t.tags.slice(0,4):[];i.innerHTML=`\n                <div class="selection-card__header">\n                    <span class="selection-card__icon">✨</span>\n                    <h3 class="selection-card__title">${t.displayName}</h3>\n                </div>\n                <p class="selection-card__description">${s}</p>\n                ${a.length?`<div class="selection-card__meta">${a.map(t=>`<span class="selection-card__tag">${t}</span>`).join("")}</div>`:""}\n            `,e.appendChild(i),this.visualCardElements.set(t.name,i)}),this.visualSelectionGrid.appendChild(e),this.highlightActiveVisualizer(this.currentVisualizerName)}highlightActiveVisualizer(t){this.visualCardElements.forEach((e,i)=>{const s=i===t;e.classList.toggle("selection-card--active",s),e.setAttribute("aria-pressed",s?"true":"false")}),this.updateSelectionHubVisibility()}focusSelectionSection(t,{exclusive:e=!1}={}){let i=null;"source"===t?i=this.sourceSelectionSection:"visual"===t&&(i=this.visualSelectionSection);const s=!this.selectionHubElement?.classList.contains("hidden");if("source"===t&&this.selectionHubManual&&s)return void this.closeSourceSelection(!0);if(e?("source"===t?this.visualSelectionSection?.classList.add("selection-section--hidden"):"visual"===t&&this.sourceSelectionSection?.classList.add("selection-section--hidden"),"source"===t&&this.sourceSelectionSection?.classList.remove("selection-section--hidden"),"visual"===t&&this.visualSelectionSection?.classList.remove("selection-section--hidden")):(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden")),this.selectionHubElement&&(this.selectionHubManual=!0,this.selectionHubElement.classList.remove("hidden")),"source"===t?(this.selectionHubDismissed=!1,this.selectionHubElement?.classList.add("selection-hub--modal")):(this.selectionHubElement?.classList.remove("selection-hub--modal"),this.selectionHubDismissed||this.dismissSelectionHub()),"source"===t?this.openSourceSelection():this.teardownSourceSelectionOutsideHandler(),!i)return;const a=e;try{i.scrollIntoView({behavior:"smooth",block:a?"nearest":"center"})}catch(t){i.scrollIntoView({behavior:"smooth"})}i.classList.add("selection-section--pulse"),setTimeout(()=>i.classList.remove("selection-section--pulse"),1200),this.updateSelectionHubVisibility()}updateSelectionHubVisibility(){if(!this.selectionHubElement)return;const t=Boolean(this.currentVisualizerName),e=Boolean(this.currentSourceType)||Boolean(this.audioManager?.audioElement)||Boolean(this.audioManager?.isMicActive),i=this.selectionHubDismissed||!this.selectionHubManual&&t&&e;this.selectionHubManual||(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden"),this.teardownSourceSelectionOutsideHandler()),this.selectionHubElement.classList.toggle("hidden",i),i&&(this.selectionHubAutoHidden=!0)}openSourceSelection(){this.isSourceSelectionOpen||(this.isSourceSelectionOpen=!0,document.addEventListener("pointerdown",this.handleSourceOutsidePointerDown,!0))}teardownSourceSelectionOutsideHandler(){this.isSourceSelectionOpen&&(this.isSourceSelectionOpen=!1,document.removeEventListener("pointerdown",this.handleSourceOutsidePointerDown,!0))}closeSourceSelection(t=!1){(t||this.isSourceSelectionOpen)&&(this.teardownSourceSelectionOutsideHandler(),this.selectionHubManual=!1,this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden"),this.selectionHubElement?.classList.remove("selection-hub--modal"),this.selectionHubDismissed=!0,this.updateSelectionHubVisibility())}handleSourceOutsidePointerDown(t){this.isSourceSelectionOpen&&(this.sourceSelectionSection?.contains(t.target)||this.sourcePickerBtn?.contains(t.target)||this.closeSourceSelection(!0))}toggleVisualSearchPanel(t){this.visualSearchToggleBtn&&this.visualSearchBar&&(("boolean"==typeof t?t:!this.visualSearchPanelOpen)?this.openVisualSearchPanel():this.closeVisualSearchPanel())}openVisualSearchPanel(){if(this.visualSearchBar&&this.visualSearchToggleBtn&&!this.visualSearchPanelOpen&&!this.isGettingStartedActive()){if(this.visualSearchPanelOpen=!0,this.visualSearchToggleBtn.classList.add("player-btn--active"),this.visualSearchToggleBtn.setAttribute("aria-pressed","true"),this.setVisualSearchDimmed(!1),this.updateVisualSearchVisibility(),this.visualizerSearchInput){this.visualizerSearchInput.value&&(this.visualizerSearchInput.value="");const t=()=>{this.applyVisualizerSearch("",{showDropdown:!0}),this.showVisualSearchDropdown()};t(),"undefined"!=typeof window&&"function"==typeof window.requestAnimationFrame&&window.requestAnimationFrame(t)}this.visualizerSearchInput?.focus(),document.addEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0)}}closeVisualSearchPanel({focusToggle:t=!1}={}){this.visualSearchPanelOpen&&(this.visualSearchPanelOpen=!1,this.visualSearchToggleBtn?.classList.remove("player-btn--active"),this.visualSearchToggleBtn?.setAttribute("aria-pressed","false"),this.setVisualSearchDimmed(!0),this.updateVisualSearchVisibility(),this.visualizerSearchInput?.blur(),this.hideVisualSearchDropdown({immediate:!0,force:!0}),document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0),t&&this.visualSearchToggleBtn?.focus())}handleVisualSearchOutsidePointer(t){if(!this.visualSearchPanelOpen)return;const e=this.visualSearchBar?.contains(t.target),i=this.visualSearchToggleBtn?.contains(t.target);e||i||this.closeVisualSearchPanel()}dismissSelectionHub(){this.selectionHubDismissed||(this.selectionHubDismissed=!0,this.selectionHubManual=!1,this.selectionHubElement?.classList.remove("selection-hub--modal"),this.updateSelectionHubVisibility())}emitVisualVisibilityEvent(t={}){if("undefined"==typeof window||"function"!=typeof window.dispatchEvent)return;let e;try{e=new CustomEvent("vvavy:visual-visibility",{detail:{active:Boolean(t.active),reason:t.reason||"unknown",timestamp:"undefined"!=typeof performance&&"function"==typeof performance.now?performance.now():Date.now()}})}catch(t){return}window.dispatchEvent(e)}renderVisualSearchDropdown(t=[],e=""){if(!this.visualSearchDropdown)return;const i=this.visualSearchDropdown;i.innerHTML="";const s=(e||"").trim(),a=t;if(!a.length){if(!s)return void i.classList.add("hidden");const t=document.createElement("div");return t.className="visual-search-item visual-search-item--empty",t.textContent="No visuals match that search.",i.appendChild(t),i.classList.remove("hidden"),void this.updateVisualSearchDropdownMaxHeight()}const r=document.createDocumentFragment();a.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="visual-search-item",e.dataset.visualName=t.name,e.dataset.displayName=t.displayName;const i=Array.isArray(t.tags)?t.tags.slice(0,3):[],s=t.description?`<div class="visual-search-item__description">${t.description}</div>`:"",a=i.length?`<div class="visual-search-item__tags">${i.map(t=>`<span>${t}</span>`).join("")}</div>`:"";e.innerHTML=`\n                <div class="visual-search-item__title">${t.displayName}</div>\n                ${s}\n                ${a}\n            `,r.appendChild(e)}),i.appendChild(r),i.classList.remove("hidden"),this.updateVisualSearchDropdownMaxHeight()}showVisualSearchDropdown(){this.visualSearchDropdown&&0!==this.visualSearchDropdown.childElementCount&&(this.visualSearchDropdown.classList.remove("hidden"),this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout),this.updateVisualSearchDropdownMaxHeight())}updateVisualSearchDropdownMaxHeight(){if(!this.visualSearchDropdown||"undefined"==typeof window)return;const t=this.visualSearchDropdown,e="undefined"!=typeof document?document:null,i=window.innerHeight||e?.documentElement?.clientHeight||0;if(!Number.isFinite(i)||i<=0)return void(t.style.maxHeight="");const s=t.classList.contains("hidden"),a=t.style.visibility,r=t.style.pointerEvents;s&&(t.classList.remove("hidden"),t.style.visibility="hidden",t.style.pointerEvents="none");let o=0;try{const e=t.getBoundingClientRect();o=e?.top??0}catch(t){o=0}if(!Number.isFinite(o)||o<=0){const t=this.visualSearchBar||this.visualizerSearchInput;if(t)try{const e=t.getBoundingClientRect();o=e?.bottom??o}catch(t){}}let n=0;if(this.playerDock)try{const t=window.getComputedStyle(this.playerDock);if("none"!==t.display&&"hidden"!==t.visibility){const t=this.playerDock.getBoundingClientRect();n=Number.isFinite(t?.height)?t.height:0}}catch(t){n=0}let l=i-n-o;Number.isFinite(l)&&l>0?t.style.maxHeight=`${Math.floor(l)}px`:t.style.maxHeight="0px",t.style.visibility=a||"",t.style.pointerEvents=r||"",s&&t.classList.add("hidden")}isFocusWithinVisualSearch(){if(!this.visualSearchBar)return!1;const t="undefined"!=typeof document?document.activeElement:null;return!!t&&this.visualSearchBar.contains(t)}hideVisualSearchDropdown({immediate:t=!1,force:e=!1}={}){if(!this.visualSearchDropdown)return;const i=()=>{!e&&this.isFocusWithinVisualSearch()||this.visualSearchDropdown.classList.add("hidden")};t?i():(this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout),this.visualDropdownHideTimeout=setTimeout(i,120))}handleVisualSearchFocusExit({restoreSummary:t=!1}={}){setTimeout(()=>{this.isFocusWithinVisualSearch()||(t&&this.updateVisualizerSummaryForSelection(this.currentVisualizerName),this.hideVisualSearchDropdown(),this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.dismissSelectionHub())},0)}async handleSourceSelection(t){this.setPlayerControlsExpanded(!1);try{switch(t){case"soundcloud":await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.showSoundCloudOrAlert(this.sourceCardElements.get("soundcloud"),{hideOnboarding:!0,hideOverlay:!0});break;case"file":await this.handleFileSelection();break;case"mic":await this.handleMicrophoneSelection()}}catch(t){}finally{this.closeSourceSelection(!0)}}async handleFileSelection(){this.hideQuickStartModal(),await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.fileInput?.click()}async handleMicrophoneSelection(){if(this.audioManager){if(this.hideQuickStartModal(),this.audioManager.isMicActive)return await this.audioManager.stopMicrophone(),this.hideNowPlaying(),this.updateControlButtons(this.audioManager.isPlaying,!1),void this.updateSelectionHubVisibility();try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideAudioContextHint(),this.showMicrophoneNowPlaying()}catch(t){alert("Microphone access denied or unavailable.")}finally{this.updateControlButtons(this.audioManager.isPlaying,this.audioManager.isMicActive)}this.updateSelectionHubVisibility()}}setSourceAvailability(t,e,i=""){let s=null;"soundcloud"===t?s=this.sourceCardElements.get("soundcloud"):"file"===t?s=this.sourceCardElements.get("file"):"mic"===t&&(s=this.sourceCardElements.get("mic")),s&&(s.disabled=!e,!e&&i?(s.dataset.soundcloudReason=i,s.setAttribute("title",i)):(delete s.dataset.soundcloudReason,s.removeAttribute("title")));const a=this.sourceCardElements?.get(t);a&&(a.classList.toggle("selection-card--disabled",!e),e?(a.removeAttribute("aria-disabled"),a.removeAttribute("data-soundcloud-reason")):(a.setAttribute("aria-disabled","true"),i&&(a.dataset.soundcloudReason=i)))}showSoundCloudOrAlert(t,{hideOnboarding:e=!0}={}){if(!this.soundCloudEnabled){const e=t?.dataset?.soundcloudReason||this.soundCloudAvailabilityMessage||"SoundCloud integration is currently unavailable.";return void alert(e)}e&&this.hideQuickStartModal(!1),this.openSoundCloudModal()}setupVisualizerSearch(){this.visualizerSearchInput&&(this._searchInitialized?this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}):(this._searchInitialized=!0,"undefined"==typeof window||this._visualSearchDropdownResizeBound||(window.addEventListener("resize",this.boundUpdateVisualSearchDropdownMaxHeight),window.addEventListener("orientationchange",this.boundUpdateVisualSearchDropdownMaxHeight),this._visualSearchDropdownResizeBound=!0),this.updateVisualSearchDropdownMaxHeight(),this.visualizerSearchInput.addEventListener("input",t=>{this.applyVisualizerSearch(t.target.value,{showDropdown:!0}),this.showVisualSearchDropdown(),this.dismissSelectionHub()}),this.visualizerSearchInput.addEventListener("focus",()=>{const t=this.visualizerSearchInput.value.trim();t?this.applyVisualizerSearch(t,{showDropdown:!0}):this.applyVisualizerSearch("",{showDropdown:!0}),this.showVisualSearchDropdown(),this.dismissSelectionHub()}),this.visualizerSearchInput.addEventListener("keydown",async t=>{if("Enter"===t.key){const e=this.visualizerSearchMatches[0];e&&(t.preventDefault(),this.visualizerSelect&&(this.visualizerSelect.value=e.name),this.visualSelectionTriggeredFromUI=!0,this.visualSelectionTriggerSource="search-input",await this.switchVisualizer(e.name),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0,force:!0}),this.dismissSelectionHub(),this.selectionHubElement?.classList.remove("selection-hub--modal"))}else"Escape"===t.key&&(this.visualizerSearchInput.value="",this.applyVisualizerSearch("",{showDropdown:!1}),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0,force:!0}))}),this.visualizerSearchInput.addEventListener("blur",()=>{const t=!this.visualizerSearchInput.value.trim();this.handleVisualSearchFocusExit({restoreSummary:t})}),this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}),this.visualSearchDropdown&&!this._dropdownBound&&(this.visualSearchDropdown.addEventListener("click",async t=>{const e=t.target.closest(".visual-search-item");if(!e||e.classList.contains("visual-search-item--empty"))return;const i=e.dataset.visualName,s=e.dataset.displayName||"";s&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=s),this.hideVisualSearchDropdown({immediate:!0,force:!0}),i&&(this.visualizerSelect&&(this.visualizerSelect.value=i),i!==this.currentVisualizerName?(this.visualSelectionTriggeredFromUI=!0,this.visualSelectionTriggerSource="search-dropdown",await this.switchVisualizer(i)):this.updateVisualizerSummaryForSelection(i)),this.visualizerSearchInput?.blur(),this.dismissSelectionHub(),this.selectionHubElement?.classList.remove("selection-hub--modal")}),this.visualSearchDropdown.addEventListener("focusin",()=>{this.showVisualSearchDropdown()}),this.visualSearchDropdown.addEventListener("focusout",()=>{const t=!this.visualizerSearchInput?.value?.trim();this.handleVisualSearchFocusExit({restoreSummary:t})}),document.addEventListener("click",t=>{if(!this.visualSearchDropdown)return;const e=this.visualSearchBar?.contains(t.target),i=this.visualSearchDropdown.contains(t.target);e||i||this.hideVisualSearchDropdown({immediate:!0,force:!0})}),this._dropdownBound=!0)))}applyVisualizerSearch(t="",{showDropdown:e}={}){const i=(t||"").toLowerCase().trim(),s=i.split(/\s+/).filter(Boolean),a=this.visualizerManifest||[];let r;r=s.length?a.map(t=>{const e=[t.name,t.displayName,t.description,...t.tags||[]].filter(Boolean).map(t=>t.toLowerCase());let i=0;for(const t of s){let s=0;for(const i of e)i.includes(t)&&(s=i===t?Math.max(s,3):i.startsWith(t)?Math.max(s,2):Math.max(s,1));if(0===s)return null;i+=s}return{entry:t,score:i}}).filter(Boolean).sort((t,e)=>e.score!==t.score?e.score-t.score:t.entry.displayName.localeCompare(e.entry.displayName)).map(t=>t.entry):a.slice(),this.visualizerSearchMatches=r,this.updateVisualizerSelectOptions(r,i),("boolean"==typeof e?e:document.activeElement===this.visualizerSearchInput)?this.renderVisualSearchDropdown(r,i):this.hideVisualSearchDropdown({immediate:!0,force:!0}),this.updateVisualizerSearchSummary(r,i)}updateVisualizerSelectOptions(t,e){if(!this.visualizerSelect)return;const i=e.length>0&&t.length>0,s=new Set(t.map(t=>t.name));if(Array.from(this.visualizerSelect.options).forEach(t=>{if(i){const e=s.has(t.value);t.hidden=!e,t.disabled=!e}else t.hidden=!1,t.disabled=!1}),!i)return this.visualizerSelect.classList.remove("search-active","search-no-match"),void(this.currentVisualizerName&&this.availableVisualizers.has(this.currentVisualizerName)&&(this.visualizerSelect.value=this.currentVisualizerName));if(t.length){const e=t[0];this.visualizerSelect.value=e.name,this.visualizerSelect.classList.add("search-active"),this.visualizerSelect.classList.remove("search-no-match")}else this.visualizerSelect.classList.remove("search-active"),this.visualizerSelect.classList.add("search-no-match")}updateVisualizerSearchSummary(t,e){if(this.visualizerSearchInput&&(!e||t.length?this.visualizerSearchInput.classList.remove("no-results"):this.visualizerSearchInput.classList.add("no-results")),!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(!e)return void this.updateVisualizerSummaryForSelection(this.currentVisualizerName);if(!t.length)return this.visualizerSearchSummary.textContent="No visuals match that search.",void this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent);const i=t[0],s=i.description?`${i.displayName}: ${i.description}`:i.displayName,a=i.tags&&i.tags.length?` (${i.tags.slice(0,3).join(" • ")})`:"";this.visualizerSearchSummary.textContent=`Top match: ${s}${a}`,this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualizerSummaryForSelection(t){if(!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(Boolean(this.visualizerSearchInput?.value?.trim()))return;if(!t)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const e=this.visualizerMetadataByName.get(t);if(!e)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const i=e.description?`${e.displayName}: ${e.description}`:e.displayName,s=e.tags&&e.tags.length?` (${e.tags.slice(0,3).join(" • ")})`:"";this.visualizerSearchSummary.textContent=`${i}${s}`,this.visualizerSearchInput?.classList.remove("no-results"),this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualInfoSummary(t){if(this.visualInfoSummary){if(this.isPlaybackActive)return void(this.visualInfoSummary.textContent="");const e="Use the visual search bar above to change scenes.";this.visualInfoSummary.textContent=t||e}}updateVisualSearchVisibility(){if(!this.visualSearchBar)return;const t=Boolean(document.querySelector("#welcomeModal.active")),e=this.isGettingStartedActive();let i=!1;try{i=!this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted])}catch(t){i=!0}const s=t||e||i,a=s||!this.visualSearchPanelOpen;this.visualSearchBar.classList.toggle("hidden",a),this.visualSearchBar.setAttribute("aria-hidden",a?"true":"false"),a&&(this.setVisualSearchDimmed(!0),this.visualSearchPanelOpen&&s&&(this.visualSearchPanelOpen=!1,this.visualSearchToggleBtn?.classList.remove("player-btn--active"),this.visualSearchToggleBtn?.setAttribute("aria-pressed","false"),document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0)))}setVisualSearchDimmed(t=!0){if(!this.visualSearchBar)return;const e=t&&!this.visualSearchPanelOpen;this.visualSearchBar.classList.toggle("dimmed",e)}refreshVisualSearchSummary(){const t=this.visualizerSearchInput?.value?.trim();t?this.applyVisualizerSearch(t,{showDropdown:!1}):this.updateVisualizerSummaryForSelection(this.currentVisualizerName)}formatTime(t){if(!Number.isFinite(t)||t<0)return"0:00";const e=Math.floor(t);return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`}updatePlayerTimeline(t=null){if(!this.playerCurrentTimeEl||!this.playerDurationEl)return;const e=this.audioManager?.audioElement||null,i=Boolean(this.audioManager?.isMicActive);let s=Number.isFinite(t?.mediaTime)?t.mediaTime:null;!Number.isFinite(s)&&e&&(s=e.currentTime),(!Number.isFinite(s)||s<0)&&(s=0);let a=null;if(Number.isFinite(t?.mediaDuration)&&t.mediaDuration>0?a=t.mediaDuration:Number.isFinite(this.currentTrackDurationMs)&&this.currentTrackDurationMs>0?a=this.currentTrackDurationMs/1e3:e&&Number.isFinite(e.duration)&&e.duration>0&&e.duration!==1/0&&(a=e.duration),i)return this.playerCurrentTimeEl.textContent="LIVE",this.playerDurationEl.textContent="",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),void(this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"));this.playerCurrentTimeEl.textContent=this.formatTime(s),Number.isFinite(a)&&a>0?(this.playerDurationEl.textContent=this.formatTime(a),this.playerDurationDivider&&(this.playerDurationDivider.style.display=""),this.playerDock&&this.playerDock.classList.remove("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","false")):(this.playerDurationEl.textContent="--:--",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"))}async loadAudioFile(t,{pauseBeforeLoad:e=!1,autoPlay:i=!1}={}){try{const s=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),e?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(s),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),(i||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),i="Unknown Artist";const s=e.match(/(.+?)\s*-\s*(.+)/);s&&(i=s[1].trim(),e=s[2].trim()),this.updateNowPlaying(e,i,{source:"file"})}setActiveSource(t){const e="soundcloud"===t&&PLAYER_SOURCE_CONFIG.soundcloud?"soundcloud":"none";this.currentSourceType="none"===e?null:e,"soundcloud"!==e&&(this.currentSoundCloudTrack=null);const i=PLAYER_SOURCE_CONFIG[e],s="soundcloud"===e,a=this.playerSourceIndicatorIcon?.parentElement||null;if(a&&a.classList.toggle("hidden",!s),this.playerDock&&this.playerDock.classList.toggle("player-dock--source-hidden",!s),this.playerSourceIndicatorIcon){for(;this.playerSourceIndicatorIcon.firstChild;)this.playerSourceIndicatorIcon.removeChild(this.playerSourceIndicatorIcon.firstChild);if(s){const t=document.createElement("img");t.src=i.iconImg||"./images/soundcloud.png",t.alt="",t.decoding="async",t.className="player-source-indicator-icon-img",this.playerSourceIndicatorIcon.appendChild(t)}}if(this.sourceCardElements&&this.sourceCardElements.size&&this.sourceCardElements.forEach((t,i)=>{t&&(t.classList.toggle("selection-card--active",e===i),t.setAttribute("aria-pressed",e===i?"true":"false"))}),this.sourcePickerBtn){const t=s&&i.label&&i.label!==PLAYER_SOURCE_CONFIG.none.label?` (current: ${i.label})`:"";this.sourcePickerBtn.setAttribute("aria-label",`Choose audio source${t}`)}this.teardownSourceSelectionOutsideHandler(),this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.updateShareButtonState()}updateNowPlaying(t,e,i={}){const s=(t,e)=>{if("string"==typeof t){const e=t.trim();if(e.length)return e}return e},a=t=>{if("string"!=typeof t)return null;const e=t.trim();return e&&(/^https?:\/\//i.test(e)||/^data:image\//i.test(e)||/^blob:/i.test(e))?e:null},r=Boolean(i?.isSoundCloud),o=i?.source&&PLAYER_SOURCE_CONFIG[i.source]?i.source:r?"soundcloud":i?.source,n=a(i?.trackUrl),l=a(i?.artistUrl),u=(s(i?.trackLinkLabel,"View on SoundCloud"),a(i?.artworkUrl)),d=a(i?.artistImageUrl),h=u||d||null,c=s(t,"No track loaded"),p=s(e,r?"Unknown Creator":"Unknown Artist");this.playerDock&&(this.playerDock.classList.toggle("player-dock--soundcloud",r),this.playerDock.classList.toggle("player-dock--live",Boolean(i?.isLive))),this.playerTitleEl&&(this.playerTitleEl.textContent=c,n?(this.playerTitleEl.href=n,this.playerTitleEl.target="_blank",this.playerTitleEl.rel="noopener"):(this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel"))),this.playerArtistEl&&(this.playerArtistEl.textContent=p,l?(this.playerArtistEl.href=l,this.playerArtistEl.target="_blank",this.playerArtistEl.rel="noopener"):(this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel"))),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!p),this.playerArtworkWrapper&&this.playerArtworkWrapper.removeAttribute("hidden"),this.playerArtwork?h?(this.playerArtwork.src!==h&&(this.playerArtwork.src=h),this.playerArtwork.alt=`${c} by ${p} artwork`,this.playerArtwork.hidden=!1,this.playerArtworkWrapper?.classList.remove("player-artwork--empty")):this.clearPlayerArtwork():h||(this.playerArtworkWrapper?.classList.add("player-artwork--empty"),this.playerArtworkWrapper?.setAttribute("hidden",""));const m="number"==typeof i?.duration&&Number.isFinite(i.duration)&&i.duration>0?i.duration:null;this.currentTrackDurationMs=m,o?this.setActiveSource(o):this.currentSourceType||this.setActiveSource(null),this.updatePlayerTimeline()}showMicrophoneNowPlaying(){this.updateNowPlaying("Microphone","Live input",{source:"mic",isLive:!0}),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.updateSelectionHubVisibility()}hideNowPlaying(){this.currentTrackDurationMs=null,this.playerTitleEl&&(this.playerTitleEl.textContent="No track loaded",this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel")),this.playerArtistEl&&(this.playerArtistEl.textContent="—",this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel")),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.clearPlayerArtwork(),this.playerDock&&(this.playerDock.classList.add("player-dock--no-duration"),this.playerDock.classList.remove("player-dock--soundcloud"),this.playerDock.classList.remove("player-dock--live")),this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"),this.setActiveSource(null),this.updatePlayerTimeline()}clearPlayerArtwork(){this.playerArtworkWrapper&&(this.playerArtworkWrapper.classList.add("player-artwork--empty"),this.playerArtworkWrapper.setAttribute("hidden","")),this.playerArtwork&&(this.playerArtwork.hidden=!0,this.playerArtwork.removeAttribute("src"),this.playerArtwork.alt="")}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">🎧</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),i=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"| |":"▶"),i&&(i.textContent=t?"Pause":"Play"),this.playPauseBtn.setAttribute("aria-label",t?"Pause":"Play");const s=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),a=!!this.demoAudioFile;(s||t)&&this.playPauseBtn.classList.remove("initial-pulse");const r=s||a||t;this.playPauseBtn.disabled=!r,s&&!t?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}this.updatePlayerTimeline()}getDefaultVisualizerName(){const t="undefined"!=typeof window?window.DEFAULT_VISUALIZER:null;if(t&&this.availableVisualizers.has(t))return t;const e=this.availableVisualizers.keys().next();return e&&!e.done?e.value:null}showQuickStartModal({force:t=!1}={}){this.quickStartModal&&(this.quickLaunchPending&&!t||this.onboardingCompleted&&!t||(this.quickStartModal.classList.add("active"),this.quickStartModal.setAttribute("aria-hidden","false"),document.body.classList.add("quickstart-active"),this.selectionHubManual=!1,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="",this.quickStartStatusEl.classList.remove("quickstart-status--error")),this.updateVisualSearchVisibility()))}hideQuickStartModal(t=!0){if(this.quickStartModal){if(this.quickStartModal.classList.remove("active"),this.quickStartModal.setAttribute("aria-hidden","true"),document.body.classList.remove("quickstart-active"),t){this.onboardingCompleted=!0;try{this.setStorageItem(sessionStorage,this.onboardingStorageKey,"true")}catch(t){}}this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.updateVisualSearchVisibility()}}async handleQuickStartStart(){if(this.quickStartStartBtn){this.quickStartStartBtn.disabled=!0,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Loading demo track…",this.quickStartStatusEl.classList.remove("quickstart-status--error"));try{const t=this.getDefaultVisualizerName();t&&t!==this.currentVisualizerName&&await this.switchVisualizer(t);let e=this.demoAudioFile;if(e||(e=await this.loadDemoAudioSilently()),!e)throw new Error("Demo audio unavailable");this.audioManager?.isMicActive&&await this.audioManager.stopMicrophone(),await this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}),this.demoAudioFile=null,this.hideQuickStartModal(!0)}catch(t){this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Quick start failed. Please choose a visual and audio source manually.",this.quickStartStatusEl.classList.add("quickstart-status--error"))}finally{this.quickStartStartBtn.disabled=!1}}}showGettingStartedOverlay({remember:t=!0}={}){this.hasCompletedOnboarding()||this.showQuickStartModal({force:!0})}hideGettingStartedOverlay(){this.hideQuickStartModal()}isGettingStartedActive(){return this.quickStartModal?.classList.contains("active")||!1}showOnboardingOverlay({force:t=!1}={}){this.quickLaunchPending&&!t||!t&&this.hasCompletedOnboarding()||this.showQuickStartModal({force:t})}hideOnboardingOverlay(){this.hideQuickStartModal()}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){if(!this.availableVisualizers.has(t))return void(this.visualSelectionTriggeredFromUI=!1);await this.loadVisualizer(t),this.updateVisualizerSummaryForSelection(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName),this.selectionHubManual=!1,this.highlightActiveVisualizer(t),this.hideVisualSearchDropdown({immediate:!0,force:!0}),this.refreshVisualSearchSummary(),this.imageUploadBtn.style.display="ImageVisualizer"===t||"WebGLImageExplosionVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showOnboardingOverlay();const i=this.visualSelectionTriggerSource,s="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches;this.visualSelectionTriggeredFromUI&&"visual-card"===i&&s&&this.focusSelectionSection("source",{exclusive:!0}),this.visualSearchPanelOpen&&this.closeVisualSearchPanel(),this.visualSelectionTriggeredFromUI=!1,this.visualSelectionTriggerSource=null}destroy(){if(this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,document.removeEventListener("pointerdown",this.handleVisualSearchOutsidePointer,!0),this.quickShareFeedbackTimeout&&(clearTimeout(this.quickShareFeedbackTimeout),this.quickShareFeedbackTimeout=null),this.quickShareBtn&&this.quickShareBtn.removeEventListener("click",this.handleQuickShareClick),this._exportWidgetResizeHandler&&"undefined"!=typeof window&&(window.removeEventListener("resize",this._exportWidgetResizeHandler),this._exportWidgetResizeHandler=null),this.exportWidget&&(this.exportWidget.classList.remove("export-widget--floating"),this.exportWidget.style.height=""),this.videoExportManager?.isRecording?.())try{this.videoExportManager.stop()}catch(t){}if(this.soundCloudModal?.overlay)try{this.soundCloudModal.overlay.remove()}catch(t){}this.soundCloudModal=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{const t=()=>{const t=new VvavyApp;return window.vvavy=t,t};window.visualizersLoaded?t():window.addEventListener("visualizersReady",t)});