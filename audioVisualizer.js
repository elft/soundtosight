class VvavyApp{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.canvas=null,this.dropOverlay=null,this.fileInput=null,this.gettingStartedOverlay=null,this.playPauseBtn=null,this.stopBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.soundcloudBtn=null,this.visualizerSelect=null,this.imageUploadBtn=null,this.menuToggle=null,this.menuPanel=null,this.showHelpOverlayBtn=null,this.onboardingDemoBtn=null,this.onboardingUploadBtn=null,this.onboardingMicBtn=null,this.onboardingSoundCloudBtn=null,this.soundCloudAvailabilityHintEl=null,this.soundCloudHero=null,this.demoAudioPromise=null,this.isProcessingDemoStart=!1,this.storageKeys={onboarding:"vvavyOnboardingSeen",soundCloudToken:"vvavySoundCloudToken",soundCloudHistory:"vvavySoundCloudHistory",termsAccepted:"vvavyAccepted"},this.onboardingStorageKey=this.storageKeys.onboarding,this.isInitialized=!1,this.currentVisualizerName=null,this.soundCloudModal=null,this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="",this.soundCloudTokenStorageKey=this.storageKeys.soundCloudToken,this.soundCloudTokenSafetyWindowMs=15e3,this.soundCloudTokenCache=null,this.soundCloudRecentTracksKey=this.storageKeys.soundCloudHistory,this.soundCloudHistoryCache=null,this.soundCloudHistoryLimit=20,this.init()}getStorageItem(t,e){if(!t||!Array.isArray(e))return null;for(const o of e)if(o)try{const e=t.getItem(o);if(null!==e)return e}catch(t){}return null}setStorageItem(t,e,o){if(t&&e)try{t.setItem(e,o)}catch(t){}}getBooleanStorageValue(t,e){return"true"===this.getStorageItem(t,e)}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager;const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?512:1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupEventListeners(),this.setupDragAndDrop(),await this.checkSoundCloudAvailability(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(e))await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e);else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t)}this.menuToggle&&(this.menuToggle.style.display="inline-flex");const o=this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted,this.storageKeys.legacyTermsAccepted]);let n=!1;try{n="true"===this.getStorageItem(sessionStorage,[this.onboardingStorageKey,this.storageKeys.legacyOnboarding])}catch(t){n=!1}o&&!n?this.showGettingStartedOverlay():!o||this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay(),this.isInitialized=!0,this.loadDemoAudioSilently()}catch(t){}}async checkSoundCloudAvailability(){try{const t=await fetch("/api/soundcloud/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json(),o=Boolean(e?.enabled),n=e?.reason||"";this.soundCloudEnabled=o,this.soundCloudAvailabilityMessage=n;const a=o?"SoundCloud streaming is ready. Search for any track to jump straight into the visuals.":n||"Start the Vvavy server to enable SoundCloud integration.";this.soundcloudBtn&&(o?(this.soundcloudBtn.style.display="flex",this.soundcloudBtn.disabled=!1,delete this.soundcloudBtn.dataset.soundcloudReason):(n?this.soundcloudBtn.dataset.soundcloudReason=n:delete this.soundcloudBtn.dataset.soundcloudReason,this.soundcloudBtn.style.display="none")),this.onboardingSoundCloudBtn&&(this.onboardingSoundCloudBtn.disabled=!o,o?(delete this.onboardingSoundCloudBtn.dataset.soundcloudReason,this.onboardingSoundCloudBtn.removeAttribute("aria-disabled"),this.onboardingSoundCloudBtn.removeAttribute("title")):(a&&(this.onboardingSoundCloudBtn.dataset.soundcloudReason=a,this.onboardingSoundCloudBtn.title=a),this.onboardingSoundCloudBtn.setAttribute("aria-disabled","true"))),this.dropSoundCloudBtn&&(o?(delete this.dropSoundCloudBtn.dataset.soundcloudReason,this.dropSoundCloudBtn.removeAttribute("aria-disabled")):(a&&(this.dropSoundCloudBtn.dataset.soundcloudReason=a),this.dropSoundCloudBtn.setAttribute("aria-disabled","true"))),this.soundCloudAvailabilityHintEl&&(this.soundCloudAvailabilityHintEl.textContent=a),this.soundCloudHero&&this.soundCloudHero.classList.toggle("soundcloud-hero-disabled",!o)}catch(t){this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="Start the Vvavy server to enable SoundCloud integration.",this.soundcloudBtn&&(this.soundcloudBtn.style.display="none"),this.onboardingSoundCloudBtn&&(this.onboardingSoundCloudBtn.disabled=!0,this.onboardingSoundCloudBtn.dataset.soundcloudReason=this.soundCloudAvailabilityMessage,this.onboardingSoundCloudBtn.title=this.soundCloudAvailabilityMessage,this.onboardingSoundCloudBtn.setAttribute("aria-disabled","true")),this.dropSoundCloudBtn&&(this.dropSoundCloudBtn.dataset.soundcloudReason=this.soundCloudAvailabilityMessage,this.dropSoundCloudBtn.setAttribute("aria-disabled","true")),this.soundCloudAvailabilityHintEl&&(this.soundCloudAvailabilityHintEl.textContent=this.soundCloudAvailabilityMessage),this.soundCloudHero&&this.soundCloudHero.classList.add("soundcloud-hero-disabled")}}getCachedSoundCloudToken(){if(this.soundCloudTokenCache?.accessToken)return this.soundCloudTokenCache;try{const t=this.getStorageItem(localStorage,[this.soundCloudTokenStorageKey]);if(!t)return null;const e=JSON.parse(t);if(e&&"object"==typeof e&&e.accessToken)return this.soundCloudTokenCache=e,e}catch(t){}return null}storeSoundCloudToken(t){this.soundCloudTokenCache=t,this.setStorageItem(localStorage,this.soundCloudTokenStorageKey,JSON.stringify(t))}clearSoundCloudToken(){this.soundCloudTokenCache=null;try{localStorage.removeItem(this.soundCloudTokenStorageKey)}catch(t){}}getSoundCloudHistory(){if(!Array.isArray(this.soundCloudHistoryCache)){let t=[];try{const e=this.getStorageItem(localStorage,[this.soundCloudRecentTracksKey,this.storageKeys.legacySoundCloudHistory]);if(e){const o=JSON.parse(e);Array.isArray(o)&&(t=o)}}catch(t){}this.soundCloudHistoryCache=t}return Array.isArray(this.soundCloudHistoryCache)?this.soundCloudHistoryCache.slice():[]}setSoundCloudHistory(t){const e=Array.isArray(t)?t.slice(0,this.soundCloudHistoryLimit):[];if(this.soundCloudHistoryCache=e,this.setStorageItem(localStorage,this.soundCloudRecentTracksKey,JSON.stringify(e)),this.soundCloudModal?.renderHistory)try{this.soundCloudModal.renderHistory(this.getSoundCloudHistory())}catch(t){}}rememberSoundCloudTrack(t){if(!t||"object"!=typeof t)return;const e=null!=t.id?String(t.id):"",o=t.permalinkUrl?String(t.permalinkUrl):"";if(!e&&!o)return;const n={id:e||null,permalinkUrl:o||null,title:t.title||"Untitled track",artist:t.author?.username||null,artworkUrl:t.artworkUrl||null,duration:"number"==typeof t.duration?t.duration:null,lastPlayed:Date.now()},a=this.getSoundCloudHistory().filter(t=>{if(!t||"object"!=typeof t)return!1;const e=n.id&&t.id&&String(t.id)===n.id,o=n.permalinkUrl&&t.permalinkUrl&&t.permalinkUrl===n.permalinkUrl;return!(e||o)});a.unshift(n),this.setSoundCloudHistory(a.slice(0,this.soundCloudHistoryLimit))}async getSoundCloudToken(t=!1){if(!t){const t=this.getCachedSoundCloudToken();if(t?.accessToken&&Number.isFinite(t.expiresAt)&&Date.now()+this.soundCloudTokenSafetyWindowMs<t.expiresAt)return t.accessToken}let e;try{e=await fetch("/api/soundcloud/token",{method:"GET",credentials:"same-origin"})}catch(t){throw new Error("Failed to contact SoundCloud token endpoint.")}if(!e?.ok){let t=`Token request failed (status ${e?.status??"unknown"})`;try{const o=await e.json();o?.error&&(t=o.error)}catch(t){}throw new Error(t)}let o=null;try{o=await e.json()}catch(t){throw new Error("Failed to parse SoundCloud token response.")}if(!o?.accessToken)throw new Error("SoundCloud token response did not include an access token.");const n=Number(o.expiresIn),a=Date.now()+(Number.isFinite(n)&&n>0?1e3*n:36e5),i={accessToken:o.accessToken,expiresAt:a};return this.storeSoundCloudToken(i),i.accessToken}buildSoundCloudUrl(t,e){const o=/^https?:\/\//i.test(t)?new URL(t):new URL(t,"https://api.soundcloud.com");return e&&"object"==typeof e&&Object.entries(e).forEach(([t,e])=>{if(null==e)return;const n=Array.isArray(e)?e:[e];o.searchParams.delete(t),n.forEach(e=>{const n=null==e?"":String(e);o.searchParams.append(t,n)})}),o.toString()}async performSoundCloudFetch(t,{method:e="GET",headers:o={},query:n,body:a,expectJson:i=!0}={},s=0){const r=this.buildSoundCloudUrl(t,n),l=await this.getSoundCloudToken(s>0),d={...o,Authorization:`Bearer ${l}`};i&&!d.Accept?d.Accept="application/json":i||d.Accept||(d.Accept="*/*");const u={method:e,headers:d,credentials:"omit"};let c;null!=a&&("object"!=typeof a||a instanceof Blob||a instanceof FormData?u.body=a:(u.body=JSON.stringify(a),u.headers["Content-Type"]||(u.headers["Content-Type"]="application/json")));try{c=await fetch(r,u)}catch(t){throw new Error(`SoundCloud request failed: ${t.message||t}`)}if(401===c.status&&0===s)return this.clearSoundCloudToken(),this.performSoundCloudFetch(t,{method:e,headers:o,query:n,body:a,expectJson:i},s+1);if(!c.ok){let t="";try{t=await c.text()}catch(e){t=""}const e=t?`: ${t}`:"";throw new Error(`SoundCloud request failed (${c.status})${e}`)}if(!i)return c;const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(t){throw new Error(`Failed to parse SoundCloud response: ${t.message}`)}}async fetchSoundCloudAPI(t,e={}){return this.performSoundCloudFetch(t,e)}sanitizeSoundCloudTrackId(t){if(null==t)return"";const e=String(t).trim();if(!e)return"";if(/^soundcloud:tracks:/i.test(e)){const t=e.split(":");return t[t.length-1]}return e}pickBestSoundCloudTranscoding(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(t=>"progressive"===t?.format?.protocol);return e||(t.find(t=>"hls"===t?.format?.protocol)||t[0])}selectPreferredStreamUrl(t){if(!t||"object"!=typeof t)return null;const e=[t.http_mp3_128_url,t.http_mp3_64_url,t.http_opus_64_url,t.hls_mp3_128_url,t.hls_mp3_64_url,t.hls_opus_64_url,t.hls_url,t.progressive_mp3_url,t.preview_mp3_128_url,t.url];for(const t of e)if(t&&"string"==typeof t)return t;return null}async fetchSoundCloudStreamData(t){if(!t?.id&&!this.sanitizeSoundCloudTrackId(t))throw new Error("Unable to determine SoundCloud track ID.");const e=[];t?.stream_url&&e.push(t.stream_url);let o=null;for(const t of e)if(t)try{const e=await this.fetchSoundCloudAPI(t,{expectJson:!1});if(!e){o=new Error("SoundCloud stream endpoint returned no response.");continue}const n=e.headers;if((n?.get&&n.get("content-type")||"").includes("application/json")){let t=null;try{t=await e.json()}catch(t){o=t}const n=this.selectPreferredStreamUrl(t);if(n)return{streamUrl:n,data:t};o=new Error("SoundCloud stream response did not include a usable URL.");continue}const a=()=>{try{e.body?.cancel?.()}catch(t){}},i=n?.get?n.get("location"):null;if(i)return a(),{streamUrl:i,data:null};if(e.url)return a(),{streamUrl:e.url,data:null};o=new Error("SoundCloud stream endpoint returned an unexpected response.")}catch(t){o=t}if(o)throw o;throw new Error("SoundCloud stream URL is unavailable.")}async fetchSoundCloudTrackById(t){const e=this.sanitizeSoundCloudTrackId(t);if(!e)throw new Error("Track ID is required.");const o=await this.fetchSoundCloudAPI("/tracks",{query:{ids:e}}),n=Array.isArray(o)?o:[];if(!n.length)throw new Error("Track not found on SoundCloud.");return n[0]}async fetchSoundCloudTranscodingUrl(t){if(!t)throw new Error("Transcoding URL is required.");return this.performSoundCloudFetch(t,{expectJson:!0})}openSoundCloudModal(){const t=this.ensureSoundCloudModal();t.form?.reset();const e=this.getSoundCloudHistory(),o=Array.isArray(e)&&e.length>0;if("function"==typeof t.setStatus&&t.setStatus(o?"Choose from recently played tracks or start a new search.":"Search SoundCloud to get started."),t.setLoading?.(!1),t.sortedResults=[],t.nextHref=null,t.totalAvailable=0,t.currentPage=1,t.fetchingMorePromise=null,t.searchQuery="","function"==typeof t.renderResults&&t.renderResults([]),"function"==typeof t.updatePaginationControls&&t.updatePaginationControls(),"function"==typeof t.renderHistory)try{t.renderHistory(e)}catch(t){}t.hasSearched=!1,t.searchInProgress=!1,t.input&&(t.input.disabled=!1),t.cancel&&(t.cancel.disabled=!1),t.overlay.classList.add("active"),setTimeout(()=>{t.input?.focus()},60)}ensureSoundCloudModal(){if(this.soundCloudModal)return this.soundCloudModal;const t=document.createElement("div");t.className="soundcloud-overlay",t.innerHTML='\n            <div class="soundcloud-modal" role="dialog" aria-modal="true">\n                <button type="button" class="soundcloud-modal-close" aria-label="Close">&times;</button>\n                <div class="modal-header soundcloud-modal-header">\n                    <div class="drop-brand soundcloud-modal-brand">\n                        <img src="./images/vvavy_favicon_256.png" alt="" class="brand-mark brand-mark--compact" aria-hidden="true">\n                        <div class="drop-brand-text">\n                            <img src="./images/vvavy_full_logo.png" alt="Vvavy logo" class="brand-mark brand-mark--full" aria-hidden="true">\n                            <span class="drop-brand-tagline">Flow with your sound</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="soundcloud-modal-content">\n                    <form class="soundcloud-modal-form">\n                        <label class="soundcloud-modal-label" for="soundcloudSearchInput">Search SoundCloud</label>\n                        <div class="soundcloud-modal-search-row">\n                            <input type="text" id="soundcloudSearchInput" class="soundcloud-modal-input" name="soundcloudSearch" placeholder="Search for artists, tracks, or genres" autocomplete="off" />\n                            <button type="submit" class="soundcloud-modal-search">Search</button>\n                        </div>\n                    </form>\n                    <div class="soundcloud-modal-body">\n                        <section class="soundcloud-modal-main" aria-label="SoundCloud search results">\n                            <div class="soundcloud-modal-status" aria-live="polite"></div>\n                            <div class="soundcloud-modal-results" role="listbox" aria-label="SoundCloud search results"></div>\n                            <div class="soundcloud-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn prev" aria-label="Previous page" disabled>Previous</button>\n                                <div class="soundcloud-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn next" aria-label="Next page" disabled>Next</button>\n                            </div>\n                        </section>\n                        <aside class="soundcloud-modal-history" aria-label="Recently played SoundCloud tracks">\n                            <div class="soundcloud-history-header">\n                                <h3>Recently Played</h3>\n                                <p class="soundcloud-history-hint">Your latest selections stay here.</p>\n                            </div>\n                            <div class="soundcloud-history-list"></div>\n                            <div class="soundcloud-pagination soundcloud-history-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn prev" aria-label="Previous history page" disabled>Previous</button>\n                                <div class="soundcloud-page-info soundcloud-history-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn next" aria-label="Next history page" disabled>Next</button>\n                            </div>\n                        </aside>\n                    </div>\n                </div>\n                <div class="modal-footer soundcloud-modal-footer">\n                    <button type="button" class="soundcloud-modal-cancel">Close</button>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const e=t.querySelector(".soundcloud-modal-main"),o=t.querySelector(".soundcloud-modal-history"),n={overlay:t,form:t.querySelector(".soundcloud-modal-form"),input:t.querySelector("#soundcloudSearchInput"),cancel:t.querySelector(".soundcloud-modal-cancel"),closeBtn:t.querySelector(".soundcloud-modal-close"),status:t.querySelector(".soundcloud-modal-status"),searchBtn:t.querySelector(".soundcloud-modal-search"),results:t.querySelector(".soundcloud-modal-results"),historySection:o,historyList:o?.querySelector(".soundcloud-history-list")||null,pagination:e?.querySelector(".soundcloud-pagination")||null,paginationPrev:e?.querySelector(".soundcloud-page-btn.prev")||null,paginationNext:e?.querySelector(".soundcloud-page-btn.next")||null,paginationInfo:e?.querySelector(".soundcloud-page-info")||null,historyPagination:o?.querySelector(".soundcloud-history-pagination")||null,historyPaginationPrev:o?.querySelector(".soundcloud-history-page-btn.prev")||null,historyPaginationNext:o?.querySelector(".soundcloud-history-page-btn.next")||null,historyPaginationInfo:o?.querySelector(".soundcloud-history-page-info")||null,currentResults:[],hasSearched:!1,searchInProgress:!1,sortedResults:[],pageSize:10,currentPage:1,nextHref:null,totalAvailable:0,fetchingMorePromise:null,searchQuery:"",historyEntries:[],historyPageSize:10,historyCurrentPage:1},a=(t,e=!1)=>{n.status&&(n.status.textContent=t||"",n.status.classList.toggle("error",Boolean(t&&e)))},i=t=>{n.cancel&&(n.cancel.disabled=t),n.input&&(n.input.disabled=t),n.searchBtn&&(n.searchBtn.disabled=t)},s=t=>{const e=Math.max(0,Math.floor((Number(t)||0)/1e3));return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`},r=(()=>{try{return new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1})}catch(t){return null}})(),l=t=>{if(!t)return{tracks:[],nextHref:null,total:0};if(Array.isArray(t))return{tracks:t,nextHref:null,total:t.length};const e=Array.isArray(t.collection)?t.collection:null,o=Array.isArray(t.tracks)?t.tracks:null,n=t.next_href||t.nextHref||null,a=[t.total_results,t.total,t.collection_size,Array.isArray(e)?e.length:null,Array.isArray(o)?o.length:null].find(t=>"number"==typeof t&&t>=0);return e?{tracks:e,nextHref:n,total:"number"==typeof a?a:e.length}:o?{tracks:o,nextHref:n,total:"number"==typeof a?a:o.length}:{tracks:[],nextHref:n,total:"number"==typeof a?a:0}},d=()=>{if(!n.pagination)return;const t=n.sortedResults.length>0;if(n.pagination.style.display=t?"flex":"none",!t)return n.paginationInfo&&(n.paginationInfo.textContent="Page 1"),n.paginationPrev&&(n.paginationPrev.disabled=!0),void(n.paginationNext&&(n.paginationNext.disabled=!0));const e=Math.max(n.sortedResults.length,n.totalAvailable||0),o=Math.max(1,Math.ceil(e/n.pageSize));if(n.currentPage=Math.min(Math.max(n.currentPage,1),o),n.paginationPrev&&(n.paginationPrev.disabled=n.currentPage<=1),n.paginationNext){const t=Math.ceil(n.sortedResults.length/n.pageSize),e=n.currentPage>=t;n.paginationNext.disabled=e&&!n.nextHref||0===n.sortedResults.length}if(n.paginationInfo)if(n.sortedResults.length){const t=(n.currentPage-1)*n.pageSize+1,e=Math.min(n.currentPage*n.pageSize,n.sortedResults.length),o=Math.max(n.sortedResults.length,n.totalAvailable||0),a=n.nextHref&&o<=n.sortedResults.length?`${n.sortedResults.length}+`:o;n.paginationInfo.textContent=`Page ${n.currentPage} • ${t}-${e} of ${a}`}else n.paginationInfo.textContent="Page 1"},u=()=>{if(!n.sortedResults.length)return y([]),void d();const t=Math.max(1,Math.ceil(n.sortedResults.length/n.pageSize));n.currentPage>t&&(n.currentPage=t);const e=(n.currentPage-1)*n.pageSize,o=e+n.pageSize,a=n.sortedResults.slice(e,o);y(a),d()},c=(t=[],{append:e=!1,nextHref:o=null,total:a=null}={})=>{const i=Array.isArray(t)?t:[],s=e?n.sortedResults.concat(i):i;n.sortedResults=((t=[])=>t.filter(t=>t&&"object"==typeof t).slice().sort((t,e)=>{const o=Number(t?.playback_count)||0,n=Number(e?.playback_count)||0;return o===n?0:n-o}))(((t=[])=>{const e=new Set,o=[];return t.forEach(t=>{if(!t||"object"!=typeof t)return;const n=null!=t.id?`id:${t.id}`:null,a=t.permalink_url||t.permalinkUrl||"",i=n||(a?`url:${a}`:null);i&&e.has(i)||(i&&e.add(i),o.push(t))}),o})(s)),e||(n.currentPage=1),n.totalAvailable="number"==typeof a&&a>=0?Math.max(a,n.sortedResults.length):e?Math.max(n.totalAvailable||0,n.sortedResults.length):n.sortedResults.length,n.nextHref=o||null,u()},h=async()=>{if(!n.nextHref)return!1;if(n.fetchingMorePromise)return await n.fetchingMorePromise,!0;const t=n.status?.textContent||"";return n.fetchingMorePromise=(async()=>{i(!0),a("Loading more SoundCloud tracks...");try{const t=await this.fetchSoundCloudAPI(n.nextHref,{query:{linked_partitioning:"1"}}),{tracks:e,nextHref:o,total:i}=l(t);c(e,{append:!0,nextHref:o,total:i}),n.sortedResults.length?a("Showing SoundCloud tracks sorted by plays."):a("No additional tracks found.")}catch(t){a(t?.message||"Failed to load more SoundCloud tracks.",!0),n.nextHref=null}finally{!n.sortedResults.length&&t&&a(t),i(!1),n.fetchingMorePromise=null}})(),await n.fetchingMorePromise,n.sortedResults.length>0},y=(t=[])=>{if(n.currentResults=Array.isArray(t)?t:[],!n.results)return;if(n.results.innerHTML="",n.results.scrollTop=0,!n.currentResults.length){if(n.hasSearched&&!n.searchInProgress){const t=document.createElement("div");t.className="soundcloud-results-empty",t.textContent="No tracks found. Try another search term.",n.results.appendChild(t)}return}const e=document.createElement("div");e.className="soundcloud-results-list",n.currentResults.forEach(t=>{if(!t||"object"!=typeof t)return;const o=document.createElement("button");o.type="button",o.className="soundcloud-search-item",o.dataset.trackId=null!=t.id?String(t.id):"",o.dataset.trackPermalink=t.permalink_url||t.permalinkUrl||"",o.dataset.trackTitle=t.title||"",o.setAttribute("role","option"),o.setAttribute("aria-selected","false");const n=document.createElement("div");n.className="soundcloud-search-item-text";const a=document.createElement("div");a.className="soundcloud-search-title",a.textContent=t.title||"Untitled track";const i=document.createElement("div");i.className="soundcloud-search-meta";const l=[];t.user?.username&&l.push(t.user.username),t.duration&&l.push(s(t.duration));const d=(t=>{const e=Number(t);if(!Number.isFinite(e)||e<0)return null;if(r)return r.format(e);try{return e.toLocaleString()}catch(t){return String(e)}})(t.playback_count);d&&l.push(`${d} plays`),i.textContent=l.join(" • "),n.appendChild(a),n.appendChild(i);const u=document.createElement("span");u.className="soundcloud-search-play",u.textContent="▶",o.appendChild(n),o.appendChild(u),o.dataset.trackId||o.dataset.trackPermalink||(o.disabled=!0),e.appendChild(o)}),n.results.appendChild(e)},g=()=>{if(!n.historyPagination)return;const t=n.historyEntries.length,e=t>0;if(n.historyPagination.style.display=e?"flex":"none",!e)return n.historyPaginationInfo&&(n.historyPaginationInfo.textContent="Page 1"),n.historyPaginationPrev&&(n.historyPaginationPrev.disabled=!0),void(n.historyPaginationNext&&(n.historyPaginationNext.disabled=!0));const o=Math.max(1,Math.ceil(t/n.historyPageSize));if(n.historyCurrentPage=Math.min(Math.max(n.historyCurrentPage,1),o),n.historyPaginationPrev&&(n.historyPaginationPrev.disabled=n.historyCurrentPage<=1),n.historyPaginationNext&&(n.historyPaginationNext.disabled=n.historyCurrentPage>=o),n.historyPaginationInfo){const e=(n.historyCurrentPage-1)*n.historyPageSize+1,o=Math.min(n.historyCurrentPage*n.historyPageSize,t);n.historyPaginationInfo.textContent=`Page ${n.historyCurrentPage} • ${e}-${o} of ${t}`}},p=(t=this.getSoundCloudHistory(),{preservePage:e=!1}={})=>{const o=Array.isArray(t)?t.filter(t=>t&&"object"==typeof t).sort((t,e)=>(Number(e.lastPlayed)||0)-(Number(t.lastPlayed)||0)):[];o.length>this.soundCloudHistoryLimit&&(o.length=this.soundCloudHistoryLimit),n.historyEntries=o;const a=Math.max(1,Math.ceil(o.length/n.historyPageSize));n.historyCurrentPage=e?Math.min(Math.max(n.historyCurrentPage,1),a):1,(()=>{if(!n.historyList)return;n.historyList.innerHTML="";const t=n.historyEntries;if(!t.length){n.historySection&&n.historySection.classList.add("soundcloud-history-empty");const t=document.createElement("div");return t.className="soundcloud-history-empty",t.textContent="Play SoundCloud tracks to build your recent history.",n.historyList.appendChild(t),void g()}n.historySection&&n.historySection.classList.remove("soundcloud-history-empty");const e=Math.max(1,Math.ceil(t.length/n.historyPageSize));n.historyCurrentPage=Math.min(Math.max(n.historyCurrentPage,1),e);const o=(n.historyCurrentPage-1)*n.historyPageSize,a=o+n.historyPageSize,i=t.slice(o,a),r=document.createElement("div");r.className="soundcloud-history-items",i.forEach(t=>{if(!t||"object"!=typeof t)return;const e=document.createElement("button");e.type="button",e.className="soundcloud-history-item soundcloud-search-item",e.dataset.trackId=null!=t.id?String(t.id):"",e.dataset.trackPermalink=t.permalinkUrl||"",e.dataset.trackTitle=t.title||"",e.setAttribute("role","option"),e.setAttribute("aria-selected","false");const o=document.createElement("div");o.className="soundcloud-search-item-text";const n=document.createElement("div");n.className="soundcloud-search-title",n.textContent=t.title||"Untitled track";const a=document.createElement("div");a.className="soundcloud-search-meta";const i=[];t.artist&&i.push(t.artist),t.duration&&i.push(s(t.duration)),i.push("Recently played"),a.textContent=i.join(" • "),o.appendChild(n),o.appendChild(a),e.appendChild(o),r.appendChild(e)}),n.historyList.appendChild(r),g()})(),!e&&n.historyList&&(n.historyList.scrollTop=0)},m=()=>{t.classList.remove("active"),n.form&&n.form.reset(),a(""),i(!1),n.hasSearched=!1,n.searchInProgress=!1,n.sortedResults=[],n.nextHref=null,n.totalAvailable=0,n.currentPage=1,n.fetchingMorePromise=null,n.searchQuery="",y([]),d(),p(this.getSoundCloudHistory())};n.close=m,n.setStatus=a,n.setLoading=i,n.renderResults=y,n.renderHistory=p,n.updatePaginationControls=d,n.paginationPrev?.addEventListener("click",t=>{t.preventDefault(),n.searchInProgress||n.currentPage<=1||(n.currentPage=Math.max(1,n.currentPage-1),u(),n.results?.scrollTo({top:0,behavior:"smooth"}))}),n.paginationNext?.addEventListener("click",async t=>{if(t.preventDefault(),n.searchInProgress)return;const e=n.currentPage+1,o=(e-1)*n.pageSize+1;n.sortedResults.length<o&&n.nextHref&&(n.paginationNext.disabled=!0,await h()),e<=Math.max(1,Math.ceil(n.sortedResults.length/n.pageSize))&&(n.currentPage=e),u(),n.results?.scrollTo({top:0,behavior:"smooth"})});const f=async()=>{const t=n.input?.value?.trim();if(!t)return a("Enter a search term to continue.",!0),!1;if(t.length<3)return a("Search term must be at least 3 characters.",!0),!1;n.hasSearched=!0,n.searchInProgress=!0,n.searchQuery=t,n.sortedResults=[],n.currentPage=1,n.nextHref=null,n.totalAvailable=0,y([]),d(),a("Searching SoundCloud..."),i(!0);try{const e=Math.min(5*n.pageSize,50),o=await this.fetchSoundCloudAPI("/tracks",{query:{q:t,limit:String(e),linked_partitioning:"1"}}),{tracks:i,nextHref:s,total:r}=l(o);return c(i,{append:!1,nextHref:s,total:r}),n.sortedResults.length||s?(a("Showing SoundCloud tracks sorted by plays."),n.sortedResults.length>0||Boolean(s)):(a("No tracks found. Try another search.",!0),!1)}catch(t){return a(t?.message||"Failed to search SoundCloud.",!0),n.sortedResults=[],n.nextHref=null,y([]),d(),!1}finally{n.searchInProgress=!1,i(!1),u()}};n.closeBtn?.addEventListener("click",m),n.cancel?.addEventListener("click",t=>{t.preventDefault(),m()}),t.addEventListener("click",e=>{e.target===t&&m()}),n.searchBtn?.addEventListener("click",async t=>{t.preventDefault(),await f()});const v=async t=>{if(!t)return;const e=t.dataset.trackId,o=t.dataset.trackPermalink||e;if(!o)return void a("Unable to load this track.",!0);const n=t.dataset.trackTitle||"SoundCloud track";a(`Loading "${n}"...`),i(!0);try{const t=await this.resolveSoundCloudTrack(o);m(),await this.loadSoundCloudTrack(t)}catch(t){a(t?.message||"Failed to load SoundCloud track.",!0),i(!1)}};return n.results?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-search-item");t.preventDefault(),await v(e)}),n.historyList?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-history-item");e&&(t.preventDefault(),await v(e))}),n.form?.addEventListener("submit",async t=>{t.preventDefault(),await f()}),p(this.getSoundCloudHistory()),d(),this.soundCloudModal=n,n}async resolveSoundCloudTrack(t){const e=(t||"").trim();if(!e)throw new Error("Please provide a SoundCloud track reference.");let o=null,n=null;const a=this.sanitizeSoundCloudTrackId(e);if(/^[0-9]+$/.test(a)&&a)n=a,o=await this.fetchSoundCloudTrackById(n);else{let t;try{t=await this.fetchSoundCloudAPI("/resolve",{query:{url:e}})}catch(t){throw new Error(t?.message||"Failed to resolve SoundCloud track.")}if(!t)throw new Error("SoundCloud resolve returned no data.");if("track"===t.kind)o=t,n=this.sanitizeSoundCloudTrackId(t.id);else{if(!t.location)throw new Error(`Resolved resource is not a track (${t.kind||"unknown"}).`);try{const e=new URL(t.location,"https://api.soundcloud.com").pathname.split("/").filter(Boolean);if(n=this.sanitizeSoundCloudTrackId(e[e.length-1]),!n)throw new Error("Unable to determine track ID from SoundCloud resolve response.");o=await this.fetchSoundCloudTrackById(n)}catch(t){throw new Error(t?.message||"Failed to follow SoundCloud resolve redirect.")}}if(!o?.media){const t=o?.id||n;if(!t)throw new Error("Unable to determine SoundCloud track ID.");o=await this.fetchSoundCloudTrackById(t)}}if(!o)throw new Error("Failed to load SoundCloud track data.");if(!1===o.streamable)throw new Error("This SoundCloud track does not permit streaming via the API.");if("string"==typeof o.policy&&"block"===o.policy.toLowerCase())throw new Error("SoundCloud has blocked API streaming for this track.");let i=null,s=null,r=null;try{const t=await this.fetchSoundCloudStreamData(o);i=t?.streamUrl||null,s=t?.data||null}catch(t){}if(!i){const t=o.media?.transcodings||[],e=this.pickBestSoundCloudTranscoding(t);if(!e?.url)throw new Error("Track has no available streamable formats.");let n;try{n=await this.fetchSoundCloudTranscodingUrl(e.url)}catch(t){throw new Error(t?.message||"Failed to obtain SoundCloud stream URL.")}const a=this.selectPreferredStreamUrl(n)||n?.url||null;if(!a)throw new Error("SoundCloud did not return a usable stream URL for this track.");i=a,s=n||null,r=e}return{id:o.id,title:o.title,duration:o.duration,permalinkUrl:o.permalink_url||o.permalinkUrl||null,artworkUrl:o.artwork_url||o.user?.avatar_url||null,author:o.user?{id:o.user.id,username:o.user.username,permalink:o.user.permalink_url||null,avatarUrl:o.user.avatar_url||null}:null,streamUrl:i,streamMetadata:s,waveformUrl:o.waveform_url||null,media:{format:r?.format||null,preset:r?.preset||null,quality:r?.quality||null,protocol:r?.format?.protocol||r?.protocol||s?.protocol||null,streamType:s?.stream_type||null}}}async loadSoundCloudTrack(t){if(!t?.streamUrl)throw new Error("SoundCloud stream is unavailable for this track.");const e=this.showLoadingMessage("Loading SoundCloud track...");try{this.audioManager.isPlaying&&this.audioManager.pause(),await this.audioManager.loadStreamFromUrl(t.streamUrl),this.rememberSoundCloudTrack(t),this.hideLoadingMessage(e),this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.hideAudioContextHint();const o=t.author?.username||"SoundCloud",n="string"==typeof t.permalinkUrl?t.permalinkUrl:t.permalink_url,a=t.author?.permalink,i=t.artworkUrl||t.artwork_url||t.author?.avatarUrl||null,s=t.author?.avatarUrl||null,r="string"==typeof n&&/^https?:\/\//i.test(n),l="string"==typeof a&&/^https?:\/\//i.test(a);!t.artworkUrl&&i&&(t.artworkUrl=i),s&&t.author&&!t.author.avatarUrl&&(t.author.avatarUrl=s),this.updateNowPlaying(t.title||"Unknown Track",o,{source:"soundcloud",isSoundCloud:!0,trackUrl:r?n:null,artistUrl:l?a:null,logoLinkUrl:r?n:l?a:"https://soundcloud.com",trackLinkLabel:r?"Listen on SoundCloud":"Creator on SoundCloud",artworkUrl:i,artistImageUrl:s}),this.updateControlButtons(!1,!1),setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,!1)}},150)}catch(t){throw this.hideLoadingMessage(e),t}}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const t="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const e=await fetch(t,{method:"HEAD"});if(!e.ok)throw new Error(`Demo audio not found (status ${e.status})`);const o=await fetch(t);if(!o.ok)throw new Error(`Failed to fetch demo audio (status ${o.status})`);const n=await o.blob(),a=new File([n],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=a,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),a})().catch(t=>{throw this.demoAudioFile=null,t});try{return await this.demoAudioPromise}catch(t){return this.demoAudioPromise=null,null}}async startDemoFromOnboarding(){if(this.isProcessingDemoStart)return;this.isProcessingDemoStart=!0;const t=this.onboardingDemoBtn,e=t?.querySelector("strong"),o=t?.querySelector("small"),n=e?.textContent||"Play Demo Track",a=o?.textContent||"See the visualizer in action instantly";t&&(t.disabled=!0),e&&(e.textContent="Loading demo..."),o&&(o.textContent="Preparing audio magic");try{const t=await this.loadDemoAudioSilently();if(!t)throw new Error("Demo audio unavailable");this.hideGettingStartedOverlay(),this.hideDropOverlay(),await this.loadAudioFile(t),this.demoAudioFile=null}catch(t){alert("Demo track isn't available right now. Try uploading your own audio instead."),this.showDropOverlay()}finally{t&&(t.disabled=!1),e&&(e.textContent=n),o&&(o.textContent=a),this.isProcessingDemoStart=!1}}initializeDOMElements(){this.dropOverlay=document.getElementById("dropOverlay"),this.dropUploadCard=document.getElementById("dropUploadCard"),this.dropUploadBrowseBtn=document.getElementById("dropUploadBrowseBtn"),this.dropSoundCloudBtn=document.getElementById("dropSoundCloudBtn"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.stopBtn=document.getElementById("stopBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.soundcloudBtn=document.getElementById("soundcloudBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.menuToggle=document.getElementById("menuToggle"),this.menuPanel=document.querySelector(".menu-panel"),this.showHelpOverlayBtn=document.getElementById("showHelpOverlayBtn"),this.onboardingDemoBtn=document.getElementById("startDemoBtn"),this.onboardingUploadBtn=document.getElementById("startUploadBtn"),this.onboardingMicBtn=document.getElementById("startMicBtn"),this.onboardingSoundCloudBtn=document.getElementById("startSoundCloudBtn"),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.dropUploadCard&&this.fileInput&&this.dropUploadCard.addEventListener("click",t=>{t.target.closest("button")||this.fileInput.click()}),this.dropUploadBrowseBtn&&this.fileInput&&this.dropUploadBrowseBtn.addEventListener("click",t=>{t.stopPropagation(),this.fileInput.click()})}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t)}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e),(t||e)&&this.hideGettingStartedOverlay()})}setupEventListeners(){const t=(t,{hideOnboarding:e=!0,hideDrop:o=!0}={})=>{if(!this.soundCloudEnabled){const e=t?.dataset?.soundcloudReason||this.soundcloudBtn?.dataset?.soundcloudReason||this.onboardingSoundCloudBtn?.dataset?.soundcloudReason||this.dropSoundCloudBtn?.dataset?.soundcloudReason||this.soundCloudAvailabilityMessage||"SoundCloud integration is currently unavailable.";return void alert(e)}e&&this.hideGettingStartedOverlay(),o&&this.hideDropOverlay(),this.openSoundCloudModal()};this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(t){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.stopBtn?.addEventListener("click",()=>{this.audioManager.stop({unload:!0}),this.hideNowPlaying(),this.showDropOverlay(),this.updateControlButtons(!1,!1)}),this.micBtn?.addEventListener("click",async()=>{if(this.audioManager.isMicActive)return this.audioManager.stopMicrophone();const t=this.micBtn.querySelector(".btn-icon"),e=this.micBtn.querySelector(".btn-label"),o=t?t.textContent:"🎤",n=e?e.textContent:"Microphone";t&&(t.textContent="⏳"),e&&(e.textContent="Loading..."),this.micBtn.disabled=!0;try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideDropOverlay(),this.hideAudioContextHint(),this.hideNowPlaying()}catch(a){alert("Microphone access denied or unavailable."),t&&(t.textContent=o),e&&(e.textContent=n)}finally{this.micBtn.disabled=!1}}),this.fileSelectBtn?.addEventListener("click",()=>{this.fileInput?.click()}),this.soundcloudBtn?.addEventListener("click",()=>{t(this.soundcloudBtn)}),this.onboardingSoundCloudBtn?.addEventListener("click",()=>{t(this.onboardingSoundCloudBtn)}),this.dropSoundCloudBtn?.addEventListener("click",e=>{e.stopPropagation(),t(this.dropSoundCloudBtn)}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",t=>{const e=t.target.value;e&&e!==this.currentVisualizerName&&this.switchVisualizer(e)}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),this.showHelpOverlayBtn?.addEventListener("click",()=>{this.showGettingStartedOverlay({remember:!1})}),this.onboardingDemoBtn?.addEventListener("click",()=>{this.startDemoFromOnboarding()}),this.onboardingUploadBtn?.addEventListener("click",()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.fileInput?.click()}),this.onboardingMicBtn?.addEventListener("click",()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.micBtn?.click()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.hideDropOverlay()})}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showDropOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideDropOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideDropOverlay(),this.hideGettingStartedOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&this.loadAudioFile(e)})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){"undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)&&window.VISUALIZERS_MANIFEST.forEach(t=>{const e=t.name,o=window[e];"function"==typeof o&&this.availableVisualizers.set(e,{name:e,class:o,file:t.file})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,o=window[e];"function"==typeof o&&this.availableVisualizers.set(e,{name:e,class:o})})}async loadAudioFile(t){try{const e=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(e),this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,!1)}},150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),o="Unknown Artist";const n=e.match(/(.+?)\s*-\s*(.+)/);n&&(o=n[1].trim(),e=n[2].trim()),this.updateNowPlaying(e,o)}updateNowPlaying(t,e,o={}){const n=document.getElementById("nowPlaying"),a=document.getElementById("trackTitle"),i=document.getElementById("trackArtist"),s=document.getElementById("trackArtwork"),r=document.querySelector("#nowPlaying .track-artist-prefix"),l=document.getElementById("soundCloudAttribution"),d=document.getElementById("soundCloudLogoLink"),u=document.getElementById("soundCloudTrackLink"),c=(t,e)=>{if("string"==typeof t){const e=t.trim();if(e.length)return e}return e},h=t=>{if("string"!=typeof t)return null;const e=t.trim();return e&&(/^https?:\/\//i.test(e)||/^data:image\//i.test(e)||/^blob:/i.test(e))?e:null},y=Boolean(o?.isSoundCloud),g=h(o?.trackUrl),p=h(o?.artistUrl),m=h(o?.logoLinkUrl)||g||p||"https://soundcloud.com",f=c(o?.trackLinkLabel,"View on SoundCloud"),v=h(o?.artworkUrl),C=h(o?.artistImageUrl),S=v||C||null,b=c(t,"Unknown Track"),k=c(e,y?"Unknown Creator":"Unknown Artist");if(n&&a&&i&&(a.textContent=b,i.textContent=k,n.style.display="block"),a&&(g?(a.href=g,a.target="_blank",a.rel="noopener"):(a.removeAttribute("href"),a.removeAttribute("target"),a.removeAttribute("rel"))),s&&(S?(s.src!==S&&(s.src=S),s.alt=`${b} by ${k} artwork`,s.hidden=!1,s.style.display=""):(s.hidden=!0,s.style.display="none",s.removeAttribute("src"),s.alt="")),i&&(p?(i.href=p,i.target="_blank",i.rel="noopener"):(i.removeAttribute("href"),i.removeAttribute("target"),i.removeAttribute("rel"))),r&&(r.hidden=!k),l)if(y){if(l.hidden=!1,l.setAttribute("data-source","soundcloud"),l.style.display="flex",d&&(d.href=m,d.target="_blank",d.rel="noopener",d.setAttribute("aria-label","SoundCloud attribution")),u){const t=g||m;u.href=t,u.target="_blank",u.rel="noopener",u.textContent=f,u.setAttribute("aria-label",`Open SoundCloud source for ${b}`)}}else l.hidden=!0,l.style.display="none",l.removeAttribute("data-source"),d&&(d.removeAttribute("href"),d.removeAttribute("target"),d.removeAttribute("rel"),d.removeAttribute("aria-label")),u&&(u.removeAttribute("href"),u.removeAttribute("target"),u.removeAttribute("rel"),u.removeAttribute("aria-label"))}hideNowPlaying(){const t=document.getElementById("nowPlaying");t&&(t.style.display="none")}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">🎧</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),o=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"⏸":"▶"),o&&(o.textContent=t?"Pause":"Play");const n=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),a=!!this.demoAudioFile;(n||t)&&this.playPauseBtn.classList.remove("initial-pulse");const i=n||a||t;this.playPauseBtn.disabled=!i,n&&!t?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}if(this.stopBtn&&(this.stopBtn.disabled=!t&&!e),this.micBtn){const t=this.micBtn.querySelector(".btn-icon"),o=this.micBtn.querySelector(".btn-label");t&&(t.textContent=e?"🔴":"🎤"),o&&(o.textContent=e?"Stop Mic":"Microphone")}}showGettingStartedOverlay({remember:t=!0}={}){if(t)try{this.setStorageItem(sessionStorage,this.onboardingStorageKey,"true")}catch(t){}this.showDropOverlay()}hideGettingStartedOverlay(){this.hideDropOverlay()}isGettingStartedActive(){return this.dropOverlay?.classList.contains("active")||!1}showDropOverlay(){this.dropOverlay?.classList.contains("active")||(this.dropOverlay?.classList.add("active"),document.body.classList.add("drop-overlay-active"))}hideDropOverlay(){this.dropOverlay?.classList.remove("active","drag-over"),document.body.classList.remove("drop-overlay-active")}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){this.availableVisualizers.has(t)&&(await this.loadVisualizer(t),this.imageUploadBtn.style.display="ImageVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay())}destroy(){if(this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.soundCloudModal?.overlay)try{this.soundCloudModal.overlay.remove()}catch(t){}this.soundCloudModal=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{const t=()=>{const t=new VvavyApp;return window.vvavy=t,t};window.visualizersLoaded?t():window.addEventListener("visualizersReady",t)});