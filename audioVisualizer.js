class SoundToSight{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.canvas=null,this.dropOverlay=null,this.fileInput=null,this.gettingStartedOverlay=null,this.playPauseBtn=null,this.stopBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.visualizerSelect=null,this.imageUploadBtn=null,this.menuToggle=null,this.menuPanel=null,this.showHelpOverlayBtn=null,this.onboardingDemoBtn=null,this.onboardingUploadBtn=null,this.onboardingMicBtn=null,this.demoAudioPromise=null,this.isProcessingDemoStart=!1,this.onboardingStorageKey="soundToSightOnboardingSeen",this.isInitialized=!1,this.currentVisualizerName=null,this.init()}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager;const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?512:1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupEventListeners(),this.setupDragAndDrop(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(e))await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e);else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t)}this.menuToggle&&(this.menuToggle.style.display="inline-flex");const i="true"===localStorage.getItem("soundToSightAccepted");let a=!1;try{a="true"===sessionStorage.getItem(this.onboardingStorageKey)}catch(t){a=!1}i&&!a?this.showGettingStartedOverlay():!i||this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay(),this.isInitialized=!0,this.loadDemoAudioSilently()}catch(t){}}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const t="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const e=await fetch(t,{method:"HEAD"});if(!e.ok)throw new Error(`Demo audio not found (status ${e.status})`);const i=await fetch(t);if(!i.ok)throw new Error(`Failed to fetch demo audio (status ${i.status})`);const a=await i.blob(),s=new File([a],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=s,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),s})().catch(t=>{throw this.demoAudioFile=null,t});try{return await this.demoAudioPromise}catch(t){return this.demoAudioPromise=null,null}}async startDemoFromOnboarding(){if(this.isProcessingDemoStart)return;this.isProcessingDemoStart=!0;const t=this.onboardingDemoBtn,e=t?.querySelector("strong"),i=t?.querySelector("small"),a=e?.textContent||"Play Demo Track",s=i?.textContent||"See the visualizer in action instantly";t&&(t.disabled=!0),e&&(e.textContent="Loading demo..."),i&&(i.textContent="Preparing audio magic");try{const t=await this.loadDemoAudioSilently();if(!t)throw new Error("Demo audio unavailable");this.hideGettingStartedOverlay(),this.hideDropOverlay(),await this.loadAudioFile(t),this.demoAudioFile=null}catch(t){alert("Demo track isn't available right now. Try uploading your own audio instead."),this.showDropOverlay()}finally{t&&(t.disabled=!1),e&&(e.textContent=a),i&&(i.textContent=s),this.isProcessingDemoStart=!1}}initializeDOMElements(){this.dropOverlay=document.getElementById("dropOverlay"),this.fileInput=document.getElementById("fileInput"),this.gettingStartedOverlay=document.getElementById("gettingStartedOverlay"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.stopBtn=document.getElementById("stopBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.menuToggle=document.getElementById("menuToggle"),this.menuPanel=document.querySelector(".menu-panel"),this.showHelpOverlayBtn=document.getElementById("showHelpOverlayBtn"),this.onboardingDemoBtn=document.getElementById("startDemoBtn"),this.onboardingUploadBtn=document.getElementById("startUploadBtn"),this.onboardingMicBtn=document.getElementById("startMicBtn"),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.dropOverlay&&this.fileInput&&(this.dropOverlay.style.cursor="pointer",this.dropOverlay.addEventListener("click",t=>{t.dataTransfer||this.fileInput.click()})),this.gettingStartedOverlay&&this.gettingStartedOverlay.addEventListener("click",t=>{t.target===this.gettingStartedOverlay&&(this.hideGettingStartedOverlay(),this.audioManager?.audioElement||this.audioManager?.isMicActive||this.showDropOverlay())})}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t)}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e),(t||e)&&this.hideGettingStartedOverlay()})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(t){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.stopBtn?.addEventListener("click",()=>{this.audioManager.stop({unload:!0}),this.hideNowPlaying(),this.showDropOverlay(),this.updateControlButtons(!1,!1)}),this.micBtn?.addEventListener("click",async()=>{if(this.audioManager.isMicActive)return this.audioManager.stopMicrophone();const t=this.micBtn.querySelector(".btn-icon"),e=this.micBtn.querySelector(".btn-label"),i=t?t.textContent:"🎤",a=e?e.textContent:"Microphone";t&&(t.textContent="⏳"),e&&(e.textContent="Loading..."),this.micBtn.disabled=!0;try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideDropOverlay(),this.hideAudioContextHint(),this.hideNowPlaying()}catch(s){alert("Microphone access denied or unavailable."),t&&(t.textContent=i),e&&(e.textContent=a)}finally{this.micBtn.disabled=!1}}),this.fileSelectBtn?.addEventListener("click",()=>{this.fileInput?.click()}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",t=>{const e=t.target.value;e&&e!==this.currentVisualizerName&&this.switchVisualizer(e)}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),this.showHelpOverlayBtn?.addEventListener("click",()=>{this.showGettingStartedOverlay({remember:!1})}),this.onboardingDemoBtn?.addEventListener("click",()=>{this.startDemoFromOnboarding()}),this.onboardingUploadBtn?.addEventListener("click",()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.fileInput?.click()}),this.onboardingMicBtn?.addEventListener("click",()=>{this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.micBtn?.click()}),document.addEventListener("keydown",t=>{if("Escape"===t.key){const t=this.isGettingStartedActive();this.hideGettingStartedOverlay(),!t||this.audioManager?.audioElement||this.audioManager?.isMicActive||this.showDropOverlay()}})}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showDropOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideDropOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideDropOverlay(),this.hideGettingStartedOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&this.loadAudioFile(e)})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){"undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)&&window.VISUALIZERS_MANIFEST.forEach(t=>{const e=t.name,i=window[e];"function"==typeof i&&this.availableVisualizers.set(e,{name:e,class:i,file:t.file})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,i=window[e];"function"==typeof i&&this.availableVisualizers.set(e,{name:e,class:i})})}async loadAudioFile(t){try{const e=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(e),this.hideGettingStartedOverlay(),this.hideDropOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,!1)}},150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),i="Unknown Artist";const a=e.match(/(.+?)\s*-\s*(.+)/);a&&(i=a[1].trim(),e=a[2].trim()),this.updateNowPlaying(e,i)}updateNowPlaying(t,e){const i=document.getElementById("nowPlaying"),a=document.getElementById("trackTitle"),s=document.getElementById("trackArtist");i&&a&&s&&(a.textContent=t||"Unknown Track",s.textContent=e||"Unknown Artist",i.style.display="block")}hideNowPlaying(){const t=document.getElementById("nowPlaying");t&&(t.style.display="none")}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">🎧</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),i=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"⏸":"▶"),i&&(i.textContent=t?"Pause":"Play");const a=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),s=!!this.demoAudioFile;(a||t)&&this.playPauseBtn.classList.remove("initial-pulse");const n=a||s||t;this.playPauseBtn.disabled=!n,a&&!t?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}if(this.stopBtn&&(this.stopBtn.disabled=!t&&!e),this.micBtn){const t=this.micBtn.querySelector(".btn-icon"),i=this.micBtn.querySelector(".btn-label");t&&(t.textContent=e?"🔴":"🎤"),i&&(i.textContent=e?"Stop Mic":"Microphone")}}showGettingStartedOverlay({remember:t=!0}={}){if(this.gettingStartedOverlay&&(this.hideDropOverlay(),this.gettingStartedOverlay.classList.add("active"),document.body.classList.add("getting-started-active"),t))try{sessionStorage.setItem(this.onboardingStorageKey,"true")}catch(t){}}hideGettingStartedOverlay(){this.gettingStartedOverlay&&(this.gettingStartedOverlay.classList.remove("active"),document.body.classList.remove("getting-started-active"))}isGettingStartedActive(){return this.gettingStartedOverlay?.classList.contains("active")||!1}showDropOverlay(){this.isGettingStartedActive()||(this.dropOverlay?.classList.add("active"),document.body.classList.add("drop-overlay-active"))}hideDropOverlay(){this.dropOverlay?.classList.remove("active","drag-over"),document.body.classList.remove("drop-overlay-active")}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){this.availableVisualizers.has(t)&&(await this.loadVisualizer(t),this.imageUploadBtn.style.display="ImageVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay())}destroy(){this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{window.visualizersLoaded?window.soundToSight=new SoundToSight:window.addEventListener("visualizersReady",()=>window.soundToSight=new SoundToSight)});