const DEFAULT_PLAYER_ART="./images/vvavy_full_logo.png",PLAYER_SOURCE_CONFIG={none:{label:"No source",icon:"🎵"},file:{label:"Upload",icon:"📁"},mic:{label:"Microphone",icon:"🎤"},soundcloud:{label:"SoundCloud",icon:"☁️",iconImg:"./images/soundcloud.png"},demo:{label:"Demo track",icon:"🎧"}};class VvavyApp{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.visualizerManifest=[],this.visualizerMetadataByName=new Map,this.canvas=null,this.fileInput=null,this.playPauseBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.soundcloudBtn=null,this.visualizerSelect=null,this.visualSearchBar=null,this.visualizerSearchInput=null,this.visualizerSearchSummary=null,this.visualInfoSummary=null,this.visualSearchDropdown=null,this.visualizerSearchMatches=[],this.imageUploadBtn=null,this.sourcePickerBtn=null,this.playerDock=null,this.playerArtwork=null,this.playerTitleEl=null,this.playerArtistEl=null,this.playerArtistPrefixEl=null,this.playerCurrentTimeEl=null,this.playerDurationEl=null,this.playerDurationWrapper=null,this.playerDurationDivider=null,this.playerSourceIndicatorIcon=null,this.currentTrackDurationMs=null,this.playerSourceIndicatorLabel=null,this.currentSourceType=null,this.visualSelectionGrid=null,this.sourceSelectionGrid=null,this.visualSelectionSection=null,this.sourceSelectionSection=null,this.selectionHubElement=null,this.visualCardElements=new Map,this.sourceCardElements=new Map,this._searchInitialized=!1,this.onboardingCompleted=!1,this.isPlaybackActive=!1,this.visualDropdownHideTimeout=null,this._dropdownBound=!1,this.selectionHubManual=!1,this.quickStartModal=null,this.quickStartCloseBtn=null,this.quickStartStartBtn=null,this.quickStartStatusEl=null,this.demoAudioPromise=null,this.storageKeys={onboarding:"vvavyOnboardingSeen",soundCloudToken:"vvavySoundCloudToken",soundCloudHistory:"vvavySoundCloudHistory",termsAccepted:"vvavyAccepted",termsVersion:"vvavyTermsVersion"},this.onboardingStorageKey=this.storageKeys.onboarding,this.termsVersionStorageKey=this.storageKeys.termsVersion,this.isInitialized=!1,this.currentVisualizerName=null,this.soundCloudModal=null,this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="",this.soundCloudTokenStorageKey=this.storageKeys.soundCloudToken,this.soundCloudTokenSafetyWindowMs=15e3,this.soundCloudTokenCache=null,this.soundCloudRecentTracksKey=this.storageKeys.soundCloudHistory,this.soundCloudHistoryCache=null,this.soundCloudHistoryLimit=20,this.init()}getStorageItem(t,e){if(!t||!Array.isArray(e))return null;for(const i of e)if(i)try{const e=t.getItem(i);if(null!==e)return e}catch(t){}return null}setStorageItem(t,e,i){if(t&&e)try{t.setItem(e,i)}catch(t){}}getBooleanStorageValue(t,e){return"true"===this.getStorageItem(t,e)}markTermsAccepted({version:t}={}){if(this.setStorageItem(localStorage,this.storageKeys.termsAccepted,"true"),t){const e=this.termsVersionStorageKey||"vvavyTermsVersion";this.setStorageItem(localStorage,e,String(t))}this.updateVisualSearchVisibility()}hasCompletedOnboarding(){return Boolean(this.onboardingCompleted)}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);const t=1024;await this.audioManager.init(t),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(t){}this.populateAvailableVisualizers(),this.setupVisualizerSearch(),this.setupEventListeners(),this.setupDragAndDrop(),await this.checkSoundCloudAvailability(),this.setupVisibilityDetection(),this.audioManager.startAnalysis();const e=window.DEFAULT_VISUALIZER||"DebugVisualizer";if(this.availableVisualizers.has(e)){await this.loadVisualizer(e),this.visualizerSelect&&(this.visualizerSelect.value=e),this.updateVisualizerSummaryForSelection(e),this.highlightActiveVisualizer(e);const t=this.visualizerMetadataByName.get(e);t&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=t.displayName)}else if(this.availableVisualizers.size>0){const t=Array.from(this.availableVisualizers.keys())[0];await this.loadVisualizer(t),this.visualizerSelect&&(this.visualizerSelect.value=t),this.updateVisualizerSummaryForSelection(t),this.highlightActiveVisualizer(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName)}const i=this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted]);let a=!1;try{a="true"===this.getStorageItem(sessionStorage,[this.onboardingStorageKey])}catch(t){a=!1}i&&!a&&this.showGettingStartedOverlay(),a&&(this.onboardingCompleted=!0),this.isInitialized=!0,this.updateVisualSearchVisibility(),this.loadDemoAudioSilently()}catch(t){}}async checkSoundCloudAvailability(){try{const t=await fetch("/api/soundcloud/status",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Status ${t.status}`);const e=await t.json(),i=Boolean(e?.enabled),a=e?.reason||"";this.soundCloudEnabled=i,this.soundCloudAvailabilityMessage=a;const s=i?"SoundCloud streaming is ready. Search for any track to jump straight into the visuals.":a||"Start the Vvavy server to enable SoundCloud integration.";this.setSourceAvailability("soundcloud",i,s),this.soundcloudBtn&&(this.soundcloudBtn.disabled=!i,!i&&s?(this.soundcloudBtn.dataset.soundcloudReason=s,this.soundcloudBtn.setAttribute("title",s)):(delete this.soundcloudBtn.dataset.soundcloudReason,this.soundcloudBtn.removeAttribute("title")))}catch(t){this.soundCloudEnabled=!1,this.soundCloudAvailabilityMessage="Start the Vvavy server to enable SoundCloud integration.",this.setSourceAvailability("soundcloud",!1,this.soundCloudAvailabilityMessage),this.soundcloudBtn&&(this.soundcloudBtn.disabled=!0,this.soundcloudBtn.dataset.soundcloudReason=this.soundCloudAvailabilityMessage,this.soundcloudBtn.setAttribute("title",this.soundCloudAvailabilityMessage))}}getCachedSoundCloudToken(){if(this.soundCloudTokenCache?.accessToken)return this.soundCloudTokenCache;try{const t=this.getStorageItem(sessionStorage,[this.soundCloudTokenStorageKey]);if(!t)return null;const e=JSON.parse(t);if(e&&"object"==typeof e&&e.accessToken)return this.soundCloudTokenCache=e,e}catch(t){}return null}storeSoundCloudToken(t){this.soundCloudTokenCache=t;const e=JSON.stringify(t);this.setStorageItem(sessionStorage,this.soundCloudTokenStorageKey,e)}clearSoundCloudToken(){this.soundCloudTokenCache=null;try{sessionStorage.removeItem(this.soundCloudTokenStorageKey)}catch(t){}}getSoundCloudHistory(){if(!Array.isArray(this.soundCloudHistoryCache)){let t=[];try{const e=this.getStorageItem(sessionStorage,[this.soundCloudRecentTracksKey]);if(e){const i=JSON.parse(e);Array.isArray(i)&&(t=i)}}catch(t){}this.soundCloudHistoryCache=t}return Array.isArray(this.soundCloudHistoryCache)?this.soundCloudHistoryCache.slice():[]}setSoundCloudHistory(t){const e=Array.isArray(t)?t.slice(0,this.soundCloudHistoryLimit):[];this.soundCloudHistoryCache=e;const i=JSON.stringify(e);if(this.setStorageItem(sessionStorage,this.soundCloudRecentTracksKey,i),this.soundCloudModal?.renderHistory)try{this.soundCloudModal.renderHistory(this.getSoundCloudHistory())}catch(t){}}rememberSoundCloudTrack(t){if(!t||"object"!=typeof t)return;const e=null!=t.id?String(t.id):"",i=t.permalinkUrl?String(t.permalinkUrl):"";if(!e&&!i)return;const a={id:e||null,permalinkUrl:i||null,title:t.title||"Untitled track",artist:t.author?.username||null,artworkUrl:t.artworkUrl||null,duration:"number"==typeof t.duration?t.duration:null,lastPlayed:Date.now()},s=this.getSoundCloudHistory().filter(t=>{if(!t||"object"!=typeof t)return!1;const e=a.id&&t.id&&String(t.id)===a.id,i=a.permalinkUrl&&t.permalinkUrl&&t.permalinkUrl===a.permalinkUrl;return!(e||i)});s.unshift(a),this.setSoundCloudHistory(s.slice(0,this.soundCloudHistoryLimit))}async getSoundCloudToken(t=!1){if(!t){const t=this.getCachedSoundCloudToken();if(t?.accessToken&&Number.isFinite(t.expiresAt)&&Date.now()+this.soundCloudTokenSafetyWindowMs<t.expiresAt)return t.accessToken}let e;try{e=await fetch("/api/soundcloud/token",{method:"GET",credentials:"same-origin"})}catch(t){throw new Error("Failed to contact SoundCloud token endpoint.")}if(!e?.ok){let t=`Token request failed (status ${e?.status??"unknown"})`;try{const i=await e.json();i?.error&&(t=i.error)}catch(t){}throw new Error(t)}let i=null;try{i=await e.json()}catch(t){throw new Error("Failed to parse SoundCloud token response.")}if(!i?.accessToken)throw new Error("SoundCloud token response did not include an access token.");const a=Number(i.expiresIn),s=Date.now()+(Number.isFinite(a)&&a>0?1e3*a:36e5),r={accessToken:i.accessToken,expiresAt:s};return this.storeSoundCloudToken(r),r.accessToken}buildSoundCloudUrl(t,e){const i=/^https?:\/\//i.test(t)?new URL(t):new URL(t,"https://api.soundcloud.com");return e&&"object"==typeof e&&Object.entries(e).forEach(([t,e])=>{if(null==e)return;const a=Array.isArray(e)?e:[e];i.searchParams.delete(t),a.forEach(e=>{const a=null==e?"":String(e);i.searchParams.append(t,a)})}),i.toString()}async performSoundCloudFetch(t,{method:e="GET",headers:i={},query:a,body:s,expectJson:r=!0}={},n=0){const o=this.buildSoundCloudUrl(t,a),l=await this.getSoundCloudToken(n>0),u={...i,Authorization:`Bearer ${l}`};r&&!u.Accept?u.Accept="application/json":r||u.Accept||(u.Accept="*/*");const d={method:e,headers:u,credentials:"omit"};let c;null!=s&&("object"!=typeof s||s instanceof Blob||s instanceof FormData?d.body=s:(d.body=JSON.stringify(s),d.headers["Content-Type"]||(d.headers["Content-Type"]="application/json")));try{c=await fetch(o,d)}catch(t){throw new Error(`SoundCloud request failed: ${t.message||t}`)}if(401===c.status&&0===n)return this.clearSoundCloudToken(),this.performSoundCloudFetch(t,{method:e,headers:i,query:a,body:s,expectJson:r},n+1);if(!c.ok){let t="";try{t=await c.text()}catch(e){t=""}const e=t?`: ${t}`:"";throw new Error(`SoundCloud request failed (${c.status})${e}`)}if(!r)return c;const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(t){throw new Error(`Failed to parse SoundCloud response: ${t.message}`)}}async fetchSoundCloudAPI(t,e={}){return this.performSoundCloudFetch(t,e)}sanitizeSoundCloudTrackId(t){if(null==t)return"";const e=String(t).trim();if(!e)return"";if(/^soundcloud:tracks:/i.test(e)){const t=e.split(":");return t[t.length-1]}return e}pickBestSoundCloudTranscoding(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(t=>"progressive"===t?.format?.protocol);return e||(t.find(t=>"hls"===t?.format?.protocol)||t[0])}selectPreferredStreamUrl(t){if(!t||"object"!=typeof t)return null;const e=[t.http_mp3_128_url,t.http_mp3_64_url,t.http_opus_64_url,t.hls_mp3_128_url,t.hls_mp3_64_url,t.hls_opus_64_url,t.hls_url,t.progressive_mp3_url,t.preview_mp3_128_url,t.url];for(const t of e)if(t&&"string"==typeof t)return t;return null}async fetchSoundCloudStreamData(t){if(!t?.id&&!this.sanitizeSoundCloudTrackId(t))throw new Error("Unable to determine SoundCloud track ID.");const e=[];t?.stream_url&&e.push(t.stream_url);let i=null;for(const t of e)if(t)try{const e=await this.fetchSoundCloudAPI(t,{expectJson:!1});if(!e){i=new Error("SoundCloud stream endpoint returned no response.");continue}const a=e.headers;if((a?.get&&a.get("content-type")||"").includes("application/json")){let t=null;try{t=await e.json()}catch(t){i=t}const a=this.selectPreferredStreamUrl(t);if(a)return{streamUrl:a,data:t};i=new Error("SoundCloud stream response did not include a usable URL.");continue}const s=()=>{try{e.body?.cancel?.()}catch(t){}},r=a?.get?a.get("location"):null;if(r)return s(),{streamUrl:r,data:null};if(e.url)return s(),{streamUrl:e.url,data:null};i=new Error("SoundCloud stream endpoint returned an unexpected response.")}catch(t){i=t}if(i)throw i;throw new Error("SoundCloud stream URL is unavailable.")}async fetchSoundCloudTrackById(t){const e=this.sanitizeSoundCloudTrackId(t);if(!e)throw new Error("Track ID is required.");const i=await this.fetchSoundCloudAPI("/tracks",{query:{ids:e}}),a=Array.isArray(i)?i:[];if(!a.length)throw new Error("Track not found on SoundCloud.");return a[0]}async fetchSoundCloudTranscodingUrl(t){if(!t)throw new Error("Transcoding URL is required.");return this.performSoundCloudFetch(t,{expectJson:!0})}openSoundCloudModal(){const t=this.ensureSoundCloudModal();t.form?.reset();const e=this.getSoundCloudHistory();if(t.setLoading?.(!1),t.sortedResults=[],t.nextHref=null,t.totalAvailable=0,t.currentPage=1,t.fetchingMorePromise=null,t.searchQuery="","function"==typeof t.renderResults&&t.renderResults([]),"function"==typeof t.updatePaginationControls&&t.updatePaginationControls(),"function"==typeof t.renderHistory)try{t.renderHistory(e)}catch(t){}t.hasSearched=!1,t.searchInProgress=!1,t.input&&(t.input.disabled=!1),t.cancel&&(t.cancel.disabled=!1),t.overlay.classList.add("active"),setTimeout(()=>{t.input?.focus()},60)}ensureSoundCloudModal(){if(this.soundCloudModal)return this.soundCloudModal;const t=document.createElement("div");t.className="soundcloud-overlay",t.innerHTML='\n            <div class="soundcloud-modal" role="dialog" aria-modal="true">\n                <div class="soundcloud-modal-content">\n                    <form class="soundcloud-modal-form">\n                        <label class="soundcloud-modal-label" for="soundcloudSearchInput">Search SoundCloud</label>\n                        <div class="soundcloud-modal-search-row">\n                            <input type="text" id="soundcloudSearchInput" class="soundcloud-modal-input" name="soundcloudSearch" placeholder="Search for artists, tracks, or genres" autocomplete="off" />\n                            <button type="submit" class="soundcloud-modal-search">Search</button>\n                        </div>\n                    </form>\n                    <div class="soundcloud-modal-body">\n                        <section class="soundcloud-modal-main" aria-label="SoundCloud search results">\n                            <div class="soundcloud-history-header">\n                                <h3>Search Results</h3>\n                            </div>\n                            <div class="soundcloud-modal-status" aria-live="polite"></div>\n                            <div class="soundcloud-modal-results" role="listbox" aria-label="SoundCloud search results"></div>\n                            <div class="soundcloud-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn prev" aria-label="Previous page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn next" aria-label="Next page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                        <section id="soundcloud-modal-history" class="soundcloud-modal-main" aria-label="Recently played SoundCloud tracks">\n                            <div class="soundcloud-history-header">\n                                <h3>Recently Played</h3>\n                            </div>\n                            <div id="soundcloud-history-list" class="soundcloud-modal-results"></div>\n                            <div class="soundcloud-pagination soundcloud-history-pagination" aria-live="polite">\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn prev" aria-label="Previous history page" disabled>&lsaquo;</button>\n                                <div class="soundcloud-page-info soundcloud-history-page-info">Page 1</div>\n                                <button type="button" class="soundcloud-page-btn soundcloud-history-page-btn next" aria-label="Next history page" disabled>&rsaquo;</button>\n                            </div>\n                        </section>\n                    </div>\n                </div>\n                <div class="modal-footer soundcloud-modal-footer">\n                    <button type="button" class="soundcloud-modal-cancel">Close</button>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const e=t.querySelector(".soundcloud-modal-main"),i=t.querySelector("#soundcloud-modal-history"),a={overlay:t,form:t.querySelector(".soundcloud-modal-form"),input:t.querySelector("#soundcloudSearchInput"),cancel:t.querySelector(".soundcloud-modal-cancel"),closeBtn:t.querySelector(".soundcloud-modal-close"),status:t.querySelector(".soundcloud-modal-status"),searchBtn:t.querySelector(".soundcloud-modal-search"),results:t.querySelector(".soundcloud-modal-results"),historySection:i,historyList:i?.querySelector("#soundcloud-history-list")||null,pagination:e?.querySelector(".soundcloud-pagination")||null,paginationPrev:e?.querySelector(".soundcloud-page-btn.prev")||null,paginationNext:e?.querySelector(".soundcloud-page-btn.next")||null,paginationInfo:e?.querySelector(".soundcloud-page-info")||null,historyPagination:i?.querySelector(".soundcloud-history-pagination")||null,historyPaginationPrev:i?.querySelector(".soundcloud-history-page-btn.prev")||null,historyPaginationNext:i?.querySelector(".soundcloud-history-page-btn.next")||null,historyPaginationInfo:i?.querySelector(".soundcloud-history-page-info")||null,currentResults:[],hasSearched:!1,searchInProgress:!1,sortedResults:[],pageSize:10,currentPage:1,nextHref:null,totalAvailable:0,fetchingMorePromise:null,searchQuery:"",historyEntries:[],historyPageSize:10,historyCurrentPage:1},s=(t,e=!1)=>{a.status&&(a.status.textContent=t||"",a.status.classList.toggle("error",Boolean(t&&e)))},r=t=>{a.cancel&&(a.cancel.disabled=t),a.input&&(a.input.disabled=t),a.searchBtn&&(a.searchBtn.disabled=t)},n=t=>{const e=Math.max(0,Math.floor((Number(t)||0)/1e3));return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`},o=(()=>{try{return new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1})}catch(t){return null}})(),l=t=>{if(!t)return{tracks:[],nextHref:null,total:0};if(Array.isArray(t))return{tracks:t,nextHref:null,total:t.length};const e=Array.isArray(t.collection)?t.collection:null,i=Array.isArray(t.tracks)?t.tracks:null,a=t.next_href||t.nextHref||null,s=[t.total_results,t.total,t.collection_size,Array.isArray(e)?e.length:null,Array.isArray(i)?i.length:null].find(t=>"number"==typeof t&&t>=0);return e?{tracks:e,nextHref:a,total:"number"==typeof s?s:e.length}:i?{tracks:i,nextHref:a,total:"number"==typeof s?s:i.length}:{tracks:[],nextHref:a,total:"number"==typeof s?s:0}},u=()=>{if(!a.pagination)return;const t=a.sortedResults.length>0;if(a.pagination.style.display=t?"flex":"none",!t)return a.paginationInfo&&(a.paginationInfo.textContent="Page 1"),a.paginationPrev&&(a.paginationPrev.disabled=!0),void(a.paginationNext&&(a.paginationNext.disabled=!0));const e=Math.max(a.sortedResults.length,a.totalAvailable||0),i=Math.max(1,Math.ceil(e/a.pageSize));if(a.currentPage=Math.min(Math.max(a.currentPage,1),i),a.paginationPrev&&(a.paginationPrev.disabled=a.currentPage<=1),a.paginationNext){const t=Math.ceil(a.sortedResults.length/a.pageSize),e=a.currentPage>=t;a.paginationNext.disabled=e&&!a.nextHref||0===a.sortedResults.length}if(a.paginationInfo)if(a.sortedResults.length){const t=(a.currentPage-1)*a.pageSize+1,e=Math.min(a.currentPage*a.pageSize,a.sortedResults.length),i=Math.max(a.sortedResults.length,a.totalAvailable||0),s=a.nextHref&&i<=a.sortedResults.length?`${a.sortedResults.length}+`:i;a.paginationInfo.textContent=`Page ${a.currentPage} • ${t}-${e} of ${s}`}else a.paginationInfo.textContent="Page 1"},d=()=>{if(!a.sortedResults.length)return p([]),void u();s("");const t=Math.max(1,Math.ceil(a.sortedResults.length/a.pageSize));a.currentPage>t&&(a.currentPage=t);const e=(a.currentPage-1)*a.pageSize,i=e+a.pageSize,r=a.sortedResults.slice(e,i);p(r),u()},c=(t=[],{append:e=!1,nextHref:i=null,total:s=null}={})=>{const r=Array.isArray(t)?t:[],n=e?a.sortedResults.concat(r):r;a.sortedResults=((t=[])=>t.filter(t=>t&&"object"==typeof t).slice().sort((t,e)=>{const i=Number(t?.playback_count)||0,a=Number(e?.playback_count)||0;return i===a?0:a-i}))(((t=[])=>{const e=new Set,i=[];return t.forEach(t=>{if(!t||"object"!=typeof t)return;const a=null!=t.id?`id:${t.id}`:null,s=t.permalink_url||t.permalinkUrl||"",r=a||(s?`url:${s}`:null);r&&e.has(r)||(r&&e.add(r),i.push(t))}),i})(n)),e||(a.currentPage=1),a.totalAvailable="number"==typeof s&&s>=0?Math.max(s,a.sortedResults.length):e?Math.max(a.totalAvailable||0,a.sortedResults.length):a.sortedResults.length,a.nextHref=i||null,d()},h=async()=>{if(!a.nextHref)return!1;if(a.fetchingMorePromise)return await a.fetchingMorePromise,!0;const t=a.status?.textContent||"";return a.fetchingMorePromise=(async()=>{r(!0),s("Loading more SoundCloud tracks...");try{const t=await this.fetchSoundCloudAPI(a.nextHref,{query:{linked_partitioning:"1"}}),{tracks:e,nextHref:i,total:r}=l(t);c(e,{append:!0,nextHref:i,total:r}),a.sortedResults.length?s(""):s("No additional tracks found.")}catch(t){s(t?.message||"Failed to load more SoundCloud tracks.",!0),a.nextHref=null}finally{!a.sortedResults.length&&t&&s(t),r(!1),a.fetchingMorePromise=null}})(),await a.fetchingMorePromise,a.sortedResults.length>0},p=(t=[])=>{if(a.currentResults=Array.isArray(t)?t:[],!a.results)return;if(a.results.innerHTML="",a.results.scrollTop=0,!a.currentResults.length){if(a.hasSearched&&!a.searchInProgress){const t=document.createElement("div");t.className="soundcloud-results-empty",t.textContent="No tracks found. Try another search term.",a.results.appendChild(t)}return}const e=document.createElement("div");e.className="soundcloud-results-list",a.currentResults.forEach(t=>{if(!t||"object"!=typeof t)return;const i=document.createElement("button");i.type="button",i.className="soundcloud-search-item",i.dataset.trackId=null!=t.id?String(t.id):"",i.dataset.trackPermalink=t.permalink_url||t.permalinkUrl||"",i.dataset.trackTitle=t.title||"",i.setAttribute("role","option"),i.setAttribute("aria-selected","false");const a=document.createElement("div");a.className="soundcloud-search-item-text";const s=document.createElement("div");s.className="soundcloud-search-title",s.textContent=t.title||"Untitled track";const r=document.createElement("div");r.className="soundcloud-search-meta";const l=[];t.user?.username&&l.push(t.user.username),t.duration&&l.push(n(t.duration));const u=(t=>{const e=Number(t);if(!Number.isFinite(e)||e<0)return null;if(o)return o.format(e);try{return e.toLocaleString()}catch(t){return String(e)}})(t.playback_count);u&&l.push(`${u} plays`),r.textContent=l.join(" • "),a.appendChild(s),a.appendChild(r);const d=document.createElement("span");d.className="soundcloud-search-play",d.textContent="▶",i.appendChild(a),i.appendChild(d),i.dataset.trackId||i.dataset.trackPermalink||(i.disabled=!0),e.appendChild(i)}),a.results.appendChild(e)},m=()=>{if(!a.historyPagination)return;const t=a.historyEntries.length,e=t>0;if(a.historyPagination.style.display=e?"flex":"none",!e)return a.historyPaginationInfo&&(a.historyPaginationInfo.textContent="Page 1"),a.historyPaginationPrev&&(a.historyPaginationPrev.disabled=!0),void(a.historyPaginationNext&&(a.historyPaginationNext.disabled=!0));const i=Math.max(1,Math.ceil(t/a.historyPageSize));if(a.historyCurrentPage=Math.min(Math.max(a.historyCurrentPage,1),i),a.historyPaginationPrev&&(a.historyPaginationPrev.disabled=a.historyCurrentPage<=1),a.historyPaginationNext&&(a.historyPaginationNext.disabled=a.historyCurrentPage>=i),a.historyPaginationInfo){const e=(a.historyCurrentPage-1)*a.historyPageSize+1,i=Math.min(a.historyCurrentPage*a.historyPageSize,t);a.historyPaginationInfo.textContent=`Page ${a.historyCurrentPage} • ${e}-${i} of ${t}`}},y=()=>{if(!a.historyList)return;a.historyList.innerHTML="";const t=a.historyEntries;if(!t.length){a.historySection&&a.historySection.classList.add("soundcloud-history-empty");const t=document.createElement("div");return t.className="soundcloud-history-empty",t.textContent="Play SoundCloud tracks to build your recent history.",a.historyList.appendChild(t),void m()}a.historySection&&a.historySection.classList.remove("soundcloud-history-empty");const e=Math.max(1,Math.ceil(t.length/a.historyPageSize));a.historyCurrentPage=Math.min(Math.max(a.historyCurrentPage,1),e);const i=(a.historyCurrentPage-1)*a.historyPageSize,s=i+a.historyPageSize,r=t.slice(i,s),o=document.createElement("div");o.className="soundcloud-history-items",r.forEach(t=>{if(!t||"object"!=typeof t)return;const e=document.createElement("button");e.type="button",e.className="soundcloud-history-item soundcloud-search-item",e.dataset.trackId=null!=t.id?String(t.id):"",e.dataset.trackPermalink=t.permalinkUrl||"",e.dataset.trackTitle=t.title||"",e.setAttribute("role","option"),e.setAttribute("aria-selected","false");const i=document.createElement("div");i.className="soundcloud-search-item-text";const a=document.createElement("div");a.className="soundcloud-search-title",a.textContent=t.title||"Untitled track";const s=document.createElement("div");s.className="soundcloud-search-meta";const r=[];t.artist&&r.push(t.artist),t.duration&&r.push(n(t.duration)),r.push("Recently played"),s.textContent=r.join(" • "),i.appendChild(a),i.appendChild(s),e.appendChild(i),o.appendChild(e)}),a.historyList.appendChild(o),m()},g=(t=this.getSoundCloudHistory(),{preservePage:e=!1}={})=>{const i=Array.isArray(t)?t.filter(t=>t&&"object"==typeof t).sort((t,e)=>(Number(e.lastPlayed)||0)-(Number(t.lastPlayed)||0)):[];i.length>this.soundCloudHistoryLimit&&(i.length=this.soundCloudHistoryLimit),a.historyEntries=i;const s=Math.max(1,Math.ceil(i.length/a.historyPageSize));a.historyCurrentPage=e?Math.min(Math.max(a.historyCurrentPage,1),s):1,y(),!e&&a.historyList&&(a.historyList.scrollTop=0)},S=()=>{t.classList.remove("active"),a.form&&a.form.reset(),s(""),r(!1),a.hasSearched=!1,a.searchInProgress=!1,a.sortedResults=[],a.nextHref=null,a.totalAvailable=0,a.currentPage=1,a.fetchingMorePromise=null,a.searchQuery="",p([]),u(),g(this.getSoundCloudHistory())};a.close=S,a.setStatus=s,a.setLoading=r,a.renderResults=p,a.renderHistory=g,a.updatePaginationControls=u,a.paginationPrev?.addEventListener("click",t=>{t.preventDefault(),a.searchInProgress||a.currentPage<=1||(a.currentPage=Math.max(1,a.currentPage-1),d(),a.results?.scrollTo({top:0,behavior:"smooth"}))}),a.paginationNext?.addEventListener("click",async t=>{if(t.preventDefault(),a.searchInProgress)return;const e=a.currentPage+1,i=(e-1)*a.pageSize+1;a.sortedResults.length<i&&a.nextHref&&(a.paginationNext.disabled=!0,await h()),e<=Math.max(1,Math.ceil(a.sortedResults.length/a.pageSize))&&(a.currentPage=e),d(),a.results?.scrollTo({top:0,behavior:"smooth"})}),a.historyPaginationPrev?.addEventListener("click",t=>{t.preventDefault(),a.historyCurrentPage<=1||(a.historyCurrentPage=Math.max(1,a.historyCurrentPage-1),y(),a.historyList?.scrollTo({top:0,behavior:"smooth"}))}),a.historyPaginationNext?.addEventListener("click",t=>{t.preventDefault();const e=Math.max(1,Math.ceil(a.historyEntries.length/a.historyPageSize));a.historyCurrentPage>=e||(a.historyCurrentPage=Math.min(e,a.historyCurrentPage+1),y(),a.historyList?.scrollTo({top:0,behavior:"smooth"}))});const v=async()=>{const t=a.input?.value?.trim();if(!t)return s("Enter a search term to continue.",!0),!1;if(t.length<3)return s("Search term must be at least 3 characters.",!0),!1;a.hasSearched=!0,a.searchInProgress=!0,a.searchQuery=t,a.sortedResults=[],a.currentPage=1,a.nextHref=null,a.totalAvailable=0,p([]),u(),s("Searching SoundCloud..."),r(!0);try{const e=Math.min(5*a.pageSize,50),i=await this.fetchSoundCloudAPI("/tracks",{query:{q:t,limit:String(e),linked_partitioning:"1"}}),{tracks:r,nextHref:n,total:o}=l(i);return c(r,{append:!1,nextHref:n,total:o}),a.sortedResults.length||n?(s(""),a.sortedResults.length>0||Boolean(n)):(s("No tracks found. Try another search.",!0),!1)}catch(t){return s(t?.message||"Failed to search SoundCloud.",!0),a.sortedResults=[],a.nextHref=null,p([]),u(),!1}finally{a.searchInProgress=!1,r(!1),d()}};a.closeBtn?.addEventListener("click",S),a.cancel?.addEventListener("click",t=>{t.preventDefault(),S()}),t.addEventListener("click",e=>{e.target===t&&S()}),a.searchBtn?.addEventListener("click",async t=>{t.preventDefault(),await v()});const f=async t=>{if(!t)return;const e=t.dataset.trackId,i=t.dataset.trackPermalink||e;if(!i)return void s("Unable to load this track.",!0);const a=t.dataset.trackTitle||"SoundCloud track";s(`Loading "${a}"...`),r(!0);try{const t=await this.resolveSoundCloudTrack(i);S(),await this.loadSoundCloudTrack(t,{pauseBeforeLoad:!0,autoPlay:!0})}catch(t){s(t?.message||"Failed to load SoundCloud track.",!0),r(!1)}};return a.results?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-search-item");t.preventDefault(),await f(e)}),a.historyList?.addEventListener("click",async t=>{const e=t.target.closest(".soundcloud-history-item");e&&(t.preventDefault(),await f(e))}),a.form?.addEventListener("submit",async t=>{t.preventDefault(),await v()}),g(this.getSoundCloudHistory()),u(),this.soundCloudModal=a,a}async resolveSoundCloudTrack(t){const e=(t||"").trim();if(!e)throw new Error("Please provide a SoundCloud track reference.");let i=null,a=null;const s=this.sanitizeSoundCloudTrackId(e);if(/^[0-9]+$/.test(s)&&s)a=s,i=await this.fetchSoundCloudTrackById(a);else{let t;try{t=await this.fetchSoundCloudAPI("/resolve",{query:{url:e}})}catch(t){throw new Error(t?.message||"Failed to resolve SoundCloud track.")}if(!t)throw new Error("SoundCloud resolve returned no data.");if("track"===t.kind)i=t,a=this.sanitizeSoundCloudTrackId(t.id);else{if(!t.location)throw new Error(`Resolved resource is not a track (${t.kind||"unknown"}).`);try{const e=new URL(t.location,"https://api.soundcloud.com").pathname.split("/").filter(Boolean);if(a=this.sanitizeSoundCloudTrackId(e[e.length-1]),!a)throw new Error("Unable to determine track ID from SoundCloud resolve response.");i=await this.fetchSoundCloudTrackById(a)}catch(t){throw new Error(t?.message||"Failed to follow SoundCloud resolve redirect.")}}if(!i?.media){const t=i?.id||a;if(!t)throw new Error("Unable to determine SoundCloud track ID.");i=await this.fetchSoundCloudTrackById(t)}}if(!i)throw new Error("Failed to load SoundCloud track data.");if(!1===i.streamable)throw new Error("This SoundCloud track does not permit streaming via the API.");if("string"==typeof i.policy&&"block"===i.policy.toLowerCase())throw new Error("SoundCloud has blocked API streaming for this track.");let r=null,n=null,o=null;try{const t=await this.fetchSoundCloudStreamData(i);r=t?.streamUrl||null,n=t?.data||null}catch(t){}if(!r){const t=i.media?.transcodings||[],e=this.pickBestSoundCloudTranscoding(t);if(!e?.url)throw new Error("Track has no available streamable formats.");let a;try{a=await this.fetchSoundCloudTranscodingUrl(e.url)}catch(t){throw new Error(t?.message||"Failed to obtain SoundCloud stream URL.")}const s=this.selectPreferredStreamUrl(a)||a?.url||null;if(!s)throw new Error("SoundCloud did not return a usable stream URL for this track.");r=s,n=a||null,o=e}return{id:i.id,title:i.title,duration:i.duration,permalinkUrl:i.permalink_url||i.permalinkUrl||null,artworkUrl:i.artwork_url||i.user?.avatar_url||null,author:i.user?{id:i.user.id,username:i.user.username,permalink:i.user.permalink_url||null,avatarUrl:i.user.avatar_url||null}:null,streamUrl:r,streamMetadata:n,waveformUrl:i.waveform_url||null,media:{format:o?.format||null,preset:o?.preset||null,quality:o?.quality||null,protocol:o?.format?.protocol||o?.protocol||n?.protocol||null,streamType:n?.stream_type||null}}}async pausePlayback({stopVisualizer:t=!0,includeMic:e=!1}={}){try{this.audioManager&&(this.audioManager.isPlaying&&this.audioManager.pause(),e&&this.audioManager.isMicActive&&(await this.audioManager.stopMicrophone(),this.hideNowPlaying()))}catch(t){}finally{t&&this.currentVisualizer?.isAnimating&&!this.audioManager?.isPlaying&&!this.audioManager?.isMicActive&&this.currentVisualizer.stop(),this.updateControlButtons(!1,this.audioManager?.isMicActive)}}async loadSoundCloudTrack(t,{pauseBeforeLoad:e=!0,autoPlay:i=!1}={}){if(!t?.streamUrl)throw new Error("SoundCloud stream is unavailable for this track.");const a=this.showLoadingMessage("Loading SoundCloud track...");try{e?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),await this.audioManager.loadStreamFromUrl(t.streamUrl),this.rememberSoundCloudTrack(t),this.hideLoadingMessage(a),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint();const s=t.author?.username||"SoundCloud",r="string"==typeof t.permalinkUrl?t.permalinkUrl:t.permalink_url,n=t.author?.permalink,o=t.artworkUrl||t.artwork_url||t.author?.avatarUrl||null,l=t.author?.avatarUrl||null,u="string"==typeof r&&/^https?:\/\//i.test(r),d="string"==typeof n&&/^https?:\/\//i.test(n);!t.artworkUrl&&o&&(t.artworkUrl=o),l&&t.author&&!t.author.avatarUrl&&(t.author.avatarUrl=l),this.updateNowPlaying(t.title||"Unknown Track",s,{source:"soundcloud",isSoundCloud:!0,trackUrl:u?r:null,artistUrl:d?n:null,trackLinkLabel:u?"Listen on SoundCloud":"Creator on SoundCloud",artworkUrl:o,artistImageUrl:l,duration:t.duration}),this.updateControlButtons(!1,!1),(i||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150)}catch(t){throw this.hideLoadingMessage(a),t}}async loadDemoAudioSilently(){if(this.demoAudioPromise)return this.demoAudioPromise;const t="./demo/spatial-soundscapes.mp3";this.demoAudioPromise=(async()=>{const e=await fetch(t,{method:"HEAD"});if(!e.ok)throw new Error(`Demo audio not found (status ${e.status})`);const i=await fetch(t);if(!i.ok)throw new Error(`Failed to fetch demo audio (status ${i.status})`);const a=await i.blob(),s=new File([a],"spatial-soundscapes.mp3",{type:"audio/mpeg"});return this.demoAudioFile=s,this.updateControlButtons(!1,!1),this.playPauseBtn&&(this.playPauseBtn.disabled=!1),s})().catch(t=>{throw this.demoAudioFile=null,t});try{return await this.demoAudioPromise}catch(t){return this.demoAudioPromise=null,null}}initializeDOMElements(){this.quickStartModal=document.getElementById("quickStartModal"),this.quickStartCloseBtn=document.getElementById("quickStartCloseBtn"),this.quickStartStartBtn=document.getElementById("quickStartStartBtn"),this.quickStartStatusEl=document.getElementById("quickStartStatus"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.soundcloudBtn=document.getElementById("soundcloudBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.visualSearchBar=document.getElementById("visualSearchBar"),this.visualizerSearchInput=document.getElementById("visualizerSearch"),this.visualizerSearchSummary=document.getElementById("visualizerSearchSummary"),this.visualInfoSummary=document.getElementById("visualInfoSummary"),this.visualSearchDropdown=document.getElementById("visualSearchDropdown"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.playerDock=document.getElementById("playerDock"),this.playerArtwork=document.getElementById("playerArtwork"),this.playerTitleEl=document.getElementById("playerTitle"),this.playerArtistEl=document.getElementById("playerArtist"),this.playerArtistPrefixEl=document.querySelector(".player-artist-prefix"),this.playerCurrentTimeEl=document.getElementById("playerCurrentTime"),this.playerDurationEl=document.getElementById("playerDuration"),this.playerDurationWrapper=document.getElementById("playerDurationWrapper"),this.playerDurationDivider=document.getElementById("playerDurationDivider"),this.playerSourceIndicatorIcon=document.getElementById("playerSourceIndicatorIcon"),this.playerSourceIndicatorLabel=document.getElementById("playerSourceIndicatorLabel"),this.sourcePickerBtn=document.getElementById("sourcePickerBtn"),this.visualSelectionGrid=document.getElementById("visualSelectionGrid"),this.sourceSelectionGrid=document.getElementById("sourceSelectionGrid"),this.visualSelectionSection=document.getElementById("visualSelectionSection"),this.sourceSelectionSection=document.getElementById("sourceSelectionSection"),this.selectionHubElement=document.getElementById("selectionHub"),this.visualizerSelect&&(this.visualizerSelect.classList.add("offscreen"),this.visualizerSelect.setAttribute("aria-hidden","true"),this.visualizerSelect.setAttribute("tabindex","-1")),this.canvas=null,this.playPauseBtn&&this.playPauseBtn.classList.add("initial-pulse"),this.quickStartStartBtn&&this.quickStartStartBtn.addEventListener("click",()=>this.handleQuickStartStart()),this.quickStartCloseBtn&&this.quickStartCloseBtn.addEventListener("click",()=>this.hideQuickStartModal()),this.quickStartModal&&(this.quickStartModal.setAttribute("aria-hidden","true"),this.quickStartModal.addEventListener("click",t=>{t.target===this.quickStartModal&&this.hideQuickStartModal(!1)})),this.bindSelectionHandlers(),this.sourcePickerBtn&&this.sourcePickerBtn.addEventListener("click",()=>{this.focusSelectionSection("source",{exclusive:!0})}),this.updateVisualSearchVisibility(),this.setVisualSearchDimmed(!1),this.hideNowPlaying(),this.updateSelectionHubVisibility()}async loadVisualizer(t){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const e=this.availableVisualizers.get(t);if(!e)throw new Error(`Visualizer not found: ${t}`);if(this.currentVisualizer=new e.class(null,{}),this.currentVisualizerName=t,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(t){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(t=>{this.currentVisualizer?.update&&this.currentVisualizer.update(t),this.updatePlayerTimeline(t)}),this.audioManager.setPlayStateChangeCallback((t,e)=>{this.currentVisualizer&&(!t&&!e||this.currentVisualizer.isAnimating?t||e||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(t,e);const i=Boolean(t||e),a=this.isPlaybackActive;this.isPlaybackActive=i,e?this.setActiveSource("mic"):t||this.audioManager?.audioElement||this.setActiveSource(null),this.setVisualSearchDimmed(i),i&&(this.onboardingCompleted=!0,this.hideGettingStartedOverlay()),a!==this.isPlaybackActive&&this.refreshVisualSearchSummary(),this.updateSelectionHubVisibility()})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(this.playPauseBtn.classList.remove("initial-pulse"),this.demoAudioFile&&!this.audioManager.audioElement)try{return await this.loadAudioFile(this.demoAudioFile),void(this.demoAudioFile=null)}catch(t){}if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(t){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.micBtn?.addEventListener("click",async()=>{await this.handleMicrophoneSelection()}),this.fileSelectBtn?.addEventListener("click",async()=>{await this.handleFileSelection()}),this.soundcloudBtn?.addEventListener("click",async()=>{await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.showSoundCloudOrAlert(this.soundcloudBtn)}),this.fileInput?.addEventListener("change",t=>{const e=t.target.files[0];e?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(e.name)?this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",async t=>{const e=t.target.value;if(e&&e!==this.currentVisualizerName)try{await this.switchVisualizer(e)}catch(t){}}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.hideOnboardingOverlay()})}setupDragAndDrop(){["dragenter","dragover"].forEach(t=>{document.addEventListener(t,t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),this.hideGettingStartedOverlay(),Array.from(t.dataTransfer?.types||[]).includes("Files")&&this.showOnboardingOverlay()})}),document.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),0===t.clientX&&0===t.clientY&&this.hideOnboardingOverlay()}),document.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.hideOnboardingOverlay(),this.hideGettingStartedOverlay();const e=Array.from(t.dataTransfer?.files||[]).find(t=>t.type.startsWith("audio/"));e&&(this.pausePlayback({stopVisualizer:!0,includeMic:!0}).catch(()=>{}),this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}))})}setupVisibilityDetection(){this.wasPlayingBeforeHidden=!1,this.wasVisualizerAnimating=!1,document.addEventListener("visibilitychange",()=>{document.hidden?(this.wasPlayingBeforeHidden=this.audioManager?.isPlaying||!1,this.wasVisualizerAnimating=this.currentVisualizer?.isAnimating||!1,this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()):(this.wasPlayingBeforeHidden&&this.audioManager&&setTimeout(()=>{this.audioManager.play()},100),(this.wasVisualizerAnimating&&this.currentVisualizer||this.currentVisualizer&&!this.currentVisualizer.isAnimating)&&this.currentVisualizer.start())}),window.addEventListener("pagehide",()=>{this.audioManager?.isPlaying&&this.audioManager.pause(),this.currentVisualizer?.isAnimating&&this.currentVisualizer.stop()}),window.addEventListener("pageshow",()=>{this.currentVisualizer&&!this.currentVisualizer.isAnimating&&this.currentVisualizer.start()})}populateAvailableVisualizers(){this.availableVisualizers.clear(),this.visualizerMetadataByName=new Map,this.visualizerManifest=[];const t="undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)?window.VISUALIZERS_MANIFEST:null;t&&t.forEach(t=>{const e=t.name,i=window[e];if("function"!=typeof i)return;const a={name:e,displayName:t.displayName||e.replace(/Visualizer$/,""),file:t.file,description:"string"==typeof t.description?t.description:"",tags:Array.isArray(t.tags)?t.tags:[]};this.visualizerMetadataByName.set(e,a),this.visualizerManifest.push(a),this.availableVisualizers.set(e,{...a,class:i})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(t=>{const e=t.value,i=window[e];if("function"!=typeof i)return;const a=this.visualizerMetadataByName.get(e);if(a)return void this.availableVisualizers.set(e,{...a,class:i});const s=t.dataset?.tags||"",r=s?s.split(",").map(t=>t.trim()).filter(Boolean):[],n={name:e,displayName:t.textContent||e.replace(/Visualizer$/,""),file:null,description:t.dataset?.description||"",tags:r};this.visualizerMetadataByName.set(e,n),this.visualizerManifest.push(n),this.availableVisualizers.set(e,{...n,class:i})}),this.renderVisualSelectionCards()}bindSelectionHandlers(){this.sourceSelectionGrid&&(this.sourceCardElements=new Map,this.sourceSelectionGrid.querySelectorAll("[data-source-card]").forEach(t=>{const e=t.dataset.sourceCard;e&&(this.sourceCardElements.set(e,t),t.setAttribute("role","button"),t.setAttribute("tabindex","0"))}),this.sourceSelectionGrid.addEventListener("click",t=>{const e=t.target.closest("[data-source-card]");if(!e||e.classList.contains("selection-card--disabled"))return;const i=e.dataset.sourceCard;i&&(t.preventDefault(),this.handleSourceSelection(i))}),this.sourceSelectionGrid.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const e=t.target.closest("[data-source-card]");if(!e||e.classList.contains("selection-card--disabled"))return;const i=e.dataset.sourceCard;i&&(t.preventDefault(),this.handleSourceSelection(i))})),this.visualSelectionGrid&&(this.visualSelectionGrid.addEventListener("click",t=>{const e=t.target.closest("[data-visual-card]");if(!e)return;const i=e.dataset.visualCard;i&&i!==this.currentVisualizerName&&(t.preventDefault(),this.switchVisualizer(i))}),this.visualSelectionGrid.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const e=t.target.closest("[data-visual-card]");if(!e)return;const i=e.dataset.visualCard;i&&i!==this.currentVisualizerName&&(t.preventDefault(),this.switchVisualizer(i))}))}renderVisualSelectionCards(){if(!this.visualSelectionGrid)return;this.visualSelectionGrid.innerHTML="",this.visualCardElements=new Map;const t=this.visualizerManifest||[],e=document.createDocumentFragment();t.forEach(t=>{const i=document.createElement("button");i.type="button",i.className="selection-card",i.dataset.visualCard=t.name,i.setAttribute("role","button"),i.setAttribute("tabindex","0");const a=t.description||"Abstract visual experience",s=Array.isArray(t.tags)?t.tags.slice(0,4):[];i.innerHTML=`\n                <div class="selection-card__header">\n                    <span class="selection-card__icon">✨</span>\n                    <h3 class="selection-card__title">${t.displayName}</h3>\n                </div>\n                <p class="selection-card__description">${a}</p>\n                ${s.length?`<div class="selection-card__meta">${s.map(t=>`<span class="selection-card__tag">${t}</span>`).join("")}</div>`:""}\n            `,e.appendChild(i),this.visualCardElements.set(t.name,i)}),this.visualSelectionGrid.appendChild(e),this.highlightActiveVisualizer(this.currentVisualizerName)}highlightActiveVisualizer(t){this.visualCardElements.forEach((e,i)=>{const a=i===t;e.classList.toggle("selection-card--active",a),e.setAttribute("aria-pressed",a?"true":"false")}),this.updateSelectionHubVisibility()}focusSelectionSection(t,{exclusive:e=!1}={}){let i=null;"source"===t?i=this.sourceSelectionSection:"visual"===t&&(i=this.visualSelectionSection);const a=!this.selectionHubElement?.classList.contains("hidden");if("source"===t&&this.selectionHubManual&&a)return this.selectionHubManual=!1,void this.updateSelectionHubVisibility();if(e?("source"===t?this.visualSelectionSection?.classList.add("selection-section--hidden"):"visual"===t&&this.sourceSelectionSection?.classList.add("selection-section--hidden"),"source"===t&&this.sourceSelectionSection?.classList.remove("selection-section--hidden"),"visual"===t&&this.visualSelectionSection?.classList.remove("selection-section--hidden")):(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden")),this.selectionHubElement&&(this.selectionHubManual=!0,this.selectionHubElement.classList.remove("hidden")),!i)return;const s=e;try{i.scrollIntoView({behavior:"smooth",block:s?"nearest":"center"})}catch(t){i.scrollIntoView({behavior:"smooth"})}i.classList.add("selection-section--pulse"),setTimeout(()=>i.classList.remove("selection-section--pulse"),1200),this.updateSelectionHubVisibility()}updateSelectionHubVisibility(){if(!this.selectionHubElement)return;const t=Boolean(this.currentVisualizerName),e=Boolean(this.currentSourceType)||Boolean(this.audioManager?.audioElement)||Boolean(this.audioManager?.isMicActive),i=!this.selectionHubManual&&t&&e;this.selectionHubManual||(this.visualSelectionSection?.classList.remove("selection-section--hidden"),this.sourceSelectionSection?.classList.remove("selection-section--hidden")),this.selectionHubElement.classList.toggle("hidden",i)}renderVisualSearchDropdown(t=[],e=""){if(!this.visualSearchDropdown)return;const i=this.visualSearchDropdown;i.innerHTML="";const a=(e||"").trim(),s=t.slice(0,14);if(!s.length){if(!a)return void i.classList.add("hidden");const t=document.createElement("div");return t.className="visual-search-item visual-search-item--empty",t.textContent="No visuals match that search.",i.appendChild(t),void i.classList.remove("hidden")}const r=document.createDocumentFragment();s.forEach(t=>{const e=document.createElement("button");e.type="button",e.className="visual-search-item",e.dataset.visualName=t.name,e.dataset.displayName=t.displayName;const i=Array.isArray(t.tags)?t.tags.slice(0,3):[],a=t.description?`<div class="visual-search-item__description">${t.description}</div>`:"",s=i.length?`<div class="visual-search-item__tags">${i.map(t=>`<span>${t}</span>`).join("")}</div>`:"";e.innerHTML=`\n                <div class="visual-search-item__title">${t.displayName}</div>\n                ${a}\n                ${s}\n            `,r.appendChild(e)}),i.appendChild(r),i.classList.remove("hidden")}showVisualSearchDropdown(){this.visualSearchDropdown&&0!==this.visualSearchDropdown.childElementCount&&(this.visualSearchDropdown.classList.remove("hidden"),this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout))}hideVisualSearchDropdown({immediate:t=!1}={}){if(!this.visualSearchDropdown)return;const e=()=>this.visualSearchDropdown.classList.add("hidden");t?e():(this.visualDropdownHideTimeout&&clearTimeout(this.visualDropdownHideTimeout),this.visualDropdownHideTimeout=setTimeout(e,120))}async handleSourceSelection(t){try{switch(t){case"soundcloud":await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.showSoundCloudOrAlert(this.sourceCardElements.get("soundcloud")||this.soundcloudBtn,{hideOnboarding:!0,hideOverlay:!0});break;case"file":await this.handleFileSelection();break;case"mic":await this.handleMicrophoneSelection()}}catch(t){}}async handleFileSelection(){this.hideQuickStartModal(),await this.pausePlayback({stopVisualizer:!0,includeMic:!0}),this.fileInput?.click()}async handleMicrophoneSelection(){if(this.audioManager){if(this.hideQuickStartModal(),this.audioManager.isMicActive)return await this.audioManager.stopMicrophone(),this.hideNowPlaying(),this.updateControlButtons(this.audioManager.isPlaying,!1),void this.updateSelectionHubVisibility();try{this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state&&await this.audioManager.audioContext.resume(),await new Promise(t=>setTimeout(t,50)),await this.audioManager.startMicrophone(),this.hideAudioContextHint(),this.showMicrophoneNowPlaying()}catch(t){alert("Microphone access denied or unavailable.")}finally{this.updateControlButtons(this.audioManager.isPlaying,this.audioManager.isMicActive)}this.updateSelectionHubVisibility()}}setSourceAvailability(t,e,i=""){let a=null;"soundcloud"===t?a=this.soundcloudBtn:"file"===t?a=this.fileSelectBtn:"mic"===t&&(a=this.micBtn),a&&(a.disabled=!e,!e&&i?(a.dataset.soundcloudReason=i,a.setAttribute("title",i)):(delete a.dataset.soundcloudReason,a.removeAttribute("title")));const s=this.sourceCardElements?.get(t);s&&(s.classList.toggle("selection-card--disabled",!e),e?(s.removeAttribute("aria-disabled"),s.removeAttribute("data-soundcloud-reason")):(s.setAttribute("aria-disabled","true"),i&&(s.dataset.soundcloudReason=i)))}showSoundCloudOrAlert(t,{hideOnboarding:e=!0}={}){if(!this.soundCloudEnabled){const e=t?.dataset?.soundcloudReason||this.soundcloudBtn?.dataset?.soundcloudReason||this.soundCloudAvailabilityMessage||"SoundCloud integration is currently unavailable.";return void alert(e)}e&&this.hideQuickStartModal(!1),this.openSoundCloudModal()}setupVisualizerSearch(){this.visualizerSearchInput&&(this._searchInitialized?this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}):(this._searchInitialized=!0,this.visualizerSearchInput.addEventListener("input",t=>{this.applyVisualizerSearch(t.target.value,{showDropdown:!0}),this.showVisualSearchDropdown()}),this.visualizerSearchInput.addEventListener("focus",()=>{const t=this.visualizerSearchInput.value.trim();t?this.applyVisualizerSearch(t,{showDropdown:!0}):this.applyVisualizerSearch("",{showDropdown:!0}),this.showVisualSearchDropdown()}),this.visualizerSearchInput.addEventListener("keydown",t=>{if("Enter"===t.key){const e=this.visualizerSearchMatches[0];e&&(t.preventDefault(),this.visualizerSelect&&(this.visualizerSelect.value=e.name),this.switchVisualizer(e.name),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0}))}else"Escape"===t.key&&(this.visualizerSearchInput.value="",this.applyVisualizerSearch("",{showDropdown:!1}),this.visualizerSearchInput.blur(),this.hideVisualSearchDropdown({immediate:!0}))}),this.visualizerSearchInput.addEventListener("blur",()=>{this.visualizerSearchInput.value.trim()||this.updateVisualizerSummaryForSelection(this.currentVisualizerName),this.hideVisualSearchDropdown(),this.selectionHubManual=!1,this.updateSelectionHubVisibility()}),this.visualizerSearchInput.value.trim()?this.applyVisualizerSearch(this.visualizerSearchInput.value,{showDropdown:!1}):this.applyVisualizerSearch("",{showDropdown:!1}),this.visualSearchDropdown&&!this._dropdownBound&&(this.visualSearchDropdown.addEventListener("click",t=>{const e=t.target.closest(".visual-search-item");if(!e||e.classList.contains("visual-search-item--empty"))return;const i=e.dataset.visualName,a=e.dataset.displayName||"";a&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=a),this.hideVisualSearchDropdown({immediate:!0}),i&&i!==this.currentVisualizerName&&this.switchVisualizer(i),this.visualizerSearchInput?.blur()}),document.addEventListener("click",t=>{if(!this.visualSearchDropdown)return;const e=this.visualSearchBar?.contains(t.target),i=this.visualSearchDropdown.contains(t.target);e||i||this.hideVisualSearchDropdown({immediate:!0})}),this._dropdownBound=!0)))}applyVisualizerSearch(t="",{showDropdown:e}={}){const i=(t||"").toLowerCase().trim(),a=i.split(/\s+/).filter(Boolean),s=this.visualizerManifest||[];let r;r=a.length?s.map(t=>{const e=[t.name,t.displayName,t.description,...t.tags||[]].filter(Boolean).map(t=>t.toLowerCase());let i=0;for(const t of a){let a=0;for(const i of e)i.includes(t)&&(a=i===t?Math.max(a,3):i.startsWith(t)?Math.max(a,2):Math.max(a,1));if(0===a)return null;i+=a}return{entry:t,score:i}}).filter(Boolean).sort((t,e)=>e.score!==t.score?e.score-t.score:t.entry.displayName.localeCompare(e.entry.displayName)).map(t=>t.entry):s.slice(),this.visualizerSearchMatches=r,this.updateVisualizerSelectOptions(r,i),("boolean"==typeof e?e:document.activeElement===this.visualizerSearchInput)?this.renderVisualSearchDropdown(r,i):this.hideVisualSearchDropdown({immediate:!0}),this.updateVisualizerSearchSummary(r,i)}updateVisualizerSelectOptions(t,e){if(!this.visualizerSelect)return;const i=e.length>0&&t.length>0,a=new Set(t.map(t=>t.name));if(Array.from(this.visualizerSelect.options).forEach(t=>{if(i){const e=a.has(t.value);t.hidden=!e,t.disabled=!e}else t.hidden=!1,t.disabled=!1}),!i)return this.visualizerSelect.classList.remove("search-active","search-no-match"),void(this.currentVisualizerName&&this.availableVisualizers.has(this.currentVisualizerName)&&(this.visualizerSelect.value=this.currentVisualizerName));if(t.length){const e=t[0];this.visualizerSelect.value=e.name,this.visualizerSelect.classList.add("search-active"),this.visualizerSelect.classList.remove("search-no-match")}else this.visualizerSelect.classList.remove("search-active"),this.visualizerSelect.classList.add("search-no-match")}updateVisualizerSearchSummary(t,e){if(this.visualizerSearchInput&&(!e||t.length?this.visualizerSearchInput.classList.remove("no-results"):this.visualizerSearchInput.classList.add("no-results")),!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(!e)return void this.updateVisualizerSummaryForSelection(this.currentVisualizerName);if(!t.length)return this.visualizerSearchSummary.textContent="No visuals match that search.",void this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent);const i=t[0],a=i.description?`${i.displayName}: ${i.description}`:i.displayName,s=i.tags&&i.tags.length?` (${i.tags.slice(0,3).join(" • ")})`:"";this.visualizerSearchSummary.textContent=`Top match: ${a}${s}`,this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualizerSummaryForSelection(t){if(!this.visualizerSearchSummary)return;if(this.isPlaybackActive)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");if(Boolean(this.visualizerSearchInput?.value?.trim()))return;if(!t)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const e=this.visualizerMetadataByName.get(t);if(!e)return this.visualizerSearchSummary.textContent="",void this.updateVisualInfoSummary("");const i=e.description?`${e.displayName}: ${e.description}`:e.displayName,a=e.tags&&e.tags.length?` (${e.tags.slice(0,3).join(" • ")})`:"";this.visualizerSearchSummary.textContent=`${i}${a}`,this.visualizerSearchInput?.classList.remove("no-results"),this.updateVisualInfoSummary(this.visualizerSearchSummary.textContent)}updateVisualInfoSummary(t){if(this.visualInfoSummary){if(this.isPlaybackActive)return void(this.visualInfoSummary.textContent="");const e="Use the visual search bar above to change scenes.";this.visualInfoSummary.textContent=t||e}}updateVisualSearchVisibility(){if(!this.visualSearchBar)return;const t=Boolean(document.querySelector("#welcomeModal.active")),e=this.isGettingStartedActive();let i=!1;try{i=!this.getBooleanStorageValue(localStorage,[this.storageKeys.termsAccepted])}catch(t){i=!0}const a=t||e||i;this.visualSearchBar.classList.toggle("hidden",a),this.visualSearchBar.setAttribute("aria-hidden",a?"true":"false")}setVisualSearchDimmed(t=!0){this.visualSearchBar&&this.visualSearchBar.classList.toggle("dimmed",t)}refreshVisualSearchSummary(){const t=this.visualizerSearchInput?.value?.trim();t?this.applyVisualizerSearch(t,{showDropdown:!1}):this.updateVisualizerSummaryForSelection(this.currentVisualizerName)}formatTime(t){if(!Number.isFinite(t)||t<0)return"0:00";const e=Math.floor(t);return`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`}updatePlayerTimeline(t=null){if(!this.playerCurrentTimeEl||!this.playerDurationEl)return;const e=this.audioManager?.audioElement||null,i=Boolean(this.audioManager?.isMicActive);let a=Number.isFinite(t?.mediaTime)?t.mediaTime:null;!Number.isFinite(a)&&e&&(a=e.currentTime),(!Number.isFinite(a)||a<0)&&(a=0);let s=null;if(Number.isFinite(t?.mediaDuration)&&t.mediaDuration>0?s=t.mediaDuration:Number.isFinite(this.currentTrackDurationMs)&&this.currentTrackDurationMs>0?s=this.currentTrackDurationMs/1e3:e&&Number.isFinite(e.duration)&&e.duration>0&&e.duration!==1/0&&(s=e.duration),i)return this.playerCurrentTimeEl.textContent="LIVE",this.playerDurationEl.textContent="",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),void(this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"));this.playerCurrentTimeEl.textContent=this.formatTime(a),Number.isFinite(s)&&s>0?(this.playerDurationEl.textContent=this.formatTime(s),this.playerDurationDivider&&(this.playerDurationDivider.style.display=""),this.playerDock&&this.playerDock.classList.remove("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","false")):(this.playerDurationEl.textContent="--:--",this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDock&&this.playerDock.classList.add("player-dock--no-duration"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"))}async loadAudioFile(t,{pauseBeforeLoad:e=!1,autoPlay:i=!1}={}){try{const a=this.showLoadingMessage("Loading audio...");if(await this.extractAndDisplayMetadata(t),e?await this.pausePlayback({includeMic:!0}):(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isMicActive&&await this.audioManager.stopMicrophone()),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(t){}await this.audioManager.loadFile(t),this.hideLoadingMessage(a),this.hideGettingStartedOverlay(),this.hideOnboardingOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),(i||!e)&&setTimeout(async()=>{try{await this.audioManager.play()}catch(t){this.updateControlButtons(!1,this.audioManager?.isMicActive)}},i?220:150)}catch(t){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}async extractAndDisplayMetadata(t){let e=t.name.replace(/\.[^/.]+$/,""),i="Unknown Artist";const a=e.match(/(.+?)\s*-\s*(.+)/);a&&(i=a[1].trim(),e=a[2].trim()),this.updateNowPlaying(e,i,{source:"file"})}setActiveSource(t){const e=t&&PLAYER_SOURCE_CONFIG[t]?t:"none";this.currentSourceType="none"===e?null:e;const i=PLAYER_SOURCE_CONFIG[e];if(this.playerSourceIndicatorLabel&&(this.playerSourceIndicatorLabel.textContent=i.label),this.playerSourceIndicatorIcon){for(;this.playerSourceIndicatorIcon.firstChild;)this.playerSourceIndicatorIcon.removeChild(this.playerSourceIndicatorIcon.firstChild);if(i.iconImg){const t=document.createElement("img");t.src=i.iconImg,t.alt="",t.decoding="async",t.className="player-source-indicator-icon-img",this.playerSourceIndicatorIcon.appendChild(t)}else i.icon?this.playerSourceIndicatorIcon.textContent=i.icon:this.playerSourceIndicatorIcon.textContent=PLAYER_SOURCE_CONFIG.none.icon}if(this.sourceCardElements&&this.sourceCardElements.size&&this.sourceCardElements.forEach((t,i)=>{t&&(t.classList.toggle("selection-card--active",e===i),t.setAttribute("aria-pressed",e===i?"true":"false"))}),this.sourcePickerBtn){const t=i.label&&i.label!==PLAYER_SOURCE_CONFIG.none.label?` (current: ${i.label})`:"";this.sourcePickerBtn.setAttribute("aria-label",`Choose audio source${t}`)}this.selectionHubManual=!1,this.updateSelectionHubVisibility()}updateNowPlaying(t,e,i={}){const a=(t,e)=>{if("string"==typeof t){const e=t.trim();if(e.length)return e}return e},s=t=>{if("string"!=typeof t)return null;const e=t.trim();return e&&(/^https?:\/\//i.test(e)||/^data:image\//i.test(e)||/^blob:/i.test(e))?e:null},r=Boolean(i?.isSoundCloud),n=i?.source&&PLAYER_SOURCE_CONFIG[i.source]?i.source:r?"soundcloud":i?.source,o=s(i?.trackUrl),l=s(i?.artistUrl),u=(a(i?.trackLinkLabel,"View on SoundCloud"),s(i?.artworkUrl)),d=s(i?.artistImageUrl),c=u||d||null,h=a(t,"No track loaded"),p=a(e,r?"Unknown Creator":"Unknown Artist");if(this.playerDock&&(this.playerDock.classList.toggle("player-dock--soundcloud",r),this.playerDock.classList.toggle("player-dock--live",Boolean(i?.isLive))),this.playerTitleEl&&(this.playerTitleEl.textContent=h,o?(this.playerTitleEl.href=o,this.playerTitleEl.target="_blank",this.playerTitleEl.rel="noopener"):(this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel"))),this.playerArtistEl&&(this.playerArtistEl.textContent=p,l?(this.playerArtistEl.href=l,this.playerArtistEl.target="_blank",this.playerArtistEl.rel="noopener"):(this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel"))),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!p),this.playerArtwork){const t=c||DEFAULT_PLAYER_ART;this.playerArtwork.src!==t&&(this.playerArtwork.src=t),this.playerArtwork.alt=c?`${h} by ${p} artwork`:"Default Vvavy artwork",this.playerArtwork.hidden=!1}const m="number"==typeof i?.duration&&Number.isFinite(i.duration)&&i.duration>0?i.duration:null;this.currentTrackDurationMs=m,n?this.setActiveSource(n):this.currentSourceType||this.setActiveSource(null),this.updatePlayerTimeline()}showMicrophoneNowPlaying(){this.updateNowPlaying("Microphone","Live input",{source:"mic",isLive:!0}),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.updateSelectionHubVisibility()}hideNowPlaying(){this.currentTrackDurationMs=null,this.playerTitleEl&&(this.playerTitleEl.textContent="No track loaded",this.playerTitleEl.removeAttribute("href"),this.playerTitleEl.removeAttribute("target"),this.playerTitleEl.removeAttribute("rel")),this.playerArtistEl&&(this.playerArtistEl.textContent="—",this.playerArtistEl.removeAttribute("href"),this.playerArtistEl.removeAttribute("target"),this.playerArtistEl.removeAttribute("rel")),this.playerArtistPrefixEl&&(this.playerArtistPrefixEl.hidden=!0),this.playerArtwork&&(this.playerArtwork.src!==DEFAULT_PLAYER_ART&&(this.playerArtwork.src=DEFAULT_PLAYER_ART),this.playerArtwork.alt="Default Vvavy artwork",this.playerArtwork.hidden=!1),this.playerDock&&(this.playerDock.classList.add("player-dock--no-duration"),this.playerDock.classList.remove("player-dock--soundcloud"),this.playerDock.classList.remove("player-dock--live")),this.playerDurationDivider&&(this.playerDurationDivider.style.display="none"),this.playerDurationWrapper&&this.playerDurationWrapper.setAttribute("aria-hidden","true"),this.setActiveSource(null),this.updatePlayerTimeline()}showLoadingMessage(t){const e=document.createElement("div");return e.className="loading-message",e.innerHTML=`<div class="loading-content"><div class="loading-spinner">🎧</div><p>${t}</p></div>`,document.body.appendChild(e),e}hideLoadingMessage(t){t?.parentNode?t.parentNode.removeChild(t):document.querySelectorAll(".loading-message").forEach(t=>t.remove())}updateControlButtons(t,e){if(this.playPauseBtn){const e=this.playPauseBtn.querySelector(".btn-icon"),i=this.playPauseBtn.querySelector(".btn-label");e&&(e.textContent=t?"⏸":"▶"),i&&(i.textContent=t?"Pause":"Play"),this.playPauseBtn.setAttribute("aria-label",t?"Pause":"Play");const a=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive),s=!!this.demoAudioFile;(a||t)&&this.playPauseBtn.classList.remove("initial-pulse");const r=a||s||t;this.playPauseBtn.disabled=!r,a&&!t?this.playPauseBtn.classList.add("breathe"):this.playPauseBtn.classList.remove("breathe")}this.updatePlayerTimeline()}getDefaultVisualizerName(){const t="undefined"!=typeof window?window.DEFAULT_VISUALIZER:null;if(t&&this.availableVisualizers.has(t))return t;const e=this.availableVisualizers.keys().next();return e&&!e.done?e.value:null}showQuickStartModal({force:t=!1}={}){this.quickStartModal&&(this.onboardingCompleted&&!t||(this.quickStartModal.classList.add("active"),this.quickStartModal.setAttribute("aria-hidden","false"),document.body.classList.add("quickstart-active"),this.selectionHubManual=!1,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="",this.quickStartStatusEl.classList.remove("quickstart-status--error")),this.updateVisualSearchVisibility()))}hideQuickStartModal(t=!0){if(this.quickStartModal){if(this.quickStartModal.classList.remove("active"),this.quickStartModal.setAttribute("aria-hidden","true"),document.body.classList.remove("quickstart-active"),t){this.onboardingCompleted=!0;try{this.setStorageItem(sessionStorage,this.onboardingStorageKey,"true")}catch(t){}}this.selectionHubManual=!1,this.updateSelectionHubVisibility(),this.updateVisualSearchVisibility()}}async handleQuickStartStart(){if(this.quickStartStartBtn){this.quickStartStartBtn.disabled=!0,this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Loading demo track…",this.quickStartStatusEl.classList.remove("quickstart-status--error"));try{const t=this.getDefaultVisualizerName();t&&t!==this.currentVisualizerName&&await this.switchVisualizer(t);let e=this.demoAudioFile;if(e||(e=await this.loadDemoAudioSilently()),!e)throw new Error("Demo audio unavailable");this.audioManager?.isMicActive&&await this.audioManager.stopMicrophone(),await this.loadAudioFile(e,{pauseBeforeLoad:!0,autoPlay:!0}),this.demoAudioFile=null,this.hideQuickStartModal(!0)}catch(t){this.quickStartStatusEl&&(this.quickStartStatusEl.textContent="Quick start failed. Please choose a visual and audio source manually.",this.quickStartStatusEl.classList.add("quickstart-status--error"))}finally{this.quickStartStartBtn.disabled=!1}}}showGettingStartedOverlay({remember:t=!0}={}){this.hasCompletedOnboarding()||this.showQuickStartModal({force:!0})}hideGettingStartedOverlay(){this.hideQuickStartModal()}isGettingStartedActive(){return this.quickStartModal?.classList.contains("active")||!1}showOnboardingOverlay({force:t=!1}={}){!t&&this.hasCompletedOnboarding()||this.showQuickStartModal({force:t})}hideOnboardingOverlay(){this.hideQuickStartModal()}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(t){if(!this.availableVisualizers.has(t))return;await this.loadVisualizer(t),this.updateVisualizerSummaryForSelection(t);const e=this.visualizerMetadataByName.get(t);e&&this.visualizerSearchInput&&(this.visualizerSearchInput.value=e.displayName),this.selectionHubManual=!1,this.highlightActiveVisualizer(t),this.hideVisualSearchDropdown({immediate:!0}),this.refreshVisualSearchSummary(),this.imageUploadBtn.style.display="ImageVisualizer"===t||"WebGLImageExplosionVisualizer"===t?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showOnboardingOverlay()}destroy(){if(this.hideGettingStartedOverlay(),this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.soundCloudModal?.overlay)try{this.soundCloudModal.overlay.remove()}catch(t){}this.soundCloudModal=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{const t=()=>{const t=new VvavyApp;return window.vvavy=t,t};window.visualizersLoaded?t():window.addEventListener("visualizersReady",t)});