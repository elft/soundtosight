class SoundToSight{constructor(){this.audioManager=null,this.currentVisualizer=null,this.availableVisualizers=new Map,this.frameStatusEl=null,this.canvas=null,this.dropOverlay=null,this.fileInput=null,this.playPauseBtn=null,this.stopBtn=null,this.micBtn=null,this.fileSelectBtn=null,this.visualizerSelect=null,this.imageUploadBtn=null,this.menuToggle=null,this.menuPanel=null,this.isInitialized=!1,this.currentVisualizerName=null,this.init()}async init(){try{this.initializeDOMElements(),this.audioManager=new AudioManager,await this.audioManager.init(1024),this.setupAudioCallbacks();try{this.audioManager.startAnalysis()}catch(e){}this.populateAvailableVisualizers(),this.setupEventListeners(),this.setupDragAndDrop(),this.audioManager.startAnalysis(),this.availableVisualizers.has("DebugVisualizer")&&(await this.loadVisualizer("DebugVisualizer"),this.visualizerSelect&&(this.visualizerSelect.value="DebugVisualizer")),this.menuPanel&&this.menuPanel.classList.remove("collapsed"),this.menuToggle&&(this.menuToggle.style.display="inline-flex"),!("true"===localStorage.getItem("soundToSightAccepted"))||this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay(),this.isInitialized=!0}catch(e){}}initializeDOMElements(){this.dropOverlay=document.getElementById("dropOverlay"),this.fileInput=document.getElementById("fileInput"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.stopBtn=document.getElementById("stopBtn"),this.micBtn=document.getElementById("micBtn"),this.fileSelectBtn=document.getElementById("fileSelectBtn"),this.visualizerSelect=document.getElementById("visualizerSelect"),this.imageUploadBtn=document.getElementById("imageUploadBtn"),this.menuToggle=document.getElementById("menuToggle"),this.menuPanel=document.querySelector(".menu-panel"),this.canvas=null,this.dropOverlay&&this.fileInput&&(this.dropOverlay.style.cursor="pointer",this.dropOverlay.addEventListener("click",e=>{e.dataTransfer||this.fileInput.click()}))}async loadVisualizer(e){try{this.currentVisualizer&&(this.currentVisualizer.destroy(),this.currentVisualizer=null);const t=this.availableVisualizers.get(e);if(!t)throw new Error(`Visualizer not found: ${e}`);if(this.currentVisualizer=new t.class(null,{}),this.currentVisualizerName=e,this.canvas=this.currentVisualizer.canvas,!this.canvas)throw new Error("Visualizer failed to create canvas");(this.audioManager.isPlaying||this.audioManager.isMicActive)&&this.currentVisualizer.start()}catch(e){}}setupAudioCallbacks(){this.audioManager.setAudioDataCallback(e=>{this.currentVisualizer?.update&&this.currentVisualizer.update(e)}),this.audioManager.setPlayStateChangeCallback((e,t)=>{this.currentVisualizer&&(!e&&!t||this.currentVisualizer.isAnimating?e||t||!this.currentVisualizer.isAnimating||this.currentVisualizer.stop():this.currentVisualizer.start()),this.updateControlButtons(e,t)})}setupEventListeners(){this.playPauseBtn?.addEventListener("click",async()=>{if(!this.audioManager.audioElement&&this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{return await this.audioManager.audioContext.resume(),this.hideAudioContextHint(),void this.updateControlButtons(!1,this.audioManager.isMicActive)}catch(e){}this.audioManager.isPlaying?this.audioManager.pause():this.audioManager.play()}),this.stopBtn?.addEventListener("click",()=>this.audioManager.stop()),this.micBtn?.addEventListener("click",async()=>{if(this.audioManager.isMicActive)return this.audioManager.stopMicrophone();try{await this.audioManager.startMicrophone(),this.hideDropOverlay(),this.hideAudioContextHint()}catch{alert("Microphone access denied or unavailable.")}}),this.fileSelectBtn?.addEventListener("click",()=>{this.fileInput?.click()}),this.fileInput?.addEventListener("change",e=>{const t=e.target.files[0];t?.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(t.name)?this.loadAudioFile(t):alert("Unsupported file type. Please use audio files only."),this.fileInput.value=""}),this.visualizerSelect?.addEventListener("change",e=>{const t=e.target.value;t&&t!==this.currentVisualizerName&&this.switchVisualizer(t)}),this.imageUploadBtn?.addEventListener("click",()=>{this.currentVisualizer&&"function"==typeof this.currentVisualizer.openImageSelector&&this.currentVisualizer.openImageSelector()})}setupDragAndDrop(){["dragenter","dragover"].forEach(e=>{document.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),Array.from(e.dataTransfer?.types||[]).includes("Files")&&this.showDropOverlay()})}),document.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),0===e.clientX&&0===e.clientY&&this.hideDropOverlay()}),document.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),this.hideDropOverlay();const t=Array.from(e.dataTransfer?.files||[]).find(e=>e.type.startsWith("audio/"));t&&this.loadAudioFile(t)})}populateAvailableVisualizers(){"undefined"!=typeof window&&Array.isArray(window.VISUALIZERS_MANIFEST)&&window.VISUALIZERS_MANIFEST.forEach(e=>{const t=e.name,i=window[t];"function"==typeof i&&this.availableVisualizers.set(t,{name:t,class:i,file:e.file})}),0===this.availableVisualizers.size&&this.visualizerSelect&&Array.from(this.visualizerSelect.options).forEach(e=>{const t=e.value,i=window[t];"function"==typeof i&&this.availableVisualizers.set(t,{name:t,class:i})})}async loadAudioFile(e){try{const t=this.showLoadingMessage("Loading audio...");if(this.audioManager.isPlaying&&this.audioManager.pause(),this.audioManager.isContextInitialized||await this.audioManager.init(),this.audioManager.audioContext&&"suspended"===this.audioManager.audioContext.state)try{await this.audioManager.audioContext.resume()}catch(e){}await this.audioManager.loadFile(e),this.hideLoadingMessage(t),this.hideDropOverlay(),this.hideAudioContextHint(),this.updateControlButtons(!1,!1),setTimeout(async()=>{try{await this.audioManager.play()}catch(e){this.updateControlButtons(!1,!1)}},150)}catch(e){this.hideLoadingMessage(),alert("Failed to load audio file. Try a different one.")}}showLoadingMessage(e){const t=document.createElement("div");return t.className="loading-message",t.innerHTML=`<div class="loading-content"><div class="loading-spinner">üéß</div><p>${e}</p></div>`,document.body.appendChild(t),t}hideLoadingMessage(e){e?.parentNode?e.parentNode.removeChild(e):document.querySelectorAll(".loading-message").forEach(e=>e.remove())}updateControlButtons(e,t){if(this.playPauseBtn){this.playPauseBtn.textContent=e?"‚è∏Ô∏è":"‚ñ∂Ô∏è";const t=!(!this.audioManager||!this.audioManager.audioElement&&!this.audioManager.isMicActive);this.playPauseBtn.disabled=!t&&!e}this.stopBtn&&(this.stopBtn.disabled=!e&&!t),this.micBtn&&(this.micBtn.textContent=t?"üî¥":"üé§")}showDropOverlay(){this.dropOverlay?.classList.add("active"),document.body.classList.add("drop-overlay-active")}hideDropOverlay(){this.dropOverlay?.classList.remove("active","drag-over"),document.body.classList.remove("drop-overlay-active")}showAudioContextHint(){if(!this.audioManager.isContextInitialized){const e=document.querySelector(".drop-content");if(e&&!e.querySelector(".audio-hint")){const t=document.createElement("div");t.className="audio-hint",t.innerHTML='<p style="color:#ffd700;font-size:14px;margin-top:10px;">üéµ Tap to enable audio context</p>',e.appendChild(t)}}try{const e=document.createElement("div");Object.assign(e.style,{position:"fixed",left:"12px",bottom:"12px",padding:"8px 10px",background:"rgba(0,0,0,0.7)",color:"#fff",borderRadius:"8px",fontFamily:"monospace",fontSize:"12px",zIndex:2147483646,pointerEvents:"none",opacity:"0.9"}),e.id="frameStatusOverlay",e.textContent="frames: --",document.body.appendChild(e),this.frameStatusEl=e}catch(e){}}showToast(e,t=3e3){try{const i=document.createElement("div");Object.assign(i.style,{position:"fixed",left:"50%",bottom:"24px",transform:"translateX(-50%) translateY(0px)",background:"rgba(0,0,0,0.85)",color:"#fff",padding:"10px 16px",borderRadius:"20px",zIndex:2147483646,fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, sans-serif",fontSize:"13px",boxShadow:"0 6px 18px rgba(0,0,0,0.35)",opacity:"0",transition:"opacity 180ms ease, transform 180ms ease"}),i.textContent=e,document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.style.transform="translateX(-50%) translateY(-6px)"}),setTimeout(()=>{try{i.style.opacity="0",i.style.transform="translateX(-50%) translateY(0px)",setTimeout(()=>{try{i.remove()}catch(e){}},200)}catch(e){}},t)}catch(e){}}hideAudioContextHint(){document.querySelector(".audio-hint")?.remove()}async switchVisualizer(e){this.availableVisualizers.has(e)&&(await this.loadVisualizer(e),this.imageUploadBtn.style.display="ImageVisualizer"===e?"inline-block":"none",this.audioManager.audioElement||this.audioManager.isMicActive||this.showDropOverlay())}destroy(){this.currentVisualizer?.destroy(),this.currentVisualizer=null,this.audioManager?.destroy(),this.audioManager=null}}document.addEventListener("DOMContentLoaded",()=>{window.visualizersLoaded?window.soundToSight=new SoundToSight:window.addEventListener("visualizersReady",()=>window.soundToSight=new SoundToSight)});