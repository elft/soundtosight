class SmokeAndMirrorsVisualizer extends BaseVisualizer{constructor(t,s){super(t,{backgroundColor:"#04040a",force2d:!0,stereo:!0,smoothing:.78,...s})}init(){this.time=0,this.lastFrameTime=performance.now(),this.smoothedLeft=0,this.smoothedRight=0,this.leftFlow=0,this.rightFlow=0,this.smoothedSubBass=0,this.smoothedBass=0,this.smoothedLowMid=0,this.smoothedMid=0,this.smoothedUpperMid=0,this.smoothedPresence=0,this.smoothedTreble=0,this.smoothedBrilliance=0,this.stereoDrift=0,this.beatPulse=0,this.overlayGlow=this.createOverlay("smokeMirrorsGlow"),this.ripples=[],this.reseedFields()}onResize(){this.reseedFields()}onUpdate(t){if(!t)return;const s=this.safeNumber(t.rmsLeft,t.rms||0),e=this.safeNumber(t.rmsRight,t.rms||0);this.smoothedLeft=this.lerp(this.smoothedLeft,this.clamp(s,0,1),.2),this.smoothedRight=this.lerp(this.smoothedRight,this.clamp(e,0,1),.2),this.smoothedSubBass=this.lerp(this.smoothedSubBass,this.clamp(t.subBassEnergy||0,0,1.5),.08),this.smoothedBass=this.lerp(this.smoothedBass,this.clamp(t.bassEnergy||0,0,1.5),.1),this.smoothedLowMid=this.lerp(this.smoothedLowMid,this.clamp(t.lowMidEnergy||0,0,1.5),.12),this.smoothedMid=this.lerp(this.smoothedMid,this.clamp(t.midEnergy||0,0,1.5),.12),this.smoothedUpperMid=this.lerp(this.smoothedUpperMid,this.clamp(t.upperMidEnergy||0,0,1.5),.12),this.smoothedPresence=this.lerp(this.smoothedPresence,this.clamp(t.presenceEnergy||0,0,1.5),.14),this.smoothedTreble=this.lerp(this.smoothedTreble,this.clamp(t.trebleEnergy||0,0,1.5),.14),this.smoothedBrilliance=this.lerp(this.smoothedBrilliance,this.clamp(t.brillianceEnergy||0,0,1.5),.16);const i=this.safeNumber(t.stereoBalance,0);this.stereoDrift=this.lerp(this.stereoDrift,i*(.12*this.width),.08);const h=this.extractChannelEnergy(t.frequencyLeft),o=this.extractChannelEnergy(t.frequencyRight);this.leftFlow=this.lerp(this.leftFlow,h,.18),this.rightFlow=this.lerp(this.rightFlow,o,.18),(t.isBeat||t.isBeatSpike)&&(this.beatPulse=1),t.bassDrop&&this.spawnMirrorRipple(this.clamp(t.bassDropIntensity??this.smoothedBass+this.smoothedSubBass,.1,2)),this.time=this.safeNumber(t.time,this.time+.016)}onRender(){const t=performance.now(),s=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t;const e=this.ctx;if(!e)return;const i=this.clamp(.38-.08*this.smoothedSubBass,.16,.38);e.fillStyle=`rgba(4, 4, 12, ${i})`,e.fillRect(0,0,this.width,this.height),this.drawBackground(e),this.drawSmoke(e,s),this.drawRipples(e,s),this.drawMirrors(s),this.beatPulse*=.9}drawBackground(t){const s=this.width/2+.35*this.stereoDrift,e=this.map(this.clamp(this.smoothedLeft+.8*this.leftFlow,0,1.4),0,1.4,190,280),i=this.map(this.clamp(this.smoothedRight+.8*this.rightFlow,0,1.4),0,1.4,320,420),h=this.safeGradient(t,0,0,this.width,this.height);h.addColorStop(0,`hsla(${e}, 50%, ${18+10*this.smoothedBass}%, 0.28)`),h.addColorStop(.5,`hsla(${this.map(this.smoothedMid,0,1.2,200,260)}, 45%, ${14+16*this.smoothedMid}%, 0.22)`),h.addColorStop(1,`hsla(${i}, 50%, ${18+10*this.smoothedBass}%, 0.28)`),t.save(),t.globalCompositeOperation="source-over",t.fillStyle=h,t.fillRect(0,0,this.width,this.height),t.restore();const o=this.map(this.smoothedMid+.5*this.smoothedUpperMid,0,2,.04*this.width,.18*this.width),r=this.safeGradient(t,s-o,0,s+o,this.height);r.addColorStop(0,"rgba(6, 12, 24, 0)"),r.addColorStop(.5,`rgba(60, 110, 180, ${.04+.06*this.smoothedPresence})`),r.addColorStop(1,"rgba(6, 12, 24, 0)"),t.save(),t.globalCompositeOperation="source-over",t.fillStyle=r,t.fillRect(0,0,this.width,this.height),t.restore()}drawSmoke(t,s){const e=this.width/2+.5*this.stereoDrift,i=this.height/2,h=.8*this.smoothedLowMid+.5*this.smoothedMid+.6*this.beatPulse,o=this.smoothedSubBass*this.height*.03,r=180*this.smoothedBass;for(const a of this.smokeWisps){a.phase+=s*a.speed*(.5+h);const l=a.side<0?this.smoothedLeft+this.leftFlow:a.side>0?this.smoothedRight+this.rightFlow:.5*(this.smoothedLeft+this.smoothedRight)+.5*(this.leftFlow+this.rightFlow),d=this.clamp(l*(.6+.4*this.beatPulse),0,2.2),n=i+a.offsetY*this.height*.5+o*(0===a.layer?-1:1),m=Math.sin(a.phase+a.seed)*(a.range+r*a.depth),p=Math.cos(.7*a.phase+1.3*a.seed)*a.range*.6*(1+.4*this.smoothedMid),c=e+this.stereoDrift*(.4+.6*a.depth)+a.side*this.width*a.spread+m+p,g=this.clamp(a.baseThickness*(.4+.7*d),8,240);t.save(),t.globalAlpha=.06+.12*d,t.lineWidth=g,t.lineCap="round",t.lineJoin="round";const f=.1*this.height+120*this.smoothedBass,u=c-.6*f,M=c+.6*f,b=n-.15*g,w=n+.15*g,S=(0===a.layer?210:260)+60*d+40*this.smoothedBrilliance,y=this.safeGradient(t,u,b,M,w);y.addColorStop(0,`hsla(${S-30}, 60%, ${22+25*d}%, 0.0)`),y.addColorStop(.5,`hsla(${S}, 70%, ${45+18*d}%, 0.5)`),y.addColorStop(1,`hsla(${S+30}, 60%, ${18+20*d}%, 0.0)`),t.strokeStyle=y,t.beginPath(),t.moveTo(u,b),t.bezierCurveTo(e+Math.sin(.8*a.phase+2.1*a.seed)*f,n-.4*g,e+Math.cos(.6*a.phase+1.7*a.seed)*f,n+.4*g,M,w),t.stroke(),t.restore()}}drawMirrors(t){if(!this.overlayGlow?.ctx)return;const s=this.overlayGlow.ctx;s.save(),s.globalCompositeOperation="source-over",s.fillStyle="rgba(0, 0, 0, 0.12)",s.fillRect(0,0,this.width,this.height),s.globalCompositeOperation="source-over";const e=this.width/2+.6*this.stereoDrift,i=.6*this.smoothedPresence+.4*this.smoothedTreble+.4*this.smoothedBrilliance;for(const h of this.mirrorShards){h.phase+=t*h.spin*(1.2+1.6*i);const o=this.clamp(.7*this.smoothedLeft+1.4*this.leftFlow,0,2.4),r=this.clamp(.7*this.smoothedRight+1.4*this.rightFlow,0,2.4);this.drawMirrorShard(s,h,-1,o,e),this.drawMirrorShard(s,h,1,r,e)}s.restore()}drawMirrorShard(t,s,e,i,h){const o=this.width*s.orbit+.12*this.width,r=Math.sin(.6*s.phase+s.seed)*this.height*.08*(.4+.6*this.smoothedMid),a=this.height*s.heightFactor+r,l=h+e*o,d=this.clamp(s.baseSize*(.5+1.2*i),14,.18*this.width),n=this.clamp(d*(1.6+1.1*this.smoothedPresence),30,.4*this.height),m=s.phase*e*(.5+.7*i);t.save(),t.translate(l,a),t.rotate(m),t.scale(e,1);const p=200+s.colorShift+70*i+50*this.smoothedBrilliance,c=.12+.16*i,g=this.safeGradient(t,.5*-d,-n,.5*d,n);g.addColorStop(0,`hsla(${p-40}, 70%, 60%, ${.2*c})`),g.addColorStop(.4,`hsla(${p}, 80%, 65%, ${.9*c})`),g.addColorStop(.7,`hsla(${p+25}, 75%, 70%, ${c})`),g.addColorStop(1,`hsla(${p+60}, 70%, 55%, ${.5*c})`),t.beginPath(),t.moveTo(0,-n),t.lineTo(.55*d,.18*-n),t.lineTo(.25*d,.22*n),t.lineTo(0,n),t.lineTo(.35*-d,.25*n),t.lineTo(.55*-d,.1*-n),t.closePath(),t.fillStyle=g,t.globalAlpha=.35+.2*i,t.fill(),t.globalAlpha=.12+.12*i,t.lineWidth=1.2+1.8*i,t.strokeStyle=`hsla(${p+40}, 90%, 75%, 1)`,t.stroke(),t.restore()}drawRipples(t,s){if(!this.ripples.length)return;const e=this.width/2+.4*this.stereoDrift,i=this.height/2;for(let h=this.ripples.length-1;h>=0;h--){const o=this.ripples[h];if(o.radius+=o.speed*s,o.alpha*=.96,o.alpha<.02||o.radius>o.maxRadius){this.ripples.splice(h,1);continue}const r=this.safeGradient(t,e-o.radius,i-o.radius,e+o.radius,i+o.radius);r.addColorStop(0,`rgba(80, 140, 255, ${.4*o.alpha})`),r.addColorStop(.6,`rgba(120, 200, 255, ${.2*o.alpha})`),r.addColorStop(1,"rgba(10, 20, 40, 0)"),t.save(),t.globalCompositeOperation="screen",t.lineWidth=o.bandWidth,t.strokeStyle=`rgba(180, 220, 255, ${o.alpha})`,t.beginPath(),t.arc(e,i,o.radius,0,2*Math.PI),t.stroke(),t.globalCompositeOperation="lighter",t.fillStyle=r,t.beginPath(),t.arc(e,i,.9*o.radius,0,2*Math.PI),t.fill(),t.restore()}}spawnMirrorRipple(t=.6){const s=this.map(t,0,2,240,540),e=this.map(t,0,2,4,18),i=.7*Math.hypot(this.width,this.height);this.ripples.push({radius:.05*this.width,speed:s,bandWidth:e,alpha:.35+.22*t,maxRadius:i})}reseedFields(){this.smokeWisps=this.createSmokeWisps(64),this.mirrorShards=this.createMirrorShards(28)}createSmokeWisps(t){const s=[];for(let e=0;e<t;e++){const t=e%3==0?0:Math.random()<.5?-1:1;s.push({seed:Math.random()*Math.PI*2,phase:Math.random()*Math.PI*2,speed:this.map(Math.random(),0,1,.3,1.8),side:t,spread:this.map(Math.random(),0,1,.08,.32),offsetY:Math.random()-.5,layer:Math.random()<.5?0:1,baseThickness:this.map(Math.random(),0,1,26,90),range:this.map(Math.random(),0,1,40,180),depth:this.map(Math.random(),0,1,.2,1)})}return s}createMirrorShards(t){const s=[];for(let e=0;e<t;e++)s.push({seed:Math.random()*Math.PI*2,phase:Math.random()*Math.PI*2,orbit:this.map(Math.random(),0,1,.12,.42),heightFactor:this.map(Math.random(),0,1,.18,.82),baseSize:this.map(Math.random(),0,1,30,90),spin:this.map(Math.random(),0,1,.6,2.2),colorShift:this.map(Math.random(),0,1,-40,60)});return s}extractChannelEnergy(t){if(!t||!t.length)return 0;let s=0;const e=Math.max(1,Math.floor(t.length/64));for(let i=0;i<t.length;i+=e)s+=t[i];const i=s/(t.length/e);return this.clamp(i/255,0,1.5)}safeGradient(t,s,e,i,h){return Number.isFinite(s)||(s=0),Number.isFinite(e)||(e=0),Number.isFinite(i)||(i=s+1),Number.isFinite(h)||(h=e+1),s===i&&e===h&&(i+=1e-4),t.createLinearGradient(s,e,i,h)}lerp(t,s,e){return t+(s-t)*e}clamp(t,s,e){return Math.min(Math.max(t,s),e)}map(t,s,e,i,h){return e===s?i:i+(t-s)/(e-s)*(h-i)}safeNumber(t,s=0){return Number.isFinite(t)?t:s}}"undefined"!=typeof window&&(window.SmokeAndMirrorsVisualizer=SmokeAndMirrorsVisualizer);