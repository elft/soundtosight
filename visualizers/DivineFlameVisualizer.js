class DivineFlameVisualizer extends BaseVisualizer{static meta={description:"Cathedral-scale flame pillars, halos, and corona blooms that thrive on impact hits.",tags:["heavy bass","midtempo","cinematic","edm"]};constructor(e,t){super(e,{backgroundColor:"#050609",force2d:!0,stereo:!0,...t})}async init(){this.centerX=this.width/2,this.baseY=.82*this.height,this.metrics={subBass:0,bass:0,lowMid:0,mid:0,upperMid:0,presence:0,treble:0,brilliance:0,ultrasonic:0,rms:0,centroid:0,stereo:0,energyChange:0,spectralFlux:0},this.palette={baseHue:24,targetBaseHue:24,accentHue:48,targetAccentHue:48,rimHue:210},this.flame={baseWidth:140,baseWidthTarget:140,baseHeight:260,baseHeightTarget:260,crestLean:0,crestLeanTarget:0,halo:.3,haloTarget:.3,wave:.2,waveTarget:.2,flicker:.4},this.backdropCanvas=document.createElement("canvas"),this.backdropCtx=this.backdropCanvas.getContext("2d"),this._resizeBackdrop(),this.auraLayers=this._initAuraLayers(4),this.coronaPetals=this._initCoronaPetals(7),this.sparkles=this._initSparkles(24),this.hazeBands=this._initHazeBands(3),this.pulseRings=[],this.time=0,this.lastRenderTime=performance.now()}_resizeBackdrop(){const e=Math.max(16,Math.round(.35*this.width)),t=Math.max(16,Math.round(.35*this.height));this.backdropCanvas.width=e,this.backdropCanvas.height=t}onResize(){this.centerX=this.width/2,this.baseY=.82*this.height,this._resizeBackdrop()}_initAuraLayers(e){const t=[];for(let s=0;s<e;s++){const a=s/e;t.push({index:s,depth:a,width:120-40*a,targetWidth:120-40*a,height:220+30*a,targetHeight:220+30*a,noise:12+8*a,targetNoise:12+8*a,alpha:.4-.08*a,targetAlpha:.4-.08*a,hueShift:26*-a,targetHueShift:26*-a,phase:Math.random()*Math.PI*2,rippleSpeed:.4+.3*a,curvature:1.3+.4*a,taper:1.4+.2*a})}return t}_initCoronaPetals(e){const t=[];for(let s=0;s<e;s++)t.push({index:s,angle:s/e*Math.PI*2,speed:.6+.3*Math.random(),scale:.8+.4*Math.random(),targetScale:.8,alpha:.2,targetAlpha:.2,length:90+60*Math.random(),width:18+10*Math.random(),hueShift:25*(Math.random()-.5)});return t}_initSparkles(e){const t=[];for(let s=0;s<e;s++)t.push({phase:Math.random()*Math.PI*2,speed:.6+.6*Math.random(),radiusFactor:.35+.5*Math.random(),heightFactor:.3+.6*Math.random(),size:1.5+1.8*Math.random(),twinkle:Math.random()*Math.PI*2,twinkleSpeed:.8+1.4*Math.random()});return t}_initHazeBands(e){const t=[];for(let s=0;s<e;s++)t.push({offset:38*s,amplitude:12+4*s,targetAmplitude:12+4*s,phase:Math.random()*Math.PI*2,speed:.4+.08*s});return t}_lerpHue(e,t,s){return e+((t-e+540)%360-180)*s}_updateBackdrop(){const e=this.backdropCanvas.width,t=this.backdropCanvas.height;if(!e||!t)return;const s=this.backdropCtx;s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,e,t);const a=s.createRadialGradient(.5*e,.8*t,Math.max(2,.08*e),.5*e,.4*t,.9*Math.max(e,t));a.addColorStop(0,`hsla(${this.palette.baseHue}, 70%, 45%, 0.28)`),a.addColorStop(1,"rgba(10, 8, 20, 0)"),s.fillStyle=a,s.fillRect(0,0,e,t);const i=s.createLinearGradient(0,0,e,t);i.addColorStop(0,`hsla(${(this.palette.baseHue+200)%360}, 60%, 16%, 0.25)`),i.addColorStop(1,`hsla(${(this.palette.accentHue+40)%360}, 60%, 22%, 0.22)`),s.globalCompositeOperation="lighter",s.fillStyle=i,s.fillRect(0,0,e,t),s.globalCompositeOperation="source-over"}onUpdate(e={}){const t=.14;this.metrics.subBass=this.lerp(this.metrics.subBass,e.subBassEnergy||0,t),this.metrics.bass=this.lerp(this.metrics.bass,e.bassEnergy||0,t),this.metrics.lowMid=this.lerp(this.metrics.lowMid,e.lowMidEnergy||0,t),this.metrics.mid=this.lerp(this.metrics.mid,e.midEnergy||0,t),this.metrics.upperMid=this.lerp(this.metrics.upperMid,e.upperMidEnergy||0,t),this.metrics.presence=this.lerp(this.metrics.presence,e.presenceEnergy||0,t),this.metrics.treble=this.lerp(this.metrics.treble,e.trebleEnergy||0,t),this.metrics.brilliance=this.lerp(this.metrics.brilliance,e.brillianceEnergy||0,t),this.metrics.ultrasonic=this.lerp(this.metrics.ultrasonic,e.ultrasonicEnergy||e.ultrasonicEnergy||0,t),this.metrics.rms=this.lerp(this.metrics.rms,e.rms||e.overallEnergy||0,.1);const s=Number.isFinite(e.spectralCentroidNormalized)?e.spectralCentroidNormalized:0;this.metrics.centroid=this.lerp(this.metrics.centroid,s,t);const a=Number.isFinite(e.stereoBalance)?e.stereoBalance:0;this.metrics.stereo=this.lerp(this.metrics.stereo,a,.08),this.metrics.energyChange=this.lerp(this.metrics.energyChange,e.energyChangeIntensity||0,.2),this.metrics.spectralFlux=this.lerp(this.metrics.spectralFlux,e.spectralFlux||0,.12),this.palette.targetBaseHue=(18+120*this.metrics.centroid+45*this.metrics.presence)%360,this.palette.targetAccentHue=(this.palette.targetBaseHue+80+50*this.metrics.brilliance)%360,this.palette.baseHue=this._lerpHue(this.palette.baseHue,this.palette.targetBaseHue,.06),this.palette.accentHue=this._lerpHue(this.palette.accentHue,this.palette.targetAccentHue,.08),this.palette.rimHue=(this.palette.baseHue+210)%360,this.flame.baseWidthTarget=120+180*this.metrics.bass+90*this.metrics.lowMid,this.flame.baseHeightTarget=230+220*this.metrics.mid+80*this.metrics.presence,this.flame.crestLeanTarget=this.metrics.stereo*(.4+.4*this.metrics.presence),this.flame.haloTarget=.22+.65*this.metrics.brilliance+.5*this.metrics.ultrasonic,this.flame.waveTarget=.16+.32*this.metrics.upperMid+.22*this.metrics.presence,this.flame.flicker=.35+1.2*this.metrics.treble+.4*this.metrics.brilliance;for(const e of this.auraLayers){const t=e.depth;e.targetWidth=this.flame.baseWidthTarget*(1-.32*t)*(1+.15*this.metrics.lowMid),e.targetHeight=this.flame.baseHeightTarget*(.68+.28*t+.2*this.metrics.mid),e.targetNoise=10+18*t+25*this.metrics.presence+18*this.metrics.treble,e.targetAlpha=this.constrain(.18+.28*(1-t)+.4*this.metrics.rms-.12*t,.06,.75),e.targetHueShift=30*-t+22*this.metrics.presence}for(const e of this.coronaPetals){const t=e.index/this.coronaPetals.length;e.targetScale=.8+1.1*this.metrics.presence+.25*t,e.targetAlpha=this.constrain(.12+.5*this.metrics.brilliance-.08*t,.04,.55),e.speed=.6+1.4*this.metrics.treble+.6*this.metrics.brilliance}for(const e of this.hazeBands)e.targetAmplitude=10+28*this.metrics.presence+12*this.metrics.treble;e.isBeat&&this.pulseRings.push({age:0,duration:1.25,maxRadius:1.4*this.flame.baseWidthTarget+.25*this.flame.baseHeightTarget,hueShift:40*(Math.random()-.5),thickness:6+12*this.metrics.presence,alpha:.45+.3*this.metrics.brilliance,rotation:Math.random()*Math.PI*2,pattern:["triangle","hex","glyph"][Math.floor(3*Math.random())]});const i=this.audioTriggers||{},r=i.dropStart||i.dropBloom,h=i.dropScore||0;r&&this.pulseRings.push({age:0,duration:1.6,maxRadius:1.8*this.flame.baseWidthTarget+.35*this.flame.baseHeightTarget,hueShift:90,thickness:8+16*this.metrics.bass+10*h,alpha:.55+.35*this.metrics.brilliance+.2*h,rotation:Math.random()*Math.PI,pattern:"burst"})}onRender(){const e=this.ctx;if(!e)return;const t=performance.now(),s=Math.min(.06,(t-this.lastRenderTime)/1e3);this.lastRenderTime=t,this.time+=s,this.flame.baseWidth=this.lerp(this.flame.baseWidth,this.flame.baseWidthTarget,.1),this.flame.baseHeight=this.lerp(this.flame.baseHeight,this.flame.baseHeightTarget,.1),this.flame.crestLean=this.lerp(this.flame.crestLean,this.flame.crestLeanTarget,.08),this.flame.halo=this.lerp(this.flame.halo,this.flame.haloTarget,.08),this.flame.wave=this.lerp(this.flame.wave,this.flame.waveTarget,.1),e.setTransform(1,0,0,1,0,0),e.fillStyle="rgba(5, 6, 9, 0.22)",e.fillRect(0,0,this.width,this.height),this._renderBackdrop(e),this._renderAura(e,s),this._renderHalo(e),this._renderCorona(e,s),this._renderPulseRings(e,s),this._renderHaze(e,s),this._renderSparkles(e,s)}_renderBackdrop(e){this._updateBackdrop(),e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=.9,e.drawImage(this.backdropCanvas,0,0,this.backdropCanvas.width,this.backdropCanvas.height,0,0,this.width,this.height),e.restore()}_renderAura(e,t){e.save(),e.translate(this.centerX,this.baseY),e.globalCompositeOperation="lighter";for(const s of this.auraLayers){s.width=this.lerp(s.width,s.targetWidth,.1),s.height=this.lerp(s.height,s.targetHeight,.1),s.noise=this.lerp(s.noise,s.targetNoise,.12),s.alpha=this.lerp(s.alpha,s.targetAlpha,.12),s.hueShift=this.lerp(s.hueShift,s.targetHueShift,.1),s.phase+=t*(this.flame.flicker*s.rippleSpeed+.4);const a=e.createLinearGradient(0,0,0,-s.height),i=(this.palette.baseHue+s.hueShift+8*Math.sin(.6*this.time+s.index))%360,r=(this.palette.accentHue+s.hueShift)%360;a.addColorStop(0,`hsla(${i}, 78%, 48%, ${s.alpha})`),a.addColorStop(.55,`hsla(${r}, 92%, 70%, ${.65*s.alpha})`),a.addColorStop(1,`hsla(${r}, 92%, 78%, 0)`),e.beginPath(),e.moveTo(-s.width,0);for(let t=1;t<=26;t++){const a=t/26,i=Math.pow(1-a,s.taper),r=s.width*(i+.2*i*Math.sin(a*Math.PI*2+s.phase)*this.flame.wave),h=this.flame.crestLean*a*s.height,l=Math.sin(a*(6+4*s.depth)+s.phase)*s.noise,n=-a*s.height-l,o=-r+h;e.lineTo(o,n)}for(let t=26;t>=0;t--){const a=t/26,i=Math.pow(1-a,s.taper),r=s.width*(i+.2*i*Math.sin((a+.2)*Math.PI*2-s.phase)*this.flame.wave),h=this.flame.crestLean*a*s.height,l=Math.sin(a*(6+5*s.depth)-s.phase)*s.noise,n=-a*s.height-l,o=r+h;e.lineTo(o,n)}e.closePath(),e.shadowBlur=40+18*s.depth,e.shadowColor=`hsla(${i}, 82%, 60%, ${s.alpha})`,e.fillStyle=a,e.fill()}e.restore()}_renderHalo(e){const t=.7*this.flame.baseWidth,s=e.createRadialGradient(this.centerX,this.baseY,.2*t,this.centerX,this.baseY,Math.max(1.8*t,1));s.addColorStop(0,`hsla(${(this.palette.baseHue+20)%360}, 90%, 58%, ${this.flame.halo})`),s.addColorStop(1,"rgba(15, 12, 30, 0)"),e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=.85,e.fillStyle=s,e.fillRect(this.centerX-2*t,this.baseY-2.4*t,4*t,4.4*t),e.restore()}_renderCorona(e,t){e.save(),e.translate(this.centerX,this.baseY-.85*this.flame.baseHeight),e.globalCompositeOperation="screen";for(const s of this.coronaPetals){s.scale=this.lerp(s.scale,s.targetScale,.12),s.alpha=this.lerp(s.alpha,s.targetAlpha,.12),s.angle+=t*s.speed*(1+.6*this.flame.wave);const a=s.length*s.scale,i=s.width*(.6+.8*this.flame.wave),r=(this.palette.accentHue+s.hueShift)%360;e.save(),e.rotate(s.angle+.4*this.flame.crestLean);const h=e.createLinearGradient(0,0,0,-a);h.addColorStop(0,`hsla(${r}, 90%, 72%, ${s.alpha})`),h.addColorStop(1,`hsla(${(r+40)%360}, 80%, 80%, 0)`),e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(-i,.45*-a,.2*-i,-a),e.lineTo(.2*i,-a),e.quadraticCurveTo(i,.45*-a,0,0),e.fillStyle=h,e.fill(),e.restore()}e.restore()}_renderPulseRings(e,t){if(this.pulseRings.length){e.save(),e.translate(this.centerX,this.baseY-.35*this.flame.baseHeight),e.globalCompositeOperation="screen";for(let s=this.pulseRings.length-1;s>=0;s--){const a=this.pulseRings[s];a.age+=t;const i=a.age/a.duration;if(i>=1){this.pulseRings.splice(s,1);continue}const r=Math.pow(i,.65),h=a.maxRadius*r,l=a.alpha*(1-i),n=Math.max(1.2,a.thickness*(1-.5*i)),o=(this.palette.accentHue+a.hueShift)%360;if(e.lineWidth=n,e.strokeStyle=`hsla(${o}, 92%, 72%, ${l})`,e.beginPath(),e.arc(0,0,h,0,2*Math.PI),e.stroke(),"triangle"===a.pattern||"hex"===a.pattern||"glyph"===a.pattern){const t="triangle"===a.pattern?3:"hex"===a.pattern?6:5;e.save(),e.rotate(a.rotation+r*Math.PI*.5),e.lineWidth=.45*n,e.strokeStyle=`hsla(${(o+30)%360}, 88%, 75%, ${.6*l})`,e.beginPath();for(let s=0;s<=t;s++){const a=s/t*Math.PI*2;e.lineTo(Math.cos(a)*h*.72,Math.sin(a)*h*.72)}e.stroke(),e.restore()}else if("burst"===a.pattern){e.save(),e.rotate(a.rotation+r*Math.PI*.3),e.strokeStyle=`hsla(${(o+80)%360}, 90%, 78%, ${.5*l})`,e.lineWidth=.35*n,e.beginPath();for(let t=0;t<8;t++){const s=t/8*Math.PI*2,a=.4*h,i=.95*h;e.moveTo(Math.cos(s)*a,Math.sin(s)*a),e.lineTo(Math.cos(s)*i,Math.sin(s)*i)}e.stroke(),e.restore()}}e.restore()}}_renderHaze(e,t){e.save(),e.globalCompositeOperation="screen",e.lineCap="round";for(const s of this.hazeBands){s.amplitude=this.lerp(s.amplitude,s.targetAmplitude,.1),s.phase+=t*s.speed*(1+.5*this.flame.wave);const a=this.baseY-this.flame.baseHeight-s.offset;e.beginPath(),e.moveTo(this.centerX-1.2*this.flame.baseWidth,a);for(let t=0;t<=60;t++){const i=t/60,r=this.centerX-1.2*this.flame.baseWidth+i*this.flame.baseWidth*2.4,h=a-Math.sin(i*Math.PI*6+s.phase)*s.amplitude*(.4+.6*i);e.lineTo(r,h)}e.strokeStyle=`hsla(${(this.palette.rimHue+20)%360}, 70%, 65%, ${.08+.12*this.metrics.brilliance})`,e.lineWidth=2.2+3*this.metrics.treble,e.shadowBlur=12,e.shadowColor=`hsla(${this.palette.rimHue}, 72%, 68%, 0.3)`,e.stroke()}e.restore()}_renderSparkles(e,t){e.save(),e.globalCompositeOperation="screen";for(const s of this.sparkles){s.phase+=t*s.speed*(1+1.1*this.metrics.treble),s.twinkle+=t*s.twinkleSpeed*(1+.8*this.metrics.brilliance);const a=this.flame.baseWidth*s.radiusFactor*(1+.3*this.metrics.presence),i=this.baseY-this.flame.baseHeight*s.heightFactor,r=this.centerX+Math.sin(s.phase)*a+this.flame.crestLean*this.flame.baseHeight*.3,h=i-Math.cos(.8*s.phase)*a*.2,l=.2+.2*Math.sin(s.twinkle)+.4*this.metrics.brilliance,n=s.size*(.8+.6*this.metrics.treble),o=(this.palette.rimHue+25*Math.sin(1.2*s.phase))%360,c=e.createRadialGradient(r,h,0,r,h,2*n);c.addColorStop(0,`hsla(${o}, 90%, 80%, ${l})`),c.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=c,e.beginPath(),e.arc(r,h,2.2*n,0,2*Math.PI),e.fill()}e.restore()}}"undefined"!=typeof window&&(window.DivineFlameVisualizer=DivineFlameVisualizer);