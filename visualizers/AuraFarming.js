class AuraFarmingVisualizer extends BaseVisualizer{constructor(t=null,i={}){super(t,{debug:!1,stereoMode:!0,...i})}async init(){this.centerX=0,this.centerY=0,this.updateDimensions(),this.threads={low:[],mid:[],high:[],stereo:[]},this.spirals={left:{particles:[],rotation:0,direction:1,color:"#00d9ff"},right:{particles:[],rotation:0,direction:-1,color:"#ff00ff"}},this.ring=null,this.dust=[],this.dustMaxCount=200,this.explosions=[],this.explosionMaxCount=500,this.audioCache={lowEnergy:0,midEnergy:0,highEnergy:0,leftEnergy:0,rightEnergy:0,spectralFlux:0,onsetDetected:!1,lastTotalEnergy:0},this.time=0,this.phase=0,this.auraMovement={left:{baseX:-80,baseY:20,orbitRadius:50,orbitSpeed:.02,floatSpeed:.015,angle:0},right:{baseX:80,baseY:20,orbitRadius:50,orbitSpeed:-.018,floatSpeed:.012,angle:Math.PI}},this.smoothedLow=0,this.smoothedMid=0,this.smoothedHigh=0,this.smoothedFlux=0}updateDimensions(){this.centerX=this.width/2,this.centerY=this.height/2,this.figure||(this.figure={headRadius:0,bodyLength:0,shoulderWidth:0,legSpacing:0,seated:!0})}onResize(){this.updateDimensions()}onUpdate(t){if(!t)return;const i=t.aWeighted?.left?.normalized??0,e=t.aWeighted?.right?.normalized??0,s=t.aWeighted?.mono?.normalized??0;this.audioCache.leftEnergy=i,this.audioCache.rightEnergy=e,this.audioCache.overallEnergy=s,t.subBassEnergy;const h=t.bassEnergy??0,a=(t.lowMidEnergy,t.midEnergy??0),o=(t.upperMidEnergy,t.presenceEnergy,t.trebleEnergy??0),r=t.brillianceEnergy??0,n=t.ultrassonicEnergy??0;this.smoothedLow=.8*this.smoothedLow+.2*h,this.smoothedMid=.8*this.smoothedMid+.2*a,this.smoothedHigh=.8*this.smoothedHigh+(o+r+n)/3*.2,this.audioCache.onsetDetected=t.isBeat??!1,this.audioCache.enhancedBassDropDetected=t.bassDrop??!1,this.audioCache.enhancedBassDropIntensity=t.bassDropIntensity??0,this.audioCache.massiveEnergyChangeDetected=t.isMassiveEnergyChange??!1,this.audioCache.energyChangeIntensity=t.energyChangeIntensity??0,this.audioCache.massiveEnergyChangeDetected&&(this.triggerExplosion("left",this.audioCache.energyChangeIntensity),this.triggerExplosion("right",this.audioCache.energyChangeIntensity)),this.smoothedFlux=.9*this.smoothedFlux+.1*(t.spectralFlux??0),this.audioCache.spectralCentroid=t.spectralCentroidNormalized??0,this.audioCache.spectralFlatness=t.spectralFlatnessSmoothed??0,this.audioCache.activeBandRatio=t.activeBandRatio??0,this.audioCache.stereoBalance=t.stereoBalance??0,this.audioCache.rmsDifference=t.rmsDifference??0,this.audioCache.stereoSpread=t.stereoSpread??0,this.updateThreads(),this.updateAuraMovement(),this.updateSpiritals(),this.updateRings(),this.updateDust(),this.updateExplosions(),this.time=t.time??this.time+1,this.phase=this.time*Math.PI/180%(2*Math.PI)}updateAuraMovement(){for(let t of["left","right"]){const i=this.auraMovement[t];i.angle+=i.orbitSpeed;const e=this.smoothedLow+this.smoothedMid+this.smoothedHigh,s=isFinite(e)?30*e:0,h=i.orbitRadius+s,a=isFinite(this.time)?this.time:0,o=20*Math.sin(a*i.floatSpeed),r=15*Math.cos(a*i.floatSpeed*.7),n=Math.cos(i.angle)*h,c=Math.sin(i.angle)*h*.6;i.currentX=isFinite(i.baseX+n+o)?i.baseX+n+o:i.baseX,i.currentY=isFinite(i.baseY+c+r)?i.baseY+c+r:i.baseY}}updateThreads(){Math.max(this.width,this.height);if(0===this.threads.low.length)for(let t=0;t<12;t++)this.threads.low.push([]),this.threads.mid.push([]),this.threads.high.push([]);for(let t=0;t<12;t++){const i=t/12*Math.PI*2;this.smoothedLow,this.centerX,Math.cos(i),this.centerY,Math.sin(i),this.smoothedMid,this.centerX,Math.cos(i+.3*this.phase),this.centerY,Math.sin(i+.3*this.phase),this.smoothedHigh,this.centerX,Math.cos(i+.5*this.phase),this.centerY,Math.sin(i+.5*this.phase)}}updateSpiritals(){const t=this.audioCache.leftEnergy,i=this.audioCache.rightEnergy;this.spirals.left.rotation+=.15*t,this.spirals.right.rotation-=.15*i,this.updateSpiralParticles(this.spirals.left,t),this.updateSpiralParticles(this.spirals.right,i)}updateSpiralParticles(t,i){const e=Math.floor(100*i)+12,s=Math.max(this.width,this.height),h=.8*s,a=.05*s;for(;t.particles.length<e;)t.particles.push({angle:Math.random()*Math.PI*2,distance:a+Math.random()*(h-a),age:0,lifetime:60});for(;t.particles.length>e;)t.particles.pop();for(let e of t.particles)e.age++,e.angle+=t.direction*i*.08,e.distance+=2*i,e.age>e.lifetime&&(e.age=0,e.distance=a+Math.random()*(h-a),e.angle=Math.random()*Math.PI*2)}updateRings(){const t=this.smoothedLow;if(this.audioCache.enhancedBassDropDetected||this.audioCache.onsetDetected&&t>.5){const i=this.audioCache.enhancedBassDropIntensity||t/255,e=Math.max(this.width,this.height)*(.6+.4*i);this.ring={radius:0,maxRadius:e,age:0,lifetime:30+20*i,color:`rgba(255, ${Math.floor(100+100*i)}, 0, ${.4+.4*i})`}}this.ring&&(this.ring.age++,this.ring.radius=this.ring.age/this.ring.lifetime*this.ring.maxRadius,this.ring.age>this.ring.lifetime&&(this.ring=null))}updateDust(){const t=this.smoothedHigh,i=Math.floor(5*t),e=1.2*Math.sqrt(Math.pow(this.width/2,2)+Math.pow(this.height/2,2));for(let t=0;t<i;t++)if(this.dust.length<this.dustMaxCount){const t=Math.random()*Math.PI*2,i=Math.random()*e;this.dust.push({x:this.centerX+Math.cos(t)*i,y:this.centerY+Math.sin(t)*i,vx:2*(Math.random()-.5),vy:2*(Math.random()-.5),age:0,lifetime:100,brightness:.7*Math.random()+.3})}for(let t=this.dust.length-1;t>=0;t--){const i=this.dust[t];i.age++,i.x+=i.vx,i.y+=i.vy,i.vx*=.98,i.vy*=.98,i.age>i.lifetime&&this.dust.splice(t,1)}}triggerExplosion(t,i){const e=this.auraMovement[t],s=this.centerX+e.currentX,h=this.centerY+e.currentY,a="left"===t?"#00d9ff":"#ff00ff",o=Math.floor(100*i)+30;for(let t=0;t<o&&this.explosions.length<this.explosionMaxCount;t++){const t=Math.random()*Math.PI*2,e=(5+15*Math.random())*i;this.explosions.push({x:s,y:h,vx:Math.cos(t)*e,vy:Math.sin(t)*e,age:0,lifetime:60+40*Math.random(),size:2+4*Math.random(),color:a,brightness:.8+.2*Math.random(),decay:.98-.02*Math.random()})}}updateExplosions(){for(let t=this.explosions.length-1;t>=0;t--){const i=this.explosions[t];i.age++,i.x+=i.vx,i.y+=i.vy,i.vx*=i.decay,i.vy*=i.decay,i.vy+=.1,i.age>i.lifetime&&this.explosions.splice(t,1)}}onRender(){this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor||"#000",this.ctx.fillRect(0,0,this.width,this.height)),this.drawConcentriCRings(),this.drawThreads(),this.drawSpiralArms(),this.drawCosmicDust(),this.drawExplosions()}drawConcentriCRings(){if(!this.ring)return;const t=this.ring,i=1-t.age/t.lifetime;this.ctx.strokeStyle=`rgba(255, 100, 0, ${1*i})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.arc(this.centerX,this.centerY,t.radius,0,2*Math.PI),this.ctx.stroke(),this.ctx.strokeStyle=`rgba(255, 150, 0, ${.5*i})`,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(this.centerX,this.centerY,t.radius+2,0,2*Math.PI),this.ctx.stroke()}drawThreads(){for(let t=0;t<12;t++){const i=t/12*Math.PI*2,e=.4*Math.max(this.width,this.height),s=this.smoothedLow*e,h=this.centerX+Math.cos(i)*s,a=this.centerY+Math.sin(i)*s;this.smoothedLow>.1&&(this.ctx.strokeStyle=`rgba(255, 100, 0, ${.2+.3*this.smoothedLow})`,this.ctx.lineWidth=1+2*this.smoothedLow,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(this.centerX,this.centerY),this.ctx.lineTo(h,a),this.ctx.stroke());const o=this.smoothedMid*e*.7+.5*e,r=this.centerX+Math.cos(i+.3*this.phase)*o,n=this.centerY+Math.sin(i+.3*this.phase)*o;this.smoothedMid>.1&&(this.ctx.strokeStyle=`rgba(0, 255, 150, ${.2+.3*this.smoothedMid})`,this.ctx.lineWidth=1+1.5*this.smoothedMid,this.ctx.beginPath(),this.ctx.moveTo(this.centerX,this.centerY),this.ctx.lineTo(r,n),this.ctx.stroke());const c=this.smoothedHigh*e*.4+.3*e,d=this.centerX+Math.cos(i+.5*this.phase)*c,l=this.centerY+Math.sin(i+.5*this.phase)*c;this.smoothedHigh>.1&&(this.ctx.strokeStyle=`rgba(150, 220, 255, ${.3+.2*this.smoothedHigh})`,this.ctx.lineWidth=1+1.5*this.smoothedHigh,this.ctx.beginPath(),this.ctx.moveTo(this.centerX,this.centerY),this.ctx.lineTo(d,l),this.ctx.stroke(),this.ctx.strokeStyle=`rgba(200, 255, 255, ${.15*this.smoothedHigh})`,this.ctx.lineWidth=2+1.5*this.smoothedHigh,this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.moveTo(this.centerX,this.centerY),this.ctx.lineTo(d,l),this.ctx.stroke(),this.ctx.globalAlpha=1)}}drawSpiralArms(){this.drawSpiral(this.spirals.left,this.auraMovement.left.currentX,this.auraMovement.left.currentY),this.drawSpiral(this.spirals.right,this.auraMovement.right.currentX,this.auraMovement.right.currentY)}drawSpiral(t,i,e){const s=this.centerX+(isFinite(i)?i:0),h=this.centerY+(isFinite(e)?e:0);let a=50;if(t.particles.length>0){const i=t.particles.map(t=>isFinite(t.distance)?t.distance:0);a=i.reduce((t,i)=>t+i,0)/i.length}let o=a+20;o=Math.min(Math.max(o,40),150);const r=.3+.2*(isFinite(this.smoothedHigh)?this.smoothedHigh:0),n=this.ctx.createRadialGradient(s,h,0,s,h,o);1===t.direction?(n.addColorStop(0,`rgba(0,220,255,${r})`),n.addColorStop(1,"rgba(0,220,255,0)")):(n.addColorStop(0,`rgba(255,0,220,${r})`),n.addColorStop(1,"rgba(255,0,220,0)")),this.ctx.fillStyle=n,this.ctx.fillRect(s-o,h-o,2*o,2*o);for(let i of t.particles){const e=isFinite(i.angle)?i.angle:0,a=isFinite(i.distance)?i.distance:0,o=s+Math.cos(e)*a,r=h+Math.sin(e)*a,n=1-i.age/i.lifetime,c=(2+a/50)*(1+.5*(isFinite(this.smoothedHigh)?this.smoothedHigh:0));this.ctx.fillStyle=`${t.color.slice(0,-1)},${n})`,this.ctx.beginPath(),this.ctx.arc(o,r,c,0,2*Math.PI),this.ctx.fill()}}drawCosmicDust(){for(let t of this.dust){const i=1-t.age/t.lifetime,e=t.brightness,s=.5*Math.sin(.1*this.time+t.age)+.5;this.ctx.fillStyle=`rgba(150, 220, 255, ${i*e*s})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1+2*s,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=`rgba(200, 255, 255, ${i*e*s*.5})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,3+5*s,0,2*Math.PI),this.ctx.fill()}}drawExplosions(){for(let t of this.explosions){const i=1-t.age/t.lifetime,e=t.brightness,s=1-t.age/t.lifetime*.5,h=t.size*s,a=t.color.match(/#(\w{2})(\w{2})(\w{2})/);if(a){const s=parseInt(a[1],16),o=parseInt(a[2],16),r=parseInt(a[3],16);if(this.ctx.fillStyle=`rgba(${s}, ${o}, ${r}, ${i*e})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,h,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=`rgba(${s}, ${o}, ${r}, ${i*e*.3})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,2*h,0,2*Math.PI),this.ctx.fill(),Math.sqrt(t.vx*t.vx+t.vy*t.vy)>3){const a=t.x-.5*t.vx,n=t.y-.5*t.vy;this.ctx.strokeStyle=`rgba(${s}, ${o}, ${r}, ${i*e*.4})`,this.ctx.lineWidth=.5*h,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(a,n),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()}}}}destroy(){super.destroy()}}"undefined"!=typeof window&&(window.AuraFarmingVisualizer=AuraFarmingVisualizer);