class AuraFarmingVisualizer extends BaseVisualizer{constructor(t=null,e={}){super(t,{debug:!1,stereoMode:!0,...e})}async init(){this.centerX=0,this.centerY=0,this.updateDimensions(),this.isMobile="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches,this.threads={low:[],mid:[],high:[],stereo:[]},this.threadHistoryLength=this.isMobile?24:36,this.threadAngles=[],this.spirals={left:{particles:[],rotation:0,direction:1,color:"#00d9ff"},right:{particles:[],rotation:0,direction:-1,color:"#ff00ff"}},this.rings=[],this.dust=[],this.dustMaxCount=this.isMobile?80:200,this.explosions=[],this.explosionMaxCount=this.isMobile?220:500,this.stereoVeils={left:{points:[],hue:180},right:{points:[],hue:315},maxPoints:this.isMobile?32:60},this.coreShape={rotation:0,twist:0,pulse:0,petals:8},this.harmonicRibbons=[],this.audioCache={lowEnergy:0,midEnergy:0,highEnergy:0,leftEnergy:0,rightEnergy:0,overallEnergy:0,spectralFlux:0,spectralCentroid:0,spectralFlatness:0,activeBandRatio:0,stereoBalance:0,stereoSpread:0,stereoContrast:0,onsetDetected:!1,enhancedBassDropDetected:!1,enhancedBassDropIntensity:0,massiveEnergyChangeDetected:!1,energyChangeIntensity:0,lastTotalEnergy:0},this.time=0,this.phase=0,this.massiveEventCooldown=1.25,this._lastFrameTimestamp="undefined"!=typeof performance?.001*performance.now():.001*Date.now(),this.auraMovement={left:{baseX:-80,baseY:20,orbitRadius:50,orbitSpeed:.02,floatSpeed:.015,angle:0},right:{baseX:80,baseY:20,orbitRadius:50,orbitSpeed:-.018,floatSpeed:.012,angle:Math.PI}},this.smoothedLow=0,this.smoothedMid=0,this.smoothedHigh=0,this.smoothedFlux=0,this.smoothedSub=0,this.smoothedPresence=0,this.smoothedBrilliance=0,this.smoothedBalance=0,this.smoothedSpread=0}updateDimensions(){this.centerX=this.width/2,this.centerY=this.height/2,this.figure||(this.figure={headRadius:0,bodyLength:0,shoulderWidth:0,legSpacing:0,seated:!0})}onResize(){this.updateDimensions()}onUpdate(t){if(!t)return;const e="undefined"!=typeof performance?.001*performance.now():.001*Date.now(),i=e-(this._lastFrameTimestamp??e),s=Math.min(.5,Math.max(1/240,i));this._lastFrameTimestamp=e,this.massiveEventCooldown=Math.max(0,this.massiveEventCooldown-s),i>.35&&(this.massiveEventCooldown=Math.max(this.massiveEventCooldown,1));const h=t.aWeighted?.left?.normalized??0,a=t.aWeighted?.right?.normalized??0,o=t.aWeighted?.mono?.normalized??0;this.audioCache.leftEnergy=h,this.audioCache.rightEnergy=a,this.audioCache.overallEnergy=o;const r=t.subBassEnergy??0,n=t.bassEnergy??t.bassEnergy??0,l=t.bassEnergy??t.bassEnergy??0,d=t.lowMidEnergy??0,c=t.midEnergy??0,m=t.upperMidEnergy??0,p=t.presenceEnergy??t.presenceEnergy??0,g=t.trebleEnergy??0,u=t.brillianceEnergy??0,M=t.ultrasonicEnergy??0,f=(n+l+r)/3,y=(c+d)/2,x=(m+p+g+u+M)/5;this.smoothedLow=.78*this.smoothedLow+.22*f,this.smoothedSub=.82*this.smoothedSub+(r+l)/2*.18,this.smoothedMid=.8*this.smoothedMid+.2*y,this.smoothedHigh=.78*this.smoothedHigh+.22*x,this.smoothedPresence=.82*this.smoothedPresence+(p+m)/2*.18,this.smoothedBrilliance=.82*this.smoothedBrilliance+(g+u+M)/3*.18,this.audioCache.onsetDetected=t.isBeat??!1,this.audioCache.enhancedBassDropDetected=t.bassDrop??!1,this.audioCache.enhancedBassDropIntensity=t.bassDropIntensity??0,this.audioCache.massiveEnergyChangeDetected=t.isMassiveEnergyChange??!1,this.audioCache.energyChangeIntensity=t.energyChangeIntensity??0;const b=this.massiveEventCooldown<=0;this.audioCache.massiveEnergyChangeDetected&&b&&(this.triggerExplosion("left",this.audioCache.energyChangeIntensity),this.triggerExplosion("right",this.audioCache.energyChangeIntensity),this.massiveEventCooldown=.9),this.smoothedFlux=.9*this.smoothedFlux+.1*(t.spectralFlux??0),this.audioCache.spectralCentroid=t.spectralCentroidNormalized??0,this.audioCache.spectralFlatness=t.spectralFlatnessSmoothed??0,this.audioCache.activeBandRatio=t.activeBandRatio??0,this.audioCache.stereoBalance=t.stereoBalance??0,this.audioCache.rmsDifference=t.rmsDifference??0,this.audioCache.stereoSpread=t.stereoSpread??0,this.audioCache.stereoContrast=Math.abs(h-a),this.smoothedBalance=.85*this.smoothedBalance+.15*this.audioCache.stereoBalance,this.smoothedSpread=.85*this.smoothedSpread+.15*this.audioCache.stereoSpread,this.updateThreads(),this.updateAuraMovement(),this.updateSpiritals(),this.updateRings(),this.updateStereoVeils(),this.updateHarmonicRibbons(),this.updateCoreShape(),this.updateDust(),this.updateExplosions(),this.time=t.time??this.time+1,this.phase=this.time*Math.PI/180%(2*Math.PI)}updateAuraMovement(){for(let t of["left","right"]){const e=this.auraMovement[t];e.angle+=e.orbitSpeed;const i=this.smoothedLow+this.smoothedMid+this.smoothedHigh,s=isFinite(i)?30*i:0,h=e.orbitRadius+s,a=isFinite(this.time)?this.time:0,o=20*Math.sin(a*e.floatSpeed),r=15*Math.cos(a*e.floatSpeed*.7),n=Math.cos(e.angle)*h,l=Math.sin(e.angle)*h*.6;e.currentX=isFinite(e.baseX+n+o)?e.baseX+n+o:e.baseX,e.currentY=isFinite(e.baseY+l+r)?e.baseY+l+r:e.baseY}}updateThreads(){const t=this.isMobile?8:14,e=.45*Math.max(this.width,this.height);if(this.threads.low.length!==t){this.threads.low=[],this.threads.mid=[],this.threads.high=[],this.threads.stereo=[];for(let e=0;e<t;e++)this.threads.low.push([]),this.threads.mid.push([]),this.threads.high.push([]),this.threads.stereo.push([])}this.threadAngles.length!==t&&(this.threadAngles=Array.from({length:t},(e,i)=>i/t*Math.PI*2));const i=this.audioCache.spectralCentroid,s=isFinite(this.smoothedFlux)?this.smoothedFlux:0,h=isFinite(this.smoothedSpread)?this.smoothedSpread:0,a=isFinite(this.smoothedBalance)?this.smoothedBalance:0,o=this.audioCache.stereoContrast??0,r=this.smoothedLow,n=this.smoothedSub,l=this.smoothedMid,d=this.smoothedPresence,c=this.smoothedHigh,m=this.smoothedBrilliance;for(let p=0;p<t;p++){const t=this.threadAngles[p],g=Math.sin(.01*(this.time+20*p))*s*.6,u=t+this.phase*(.18+.25*i)+g,M=e*(.18+.6*r+.4*n),f=u+.2*Math.sin(.005*this.time+p)*(1+s),y=this.centerX+Math.cos(f)*M,x=this.centerY+Math.sin(f)*(M*(.8+.3*n));this.pushThreadPoint(this.threads.low[p],{x:isFinite(y)?y:this.centerX,y:isFinite(x)?x:this.centerY,alpha:.3+.5*r,width:2+4*r});const b=e*(.35+.4*l+.2*d),w=u+.4*this.phase+.4*s,C=this.centerX+Math.cos(w)*b,S=this.centerY+Math.sin(w)*(b*(.9+.2*d));this.pushThreadPoint(this.threads.mid[p],{x:isFinite(C)?C:this.centerX,y:isFinite(S)?S:this.centerY,alpha:.15+.45*l,width:1.5+3*l});const v=e*(.55+.3*c+.4*m),$=u+.7*this.phase+.6*s,P=this.centerX+Math.cos($)*v,I=this.centerY+Math.sin($)*(v*(.85+.2*s));this.pushThreadPoint(this.threads.high[p],{x:isFinite(P)?P:this.centerX,y:isFinite(I)?I:this.centerY,alpha:.12+.4*c+.3*m,width:1+2*c});const E=e*(.25+.5*h+.3*o),F=t+a*Math.PI*.35,B=this.centerX+Math.cos(F)*E,R=this.centerY+Math.sin(F)*E*(.7+.4*h);this.pushThreadPoint(this.threads.stereo[p],{x:isFinite(B)?B:this.centerX,y:isFinite(R)?R:this.centerY,alpha:.18+.5*o,width:1.2+2.5*h});let D=t+.002+.01*s+.008*c;D%=2*Math.PI,D<0&&(D+=2*Math.PI),this.threadAngles[p]=D}}pushThreadPoint(t,e){t.push(e),t.length>this.threadHistoryLength&&t.shift()}updateSpiritals(){const t=this.audioCache.leftEnergy,e=this.audioCache.rightEnergy;this.spirals.left.rotation+=.15*t,this.spirals.right.rotation-=.15*e,this.updateSpiralParticles(this.spirals.left,t),this.updateSpiralParticles(this.spirals.right,e)}updateSpiralParticles(t,e){const i=Math.floor(100*e)+12,s=Math.max(this.width,this.height),h=.8*s,a=.05*s;for(;t.particles.length<i;)t.particles.push({angle:Math.random()*Math.PI*2,distance:a+Math.random()*(h-a),age:0,lifetime:60});for(;t.particles.length>i;)t.particles.pop();for(let i of t.particles)i.age++,i.angle+=t.direction*e*.08,i.distance+=2*e,i.age>i.lifetime&&(i.age=0,i.distance=a+Math.random()*(h-a),i.angle=Math.random()*Math.PI*2)}updateRings(){const t=this.smoothedLow,e=this.smoothedPresence,i=this.smoothedBrilliance,s=this.audioCache.spectralCentroid??0;if(this.audioCache.enhancedBassDropDetected||this.audioCache.onsetDetected&&t>.45){const e=Math.min(1,this.audioCache.enhancedBassDropIntensity||t),i=Math.max(this.width,this.height)*(.55+.45*e);this.rings.push({radius:0,maxRadius:isFinite(i)?i:0,age:0,lifetime:36+28*e,hue:30+20*e,alpha:.22+.22*e,lineWidth:3+6*e,glow:.18+.22*e,tilt:.3+.25*e,yaw:Math.random()*Math.PI*2,yawSpeed:(.004+.012*e)*(Math.random()>.5?1:-1),verticalOffset:0})}if(this.audioCache.onsetDetected&&e>.35){const t=Math.min(1,e+.5*i),h=Math.max(this.width,this.height)*(.4+.35*t);this.rings.push({radius:0,maxRadius:isFinite(h)?h:0,age:0,lifetime:50,hue:160+120*s,alpha:.15+.2*t,lineWidth:1.5+4*t,glow:.12+.18*t,tilt:.2+.22*t,yaw:Math.random()*Math.PI*2,yawSpeed:(.003+.01*t)*(Math.random()>.5?1:-1),verticalOffset:0})}for(let t=this.rings.length-1;t>=0;t--){const e=this.rings[t];e.age++;const i=e.lifetime?e.age/e.lifetime:1;if(e.radius=e.maxRadius*Math.min(1,i),"number"==typeof e.yaw){const t=e.yawSpeed||0;e.yaw+=t,(e.yaw>2*Math.PI||e.yaw<2*-Math.PI)&&(e.yaw=e.yaw%(2*Math.PI));const i=Math.max(.08,Math.min(.75,e.tilt??.3));e.tilt=i,e.verticalOffset=Math.sin(e.yaw)*i*e.radius*.25}e.age>e.lifetime&&this.rings.splice(t,1)}}updateStereoVeils(){const{left:t,right:e,maxPoints:i}=this.stereoVeils,s=Math.max(0,this.smoothedSpread),h=this.smoothedBalance,a=Math.min(1,this.audioCache.stereoContrast??0),o=Math.min(1,1.2*(this.audioCache.overallEnergy??0)),r=this.isMobile?2.2:4,n=Math.max(0,Math.floor((s+a+o)*r)),l=(t,e)=>{for(let r=0;r<n&&!(t.points.length>=i);r++){const i=.18*this.width+s*this.width*.15,r=this.centerX+e*(i+h*this.width*.08),n=this.centerY+(Math.random()-.5)*this.height*(.8+.4*s);t.points.push({x:isFinite(r)?r:this.centerX,y:isFinite(n)?n:this.centerY,vx:e*(.6+3*a+2*s)*(this.isMobile?.6:1),vy:(Math.random()-.5)*(2+4*s)*(this.isMobile?.6:1),age:0,lifetime:(this.isMobile?70:110)+Math.random()*(this.isMobile?25:40),alpha:.08+.22*a+.22*o,size:(this.isMobile?18:24)+Math.random()*(this.isMobile?60:90),wobble:Math.random()*Math.PI*2})}};l(t,-1),l(e,1);const d=t=>{for(let e=t.points.length-1;e>=0;e--){const i=t.points[e];i.age++,i.x+=i.vx,i.y+=i.vy,i.vx*=.99,i.vy*=.99,i.y+=.6*Math.sin(.02*this.time+i.wobble),i.age>i.lifetime&&t.points.splice(e,1)}};d(t),d(e)}updateHarmonicRibbons(){const t=this.isMobile?3:5;if(this.harmonicRibbons.length!==t){this.harmonicRibbons=[];for(let e=0;e<t;e++)this.harmonicRibbons.push({baseRatio:.18+.1*e,rotation:Math.random()*Math.PI*2,seed:500*Math.random(),thickness:4,opacity:.2,hueShift:60*Math.random()})}const e=.3*Math.min(this.width,this.height),i=.5*this.smoothedMid+.35*this.smoothedPresence,s=this.smoothedBrilliance,h=this.audioCache.spectralCentroid??0;for(let t of this.harmonicRibbons){t.rotation+=.01+.05*i+.04*h;const a=Math.sin(.01*(this.time+t.seed))*(.2+.6*this.audioCache.spectralFlatness);t.radius=e*(.8+t.baseRatio+.2*a)+120*this.smoothedLow;const o=6+20*i+10*s;t.thickness=this.isMobile?.55*o:o;const r=.12+.3*i+.25*s;t.opacity=this.isMobile?Math.min(.35,.6*r):r,t.waveOffset=a}}updateCoreShape(){const t=this.audioCache.overallEnergy??0,e=this.smoothedFlux,i=this.smoothedBrilliance,s=this.smoothedHigh,h=this.smoothedPresence,a=this.audioCache.spectralCentroid??0,o=this.audioCache.activeBandRatio??0;this.coreShape.rotation+=.01+.12*t+.08*a,this.coreShape.twist=.2+.6*e+.4*i,this.coreShape.pulse=.3+.4*t+.35*s+.25*h;const r=6+Math.floor(6*o+4*i);this.coreShape.petals=Math.max(5,Math.min(12,r))}updateDust(){const t=this.smoothedHigh,e=this.isMobile?1.5:5,i=Math.floor(t*e),s=1.2*Math.sqrt(Math.pow(this.width/2,2)+Math.pow(this.height/2,2));for(let t=0;t<i;t++)if(this.dust.length<this.dustMaxCount){const t=Math.random()*Math.PI*2,e=Math.random()*s;this.dust.push({x:this.centerX+Math.cos(t)*e,y:this.centerY+Math.sin(t)*e,vx:(Math.random()-.5)*(this.isMobile?1.2:2),vy:(Math.random()-.5)*(this.isMobile?1.2:2),age:0,lifetime:this.isMobile?70:100,brightness:.7*Math.random()+.3})}for(let t=this.dust.length-1;t>=0;t--){const e=this.dust[t];e.age++,e.x+=e.vx,e.y+=e.vy;const i=this.isMobile?.985:.98;e.vx*=i,e.vy*=i,e.age>e.lifetime&&this.dust.splice(t,1)}}triggerExplosion(t,e){const i=this.auraMovement[t],s=this.centerX+i.currentX,h=this.centerY+i.currentY,a="left"===t?"#00d9ff":"#ff00ff",o=this.isMobile?Math.floor(40*e)+18:Math.floor(100*e)+30;for(let t=0;t<o&&this.explosions.length<this.explosionMaxCount;t++){const t=Math.random()*Math.PI*2,i=(5+Math.random()*(this.isMobile?8:15))*e;this.explosions.push({x:s,y:h,vx:Math.cos(t)*i,vy:Math.sin(t)*i,age:0,lifetime:(this.isMobile?45:60)+Math.random()*(this.isMobile?25:40),size:2+4*Math.random(),color:a,brightness:.8+.2*Math.random(),decay:(this.isMobile?.985:.98)-.02*Math.random()})}}updateExplosions(){for(let t=this.explosions.length-1;t>=0;t--){const e=this.explosions[t];e.age++,e.x+=e.vx,e.y+=e.vy,e.vx*=e.decay,e.vy*=e.decay,e.vy+=.1,e.age>e.lifetime&&this.explosions.splice(t,1)}}onRender(){this.ctx&&(this.ctx.fillStyle=this.config.backgroundColor||"#000",this.ctx.fillRect(0,0,this.width,this.height)),this.drawConcentriCRings(),this.drawStereoVeils(),this.drawHarmonicRibbons(),this.drawThreads(),this.drawCoreMandala(),this.drawSpiralArms(),this.drawCosmicDust(),this.drawExplosions()}drawConcentriCRings(){if(!this.ctx||0===this.rings.length)return;const t=this.ctx;t.save(),t.lineCap="round",t.globalCompositeOperation="screen";for(let e of this.rings){const i=e.lifetime?e.age/e.lifetime:0,s=Math.max(0,1-i),h=e.alpha*s,a=Math.max(0,e.radius);if(h<=0||a<=0)continue;const o=isFinite(e.hue)?e.hue:30,r=Math.max(.06,Math.min(.85,e.tilt??.3)),n=Math.max(8,a),l=Math.max(3,a*(1-r)),d=e.yaw??0,c=e.verticalOffset??0,m=18*(e.glow??.2),p=.35*h,g=h;t.save(),t.translate(this.centerX,this.centerY+c),t.rotate(d),t.lineWidth=e.lineWidth,t.globalAlpha=1,t.shadowBlur=m,t.shadowColor=`hsla(${o}, 75%, 45%, ${.6*p})`,t.strokeStyle=`hsla(${o}, 70%, 50%, ${p})`,t.beginPath(),t.ellipse(0,0,n,l,0,Math.PI,2*Math.PI),t.stroke(),t.shadowBlur=1.4*m,t.shadowColor=`hsla(${o}, 82%, 60%, ${.85*g})`,t.strokeStyle=`hsla(${o}, 85%, 68%, ${g})`,t.beginPath(),t.ellipse(0,0,n,l,0,0,Math.PI),t.stroke(),t.shadowBlur=.8*m,t.strokeStyle=`hsla(${(o+32)%360}, 90%, 74%, ${.6*g})`;const u=Math.max(1.2,.5*e.lineWidth);t.lineWidth=u,t.beginPath(),t.ellipse(0,0,.9*n,.9*l,0,.2*Math.PI,.8*Math.PI),t.stroke(),t.restore()}t.restore()}drawThreads(){if(!this.ctx)return;const t=this.ctx;if(!this.threads.low.length)return;const e=(e,i,s=0)=>{for(let h of e){if(!h||h.length<2)continue;const e=h[0],a=i({first:e,last:h[h.length-1],history:h});if(a){t.beginPath(),t.moveTo(e.x,e.y);for(let e=1;e<h.length;e++){const i=h[e-1],s=h[e],a=.5*(i.x+s.x),o=.5*(i.y+s.y);t.quadraticCurveTo(i.x,i.y,a,o)}t.lineWidth=a.lineWidth,t.strokeStyle=a.strokeStyle,t.globalAlpha=a.alpha,t.shadowBlur=s*a.lineWidth,t.shadowColor=a.shadowColor||a.strokeStyle,t.stroke()}}};t.save(),t.globalCompositeOperation="lighter",t.lineCap="round",t.lineJoin="round";const i=20+40*this.smoothedSub,s=130+40*this.smoothedPresence,h=220+40*this.smoothedBrilliance,a=280+60*this.smoothedBalance;e(this.threads.low,({first:e,last:s})=>{const h=Math.min(1,s.alpha??.4),a=t.createLinearGradient(e.x,e.y,s.x,s.y);return a.addColorStop(0,`hsla(${i}, 90%, 38%, ${.18*h})`),a.addColorStop(1,`hsla(${i+10}, 90%, 50%, ${.7*h})`),{strokeStyle:a,lineWidth:Math.max(1.5,s.width??2),alpha:.7,shadowColor:`hsla(${i}, 90%, 55%, ${.35*h})`}},2),e(this.threads.mid,({first:e,last:i})=>{const h=Math.min(1,i.alpha??.4),a=t.createLinearGradient(e.x,e.y,i.x,i.y);return a.addColorStop(0,`hsla(${s}, 80%, 38%, ${.18*h})`),a.addColorStop(1,`hsla(${s+20}, 80%, 52%, ${.7*h})`),{strokeStyle:a,lineWidth:Math.max(1.2,i.width??1.5),alpha:.6,shadowColor:`hsla(${s}, 85%, 58%, ${.3*h})`}},1.5),e(this.threads.high,({first:e,last:i})=>{const s=Math.min(1,i.alpha??.3),a=t.createLinearGradient(e.x,e.y,i.x,i.y);return a.addColorStop(0,`hsla(${h}, 85%, 60%, ${.18*s})`),a.addColorStop(1,`hsla(${h+40}, 85%, 70%, ${.65*s})`),{strokeStyle:a,lineWidth:Math.max(1,i.width??1.2),alpha:.55,shadowColor:`hsla(${h}, 90%, 70%, ${.35*s})`}},2.2),e(this.threads.stereo,({history:e,last:i})=>{const s=Math.min(1,i.alpha??.2),h=t.createLinearGradient(e[0].x,e[0].y,i.x,i.y);return h.addColorStop(0,`hsla(${a}, 65%, 45%, ${.15*s})`),h.addColorStop(1,`hsla(${a+40}, 65%, 60%, ${.6*s})`),{strokeStyle:h,lineWidth:Math.max(1,i.width??1.4),alpha:.5,shadowColor:`hsla(${a+20}, 75%, 60%, ${.28*s})`}},1.8),t.restore()}drawStereoVeils(){if(!this.ctx)return;const t=this.ctx,e=e=>{for(let i of e.points){const s=i.lifetime?i.age/i.lifetime:0,h=Math.max(0,1-s),a=i.alpha*h;if(a<=0)continue;const o=i.size*(.6+.4*this.smoothedSpread),r=t.createRadialGradient(i.x,i.y,0,i.x,i.y,o);r.addColorStop(0,`hsla(${e.hue}, 75%, 60%, ${.6*a})`),r.addColorStop(1,`hsla(${e.hue}, 75%, 60%, 0)`),t.globalAlpha=.85,t.fillStyle=r,t.beginPath(),t.arc(i.x,i.y,o,0,2*Math.PI),t.fill()}};t.save(),t.globalCompositeOperation="screen",e(this.stereoVeils.left),e(this.stereoVeils.right),t.restore()}drawHarmonicRibbons(){if(!this.ctx||!this.harmonicRibbons.length)return;const t=this.ctx,e=this.audioCache.spectralCentroid??0;t.save(),t.translate(this.centerX,this.centerY),t.globalCompositeOperation="lighter";for(let i of this.harmonicRibbons){const s=Math.max(20,i.radius??0),h=Math.min(.6,.65*(i.opacity??.4)),a=150+i.hueShift+80*e,o=t.createLinearGradient(-s,0,s,0);o.addColorStop(0,`hsla(${a}, 75%, 50%, ${.2*h})`),o.addColorStop(.5,`hsla(${a+20}, 75%, 55%, ${h})`),o.addColorStop(1,`hsla(${a-15}, 75%, 50%, ${.2*h})`),t.save(),t.rotate(i.rotation),t.lineWidth=i.thickness,t.strokeStyle=o,t.globalAlpha=.75,t.shadowBlur=.9*i.thickness,t.shadowColor=`hsla(${a}, 80%, 55%, ${.6*h})`,t.beginPath(),t.ellipse(0,0,s,s*(.5+.45*(i.waveOffset??0)+.2*this.smoothedBalance),0,0,2*Math.PI),t.stroke(),t.restore()}t.restore()}drawCoreMandala(){if(!this.ctx)return;const t=this.ctx,e=this.coreShape.petals??6,i=Math.min(1.6,Math.max(.1,this.coreShape.twist??.2)),s=Math.max(.2,this.coreShape.pulse??.3),h=.12*Math.min(this.width,this.height)*s,a=.45*h,o=h*(1.2+.8*this.smoothedHigh),r=190+100*(this.audioCache.spectralCentroid??0),n=this.smoothedBrilliance;t.save(),t.translate(this.centerX,this.centerY),t.rotate(this.coreShape.rotation);const l=t.createRadialGradient(0,0,.5*a,0,0,o);l.addColorStop(0,`hsla(${r}, 85%, 78%, ${.18+.25*n})`),l.addColorStop(.6,`hsla(${r+40}, 85%, 60%, ${.32+.22*n})`),l.addColorStop(1,`hsla(${r-20}, 85%, 42%, 0.1)`),t.beginPath();for(let s=0;s<e;s++){const h=s*(2*Math.PI/e),a=Math.sin(.015*this.time+s)*i*.4,r=Math.cos(h+a)*o,n=Math.sin(h+a)*o;0===s?t.moveTo(r,n):t.lineTo(r,n)}t.closePath(),t.fillStyle=l,t.fill(),t.globalCompositeOperation="lighter",t.beginPath();for(let s=0;s<e;s++){const h=s*(2*Math.PI/e),o=Math.cos(.02*this.time+1.2*s)*i*.3,r=Math.cos(h+o)*a,n=Math.sin(h+o)*a;0===s?t.moveTo(r,n):t.lineTo(r,n)}t.closePath(),t.strokeStyle=`hsla(${r+60}, 80%, 66%, ${.25+.28*n})`,t.lineWidth=1.5+1.6*this.smoothedPresence,t.stroke(),t.beginPath(),t.arc(0,0,.4*a,0,2*Math.PI),t.fillStyle=`hsla(${r+80}, 85%, 70%, ${.28+.22*n})`,t.fill(),t.restore()}drawSpiralArms(){this.drawSpiral(this.spirals.left,this.auraMovement.left.currentX,this.auraMovement.left.currentY),this.drawSpiral(this.spirals.right,this.auraMovement.right.currentX,this.auraMovement.right.currentY)}drawSpiral(t,e,i){const s=this.centerX+(isFinite(e)?e:0),h=this.centerY+(isFinite(i)?i:0);let a=50;if(t.particles.length>0){const e=t.particles.map(t=>isFinite(t.distance)?t.distance:0);a=e.reduce((t,e)=>t+e,0)/e.length}let o=a+20;o=Math.min(Math.max(o,40),150),this.ctx.save();const r=t.color.match(/#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i);let n={r:0,g:200,b:255};r&&(n={r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)});for(let e of t.particles){const t=isFinite(e.angle)?e.angle:0,i=isFinite(e.distance)?e.distance:0,a=s+Math.cos(t)*i,o=h+Math.sin(t)*i,r=1-e.age/e.lifetime,l=(2+i/50)*(1+.5*(isFinite(this.smoothedHigh)?this.smoothedHigh:0));this.ctx.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${r})`,this.ctx.beginPath(),this.ctx.arc(a,o,l,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawCosmicDust(){for(let t of this.dust){const e=1-t.age/t.lifetime,i=t.brightness,s=.5*Math.sin(.1*this.time+t.age)+.5,h=e*i*(.35+.25*s);this.ctx.fillStyle=`rgba(140, 205, 235, ${h})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1+1.6*s,0,2*Math.PI),this.ctx.fill()}}drawExplosions(){for(let t of this.explosions){const e=1-t.age/t.lifetime,i=t.brightness,s=1-t.age/t.lifetime*.5,h=t.size*s,a=t.color.match(/#(\w{2})(\w{2})(\w{2})/);if(a){const s=parseInt(a[1],16),o=parseInt(a[2],16),r=parseInt(a[3],16),n=e*i*.7;if(this.ctx.fillStyle=`rgba(${s}, ${o}, ${r}, ${n})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,h,0,2*Math.PI),this.ctx.fill(),Math.sqrt(t.vx*t.vx+t.vy*t.vy)>3){const e=t.x-.5*t.vx,i=t.y-.5*t.vy;this.ctx.strokeStyle=`rgba(${s}, ${o}, ${r}, ${.35*n})`,this.ctx.lineWidth=.4*h,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e,i),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()}}}}destroy(){super.destroy()}}"undefined"!=typeof window&&(window.AuraFarmingVisualizer=AuraFarmingVisualizer);