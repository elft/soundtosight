const clamp=(t,e,s)=>Math.min(Math.max(t,e),s),lerp=(t,e,s)=>t+(e-t)*s,arSmoother=(t,e,s,a=.06,i=.28)=>{const r=1-Math.exp(-s/a),o=1-Math.exp(-s/i);return t+(e-t)*(e>t?r:o)};class DebugVisualizer extends BaseVisualizer{constructor(t=null,e={}){super(t,{backgroundColor:"#0b0d12",force2d:!0,stereoMode:!0,debug:!1,...e})}async init(){this.margin=16,this.pad=10,this.specBars=64,this.histLen=360,this.prevT=.001*performance.now(),this.smooth={rms:0,energy:0,flux:0,flat:0,balance:0,spread:0,loudDbN:0,tempo:120,centroidN:0},this.specSmooth=new Float32Array(this.specBars),this.specPeak=new Float32Array(this.specBars),this.eventHold={snare:0,hat:0},this.hist={flux:new Float32Array(this.histLen),energy:new Float32Array(this.histLen),loudDb:new Float32Array(this.histLen),snare:new Float32Array(this.histLen),hat:new Float32Array(this.histLen),write:0},this.bandKeys=["subBassEnergy","bassEnergy","lowMidEnergy","midEnergy","upperMidEnergy","presenceEnergy","trebleEnergy","brillianceEnergy","ultrassonicEnergy","ultrasonicEnergy"],this._computeBarLayout()}onResize(){this._computeBarLayout()}_computeBarLayout(){const t=this.width,e=this.height,s=this.margin,a=this.pad,i=e-2*s-(440+3*a),r=Math.max(160,i);let o=s;this.rectTop={x:s,y:o,w:t-2*s,h:140},o+=140+a,this.rectBands={x:s,y:o,w:t-2*s,h:110},o+=110+a,this.rectSpec={x:s,y:o,w:t-2*s,h:r},o+=r+a,this.rectWaves={x:s,y:o,w:t-2*s,h:120},o+=120+a,this.rectSparks={x:s,y:o,w:t-2*s,h:70};const h=Math.floor((this.rectSpec.w-3*(this.specBars-1))/this.specBars);this.specBar={w:Math.max(2,h),gap:3}}_sampleSpectrum(t){const e=t.frequencyLeft||new Uint8Array(0),s=t.frequencyRight||e,a=Math.min(e.length,s.length);if(!a)return new Float32Array(this.specBars);const i=new Float32Array(a);for(let t=0;t<a;t++)i[t]=.5*(e[t]+s[t]);const r=new Float32Array(this.specBars),o=a/this.specBars;for(let t=0;t<this.specBars;t++){const e=Math.floor(t*o),s=Math.min(a-1,Math.floor((t+1)*o));let h=0;const l=Math.max(1,s-e+1);for(let t=e;t<=s;t++)h+=i[t];r[t]=h/(255*l)}return r}_drawLabel(t,e,s,a,i=12,r="#cbd5e1",o="left"){t.fillStyle=r,t.font=`${i}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`,t.textAlign=o,t.textBaseline="middle",t.fillText(e,s,a)}_drawDial(t,e,s,a,i,r,o="#60a5fa",h="#1f2937",l=8){t.beginPath(),t.arc(e,s,a,0,2*Math.PI),t.strokeStyle=h,t.lineWidth=l,t.stroke(),t.beginPath(),t.arc(e,s,a,i,r),t.strokeStyle=o,t.lineWidth=l,t.lineCap="round",t.stroke()}_drawBar(t,e,s,a,i,r,o,h,l,n=1){const c=i*clamp(r,0,1);if(t.globalAlpha=n,t.fillStyle=o,t.fillRect(e,s+(i-c),a,c),null!=l){const r=s+i-i*clamp(l,0,1);t.fillStyle=h,t.fillRect(e,Math.max(s,r-2),a,2)}t.globalAlpha=1}_drawScope(t,e,s,a="#93c5fd"){const{x:i,y:r,w:o,h:h}=e;if(t.save(),t.beginPath(),t.rect(i,r,o,h),t.clip(),t.fillStyle="#0f172a",t.fillRect(i,r,o,h),!s||!s.length)return void t.restore();t.strokeStyle=a,t.lineWidth=1.5,t.beginPath();const l=s.length;for(let e=0;e<l;e++){const a=i+e/(l-1)*o,n=r+.5*h-(s[e]-128)/128*(.45*h);0===e?t.moveTo(a,n):t.lineTo(a,n)}t.stroke(),t.restore()}_drawSpark(t,e,s,a="#34d399",i=-1,r=1){const{x:o,y:h,w:l,h:n}=e;t.save(),t.beginPath(),t.rect(o,h,l,n),t.clip(),t.fillStyle="#0b1020",t.fillRect(o,h,l,n);const c=s.length;t.strokeStyle=a,t.lineWidth=1.25,t.beginPath();for(let e=0;e<c;e++){const a=o+e/(c-1)*l,d=h+n-(clamp(s[e],i,r)-i)/(r-i)*n;0===e?t.moveTo(a,d):t.lineTo(a,d)}if(t.stroke(),i<0&&r>0){const e=h+n-(0-i)/(r-i)*n;t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=1,t.beginPath(),t.moveTo(o,e),t.lineTo(o+l,e),t.stroke()}t.restore()}update(t){if(super.update(t),!t)return;const e=.001*performance.now(),s=clamp(e-this.prevT,1/240,.1);this.prevT=e;const a=Number(t.rms)||0,i=Number(t.overallEnergy??t.energy)||0,r=Number(t.spectralFlux)||0,o=Number(t.spectralFlatnessSmoothed??t.flatness)||0,h=Number(t.stereoBalance)||0,l=Number(t.stereoSpread??Math.abs(h))||0,n=Number(t.spectralCentroidNormalized??t.centroid/(("undefined"!=typeof window&&window.vvavy?.audioManager?.audioContext?.sampleRate||48e3)/2))||0,c=Number(t.tempo)||0,d=Boolean(t.isBeat),m=Boolean(t.bassDrop),p=Number(t.aWeighted?.mono?.db)||-60,f=clamp((p+60)/60,0,1);this.smooth.rms=arSmoother(this.smooth.rms,a,s,.04,.18),this.smooth.energy=arSmoother(this.smooth.energy,i,s,.05,.3),this.smooth.flux=arSmoother(this.smooth.flux,r,s,.03,.2),this.smooth.flat=arSmoother(this.smooth.flat,o,s,.08,.35),this.smooth.balance=arSmoother(this.smooth.balance,h,s,.03,.18),this.smooth.spread=arSmoother(this.smooth.spread,l,s,.08,.4),this.smooth.loudDbN=arSmoother(this.smooth.loudDbN,f,s,.1,.5),this.smooth.tempo=arSmoother(this.smooth.tempo,c,s,.5,1),this.smooth.centroidN=arSmoother(this.smooth.centroidN,n,s,.1,.6);const b=t.smoothedSpectrum,u=t.peakSpectrum;let y=b?this._resampleFloat(b,this.specBars):this._sampleSpectrum(t);const w=Math.exp(-s/.4),g=1-Math.exp(-s/.03),_=1-Math.exp(-s/.22);for(let t=0;t<this.specBars;t++){const e=clamp(y[t],0,1),s=this.specSmooth[t],a=s+(e-s)*(e>s?g:_);this.specSmooth[t]=b?e:a;const i=this.specPeak[t]*w;this.specPeak[t]=Math.max(this.specSmooth[t],i)}if(u&&u.length){const t=this._resampleFloat(u,this.specBars);this.specPeak.set(t)}const x=this.hist.write%this.histLen;this.hist.flux[x]=clamp(this.smooth.flux,0,1),this.hist.energy[x]=clamp(this.smooth.energy,0,1),this.hist.loudDb[x]=this.smooth.loudDbN,this.hist.snare[x]=t.snareHit?1:0,this.hist.hat[x]=t.hatTick?1:0,this.hist.write=(x+1)%this.histLen,this.eventHold.snare=Math.max(0,this.eventHold.snare-s),this.eventHold.hat=Math.max(0,this.eventHold.hat-s),t.snareHit&&(this.eventHold.snare=.28),t.hatTick&&(this.eventHold.hat=.18);const S=this.eventHold.snare>0,M=this.eventHold.hat>0;this._audio={isBeat:d,bassDrop:m,beatPhase:clamp(Number(t.beatPhase)||0,0,1),predictedNextBeat:t.predictedNextBeat,time:Number(t.time)||0,rmsLeft:Number(t.rmsLeft)||0,rmsRight:Number(t.rmsRight)||0,timeLeft:t.timeDomainLeft,timeRight:t.timeDomainRight,dominantFreq:Number(t.dominantFreq)||0,aDb:p,bpmRounded:Math.round(this.smooth.tempo||0),snareActive:S,hatActive:M},this._bands=this._collectBands(t)}_resampleFloat(t,e){const s=new Float32Array(e);if(!t||!t.length)return s;const a=t.length,i=a/e;for(let r=0;r<e;r++){const e=Math.floor(r*i),o=Math.min(a-1,Math.floor((r+1)*i));let h=0,l=Math.max(1,o-e+1);for(let s=e;s<=o;s++)h+=t[s];s[r]=h/l}return s}_collectBands(t){const e=[];for(let s=0;s<9;s++){const a=this.bandKeys[s];e.push(Number(t[a])||0)}const s=Number(t.ultrassonicEnergy??t.ultrasonicEnergy)||0;return e.push(s),e}onRender(){const t=this.ctx,e=this.width,s=this.height;t.fillStyle=this.config.backgroundColor,t.fillRect(0,0,e,s),this._drawBackdropGradients(t),this._renderTop(t),this._renderBands(t),this._renderSpectrum(t),this._renderWaves(t),this._renderSparklines(t)}_drawBackdropGradients(t){const e=t.createLinearGradient(0,0,0,this.height);e.addColorStop(0,"rgba(88,28,135,0.08)"),e.addColorStop(.5,"rgba(2,6,23,0.0)"),e.addColorStop(1,"rgba(8,47,73,0.10)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height)}_renderTop(t){const e=this.rectTop,s=e.x+.12*e.w,a=e.y+.52*e.h,i=Math.min(.45*e.h,58),r=(this._audio?.beatPhase??0)*Math.PI*2,o=this._audio?.isBeat?"#f59e0b":"#60a5fa";this._drawDial(t,s,a,i,-Math.PI/2,-Math.PI/2+r,o,"#0f172a",10),this._audio?.isBeat&&(t.beginPath(),t.arc(s,a,i+6,0,2*Math.PI),t.strokeStyle="rgba(245,158,11,0.55)",t.lineWidth=3,t.stroke()),this._audio?.bassDrop&&(t.beginPath(),t.arc(s,a,i+12,0,2*Math.PI),t.strokeStyle="rgba(16,185,129,0.45)",t.lineWidth=2,t.setLineDash([6,8]),t.stroke(),t.setLineDash([]));const h=this._audio?.bpmRounded??0;if(this._drawLabel(t,`${h} BPM`,s,a,18,"#e5e7eb","center"),this._audio?.predictedNextBeat&&Number.isFinite(this._audio.time)){const e=Math.max(0,this._audio.predictedNextBeat-this._audio.time);this._drawLabel(t,`next ${e.toFixed(2)}s`,s,a+i+16,12,"#93c5fd","center")}const l=e.x+.25*e.w,n=e.y+20,c=this.smooth.balance,d=(c+1)/2*100|0,m=this.smooth.spread,p=this._audio?.snareHit,f=this._audio?.hatActive,b=[["RMS",this.smooth.rms.toFixed(3)],["Loud (A‑dB)",`${this._audio?.aDb.toFixed(1)} dB`],["Energy",this.smooth.energy.toFixed(3)],["Flux",this.smooth.flux.toFixed(3)],["Flatness",this.smooth.flat.toFixed(3)],["Centroid",`${(100*this.smooth.centroidN).toFixed(1)}% nyq`],["Snare Hit",p?"TRUE":"FALSE",p?"#fda4af":"#9ca3af"],["Hat Tick",f?"TRUE":"FALSE",f?"#38bdf8":"#9ca3af"]];for(let e=0;e<b.length;e++){const[s,a,i]=b[e],r=i||"#cbd5e1";this._drawLabel(t,`${s}: ${a}`,l,n+18*e,12,r,"left")}const u=220,y=e.x+e.w-u-10,w=e.y+.32*e.h;t.fillStyle="#0f172a",t.fillRect(y,w,u,10),t.fillStyle="rgba(255,255,255,0.12)",t.fillRect(y+110-1,w,2,10);const g=110;c>=0?(t.fillStyle="#60a5fa",t.fillRect(y+g,w,g*c,10)):(t.fillStyle="#22d3ee",t.fillRect(y+g+g*c,w,-110*c,10)),this._drawLabel(t,`Balance ${d}%`,y+u,w-8,11,"#9ca3af","right");const _=y+u-26,x=w+44;this._drawDial(t,_,x,20,-Math.PI/2,-Math.PI/2+clamp(m,0,1)*Math.PI*2,"#22d3ee","#0f172a",6),this._drawLabel(t,"Spread",_,x+28,11,"#9ca3af","center")}_renderBands(t){const e=this.rectBands,s=this._bands||[],a=["Sub","Bass","Low‑Mid","Mid","U‑Mid","Pres","Treble","Brill","Ultra"],i=Math.min(9,s.length),r=Math.floor((e.w-8*(i-1))/i),o=e.y+e.h-16;let h=0,l=-1;for(let t=0;t<i;t++)s[t]>l&&(l=s[t],h=t);for(let l=0;l<i;l++){const i=clamp(s[l],0,1),n=e.x+l*(r+8),c=(e.h,l===h),d=c?"#f59e0b":"#60a5fa",m=c?"#fde68a":"#93c5fd";this._drawBar(t,n,o-(e.h-30),r,e.h-30,i,d,m,null,c?.95:.85),this._drawLabel(t,a[l]||`B${l}`,n+r/2,o,11,"#94a3b8","center")}this._drawLabel(t,"Band Energy",e.x,e.y+12,12,"#cbd5e1","left")}_renderSpectrum(t){const e=this.rectSpec,{wBar:s,gap:a}={wBar:this.specBar.w,gap:this.specBar.gap};t.fillStyle="#0b1020",t.fillRect(e.x,e.y,e.w,e.h),t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,t.beginPath();for(let s=0;s<=4;s++){const a=e.y+s/4*e.h;t.moveTo(e.x,a),t.lineTo(e.x+e.w,a)}t.stroke();const i=this.specBars;for(let r=0;r<i;r++){const i=e.x+r*(s+a),o=this.specSmooth[r],h=this.specPeak[r];this._drawBar(t,i,e.y,s,e.h,o,"#60a5fa","#fde68a",h,.9)}const r=e.x+clamp(this.smooth.centroidN,0,1)*e.w;if(t.strokeStyle="rgba(34,197,94,0.65)",t.beginPath(),t.moveTo(r,e.y),t.lineTo(r,e.y+e.h),t.stroke(),this._drawLabel(t,"centroid",r+4,e.y+12,10,"#86efac","left"),this._audio?.dominantFreq){const s=clamp(this._audio.dominantFreq/22050,0,1),a=e.x+s*e.w;t.strokeStyle="rgba(236,72,153,0.55)",t.beginPath(),t.moveTo(a,e.y),t.lineTo(a,e.y+e.h),t.stroke(),this._drawLabel(t,`${Math.round(this._audio.dominantFreq)} Hz`,a+4,e.y+28,10,"#f9a8d4","left")}this._drawLabel(t,"Spectrum (64 bars, peak‑hold)",e.x,e.y+12,12,"#cbd5e1","left")}_renderWaves(t){const e=this.rectWaves,s=Math.floor(e.h/2)-6,a={x:e.x,y:e.y,w:e.w,h:s},i={x:e.x,y:e.y+s+12,w:e.w,h:s};this._drawScope(t,a,this._audio?.timeLeft,"#22d3ee"),this._drawScope(t,i,this._audio?.timeRight,"#60a5fa"),this._drawLabel(t,"Oscilloscope L",a.x,a.y+10,12,"#cbd5e1","left"),this._drawLabel(t,"Oscilloscope R",i.x,i.y+10,12,"#cbd5e1","left")}_renderSparklines(t){const e=this.rectSparks,s=Math.floor((e.h-20)/3),a=t=>({x:e.x,y:e.y+t*(s+10),w:e.w,h:s}),i=a(0),r=a(1),o=a(2),h=this._rollHistory(this.hist.flux,this.hist.write),l=this._rollHistory(this.hist.energy,this.hist.write),n=this._rollHistory(this.hist.loudDb,this.hist.write),c=this._rollHistory(this.hist.snare,this.hist.write),d=this._rollHistory(this.hist.hat,this.hist.write);this._drawSpark(t,i,h,"#34d399",0,1),this._drawEventMarkers(t,i,c,"rgba(236,72,153,0.85)",.85,3),this._drawEventMarkers(t,i,d,"rgba(14,165,233,0.65)",.55,2),this._drawSpark(t,r,l,"#60a5fa",0,1),this._drawEventMarkers(t,r,c,"rgba(236,72,153,0.65)",.65,2),this._drawEventMarkers(t,r,d,"rgba(14,165,233,0.55)",.4,1.5),this._drawSpark(t,o,n,"#f59e0b",0,1),this._drawEventMarkers(t,o,c,"rgba(236,72,153,0.45)",.45,1.5),this._drawEventMarkers(t,o,d,"rgba(14,165,233,0.9)",.85,2.5),this._drawLabel(t,"Flux",i.x+6,i.y+10,11,"#cbd5e1","left"),this._drawLabel(t,"Energy",r.x+6,r.y+10,11,"#cbd5e1","left"),this._drawLabel(t,"Loud (A‑dB norm)",o.x+6,o.y+10,11,"#cbd5e1","left")}_rollHistory(t,e){const s=t.length,a=new Float32Array(s),i=s-e;return a.set(t.subarray(e),0),a.set(t.subarray(0,e),i),a}_drawEventMarkers(t,e,s,a,i=1,r=2){if(!s||!s.length)return;const{x:o,y:h,w:l,h:n}=e;t.save(),t.beginPath(),t.rect(o,h,l,n),t.clip(),t.fillStyle=a;const c=s.length,d=Math.max(4,n*clamp(i,0,1)),m=h+(n-d),p=Math.max(1,Math.floor(c/l));for(let e=0;e<c;e++){if(s[e]<=0)continue;if(p>1&&e%p!==0)continue;const a=o+e/(c-1)*l;t.fillRect(a-r/2,m,r,d)}t.restore()}}window.DebugVisualizer=DebugVisualizer;