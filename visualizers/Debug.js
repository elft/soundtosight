class DebugVisualizer extends BaseVisualizer{static meta={description:"Audio metrics HUD for inspecting every field coming from AudioManager.",tags:["debug","analysis","utility"]};constructor(e=null,t={}){super(e,{backgroundColor:"#0b0d12",force2d:!0,stereoMode:!0,debug:!1,...t})}async init(){this.margin=16,this.pad=10,this.specBars=64,this.histLen=360,this.prevT=.001*performance.now(),this.smooth={rms:0,energy:0,flux:0,flat:0,balance:0,spread:0,loudDbN:0,tempo:120,centroidN:0},this.specSmooth=new Float32Array(this.specBars),this.specPeak=new Float32Array(this.specBars),this.eventHold={dropStart:0,dropBloom:0,melody:0},this.hist={flux:new Float32Array(this.histLen),energy:new Float32Array(this.histLen),loudDb:new Float32Array(this.histLen),dropStart:new Float32Array(this.histLen),dropBloom:new Float32Array(this.histLen),melody:new Float32Array(this.histLen),write:0},this.bandKeys=["subBassEnergy","bassEnergy","lowMidEnergy","midEnergy","upperMidEnergy","presenceEnergy","trebleEnergy","brillianceEnergy","ultrassonicEnergy","ultrasonicEnergy"],this._computeBarLayout(),this._frameCounter=0,this._latestSnapshot=null,this._latestSnapshotString="",this._snapshotHistory=[],this._snapshotLimit=Number.isFinite(this.config?.jsonHistoryLimit)?this.config.jsonHistoryLimit:900,!Number.isFinite(this._snapshotLimit)||this._snapshotLimit<=0?this._snapshotLimit=900:this._snapshotLimit=Math.max(1,Math.floor(this._snapshotLimit)),this._aggregateJsonString="",this._aggregateDirty=!1,this._capturePaused=!0,this._jsonOverlayEl=null,this._jsonOverlayPre=null,this._jsonOverlayTextarea=null,this._jsonOverlayCopyBtn=null,this._jsonOverlayDownloadBtn=null,this._jsonOverlayPauseBtn=null,this._jsonOverlayAggregateTitle=null,this._jsonOverlayHint=null,this._jsonOverlayVisible=!1,this._captureEnabled=this._resolveCaptureEnabled(),this._captureEnabled&&this._initJsonOverlay(),"undefined"!=typeof window&&(this._boundExportsHandler=this._boundExportsHandler||(e=>this._handleExportsReadyEvent(e)),window.addEventListener("vvavy:exports-ready",this._boundExportsHandler))}onResize(){this._computeBarLayout()}_computeBarLayout(){const e=this.width,t=this.height,s=this.margin,i=this.pad,r=t-2*s-(440+3*i),a=Math.max(160,r);let o=s;this.rectTop={x:s,y:o,w:e-2*s,h:140},o+=140+i,this.rectBands={x:s,y:o,w:e-2*s,h:110},o+=110+i,this.rectSpec={x:s,y:o,w:e-2*s,h:a},o+=a+i,this.rectWaves={x:s,y:o,w:e-2*s,h:120},o+=120+i,this.rectSparks={x:s,y:o,w:e-2*s,h:70};const n=Math.floor((this.rectSpec.w-3*(this.specBars-1))/this.specBars);this.specBar={w:Math.max(2,n),gap:3}}_sampleSpectrum(e){const t=e.frequencyLeft||new Uint8Array(0),s=e.frequencyRight||t,i=Math.min(t.length,s.length);if(!i)return new Float32Array(this.specBars);const r=new Float32Array(i);for(let e=0;e<i;e++)r[e]=.5*(t[e]+s[e]);const a=new Float32Array(this.specBars),o=i/this.specBars;for(let e=0;e<this.specBars;e++){const t=Math.floor(e*o),s=Math.min(i-1,Math.floor((e+1)*o));let n=0;const l=Math.max(1,s-t+1);for(let e=t;e<=s;e++)n+=r[e];a[e]=n/(255*l)}return a}_drawLabel(e,t,s,i,r=12,a="#cbd5e1",o="left"){e.fillStyle=a,e.font=`${r}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`,e.textAlign=o,e.textBaseline="middle",e.fillText(t,s,i)}_drawDial(e,t,s,i,r,a,o="#60a5fa",n="#1f2937",l=8){e.beginPath(),e.arc(t,s,i,0,2*Math.PI),e.strokeStyle=n,e.lineWidth=l,e.stroke(),e.beginPath(),e.arc(t,s,i,r,a),e.strokeStyle=o,e.lineWidth=l,e.lineCap="round",e.stroke()}_drawBar(e,t,s,i,r,a,o,n,l,h=1){const d=r*this.constrain(a,0,1);if(e.globalAlpha=h,e.fillStyle=o,e.fillRect(t,s+(r-d),i,d),null!=l){const a=s+r-r*this.constrain(l,0,1);e.fillStyle=n,e.fillRect(t,Math.max(s,a-2),i,2)}e.globalAlpha=1}_drawScope(e,t,s,i="#93c5fd"){const{x:r,y:a,w:o,h:n}=t;if(e.save(),e.beginPath(),e.rect(r,a,o,n),e.clip(),e.fillStyle="#0f172a",e.fillRect(r,a,o,n),!s||!s.length)return void e.restore();e.strokeStyle=i,e.lineWidth=1.5,e.beginPath();const l=s.length;for(let t=0;t<l;t++){const i=r+t/(l-1)*o,h=a+.5*n-(s[t]-128)/128*(.45*n);0===t?e.moveTo(i,h):e.lineTo(i,h)}e.stroke(),e.restore()}_drawSpark(e,t,s,i="#34d399",r=-1,a=1){const{x:o,y:n,w:l,h:h}=t;e.save(),e.beginPath(),e.rect(o,n,l,h),e.clip(),e.fillStyle="#0b1020",e.fillRect(o,n,l,h);const d=s.length;e.strokeStyle=i,e.lineWidth=1.25,e.beginPath();for(let t=0;t<d;t++){const i=o+t/(d-1)*l,u=n+h-(this.constrain(s[t],r,a)-r)/(a-r)*h;0===t?e.moveTo(i,u):e.lineTo(i,u)}if(e.stroke(),r<0&&a>0){const t=n+h-(0-r)/(a-r)*h;e.strokeStyle="rgba(255,255,255,0.08)",e.lineWidth=1,e.beginPath(),e.moveTo(o,t),e.lineTo(o+l,t),e.stroke()}e.restore()}update(e){if(super.update(e),!e)return;const t=.001*performance.now(),s=this.constrain(t-this.prevT,1/240,.1);this.prevT=t;const i=this.audioTriggers||{},r=Boolean(i.dropStart),a=Boolean(i.dropBloom),o=r||a,n=Number(i.dropScore)||0,l=Boolean(i.melodyChange),h=Number(i.melodyChangeScore)||0,d=Number(e.rms)||0,u=Number(e.overallEnergy??e.energy)||0,c=Number(e.spectralFlux)||0,p=Number(e.spectralFlatnessSmoothed??e.flatness)||0,m=Number(e.stereoBalance)||0,y=Number(e.stereoSpread??Math.abs(m))||0,g=Number(e.spectralCentroidNormalized??e.centroid/(("undefined"!=typeof window&&window.vvavy?.audioManager?.audioContext?.sampleRate||48e3)/2))||0,_=Number(e.tempo)||0,b=Boolean(e.isBeat),f=Number(e.aWeighted?.mono?.db)||-60,v=this.constrain((f+60)/60,0,1);this.smooth.rms=this.attackRelease(this.smooth.rms,d,s,.04,.18),this.smooth.energy=this.attackRelease(this.smooth.energy,u,s,.05,.3),this.smooth.flux=this.attackRelease(this.smooth.flux,c,s,.03,.2),this.smooth.flat=this.attackRelease(this.smooth.flat,p,s,.08,.35),this.smooth.balance=this.attackRelease(this.smooth.balance,m,s,.03,.18),this.smooth.spread=this.attackRelease(this.smooth.spread,y,s,.08,.4),this.smooth.loudDbN=this.attackRelease(this.smooth.loudDbN,v,s,.1,.5),this.smooth.tempo=this.attackRelease(this.smooth.tempo,_,s,.5,1),this.smooth.centroidN=this.attackRelease(this.smooth.centroidN,g,s,.1,.6);const x=e.smoothedSpectrum,w=e.peakSpectrum;let S=x?this._resampleFloat(x,this.specBars):this._sampleSpectrum(e);const E=Math.exp(-s/.4),B=1-Math.exp(-s/.03),N=1-Math.exp(-s/.22);for(let e=0;e<this.specBars;e++){const t=this.constrain(S[e],0,1),s=this.specSmooth[e],i=s+(t-s)*(t>s?B:N);this.specSmooth[e]=x?t:i;const r=this.specPeak[e]*E;this.specPeak[e]=Math.max(this.specSmooth[e],r)}if(w&&w.length){const e=this._resampleFloat(w,this.specBars);this.specPeak.set(e)}const O=this.hist.write%this.histLen;this.hist.flux[O]=this.constrain(this.smooth.flux,0,1),this.hist.energy[O]=this.constrain(this.smooth.energy,0,1),this.hist.loudDb[O]=this.smooth.loudDbN,this.hist.dropStart[O]=r?1:0,this.hist.dropBloom[O]=a?1:0,this.hist.melody[O]=l?1:0,this.hist.write=(O+1)%this.histLen,this.eventHold.dropStart=Math.max(0,this.eventHold.dropStart-s),this.eventHold.dropBloom=Math.max(0,this.eventHold.dropBloom-s),this.eventHold.melody=Math.max(0,this.eventHold.melody-s),r&&(this.eventHold.dropStart=.35),a&&(this.eventHold.dropBloom=.35),l&&(this.eventHold.melody=.45);const j=this.eventHold.dropStart>0,C=this.eventHold.dropBloom>0,k=this.eventHold.melody>0;this._audio={isBeat:b,dropActive:o,dropScore:n,melodyChange:l,melodyScore:h,beatPhase:this.constrain(Number(e.beatPhase)||0,0,1),predictedNextBeat:e.predictedNextBeat,time:Number(e.time)||0,rmsLeft:Number(e.rmsLeft)||0,rmsRight:Number(e.rmsRight)||0,timeLeft:e.timeDomainLeft,timeRight:e.timeDomainRight,dominantFreq:Number(e.dominantFreq)||0,aDb:f,bpmRounded:Math.round(this.smooth.tempo||0),dropStartActive:j,dropBloomActive:C,melodyPulse:k},this._bands=this._collectBands(e),this._updateFrameSnapshot(e)}_resampleFloat(e,t){const s=new Float32Array(t);if(!e||!e.length)return s;const i=e.length,r=i/t;for(let a=0;a<t;a++){const t=Math.floor(a*r),o=Math.min(i-1,Math.floor((a+1)*r));let n=0,l=Math.max(1,o-t+1);for(let s=t;s<=o;s++)n+=e[s];s[a]=n/l}return s}_collectBands(e){const t=[];for(let s=0;s<9;s++){const i=this.bandKeys[s];t.push(Number(e[i])||0)}const s=Number(e.ultrassonicEnergy??e.ultrasonicEnergy)||0;return t.push(s),t}onRender(){const e=this.ctx,t=this.width,s=this.height;e.fillStyle=this.config.backgroundColor,e.fillRect(0,0,t,s),this._drawBackdropGradients(e),this._renderTop(e),this._renderBands(e),this._renderSpectrum(e),this._renderWaves(e),this._renderSparklines(e)}_drawBackdropGradients(e){const t=e.createLinearGradient(0,0,0,this.height);t.addColorStop(0,"rgba(88,28,135,0.08)"),t.addColorStop(.5,"rgba(2,6,23,0.0)"),t.addColorStop(1,"rgba(8,47,73,0.10)"),e.fillStyle=t,e.fillRect(0,0,this.width,this.height)}_renderTop(e){const t=this.rectTop,s=t.x+.12*t.w,i=t.y+.52*t.h,r=Math.min(.45*t.h,58),a=(this._audio?.beatPhase??0)*Math.PI*2,o=this._audio?.isBeat?"#f59e0b":"#60a5fa";this._drawDial(e,s,i,r,-Math.PI/2,-Math.PI/2+a,o,"#0f172a",10),this._audio?.isBeat&&(e.beginPath(),e.arc(s,i,r+6,0,2*Math.PI),e.strokeStyle="rgba(245,158,11,0.55)",e.lineWidth=3,e.stroke()),this._audio?.dropActive&&(e.beginPath(),e.arc(s,i,r+12,0,2*Math.PI),e.strokeStyle="rgba(16,185,129,0.45)",e.lineWidth=2,e.setLineDash([6,8]),e.stroke(),e.setLineDash([]));const n=this._audio?.bpmRounded??0;if(this._drawLabel(e,`${n} BPM`,s,i,18,"#e5e7eb","center"),this._audio?.predictedNextBeat&&Number.isFinite(this._audio.time)){const t=Math.max(0,this._audio.predictedNextBeat-this._audio.time);this._drawLabel(e,`next ${t.toFixed(2)}s`,s,i+r+16,12,"#93c5fd","center")}const l=t.x+.25*t.w,h=t.y+20,d=this.smooth.balance,u=(d+1)/2*100|0,c=this.smooth.spread,p=this._audio?.dropStartActive,m=this._audio?.dropBloomActive,y=this._audio?.melodyPulse,g=[["RMS",this.smooth.rms.toFixed(3)],["Loud (Aâ€‘dB)",`${this._audio?.aDb.toFixed(1)} dB`],["Energy",this.smooth.energy.toFixed(3)],["Flux",this.smooth.flux.toFixed(3)],["Flatness",this.smooth.flat.toFixed(3)],["Centroid",`${(100*this.smooth.centroidN).toFixed(1)}% nyq`],["Drop Start",p?"TRUE":"FALSE",p?"#34d399":"#9ca3af"],["Drop Bloom",m?"TRUE":"FALSE",m?"#2dd4bf":"#9ca3af"],["Melody Pivot",y?"TRUE":"FALSE",y?"#f9a8d4":"#9ca3af"]];for(let t=0;t<g.length;t++){const[s,i,r]=g[t],a=r||"#cbd5e1";this._drawLabel(e,`${s}: ${i}`,l,h+18*t,12,a,"left")}const _=220,b=t.x+t.w-_-10,f=t.y+.32*t.h;e.fillStyle="#0f172a",e.fillRect(b,f,_,10),e.fillStyle="rgba(255,255,255,0.12)",e.fillRect(b+110-1,f,2,10);const v=110;d>=0?(e.fillStyle="#60a5fa",e.fillRect(b+v,f,v*d,10)):(e.fillStyle="#22d3ee",e.fillRect(b+v+v*d,f,-110*d,10)),this._drawLabel(e,`Balance ${u}%`,b+_,f-8,11,"#9ca3af","right");const x=b+_-26,w=f+44;this._drawDial(e,x,w,20,-Math.PI/2,-Math.PI/2+this.constrain(c,0,1)*Math.PI*2,"#22d3ee","#0f172a",6),this._drawLabel(e,"Spread",x,w+28,11,"#9ca3af","center")}_renderBands(e){const t=this.rectBands,s=this._bands||[],i=["Sub","Bass","Lowâ€‘Mid","Mid","Uâ€‘Mid","Pres","Treble","Brill","Ultra"],r=Math.min(9,s.length),a=Math.floor((t.w-8*(r-1))/r),o=t.y+t.h-16;let n=0,l=-1;for(let e=0;e<r;e++)s[e]>l&&(l=s[e],n=e);for(let l=0;l<r;l++){const r=this.constrain(s[l],0,1),h=t.x+l*(a+8),d=(t.h,l===n),u=d?"#f59e0b":"#60a5fa",c=d?"#fde68a":"#93c5fd";this._drawBar(e,h,o-(t.h-30),a,t.h-30,r,u,c,null,d?.95:.85),this._drawLabel(e,i[l]||`B${l}`,h+a/2,o,11,"#94a3b8","center")}this._drawLabel(e,"Band Energy",t.x,t.y+12,12,"#cbd5e1","left")}_renderSpectrum(e){const t=this.rectSpec,{wBar:s,gap:i}={wBar:this.specBar.w,gap:this.specBar.gap};e.fillStyle="#0b1020",e.fillRect(t.x,t.y,t.w,t.h),e.strokeStyle="rgba(255,255,255,0.05)",e.lineWidth=1,e.beginPath();for(let s=0;s<=4;s++){const i=t.y+s/4*t.h;e.moveTo(t.x,i),e.lineTo(t.x+t.w,i)}e.stroke();const r=this.specBars;for(let a=0;a<r;a++){const r=t.x+a*(s+i),o=this.specSmooth[a],n=this.specPeak[a];this._drawBar(e,r,t.y,s,t.h,o,"#60a5fa","#fde68a",n,.9)}const a=t.x+this.constrain(this.smooth.centroidN,0,1)*t.w;if(e.strokeStyle="rgba(34,197,94,0.65)",e.beginPath(),e.moveTo(a,t.y),e.lineTo(a,t.y+t.h),e.stroke(),this._drawLabel(e,"centroid",a+4,t.y+12,10,"#86efac","left"),this._audio?.dominantFreq){const s=this.constrain(this._audio.dominantFreq/22050,0,1),i=t.x+s*t.w;e.strokeStyle="rgba(236,72,153,0.55)",e.beginPath(),e.moveTo(i,t.y),e.lineTo(i,t.y+t.h),e.stroke(),this._drawLabel(e,`${Math.round(this._audio.dominantFreq)} Hz`,i+4,t.y+28,10,"#f9a8d4","left")}this._drawLabel(e,"Spectrum (64 bars, peakâ€‘hold)",t.x,t.y+12,12,"#cbd5e1","left")}_renderWaves(e){const t=this.rectWaves,s=Math.floor(t.h/2)-6,i={x:t.x,y:t.y,w:t.w,h:s},r={x:t.x,y:t.y+s+12,w:t.w,h:s};this._drawScope(e,i,this._audio?.timeLeft,"#22d3ee"),this._drawScope(e,r,this._audio?.timeRight,"#60a5fa"),this._drawLabel(e,"Oscilloscope L",i.x,i.y+10,12,"#cbd5e1","left"),this._drawLabel(e,"Oscilloscope R",r.x,r.y+10,12,"#cbd5e1","left")}_renderSparklines(e){const t=this.rectSparks,s=Math.floor((t.h-20)/3),i=e=>({x:t.x,y:t.y+e*(s+10),w:t.w,h:s}),r=i(0),a=i(1),o=i(2),n=this._rollHistory(this.hist.flux,this.hist.write),l=this._rollHistory(this.hist.energy,this.hist.write),h=this._rollHistory(this.hist.loudDb,this.hist.write),d=this._rollHistory(this.hist.dropStart,this.hist.write),u=this._rollHistory(this.hist.dropBloom,this.hist.write),c=this._rollHistory(this.hist.melody,this.hist.write);this._drawSpark(e,r,n,"#34d399",0,1),this._drawEventMarkers(e,r,d,"rgba(34,197,94,0.85)",.85,3),this._drawEventMarkers(e,r,u,"rgba(45,212,191,0.75)",.65,2),this._drawEventMarkers(e,r,c,"rgba(244,114,182,0.75)",.55,2),this._drawSpark(e,a,l,"#60a5fa",0,1),this._drawEventMarkers(e,a,d,"rgba(34,197,94,0.65)",.6,2),this._drawEventMarkers(e,a,u,"rgba(45,212,191,0.55)",.45,1.5),this._drawEventMarkers(e,a,c,"rgba(244,114,182,0.55)",.35,1.5),this._drawSpark(e,o,h,"#f59e0b",0,1),this._drawEventMarkers(e,o,d,"rgba(34,197,94,0.45)",.45,1.5),this._drawEventMarkers(e,o,u,"rgba(45,212,191,0.6)",.75,2),this._drawEventMarkers(e,o,c,"rgba(244,114,182,0.7)",.85,2.5),this._drawLabel(e,"Flux",r.x+6,r.y+10,11,"#cbd5e1","left"),this._drawLabel(e,"Energy",a.x+6,a.y+10,11,"#cbd5e1","left"),this._drawLabel(e,"Loud (Aâ€‘dB norm)",o.x+6,o.y+10,11,"#cbd5e1","left")}_rollHistory(e,t){const s=e.length,i=new Float32Array(s),r=s-t;return i.set(e.subarray(t),0),i.set(e.subarray(0,t),r),i}_drawEventMarkers(e,t,s,i,r=1,a=2){if(!s||!s.length)return;const{x:o,y:n,w:l,h:h}=t;e.save(),e.beginPath(),e.rect(o,n,l,h),e.clip(),e.fillStyle=i;const d=s.length,u=Math.max(4,h*this.constrain(r,0,1)),c=n+(h-u),p=Math.max(1,Math.floor(d/l));for(let t=0;t<d;t++){if(s[t]<=0)continue;if(p>1&&t%p!==0)continue;const i=o+t/(d-1)*l;e.fillRect(i-a/2,c,a,u)}e.restore()}_resolveCaptureEnabled(){if(!1===this.config?.jsonCaptureEnabled)return!1;if("undefined"==typeof window)return!0;const e=window.VISUALIZER_EXPORT_ENABLED??window.EXPORT_VISUAL??window.EXPORT_VISUAL_ENABLED;if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["false","0","off","disabled","no"].includes(t))return!1}return!1!==window.vvavyExportsEnabled&&(!window.vvavyExportStatus||!1!==window.vvavyExportStatus.enabled)}_handleExportsReadyEvent(e){const t=e?.detail?.enabled;void 0!==t&&this._applyCaptureEnabled(Boolean(t))}_applyCaptureEnabled(e){const t=Boolean(e);this._captureEnabled!==t&&(this._captureEnabled=t,t?this._jsonOverlayEl||this._initJsonOverlay():(this._jsonOverlayVisible=!1,this._jsonOverlayEl?.parentNode&&this._jsonOverlayEl.parentNode.removeChild(this._jsonOverlayEl),this._jsonOverlayEl=null,this._jsonOverlayPre=null,this._jsonOverlayTextarea=null,this._jsonOverlayCopyBtn=null,this._jsonOverlayDownloadBtn=null,this._jsonOverlayPauseBtn=null,this._jsonOverlayAggregateTitle=null,this._jsonOverlayHint=null,this._snapshotHistory=[],this._aggregateJsonString="",this._aggregateDirty=!1))}_initJsonOverlay(){if("undefined"==typeof document||this._jsonOverlayEl)return;const e=document.createElement("div");e.dataset.debugVisualizerJson="true",Object.assign(e.style,{position:"fixed",bottom:"16px",right:"16px",maxWidth:"min(460px, 95vw)",maxHeight:"70vh",overflow:"auto",padding:"14px 16px",background:"rgba(7, 10, 18, 0.94)",border:"1px solid rgba(96, 165, 250, 0.45)",borderRadius:"12px",fontFamily:"ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",fontSize:"12px",lineHeight:"1.5",color:"#e2e8f0",whiteSpace:"normal",wordBreak:"break-word",zIndex:"2147483000",pointerEvents:"auto",boxShadow:"0 18px 32px rgba(15, 23, 42, 0.65)",backdropFilter:"blur(6px)"});const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.gap="12px",t.style.marginBottom="10px";const s=document.createElement("div");s.textContent="AudioMetrics Stream (JSON)",s.style.fontWeight="600",s.style.fontSize="12px",s.style.color="#93c5fd";const i=document.createElement("div");i.style.display="flex",i.style.gap="6px";const r=e=>{const t=document.createElement("button");return t.type="button",t.textContent=e,Object.assign(t.style,{background:"rgba(30, 64, 175, 0.55)",color:"#e0f2fe",border:"1px solid rgba(96, 165, 250, 0.6)",borderRadius:"6px",padding:"4px 8px",fontSize:"11px",fontFamily:"inherit",cursor:"pointer",transition:"background 0.2s ease, border-color 0.2s ease"}),t.addEventListener("mouseenter",()=>{t.style.background="rgba(30, 64, 175, 0.75)"}),t.addEventListener("mouseleave",()=>{t.style.background="rgba(30, 64, 175, 0.55)"}),t},a=r("Copy all");a.addEventListener("click",()=>this._copyAggregateToClipboard());const o=r("Download");o.addEventListener("click",()=>this._downloadAggregateJson());const n=r("Clear");n.addEventListener("click",()=>this._clearAggregateHistory());const l=r("Pause capture");l.addEventListener("click",()=>this._toggleCapturePause()),l.addEventListener("mouseenter",()=>{"true"===l.dataset.capturePaused&&(l.style.background="rgba(30, 64, 175, 0.55)")}),l.addEventListener("mouseleave",()=>{"true"===l.dataset.capturePaused&&(l.style.background="rgba(30, 64, 175, 0.3)")}),i.appendChild(a),i.appendChild(o),i.appendChild(n),i.appendChild(l),t.appendChild(s),t.appendChild(i);const h=document.createElement("div");h.textContent="Frames append in real-time. JSON lines = one frame per line.",h.style.fontSize="11px",h.style.marginBottom="12px",h.style.color="#64748b";const d=document.createElement("div");d.textContent="Latest frame",d.style.fontSize="11px",d.style.fontWeight="600",d.style.color="#cbd5f5",d.style.marginBottom="4px";const u=document.createElement("pre");Object.assign(u.style,{margin:"0 0 12px",fontSize:"11px",whiteSpace:"pre-wrap",background:"rgba(15, 23, 42, 0.6)",padding:"8px",borderRadius:"8px",border:"1px solid rgba(99, 102, 241, 0.25)",maxHeight:"160px",overflow:"auto"});const c=document.createElement("div");c.textContent="Aggregated frames (JSON lines)",c.style.fontSize="11px",c.style.fontWeight="600",c.style.color="#cbd5f5",c.style.marginBottom="4px";const p=document.createElement("textarea");Object.assign(p.style,{width:"100%",height:"200px",background:"rgba(15, 23, 42, 0.6)",color:"#e2e8f0",border:"1px solid rgba(99, 102, 241, 0.25)",borderRadius:"8px",padding:"8px",fontSize:"11px",fontFamily:"inherit",lineHeight:"1.4",resize:"vertical"}),p.readOnly=!0,p.placeholder="Waiting for framesâ€¦",e.appendChild(t),e.appendChild(h),e.appendChild(d),e.appendChild(u),e.appendChild(c),e.appendChild(p),e.style.display="none",document.body.appendChild(e),this._jsonOverlayEl=e,this._jsonOverlayPre=u,this._jsonOverlayTextarea=p,this._jsonOverlayCopyBtn=a,this._jsonOverlayDownloadBtn=o,this._jsonOverlayPauseBtn=l,this._jsonOverlayAggregateTitle=c,this._jsonOverlayHint=h,this._jsonOverlayHintBase=h.textContent,this._syncCapturePauseState()}_toggleCapturePause(){this._captureEnabled&&(this._capturePaused=!this._capturePaused,this._syncCapturePauseState(),this._jsonOverlayVisible&&this._updateJsonDisplay())}_syncCapturePauseState(){const e=this._captureEnabled&&!this._capturePaused;this._jsonOverlayPauseBtn&&(this._jsonOverlayPauseBtn.textContent=e?"Pause capture":"Resume capture",this._jsonOverlayPauseBtn.dataset.capturePaused=e?"false":"true",this._jsonOverlayPauseBtn.style.background=e?"rgba(30, 64, 175, 0.55)":"rgba(30, 64, 175, 0.3)",this._jsonOverlayPauseBtn.style.borderColor=e?"rgba(96, 165, 250, 0.6)":"rgba(148, 163, 184, 0.6)"),this._jsonOverlayHint&&(this._jsonOverlayHintBase||(this._jsonOverlayHintBase=this._jsonOverlayHint.textContent),this._jsonOverlayHint.textContent=e?this._jsonOverlayHintBase:"Capture paused. Resume to continue logging new frames."),!this._jsonOverlayTextarea||e||this._jsonOverlayTextarea.value||(this._jsonOverlayTextarea.placeholder="Capture pausedâ€¦")}_setJsonOverlayVisible(e){if(!this._jsonOverlayEl)return;const t=Boolean(e);this._jsonOverlayVisible!==t?(this._jsonOverlayVisible=t,this._jsonOverlayEl.style.display=t?"block":"none",t&&this._updateJsonDisplay()):t&&this._updateJsonDisplay()}_updateJsonDisplay(){if(this._jsonOverlayVisible){if(this._syncCapturePauseState(),this._jsonOverlayPre&&(this._jsonOverlayPre.textContent=this._latestSnapshotString||"No snapshot yet."),this._aggregateDirty&&(this._aggregateJsonString=this._snapshotHistory.length?this._snapshotHistory.join("\n"):"",this._aggregateDirty=!1),this._jsonOverlayTextarea){const e=this._captureEnabled&&!this._capturePaused;this._jsonOverlayTextarea.value=this._aggregateJsonString||"",e&&this._snapshotHistory.length?this._jsonOverlayTextarea.placeholder="":e||this._jsonOverlayTextarea.value||(this._jsonOverlayTextarea.placeholder="Capture pausedâ€¦")}if(this._jsonOverlayAggregateTitle){const e=this._snapshotHistory.length,t=this._snapshotLimit;this._jsonOverlayAggregateTitle.textContent=`Aggregated frames (JSON lines) â€” ${e}/${t}`}}}_updateFrameSnapshot(e){if(!e)return;const t=this._frameCounter++,s=this._serializeAudioFrame(e,t);if(!s)return;if(this._latestSnapshot=s,this._latestSnapshotString=JSON.stringify(s,null,2),!this._captureEnabled||this._capturePaused)return void(this._jsonOverlayVisible&&this._updateJsonDisplay());const i=JSON.stringify(s);if(i){const e=this._snapshotHistory.length>=this._snapshotLimit;e&&(this._snapshotHistory.shift(),this._aggregateDirty=!0),this._snapshotHistory.push(i),e||(this._aggregateJsonString=this._aggregateJsonString?`${this._aggregateJsonString}\n${i}`:i)}!this._jsonOverlayVisible&&this._snapshotHistory.length?this._setJsonOverlayVisible(!0):this._jsonOverlayVisible&&this._updateJsonDisplay()}_copyAggregateToClipboard(){if(!this._captureEnabled||!this._snapshotHistory.length)return;this._aggregateDirty&&(this._aggregateJsonString=this._snapshotHistory.join("\n"),this._aggregateDirty=!1);const e=this._aggregateJsonString;e&&(navigator?.clipboard?.writeText?navigator.clipboard.writeText(e).catch(()=>this._fallbackCopy(e)):this._fallbackCopy(e))}_downloadAggregateJson(){if(!this._captureEnabled||!this._snapshotHistory.length)return;const e="[\n"+this._snapshotHistory.join(",\n")+"\n]",t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`audio-metrics-${Date.now()}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>URL.revokeObjectURL(s),1e3)}_clearAggregateHistory(){this._captureEnabled&&(this._snapshotHistory=[],this._aggregateJsonString="",this._aggregateDirty=!1,this._jsonOverlayTextarea&&(this._jsonOverlayTextarea.value="",this._jsonOverlayTextarea.placeholder="Cleared. Waiting for framesâ€¦"),this._jsonOverlayAggregateTitle&&(this._jsonOverlayAggregateTitle.textContent=`Aggregated frames (JSON lines) â€” 0/${this._snapshotLimit}`),this._syncCapturePauseState())}_fallbackCopy(e){try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.top="-1000px",t.style.left="-1000px",document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}catch(e){}}_serializeAudioFrame(e,t=null){if(!e)return null;const s=Number.isFinite(e.loudnessShortDb)?e.loudnessShortDb:Number(e.aWeighted?.mono?.db??NaN),i=Number(e.loudnessIntegratedDb),r=Number(e.percussiveEnergy),a=Number(e.harmonicEnergy);let o=Number(e.percussiveRatio);if(!Number.isFinite(o)&&(Number.isFinite(r)||Number.isFinite(a))){const e=Number.isFinite(r)?r:0,t=Number.isFinite(a)?a:0;o=t+e>0?e/(e+t):null}const n=e.smoothedSpectrum&&e.smoothedSpectrum.length?e.smoothedSpectrum:this.specSmooth,l=e.peakSpectrum&&e.peakSpectrum.length?e.peakSpectrum:this.specPeak,h=this._serializeFloatArray(32===n.length?n:this._resampleFloat(n,32),null,4,0),d=this._serializeFloatArray(32===l.length?l:this._resampleFloat(l,32),null,4,0),u=this._serializeFloatArray(e.fluxByBand,null,4,0),c=this.audioTriggers||{},p={subBass:this._serializeNumber(e.subBassEnergy,4,null),bass:this._serializeNumber(e.bassEnergy,4,null),lowMid:this._serializeNumber(e.lowMidEnergy,4,null),mid:this._serializeNumber(e.midEnergy,4,null),upperMid:this._serializeNumber(e.upperMidEnergy,4,null),presence:this._serializeNumber(e.presenceEnergy,4,null),treble:this._serializeNumber(e.trebleEnergy,4,null),brilliance:this._serializeNumber(e.brillianceEnergy,4,null),ultrasonic:this._serializeNumber(e.ultrasonicEnergy??e.ultrassonicEnergy,4,null)};return{meta:{timestampIso:(new Date).toISOString(),frameIndex:Number.isFinite(t)?t:null,mediaTime:this._serializeNumber(e.mediaTime,3,null),mediaDuration:this._serializeNumber(e.mediaDuration,3,null)},beats:{tempo:this._serializeNumber(e.tempo,2,null),tempoConfidence:this._serializeNumber(e.tempoConfidence,3,null),isBeat:Boolean(e.isBeat),beatPhase:this._serializeNumber(e.beatPhase,3,null),predictedNextBeat:this._serializeNumber(e.predictedNextBeat,3,null),dropStart:Boolean(c.dropStart),dropBloom:Boolean(c.dropBloom),dropScore:this._serializeNumber(c.dropScore,3,null),melodyChange:Boolean(c.melodyChange),melodyChangeScore:this._serializeNumber(c.melodyChangeScore,3,null)},loudness:{shortDb:this._serializeNumber(s,2,null),integratedDb:this._serializeNumber(i,2,null),rms:this._serializeNumber(e.rms,4,null),aWeightedNormalized:this._serializeNumber(e.aWeighted?.mono?.normalized,4,null)},dynamics:{rmsTime:this._serializeNumber(e.rmsTime,4,null),crestTime:this._serializeNumber(e.crestTime,4,null),overallEnergy:this._serializeNumber(e.overallEnergy??e.energy,4,null),energyChange:this._serializeNumber(e.energyChange,4,null),energyChangeIntensity:this._serializeNumber(e.energyChangeIntensity,4,null)},texture:{percussiveEnergy:this._serializeNumber(r,4,null),harmonicEnergy:this._serializeNumber(a,4,null),percussiveRatio:this._serializeNumber(o,4,null),spectralFlatnessTrue:this._serializeNumber(e.spectralFlatnessTrue??e.spectralFlatnessSmoothed??e.flatness,4,null),spectralEntropy:this._serializeNumber(e.spectralEntropy,4,null)},motion:{spectralFlux:this._serializeNumber(e.spectralFlux,4,null),fluxByBand:u},spectrum:{centroidHz:this._serializeNumber(e.centroid,1,null),centroidNormalized:this._serializeNumber(e.spectralCentroidNormalized,4,null),spectralRolloff85Hz:this._serializeNumber(e.spectralRolloff85,0,null),spectralRolloff95Hz:this._serializeNumber(e.spectralRolloff95,0,null),spectralSlope:this._serializeNumber(e.spectralSlope,4,null),spectralSpreadHz:this._serializeNumber(e.spectralSpreadHz,0,null),spectralSkewness:this._serializeNumber(e.spectralSkewness,4,null)},pitch:{dominantFreq:this._serializeNumber(e.dominantFreq,1,null),dominantFreqPrecise:this._serializeNumber(e.dominantFreqPrecise,1,null)},stereo:{stereoBalance:this._serializeNumber(e.stereoBalance,4,null),midSideRatio:this._serializeNumber(e.midSideRatio,4,null),interchannelCorrelation:this._serializeNumber(e.interchannelCorrelation,4,null),rmsLeft:this._serializeNumber(e.rmsLeft,4,null),rmsRight:this._serializeNumber(e.rmsRight,4,null)},bands:p,bars:{smoothed32:h,peak32:d},timeDomain:{zcr:this._serializeNumber(e.zcr,4,null),waveformPreview:this._serializeWaveform(e.timeDomainLeft??null,64)}}}_serializeNumber(e,t=4,s=null){const i=Number(e);if(!Number.isFinite(i))return s;const r=Math.pow(10,t);return Math.round(i*r)/r}_serializeFloatArray(e,t=null,s=4,i=0){if(!e||!e.length)return[];let r=e;if(!Array.isArray(e)&&!ArrayBuffer.isView(e))return[];if(Number.isInteger(t)&&t>0&&e.length>t){const s=ArrayBuffer.isView(e)?e:Float32Array.from(e);r=this._resampleFloat(s,t)}return(Array.isArray(r)?r:Array.from(r)).map(e=>this._serializeNumber(e,s,i))}_serializeWaveform(e,t=64){if(!e||!e.length)return[];const s=Math.min(t,e.length),i=[];for(let t=0;t<s;t++){const r=(e[Math.floor(t/Math.max(s-1,1)*(e.length-1))]-128)/128;i.push(this._serializeNumber(r,3,0))}return i}destroy(){this._jsonOverlayEl?.parentNode&&this._jsonOverlayEl.parentNode.removeChild(this._jsonOverlayEl),this._jsonOverlayEl=null,this._jsonOverlayPre=null,this._jsonOverlayTextarea=null,this._jsonOverlayCopyBtn=null,this._jsonOverlayDownloadBtn=null,this._jsonOverlayPauseBtn=null,this._jsonOverlayAggregateTitle=null,this._jsonOverlayHint=null,this._snapshotHistory=[],this._aggregateJsonString="",this._aggregateDirty=!1,"undefined"!=typeof window&&this._boundExportsHandler&&(window.removeEventListener("vvavy:exports-ready",this._boundExportsHandler),this._boundExportsHandler=null),super.destroy()}}window.DebugVisualizer=DebugVisualizer;