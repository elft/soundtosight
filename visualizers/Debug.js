class DebugVisualizer extends BaseVisualizer{static meta={description:"Audio metrics HUD for inspecting every field coming from AudioManager.",tags:["debug","analysis","utility"]};constructor(t=null,e={}){super(t,{backgroundColor:"#0b0d12",force2d:!0,stereoMode:!0,debug:!1,...e})}async init(){this.margin=16,this.pad=10,this.specBars=64,this.histLen=360,this.prevT=.001*performance.now(),this.smooth={rms:0,energy:0,flux:0,flat:0,balance:0,spread:0,loudDbN:0,tempo:120,centroidN:0},this.specSmooth=new Float32Array(this.specBars),this.specPeak=new Float32Array(this.specBars),this.eventHold={snare:0,hat:0},this.hist={flux:new Float32Array(this.histLen),energy:new Float32Array(this.histLen),loudDb:new Float32Array(this.histLen),snare:new Float32Array(this.histLen),hat:new Float32Array(this.histLen),write:0},this.bandKeys=["subBassEnergy","bassEnergy","lowMidEnergy","midEnergy","upperMidEnergy","presenceEnergy","trebleEnergy","brillianceEnergy","ultrassonicEnergy","ultrasonicEnergy"],this._computeBarLayout()}onResize(){this._computeBarLayout()}_computeBarLayout(){const t=this.width,e=this.height,s=this.margin,i=this.pad,a=e-2*s-(440+3*i),r=Math.max(160,a);let h=s;this.rectTop={x:s,y:h,w:t-2*s,h:140},h+=140+i,this.rectBands={x:s,y:h,w:t-2*s,h:110},h+=110+i,this.rectSpec={x:s,y:h,w:t-2*s,h:r},h+=r+i,this.rectWaves={x:s,y:h,w:t-2*s,h:120},h+=120+i,this.rectSparks={x:s,y:h,w:t-2*s,h:70};const o=Math.floor((this.rectSpec.w-3*(this.specBars-1))/this.specBars);this.specBar={w:Math.max(2,o),gap:3}}_sampleSpectrum(t){const e=t.frequencyLeft||new Uint8Array(0),s=t.frequencyRight||e,i=Math.min(e.length,s.length);if(!i)return new Float32Array(this.specBars);const a=new Float32Array(i);for(let t=0;t<i;t++)a[t]=.5*(e[t]+s[t]);const r=new Float32Array(this.specBars),h=i/this.specBars;for(let t=0;t<this.specBars;t++){const e=Math.floor(t*h),s=Math.min(i-1,Math.floor((t+1)*h));let o=0;const n=Math.max(1,s-e+1);for(let t=e;t<=s;t++)o+=a[t];r[t]=o/(255*n)}return r}_drawLabel(t,e,s,i,a=12,r="#cbd5e1",h="left"){t.fillStyle=r,t.font=`${a}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`,t.textAlign=h,t.textBaseline="middle",t.fillText(e,s,i)}_drawDial(t,e,s,i,a,r,h="#60a5fa",o="#1f2937",n=8){t.beginPath(),t.arc(e,s,i,0,2*Math.PI),t.strokeStyle=o,t.lineWidth=n,t.stroke(),t.beginPath(),t.arc(e,s,i,a,r),t.strokeStyle=h,t.lineWidth=n,t.lineCap="round",t.stroke()}_drawBar(t,e,s,i,a,r,h,o,n,l=1){const c=a*this.constrain(r,0,1);if(t.globalAlpha=l,t.fillStyle=h,t.fillRect(e,s+(a-c),i,c),null!=n){const r=s+a-a*this.constrain(n,0,1);t.fillStyle=o,t.fillRect(e,Math.max(s,r-2),i,2)}t.globalAlpha=1}_drawScope(t,e,s,i="#93c5fd"){const{x:a,y:r,w:h,h:o}=e;if(t.save(),t.beginPath(),t.rect(a,r,h,o),t.clip(),t.fillStyle="#0f172a",t.fillRect(a,r,h,o),!s||!s.length)return void t.restore();t.strokeStyle=i,t.lineWidth=1.5,t.beginPath();const n=s.length;for(let e=0;e<n;e++){const i=a+e/(n-1)*h,l=r+.5*o-(s[e]-128)/128*(.45*o);0===e?t.moveTo(i,l):t.lineTo(i,l)}t.stroke(),t.restore()}_drawSpark(t,e,s,i="#34d399",a=-1,r=1){const{x:h,y:o,w:n,h:l}=e;t.save(),t.beginPath(),t.rect(h,o,n,l),t.clip(),t.fillStyle="#0b1020",t.fillRect(h,o,n,l);const c=s.length;t.strokeStyle=i,t.lineWidth=1.25,t.beginPath();for(let e=0;e<c;e++){const i=h+e/(c-1)*n,d=o+l-(this.constrain(s[e],a,r)-a)/(r-a)*l;0===e?t.moveTo(i,d):t.lineTo(i,d)}if(t.stroke(),a<0&&r>0){const e=o+l-(0-a)/(r-a)*l;t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=1,t.beginPath(),t.moveTo(h,e),t.lineTo(h+n,e),t.stroke()}t.restore()}update(t){if(super.update(t),!t)return;const e=.001*performance.now(),s=this.constrain(e-this.prevT,1/240,.1);this.prevT=e;const i=Number(t.rms)||0,a=Number(t.overallEnergy??t.energy)||0,r=Number(t.spectralFlux)||0,h=Number(t.spectralFlatnessSmoothed??t.flatness)||0,o=Number(t.stereoBalance)||0,n=Number(t.stereoSpread??Math.abs(o))||0,l=Number(t.spectralCentroidNormalized??t.centroid/(("undefined"!=typeof window&&window.vvavy?.audioManager?.audioContext?.sampleRate||48e3)/2))||0,c=Number(t.tempo)||0,d=Boolean(t.isBeat),m=Boolean(t.bassDrop),f=Number(t.aWeighted?.mono?.db)||-60,p=this.constrain((f+60)/60,0,1);this.smooth.rms=this.attackRelease(this.smooth.rms,i,s,.04,.18),this.smooth.energy=this.attackRelease(this.smooth.energy,a,s,.05,.3),this.smooth.flux=this.attackRelease(this.smooth.flux,r,s,.03,.2),this.smooth.flat=this.attackRelease(this.smooth.flat,h,s,.08,.35),this.smooth.balance=this.attackRelease(this.smooth.balance,o,s,.03,.18),this.smooth.spread=this.attackRelease(this.smooth.spread,n,s,.08,.4),this.smooth.loudDbN=this.attackRelease(this.smooth.loudDbN,p,s,.1,.5),this.smooth.tempo=this.attackRelease(this.smooth.tempo,c,s,.5,1),this.smooth.centroidN=this.attackRelease(this.smooth.centroidN,l,s,.1,.6);const b=t.smoothedSpectrum,u=t.peakSpectrum;let y=b?this._resampleFloat(b,this.specBars):this._sampleSpectrum(t);const g=Math.exp(-s/.4),w=1-Math.exp(-s/.03),_=1-Math.exp(-s/.22);for(let t=0;t<this.specBars;t++){const e=this.constrain(y[t],0,1),s=this.specSmooth[t],i=s+(e-s)*(e>s?w:_);this.specSmooth[t]=b?e:i;const a=this.specPeak[t]*g;this.specPeak[t]=Math.max(this.specSmooth[t],a)}if(u&&u.length){const t=this._resampleFloat(u,this.specBars);this.specPeak.set(t)}const x=this.hist.write%this.histLen;this.hist.flux[x]=this.constrain(this.smooth.flux,0,1),this.hist.energy[x]=this.constrain(this.smooth.energy,0,1),this.hist.loudDb[x]=this.smooth.loudDbN,this.hist.snare[x]=t.snareHit?1:0,this.hist.hat[x]=t.hatTick?1:0,this.hist.write=(x+1)%this.histLen,this.eventHold.snare=Math.max(0,this.eventHold.snare-s),this.eventHold.hat=Math.max(0,this.eventHold.hat-s),t.snareHit&&(this.eventHold.snare=.28),t.hatTick&&(this.eventHold.hat=.18);const S=this.eventHold.snare>0,M=this.eventHold.hat>0;this._audio={isBeat:d,bassDrop:m,beatPhase:this.constrain(Number(t.beatPhase)||0,0,1),predictedNextBeat:t.predictedNextBeat,time:Number(t.time)||0,rmsLeft:Number(t.rmsLeft)||0,rmsRight:Number(t.rmsRight)||0,timeLeft:t.timeDomainLeft,timeRight:t.timeDomainRight,dominantFreq:Number(t.dominantFreq)||0,aDb:f,bpmRounded:Math.round(this.smooth.tempo||0),snareActive:S,hatActive:M},this._bands=this._collectBands(t)}_resampleFloat(t,e){const s=new Float32Array(e);if(!t||!t.length)return s;const i=t.length,a=i/e;for(let r=0;r<e;r++){const e=Math.floor(r*a),h=Math.min(i-1,Math.floor((r+1)*a));let o=0,n=Math.max(1,h-e+1);for(let s=e;s<=h;s++)o+=t[s];s[r]=o/n}return s}_collectBands(t){const e=[];for(let s=0;s<9;s++){const i=this.bandKeys[s];e.push(Number(t[i])||0)}const s=Number(t.ultrassonicEnergy??t.ultrasonicEnergy)||0;return e.push(s),e}onRender(){const t=this.ctx,e=this.width,s=this.height;t.fillStyle=this.config.backgroundColor,t.fillRect(0,0,e,s),this._drawBackdropGradients(t),this._renderTop(t),this._renderBands(t),this._renderSpectrum(t),this._renderWaves(t),this._renderSparklines(t)}_drawBackdropGradients(t){const e=t.createLinearGradient(0,0,0,this.height);e.addColorStop(0,"rgba(88,28,135,0.08)"),e.addColorStop(.5,"rgba(2,6,23,0.0)"),e.addColorStop(1,"rgba(8,47,73,0.10)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height)}_renderTop(t){const e=this.rectTop,s=e.x+.12*e.w,i=e.y+.52*e.h,a=Math.min(.45*e.h,58),r=(this._audio?.beatPhase??0)*Math.PI*2,h=this._audio?.isBeat?"#f59e0b":"#60a5fa";this._drawDial(t,s,i,a,-Math.PI/2,-Math.PI/2+r,h,"#0f172a",10),this._audio?.isBeat&&(t.beginPath(),t.arc(s,i,a+6,0,2*Math.PI),t.strokeStyle="rgba(245,158,11,0.55)",t.lineWidth=3,t.stroke()),this._audio?.bassDrop&&(t.beginPath(),t.arc(s,i,a+12,0,2*Math.PI),t.strokeStyle="rgba(16,185,129,0.45)",t.lineWidth=2,t.setLineDash([6,8]),t.stroke(),t.setLineDash([]));const o=this._audio?.bpmRounded??0;if(this._drawLabel(t,`${o} BPM`,s,i,18,"#e5e7eb","center"),this._audio?.predictedNextBeat&&Number.isFinite(this._audio.time)){const e=Math.max(0,this._audio.predictedNextBeat-this._audio.time);this._drawLabel(t,`next ${e.toFixed(2)}s`,s,i+a+16,12,"#93c5fd","center")}const n=e.x+.25*e.w,l=e.y+20,c=this.smooth.balance,d=(c+1)/2*100|0,m=this.smooth.spread,f=this._audio?.snareHit,p=this._audio?.hatActive,b=[["RMS",this.smooth.rms.toFixed(3)],["Loud (A‑dB)",`${this._audio?.aDb.toFixed(1)} dB`],["Energy",this.smooth.energy.toFixed(3)],["Flux",this.smooth.flux.toFixed(3)],["Flatness",this.smooth.flat.toFixed(3)],["Centroid",`${(100*this.smooth.centroidN).toFixed(1)}% nyq`],["Snare Hit",f?"TRUE":"FALSE",f?"#fda4af":"#9ca3af"],["Hat Tick",p?"TRUE":"FALSE",p?"#38bdf8":"#9ca3af"]];for(let e=0;e<b.length;e++){const[s,i,a]=b[e],r=a||"#cbd5e1";this._drawLabel(t,`${s}: ${i}`,n,l+18*e,12,r,"left")}const u=220,y=e.x+e.w-u-10,g=e.y+.32*e.h;t.fillStyle="#0f172a",t.fillRect(y,g,u,10),t.fillStyle="rgba(255,255,255,0.12)",t.fillRect(y+110-1,g,2,10);const w=110;c>=0?(t.fillStyle="#60a5fa",t.fillRect(y+w,g,w*c,10)):(t.fillStyle="#22d3ee",t.fillRect(y+w+w*c,g,-110*c,10)),this._drawLabel(t,`Balance ${d}%`,y+u,g-8,11,"#9ca3af","right");const _=y+u-26,x=g+44;this._drawDial(t,_,x,20,-Math.PI/2,-Math.PI/2+this.constrain(m,0,1)*Math.PI*2,"#22d3ee","#0f172a",6),this._drawLabel(t,"Spread",_,x+28,11,"#9ca3af","center")}_renderBands(t){const e=this.rectBands,s=this._bands||[],i=["Sub","Bass","Low‑Mid","Mid","U‑Mid","Pres","Treble","Brill","Ultra"],a=Math.min(9,s.length),r=Math.floor((e.w-8*(a-1))/a),h=e.y+e.h-16;let o=0,n=-1;for(let t=0;t<a;t++)s[t]>n&&(n=s[t],o=t);for(let n=0;n<a;n++){const a=this.constrain(s[n],0,1),l=e.x+n*(r+8),c=(e.h,n===o),d=c?"#f59e0b":"#60a5fa",m=c?"#fde68a":"#93c5fd";this._drawBar(t,l,h-(e.h-30),r,e.h-30,a,d,m,null,c?.95:.85),this._drawLabel(t,i[n]||`B${n}`,l+r/2,h,11,"#94a3b8","center")}this._drawLabel(t,"Band Energy",e.x,e.y+12,12,"#cbd5e1","left")}_renderSpectrum(t){const e=this.rectSpec,{wBar:s,gap:i}={wBar:this.specBar.w,gap:this.specBar.gap};t.fillStyle="#0b1020",t.fillRect(e.x,e.y,e.w,e.h),t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,t.beginPath();for(let s=0;s<=4;s++){const i=e.y+s/4*e.h;t.moveTo(e.x,i),t.lineTo(e.x+e.w,i)}t.stroke();const a=this.specBars;for(let r=0;r<a;r++){const a=e.x+r*(s+i),h=this.specSmooth[r],o=this.specPeak[r];this._drawBar(t,a,e.y,s,e.h,h,"#60a5fa","#fde68a",o,.9)}const r=e.x+this.constrain(this.smooth.centroidN,0,1)*e.w;if(t.strokeStyle="rgba(34,197,94,0.65)",t.beginPath(),t.moveTo(r,e.y),t.lineTo(r,e.y+e.h),t.stroke(),this._drawLabel(t,"centroid",r+4,e.y+12,10,"#86efac","left"),this._audio?.dominantFreq){const s=this.constrain(this._audio.dominantFreq/22050,0,1),i=e.x+s*e.w;t.strokeStyle="rgba(236,72,153,0.55)",t.beginPath(),t.moveTo(i,e.y),t.lineTo(i,e.y+e.h),t.stroke(),this._drawLabel(t,`${Math.round(this._audio.dominantFreq)} Hz`,i+4,e.y+28,10,"#f9a8d4","left")}this._drawLabel(t,"Spectrum (64 bars, peak‑hold)",e.x,e.y+12,12,"#cbd5e1","left")}_renderWaves(t){const e=this.rectWaves,s=Math.floor(e.h/2)-6,i={x:e.x,y:e.y,w:e.w,h:s},a={x:e.x,y:e.y+s+12,w:e.w,h:s};this._drawScope(t,i,this._audio?.timeLeft,"#22d3ee"),this._drawScope(t,a,this._audio?.timeRight,"#60a5fa"),this._drawLabel(t,"Oscilloscope L",i.x,i.y+10,12,"#cbd5e1","left"),this._drawLabel(t,"Oscilloscope R",a.x,a.y+10,12,"#cbd5e1","left")}_renderSparklines(t){const e=this.rectSparks,s=Math.floor((e.h-20)/3),i=t=>({x:e.x,y:e.y+t*(s+10),w:e.w,h:s}),a=i(0),r=i(1),h=i(2),o=this._rollHistory(this.hist.flux,this.hist.write),n=this._rollHistory(this.hist.energy,this.hist.write),l=this._rollHistory(this.hist.loudDb,this.hist.write),c=this._rollHistory(this.hist.snare,this.hist.write),d=this._rollHistory(this.hist.hat,this.hist.write);this._drawSpark(t,a,o,"#34d399",0,1),this._drawEventMarkers(t,a,c,"rgba(236,72,153,0.85)",.85,3),this._drawEventMarkers(t,a,d,"rgba(14,165,233,0.65)",.55,2),this._drawSpark(t,r,n,"#60a5fa",0,1),this._drawEventMarkers(t,r,c,"rgba(236,72,153,0.65)",.65,2),this._drawEventMarkers(t,r,d,"rgba(14,165,233,0.55)",.4,1.5),this._drawSpark(t,h,l,"#f59e0b",0,1),this._drawEventMarkers(t,h,c,"rgba(236,72,153,0.45)",.45,1.5),this._drawEventMarkers(t,h,d,"rgba(14,165,233,0.9)",.85,2.5),this._drawLabel(t,"Flux",a.x+6,a.y+10,11,"#cbd5e1","left"),this._drawLabel(t,"Energy",r.x+6,r.y+10,11,"#cbd5e1","left"),this._drawLabel(t,"Loud (A‑dB norm)",h.x+6,h.y+10,11,"#cbd5e1","left")}_rollHistory(t,e){const s=t.length,i=new Float32Array(s),a=s-e;return i.set(t.subarray(e),0),i.set(t.subarray(0,e),a),i}_drawEventMarkers(t,e,s,i,a=1,r=2){if(!s||!s.length)return;const{x:h,y:o,w:n,h:l}=e;t.save(),t.beginPath(),t.rect(h,o,n,l),t.clip(),t.fillStyle=i;const c=s.length,d=Math.max(4,l*this.constrain(a,0,1)),m=o+(l-d),f=Math.max(1,Math.floor(c/n));for(let e=0;e<c;e++){if(s[e]<=0)continue;if(f>1&&e%f!==0)continue;const i=h+e/(c-1)*n;t.fillRect(i-r/2,m,r,d)}t.restore()}}window.DebugVisualizer=DebugVisualizer;