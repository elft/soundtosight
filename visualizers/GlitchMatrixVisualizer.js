class GlitchMatrixVisualizer extends BaseVisualizer{constructor(t,i={}){super(t,{backgroundColor:"#040e04",force2d:!0,...i})}async init(){this.isMobile="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches,this.ctx.font="12px monospace",this.ctx.textBaseline="top",this.columns=this.isMobile?24:42,this.rows=this.isMobile?18:28,this.cellWidth=this.width/this.columns,this.cellHeight=this.height/this.rows,this.loudness=0,this.prevLoudness=0,this.flux=0,this.beatPulse=0,this.lastRippleTime=0,this.ripples=[],this.glitchTime=0,this.glitchIntensity=0,this.flyingSymbols=[],this.launchCooldown=0,this.tempo=0,this.gridHue=120,this.codeSymbols="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ@#$%&",this.emojiSymbols=[],this.matrix=[],this._buildMatrix()}onResize(){this.columns=this.isMobile?24:42,this.rows=this.isMobile?18:28,this.cellWidth=this.width/this.columns,this.cellHeight=this.height/this.rows,this._buildMatrix()}_buildMatrix(){this.matrix=[];for(let t=0;t<this.rows;t++){const t=[];for(let i=0;i<this.columns;i++)t.push({value:this._randomSymbol(),brightness:Math.random(),glitch:0,offset:.3*(Math.random()-.5),flying:!1,returnProgress:1});this.matrix.push(t)}}_randomSymbol(){const t=Math.floor(Math.random()*this.codeSymbols.length);return this.codeSymbols.charAt(t)}dbTo01(t){return Math.min(Math.max((t+60)/60,0),1)}attackRelease(t,i,s,h=.05,l=.24){return t+(i-t)*(1-Math.exp(-s/(i>t?h:l)))}clamp(t,i,s){return Math.min(Math.max(t,i),s)}onUpdate(t){const i=Number.isFinite(t?.time)?t.time:.001*performance.now(),s=Math.min(.12,Math.max(1/240,i-(this._lastTime||i)));this._lastTime=i;const h=Number.isFinite(t?.loudnessShortDb)?t.loudnessShortDb:t?.aWeighted?.mono?.db??-60,l=this.dbTo01(h),e=Number.isFinite(t?.spectralFlux)?t.spectralFlux:0,o=t?.isBeat?1:0;this.prevLoudness=this.loudness,this.loudness=this.attackRelease(this.loudness,l,s,.04,.45),this.flux=this.attackRelease(this.flux,e,s,.1,.4),this.beatPulse=this.attackRelease(this.beatPulse,o,s,.04,.35),Math.abs(this.loudness-this.prevLoudness)>.01&&i-this.lastRippleTime>.12&&(this.lastRippleTime=i,this._spawnRipple(i,this.loudness)),o&&(this.glitchIntensity=Math.min(1,this.glitchIntensity+.35+.5*this.flux),this._launchSymbol(i)),this.glitchIntensity=Math.max(0,this.glitchIntensity-.32*s),this.glitchTime+=s*(1+4*this.glitchIntensity),this.launchCooldown=Math.max(0,this.launchCooldown-s),this._updateMatrix(s),this._updateRipples(s),this._updateFlyingSymbols(s)}_spawnRipple(t,i){this.ripples.push({start:t,radius:0,strength:i,speed:90+220*i}),this.ripples.length>6&&this.ripples.shift()}_updateMatrix(t){const i=this.glitchIntensity;for(let s=0;s<this.rows;s++)for(let h=0;h<this.columns;h++){const l=this.matrix[s][h],e=.08*(Math.random()-.5)*(1+3*i);l.brightness=this.clamp(l.brightness+e+.06*this.flux,0,1),Math.random()<.02+.2*i&&(l.value=this._randomSymbol()),Math.random()<.08+.12*this.flux?l.glitch=Math.min(1,l.glitch+.5):l.glitch=Math.max(0,l.glitch-2.5*t);const o=.15+.35*this.loudness+.5*i;l.offset=this.clamp(l.offset+(Math.random()-.5)*o*t,-.6,.6),l.flying||(l.returnProgress=Math.min(1,l.returnProgress+1.2*t))}}_updateRipples(t){for(const i of this.ripples)i.radius+=i.speed*t,i.strength*=Math.pow(.9,12*t);this.ripples=this.ripples.filter(t=>t.strength>.05)}onRender(){const t=this.ctx;t.fillStyle="#050b05",t.fillRect(0,0,this.width,this.height),this._drawGrid(t),this._drawRipples(t),this._drawFlyingSymbols(t),this._drawScanlines(t),this._drawEdgeGlow(t)}_drawGrid(t){t.save(),t.fillStyle="#041704",t.globalAlpha=.45+.2*this.loudness,t.fillRect(0,0,this.width,this.height),t.restore();for(let i=0;i<this.rows;i++)for(let s=0;s<this.columns;s++){const h=this.matrix[i][s],l=s*this.cellWidth,e=i*this.cellHeight,o=.25+.6*h.brightness+.3*this.glitchIntensity,a=120+12*Math.sin(.8*this.glitchTime+.4*s);t.fillStyle=`hsl(${a} 72% ${45*o+15}%)`;const r=h.flying?.1*Math.max(0,1-.6*this.glitchIntensity):h.returnProgress;t.globalAlpha=(.55+.35*o)*r,t.fillRect(l+h.offset*this.cellWidth*.3,e+h.offset*this.cellHeight*.3,this.cellWidth,this.cellHeight),t.globalAlpha=h.flying?0:h.returnProgress;const n=this.cellHeight*(this.isMobile?.95:.85),c=Math.max(this.isMobile?16:12,n);t.font=`${c}px monospace`,t.fillStyle=`rgba(180, 255, 180, ${.58+.3*h.brightness})`;const g=l+.5*(this.cellWidth-.6*c),d=e+.5*(this.cellHeight-c);t.fillText(h.value,g,d),h.glitch>.01&&(t.globalAlpha=.45*h.glitch,t.fillStyle="rgba(189,255,189,0.4)",t.fillRect(l-.4*this.cellWidth,e+.2*this.cellHeight,1.8*this.cellWidth,.15*this.cellHeight),t.globalAlpha=1)}}_drawRipples(t){if(this.ripples.length){t.save(),t.globalCompositeOperation="lighter";for(const i of this.ripples){const s=this.clamp(.7*i.strength,0,.65),h=Math.max(1,18*i.strength),l=i.radius,e=9;for(let i=0;i<e;i++){const o=i/e*Math.PI*2,a=this.gridHue+20;t.strokeStyle=`hsla(${a} 85% 65%, ${s/(i+1)})`,t.lineWidth=h/(i+1.5),t.beginPath(),t.arc(.5*this.width,.5*this.height,l+i*this.cellHeight*.9,o+.1*Math.PI,o+.8*Math.PI,!1),t.stroke()}}t.restore()}}_drawScanlines(t){t.save(),t.globalAlpha=.08+.1*this.loudness,t.fillStyle="rgba(0, 0, 0, 0.35)";const i=Math.max(2,.6*this.cellHeight);for(let s=0;s<this.height;s+=2*i)t.fillRect(0,s,this.width,i);t.restore()}_drawEdgeGlow(t){t.save();const i=t.createLinearGradient(0,0,0,this.height);i.addColorStop(0,`hsla(${this.gridHue}, 60%, 35%, 0.14)`),i.addColorStop(.5,"rgba(30,90,30,0)"),i.addColorStop(1,`hsla(${this.gridHue}, 60%, 35%, 0.14)`),t.globalAlpha=.6,t.fillStyle=i,t.fillRect(0,0,this.width,this.height),t.restore()}_launchSymbol(t){if(this.launchCooldown>0||!this.matrix.length)return;const i=[];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.matrix[t][s].flying||i.push({r:t,c:s});if(!i.length)return;const s=i[Math.floor(Math.random()*i.length)],h=this.matrix[s.r][s.c];h.flying=!0,h.returnProgress=0;const l={x:s.c*this.cellWidth+.5*this.cellWidth,y:s.r*this.cellHeight+.5*this.cellHeight},e={x:.5*this.width+(Math.random()-.5)*this.width*.2,y:.4*this.height+(Math.random()-.5)*this.height*.2};this.flyingSymbols.push({cell:h,origin:l,target:e,symbol:h.value,progress:0,duration:1.4+.6*Math.random()}),this.launchCooldown=.01}_updateFlyingSymbols(t){if(this.flyingSymbols.length)for(let i=this.flyingSymbols.length-1;i>=0;i--){const s=this.flyingSymbols[i];s.progress+=t/s.duration,s.progress>=1&&(s.cell.flying=!1,s.cell.value=this._randomSymbol(),this.flyingSymbols.splice(i,1))}}_drawFlyingSymbols(t){if(this.flyingSymbols.length){t.save(),t.globalCompositeOperation="lighter";for(const i of this.flyingSymbols){const s=this.clamp(i.progress,0,1),h=s*s*(3-2*s),l=this._lerp(i.origin.x,i.target.x,h),e=this._lerp(i.origin.y,i.target.y-.08*this.height*(1-h),h),o=1+2.6*h,a=this.clamp(1-1.8*Math.abs(.5-h)+.3,0,.75),r=120+16*Math.sin(this.glitchTime+.01*l);t.save(),t.translate(l,e),t.scale(o,o),t.rotate(.15*Math.sin(1.5*this.glitchTime+3*h)),t.fillStyle=`rgba(160,255,160,${a})`,t.strokeStyle=`rgba(80,220,80,${.6*a})`,t.lineWidth=2,t.beginPath();const n=.6*this.cellWidth,c=.8*this.cellHeight;t.rect(.5*-n,.5*-c,n,c),t.fill(),t.stroke();const g=Math.max(this.isMobile?26:14,.9*this.cellHeight*(1+.8*h));t.fillStyle=`hsl(${r} 80% 70%)`,t.font=`${g}px monospace`,t.textAlign="center",t.textBaseline="middle",t.fillText(i.symbol,0,0),t.restore()}t.restore()}}_lerp(t,i,s){return t+(i-t)*s}}"undefined"!=typeof window&&(window.GlitchMatrixVisualizer=GlitchMatrixVisualizer);