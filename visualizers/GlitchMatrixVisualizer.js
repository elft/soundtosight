class GlitchMatrixVisualizer extends BaseVisualizer{static meta={description:"Cyberpunk rain of characters with glitch ripples and digital sparks.",tags:["edm","cyberpunk","glitch","synthwave"]};constructor(t,s={}){super(t,{backgroundColor:"#040e04",force2d:!0,...s})}async init(){this.isMobile="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches,this.ctx.font="12px monospace",this.ctx.textBaseline="top",this.columns=this.isMobile?24:42,this.rows=this.isMobile?18:28,this.cellWidth=this.width/this.columns,this.cellHeight=this.height/this.rows,this.loudness=0,this.prevLoudness=0,this.flux=0,this.beatPulse=0,this.lastRippleTime=0,this.ripples=[],this.glitchTime=0,this.glitchIntensity=0,this.flyingSymbols=[],this.launchCooldown=0,this.gridHue=120,this.sectionHue=120,this.sectionSeed=1e3*Math.random()|0,this.sectionTime=0,this.symbolSets=["0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ@#$%&","01[]{}<>/\\|=+-*~^%!?","0123456789abcdefghijklmnopqrstuvwxyz+-=_~","01##==++--::;;**%%$$@@!!??"],this.symbolSetIndex=0,this.codeSymbols=this.symbolSets[this.symbolSetIndex],this.columnEnergy=new Float32Array(this.columns),this.rowEnergy=new Float32Array(this.rows),this.rowGlitch=new Float32Array(this.rows),this.columnImpulse=new Float32Array(this.columns),this.stereoSpread=0,this.stereoLean=0,this.midSide=.5,this.tempoEstimate=120,this.tempoConfidence=0,this.beatPhase=0,this._lastBeatPhase=0,this.scheduledLaunches=0,this._lastLaunchSlot=-1,this.percussiveEnergy=0,this.harmonicEnergy=0,this.percussiveRatio=0,this.hatSpark=0,this.dropFlash=0,this.aberration=0,this.entropy=0,this.rolloff=.5,this.slope=0,this._lastKickTime=0,this._lastSnareTime=0,this._lastHatTime=0,this.matrix=[],this._buildMatrix()}onResize(){this.columns=this.isMobile?24:42,this.rows=this.isMobile?18:28,this.cellWidth=this.width/this.columns,this.cellHeight=this.height/this.rows,this.columnEnergy=new Float32Array(this.columns),this.rowEnergy=new Float32Array(this.rows),this.rowGlitch=new Float32Array(this.rows),this.columnImpulse=new Float32Array(this.columns),this._buildMatrix()}_buildMatrix(){this.matrix=[];for(let t=0;t<this.rows;t++){const t=[];for(let s=0;s<this.columns;s++)t.push({value:this._randomSymbol(),brightness:Math.random(),glitch:0,offset:.3*(Math.random()-.5),flying:!1,returnProgress:1,spark:0});this.matrix.push(t)}}_randomSymbol(){const t=Math.floor(Math.random()*this.codeSymbols.length);return this.codeSymbols.charAt(t)}dbTo01(t){return Math.min(Math.max((t+60)/60,0),1)}attackRelease(t,s,i,h=.05,e=.24){return t+(s-t)*(1-Math.exp(-i/(s>t?h:e)))}clamp(t,s,i){return Math.min(Math.max(t,s),i)}_safe(t,s=0){return Number.isFinite(t)?t:s}onUpdate(t){const s=Number.isFinite(t?.time)?t.time:.001*performance.now(),i=Math.min(.12,Math.max(1/240,s-(this._lastTime||s)));this._lastTime=s,this.sectionTime+=i;const h=Number.isFinite(t?.loudnessShortDb)?t.loudnessShortDb:t?.aWeighted?.mono?.db??-60,e=this.dbTo01(h),a=this._safe(t?.spectralFlux,0),l=t?.isBeat?1:0;this.prevLoudness=this.loudness,this.loudness=this.attackRelease(this.loudness,e,i,.04,.45),this.flux=this.attackRelease(this.flux,a,i,.1,.4),this.beatPulse=this.attackRelease(this.beatPulse,l,i,.04,.35);const o=this._safe(t?.tempo,this.tempoEstimate),r=this.clamp(this._safe(t?.tempoConfidence,0),0,1);this.tempoEstimate=this.attackRelease(this.tempoEstimate,o,i,.18,.9),this.tempoConfidence=this.attackRelease(this.tempoConfidence,r,i,.12,.4);const n=Number.isFinite(t?.beatPhase)?t.beatPhase:(this.beatPhase+i*this.tempoEstimate/60)%1;this.beatPhase=this.clamp(n,0,1),this.beatPhase<this._lastBeatPhase&&(this._lastLaunchSlot=-1),this._lastBeatPhase=this.beatPhase;const c=this.clamp(this._safe(t?.percussiveEnergy,a),0,1),m=this.clamp(this._safe(t?.harmonicEnergy,1-c),0,1),p=this.clamp(this._safe(t?.percussiveRatio,c),0,1);this.percussiveEnergy=this.attackRelease(this.percussiveEnergy,c,i,.05,.35),this.harmonicEnergy=this.attackRelease(this.harmonicEnergy,m,i,.08,.5),this.percussiveRatio=this.attackRelease(this.percussiveRatio,p,i,.08,.4);const d=this.clamp(this._safe(t?.spectralEntropy,this.entropy),0,1);this.entropy=this.attackRelease(this.entropy,d,i,.18,.6);const u=this._safe(t?.spectralRolloff85??t?.spectralRolloff95,2e4*this.rolloff);this.rolloff=this.attackRelease(this.rolloff,this.clamp(u/2e4,0,1),i,.22,.7);const g=this._safe(t?.spectralSlope,this.slope);this.slope=this.attackRelease(this.slope,g,i,.2,.6);const f=this._safe(t?.stereoBalance,0),y=this._safe(t?.midSideRatio,.5),M=this._safe(t?.interchannelCorrelation,0);this.stereoLean=this.attackRelease(this.stereoLean,f*this.width*.05,i,.16,.45),this.midSide=this.attackRelease(this.midSide,y,i,.12,.5);const b=.32*(this.midSide-.5);this.stereoSpread=this.attackRelease(this.stereoSpread,b,i,.16,.6);const w=t?.fluxByBand||[],S=this.clamp(.5*((w[0]??0)+(w[1]??0)),0,1),x=this.clamp(.5*((w[4]??0)+(w[5]??0)),0,1),_=this.clamp(.5*((w[6]??0)+(w[7]??0)),0,1),k=this.clamp(.5*((w[2]??0)+(w[3]??0)),0,1);if(this.hatSpark=this.attackRelease(this.hatSpark,_,i,.12,.6),S>.55&&s-this._lastKickTime>.1&&(this._lastKickTime=s,this._pulseColumns(S),this.scheduledLaunches=Math.min(6,this.scheduledLaunches+1)),x>.5&&s-this._lastSnareTime>.14&&(this._lastSnareTime=s,this._rowTear(x)),_>.45&&s-this._lastHatTime>.06&&(this._lastHatTime=s,this._sparkColumns(_)),k>.5&&(this.glitchIntensity=Math.min(1,this.glitchIntensity+.08*k)),Math.abs(this.loudness-this.prevLoudness)>.015&&s-this.lastRippleTime>.1){this.lastRippleTime=s;const i=this._safe(t?.spectralSpreadHz,0)/5e3;this._spawnRipple(s,this.clamp(this.loudness+.6*i,0,1))}const R=this.audioTriggers||{};R.dropStart&&this._onDropStart(R.dropScore??1),R.dropBloom&&(this.dropFlash=Math.max(this.dropFlash,.25+.4*(R.dropScore??0)),this.aberration=Math.max(this.aberration,.2+.3*(R.dropScore??0))),R.melodyChange&&(R.melodyChangeScore??0)>.6&&this._advanceSection(R.melodyChangeScore??1);const E=this.percussiveRatio>.6?16:24,v=60/Math.max(40,this.tempoEstimate)*E;this.sectionTime>v&&this._advanceSection(.6);const I=8e-5*this.slope*180,H=100+140*this.rolloff+I;if(this.sectionHue=(H+.5*this.sectionSeed)%360,this.gridHue=this.sectionHue,M>.85?this.glitchIntensity*=.96:M<.2&&(this.glitchIntensity=Math.min(1,this.glitchIntensity+.15*(.2-M))),l){const t=.25+.45*this.percussiveEnergy;this.glitchIntensity=Math.min(1,this.glitchIntensity+t),this.scheduledLaunches=Math.min(6,this.scheduledLaunches+1+(S>.4?1:0))}this.glitchIntensity=Math.max(0,this.glitchIntensity-i*(.24+.2*this.harmonicEnergy)),this.glitchTime+=i*(1+4*this.glitchIntensity+1.2*this.percussiveEnergy);const L=t?.smoothedSpectrum;if(L&&L.length){const t=L.length,s=t/this.columns;for(let t=0;t<this.columns;t++){const h=Math.floor(t*s),e=Math.floor((t+1)*s);let a=0,l=0;for(let t=h;t<e;t++)a+=L[t]??0,l++;const o=l?a/l:0;this.columnEnergy[t]=this.attackRelease(this.columnEnergy[t],o,i,.12,.45)}const h=t/this.rows;for(let t=0;t<this.rows;t++){const s=Math.floor(t*h),e=Math.floor((t+1)*h);let a=0,l=0;for(let t=s;t<e;t++)a+=L[t]??0,l++;const o=l?a/l:0;this.rowEnergy[t]=this.attackRelease(this.rowEnergy[t],o,i,.16,.6)}}else{const t=Math.pow(.9,60*i);for(let s=0;s<this.columns;s++)this.columnEnergy[s]*=t;const s=Math.pow(.88,60*i);for(let t=0;t<this.rows;t++)this.rowEnergy[t]*=s}for(let t=0;t<this.rows;t++)this.rowGlitch[t]=Math.max(0,this.rowGlitch[t]-1.6*i);for(let t=0;t<this.columns;t++)this.columnImpulse[t]=Math.max(0,this.columnImpulse[t]-1.9*i);this.hatSpark=Math.max(0,this.hatSpark-1.5*i),this.dropFlash=Math.max(0,this.dropFlash-.8*i),this.aberration=Math.max(0,this.aberration-.7*i),this.launchCooldown=Math.max(0,this.launchCooldown-i),this._processLaunchQueue(s),this._updateMatrix(i),this._updateRipples(i),this._updateFlyingSymbols(i)}_spawnRipple(t,s){this.ripples.push({start:t,radius:0,strength:s,speed:90+220*s}),this.ripples.length>6&&this.ripples.shift()}_updateMatrix(t){const s=this.glitchIntensity,i=.35+.9*this.entropy,h=1+.5*this.harmonicEnergy,e=.4+.5*this.hatSpark;for(let a=0;a<this.rows;a++){const l=this.rowEnergy[a]??0,o=this.rowGlitch[a]??0;for(let r=0;r<this.columns;r++){const n=this.matrix[a][r],c=this.columnEnergy[r]??0,m=this.columnImpulse[r]??0,p=.08*(Math.random()-.5)*(1+3*s+2*m),d=n.spark??0;n.spark=Math.max(0,d-3.6*t);const u=p+.05*this.flux+.24*c+.18*l+.45*m+.3*o+d*e;n.brightness=this.clamp(n.brightness+u,0,1);const g=(.015+.12*s+.25*m+.1*o)*i;Math.random()<g&&(n.value=this._randomSymbol());const f=.05+.2*s+.3*m+.25*o;if(Math.random()<f)n.glitch=this.clamp(n.glitch+.35+.4*m,0,1);else{const s=2.2+2*this.harmonicEnergy;n.glitch=Math.max(0,n.glitch-t*s)}const y=this.stereoSpread*(r/Math.max(1,this.columns-1)-.5)*1.8,M=.12+.28*this.loudness+.4*s+.5*m;n.offset=this.clamp(n.offset+(Math.random()-.5)*M*t+y*t,-.6,.6),n.flying?n.returnProgress=Math.max(0,n.returnProgress-1.4*t):n.returnProgress=Math.min(1,n.returnProgress+t*(1.1+.4*h)),this.hatSpark>.05&&Math.random()<.1*this.hatSpark&&(n.spark=Math.max(n.spark,this.hatSpark))}}}_updateRipples(t){for(const s of this.ripples)s.radius+=s.speed*t,s.strength*=Math.pow(.9,12*t);this.ripples=this.ripples.filter(t=>t.strength>.05)}onRender(){const t=this.ctx;t.fillStyle="#050b05",t.fillRect(0,0,this.width,this.height),t.save(),t.translate(this.stereoLean,0),this._drawGrid(t),t.restore(),this._drawRipples(t),this._drawFlyingSymbols(t),this._drawScanlines(t),this._drawEdgeGlow(t)}_drawGrid(t){t.save(),t.fillStyle="#041704",t.globalAlpha=.35+.25*this.loudness+.2*this.harmonicEnergy,t.fillRect(0,0,this.width,this.height),t.restore();for(let s=0;s<this.rows;s++){const i=this.rowEnergy[s]??0,h=this.rowGlitch[s]??0;for(let e=0;e<this.columns;e++){const a=this.matrix[s][e],l=e*this.cellWidth+this.stereoSpread*(e/Math.max(1,this.columns-1)-.5)*this.width,o=s*this.cellHeight,r=this.columnEnergy[e]??0,n=this.columnImpulse[e]??0,c=.22+.65*a.brightness+.25*this.glitchIntensity+.4*n,m=10*Math.sin(.8*this.glitchTime+.35*e),p=(this.gridHue+m+40*i)%360;t.fillStyle=`hsl(${p} 72% ${this.clamp(50*c+12+18*h,10,95)}%)`;const d=a.spark??0,u=a.flying?.1*Math.max(0,1-.7*this.glitchIntensity):a.returnProgress,g=this.clamp((.5+.4*c+.35*n+.3*h+.4*d)*u,0,1);t.globalAlpha=g,t.fillRect(l+a.offset*this.cellWidth*.3,o+a.offset*this.cellHeight*.3,this.cellWidth,this.cellHeight),t.globalAlpha=a.flying?0:this.clamp(u+.25*d,0,1);const f=this.cellHeight*(this.isMobile?.95:.85),y=Math.max(this.isMobile?16:12,f*(1+.1*r));t.font=`${y}px monospace`;const M=this.clamp(.58+.35*a.brightness+.4*d,0,1),b=(p+180)%360,w=this.clamp(80-35*M,20,85);t.fillStyle=`hsla(${b} 85% ${w}%, ${.55+.3*r})`;const S=l+.5*(this.cellWidth-.6*y),x=o+.5*(this.cellHeight-y);t.fillText(a.value,S,x),a.glitch>.01&&(t.globalAlpha=this.clamp(.5*a.glitch+.3*n,0,1),t.fillStyle="rgba(189,255,189,0.35)",t.fillRect(l-.4*this.cellWidth,o+.2*this.cellHeight,this.cellWidth*(1.6+.8*n),this.cellHeight*(.15+.3*h)),t.globalAlpha=1)}}}_drawRipples(t){if(this.ripples.length){t.save(),t.globalCompositeOperation="lighter";for(const s of this.ripples){const i=this.clamp(.7*s.strength,0,.65),h=Math.max(1,18*s.strength),e=s.radius,a=9;for(let s=0;s<a;s++){const l=s/a*Math.PI*2,o=(this.gridHue+20+40*this.percussiveRatio)%360;t.strokeStyle=`hsla(${o} 85% 65%, ${i/(s+1)})`,t.lineWidth=h/(s+1.5),t.beginPath(),t.arc(.5*this.width+this.stereoLean,.5*this.height,e+s*this.cellHeight*.9,l+.1*Math.PI,l+.8*Math.PI,!1),t.stroke()}}t.restore()}}_drawScanlines(t){t.save(),t.globalAlpha=.06+.08*this.loudness+.04*this.percussiveEnergy,t.fillStyle="rgba(0, 0, 0, 0.35)";const s=Math.max(2,.6*this.cellHeight);for(let i=0;i<this.height;i+=2*s)t.fillRect(0,i,this.width,s);t.restore()}_drawEdgeGlow(t){t.save();const s=t.createLinearGradient(0,0,0,this.height);if(s.addColorStop(0,`hsla(${this.gridHue}, 60%, 35%, ${.12+.12*this.harmonicEnergy})`),s.addColorStop(.5,"rgba(30,90,30,0)"),s.addColorStop(1,`hsla(${(this.gridHue+30)%360}, 60%, 35%, ${.12+.12*this.harmonicEnergy})`),t.globalAlpha=.45+.3*this.dropFlash,t.fillStyle=s,t.fillRect(0,0,this.width,this.height),t.restore(),this.dropFlash>.02&&(t.save(),t.globalAlpha=.25*this.dropFlash,t.fillStyle=`hsla(${(this.gridHue+200)%360}, 80%, 70%, 1)`,t.fillRect(0,0,this.width,this.height),t.restore()),this.aberration>.02){t.save();const s=6*this.aberration;t.globalAlpha=.22*this.aberration,t.fillStyle="rgba(180,30,255,0.5)",t.fillRect(s,0,this.width,this.height),t.fillStyle="rgba(50,200,255,0.5)",t.fillRect(-s,0,this.width,this.height),t.restore()}}_processLaunchQueue(t){if(this.scheduledLaunches<=0)return;const s=this.tempoConfidence;if(s>.6){const i=this.percussiveRatio>.6?4:2,h=Math.floor(this.beatPhase*i);h!==this._lastLaunchSlot&&(this._launchSymbol(t,s)&&(this.scheduledLaunches=Math.max(0,this.scheduledLaunches-1)),this._lastLaunchSlot=h)}else this.launchCooldown<=0&&this._launchSymbol(t,s)&&(this.scheduledLaunches=Math.max(0,this.scheduledLaunches-1))}_pulseColumns(t=.5){const s=Math.floor(Math.random()*this.columns),i=Math.max(1,Math.round(1+3*t));for(let h=-i;h<=i;h++){const e=s+h;if(e<0||e>=this.columns)continue;const a=1-Math.abs(h)/(i+1);this.columnImpulse[e]=Math.min(1,this.columnImpulse[e]+t*a)}}_rowTear(t=.5){const s=Math.floor(Math.random()*this.rows);this.rowGlitch[s]=Math.min(1,this.rowGlitch[s]+.9*t),s>0&&(this.rowGlitch[s-1]=Math.min(1,this.rowGlitch[s-1]+.4*t)),s<this.rows-1&&(this.rowGlitch[s+1]=Math.min(1,this.rowGlitch[s+1]+.4*t))}_sparkColumns(t=.4){if(!this.matrix.length)return;const s=Math.floor(Math.random()*this.columns);this.columnImpulse[s]=Math.min(1,this.columnImpulse[s]+.8*t);for(let i=0;i<this.rows;i++){const h=this.matrix[i][s];h&&(h.spark=Math.max(h.spark??0,t))}}_onDropStart(t){const s=this.clamp(t,0,1);this.dropFlash=Math.max(this.dropFlash,.6+.5*s),this.aberration=Math.max(this.aberration,.45+.4*s),this.glitchIntensity=Math.min(1,this.glitchIntensity+.5+.4*s),this.scheduledLaunches=Math.min(6,this.scheduledLaunches+3),this._blastGrid(s)}_advanceSection(t=1){this.sectionSeed=this.sectionSeed+1|0,this.sectionTime=0,this.symbolSetIndex=(this.symbolSetIndex+1)%this.symbolSets.length,this.codeSymbols=this.symbolSets[this.symbolSetIndex];const s=(180*this.rolloff+80*t+40*Math.random())%360;this.gridHue=(s+.5*this.sectionSeed)%360,this.scheduledLaunches=Math.min(6,this.scheduledLaunches+2);for(let s=0;s<this.rows;s++)for(let i=0;i<this.columns;i++){const h=this.matrix[s][i];Math.random()<.4&&(h.value=this._randomSymbol()),h.glitch=Math.min(1,h.glitch+.3*t),h.spark=Math.max(h.spark??0,.6*t)}}_blastGrid(t=1){for(let s=0;s<this.columns;s++)this.columnImpulse[s]=Math.min(1,this.columnImpulse[s]+t*(.4+.4*Math.random()));for(let s=0;s<this.rows;s++)this.rowGlitch[s]=Math.min(1,this.rowGlitch[s]+t*(.3+.4*Math.random()))}_launchSymbol(t,s=0){if(this.launchCooldown>0||!this.matrix.length)return!1;const i=[];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.matrix[t][s].flying||i.push({r:t,c:s});if(!i.length)return!1;const h=i[Math.floor(Math.random()*i.length)],e=this.matrix[h.r][h.c];e.flying=!0,e.returnProgress=0;const a={x:h.c*this.cellWidth+.5*this.cellWidth,y:h.r*this.cellHeight+.5*this.cellHeight},l={x:.5*this.width+(Math.random()-.5)*this.width*(.15+.1*this.midSide),y:this.height*(.35+.2*this.harmonicEnergy)+(Math.random()-.5)*this.height*.18},o=this.clamp(1+.6*Math.random()+.5*(1-s)-.3*this.percussiveEnergy,.6,2.2);return this.flyingSymbols.push({cell:e,origin:a,target:l,symbol:e.value,progress:0,duration:o}),this.launchCooldown=Math.max(.02,.12-.05*s),!0}_updateFlyingSymbols(t){if(this.flyingSymbols.length)for(let s=this.flyingSymbols.length-1;s>=0;s--){const i=this.flyingSymbols[s];i.progress+=t/i.duration,i.progress>=1&&(i.cell.flying=!1,i.cell.value=this._randomSymbol(),this.flyingSymbols.splice(s,1))}}_drawFlyingSymbols(t){if(this.flyingSymbols.length){t.save(),t.globalCompositeOperation="lighter",t.translate(this.stereoLean,0);for(const s of this.flyingSymbols){const i=this.clamp(s.progress,0,1),h=i*i*(3-2*i),e=this.tempoConfidence>.6?Math.sin(this.beatPhase*Math.PI*2+4*h):0,a=this._lerp(s.origin.x,s.target.x,h)+e*this.width*.02,l=this._lerp(s.origin.y,s.target.y-.08*this.height*(1-h),h),o=1+h*(2.2+.8*this.percussiveEnergy),r=this.clamp(1-1.6*Math.abs(.5-h)+.28+.2*this.dropFlash,0,.85),n=(this.gridHue+18*Math.sin(this.glitchTime+.01*a)+40*this.percussiveRatio)%360;t.save(),t.translate(a,l),t.scale(o,o),t.rotate(Math.sin(1.4*this.glitchTime+4*h)*(.12+.05*this.percussiveRatio)),t.fillStyle=`hsla(${n}, 80%, 65%, ${r})`,t.strokeStyle=`hsla(${(n+40)%360}, 80%, 55%, ${.6*r})`,t.lineWidth=1.8+.8*this.percussiveEnergy,t.beginPath();const c=.6*this.cellWidth,m=.8*this.cellHeight;t.rect(.5*-c,.5*-m,c,m),t.fill(),t.stroke();const p=Math.max(this.isMobile?26:14,.9*this.cellHeight*(1+.8*h+.3*this.percussiveEnergy)),d=(n+180)%360;t.fillStyle=`hsl(${d} 85% 72%)`,t.font=`${p}px monospace`,t.textAlign="center",t.textBaseline="middle",t.fillText(s.symbol,0,0),t.restore()}t.restore()}}_lerp(t,s,i){return t+(s-t)*i}}"undefined"!=typeof window&&(window.GlitchMatrixVisualizer=GlitchMatrixVisualizer);