class SoundWeaverVisualizer extends BaseVisualizer{static meta={description:"Luminous lattice of threads weaving pulses and ripples in endless motion.",tags:["ambient","cinematic","chill","post-rock"]};async init(){this.centerX=this.width/2,this.centerY=this.height/2,this.ringCount=6,this.baseNodesPerRing=10,this.nodeCountTarget=200,this.nodes=[],this.edges=[],this.motes=[],this.ripples=[],this.colorPulses=[],this.maxMotes=180,this.maxRipples=5,this.maxColorPulses=3,this.trailAlpha=.12,this._smoothed={subBass:0,bass:0,lowMid:0,mid:0,presence:0,brilliance:0,flux:0},this._smoothK=.08,this.stereoSkew=0,this._frameTime=0,this._frameCount=0,this._buildLattice(),this._lastAudioTime=performance.now(),this.baseHue=200}onResize(){this.centerX=this.width/2,this.centerY=this.height/2,this._repositionNodes()}_buildLattice(){this.nodes.length=0,this.edges.length=0,this._edgeSet=new Set;const t=.44*Math.min(this.width,this.height);for(let s=0;s<this.ringCount;s++){const e=Math.min(Math.round(this.baseNodesPerRing*(1+.7*s)),Math.ceil(this.nodeCountTarget/this.ringCount)),i=s/Math.max(1,this.ringCount-1)*t*(.28+.14*s);for(let t=0;t<e;t++){const h={ring:s,ringIndex:t,angle:t/e*Math.PI*2,baseRadius:i,radius:i,x:0,y:0,vx:0,vy:0,phase:Math.random()*Math.PI*2,hueOffset:40*Math.random()-20,brightness:.6,edgeStrength:0,id:this.nodes.length};this.nodes.push(h)}}for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t],e=this.nodes.filter(t=>t.ring===s.ring),i=e.findIndex(t=>t===s);if(e.length>1){const t=e[(i+1)%e.length],h=e[(i-1+e.length)%e.length];this._addEdgeIfUnique(s.id,t.id),this._addEdgeIfUnique(s.id,h.id)}const h=this.nodes.filter(t=>1===Math.abs(t.ring-s.ring));if(h.length){h.sort((t,e)=>Math.abs(t.angle-s.angle)-Math.abs(e.angle-s.angle));const t=Math.min(2,h.length);for(let e=0;e<t;e++)this._addEdgeIfUnique(s.id,h[e].id)}}this._repositionNodes()}_repositionNodes(){const t=this.stereoSkew*(.08*this.width);for(const s of this.nodes){const e=Math.max(1e-4,s.baseRadius),i=Math.cos(s.angle)*e+this.centerX+t,h=Math.sin(s.angle)*e+this.centerY;s.x=i,s.y=h,s.radius=e}}_addEdgeIfUnique(t,s){if(t===s)return;const e=t<s?`${t}-${s}`:`${s}-${t}`;this._edgeSet.has(e)||(this._edgeSet.add(e),this.edges.push({a:t,b:s}))}onUpdate(t){if(!t)return;const s=t.time??performance.now()/1e3,e=Math.max(1e-4,s-(this._lastAudioTime||s));this._lastAudioTime=s,this._frameTime+=e,this._frameCount++;const{subBassEnergy:i,bassEnergy:h,lowMidEnergy:o,midEnergy:a,presenceEnergy:n,brillianceEnergy:l,spectralFlux:r,isBeat:d,isMassiveEnergyChange:p,rmsLeft:g,rmsRight:m,centroid:u}=t;this._smoothed.subBass=this.smooth(this._smoothed.subBass,i,this._smoothK),this._smoothed.bass=this.smooth(this._smoothed.bass,h,this._smoothK),this._smoothed.lowMid=this.smooth(this._smoothed.lowMid,o,this._smoothK),this._smoothed.mid=this.smooth(this._smoothed.mid,a,this._smoothK),this._smoothed.presence=this.smooth(this._smoothed.presence,n,this._smoothK),this._smoothed.brilliance=this.smooth(this._smoothed.brilliance,l,this._smoothK),this._smoothed.flux=this.smooth(this._smoothed.flux,r,this._smoothK),this.stereoSkew=this.clamp(1.6*(m-g),-1,1);const c=Number.isFinite(u)?u:0;if(this.baseHue=this.map(c,0,8e3,210,30),d&&this._spawnRipple(.8+1.5*(h+a)),p){const s=this.map(c,0,12e3,0,360);this._spawnColorPulse(s,2.5*t.energyChangeIntensity)}const M=Math.floor(25*(this._smoothed.presence+this._smoothed.brilliance)+30*this._smoothed.flux);for(let t=0;t<M;t++)this.motes.length<this.maxMotes&&Math.random()<.7&&this._spawnMote();const f=1+.6*(this._smoothed.subBass+this._smoothed.bass);for(const t of this.nodes){const s=1+t.ring/Math.max(1,this.ringCount-1)*.6,e=t.baseRadius*f*s,i=.6*Math.sin(this._frameTime*(.6+.1*t.phase)+t.phase)*(.5+1.5*(this._smoothed.lowMid+this._smoothed.mid))*(1+.2*t.ring);let h=0;for(let s of this.ripples)h+=this._rippleValueAtNode(s,t)*s.strength*1.6;let o=0,a=0;for(const s of this.colorPulses){const e=this._pulseValueAtNode(s,t);e>0&&(o=s.hue,a=e*s.strength)}t.pulseHue=o,t.pulseBrightness=a;const n=e+8*i+18*h,l=this.stereoSkew*(.08*this.width)*(t.ring/Math.max(1,this.ringCount-1)),r=Math.cos(t.angle)*n+this.centerX+l,d=Math.sin(t.angle)*n+this.centerY;t.vx+=.06*(r-t.x),t.vy+=.06*(d-t.y),t.vx*=.88,t.vy*=.88,t.x+=t.vx,t.y+=t.vy,t.brightness=this.clamp(.2+1.2*(this._smoothed.presence+this._smoothed.brilliance)+.18*Math.abs(Math.sin(t.phase+.6*this._frameTime)),0,1.3)}this._ageParticles(this.motes,t=>(t.age++,t.x+=t.vx,t.y+=t.vy,t.vx*=.98,t.vy*=.98,t.alpha*=.992,t.age>t.lifetime||t.alpha<.02)),this._ageParticles(this.ripples,t=>(t.age++,t.age>t.lifespan)),this._ageParticles(this.colorPulses,t=>(t.age++,t.age>t.lifespan));for(let t=0;t<this.edges.length;t++){const s=this.edges[t],e=this.nodes[s.a],i=this.nodes[s.b],h=.5*(e.brightness+i.brightness),o=this._rippleValueAtEdge(e,i);s.strength=this.clamp(h+2.2*o,0,1.6),s.pulseHue=e.pulseBrightness>0?e.pulseHue:i.pulseBrightness>0?i.pulseHue:0,s.pulseBrightness=Math.max(e.pulseBrightness,i.pulseBrightness)}}_spawnRipple(t=1){this.ripples.length>=this.maxRipples&&this.ripples.shift(),this.ripples.push({t0:this._frameTime,age:0,lifespan:80+Math.round(60*t),speed:.013+.01*t,strength:this.clamp(t,.1,3)})}_spawnColorPulse(t,s=1){this.colorPulses.length>=this.maxColorPulses&&this.colorPulses.shift(),this.colorPulses.push({hue:t,strength:this.clamp(s,.5,4),age:0,lifespan:90,speed:.025})}_rippleValueAtNode(t,s){const e=.6*Math.min(this.width,this.height),i=Math.sqrt(Math.pow(s.x-this.centerX,2)+Math.pow(s.y-this.centerY,2))/e,h=t.age*t.speed-i;return Math.exp(-Math.pow(8*h,2))*Math.cos(h*Math.PI*2)}_pulseValueAtNode(t,s){const e=.6*Math.min(this.width,this.height),i=Math.sqrt(Math.pow(s.x-this.centerX,2)+Math.pow(s.y-this.centerY,2))/e,h=t.age*t.speed-i;return h>0&&h<.1?Math.sin(h/.1*Math.PI):0}_rippleValueAtEdge(t,s){const e=.5*(t.x+s.x),i=.5*(t.y+s.y),h=.6*Math.min(this.width,this.height),o=Math.sqrt(Math.pow(e-this.centerX,2)+Math.pow(i-this.centerY,2));let a=0;for(const t of this.ripples){const s=o/h,e=t.age*t.speed-s;a+=Math.exp(-Math.pow(8*e,2))*t.strength}return a}_spawnMote(){const t=this.nodes.filter(t=>t.ring>=Math.floor(.5*this.ringCount)),s=t.length?t[Math.floor(Math.random()*t.length)]:this.nodes[Math.floor(Math.random()*this.nodes.length)],e=s.angle+.6*(Math.random()-.5),i=1+3*Math.random(),h=this.baseHue+(70*Math.random()-35);this.motes.push({x:s.x,y:s.y,vx:Math.cos(e)*i+(Math.random()-.5),vy:Math.sin(e)*i+(Math.random()-.5),age:0,lifetime:40+Math.floor(60*Math.random()),size:.8+3.2*Math.random(),alpha:.9+.6*Math.random(),hue:h})}_ageParticles(t,s){for(let e=t.length-1;e>=0;e--)s(t[e])&&t.splice(e,1)}onRender(){const t=this.ctx;t&&(t.save(),t.fillStyle=`rgba(0,0,0,${this.trailAlpha})`,t.globalCompositeOperation="source-over",t.fillRect(0,0,this.width,this.height),t.restore(),t.save(),t.globalCompositeOperation="lighter",this._drawEdges(t),this._drawMotes(t),this._drawNodes(t),this.config&&this.config.debug&&(t.save(),t.fillStyle="rgba(255,255,255,0.85)",t.font="12px monospace",t.fillText(`Nodes: ${this.nodes.length}  Edges: ${this.edges.length}  Motes: ${this.motes.length}  Ripples: ${this.ripples.length}  Pulses: ${this.colorPulses.length}`,12,18),t.restore()),t.restore())}_drawEdges(t){for(let s=0;s<this.edges.length;s++){const e=this.edges[s],i=this.nodes[e.a],h=this.nodes[e.b],o=this.clamp(e.strength??.3,.05,1.6),a=this.map(o,0,1.6,.4,3.4);let n=this.baseHue+.5*(i.hueOffset+h.hueOffset);const l=this.clamp(.18+.6*o,.03,1);e.pulseBrightness>0&&(this.clamp(e.pulseBrightness,0,1),n=e.pulseHue);const r=t.createLinearGradient(i.x,i.y,h.x,h.y);r.addColorStop(0,`hsla(${this.clamp(Math.round(n-12),0,360)}, 85%, 58%, ${.9*l})`),r.addColorStop(.5,`hsla(${this.clamp(Math.round(n+8),0,360)}, 82%, 66%, ${l})`),r.addColorStop(1,`hsla(${this.clamp(Math.round(n+28),0,360)}, 78%, 52%, ${.85*l})`),t.strokeStyle=r,t.lineWidth=a,t.lineCap="round",t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(h.x,h.y),t.stroke()}}_drawNodes(t){for(const s of this.nodes){let e=this.clamp(Math.round(this.baseHue+s.hueOffset),0,360);const i=this.clamp(s.brightness,.05,1.6);s.pulseBrightness>0&&(this.clamp(s.pulseBrightness,0,1),e=s.pulseHue);const h=t.createRadialGradient(s.x,s.y,0,s.x,s.y,10+18*i);h.addColorStop(0,`hsla(${e}, 95%, ${50+8*i}%, ${.42*i})`),h.addColorStop(.3,`hsla(${e}, 88%, ${44+6*i}%, ${.22*i})`),h.addColorStop(1,`hsla(${e}, 82%, ${36+4*i}%, 0)`),t.fillStyle=h,t.beginPath(),t.arc(s.x,s.y,2.4+2.6*i,0,2*Math.PI),t.fill(),t.fillStyle=`hsla(${e}, 100%, ${66+6*i}%, 0.9)`,t.beginPath(),t.arc(s.x,s.y,Math.max(.6,.8+.6*i),0,2*Math.PI),t.fill()}}_drawMotes(t){for(const s of this.motes){const e=t.createRadialGradient(s.x,s.y,0,s.x,s.y,Math.max(6,6*s.size));e.addColorStop(0,`hsla(${Math.round(s.hue)}, 100%, 88%, ${this.clamp(s.alpha,0,1)})`),e.addColorStop(.4,`hsla(${Math.round(s.hue)}, 90%, 62%, ${this.clamp(.45*s.alpha,0,1)})`),e.addColorStop(1,`hsla(${Math.round(s.hue)}, 80%, 42%, 0)`),t.fillStyle=e,t.beginPath(),t.arc(s.x,s.y,Math.max(.6,2*s.size),0,2*Math.PI),t.fill()}}destroy(){this.nodes=[],this.edges=[],this.motes=[],this.ripples=[],this.colorPulses=[],super.destroy&&super.destroy()}}"undefined"!=typeof window&&(window.SoundWeaverVisualizer=SoundWeaverVisualizer);