class ChromaticWormholeVisualizer extends BaseVisualizer{constructor(t,e){super(t,{backgroundColor:"#030d1a",force2d:!0,...e})}async init(){this.dpr>1.5&&(this.dpr=1,this.setupCanvas()),this.centerX=this.width/2,this.centerY=this.height/2,this.minTunnelRadius=.12*Math.min(this.width,this.height),this.maxTunnelRadius=.55*Math.hypot(this.width,this.height),this.sectionCount=16,this.sections=[];for(let t=0;t<this.sectionCount;t++)this.sections.push(this._createSection(t/this.sectionCount));this.starCount=70,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this._createStar());this.tunnelSegments=18,this._updateSegmentCache(),this.energy={subBass:0,bass:0,lowMid:0,mid:0,upperMid:0,presence:0,treble:0,brilliance:0,ultrasonic:0,overall:0},this.hue=210,this.targetHue=210,this.portalSides=6,this.portalSidesTarget=6,this.portalScale=1,this.portalScaleTarget=1,this.rotation=0,this.rotationSpeed=.6,this.rotationSpeedTarget=.6,this.depthVelocity=.28,this.depthVelocityTarget=.28,this.sectionWarp=.18,this.sectionWarpTarget=.18,this.starStretch=.26,this.starStretchTarget=.26,this.tunnelTwist=0,this.tunnelTwistTarget=0,this.portalMorph=.36,this.portalMorphTarget=.36,this.portalMorphPhase=Math.random()*Math.PI*2,this.coreRotation=0,this.coreRotationSpeed=.6,this.coreRotationSpeedTarget=.6,this.innerFlare=.22,this.innerFlareTarget=.22,this.rippleStrength=0,this.rippleExpansion=0,this.lastRenderTime=performance.now()}onResize(){this.centerX=this.width/2,this.centerY=this.height/2,this.minTunnelRadius=.12*Math.min(this.width,this.height),this.maxTunnelRadius=.55*Math.hypot(this.width,this.height)}_createSection(t){return{depth:t+.2*Math.random(),angleOffset:Math.random()*Math.PI*2,noiseSeed:1e3*Math.random(),speed:.8+.6*Math.random(),twistFactor:2*(Math.random()-.5),colorShift:40*Math.random()-20}}_resetSection(t){t.depth=1+.2*Math.random(),t.angleOffset=Math.random()*Math.PI*2,t.noiseSeed=1e3*Math.random(),t.speed=.8+.6*Math.random(),t.twistFactor=2*(Math.random()-.5),t.colorShift=40*Math.random()-20}_createStar(){return this._resetStar({x:0,y:0,depth:1,drift:0,speed:0,scale:0,colorShift:0})}_resetStar(t){return t.x=2*(Math.random()-.5),t.y=2*(Math.random()-.5),t.depth=.8*Math.random()+.2,t.speed=.6+.9*Math.random(),t.drift=.6*(Math.random()-.5),t.scale=.3+.9*Math.random(),t.colorShift=80*Math.random()-40,t}onUpdate(t){const e=.16;this.energy.subBass=this.lerp(this.energy.subBass,t.subBassEnergy||0,e),this.energy.bass=this.lerp(this.energy.bass,t.bassEnergy||0,e),this.energy.lowMid=this.lerp(this.energy.lowMid,t.lowMidEnergy||0,e),this.energy.mid=this.lerp(this.energy.mid,t.midEnergy||0,e),this.energy.upperMid=this.lerp(this.energy.upperMid,t.upperMidEnergy||0,e),this.energy.presence=this.lerp(this.energy.presence,t.presenceEnergy||0,e),this.energy.treble=this.lerp(this.energy.treble,t.trebleEnergy||0,e),this.energy.brilliance=this.lerp(this.energy.brilliance,t.brillianceEnergy||0,e),this.energy.ultrasonic=this.lerp(this.energy.ultrasonic,t.ultrassonicEnergy||0,e),this.energy.overall=this.lerp(this.energy.overall,t.overallEnergy||0,e);const i=Number.isFinite(t.dominantFreq)?Math.max(20,t.dominantFreq):200,s=Math.log(i),h=this.map(s,Math.log(40),Math.log(18e3),180,420);this.targetHue=(h%360+360)%360;const r=this.map(s,Math.log(50),Math.log(14e3),3.2,9.6);this.portalSidesTarget=this.constrain(r,3.2,9.6),this.portalScaleTarget=1+.38*this.energy.subBass+.25*this.energy.bass,this.depthVelocityTarget=.2+.5*this.energy.mid+.35*this.energy.bass+.25*this.energy.overall,this.rotationSpeedTarget=.4+1.6*this.energy.lowMid+1.1*this.energy.mid,this.sectionWarpTarget=.16+.42*this.energy.upperMid+.34*this.energy.presence,this.starStretchTarget=.2+.9*this.energy.treble+.5*this.energy.brilliance,this.portalMorphTarget=.22+.6*this.energy.presence+.38*this.energy.upperMid,this.coreRotationSpeedTarget=.5+1.8*this.energy.presence+.8*this.energy.treble,this.innerFlareTarget=.16+.6*this.energy.brilliance+.45*this.energy.ultrasonic+.3*this.energy.treble;const a=Number.isFinite(t.stereoBalance)?t.stereoBalance:0;if(this.tunnelTwistTarget=a*(.2+.5*this.energy.presence)+.2*(this.energy.upperMid-.5),t.bassDrop){const e=t.bassDropIntensity||this.energy.bass+this.energy.subBass;this.rippleStrength=Math.min(1,this.rippleStrength+.3+.9*e),this.rippleExpansion=0}this.hue=this.lerp(this.hue,this.targetHue,.08),this.portalSides=this.lerp(this.portalSides,this.portalSidesTarget,.12),this.portalScale=this.lerp(this.portalScale,this.portalScaleTarget,.18),this.depthVelocity=this.lerp(this.depthVelocity,this.depthVelocityTarget,.12),this.rotationSpeed=this.lerp(this.rotationSpeed,this.rotationSpeedTarget,.12),this.sectionWarp=this.lerp(this.sectionWarp,this.sectionWarpTarget,.12),this.starStretch=this.lerp(this.starStretch,this.starStretchTarget,.14),this.tunnelTwist=this.lerp(this.tunnelTwist,this.tunnelTwistTarget,.1),this.portalMorph=this.lerp(this.portalMorph,this.portalMorphTarget,.14),this.coreRotationSpeed=this.lerp(this.coreRotationSpeed,this.coreRotationSpeedTarget,.12),this.innerFlare=this.lerp(this.innerFlare,this.innerFlareTarget,.15),this.portalMorphPhase+=.06*(this.energy.presence+this.energy.upperMid)+.01}onRender(){const t=this.ctx,e=performance.now(),i=Math.min(.07,(e-this.lastRenderTime)/1e3);this.lastRenderTime=e,this.rotation+=this.rotationSpeed*i,this.coreRotation+=this.coreRotationSpeed*i,this.rippleStrength>0&&(this.rippleStrength=Math.max(0,this.rippleStrength-.7*i),this.rippleExpansion+=1.4*i),t.fillStyle="rgba(3, 13, 26, 0.1)",t.fillRect(0,0,this.width,this.height),this._drawBackground(t),this._updateSections(i),this._updateStars(i),this._drawStars(t),this._drawTunnel(t),this._drawCore(t)}_drawBackground(t){const e=t.createRadialGradient(this.centerX,this.centerY,Math.max(1,.4*this.minTunnelRadius),this.centerX,this.centerY,Math.max(this.width,this.height)),i=this.hue,s=this.energy.brilliance;e.addColorStop(0,`hsla(${(i+10)%360}, 52%, ${16+18*s}%, 0.2)`),e.addColorStop(.45,`hsla(${(i+50)%360}, 58%, ${12+14*s}%, 0.1)`),e.addColorStop(1,"rgba(3, 13, 26, 0)"),t.save(),t.globalCompositeOperation="screen",t.fillStyle=e,t.fillRect(0,0,this.width,this.height),t.restore()}_updateSections(t){const e=this.depthVelocity*(1.5+this.energy.overall)*t;for(const i of this.sections)i.depth-=e*i.speed,i.depth<=.02?this._resetSection(i):i.angleOffset+=this.rotationSpeed*i.twistFactor*.05*t}_updateStars(t){const e=1.9*this.depthVelocity+.5*this.energy.overall;for(const i of this.stars)i.depth-=t*e*i.speed,i.depth<=.05?(this._resetStar(i),i.depth+=.7):(i.x+=i.drift*t*.4,i.y+=i.drift*t*.25,(Math.abs(i.x)>1.4||Math.abs(i.y)>1.4)&&this._resetStar(i))}_drawStars(t){t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.85;const e=this.hue,i=this.starStretch,s=.25+.55*this.energy.brilliance;for(const h of this.stars){const r=Math.max(.05,h.depth);if(r>1.05)continue;const a=1/(1.2*r),n=this.centerX+h.x*this.width*.32*a,o=this.centerY+h.y*this.height*.32*a,l=Math.max(.35,h.scale*a*(.55+1.1*this.energy.treble)),p=l*(1.1+i*a),c=Math.atan2(o-this.centerY,n-this.centerX);t.save(),t.translate(n,o),t.rotate(c),t.fillStyle=`hsla(${(e+18+h.colorShift)%360}, 68%, ${48+22*s}%, ${.25+.35*a})`,t.fillRect(.5*-l,.5*-p,l,p);const d=.45*l;t.beginPath(),t.arc(0,0,d,0,2*Math.PI),t.fillStyle=`hsla(${(e+h.colorShift/2)%360}, 80%, ${62+18*s}%, ${.35+.4*a})`,t.fill(),t.restore()}t.restore()}_drawTunnel(t){this.sections.sort((t,e)=>e.depth-t.depth);const e=this.hue,i=Math.max(3,this.portalSides),s=this.sectionWarp,h=this.tunnelTwist,r=this.portalScale,a=this.rippleStrength;t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.65;for(const n of this.sections){const o=Math.min(1.2,n.depth);if(o>1.05)continue;const l=1-Math.pow(o,.9),p=this.minTunnelRadius+l*this.maxTunnelRadius*r,c=a>0?Math.sin((1-o)*Math.PI*4-this.rippleExpansion*Math.PI*2+.02*n.noiseSeed)*a*this.minTunnelRadius*.6:0,d=Math.max(4,p+c),g=this.tunnelSegments,M=this.segmentCache;t.beginPath();for(let e=0;e<=g;e++){const r=M[e],a=r.t,o=n.angleOffset+this.rotation+r.angle,l=1+Math.sin(a*i*Math.PI*2+this.portalMorphPhase+.1*n.noiseSeed)*s+Math.sin(2*o+n.noiseSeed)*s*.5,p=Math.sin(.5*o+n.twistFactor)*h*d*.12,c=d*l,g=this.centerX+Math.cos(o)*c+p,S=this.centerY+Math.sin(o)*c*(1-.4*h);0===e?t.moveTo(g,S):t.lineTo(g,S)}t.closePath();const S=16+22*l+12*this.energy.brilliance,u=.08+.16*(1-o)+.05*this.energy.overall,m=(e+n.colorShift+40*this.energy.presence)%360,y=t.createRadialGradient(this.centerX,this.centerY,Math.max(1,.2*d),this.centerX,this.centerY,Math.max(d,1));y.addColorStop(0,`hsla(${m}, 66%, ${Math.min(60,S+6)}%, ${.5*u})`),y.addColorStop(.7,`hsla(${(m+30)%360}, 70%, ${Math.max(9,S-14)}%, ${.3*u})`),y.addColorStop(1,`hsla(${m}, 58%, 8%, ${.12*u})`),t.fillStyle=y,t.fill(),t.lineWidth=Math.max(.9,.0045*d),t.strokeStyle=`hsla(${m}, 70%, ${Math.min(70,S+10)}%, ${.45*u})`,t.stroke()}t.restore()}_drawCore(t){const e=this.hue,i=this.minTunnelRadius*(.6+.4*this.portalScale);t.save(),t.globalAlpha=.75,t.translate(this.centerX,this.centerY),t.rotate(this.coreRotation);for(let s=0;s<3;s++){const h=i*(1-.22*s),r=Math.max(3,Math.round(this.portalSides+s)),a=.18-.065*s+.08*this.innerFlare;t.beginPath();for(let e=0;e<=r;e++){const i=e/r*Math.PI*2,a=h*(1+Math.sin(i*r+this.portalMorphPhase+s)*this.portalMorph*.25),n=Math.cos(i)*a,o=Math.sin(i)*a;0===e?t.moveTo(n,o):t.lineTo(n,o)}t.closePath();const n=42+20*this.innerFlare-6*s;t.fillStyle=`hsla(${(e+25*s)%360}, 64%, ${n}%, ${a})`,t.fill(),t.lineWidth=Math.max(.9,.04*h),t.strokeStyle=`hsla(${(e+180+20*s)%360}, 72%, ${Math.min(76,n+12)}%, ${.4*a})`,t.stroke()}t.restore();const s=1.4*i,h=t.createRadialGradient(this.centerX,this.centerY,0,this.centerX,this.centerY,Math.max(1,s));h.addColorStop(0,`hsla(${(e+200)%360}, 68%, 78%, ${.1+.1*this.innerFlare})`),h.addColorStop(1,"rgba(255,255,255,0)"),t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.75,t.fillStyle=h,t.fillRect(this.centerX-s,this.centerY-s,2*s,2*s),t.restore()}_updateSegmentCache(){this.segmentCache=[];const t=Math.max(6,Math.floor(this.tunnelSegments))||6;this.tunnelSegments=t;for(let e=0;e<=t;e++){const i=e/t;this.segmentCache.push({t:i,angle:i*Math.PI*2})}}}"undefined"!=typeof window&&(window.ChromaticWormholeVisualizer=ChromaticWormholeVisualizer);