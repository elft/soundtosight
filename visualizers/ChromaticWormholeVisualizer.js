class ChromaticWormholeVisualizer extends BaseVisualizer{constructor(t,e){super(t,{backgroundColor:"#040a17",force2d:!0,...e})}async init(){this.dpr>1.5&&(this.dpr=1,this.setupCanvas()),this.centerX=this.width/2,this.centerY=this.height/2,this.minTunnelRadius=.14*Math.min(this.width,this.height),this.maxTunnelRadius=.55*Math.hypot(this.width,this.height),this.backdropCanvas=document.createElement("canvas"),this.backdropCtx=this.backdropCanvas.getContext("2d"),this._resizeBackdrop(),this.energy={subBass:0,bass:0,lowMid:0,mid:0,upperMid:0,presence:0,treble:0,brilliance:0,ultrasonic:0,overall:0},this.colorState={baseHue:210,targetBaseHue:210,accentHue:36,targetAccentHue:36,rimHue:260},this.motion={rotation:0,rotationSpeed:.05,rotationSpeedTarget:.05,rotationDir:1,rotationDirTarget:1,sway:0,swayTarget:0,zoom:1,zoomTarget:1,twist:.12,twistTarget:.12,pulse:0,pulseTarget:0},this.depthDrift=.2,this.depthDriftTarget=.2,this.tunnelBands=this._initTunnelBands(9),this.rays=this._initRays(7),this.starStreams=this._initStarStreams(68),this.waveBursts=[],this.starfield={stretch:.22,targetStretch:.22,intensity:.24,targetIntensity:.24,drift:0,targetDrift:0},this.time=0,this.lastRenderTime=performance.now()}onResize(){this.centerX=this.width/2,this.centerY=this.height/2,this.minTunnelRadius=.14*Math.min(this.width,this.height),this.maxTunnelRadius=.55*Math.hypot(this.width,this.height),this._resizeBackdrop()}_resizeBackdrop(){const t=Math.max(16,Math.round(.35*this.width)),e=Math.max(16,Math.round(.35*this.height));this.backdropCanvas.width=t,this.backdropCanvas.height=e}_initTunnelBands(t){const e=[];for(let s=0;s<t;s++){const i=(s+1)/t,r=this.minTunnelRadius+i*this.maxTunnelRadius*.5;e.push({index:s,depth:i,targetDepth:i,radius:r,targetRadius:r,thickness:.03,targetThickness:.03,warp:.12,targetWarp:.12,brightness:.2,targetBrightness:.2,hueOffset:50*(Math.random()-.5),phase:Math.random()*Math.PI*2,spin:.24+.5*Math.random(),flicker:.18,segments:42,seed:1e3*Math.random()})}return e}_initRays(t){const e=[];for(let s=0;s<t;s++){const i=s/t*Math.PI*2;e.push({angle:i,phase:Math.random()*Math.PI*2,width:.04,targetWidth:.04,length:.55,targetLength:.55,intensity:.2,targetIntensity:.2,hueOffset:60*(Math.random()-.5),sway:0,swayTarget:0})}return e}_initStarStreams(t){const e=[];for(let s=0;s<t;s++)e.push(this._resetStarStream({}));return e}_resetStarStream(t){return t.x=1.6*(Math.random()-.5),t.y=1.6*(Math.random()-.5),t.depth=.8*Math.random()+.2,t.speed=.32+.6*Math.random(),t.stretch=.18+.22*Math.random(),t.brightness=.28+.4*Math.random(),t.phase=Math.random()*Math.PI*2,t.twist=.6*(Math.random()-.5),t}_updateBackdrop(){const t=this.backdropCanvas.width,e=this.backdropCanvas.height;if(0===t||0===e)return;const s=this.backdropCtx;s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,t,e);const i=s.createRadialGradient(t/2,e/2,.12*t,t/2,e/2,.8*Math.max(t,e));i.addColorStop(0,`hsla(${this.colorState.accentHue}, 74%, 68%, 0.28)`),i.addColorStop(1,`hsla(${(this.colorState.baseHue+210)%360}, 52%, 14%, 0)`),s.fillStyle=i,s.fillRect(0,0,t,e);const r=s.createLinearGradient(0,0,t,e);r.addColorStop(0,`hsla(${(this.colorState.baseHue+180)%360}, 48%, 18%, 0.32)`),r.addColorStop(1,`hsla(${(this.colorState.accentHue+40)%360}, 56%, 24%, 0.28)`),s.globalCompositeOperation="lighter",s.fillStyle=r,s.fillRect(0,0,t,e),s.globalCompositeOperation="source-over"}onUpdate(t={}){const e=.12;this.energy.subBass=this.lerp(this.energy.subBass,t.subBassEnergy||0,e),this.energy.bass=this.lerp(this.energy.bass,t.bassEnergy||0,e),this.energy.lowMid=this.lerp(this.energy.lowMid,t.lowMidEnergy||0,e),this.energy.mid=this.lerp(this.energy.mid,t.midEnergy||0,e),this.energy.upperMid=this.lerp(this.energy.upperMid,t.upperMidEnergy||0,e),this.energy.presence=this.lerp(this.energy.presence,t.presenceEnergy||0,e),this.energy.treble=this.lerp(this.energy.treble,t.trebleEnergy||0,e),this.energy.brilliance=this.lerp(this.energy.brilliance,t.brillianceEnergy||0,e),this.energy.ultrasonic=this.lerp(this.energy.ultrasonic,t.ultrassonicEnergy||t.ultrasonicEnergy||0,e);const s=Number.isFinite(t.overallEnergy)?t.overallEnergy:t.rms||0;this.energy.overall=this.lerp(this.energy.overall,s,e);const i=Number.isFinite(t.dominantFreq)?Math.max(30,t.dominantFreq):180,r=Math.log(i),a=this.constrain(this.map(r,Math.log(40),Math.log(16e3),0,1),0,1);this.colorState.targetBaseHue=(190+140*a-50*this.energy.lowMid+90*this.energy.brilliance)%360,this.colorState.targetAccentHue=(this.colorState.targetBaseHue+100+80*this.energy.presence)%360,this.colorState.baseHue=this._lerpHue(this.colorState.baseHue,this.colorState.targetBaseHue,.06),this.colorState.accentHue=this._lerpHue(this.colorState.accentHue,this.colorState.targetAccentHue,.08),this.colorState.rimHue=(this.colorState.baseHue+200)%360;const h=Number.isFinite(t.stereoBalance)?t.stereoBalance:0;this.motion.rotationSpeedTarget=.03+.45*this.energy.lowMid+.3*this.energy.mid,this.motion.rotationDirTarget=this.constrain(1.4*h+.4*Math.sin(.25*this.time),-1,1),this.motion.zoomTarget=1+.35*this.energy.subBass+.25*this.energy.overall,this.motion.swayTarget=.8*(this.energy.presence-.5),this.motion.twistTarget=.08+.3*this.energy.upperMid+.25*Math.abs(h),this.motion.pulseTarget=Math.max(.9*this.motion.pulseTarget,.5*this.energy.bass+.7*this.energy.subBass),this.depthDriftTarget=.18+.4*this.energy.mid+.2*this.energy.presence,this.starfield.targetStretch=.18+.8*this.energy.treble+.4*this.energy.brilliance,this.starfield.targetIntensity=.18+.5*this.energy.treble+.4*this.energy.presence,this.starfield.targetDrift=.5*h;for(let t=0;t<this.tunnelBands.length;t++){const e=this.tunnelBands[t],s=(t+1)/this.tunnelBands.length,i=this.motion.pulseTarget*(1-s)*.25-.05*this.depthDrift;e.targetDepth=this.constrain(s+i,.05,1.15),e.targetRadius=this.minTunnelRadius+s*this.maxTunnelRadius*this.motion.zoom,e.targetThickness=.02+.035*this.energy.bass+.03*(1-s),e.targetWarp=.1+.28*this.energy.upperMid+.18*this.energy.presence,e.targetBrightness=.12+.45*this.energy.brilliance+.25*(1-s),e.hueOffset=this.lerp(e.hueOffset,35*Math.sin(.35*this.time+e.seed)+30*this.energy.presence,.08),e.flicker=this.lerp(e.flicker,.18+.6*this.energy.treble,.1)}for(const t of this.rays)t.targetWidth=.02+.07*this.energy.presence+.04*this.energy.treble,t.targetLength=.48+.45*this.energy.mid+.35*this.energy.brilliance,t.targetIntensity=.18+.6*this.energy.treble+.3*this.energy.brilliance,t.swayTarget=.6*(this.energy.upperMid-.5),t.hueOffset=this.lerp(t.hueOffset,40*Math.sin(.5*this.time+t.phase)+30*this.energy.presence,.08);this.energy.subBass>.55&&this.energy.overall>.4&&Math.random()<.18&&this.waveBursts.push({progress:0,alpha:.4+.45*this.energy.bass,width:.012+.05*this.energy.subBass,hueShift:50*(Math.random()-.5),rotation:Math.random()*Math.PI*2,spread:.9+.8*this.energy.presence}),this.energy.treble>.6&&Math.random()<.1&&this.waveBursts.push({progress:0,alpha:.28+.4*this.energy.treble,width:.008+.03*this.energy.treble,hueShift:120+60*(Math.random()-.5),rotation:Math.random()*Math.PI*2,spread:.6+.9*this.energy.brilliance})}onRender(){const t=this.ctx;if(!t)return;const e=performance.now(),s=Math.min(.06,(e-this.lastRenderTime)/1e3);this.lastRenderTime=e,this.time+=s,this.motion.rotationSpeed=this.lerp(this.motion.rotationSpeed,this.motion.rotationSpeedTarget,.08),this.motion.rotationDir=this.lerp(this.motion.rotationDir,this.motion.rotationDirTarget,.08),this.motion.sway=this.lerp(this.motion.sway,this.motion.swayTarget,.06),this.motion.zoom=this.lerp(this.motion.zoom,this.motion.zoomTarget,.07),this.motion.twist=this.lerp(this.motion.twist,this.motion.twistTarget,.08),this.motion.pulse=this.lerp(this.motion.pulse,this.motion.pulseTarget,.12),this.depthDrift=this.lerp(this.depthDrift,this.depthDriftTarget,.08),this.starfield.stretch=this.lerp(this.starfield.stretch,this.starfield.targetStretch,.1),this.starfield.intensity=this.lerp(this.starfield.intensity,this.starfield.targetIntensity,.1),this.starfield.drift=this.lerp(this.starfield.drift,this.starfield.targetDrift,.08),this.motion.rotation+=this.motion.rotationSpeed*this.motion.rotationDir*s*(.9+.8*this.motion.pulse),this.motion.rotation>2*Math.PI&&(this.motion.rotation-=2*Math.PI),this.motion.rotation<2*-Math.PI&&(this.motion.rotation+=2*Math.PI),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.width,this.height),t.fillStyle="#040a17",t.fillRect(0,0,this.width,this.height),this._renderBackdrop(t,this.width,this.height),this._renderWaveBursts(t,s),this._renderTunnel(t,s),this._renderRays(t,s),this._renderStarStreams(t,s),this._renderCore(t)}_renderBackdrop(t,e,s){this._updateBackdrop(),t.save(),t.globalCompositeOperation="lighter",t.globalAlpha=.9,t.drawImage(this.backdropCanvas,0,0,this.backdropCanvas.width,this.backdropCanvas.height,0,0,e,s),t.restore()}_renderTunnel(t,e){t.save(),t.translate(this.centerX,this.centerY),t.rotate(.6*this.motion.rotation);for(const s of this.tunnelBands){s.depth=this.lerp(s.depth,s.targetDepth,.1),s.radius=this.lerp(s.radius,s.targetRadius,.1),s.thickness=this.lerp(s.thickness,s.targetThickness,.12),s.warp=this.lerp(s.warp,s.targetWarp,.12),s.brightness=this.lerp(s.brightness,s.targetBrightness,.13),s.phase+=e*(.6*s.spin+.8*this.motion.rotationSpeed);const i=this.constrain(1-s.depth,0,1),r=Math.max(8,s.radius)*(.8+.5*i),a=s.segments;t.save(),t.rotate(s.phase),t.beginPath();for(let e=0;e<=a;e++){const h=e/a*Math.PI*2,n=r*(1+Math.sin(h*(4+4*i)+s.seed)*s.warp+Math.sin(2*h+this.motion.rotation)*this.motion.twist*.5),o=Math.cos(h)*n,l=Math.sin(h)*n*(1-.35*this.motion.sway);0===e?t.moveTo(o,l):t.lineTo(o,l)}t.closePath();const h=(this.colorState.baseHue+s.hueOffset)%360,n=this.constrain(.12+.6*s.brightness,.05,.8);t.fillStyle=`hsla(${h}, 70%, ${40+40*s.brightness}%, ${n})`,t.fill(),t.lineWidth=Math.max(1,s.thickness*r*.1),t.strokeStyle=`hsla(${(h+180)%360}, 65%, ${55+30*i}%, ${.5*n})`,t.stroke(),t.restore()}t.restore()}_renderRays(t,e){t.save(),t.translate(this.centerX,this.centerY);const s=this.minTunnelRadius*(.75+.2*this.motion.pulse),i=.6*this.maxTunnelRadius;for(const r of this.rays){r.width=this.lerp(r.width,r.targetWidth,.1),r.length=this.lerp(r.length,r.targetLength,.1),r.intensity=this.lerp(r.intensity,r.targetIntensity,.1),r.sway=this.lerp(r.sway,r.swayTarget,.08),r.phase+=e*(.6+1.5*this.motion.rotationSpeed+.8*this.motion.pulse);const a=r.angle+.3*this.motion.rotation+.25*Math.sin(r.phase)+r.sway,h=r.width,n=s,o=Math.min(i,n+i*r.length),l=(this.colorState.accentHue+r.hueOffset)%360;t.beginPath(),t.moveTo(Math.cos(a-h)*n,Math.sin(a-h)*n),t.lineTo(Math.cos(a)*o,Math.sin(a)*o*(1-.4*this.motion.sway)),t.lineTo(Math.cos(a+h)*n,Math.sin(a+h)*n),t.closePath(),t.fillStyle=`hsla(${l}, 80%, 65%, ${.12+.6*r.intensity})`,t.fill()}t.restore()}_renderStarStreams(t,e){t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.9;for(const s of this.starStreams){if(s.depth-=e*(.3+1.2*this.depthDrift)*s.speed,s.depth<=.05){this._resetStarStream(s),s.depth+=.8;continue}s.phase+=e*(.5+.9*this.motion.rotationSpeed);const i=1/(1.4*s.depth);if(s.x+=this.starfield.drift*e*.4,s.y+=Math.sin(s.phase)*e*.2,Math.abs(s.x)>1.8||Math.abs(s.y)>1.8){this._resetStarStream(s);continue}const r=this.centerX+s.x*this.width*.28*i,a=this.centerY+s.y*this.height*.28*i,h=Math.max(1.2,s.stretch*i*this.starfield.stretch*this.maxTunnelRadius*.02),n=Math.max(.7,.18*h),o=(this.colorState.rimHue+25*Math.sin(s.phase+s.twist))%360;t.save(),t.translate(r,a),t.rotate(Math.atan2(a-this.centerY,r-this.centerX)+.3*this.motion.sway);const l=t.createLinearGradient(-n,.5*-h,n,.5*h);l.addColorStop(0,`hsla(${o}, 75%, 70%, 0)`),l.addColorStop(.5,`hsla(${o}, 80%, 65%, ${.18+this.starfield.intensity*s.brightness})`),l.addColorStop(1,`hsla(${(o+20)%360}, 85%, 75%, 0)`),t.fillStyle=l,t.fillRect(-n,.5*-h,2*n,h),t.restore()}t.restore()}_renderWaveBursts(t,e){if(0!==this.waveBursts.length){t.save(),t.translate(this.centerX,this.centerY),t.globalCompositeOperation="screen";for(let s=this.waveBursts.length-1;s>=0;s--){const i=this.waveBursts[s];if(i.progress+=e*(.35+1.4*this.motion.pulse+.6*this.depthDrift),i.alpha=Math.max(0,i.alpha-e*(.25+.4*this.energy.treble)),i.progress>=1||i.alpha<=.02){this.waveBursts.splice(s,1);continue}const r=this.minTunnelRadius*(.6+2.6*i.progress),a=Math.max(1,i.width*this.maxTunnelRadius*.05),h=(this.colorState.baseHue+i.hueShift)%360;t.lineWidth=a,t.strokeStyle=`hsla(${h}, 80%, 68%, ${i.alpha})`,t.beginPath(),t.arc(0,0,r,i.rotation-i.spread,i.rotation+i.spread),t.stroke()}t.restore()}}_renderCore(t){const e=this.minTunnelRadius*(.6+.5*this.motion.pulse);t.save(),t.translate(this.centerX,this.centerY),t.rotate(.9*this.motion.rotation);for(let s=0;s<3;s++){const i=e*(1-.24*s),r=Math.max(3,Math.round(5+4*this.motion.pulse-s)),a=(this.colorState.accentHue+25*s)%360,h=.2-.05*s+.1*this.energy.brilliance;t.beginPath();for(let e=0;e<=r;e++){const a=e/r*Math.PI*2,h=i*(1+.08*Math.sin(a*(3+6*this.motion.twist)+.8*this.time+s)),n=Math.cos(a)*h,o=Math.sin(a)*h;0===e?t.moveTo(n,o):t.lineTo(n,o)}t.closePath(),t.fillStyle=`hsla(${a}, 76%, ${48+8*s}%, ${h})`,t.fill(),t.lineWidth=Math.max(1,.05*i),t.strokeStyle=`hsla(${(a+180)%360}, 68%, 72%, ${.5*h})`,t.stroke()}t.restore();const s=1.6*e,i=t.createRadialGradient(this.centerX,this.centerY,0,this.centerX,this.centerY,Math.max(1,s));i.addColorStop(0,`hsla(${(this.colorState.accentHue+200)%360}, 90%, 80%, ${.12+.2*this.energy.brilliance})`),i.addColorStop(1,"rgba(255,255,255,0)"),t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.75,t.fillStyle=i,t.fillRect(this.centerX-s,this.centerY-s,2*s,2*s),t.restore()}_lerpHue(t,e,s){return t+((e-t+540)%360-180)*s}}"undefined"!=typeof window&&(window.ChromaticWormholeVisualizer=ChromaticWormholeVisualizer);