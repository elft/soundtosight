class ChromaticOsmosisVisualizer extends BaseVisualizer{static meta={description:"Liquid ribbons and prismatic fields that melt between harmonics.",tags:["psychedelic","melodic","downtempo","ambient"]};constructor(t={}){super(null,{backgroundColor:"#050508",force2d:!0,...t}),this.backdropCanvas=document.createElement("canvas"),this.backdropCtx=this.backdropCanvas.getContext("2d"),this._resizeBackdrop(),this.palette={baseHue:210,targetHue:210,accentHue:45,targetAccentHue:45,depth:.18,exposure:.45,fog:.2},this.renderState={shimmer:0,sparkle:0,contour:0,rhythm:0,brilliance:0,entropy:0,kickPulse:0,snarePulse:0,hatSpark:0},this.scene={motif:0,sectionSeed:1e3*Math.random()|0,sectionTime:0,cameraYaw:0,cameraPitch:0,cameraRoll:0,cameraDrift:.25,dropFlash:0,aberration:0,chromaBloom:0},this.layers=this._initLayers(5),this.ribbons=this._initRibbons(6),this.orbitals=this._initOrbitals(48),this.waveFronts=[],this.shards=this._initShards(120),this.sparkBursts=[],this.sceneTime=0,this.lowPassEnergy=0,this.metrics=null,this._lastTime=.001*performance.now()}_resizeBackdrop(){const t=Math.max(16,Math.round(.4*this.width)),e=Math.max(16,Math.round(.4*this.height));this.backdropCanvas.width=t,this.backdropCanvas.height=e}onResize(){this._resizeBackdrop(),this.shards=this._initShards(this.shards?.length||120)}_initLayers(t){const e=[];for(let a=0;a<t;a++)e.push({radius:.24+.08*a,targetRadius:.24+.08*a,angle:Math.random()*Math.PI*2,speed:.01+.01*Math.random(),thickness:.04,hueShift:a/t*140,alpha:.35,arcSpan:1.2+.6*Math.random(),pulse:Math.random()*Math.PI*2});return e}_initRibbons(t){const e=[];for(let a=0;a<t;a++)e.push({index:a,phase:Math.random()*Math.PI*2,radius:.3+.1*Math.random(),targetRadius:.3+.1*Math.random(),amplitude:.04+.02*Math.random(),targetAmplitude:.04,hueShift:90*(Math.random()-.5),thickness:.015,tilt:.6*(Math.random()-.5),bias:.6+.2*Math.random()});return e}_initOrbitals(t){const e=[];for(let a=0;a<t;a++)e.push({band:a%6,angle:Math.random()*Math.PI*2,radius:.22+a%6*.05,targetRadius:.22+a%6*.05,speed:.01+.02*Math.random(),size:2+1.5*Math.random(),hueShift:60*(Math.random()-.5),heightScale:.6+.2*Math.random(),shimmerPhase:Math.random()*Math.PI*2,seed:Math.random()*Math.PI*2});return e}_initShards(t){const e=[],a=.42*Math.min(this.width,this.height)||240;for(let s=0;s<t;s++){const t=Math.random()*Math.PI*2,s=a*(.3+.7*Math.random()),i=3+Math.floor(3*Math.random()),r=[];for(let e=0;e<i;e++){const a=t+e/i*Math.PI*2+.4*(Math.random()-.5),h=s*(.32+.5*Math.random());r.push({x:Math.cos(a)*h,y:Math.sin(a)*h*(.8+.4*Math.random())})}e.push({angle:t,dist:s,pts:r,thickness:.6+.6*Math.random(),hueShift:90*(Math.random()-.5),sparkle:Math.random()})}return e}_advanceSection(t=1,e=!1){this.scene.sectionSeed=this.scene.sectionSeed+1|0,this.scene.sectionTime=0,(e||t>.65)&&(this.scene.motif=(this.scene.motif+1)%2,this.shards=this._initShards(this.shards?.length||120));const a=50*(Math.random()-.5)*t;this.palette.targetHue=(this.palette.baseHue+a+360)%360,this.palette.targetAccentHue=(this.palette.accentHue+90+.5*a+360)%360;for(const t of this.layers)t.angle+=.6*(Math.random()-.5),t.hueShift=(t.hueShift+.6*a)%360;for(const t of this.ribbons)t.hueShift+=a,t.bias=.55+.4*Math.random();for(const t of this.orbitals)t.hueShift+=.4*a}_spawnWaveBurst(t=1,e=this.palette.baseHue){const a=.9+1.4*t;this.waveFronts.push({progress:0,width:.01+.035*t,alpha:.25+.35*t,angle:Math.random()*Math.PI*2,spread:a,hueShift:e-this.palette.baseHue})}_spawnSparkBurst(t=.5,e=this.palette.accentHue,a=!1){const s=12+Math.round(18*t);for(let i=0;i<s;i++){const s=Math.random()*Math.PI*2;this.sparkBursts.push({angle:s,hue:e,size:12+20*t,alpha:.25+.6*t,velocity:120+140*t,life:.7+.6*Math.random(),airy:a})}}_lerp(t,e,a){return t+(e-t)*a}_lerpAngle(t,e,a){return t+((e-t+540)%360-180)*a}_safe(t,e=0){return Number.isFinite(t)?t:e}_updateBackdrop(){const t=Math.max(16,Math.round(.4*this.width)),e=Math.max(16,Math.round(.4*this.height));this.backdropCanvas.width===t&&this.backdropCanvas.height===e||(this.backdropCanvas.width=t,this.backdropCanvas.height=e);const a=this.backdropCtx;a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,t,e);const s=a.createRadialGradient(t/2,e/2,.08*t,t/2,e/2,.75*Math.max(t,e));s.addColorStop(0,`hsla(${this.palette.accentHue}, 70%, 60%, ${.24+.26*this.palette.depth})`),s.addColorStop(1,`hsla(${(this.palette.baseHue+220)%360}, 45%, 10%, 0)`),a.fillStyle=s,a.fillRect(0,0,t,e);const i=a.createLinearGradient(0,0,t,e);i.addColorStop(0,`hsla(${(this.palette.baseHue+20)%360}, 50%, 24%, ${.28*this.palette.depth})`),i.addColorStop(1,`hsla(${(this.palette.accentHue+200)%360}, 46%, 16%, ${.08+.08*this.palette.depth})`),a.globalCompositeOperation="lighter",a.fillStyle=i,a.fillRect(0,0,t,e),a.globalCompositeOperation="source-over"}onUpdate(t={}){this.metrics=t;const e=.001*performance.now(),a=this.clamp(e-this._lastTime,1/240,.1);this._lastTime=e,this.sceneTime+=a,this.scene.sectionTime+=a;const s=this.audioTriggers||{},i=(this.dbTo01(Number.isFinite(t?.loudnessShortDb)?t.loudnessShortDb:t?.aWeighted?.mono?.db??-60),this.dbTo01(Number.isFinite(t?.loudnessIntegratedDb)?t.loudnessIntegratedDb:t?.aWeighted?.mono?.db??-60)),r=this._safe(t?.tempo,120),h=this.clamp(this._safe(t?.tempoConfidence,0),0,1),o=(Number.isFinite(t?.beatPhase)?t.beatPhase:this.sceneTime,this.clamp(this._safe(t?.percussiveEnergy,t?.spectralFlux??0),0,1)),n=this.clamp(this._safe(t?.harmonicEnergy,1-o),0,1),l=this.clamp(this._safe(t?.percussiveRatio,o),0,1),c=this.clamp(this._safe(t?.spectralEntropy,0),0,1),p=(this._safe(t?.spectralSpreadHz,0),this._safe(t?.spectralRolloff85??t?.spectralRolloff95??t?.centroid,9e3)),d=this._safe(t?.spectralSlope,0),m=this._safe(t?.stereoBalance,0),u=this._safe(t?.midSideRatio,.5),f=(this._safe(t?.interchannelCorrelation,0),t?.fluxByBand||[]),b=this.clamp(.5*((f[0]??0)+(f[1]??0)),0,1),g=this.clamp(.5*((f[3]??0)+(f[4]??0)),0,1),M=this.clamp(.5*((f[6]??0)+(f[7]??0)),0,1),S=this.clamp(.18+.55*i+.08*l-.12*n,.14,.88);this.palette.exposure=this.attackRelease(this.palette.exposure,S,a,.08,.6),this.palette.depth=this.attackRelease(this.palette.depth,.12+.32*n,a,.1,.5),this.palette.fog=this.attackRelease(this.palette.fog,.08+.35*n+.25*c,a,.4,1.4);const k=(200+this.clamp(90*d,-120,120)+140*this.clamp(p/2e4,0,1)+18*h)%360;this.palette.targetHue=k,this.palette.baseHue=this._lerpAngle(this.palette.baseHue,this.palette.targetHue,.04);const _=(this.palette.baseHue+120+90*l-60*c)%360;this.palette.targetAccentHue=_,this.palette.accentHue=this._lerpAngle(this.palette.accentHue,this.palette.targetAccentHue,.06),this.renderState.shimmer=this.attackRelease(this.renderState.shimmer,.15+.85*this.clamp(this._safe(t?.trebleEnergy,0),0,1),a,.12,.5),this.renderState.sparkle=this.attackRelease(this.renderState.sparkle,.2+.8*this.clamp(this._safe(t?.presenceEnergy,0),0,1),a,.12,.5),this.renderState.contour=this.attackRelease(this.renderState.contour,.24+.82*this.clamp(this._safe(t?.bassEnergy,0),0,1),a,.1,.4),this.renderState.rhythm=this.attackRelease(this.renderState.rhythm,.22+.9*this.clamp(this._safe(t?.subBassEnergy,0),0,1),a,.08,.45),this.renderState.brilliance=this.attackRelease(this.renderState.brilliance,.18+.75*this.clamp(this._safe(t?.brillianceEnergy,0),0,1),a,.16,.6),this.renderState.entropy=this.attackRelease(this.renderState.entropy,c,a,.2,.7),this.renderState.kickPulse=this.attackRelease(this.renderState.kickPulse,b,a,.04,.5),this.renderState.snarePulse=this.attackRelease(this.renderState.snarePulse,g,a,.05,.55),this.renderState.hatSpark=this.attackRelease(this.renderState.hatSpark,M,a,.08,.6),this.scene.cameraYaw+=a*(.18+.3*h+.35*o);const y=.6*(u-.5),x=.35*m;if(this.scene.cameraPitch=this.attackRelease(this.scene.cameraPitch,y,a,.16,.7),this.scene.cameraRoll=this.attackRelease(this.scene.cameraRoll,x,a,.14,.6),this.scene.cameraDrift=this.attackRelease(this.scene.cameraDrift,.18+.4*n+.25*l,a,.1,.6),s.dropStart){const t=this.clamp(s.dropScore??.8,0,1);this.scene.dropFlash=Math.max(this.scene.dropFlash,.8+.6*t),this.scene.aberration=Math.max(this.scene.aberration,.35+.5*t),this.scene.chromaBloom=Math.max(this.scene.chromaBloom,.5+.4*t),this._advanceSection(t,!0),this._spawnWaveBurst(1.8+t,(this.palette.baseHue+40)%360)}else this.scene.dropFlash=Math.max(0,this.scene.dropFlash-.9*a),this.scene.aberration=Math.max(0,this.scene.aberration-.7*a),this.scene.chromaBloom=Math.max(0,this.scene.chromaBloom-a*(.4+.2*c));s.dropBloom&&(this.scene.chromaBloom=Math.max(this.scene.chromaBloom,.3+.3*(s.dropScore??0))),s.melodyChange&&(s.melodyChangeScore??0)>.7&&this._advanceSection(this.clamp(s.melodyChangeScore??1,0,1));const R=h>.6?24:32,v=60/Math.max(40,r)*R;this.scene.sectionTime>v&&this._advanceSection(.6);const C=.35+.5*this.renderState.sparkle+.25*l,w=this.renderState.contour,B=this.renderState.rhythm,P=this.renderState.shimmer,H=this.renderState.sparkle,$=this.renderState.brilliance;for(let t=0;t<this.layers.length;t++){const e=this.layers[t],a=B*(.7-.1*t)+.45*w,s=.22+.12*t;e.targetRadius=s+.22*a,e.radius=this._lerp(e.radius,e.targetRadius,.1),e.angle+=(e.speed+.01*t)*(1+.6*C),e.thickness=this._lerp(e.thickness,.02+.06*w,.14);const i=Math.max(.04,.12+.25*H-.03*t);e.alpha=this._lerp(e.alpha,i,.12),e.arcSpan=this._lerp(e.arcSpan,1.1+2.4*w,.1),e.pulse+=.02+.05*B+.03*C}for(const t of this.ribbons)t.targetRadius=.3+.18*C+.025*t.index,t.radius=this._lerp(t.radius,t.targetRadius,.15),t.phase+=.01+.05*C+.035*P,t.targetAmplitude=.04+.11*w+.02*t.bias,t.amplitude=this._lerp(t.amplitude,t.targetAmplitude,.12),t.tilt=this._lerp(t.tilt,1.2*(l-.5)+.6*m,.08),t.thickness=this._lerp(t.thickness,.01+.03*P+.02*this.scene.chromaBloom,.12);for(const t of this.orbitals){const e=t.band%6*.1,a=f[t.band%f.length]??.2;t.speed=.005+.035*H+.02*a,t.angle+=t.speed*(1+.6*h),t.targetRadius=.24+.08*t.band+.18*w+.12*this.scene.chromaBloom,t.radius=this._lerp(t.radius,t.targetRadius,.1),t.heightScale=this._lerp(t.heightScale,.6+e+.3*C,.08);const s=1+4*e+2.2*P+1.2*n;t.size=this._lerp(t.size,s,.18),t.shimmerPhase+=.1+.28*P+.22*$}b>.55-.15*h&&this._spawnWaveBurst(1+1.4*b,(this.palette.baseHue+30)%360),g>.45&&Math.random()<.6&&this._spawnSparkBurst(g,(this.palette.accentHue+160)%360),M>.4&&Math.random()<.35&&this._spawnSparkBurst(.7*M,(this.palette.accentHue+40)%360,!0);for(const t of this.waveFronts)t.progress+=(.4+1.6*w)*a,t.alpha*=1-(.9+.3*P)*a*.6;this.waveFronts=this.waveFronts.filter(t=>t.alpha>.02);for(const t of this.sparkBursts)t.life-=.9*a,t.size+=a*(t.velocity+60*this.scene.chromaBloom),t.alpha*=1-a*(.8+.4*H);this.sparkBursts=this.sparkBursts.filter(t=>t.life>0&&t.alpha>.04),this.scene.dropFlash=Math.max(0,this.scene.dropFlash*(1-.6*a)),this.scene.aberration=Math.max(0,this.scene.aberration)}_renderBackground(t,e,a){const s=this.palette.exposure,i=this.palette.depth,r=this.palette.fog,h=this.palette.baseHue,o=this.palette.accentHue,n=t.createLinearGradient(0,0,e,a),l=6+32*s,c=4+24*s,p=2+16*s;n.addColorStop(0,`hsl(${h}, 38%, ${l}%)`),n.addColorStop(.6,`hsl(${(h+30)%360}, 32%, ${c}%)`),n.addColorStop(1,`hsl(${(o+210)%360}, 28%, ${p}%)`),t.fillStyle=n,t.fillRect(0,0,e,a),this._updateBackdrop(),t.globalCompositeOperation="screen",t.globalAlpha=.3+.55*i,t.drawImage(this.backdropCanvas,0,0,this.backdropCanvas.width,this.backdropCanvas.height,0,0,e,a),t.globalAlpha=1,t.globalCompositeOperation="source-over";const d=t.createRadialGradient(e/2,a/2,.1*Math.min(e,a),e/2,a/2,.9*Math.max(e,a));d.addColorStop(0,`rgba(5, 10, 15, ${.08+.2*r})`),d.addColorStop(1,"rgba(0, 0, 0, 0.95)"),t.fillStyle=d,t.fillRect(0,0,e,a),this.scene.dropFlash>.05&&(t.globalCompositeOperation="screen",t.globalAlpha=.25*this.scene.dropFlash,t.fillStyle=`hsla(${(o+180)%360}, 100%, 70%, 1)`,t.fillRect(0,0,e,a),t.globalAlpha=1,t.globalCompositeOperation="source-over")}_renderLayers(t,e,a){const s=Math.min(e,a),i=this.palette.exposure,r=this.scene;for(const h of this.layers){const o=Math.max(12,h.radius*s*.52),n=Math.max(.8,h.thickness*s*.07),l=Math.max(0,Math.min(1,h.alpha*(.7+.6*i))),c=(this.palette.baseHue+h.hueShift+18*Math.sin(h.pulse))%360,p=Math.max(.4,Math.min(1.95*Math.PI,h.arcSpan));t.save(),t.translate(e/2,a/2),t.rotate(.05*r.cameraYaw),t.scale(1+.18*r.cameraDrift,1+.15*r.cameraDrift-.3*r.cameraPitch),t.rotate(.25*r.cameraRoll),t.rotate(h.angle),t.globalAlpha=l,t.strokeStyle=`hsla(${c}, 65%, ${40+35*i}%, 1)`,t.lineWidth=n,t.shadowColor=`hsla(${c}, 70%, 55%, ${.3+.4*i})`,t.shadowBlur=n*(1.3+1.2*this.scene.chromaBloom),t.beginPath(),t.arc(0,0,o,-p/2,p/2),t.stroke(),t.beginPath(),t.arc(0,0,o,Math.PI-p/2,Math.PI+p/2),t.stroke(),t.restore()}t.globalAlpha=1,t.shadowBlur=0,t.shadowColor="transparent"}_renderRibbons(t,e,a){if(0!==this.scene.motif)return;const s=Math.min(e,a),i=this.palette.exposure,r=this.scene;t.globalCompositeOperation="screen";for(const h of this.ribbons){const o=Math.max(10,h.radius*s*.45),n=h.amplitude*s*.2,l=Math.max(1,h.thickness*s*.08),c=(this.palette.accentHue+h.hueShift)%360,p=48;t.save(),t.translate(e/2,a/2),t.rotate(.03*r.cameraYaw),t.scale(1+.12*r.cameraDrift,1+.08*r.cameraDrift),t.rotate(h.tilt+.2*r.cameraRoll),t.beginPath();for(let e=0;e<=p;e++){const a=e/p*Math.PI*2,s=o+Math.sin(2*a+h.phase)*n,i=Math.cos(a)*s,r=Math.sin(a)*s*h.bias;0===e?t.moveTo(i,r):t.lineTo(i,r)}t.closePath(),t.strokeStyle=`hsla(${c}, 72%, ${35+40*i}%, ${.14+.2*this.scene.chromaBloom})`,t.lineWidth=l,t.stroke(),t.restore()}t.globalCompositeOperation="source-over"}_renderShards(t,e,a){if(1!==this.scene.motif||!this.shards?.length)return;const s=this.palette.exposure,i=this.scene;t.save(),t.translate(e/2,a/2),t.rotate(.04*i.cameraYaw),t.scale(1+.15*i.cameraDrift,1+.12*i.cameraDrift-.4*i.cameraPitch),t.rotate(.25*i.cameraRoll);for(const e of this.shards){const a=(this.palette.accentHue+e.hueShift+.4*this.scene.sectionSeed)%360,i=.08+.35*s+.2*e.sparkle+.3*this.scene.chromaBloom;t.globalAlpha=Math.min(1,i),t.fillStyle=`hsla(${a}, 62%, ${28+32*s}%, 0.9)`,t.strokeStyle=`hsla(${a}, 78%, ${48+30*s}%, 0.6)`,t.lineWidth=e.thickness*(1+.6*this.scene.chromaBloom),t.beginPath();const r=e.pts[0];t.moveTo(r.x,r.y);for(let a=1;a<e.pts.length;a++){const s=e.pts[a];t.lineTo(s.x,s.y)}t.closePath(),t.fill(),t.stroke()}t.restore(),t.globalAlpha=1}_renderOrbitals(t,e,a){const s=Math.min(e,a),{shimmer:i,sparkle:r}=this.renderState,h=this.palette.exposure,o=this.scene;t.save(),t.translate(e/2,a/2),t.rotate(.05*o.cameraYaw),t.scale(1+.1*o.cameraDrift,1+.1*o.cameraDrift-.25*o.cameraPitch);for(const e of this.orbitals){const a=Math.max(14,e.radius*s*.38),n=Math.cos(e.angle+e.seed)*a,l=Math.sin(e.angle+e.seed)*a*(e.heightScale+.3*o.cameraPitch),c=.22+Math.abs(Math.sin(e.shimmerPhase))*(.26+.35*i+.2*r)+.25*this.scene.chromaBloom,p=Math.max(0,Math.min(.8,c*(.6+.7*h))),d=(this.palette.accentHue+e.hueShift)%360,m=Math.max(1.2,e.size*(.8+.4*h));t.fillStyle=`hsla(${d}, 72%, ${45+35*h}%, ${p})`,t.beginPath(),t.ellipse(n,l,m,m*(.6+.3*this.renderState.entropy),0,0,2*Math.PI),t.fill()}t.restore()}_renderWaveFronts(t,e,a){if(!this.waveFronts.length)return;const s=Math.min(e,a),i=this.palette.exposure,r=this.scene;t.save(),t.translate(e/2,a/2),t.rotate(.04*r.cameraYaw),t.scale(1+.1*r.cameraDrift,1+.08*r.cameraDrift),t.globalCompositeOperation="screen";for(const e of this.waveFronts){const a=e.progress*s*.6+.1*s,r=Math.max(1,e.width*s*.08),h=Math.max(0,Math.min(1,e.alpha)),o=(this.palette.baseHue+e.hueShift)%360,n=Math.max(.4,Math.min(2*Math.PI,e.spread));t.lineWidth=r,t.strokeStyle=`hsla(${o}, 70%, ${38+32*i}%, ${h*(.5+.6*i)})`,t.beginPath(),t.arc(0,0,a,e.angle-n/2,e.angle+n/2),t.stroke()}t.restore(),t.globalCompositeOperation="source-over"}_renderSparkBursts(t,e,a){if(!this.sparkBursts.length)return;const s=this.palette.exposure,i=this.scene;t.save(),t.translate(e/2,a/2),t.rotate(.05*i.cameraYaw),t.globalCompositeOperation="lighter";for(const e of this.sparkBursts){const a=(e.hue+.2*this.scene.sectionSeed)%360,i=e.size*(.4+.5*s),r=Math.cos(e.angle),h=Math.sin(e.angle);t.globalAlpha=Math.max(0,Math.min(1,e.alpha)),t.strokeStyle=`hsla(${a}, 80%, ${50+30*s}%, ${e.airy?.4:.8})`,t.lineWidth=e.airy?1:1.6,t.beginPath(),t.moveTo(r*i*.3,h*i*.3),t.lineTo(r*i,h*i*(e.airy?1.4:1)),t.stroke()}t.restore(),t.globalCompositeOperation="source-over",t.globalAlpha=1}_renderOverlays(t,e,a){const s=this.scene.aberration;if(s>.02){const i=14*s;t.globalCompositeOperation="screen",t.globalAlpha=.18*s,t.fillStyle="rgba(160, 40, 255, 0.6)",t.fillRect(-i,0,e,a),t.fillStyle="rgba(40, 220, 255, 0.5)",t.fillRect(i,0,e,a),t.globalAlpha=1,t.globalCompositeOperation="source-over"}const i=.18+.4*this.palette.depth,r=t.createRadialGradient(e/2,a/2,.45*Math.min(e,a),e/2,a/2,.75*Math.max(e,a));if(r.addColorStop(0,"rgba(0,0,0,0)"),r.addColorStop(1,`rgba(0,0,0,${i})`),t.fillStyle=r,t.fillRect(0,0,e,a),this.renderState.entropy>.2){const s=.04+.08*this.renderState.entropy;t.globalAlpha=s,t.fillStyle="rgba(255,255,255,0.6)";for(let s=0;s<40;s++){const s=Math.random()*e,i=Math.random()*a,r=1+2*Math.random();t.fillRect(s,i,r,r)}t.globalAlpha=1}}onRender(){if(!this.metrics)return;const t=this.ctx,e=Math.max(1,Math.floor(this.width)),a=Math.max(1,Math.floor(this.height));t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e,a),this._renderBackground(t,e,a),this._renderLayers(t,e,a),this._renderShards(t,e,a),this._renderRibbons(t,e,a),this._renderOrbitals(t,e,a),this._renderWaveFronts(t,e,a),this._renderSparkBursts(t,e,a),this._renderOverlays(t,e,a)}}"undefined"!=typeof window&&(window.ChromaticOsmosisVisualizer=ChromaticOsmosisVisualizer);