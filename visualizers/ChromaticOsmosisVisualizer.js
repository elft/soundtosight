class ChromaticOsmosisVisualizer extends BaseVisualizer{constructor(t={}){super({name:"Chromatic Osmosis",...t}),this.baseCanvas=document.createElement("canvas"),this.baseCtx=this.baseCanvas.getContext("2d",{alpha:!1}),this.overlayCanvas=document.createElement("canvas"),this.overlayCtx=this.overlayCanvas.getContext("2d"),this.bufferCanvas=document.createElement("canvas"),this.bufferCtx=this.bufferCanvas.getContext("2d"),this._resizeInternalCanvases(),this.noiseSeed=1e3*Math.random(),this.noiseScale=.0016,this.blobs=this._initBlobs(5),this.filaments=this._initFilaments(32),this.motes=this._initMotes(140),this.ripples=[],this.gradientRamps=this._buildGradientRamps(),this.metrics=null}_resizeInternalCanvases(){const t=this.width,s=this.height;this.baseCanvas.width=t,this.baseCanvas.height=s,this.overlayCanvas.width=t,this.overlayCanvas.height=s,this.bufferCanvas.width=t,this.bufferCanvas.height=s}onResize(){this._resizeInternalCanvases()}_initBlobs(t){const s=[];for(let a=0;a<t;a++)s.push({x:Math.random(),y:Math.random(),r:.12+.18*Math.random(),hue:360*Math.random(),sat:60+30*Math.random(),a:.35+.2*Math.random(),vx:0,vy:0,wobble:Math.random()*Math.PI*2});return s}_initFilaments(t){const s=[];for(let a=0;a<t;a++)s.push({x:Math.random(),y:Math.random(),angle:Math.random()*Math.PI*2,life:.5+1.5*Math.random(),width:.5+2*Math.random(),hueOffset:60*Math.random()-30});return s}_initMotes(t){const s=[];for(let a=0;a<t;a++)s.push({x:Math.random(),y:Math.random(),vx:0,vy:0,size:.5+1.5*Math.random(),twinkle:Math.random()*Math.PI*2,hueOffset:90*Math.random()-45});return s}_buildGradientRamps(){return[[{h:330,s:75,l:52},{h:200,s:80,l:48}],[{h:40,s:90,l:55},{h:280,s:70,l:50}],[{h:120,s:70,l:50},{h:0,s:80,l:48}]]}_noise2D(t,s){const a=Math.sin(12.9898*(t+this.noiseSeed)+78.233*(s-this.noiseSeed)),e=Math.sin(4.123*(t-this.noiseSeed)+37.719*(s+this.noiseSeed));return.5*(Math.sin(43758.5453*a)+Math.sin(127.1*e))}_flowAt(t,s,a=.6){const e=this.noiseScale,i=this._noise2D(t/e,s/e)*Math.PI*2;return{x:Math.cos(i)*a,y:Math.sin(i)*a}}onUpdate(t){this.metrics=t;const{subBassEnergy:s=0,bassEnergy:a=0,lowMidEnergy:e=0,midEnergy:i=0,upperMidEnergy:h=0,presenceEnergy:n=0,trebleEnergy:o=0,brillianceEnergy:r=0,rms:l=0}=t||{},m=.2+.8*s,c=.1+.9*a,M=.02+.12*e,d=.4+.9*i,b=.05+.25*h,f=.2+1.2*o,x=.15+.85*r;for(const t of this.blobs){const s=this._flowAt(t.x+.02*c,t.y-.02*c,d);t.vx+=.002*s.x+.0015*Math.sin(t.wobble),t.vy+=.002*s.y+.0015*Math.cos(t.wobble),t.vx*=.96,t.vy*=.96,t.x=(t.x+t.vx+1)%1,t.y=(t.y+t.vy+1)%1,t.wobble+=.02+.05*a;const e=t.r*(.98+.04*m+.02*Math.sin(.5*t.wobble));t.r=Math.min(.5,Math.max(.06,e)),t.hue=(t.hue+2*b+10*l)%360,t.a=.28+.22*x}s>.55&&Math.random()<.2&&this.ripples.push({t:0,x:.5,y:.5,strength:.3+.3*m,width:.02+.05*a});for(const t of this.ripples)t.t+=.008+.04*M;this.ripples=this.ripples.filter(t=>t.t<1.2);for(const t of this.filaments){const s=this._flowAt(t.x+.01,t.y-.01,d+.2*i);t.x=(t.x+.004*s.x+8e-4*c+1)%1,t.y=(t.y+.004*s.y-8e-4*c+1)%1,t.angle+=.1*(s.x-s.y),t.life-=.005-.004*e,t.life<=0&&(t.x=Math.random(),t.y=Math.random(),t.life=.8+1.6*Math.random())}for(const t of this.motes){const s=this._flowAt(t.x,t.y,d+.5*b);t.vx=.9*t.vx+.002*s.x+(Math.random()-.5)*b*.002,t.vy=.9*t.vy+.002*s.y+(Math.random()-.5)*b*.002,t.x=(t.x+t.vx+1)%1,t.y=(t.y+t.vy+1)%1,t.twinkle+=.05+.15*f}}onRender(){if(!this.metrics)return;const t=this.baseCtx,s=Math.max(1,Math.floor(this.baseCanvas.width)),a=Math.max(1,Math.floor(this.baseCanvas.height));this.baseCtx.setTransform(1,0,0,1,0,0),t.clearRect(0,0,s,a),t.globalCompositeOperation="source-over";for(let e=0;e<this.blobs.length;e++){const i=this.blobs[e],h=i.x*s,n=i.y*a,o=Math.max(5,i.r*Math.min(s,a)*.22),r=this.gradientRamps[e%this.gradientRamps.length],l=isFinite(h)&&isFinite(n)&&isFinite(o)?t.createRadialGradient(h,n,.1*o,h,n,o):null;if(!l)continue;const m=(i.hue+r[0].h)%360,c=(i.hue+r[1].h)%360;l.addColorStop(0,`hsla(${m}, ${Math.max(0,Math.min(100,r[0].s))}%, ${Math.max(0,Math.min(100,r[0].l))}%, ${Math.max(0,Math.min(1,i.a))})`),l.addColorStop(1,`hsla(${c}, ${Math.max(0,Math.min(100,r[1].s))}%, ${Math.max(0,Math.min(100,r[1].l))}%, 0)`),t.globalCompositeOperation=0===e?"source-over":e%2?"lighter":"screen",t.fillStyle=l,t.beginPath();const M=48;t.moveTo(h+o,n);for(let s=0;s<=M;s++){const a=s/M*Math.PI*2,e=.85+.12*Math.sin(3*a+i.wobble),r=Math.cos(a)*o*e,l=Math.sin(a)*o*(1.05-.1*e);t.lineTo(h+r,n+l)}t.closePath(),t.fill()}this.bufferCtx.globalCompositeOperation="copy",this.bufferCtx.drawImage(this.baseCanvas,0,0);const e=.9+.6*(this.metrics?.lowMidEnergy||0),i=6*(this.metrics?.midEnergy||0);this.baseCtx.globalAlpha=.5,this.baseCtx.globalCompositeOperation="lighter",this.baseCtx.drawImage(this.bufferCanvas,Math.sin(i)*e,Math.cos(.9*i)*e),this.baseCtx.globalAlpha=1;const h=this.overlayCtx;h.setTransform(1,0,0,1,0,0),h.clearRect(0,0,s,a),h.globalCompositeOperation="lighter";for(const t of this.filaments){const e=t.x*s,i=t.y*a,n=this._flowAt(t.x,t.y,1+.5*(this.metrics?.midEnergy||0)),o=e+40*n.x,r=i+40*n.y,l=((this.blobs[0]?.hue||0)+t.hueOffset)%360,m=.15+.35*(this.metrics?.presenceEnergy||0);h.strokeStyle=`hsla(${l}, 80%, 60%, ${Math.max(0,Math.min(1,m))})`,h.lineWidth=Math.max(.2,Math.min(4,t.width*(.6+1.2*(this.metrics?.bassEnergy||0)))),h.beginPath(),h.moveTo(e,i),h.quadraticCurveTo(.5*(e+o)+20*Math.sin(t.angle),.5*(i+r)+20*Math.cos(t.angle),o,r),h.stroke()}for(const t of this.ripples){const e=Math.max(s,a)*t.t,i=Math.max(1,10*(t.width||1)),n=Math.max(0,.25*(1-t.t));h.lineWidth=i,h.strokeStyle=`hsla(${this.blobs[1]?.hue||0}, 70%, 65%, ${n})`,h.beginPath(),h.arc(s*t.x,a*t.y,e,0,2*Math.PI),h.stroke()}for(const t of this.motes){const e=t.x*s,i=t.y*a,n=.25+Math.abs(Math.sin(t.twinkle))*(.25+.5*(this.metrics?.trebleEnergy||0)),o=((this.blobs[2]?.hue||0)+t.hueOffset)%360;h.fillStyle=`hsla(${o}, 90%, 70%, ${Math.max(0,Math.min(1,n))})`;const r=Math.max(.5,Math.min(4,t.size*(.8+.8*(this.metrics?.presenceEnergy||0))));h.beginPath(),h.arc(e,i,r,0,2*Math.PI),h.fill()}this.ctx.globalCompositeOperation="source-over",this.ctx.drawImage(this.baseCanvas,0,0,s,a,0,0,s,a),this.ctx.drawImage(this.overlayCanvas,0,0,s,a,0,0,s,a)}}"undefined"!=typeof window&&(window.ChromaticOsmosisVisualizer=ChromaticOsmosisVisualizer);