class ChromaticOsmosisVisualizer extends BaseVisualizer{constructor(t={}){super({name:"Chromatic Osmosis",...t}),this.backdropCanvas=document.createElement("canvas"),this.backdropCtx=this.backdropCanvas.getContext("2d"),this._resizeBackdrop(),this.palette={baseHue:210,targetHue:210,accentHue:45,targetAccentHue:45,depth:.4},this.renderState={shimmer:0,sparkle:0,contour:0,rhythm:0,brilliance:0},this.layers=this._initLayers(5),this.ribbons=this._initRibbons(6),this.orbitals=this._initOrbitals(36),this.waveFronts=[],this.sceneTime=0,this.lowPassEnergy=0,this.metrics=null}_resizeBackdrop(){const t=Math.max(16,Math.round(.4*this.width)),e=Math.max(16,Math.round(.4*this.height));this.backdropCanvas.width=t,this.backdropCanvas.height=e}onResize(){this._resizeBackdrop()}_initLayers(t){const e=[];for(let a=0;a<t;a++)e.push({radius:.24+.08*a,targetRadius:.24+.08*a,angle:Math.random()*Math.PI*2,speed:.01+.01*Math.random(),thickness:.04,hueShift:a/t*140,alpha:.35,arcSpan:1.2+.6*Math.random(),pulse:Math.random()*Math.PI*2});return e}_initRibbons(t){const e=[];for(let a=0;a<t;a++)e.push({index:a,phase:Math.random()*Math.PI*2,radius:.3+.1*Math.random(),targetRadius:.3+.1*Math.random(),amplitude:.04+.02*Math.random(),targetAmplitude:.04,hueShift:90*(Math.random()-.5),thickness:.015,tilt:.6*(Math.random()-.5),bias:.6+.2*Math.random()});return e}_initOrbitals(t){const e=[];for(let a=0;a<t;a++)e.push({band:a%6,angle:Math.random()*Math.PI*2,radius:.22+a%6*.05,targetRadius:.22+a%6*.05,speed:.01+.02*Math.random(),size:2+1.5*Math.random(),hueShift:60*(Math.random()-.5),heightScale:.6+.2*Math.random(),shimmerPhase:Math.random()*Math.PI*2,seed:Math.random()*Math.PI*2});return e}_lerp(t,e,a){return t+(e-t)*a}_lerpAngle(t,e,a){return t+((e-t+540)%360-180)*a}_updateBackdrop(){const t=Math.max(16,Math.round(.4*this.width)),e=Math.max(16,Math.round(.4*this.height));this.backdropCanvas.width===t&&this.backdropCanvas.height===e||(this.backdropCanvas.width=t,this.backdropCanvas.height=e);const a=this.backdropCtx;a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,t,e);const s=a.createRadialGradient(t/2,e/2,.08*t,t/2,e/2,.75*Math.max(t,e));s.addColorStop(0,`hsla(${this.palette.accentHue}, 75%, 74%, ${.35+.35*this.palette.depth})`),s.addColorStop(1,`hsla(${(this.palette.baseHue+220)%360}, 50%, 12%, 0)`),a.fillStyle=s,a.fillRect(0,0,t,e);const h=a.createLinearGradient(0,0,t,e);h.addColorStop(0,`hsla(${(this.palette.baseHue+20)%360}, 55%, 28%, ${.4*this.palette.depth})`),h.addColorStop(1,`hsla(${(this.palette.accentHue+200)%360}, 50%, 18%, ${.1+.1*this.palette.depth})`),a.globalCompositeOperation="lighter",a.fillStyle=h,a.fillRect(0,0,t,e),a.globalCompositeOperation="source-over"}onUpdate(t){this.metrics=t;const{subBassEnergy:e=0,bassEnergy:a=0,lowMidEnergy:s=0,midEnergy:h=0,upperMidEnergy:i=0,presenceEnergy:r=0,trebleEnergy:o=0,brillianceEnergy:n=0,rms:l=0}=t||{};this.sceneTime+=.016*(1+1.3*h),this.lowPassEnergy=this._lerp(this.lowPassEnergy,l,.1);const d=.25+.9*e,p=.25+.8*a,c=.35+.9*h,m=.15+.9*o,u=.2+.9*r,M=.2+.8*n,g=(220+70*h-40*s+140*n)%360;this.palette.targetHue=g,this.palette.baseHue=this._lerpAngle(this.palette.baseHue,this.palette.targetHue,.05);const b=(this.palette.baseHue+120+80*r)%360;this.palette.targetAccentHue=b,this.palette.accentHue=this._lerpAngle(this.palette.accentHue,this.palette.targetAccentHue,.08),this.palette.depth=this._lerp(this.palette.depth,.35+.45*n,.05),this.renderState={shimmer:m,sparkle:u,contour:p,rhythm:d,brilliance:M};for(let t=0;t<this.layers.length;t++){const e=this.layers[t],a=d*(.6-.08*t)+.4*p+.3*s,h=.22+.13*t;e.targetRadius=h+.18*a,e.radius=this._lerp(e.radius,e.targetRadius,.08),e.angle+=e.speed*(1+.5*c)+.002*t,e.thickness=this._lerp(e.thickness,.03+.07*p,.12),e.alpha=this._lerp(e.alpha,Math.max(.12,.22+.45*u-.04*t),.12),e.arcSpan=this._lerp(e.arcSpan,1.2+2.2*s,.08),e.pulse+=.025+.06*d+.02*c}for(const t of this.ribbons)t.targetRadius=.32+.18*c+.03*t.index,t.radius=this._lerp(t.radius,t.targetRadius,.12),t.phase+=.01+.05*c+.03*m,t.targetAmplitude=.05+.12*p+.02*t.bias,t.amplitude=this._lerp(t.amplitude,t.targetAmplitude,.1),t.tilt=this._lerp(t.tilt,.9*(r-.5),.06),t.thickness=this._lerp(t.thickness,.012+.04*m,.08);for(const t of this.orbitals){const e=.6+.1*t.band;t.speed=.004+.035*u+.02*m,t.angle+=t.speed*e,t.targetRadius=.24+.09*t.band+.2*p,t.radius=this._lerp(t.radius,t.targetRadius,.08),t.heightScale=this._lerp(t.heightScale,.55+.045*t.band+.25*c,.05),t.size=this._lerp(t.size,1.4+.5*t.band+3.5*m,.2),t.shimmerPhase+=.12+.3*m+.25*M}e>.55&&l>.4&&this.waveFronts.push({progress:0,width:.018+.05*p,alpha:.4+.35*p,angle:Math.random()*Math.PI*2,spread:1+.9*r,hueShift:80*(Math.random()-.5)}),r>.7&&o>.5&&Math.random()<.12&&this.waveFronts.push({progress:0,width:.012+.04*m,alpha:.3+.3*u,angle:Math.random()*Math.PI*2,spread:.8+.7*u,hueShift:100*(Math.random()-.5)});for(const t of this.waveFronts)t.progress+=.012+.035*p,t.alpha*=.986-.015*m;this.waveFronts=this.waveFronts.filter(t=>t.alpha>.02)}_renderBackground(t,e,a){const s=t.createLinearGradient(0,0,e,a),h=Math.max(0,Math.min(100,35+28*this.palette.depth)),i=Math.max(0,Math.min(100,28+24*this.palette.depth)),r=Math.max(0,Math.min(100,16+18*this.palette.depth));s.addColorStop(0,`hsl(${this.palette.baseHue}, 58%, ${h}%)`),s.addColorStop(.65,`hsl(${(this.palette.baseHue+40)%360}, 52%, ${i}%)`),s.addColorStop(1,`hsl(${(this.palette.accentHue+200)%360}, 42%, ${r}%)`),t.fillStyle=s,t.fillRect(0,0,e,a),this._updateBackdrop(),t.globalCompositeOperation="lighter",t.globalAlpha=.85,t.drawImage(this.backdropCanvas,0,0,this.backdropCanvas.width,this.backdropCanvas.height,0,0,e,a),t.globalAlpha=1,t.globalCompositeOperation="source-over"}_renderLayers(t,e,a){const s=Math.min(e,a);for(const h of this.layers){const i=Math.max(10,h.radius*s*.5),r=Math.max(1,h.thickness*s*.08),o=Math.max(0,Math.min(1,h.alpha)),n=(this.palette.baseHue+h.hueShift+12*Math.sin(h.pulse))%360,l=Math.max(.4,Math.min(1.9*Math.PI,h.arcSpan));t.save(),t.translate(e/2,a/2),t.rotate(h.angle),t.strokeStyle=`hsla(${n}, 70%, 62%, ${o})`,t.lineWidth=r,t.shadowColor=`hsla(${n}, 75%, 55%, ${.6*o})`,t.shadowBlur=2.2*r,t.beginPath(),t.arc(0,0,i,-l/2,l/2),t.stroke(),t.beginPath(),t.arc(0,0,i,Math.PI-l/2,Math.PI+l/2),t.stroke(),t.restore()}t.shadowBlur=0,t.shadowColor="transparent"}_renderRibbons(t,e,a){const s=Math.min(e,a);t.globalCompositeOperation="screen";for(const h of this.ribbons){const i=Math.max(10,h.radius*s*.45),r=h.amplitude*s*.2,o=Math.max(1,h.thickness*s*.08),n=(this.palette.accentHue+h.hueShift)%360,l=48;t.save(),t.translate(e/2,a/2),t.rotate(h.tilt),t.beginPath();for(let e=0;e<=l;e++){const a=e/l*Math.PI*2,s=i+Math.sin(2*a+h.phase)*r,o=Math.cos(a)*s,n=Math.sin(a)*s*h.bias;0===e?t.moveTo(o,n):t.lineTo(o,n)}t.closePath(),t.strokeStyle=`hsla(${n}, 80%, 65%, 0.28)`,t.lineWidth=o,t.stroke(),t.restore()}t.globalCompositeOperation="source-over"}_renderOrbitals(t,e,a){const s=Math.min(e,a),{shimmer:h,sparkle:i}=this.renderState;t.save(),t.translate(e/2,a/2);for(const e of this.orbitals){const a=Math.max(12,e.radius*s*.4),r=Math.cos(e.angle+e.seed)*a,o=Math.sin(e.angle+e.seed)*a*e.heightScale,n=.35+Math.abs(Math.sin(e.shimmerPhase))*(.4+.6*h+.3*i),l=Math.max(0,Math.min(1,n)),d=(this.palette.accentHue+e.hueShift)%360,p=Math.max(1.5,e.size);t.fillStyle=`hsla(${d}, 75%, 70%, ${l})`,t.beginPath(),t.ellipse(r,o,p,.8*p,0,0,2*Math.PI),t.fill()}t.restore()}_renderWaveFronts(t,e,a){const s=Math.min(e,a);t.save(),t.translate(e/2,a/2),t.globalCompositeOperation="screen";for(const e of this.waveFronts){const a=e.progress*s*.6+.1*s,h=Math.max(1,e.width*s*.08),i=Math.max(0,Math.min(1,e.alpha)),r=(this.palette.baseHue+e.hueShift)%360,o=Math.max(.4,Math.min(2*Math.PI,e.spread));t.lineWidth=h,t.strokeStyle=`hsla(${r}, 80%, 68%, ${i})`,t.beginPath(),t.arc(0,0,a,e.angle-o/2,e.angle+o/2),t.stroke()}t.restore(),t.globalCompositeOperation="source-over"}onRender(){if(!this.metrics)return;const t=this.ctx,e=Math.max(1,Math.floor(this.width)),a=Math.max(1,Math.floor(this.height));t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e,a),this._renderBackground(t,e,a),this._renderLayers(t,e,a),this._renderRibbons(t,e,a),this._renderOrbitals(t,e,a),this._renderWaveFronts(t,e,a)}}"undefined"!=typeof window&&(window.ChromaticOsmosisVisualizer=ChromaticOsmosisVisualizer);