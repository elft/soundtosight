class StereoSkyriderVisualizer extends BaseVisualizer{constructor(t,e={}){super(t,{backgroundColor:"#05060d",force2d:!0,stereo:!0,smoothing:.8,...e})}async init(){this.time=0,this.lastUpdateTime=null,this.smoothed={speed:0,altitude:.5,bank:0,energy:0,shimmer:0,bassSurge:0},this.craft={x:.5*this.width,y:.55*this.height,heading:0,bankAngle:0,glidePhase:Math.random()*Math.PI*2,wobble:0},this.trail=[],this.maxTrail=140,this.sparkParticles=[],this.maxSparks=220,this.hazeLayers=this.createHazeLayers(3),this.starfield=this.createStarfield(90),this.channelEnergy={left:0,right:0}}onResize(){this.craft.x=.5*this.width,this.craft.y=.55*this.height,this.hazeLayers=this.createHazeLayers(3),this.starfield=this.createStarfield(this.starfield.length)}onUpdate(t={}){const e=Number.isFinite(t.time)?t.time:performance.now()/1e3,h=null==this.lastUpdateTime?1/60:Math.min(.12,Math.max(.001,e-this.lastUpdateTime));this.lastUpdateTime=e,this.time+=h;const i=this.clamp(t.rms||0,0,1),a=this.clamp(t.energy||0,0,1.2),s=this.clamp(t.bassEnergy||0,0,1.5),r=this.clamp(t.subBassEnergy||0,0,1.5),o=this.clamp(t.midEnergy||0,0,1.5),l=(this.clamp(t.upperMidEnergy||0,0,1.5),this.clamp(t.presenceEnergy||0,0,1.5)),n=this.clamp(t.brillianceEnergy||0,0,1.5),d=this.clamp(t.stereoBalance||0,-1,1),c=this.clamp(2*(t.rmsDifference||0),-1,1),g=this.extractChannelEnergy(t.frequencyLeft),m=this.extractChannelEnergy(t.frequencyRight);this.channelEnergy.left=this.lerp(this.channelEnergy.left,g,.18),this.channelEnergy.right=this.lerp(this.channelEnergy.right,m,.18);const f=this.channelEnergy.left-this.channelEnergy.right,p=this.clamp(.45*d+.25*c+.7*f,-1,1),y=this.map(o+.4*l+.2*i,0,2.5,.25,1.35);this.smoothed.speed=this.lerp(this.smoothed.speed,y,.12);const b=this.map(.6*r+.4*s+.2*a,0,2,.3,.85);this.smoothed.altitude=this.lerp(this.smoothed.altitude,b,.08);const u=this.map(p,-1,1,-.9,.9);this.smoothed.bank=this.lerp(this.smoothed.bank,u,.18),this.smoothed.energy=this.lerp(this.smoothed.energy,a,.1),this.smoothed.shimmer=this.lerp(this.smoothed.shimmer,n+.6*l,.2);const S=s>this.smoothed.bassSurge?s:.6*s;this.smoothed.bassSurge=this.lerp(this.smoothed.bassSurge,S,.12),this.craft.heading+=p*h*.75,this.craft.heading=this.clamp(this.craft.heading,-1.2,1.2),this.craft.bankAngle=this.lerp(this.craft.bankAngle,this.smoothed.bank,.15),this.craft.wobble=Math.sin(this.time*(1.2+.6*this.smoothed.speed))*(.15+.2*this.smoothed.energy);const M=this.map(this.smoothed.altitude,0,1,.7*this.height,.25*this.height),w=this.craft.heading*this.width*.22;this.craft.x=.5*this.width+w,this.craft.y=M+Math.sin(this.time*(.8+.3*this.smoothed.speed))*this.height*.02,this.updateTrail(h),this.updateSparks(h,n,l),this.updateStarfield(h),this.updateHaze(h)}updateTrail(t){for(this.trail.push({x:this.craft.x,y:this.craft.y,bank:this.craft.bankAngle,energy:this.smoothed.energy,life:1});this.trail.length>this.maxTrail;)this.trail.shift();const e=.8*t;this.trail.forEach(t=>{t.life=Math.max(0,t.life-e)})}updateSparks(t,e,h){const i=Math.abs(this.channelEnergy.left-this.channelEnergy.right),a=.8*(.6*e+.4*h+.2*this.smoothed.speed+Math.max(0,Math.abs(this.craft.bankAngle))+.6*i),s=Math.floor(6*a),r=.16*this.width,o=.02*this.height,l={x:this.craft.x-r*Math.cos(.6*this.craft.bankAngle),y:this.craft.y+o-r*Math.sin(.6*this.craft.bankAngle)},n={x:this.craft.x+r*Math.cos(.6*this.craft.bankAngle),y:this.craft.y+o+r*Math.sin(.6*this.craft.bankAngle)},d=Math.max(.01,this.channelEnergy.left+.2),c=d+Math.max(.01,this.channelEnergy.right+.2);for(let t=0;t<s&&!(this.sparkParticles.length>=this.maxSparks);t++){const t=Math.random()<d/c,e=t?l:n,h=t?-1:1;this.sparkParticles.push({x:e.x+(Math.random()-.5)*this.width*.02,y:e.y+(Math.random()-.5)*this.height*.01,vx:h*(.4+.6*Math.random())*(1+.8*Math.abs(this.craft.bankAngle)),vy:-this.smoothed.speed*(.5+.4*Math.random())-.2,size:1.5+2.5*Math.random(),hue:t?210+50*this.smoothed.bank+30*i:320+50*this.smoothed.bank-30*i,life:1,decay:.45+.3*Math.random()})}const g=.75*t;for(let e=this.sparkParticles.length-1;e>=0;e--){const h=this.sparkParticles[e];h.x+=h.vx*t*this.width*.4,h.y+=h.vy*t*this.height*.4,h.vx*=.96,h.vy+=.08*t*this.height*.01,h.life-=g*h.decay,(h.life<=0||h.y>this.height)&&this.sparkParticles.splice(e,1)}}updateStarfield(t){const e=.25+.6*this.smoothed.speed;this.starfield.forEach(h=>{h.z-=t*e*(.3+.7*h.speed);const i=this.craft.bankAngle*h.z*.4;h.x+=i*t,h.z<.1&&this.resetStar(h,!0)})}updateHaze(t){this.hazeLayers.forEach((e,h)=>{e.offset+=t*(.02+.06*this.smoothed.speed+.015*h),e.turbulence+=t*(.4+.2*h),e.offset>1&&(e.offset-=1)})}drawHaze(t){t.save(),t.globalCompositeOperation="lighter",this.hazeLayers.forEach(e=>{const h=.06+.1*this.smoothed.energy+.05*e.depth;t.globalAlpha=h;const i=t.createLinearGradient(0,this.height*e.startY,0,this.height*e.endY);i.addColorStop(0,"rgba(30, 60, 120, 0)"),i.addColorStop(.6,"rgba(40, 80, 160, 0.25)"),i.addColorStop(1,"rgba(15, 20, 45, 0)"),t.fillStyle=i,t.beginPath();const a=Math.sin(e.turbulence+e.seed)*this.height*.03;t.moveTo(0,this.height*e.startY+a),t.lineTo(this.width,this.height*e.startY-a),t.lineTo(this.width,this.height*e.endY),t.lineTo(0,this.height*e.endY),t.closePath(),t.fill()}),t.restore()}drawStarfield(t){t.save(),t.globalCompositeOperation="screen";const e=.5*this.width,h=.2*this.height;this.starfield.forEach(i=>{const a=Math.max(.12,i.z),s=this.map(a,.1,1.4,6,.6),r=e+i.x/a*this.width*.6,o=h+i.y/a*this.height*.3;if(r<-50||r>this.width+50||o<-50||o>this.height+20)return;const l=this.map(1/a,0,10,2,16)*(1+.4*this.smoothed.speed);t.globalAlpha=this.map(a,.1,1.3,.5,.1),t.strokeStyle="rgba(100, 150, 255, 0.9)",t.lineWidth=.3*s,t.beginPath(),t.moveTo(r,o),t.lineTo(r,o+l),t.stroke(),t.globalAlpha=this.map(a,.1,1.3,.9,.15),t.fillStyle="rgba(180, 220, 255, 0.8)",t.beginPath(),t.arc(r,o,.4*s,0,2*Math.PI),t.fill()}),t.restore()}onRender(){const t=this.ctx;t&&(t.fillStyle=`rgba(5, 6, 13, ${.16+.05*this.smoothed.energy})`,t.fillRect(0,0,this.width,this.height),this.drawBackground(t),this.drawHaze(t),this.drawStarfield(t),this.drawTrail(t),this.drawCraft(t),this.drawSparks(t),this.drawForegroundGlow(t))}drawBackground(t){const e=t.createLinearGradient(0,0,0,this.height);e.addColorStop(0,"rgba(8, 12, 25, 0.65)"),e.addColorStop(.45,"rgba(10, 16, 32, 0.55)"),e.addColorStop(.8,`rgba(5, 6, 14, ${.4+.1*this.smoothed.energy})`),e.addColorStop(1,"rgba(3, 4, 10, 0.9)"),t.fillStyle=e,t.fillRect(0,0,this.width,this.height);const h=.2*this.height,i=t.createLinearGradient(0,h-30,0,h+120);i.addColorStop(0,`rgba(40, 80, 160, ${.18+.1*this.smoothed.energy})`),i.addColorStop(1,"rgba(10, 15, 30, 0)"),t.fillStyle=i,t.fillRect(0,h-40,this.width,160)}drawTrail(t){if(!(this.trail.length<3)){t.save(),t.globalCompositeOperation="lighter",t.lineCap="round";for(let e=1;e<this.trail.length;e++){const h=this.trail[e-1],i=this.trail[e];if(h.life<=0&&i.life<=0)continue;const a=Math.min(h.life,i.life)*(.4+.3*this.smoothed.energy);t.globalAlpha=a;const s=this.map(e,0,this.trail.length,.02*this.width,.002*this.width);t.lineWidth=s;const r=40*(this.channelEnergy.left-this.channelEnergy.right),o=`hsla(${200+70*i.bank+20*this.smoothed.bassSurge+r}, 70%, ${50+12*this.smoothed.shimmer}%, 0.9)`;t.strokeStyle=o,t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(i.x,i.y),t.stroke()}t.restore()}}drawCraft(t){const{x:e,y:h,bankAngle:i}=this.craft,a=.08*this.width,s=.018*this.width,r=.22*this.width,o=.01*this.width,l=.07*this.width,n=40*i,d=50*i,c=20*i;t.save(),t.translate(e,h),t.rotate(.6*i);const g=t.createLinearGradient(.5*-a,0,.5*a,0),m=210+n,f=260+n;g.addColorStop(0,`hsla(${m}, 65%, 45%, 0.7)`),g.addColorStop(1,`hsla(${f}, 60%, 60%, 0.9)`),t.fillStyle=g,t.beginPath(),t.moveTo(.5*-a,.6*-s),t.quadraticCurveTo(.1*a,1.8*-s,.45*a,0),t.quadraticCurveTo(.1*a,1.8*s,.5*-a,.6*s),t.closePath(),t.fill();const p=t.createLinearGradient(0,0,.5*r,0),y=200+d,b=320+c;p.addColorStop(0,`hsla(${y}, 70%, 55%, 0.9)`),p.addColorStop(1,`hsla(${b}, 70%, 50%, 0.4)`),t.fillStyle=p,t.beginPath(),t.moveTo(0,0),t.lineTo(.5*r,o),t.lineTo(.32*r,.2*-o),t.quadraticCurveTo(.12*r,.8*-o,0,.4*-o),t.closePath(),t.fill(),t.save(),t.scale(-1,1),t.fillStyle=p,t.beginPath(),t.moveTo(0,0),t.lineTo(.5*r,o),t.lineTo(.32*r,.2*-o),t.quadraticCurveTo(.12*r,.8*-o,0,.4*-o),t.closePath(),t.fill(),t.restore();const u=t.createLinearGradient(0,0,-l,0);u.addColorStop(0,`hsla(${m}, 55%, 55%, 0.8)`),u.addColorStop(1,`hsla(${f}, 65%, 60%, 0.3)`),t.fillStyle=u,t.beginPath(),t.moveTo(.4*-a,0),t.lineTo(.75*-a,.25*l),t.lineTo(.75*-a,.25*-l),t.closePath(),t.fill(),t.restore()}drawSparks(t){this.sparkParticles.length&&(t.save(),t.globalCompositeOperation="screen",this.sparkParticles.forEach(e=>{const h=this.clamp(e.life,0,1);t.globalAlpha=h,t.fillStyle=`hsla(${e.hue}, 80%, ${55+35*h}%, ${.7+.3*h})`,t.beginPath(),t.ellipse(e.x,e.y,e.size*(1+1.2*(1-h)),.6*e.size,.08*e.vx,0,2*Math.PI),t.fill()}),t.restore())}drawForegroundGlow(t){const e=Math.min(1,.4+.6*this.smoothed.energy+.4*Math.abs(this.craft.bankAngle)),h=t.createRadialGradient(this.craft.x,this.craft.y,.03*this.width,this.craft.x,this.craft.y,.22*this.width);h.addColorStop(0,`rgba(190, 220, 255, ${.4+.35*e})`),h.addColorStop(1,"rgba(50, 80, 120, 0)"),t.fillStyle=h,t.globalAlpha=.6,t.beginPath(),t.arc(this.craft.x,this.craft.y,.24*this.width,0,2*Math.PI),t.fill(),t.globalAlpha=1}createHazeLayers(t){const e=[];for(let h=0;h<t;h++)e.push({startY:.35+.12*h,endY:.55+.16*h,depth:h/t,offset:Math.random(),turbulence:Math.random()*Math.PI*2,seed:Math.random()*Math.PI*2});return e}createStarfield(t){const e=[];for(let h=0;h<t;h++)e.push(this.newStar());return e}newStar(){return{x:2*(Math.random()-.5),y:Math.random(),z:1.3*Math.random()+.1,speed:Math.random()}}resetStar(t,e=!1){t.x=2*(Math.random()-.5),t.y=Math.random(),t.z=e?.5*Math.random()+.8:1.3*Math.random()+.4,t.speed=Math.random()}extractChannelEnergy(t){if(!t||!t.length)return 0;let e=0;const h=Math.max(1,Math.floor(t.length/64));for(let i=0;i<t.length;i+=h){const h=t[i];Number.isFinite(h)&&(e+=h)}const i=e/(t.length/h);return this.clamp(i/255,0,1.5)}clamp(t,e,h){return Math.min(Math.max(t,e),h)}lerp(t,e,h){return t+(e-t)*h}map(t,e,h,i,a){return h===e?i:i+(t-e)/(h-e)*(a-i)}}"undefined"!=typeof window&&(window.StereoSkyriderVisualizer=StereoSkyriderVisualizer);