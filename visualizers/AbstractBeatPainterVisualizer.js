class AbstractBeatPainterVisualizer extends BaseVisualizer{async init(){this.paint=this.createOverlay("abp-paint",1),this.fx=this.createOverlay("abp-fx",2),this.t=0,this.seed=1e6*Math.random(),this.maxStrokes=280,this.strokes=[],this.splatters=[],this.baseHue=200,this.paletteShift=0,this.fadeEveryNFrames=2,this.frameCount=0;for(let t=0;t<32;t++)this._spawnStroke(Math.random(),{seedOnly:!0});this.start(),this.backgroundIsWhite=!1,this.lastBackgroundFlip=0}onResize(){}onUpdate(t){this.t+=1/60,this.baseHue=this._map(t.spectralCentroidNormalized,0,1,30,220);const s=this._clamp(t.aWeighted?.mono?.normalized??t.energy,0,1);if(this.paletteShift=this._lerp(this.paletteShift,40*(t.presenceEnergy+t.trebleEnergy),.08),t.isBeat){const e=this._clamp(3*t.energyChangeIntensity+.8*t.bassEnergy+.6*s,.2,3),a=Math.floor(8+18*e);for(let s=0;s<a;s++)this._spawnStroke(e,{stereo:t.stereoBalance});this._spawnSplatters(Math.floor(3+6*e))}const e=performance.now();if(e-this.lastBackgroundFlip>600&&(t.isMassiveEnergyChange||t.energyChangeIntensity>.55)){this.backgroundIsWhite=!this.backgroundIsWhite,this.lastBackgroundFlip=e;const t=this.backgroundIsWhite?"#ffffff":"#000000";this.paint.canvas.style.transition="background-color 0.3s ease-out",this.fx.canvas.style.transition="background-color 0.3s ease-out",this.paint.canvas.style.backgroundColor=t,this.fx.canvas.style.backgroundColor="transparent"}const a=this._clamp(.25*(t.midEnergy+t.lowMidEnergy)+.02,0,.12);Math.random()<a&&this._spawnStroke(.35,{drift:!0,stereo:t.stereoBalance});for(let e=this.strokes.length-1;e>=0;e--){const a=this.strokes[e],i=Math.sin(this.t*a.wFreq+a.phase)*a.wAmp,h=2.2*(t.subBassEnergy+t.bassEnergy);a.thickness=this._clamp(a.baseThickness*(1+h*a.bassBias),.4,a.maxThickness);const r=1+1.6*(t.presenceEnergy+t.trebleEnergy+t.brillianceEnergy);a.vx+=Math.cos(a.dir+i)*a.accel*.3,a.vy+=Math.sin(a.dir+i)*a.accel*.3,a.vx*=.96,a.vy*=.96,a.x+=a.vx*r,a.y+=a.vy*r;const n=this._map(s,0,1,.012,.002);a.vx+=(.5*this.width-a.x)*n*a.centerBias,a.vy+=(.5*this.height-a.y)*n*a.centerBias,a.life++,a.dir+=a.curl,a.opacity*=.996-a.life/a.lifespan*.0015,(a.life>a.lifespan||a.opacity<.05||a.x<-80||a.x>this.width+80||a.y<-80||a.y>this.height+80)&&this.strokes.splice(e,1)}for(let t=this.splatters.length-1;t>=0;t--){const s=this.splatters[t];s.age++,s.alpha*=.97,(s.age>s.life||s.alpha<.02)&&this.splatters.splice(t,1)}}onRender(){if(this.frameCount++,this.frameCount%this.fadeEveryNFrames===0){const t=this.paint.ctx;t.save(),t.globalCompositeOperation="source-over",t.fillStyle="rgba(5, 5, 5, 0.02)",t.fillRect(0,0,this.width,this.height),t.restore()}this._renderStrokes(this.paint.ctx);const t=this.fx.ctx;t.clearRect(0,0,this.width,this.height),this._renderSplatters(t)}_spawnStroke(t=1,s={}){this.strokes.length>=this.maxStrokes&&this.strokes.shift();const e=.5*this.width,a=.5*this.height,i=this._rand(6,.08*Math.max(this.width,this.height))*(s.drift?1.4:1),h=Math.random()*Math.PI*2,r=e+Math.cos(h)*i+(s.stereo||0)*this.width*.12,n=a+Math.sin(h)*i,o=h+this._rand(-.9,.9),l=this._rand(.4,1.6)*(1+.4*t),d=(this.baseHue+this.paletteShift+this._rand(-22,22))%360,c=72+Math.min(22,18*t+this._rand(-6,10)),p=46+this._rand(-6,8),y=this._rand(1.2,4)*(1+.8*t),f=y*this._rand(1.2,2.8),g=Math.floor(60+60*t+80*Math.random());this.strokes.push({x:r,y:n,vx:Math.cos(o)*this._rand(.6,1.8),vy:Math.sin(o)*this._rand(.6,1.8),dir:o,curl:this._rand(-.02,.02)*(s.drift?.5:1),wFreq:this._rand(.6,2.2),wAmp:this._rand(.04,.18),phase:Math.random()*Math.PI*2,hue:d,sat:c,lit:p,baseThickness:y,maxThickness:f,thickness:y,opacity:this._clamp(.65+.25*t,.1,.95),lifespan:g,life:0,accel:l,bassBias:.9*Math.random()+.3,centerBias:.7*Math.random()+.2})}_renderStrokes(t){t.save(),t.globalCompositeOperation="hard-light";for(const s of this.strokes){const e=(s.hue+20*Math.random()-10+360)%360,a=Math.min(100,s.sat+40),i=Math.min(70,s.lit+20),h=(e+30)%360,r=i-10,n=this._clamp(1.5*s.opacity,.3,1),o=t.createLinearGradient(s.x-10*s.vx,s.y-10*s.vy,s.x+10*s.vx,s.y+10*s.vy);o.addColorStop(0,`hsl(${e}, ${a}%, ${i}%)`),o.addColorStop(1,`hsl(${h}, ${a-20}%, ${r}%)`),t.strokeStyle=o,t.globalAlpha=n,t.lineWidth=1.5*s.thickness,t.lineCap="round",t.lineJoin="round",t.beginPath(),t.moveTo(s.x-2*s.vx,s.y-2*s.vy),t.lineTo(s.x+3*s.vx,s.y+3*s.vy),t.stroke(),t.globalAlpha=.6*n,t.fillStyle=`hsl(${e}, ${a}%, ${i-10}%)`,t.beginPath(),t.ellipse(s.x,s.y,2.4*s.thickness,1.1*s.thickness,s.dir,0,2*Math.PI),t.fill()}t.restore()}_spawnSplatters(t=6){for(let s=0;s<t;s++){const t=Math.random()*Math.PI*2,s=this._rand(0,.28*Math.min(this.width,this.height)),e=.5*this.width+Math.cos(t)*s,a=.5*this.height+Math.sin(t)*s,i=(this.baseHue+this._rand(-28,28))%360;this.splatters.push({x:e+this._rand(-12,12),y:a+this._rand(-12,12),r:this._rand(2,18),hue:i,alpha:this._rand(.35,.85),age:0,life:Math.floor(this._rand(14,34))})}}_renderSplatters(t){t.save(),t.globalCompositeOperation="lighter";for(const s of this.splatters){const e=t.createRadialGradient(s.x,s.y,0,s.x,s.y,2.2*s.r);e.addColorStop(0,`hsla(${s.hue}, 88%, 70%, ${s.alpha})`),e.addColorStop(1,`hsla(${s.hue}, 88%, 70%, 0)`),t.fillStyle=e,t.beginPath(),t.arc(s.x,s.y,s.r,0,2*Math.PI),t.fill()}t.restore()}_rand(t,s){return t+Math.random()*(s-t)}_map(t,s,e,a,i){return s===e?a:a+(t-s)*(i-a)/(e-s)}_clamp(t,s=0,e=1){return Math.max(s,Math.min(e,t))}_lerp(t,s,e){return t+(s-t)*e}destroy(){this.strokes=[],this.splatters=[],super.destroy()}}"undefined"!=typeof window&&(window.AbstractBeatPainterVisualizer=AbstractBeatPainterVisualizer);