class AbstractBeatPainterVisualizer extends BaseVisualizer{async init(){this.paint=this.createOverlay("abp-paint",1),this.fx=this.createOverlay("abp-fx",2),this.t=0,this.seed=1e6*Math.random();const t=!("undefined"==typeof window||!window.matchMedia)&&window.matchMedia("(pointer: coarse)").matches,s="undefined"!=typeof window&&window.innerWidth<820;this.isMobileLike=!(!t&&!s),this.maxStrokes=135,this.strokes=[],this.splatters=[],this.baseHue=200,this.paletteShift=0,this.fadeEveryNFrames=this.isMobileLike?3:2,this.frameCount=0,this.strokeGradientInterval=this.isMobileLike?3:2;for(let t=0;t<32;t++)this._spawnStroke(Math.random(),{seedOnly:!0});this.start(),this.backgroundIsWhite=!1,this.lastBackgroundFlip=0}onResize(){}onUpdate(t){this.t+=1/60,this.baseHue=this._map(t.spectralCentroidNormalized,0,1,30,220);const s=this._clamp(t.aWeighted?.mono?.normalized??t.energy,0,1);if(this.paletteShift=this._lerp(this.paletteShift,40*(t.presenceEnergy+t.trebleEnergy),.08),t.isBeat){const i=this._clamp(3*t.energyChangeIntensity+.8*t.bassEnergy+.6*s,.2,3),e=Math.floor(8+18*i);for(let s=0;s<e;s++)this._spawnStroke(i,{stereo:t.stereoBalance});this._spawnSplatters(Math.floor(3+6*i))}const i=performance.now();if(i-this.lastBackgroundFlip>600&&(t.isMassiveEnergyChange||t.energyChangeIntensity>.55)){this.backgroundIsWhite=!this.backgroundIsWhite,this.lastBackgroundFlip=i;const t=this.backgroundIsWhite?"#ffffff":"#000000";this.paint.canvas.style.transition="background-color 0.3s ease-out",this.fx.canvas.style.transition="background-color 0.3s ease-out",this.paint.canvas.style.backgroundColor=t,this.fx.canvas.style.backgroundColor="transparent"}const e=this._clamp(.25*(t.midEnergy+t.lowMidEnergy)+.02,0,.12);Math.random()<e&&this._spawnStroke(.35,{drift:!0,stereo:t.stereoBalance});const a=this.strokes,h=.5*this.width,r=.5*this.height;for(let i=a.length-1;i>=0;i--){const e=a[i],n=Math.sin(this.t*e.wFreq+e.phase)*e.wAmp,o=2.2*(t.subBassEnergy+t.bassEnergy);e.thickness=this._clamp(e.baseThickness*(1+o*e.bassBias),.4,e.maxThickness);const l=1+1.6*(t.presenceEnergy+t.trebleEnergy+t.brillianceEnergy);e.vx+=Math.cos(e.dir+n)*e.accel*.3,e.vy+=Math.sin(e.dir+n)*e.accel*.3,e.vx*=.96,e.vy*=.96,e.x+=e.vx*l,e.y+=e.vy*l;const d=this._map(s,0,1,.012,.002);e.vx+=(h-e.x)*d*e.centerBias,e.vy+=(r-e.y)*d*e.centerBias,e.life++,e.dir+=e.curl,e.opacity*=.996-e.life/e.lifespan*.0015,(e.life>e.lifespan||e.opacity<.05||e.x<-80||e.x>this.width+80||e.y<-80||e.y>this.height+80)&&this.strokes.splice(i,1)}for(let t=this.splatters.length-1;t>=0;t--){const s=this.splatters[t];s.age++,s.alpha*=.97,(s.age>s.life||s.alpha<.02)&&this.splatters.splice(t,1)}}onRender(){if(this.frameCount++,this.frameCount%this.fadeEveryNFrames===0){const t=this.paint.ctx;t.save(),t.globalCompositeOperation="source-over",t.fillStyle="rgba(5, 5, 5, 0.02)",t.fillRect(0,0,this.width,this.height),t.restore()}this._renderStrokes(this.paint.ctx);const t=this.fx.ctx;t.clearRect(0,0,this.width,this.height),this._renderSplatters(t)}_spawnStroke(t=1,s={}){this.strokes.length>=this.maxStrokes&&this.strokes.shift();const i=.5*this.width,e=.5*this.height,a=this._rand(6,.08*Math.max(this.width,this.height))*(s.drift?1.4:1),h=Math.random()*Math.PI*2,r=i+Math.cos(h)*a+(s.stereo||0)*this.width*.12,n=e+Math.sin(h)*a,o=h+this._rand(-.9,.9),l=this._rand(.4,1.6)*(1+.4*t),d=(this.baseHue+this.paletteShift+this._rand(-22,22))%360,c=72+Math.min(22,18*t+this._rand(-6,10)),p=46+this._rand(-6,8),f=this._rand(1.2,4)*(1+.8*t),g=f*this._rand(1.2,2.8),y=Math.floor(60+60*t+80*Math.random()),m=this._rand(-12,12),u=this._rand(22,42),k=this._rand(16,32),_=this._rand(6,16),M=this._rand(8,18),b=this._rand(-12,-6);this.strokes.push({x:r,y:n,vx:Math.cos(o)*this._rand(.6,1.8),vy:Math.sin(o)*this._rand(.6,1.8),dir:o,curl:this._rand(-.02,.02)*(s.drift?.5:1),wFreq:this._rand(.6,2.2),wAmp:this._rand(.04,.18),phase:Math.random()*Math.PI*2,hue:d,sat:c,lit:p,baseThickness:f,maxThickness:g,thickness:f,opacity:this._clamp(.65+.25*t,.1,.95),lifespan:y,life:0,accel:l,bassBias:.9*Math.random()+.3,centerBias:.7*Math.random()+.2,hueJitter:m,highlightHueShift:u,saturationBoost:k,lightnessBoost:_,shadowLift:M,fillColor:`hsl(${(d+m+360)%360}, ${Math.min(100,c+k)}%, ${Math.max(0,p+b)}%)`,gradTick:0,gradUpdateEvery:this.strokeGradientInterval+Math.floor(this._rand(0,2)),strokeGrad:null})}_renderStrokes(t){t.save(),t.globalCompositeOperation="hard-light",t.lineCap="round",t.lineJoin="round";for(const s of this.strokes){const i=(s.hue+s.hueJitter+360)%360,e=Math.min(100,s.sat+s.saturationBoost),a=Math.min(70,s.lit+s.lightnessBoost),h=(i+s.highlightHueShift)%360,r=Math.max(0,a-s.shadowLift);let n=s.strokeGrad;if(!n||s.gradTick++>=s.gradUpdateEvery){s.gradTick=0;const o=s.x-10*s.vx,l=s.y-10*s.vy,d=s.x+10*s.vx,c=s.y+10*s.vy;Number.isFinite(o)&&Number.isFinite(l)&&Number.isFinite(d)&&Number.isFinite(c)?(n=t.createLinearGradient(o,l,d,c),n.addColorStop(0,`hsl(${i}, ${e}%, ${a}%)`),n.addColorStop(1,`hsl(${h}, ${Math.max(0,e-20)}%, ${r}%)`),s.strokeGrad=n):(s.strokeGrad=null,n=null)}const o=this._clamp(1.35*s.opacity,.26,.9);t.strokeStyle=n||`hsl(${i}, ${e}%, ${a}%)`,t.globalAlpha=o,t.lineWidth=1.5*s.thickness,t.beginPath(),t.moveTo(s.x-2*s.vx,s.y-2*s.vy),t.lineTo(s.x+3*s.vx,s.y+3*s.vy),t.stroke(),t.globalAlpha=.6*o,t.fillStyle=s.fillColor,t.beginPath(),t.ellipse(s.x,s.y,2.4*s.thickness,1.1*s.thickness,s.dir,0,2*Math.PI),t.fill()}t.restore()}_spawnSplatters(t=6){for(let s=0;s<t;s++){const t=Math.random()*Math.PI*2,s=this._rand(0,.28*Math.min(this.width,this.height)),i=.5*this.width+Math.cos(t)*s,e=.5*this.height+Math.sin(t)*s,a=(this.baseHue+this._rand(-28,28))%360;this.splatters.push({x:i+this._rand(-12,12),y:e+this._rand(-12,12),r:this._rand(2,18),hue:a,alpha:this._rand(.35,.85),age:0,life:Math.floor(this._rand(14,34))})}}_renderSplatters(t){t.save(),t.globalCompositeOperation="lighter";for(const s of this.splatters){const i=t.createRadialGradient(s.x,s.y,0,s.x,s.y,2.2*s.r);i.addColorStop(0,`hsla(${s.hue}, 88%, 70%, ${s.alpha})`),i.addColorStop(1,`hsla(${s.hue}, 88%, 70%, 0)`),t.fillStyle=i,t.beginPath(),t.arc(s.x,s.y,s.r,0,2*Math.PI),t.fill()}t.restore()}_rand(t,s){return t+Math.random()*(s-t)}_map(t,s,i,e,a){return s===i?e:e+(t-s)*(a-e)/(i-s)}_clamp(t,s=0,i=1){return Math.max(s,Math.min(i,t))}_lerp(t,s,i){return t+(s-t)*i}destroy(){this.strokes=[],this.splatters=[],super.destroy()}}"undefined"!=typeof window&&(window.AbstractBeatPainterVisualizer=AbstractBeatPainterVisualizer);