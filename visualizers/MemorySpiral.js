class MemorySpiralVisualizer extends BaseVisualizer{async init(){this.centerX=this.width/2,this.centerY=this.height/2,this.baseRadius=.06*Math.min(this.width,this.height),this.maxRadius=.48*Math.min(this.width,this.height),this.spiralArms=3,this.spiralTightness=1.6,this.spiralPoints=240,this.auras=[],this.maxAuras=40,this.motes=[],this.maxMotes=160,this.rings=[],this.maxRings=8,this._lastDb=-1/0,this._smoothedRms=0,this._smoothedBass=0,this._smoothedMid=0,this._smoothedHighs=0,this.smoothFactor=.08,this._loudnessNorm=0,this._percussiveEnergy=0,this._intenseEnergy=0,this._intensePulse=0,this.trailAlpha=.14,this.globalRotation=0,this.colorBase=200}onResize(){this.centerX=this.width/2,this.centerY=this.height/2,this.baseRadius=.06*Math.min(this.width,this.height),this.maxRadius=.48*Math.min(this.width,this.height)}onUpdate(s){if(!s)return;this.currentAudioData=s;const t=s.rms??0,i=s.bassEnergy??0,h=s.midEnergy??0,a=s.trebleEnergy??s.highs??0,e=s.spectralFlux??0,o=s.centroid??0,n=!!s.isBeat,r=s.time??performance.now()/1e3,l="number"==typeof s.loudnessShortDb?s.loudnessShortDb:s.aWeighted?.mono?.db??-60,d=this.dbTo01(l),m=this.constrain(s.percussiveEnergy??s.percussiveRatio??0,0,1),u=s.crestTime??1,p=s.fluxByBand;let c=this.constrain(e,0,1);if(p&&p.length>=8){const s=(p[0]??0)+(p[1]??0),t=(p[4]??0)+(p[5]??0),i=(p[6]??0)+(p[7]??0);c=this.constrain(.45*s+.35*t+.2*i,0,1.2)}this._loudnessNorm=this.lerp(this._loudnessNorm,d,.18),this._percussiveEnergy=this.lerp(this._percussiveEnergy,m,.18);const M=this.constrain(this.map(this.constrain(u,1,9),1,9,0,.32),0,.32),g=this.constrain(.55*this._loudnessNorm+.35*this._percussiveEnergy+.38*c+M,0,1.4),_=this.constrain(g,0,1),b=_>this._intenseEnergy?.32:.12;this._intenseEnergy=this.lerp(this._intenseEnergy,_,b),this._intensePulse=Math.max(.88*this._intensePulse,_>.82?_:0),this._smoothedRms=this.lerp(this._smoothedRms,t,this.smoothFactor),this._smoothedBass=this.lerp(this._smoothedBass,i,this.smoothFactor),this._smoothedMid=this.lerp(this._smoothedMid,h,this.smoothFactor),this._smoothedHighs=this.lerp(this._smoothedHighs,a,this.smoothFactor);const R=1+1.8*this._smoothedBass,f=1+2.6*this._smoothedMid;this.spiralArms=2+Math.round(this.map(this._smoothedMid,0,1,1,6)),this.spiralTightness=1.2+.9*f,this.spiralRadiusBase=this.baseRadius*R;const x=this.map(e+.8*a+(n?.6:0),0,2,0,1);if(Math.random()<x&&this.motes.length<this.maxMotes){const s=1+Math.floor(this.map(e,0,1,0,6));for(let t=0;t<s;t++)this._spawnMote(o,r)}const y=s.aWeighted?.mono?.db??this._lastDb,P=Math.max(0,(y===-1/0?-1/0:y)-(this._lastDb===-1/0?y:this._lastDb));this._lastDb=y,(P>.6||this._smoothedBass>.6||n)&&this.rings.length<this.maxRings&&this._spawnRing(o,this._smoothedBass,this._smoothedRms,this._intenseEnergy);const $=1+2.4*this._intenseEnergy+1.6*this._smoothedBass;for(let s=this.rings.length-1;s>=0;s--){const t=this.rings[s];t.age+=$;const i=this.constrain(t.age/t.lifespan,0,1),h=this.smoothstep(0,1,i);t.radius=t.startRadius+(t.maxRadius-t.startRadius)*h,t.thickness=t.baseThickness*(1-.55*h)+t.baseThickness*(.3+.9*this._intensePulse)*(1-h),t.alpha=t.initAlpha*Math.pow(1-h,.6),t.alpha<.02&&i>=1&&this.rings.splice(s,1)}for(let s=this.motes.length-1;s>=0;s--){const t=this.motes[s];t.t+=.002+.006*(.2+this._smoothedHighs+.6*e)*(1+.2*t.seed),t.radial+=.1*Math.sin(3*r+5*t.seed)*this._smoothedMid,t.radius=t.baseRadius+t.t*t.speed*(1+4*this._smoothedBass)+t.radial,t.alpha*=.995,(t.t>1.6||t.alpha<.02)&&this.motes.splice(s,1)}for(;this.auras.length<this.maxAuras;)this._spawnAura(this.auras.length);const S=Math.pow(this._intenseEnergy,1.35),B=this._intensePulse;for(let s=0;s<this.auras.length;s++){const t=this.auras[s],i=1+2.4*this._smoothedRms+4*e+1.4*S;t.angle+=t.baseSpeed*i;const h=this._smoothedBass*(1+.5*Math.sin(1.5*r+t.seed));let a=0;for(let i=0;i<Math.min(8,this.motes.length);i++){const h=this.motes[(s+i)%this.motes.length],e=Math.cos(t.angle)*t.orbit-(Math.cos(h.angle)*h.radius||0),o=Math.sin(t.angle)*t.orbit-(Math.sin(h.angle)*h.radius||0),n=Math.sqrt(e*e+o*o);a+=this.constrain(1/(1+.02*n),0,.12)}const n=t.baseOrbit*(1+1.4*h)+t.baseOrbit*a*2,l=this.baseRadius*(.35+.4*this._smoothedBass+.25*B),d=this.lerp(n,l,S);t.orbit=this.lerp(t.orbit,d,.08+.3*S+.1*B);const m=.3+.25*Math.sin(.7*t.angle+.6*r+t.seed);t.z=this.lerp(t.z,m-.4*S,.12+.2*S),t.hue=this._centroidToHue(o)+16*Math.sin(t.seed+.3*r),t.size=this.constrain(t.baseSize*(1+1.4*this._smoothedRms+.08*Math.sin(2*t.angle+3*r))*(1-.35*S),1.2,34),t.alpha=this.constrain(.35+.65*this._smoothedRms+.55*this._smoothedBass+.3*B,.1,1)}this.globalRotation+=8e-4+.02*this._smoothedBass+.006*this._smoothedMid}onRender(){const s=this.ctx;if(s){s.save(),s.fillStyle=`rgba(0,0,0,${this.trailAlpha})`,s.globalCompositeOperation="source-over",s.fillRect(0,0,this.width,this.height),s.restore(),s.save(),s.translate(this.centerX,this.centerY),s.rotate(this.globalRotation),s.globalCompositeOperation="lighter",this._renderSpiral(s);for(let s=0;s<this.rings.length;s++)this._renderRing(this.rings[s]);for(let s=0;s<this.motes.length;s++)this._renderMote(this.motes[s]);for(let s=0;s<this.auras.length;s++)this._renderAura(this.auras[s]);if(s.restore(),this.config.debug&&this.currentAudioData){const t=[`RMS:${this._smoothedRms.toFixed(3)}`,`Bass:${this._smoothedBass.toFixed(3)}`,`Mid:${this._smoothedMid.toFixed(3)}`,`Highs:${this._smoothedHighs.toFixed(3)}`,`Motes:${this.motes.length}`,`Auras:${this.auras.length}`].join("  ");s.save(),s.fillStyle="rgba(255,255,255,0.85)",s.font="12px monospace",s.fillText(t,12,20),s.restore()}}}_renderSpiral(s){const t=Math.max(1,this.spiralArms),i=this.spiralPoints,h=this.colorBase,a=this._smoothedBass,e=this._smoothedMid,o=this._smoothedHighs;for(let n=0;n<3;n++){const r=this.map(n,0,2,.18,.04),l=this.map(n,0,2,2.6,.6),d=1+.12*n;for(let m=0;m<t;m++){s.beginPath();const u=Math.round(h+m/Math.max(1,t)*40-12*n);for(let h=0;h<=i;h++){const r=h/i,l=this.spiralRadiusBase*(1+r*this.map(a,0,1,1.2,5))*d,u=this.spiralTightness*(1+2.2*e),p=l*(1+6*r)+Math.sin(r*Math.PI*8+.9*m+.3*n)*(.6+1.8*o)*(1-r)*6,c=m*(2*Math.PI/t)+r*Math.PI*6*u+.06*n;let M=0;for(let s=0;s<Math.min(8,this.motes.length);s++){const t=this.motes[(h+s)%Math.max(1,this.motes.length)],i=Math.abs((c-(t.angle||0)+Math.PI)%(2*Math.PI)-Math.PI),a=Math.abs(p-(t.radius||0));M+=this.constrain(.02/(1+10*i+.02*a),0,1)}const g=p*(1+2*M),_=Math.cos(c)*g,b=Math.sin(c)*g;0===h?s.moveTo(_,b):s.lineTo(_,b)}s.strokeStyle=`hsla(${u}, 85%, ${40+8*n}%, ${r})`,s.lineWidth=l,s.lineCap="round",s.lineJoin="round",s.stroke()}}}_spawnMote(s=2e3,t=performance.now()/1e3){const i=Math.random(),h=Math.floor(Math.random()*Math.max(1,this.spiralArms)),a=.12*Math.random(),e=this.map(Math.random(),0,1,.6,2.6),o=this.spiralRadiusBase*(.6+.6*Math.random()),n=this._centroidToHue(s)+28*Math.random()-14,r={seed:i,arm:h,t:a,speed:e,baseRadius:o,radial:0,radius:o,alpha:1,size:2.2*Math.random()+.6,hue:n,angle:0};r.angle=h*(2*Math.PI/Math.max(1,this.spiralArms)),this.motes.push(r)}_renderMote(s){const t=this.ctx,i=s.t,h=s.arm,a=this.spiralTightness*(1+2.2*this._smoothedMid),e=s.baseRadius*(1+6*i)*(1+.9*this._smoothedBass)+Math.sin(i*Math.PI*8+.9*h+7*s.seed)*(.6+1.8*this._smoothedHighs)*(1-i)*6+s.radial,o=h*(2*Math.PI/Math.max(1,this.spiralArms))+i*Math.PI*6*a+.2*s.seed;s.angle=o,s.radius=e;const n=Math.cos(o)*e,r=Math.sin(o)*e,l=t.createRadialGradient(n,r,0,n,r,10*s.size);l.addColorStop(0,`hsla(${Math.round(s.hue)}, 100%, 85%, ${s.alpha})`),l.addColorStop(.25,`hsla(${Math.round(s.hue)}, 90%, 65%, ${.45*s.alpha})`),l.addColorStop(1,`hsla(${Math.round(s.hue)}, 80%, 45%, 0)`),t.fillStyle=l,t.beginPath(),t.arc(n,r,3.2*s.size,0,2*Math.PI),t.fill(),t.fillStyle=`hsla(${Math.round(s.hue)}, 100%, 92%, ${s.alpha})`,t.beginPath(),t.arc(n,r,Math.max(.6,.6*s.size),0,2*Math.PI),t.fill()}_spawnAura(s){const t=Math.random()*Math.PI*2,i=this.map(Math.random(),0,1,.9*this.baseRadius,.6*this.maxRadius),h=this.map(Math.random(),0,1,3,18),a=this.map(Math.random(),0,1,.002,.012),e={seed:t,angle:s/Math.max(1,this.maxAuras)*Math.PI*2+.2*Math.random(),baseOrbit:i,orbit:i,baseSize:h,size:h,baseSpeed:a,hue:this.colorBase+60*Math.random()-30,alpha:.9,z:.5};this.auras.push(e)}_renderAura(s){const t=this.ctx,i=1+.8*(s.z-.5),h=Math.cos(s.angle)*s.orbit,a=Math.sin(s.angle)*s.orbit*(1-.12*s.z),e=s.size*i,o=Math.round(this.constrain(s.hue,0,360)),n=t.createRadialGradient(h,a,0,h,a,4*e);n.addColorStop(0,`hsla(${o}, 100%, 75%, ${s.alpha})`),n.addColorStop(.25,`hsla(${o}, 90%, 60%, ${.55*s.alpha})`),n.addColorStop(1,`hsla(${o}, 80%, 45%, 0)`),t.fillStyle=n,t.beginPath(),t.arc(h,a,2.6*e,0,2*Math.PI),t.fill(),t.fillStyle=`hsla(${o}, 100%, 92%, ${Math.min(1,1.2*s.alpha)})`,t.beginPath(),t.arc(h,a,Math.max(1.2,.42*e),0,2*Math.PI),t.fill()}_spawnRing(s=2e3,t=0,i=0,h=0){const a=this._centroidToHue(s),e=Math.max(t,i,h,this._percussiveEnergy),o=Math.round(this.map(e,0,1,260,720)),n=.8*this.baseRadius,r=this.map(e,0,1,1.4*this.baseRadius,.98*this.maxRadius),l=this.map(e,0,1,1.2,30);this.rings.push({age:0,lifespan:o,startRadius:n,radius:n,maxRadius:r,baseThickness:l,thickness:l,hue:a,alpha:1,initAlpha:.9})}_renderRing(s){const t=this.ctx;t.save(),t.globalCompositeOperation="lighter",t.beginPath(),t.strokeStyle=`hsla(${Math.round(s.hue)}, 88%, 62%, ${.9*s.alpha})`,t.lineWidth=Math.max(.8,.9*s.thickness),t.arc(0,0,s.radius,0,2*Math.PI),t.stroke(),t.beginPath(),t.strokeStyle=`hsla(${Math.round(s.hue)}, 75%, 48%, ${.45*s.alpha})`,t.lineWidth=Math.max(.4,.28*s.thickness),t.arc(0,0,.82*s.radius,0,2*Math.PI),t.stroke(),t.restore()}_centroidToHue(s){const t=this.constrain(s||0,0,22050);return Math.round(this.map(t,0,22050,210,30))}}"undefined"!=typeof window&&(window.MemorySpiralVisualizer=MemorySpiralVisualizer);