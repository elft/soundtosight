class MemorySpiralVisualizer extends BaseVisualizer{init(){this.centerX=this.width/2,this.centerY=this.height/2,this.baseRadius=.06*Math.min(this.width,this.height),this.maxRadius=.48*Math.min(this.width,this.height),this.spiralArms=3,this.spiralTightness=1.6,this.spiralPoints=240,this.auras=[],this.maxAuras=40,this.motes=[],this.maxMotes=160,this.rings=[],this.maxRings=8,this._lastDb=-1/0,this._smoothedRms=0,this._smoothedBass=0,this._smoothedMid=0,this._smoothedHighs=0,this.smoothFactor=.08,this.trailAlpha=.14,this.globalRotation=0,this.colorBase=200}onResize(){this.centerX=this.width/2,this.centerY=this.height/2,this.baseRadius=.06*Math.min(this.width,this.height),this.maxRadius=.48*Math.min(this.width,this.height)}onUpdate(t){if(!t)return;this.currentAudioData=t;const s=t.rms??0,i=t.bassEnergy??0,h=t.midEnergy??0,a=t.trebleEnergy??t.highs??0,e=t.spectralFlux??0,o=t.centroid??0,r=!!t.isBeat,n=t.time??performance.now()/1e3;this._smoothedRms=this.lerp(this._smoothedRms,s,this.smoothFactor),this._smoothedBass=this.lerp(this._smoothedBass,i,this.smoothFactor),this._smoothedMid=this.lerp(this._smoothedMid,h,this.smoothFactor),this._smoothedHighs=this.lerp(this._smoothedHighs,a,this.smoothFactor);const l=1+1.8*this._smoothedBass,d=1+2.6*this._smoothedMid;this._smoothedHighs,this.spiralArms=2+Math.round(this.map(this._smoothedMid,0,1,1,6)),this.spiralTightness=1.2+.9*d,this.spiralRadiusBase=this.baseRadius*l;const m=this.map(e+.8*a+(r?.6:0),0,2,0,1);if(Math.random()<m&&this.motes.length<this.maxMotes){const t=1+Math.floor(this.map(e,0,1,0,6));for(let s=0;s<t;s++)this._spawnMote(o,n)}const M=t.aWeighted?.mono?.db??this._lastDb,p=Math.max(0,(M===-1/0?-1/0:M)-(this._lastDb===-1/0?M:this._lastDb));this._lastDb=M,(p>.6||this._smoothedBass>.6||r)&&this.rings.length<this.maxRings&&this._spawnRing(o,this._smoothedBass,this._smoothedRms);for(let t=this.rings.length-1;t>=0;t--){const s=this.rings[t];s.age++,s.alpha=this.map(s.age,0,s.lifespan,s.initAlpha,0),s.radius=this.lerp(s.radius,s.maxRadius,.06),s.age>=s.lifespan&&this.rings.splice(t,1)}for(let t=this.motes.length-1;t>=0;t--){const s=this.motes[t];s.t+=.002+.006*(.2+this._smoothedHighs+.6*e)*(1+.2*s.seed),s.radial+=.1*Math.sin(3*n+5*s.seed)*this._smoothedMid,s.radius=s.baseRadius+s.t*s.speed*(1+4*this._smoothedBass)+s.radial,s.alpha*=.995,(s.t>1.6||s.alpha<.02)&&this.motes.splice(t,1)}for(;this.auras.length<this.maxAuras;)this._spawnAura(this.auras.length);for(let t=0;t<this.auras.length;t++){const s=this.auras[t];s.angle+=s.baseSpeed*(1+2.4*this._smoothedRms+4*e);const i=this._smoothedBass*(1+.5*Math.sin(1.5*n+s.seed));let h=0;for(let i=0;i<Math.min(8,this.motes.length);i++){const a=this.motes[(t+i)%this.motes.length],e=Math.cos(s.angle)*s.orbit-(Math.cos(a.angle)*a.radius||0),o=Math.sin(s.angle)*s.orbit-(Math.sin(a.angle)*a.radius||0),r=Math.sqrt(e*e+o*o);h+=this.constrain(1/(1+.02*r),0,.12)}s.orbit=s.baseOrbit*(1+1.6*i+2*h),s.z=.3+.25*Math.sin(.7*s.angle+.6*n+s.seed),s.hue=this._centroidToHue(o)+16*Math.sin(s.seed+.3*n),s.size=this.constrain(s.baseSize*(1+1.6*this._smoothedRms+.08*Math.sin(2*s.angle+3*n)),1.2,34),s.alpha=this.constrain(.35+.65*this._smoothedRms+.55*this._smoothedBass,.08,1)}this.globalRotation+=8e-4+.02*this._smoothedBass+.006*this._smoothedMid}onRender(){const t=this.ctx;if(t){t.save(),t.fillStyle=`rgba(0,0,0,${this.trailAlpha})`,t.globalCompositeOperation="source-over",t.fillRect(0,0,this.width,this.height),t.restore(),t.save(),t.translate(this.centerX,this.centerY),t.rotate(this.globalRotation),t.globalCompositeOperation="lighter",this._renderSpiral(t);for(let t=0;t<this.rings.length;t++)this._renderRing(this.rings[t]);for(let t=0;t<this.motes.length;t++)this._renderMote(this.motes[t]);for(let t=0;t<this.auras.length;t++)this._renderAura(this.auras[t]);if(t.restore(),this.config.debug&&this.currentAudioData){const s=[`RMS:${this._smoothedRms.toFixed(3)}`,`Bass:${this._smoothedBass.toFixed(3)}`,`Mid:${this._smoothedMid.toFixed(3)}`,`Highs:${this._smoothedHighs.toFixed(3)}`,`Motes:${this.motes.length}`,`Auras:${this.auras.length}`].join("  ");t.save(),t.fillStyle="rgba(255,255,255,0.85)",t.font="12px monospace",t.fillText(s,12,20),t.restore()}}}_renderSpiral(t){const s=Math.max(1,this.spiralArms),i=this.spiralPoints,h=this.colorBase,a=this._smoothedBass,e=this._smoothedMid,o=this._smoothedHighs;for(let r=0;r<3;r++){const n=this.map(r,0,2,.18,.04),l=this.map(r,0,2,2.6,.6),d=1+.12*r;for(let m=0;m<s;m++){t.beginPath();const M=Math.round(h+m/Math.max(1,s)*40-12*r);for(let h=0;h<=i;h++){const n=h/i,l=this.spiralRadiusBase*(1+n*this.map(a,0,1,1.2,5))*d,M=this.spiralTightness*(1+2.2*e),p=l*(1+6*n)+Math.sin(n*Math.PI*8+.9*m+.3*r)*(.6+1.8*o)*(1-n)*6,g=m*(2*Math.PI/s)+n*Math.PI*6*M+.06*r;let u=0;for(let t=0;t<Math.min(8,this.motes.length);t++){const s=this.motes[(h+t)%Math.max(1,this.motes.length)],i=Math.abs((g-(s.angle||0)+Math.PI)%(2*Math.PI)-Math.PI),a=Math.abs(p-(s.radius||0));u+=this.constrain(.02/(1+10*i+.02*a),0,1)}const c=p*(1+2*u),_=Math.cos(g)*c,b=Math.sin(g)*c;0===h?t.moveTo(_,b):t.lineTo(_,b)}t.strokeStyle=`hsla(${M}, 85%, ${40+8*r}%, ${n})`,t.lineWidth=l,t.lineCap="round",t.lineJoin="round",t.stroke()}}}_spawnMote(t=2e3,s=performance.now()/1e3){const i=Math.random(),h=Math.floor(Math.random()*Math.max(1,this.spiralArms)),a=.12*Math.random(),e=this.map(Math.random(),0,1,.6,2.6),o=this.spiralRadiusBase*(.6+.6*Math.random()),r=this._centroidToHue(t)+28*Math.random()-14,n={seed:i,arm:h,t:a,speed:e,baseRadius:o,radial:0,radius:o,alpha:1,size:2.2*Math.random()+.6,hue:r,angle:0};n.angle=h*(2*Math.PI/Math.max(1,this.spiralArms)),this.motes.push(n)}_renderMote(t){const s=this.ctx,i=t.t,h=t.arm,a=this.spiralTightness*(1+2.2*this._smoothedMid),e=t.baseRadius*(1+6*i)*(1+.9*this._smoothedBass)+Math.sin(i*Math.PI*8+.9*h+7*t.seed)*(.6+1.8*this._smoothedHighs)*(1-i)*6+t.radial,o=h*(2*Math.PI/Math.max(1,this.spiralArms))+i*Math.PI*6*a+.2*t.seed;t.angle=o,t.radius=e;const r=Math.cos(o)*e,n=Math.sin(o)*e,l=s.createRadialGradient(r,n,0,r,n,10*t.size);l.addColorStop(0,`hsla(${Math.round(t.hue)}, 100%, 85%, ${t.alpha})`),l.addColorStop(.25,`hsla(${Math.round(t.hue)}, 90%, 65%, ${.45*t.alpha})`),l.addColorStop(1,`hsla(${Math.round(t.hue)}, 80%, 45%, 0)`),s.fillStyle=l,s.beginPath(),s.arc(r,n,3.2*t.size,0,2*Math.PI),s.fill(),s.fillStyle=`hsla(${Math.round(t.hue)}, 100%, 92%, ${t.alpha})`,s.beginPath(),s.arc(r,n,Math.max(.6,.6*t.size),0,2*Math.PI),s.fill()}_spawnAura(t){const s=Math.random()*Math.PI*2,i=this.map(Math.random(),0,1,.9*this.baseRadius,.6*this.maxRadius),h=this.map(Math.random(),0,1,3,18),a=this.map(Math.random(),0,1,.002,.012),e={seed:s,angle:t/Math.max(1,this.maxAuras)*Math.PI*2+.2*Math.random(),baseOrbit:i,orbit:i,baseSize:h,size:h,baseSpeed:a,hue:this.colorBase+60*Math.random()-30,alpha:.9,z:.5};this.auras.push(e)}_renderAura(t){const s=this.ctx,i=1+.8*(t.z-.5),h=Math.cos(t.angle)*t.orbit,a=Math.sin(t.angle)*t.orbit*(1-.12*t.z),e=t.size*i,o=Math.round(this.constrain(t.hue,0,360)),r=s.createRadialGradient(h,a,0,h,a,4*e);r.addColorStop(0,`hsla(${o}, 100%, 75%, ${t.alpha})`),r.addColorStop(.25,`hsla(${o}, 90%, 60%, ${.55*t.alpha})`),r.addColorStop(1,`hsla(${o}, 80%, 45%, 0)`),s.fillStyle=r,s.beginPath(),s.arc(h,a,2.6*e,0,2*Math.PI),s.fill(),s.fillStyle=`hsla(${o}, 100%, 92%, ${Math.min(1,1.2*t.alpha)})`,s.beginPath(),s.arc(h,a,Math.max(1.2,.42*e),0,2*Math.PI),s.fill()}_spawnRing(t=2e3,s=0,i=0){const h=this._centroidToHue(t),a=Math.round(this.map(Math.max(s,i),0,1,320,1100)),e=this.map(Math.max(s,i),0,1,1.3*this.baseRadius,.9*this.maxRadius);this.rings.push({age:0,lifespan:a,radius:.8*this.baseRadius,maxRadius:e,thickness:this.map(s,0,1,1.2,28),hue:h,alpha:1,initAlpha:.9})}_renderRing(t){const s=this.ctx;s.save(),s.globalCompositeOperation="lighter",s.beginPath(),s.strokeStyle=`hsla(${Math.round(t.hue)}, 88%, 62%, ${.9*t.alpha})`,s.lineWidth=Math.max(.8,.9*t.thickness),s.arc(0,0,t.radius,0,2*Math.PI),s.stroke(),s.beginPath(),s.strokeStyle=`hsla(${Math.round(t.hue)}, 75%, 48%, ${.45*t.alpha})`,s.lineWidth=Math.max(.4,.28*t.thickness),s.arc(0,0,.82*t.radius,0,2*Math.PI),s.stroke(),s.restore()}_centroidToHue(t){const s=this.constrain(t||0,0,22050);return Math.round(this.map(s,0,22050,210,30))}}"undefined"!=typeof window&&(window.MemorySpiralVisualizer=MemorySpiralVisualizer);