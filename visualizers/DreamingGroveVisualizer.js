class DreamingGroveVisualizer extends BaseVisualizer{constructor(t,e={}){super(t,{backgroundColor:"#0a0d12",force2d:!0,...e})}async init(){this.centerX=this.width/2,this.baseY=.82*this.height,this.metrics={rms:0,bass:0,subBass:0,lowMid:0,mid:0,upperMid:0,presence:0,treble:0,brilliance:0,ultrasonic:0,centroid:.5,stereo:0,flatness:.5,flux:0,db:-60},this.palette={baseHue:120,targetBaseHue:120,canopyHue:160,targetCanopyHue:160,accentHue:210},this.groveState={breath:1,breathTarget:1,zoom:1,zoomTarget:1,lean:0,leanTarget:0,sway:0,swayTarget:0,glow:.3,glowTarget:.3,trunkWidth:32,trunkWidthTarget:32,trunkPulse:0},this.canopyLayers=this._initCanopyLayers(5),this.rootBands=this._initRootBands(5),this.trunkVeins=this._initTrunkVeins(4),this.fireflies=this._initFireflies(28),this.pulseWaves=[],this.time=0,this.lastRenderTime=performance.now()}_initCanopyLayers(t){const e=[];for(let s=0;s<t;s++){const i=s/Math.max(1,t-1);e.push({depth:i,radius:this.width*(.18+.12*i),targetRadius:this.width*(.18+.12*i),height:this.height*(.22+.08*i),targetHeight:this.height*(.22+.08*i),amplitude:18+12*i,targetAmplitude:18+12*i,density:.5+.3*i,targetDensity:.5+.3*i,alpha:.28-.05*i,targetAlpha:.28-.05*i,hueShift:28*-i,targetHueShift:28*-i,phase:Math.random()*Math.PI*2,drift:.6+.4*i})}return e}_initRootBands(t){const e=[];for(let s=0;s<t;s++){const i=(s+1)/(t+1);e.push({depth:i,radius:this.width*(.12+.18*i),targetRadius:this.width*(.12+.18*i),amplitude:20+24*i,targetAmplitude:20+24*i,thickness:6-2*i,targetThickness:6-2*i,phase:Math.random()*Math.PI*2,speed:.5+.3*i,hueShift:30*i})}return e}_initTrunkVeins(t){const e=[];for(let s=0;s<t;s++)e.push({offset:s/Math.max(1,t-1)*.6-.3,sway:Math.random()*Math.PI*2,wobble:0,thickness:2+1.5*Math.random()});return e}_initFireflies(t){const e=[];for(let s=0;s<t;s++)e.push({layer:s%4,phase:Math.random()*Math.PI*2,speed:.6+.9*Math.random(),radius:.18*this.width+Math.random()*this.width*.2,targetRadius:.18*this.width+Math.random()*this.width*.2,height:this.height*(.28+.3*Math.random()),targetHeight:this.height*(.28+.3*Math.random()),size:1.6+1.8*Math.random(),twinkle:Math.random()*Math.PI*2,twinkleSpeed:.8+1.4*Math.random(),alpha:.25+.35*Math.random()});return e}onResize(){this.centerX=this.width/2,this.baseY=.82*this.height;for(const t of this.canopyLayers){const e=t.depth;t.radius=t.targetRadius=this.width*(.18+.12*e),t.height=t.targetHeight=this.height*(.22+.08*e)}for(const t of this.rootBands){const e=t.depth;t.radius=t.targetRadius=this.width*(.12+.18*e)}for(const t of this.fireflies)t.radius=t.targetRadius=.18*this.width+Math.random()*this.width*.2,t.height=t.targetHeight=this.height*(.28+.3*Math.random())}onUpdate(t={}){const e=.14;this.metrics.rms=this.lerp(this.metrics.rms,t.rms||t.overallEnergy||0,e),this.metrics.bass=this.lerp(this.metrics.bass,t.bassEnergy||0,.18),this.metrics.subBass=this.lerp(this.metrics.subBass,t.subBassEnergy||0,.18),this.metrics.lowMid=this.lerp(this.metrics.lowMid,t.lowMidEnergy||0,e),this.metrics.mid=this.lerp(this.metrics.mid,t.midEnergy||0,e),this.metrics.upperMid=this.lerp(this.metrics.upperMid,t.upperMidEnergy||0,e),this.metrics.presence=this.lerp(this.metrics.presence,t.presenceEnergy||0,e),this.metrics.treble=this.lerp(this.metrics.treble,t.trebleEnergy||0,e),this.metrics.brilliance=this.lerp(this.metrics.brilliance,t.brillianceEnergy||0,e),this.metrics.ultrasonic=this.lerp(this.metrics.ultrasonic,t.ultrassonicEnergy||t.ultrasonicEnergy||0,e);const s=Number.isFinite(t.spectralCentroidNormalized)?t.spectralCentroidNormalized:.5;this.metrics.centroid=this.lerp(this.metrics.centroid,s,.12),this.metrics.flatness=this.lerp(this.metrics.flatness,t.flatness||.5,.1);const i=Number.isFinite(t.stereoBalance)?t.stereoBalance:0;this.metrics.stereo=this.lerp(this.metrics.stereo,i,.1),this.metrics.flux=this.lerp(this.metrics.flux,t.spectralFlux||0,.12);const a=t.aWeighted?.mono?.db??-60;this.metrics.db=this.lerp(this.metrics.db,a,.12),this.palette.targetBaseHue=(110+140*this.metrics.centroid-20*this.metrics.presence)%360,this.palette.targetCanopyHue=(this.palette.targetBaseHue+40+50*this.metrics.presence)%360,this.palette.baseHue=this._lerpHue(this.palette.baseHue,this.palette.targetBaseHue,.06),this.palette.canopyHue=this._lerpHue(this.palette.canopyHue,this.palette.targetCanopyHue,.08),this.palette.accentHue=(this.palette.baseHue+200)%360,this.groveState.breathTarget=1+.18*this.metrics.rms;const r=this.constrain((this.metrics.db+60)/50,0,1);this.groveState.zoomTarget=.88+.45*r,this.groveState.leanTarget=this.metrics.stereo*(.35+.3*this.metrics.presence),this.groveState.swayTarget=.16*(this.metrics.mid+.4*this.metrics.presence),this.groveState.glowTarget=.22+.55*this.metrics.brilliance+.3*this.metrics.ultrasonic,this.groveState.trunkWidthTarget=28+120*this.metrics.lowMid+60*this.metrics.bass,this.groveState.trunkPulse=Math.max(.86*this.groveState.trunkPulse,t.isBeat?1:0);for(const t of this.canopyLayers){const e=t.depth;t.targetRadius=this.width*(.2+.2*e)*(1+.25*this.metrics.mid+.12*this.metrics.presence),t.targetHeight=this.height*(.22+.12*e)*(1+.3*this.metrics.mid),t.targetAmplitude=14+20*e+70*this.metrics.mid+40*this.metrics.upperMid,t.targetDensity=.45+.4*e+.6*this.metrics.upperMid,t.targetAlpha=this.constrain(.2+.35*(1-e)+.45*this.metrics.rms-.1*e,.06,.75),t.targetHueShift=30*-e+20*this.metrics.presence}for(const t of this.rootBands)t.targetRadius=this.width*(.12+.2*t.depth)*(1+.35*this.metrics.bass+.25*this.metrics.subBass),t.targetAmplitude=18+40*t.depth+80*this.metrics.bass+60*this.metrics.subBass,t.targetThickness=4+6*this.metrics.bass-2*t.depth;for(const t of this.trunkVeins)t.wobble=Math.sin(.6*this.time+5*t.offset)*(.2+.8*this.metrics.upperMid),t.thickness=1.2+3*this.metrics.presence;for(const t of this.fireflies)t.targetRadius=this.width*(.16+.04*t.layer)*(1+.2*this.metrics.mid)+90*this.metrics.presence,t.targetHeight=this.height*(.28+.06*t.layer)-120*this.metrics.mid;t.isBeat&&this.pulseWaves.push({age:0,duration:1.2,amplitude:.6+.5*this.metrics.presence,maxRadius:.45*this.width+240*this.metrics.mid,hueShift:30*(Math.random()-.5),rotation:Math.random()*Math.PI*2,pattern:Math.random()<.5?"arc":"petal"}),t.bassDrop&&this.pulseWaves.push({age:0,duration:1.6,amplitude:.9,maxRadius:.55*this.width+320*this.metrics.bass,hueShift:90,rotation:Math.random()*Math.PI,pattern:"burst"})}onRender(){const t=performance.now(),e=Math.min(.06,(t-this.lastRenderTime)/1e3);this.lastRenderTime=t,this.time+=e,this.groveState.breath=this.lerp(this.groveState.breath,this.groveState.breathTarget,.08),this.groveState.zoom=this.lerp(this.groveState.zoom,this.groveState.zoomTarget,.08),this.groveState.lean=this.lerp(this.groveState.lean,this.groveState.leanTarget,.08),this.groveState.sway=this.lerp(this.groveState.sway,this.groveState.swayTarget,.1),this.groveState.glow=this.lerp(this.groveState.glow,this.groveState.glowTarget,.1),this.groveState.trunkWidth=this.lerp(this.groveState.trunkWidth,this.groveState.trunkWidthTarget,.12),this.groveState.trunkPulse*=.9;for(const t of this.canopyLayers)t.radius=this.lerp(t.radius,t.targetRadius,.12),t.height=this.lerp(t.height,t.targetHeight,.12),t.amplitude=this.lerp(t.amplitude,t.targetAmplitude,.12),t.density=this.lerp(t.density,t.targetDensity,.1),t.alpha=this.lerp(t.alpha,t.targetAlpha,.1),t.hueShift=this.lerp(t.hueShift,t.targetHueShift,.1),t.phase+=e*(t.drift+1.5*this.metrics.mid+1.2*this.metrics.presence);for(const t of this.rootBands)t.radius=this.lerp(t.radius,t.targetRadius,.12),t.amplitude=this.lerp(t.amplitude,t.targetAmplitude,.12),t.thickness=this.lerp(t.thickness,t.targetThickness,.12),t.phase+=e*(t.speed+1.4*this.metrics.bass+1.1*this.metrics.subBass);for(const t of this.fireflies)t.radius=this.lerp(t.radius,t.targetRadius,.1),t.height=this.lerp(t.height,t.targetHeight,.1),t.phase+=e*t.speed*(1+.5*this.metrics.mid+.4*this.metrics.presence),t.twinkle+=e*t.twinkleSpeed*(1+.8*this.metrics.brilliance+.6*this.metrics.ultrasonic);this.pulseWaves=this.pulseWaves.filter(t=>(t.age+=e,t.age<t.duration));const s=this.ctx,i=Math.max(1,this.width),a=Math.max(1,this.height),r=s.createLinearGradient(0,0,0,a);r.addColorStop(0,`hsl(${(this.palette.baseHue+220)%360}, 45%, 10%)`),r.addColorStop(1,"#06080d"),s.fillStyle=r,s.fillRect(0,0,i,a),this._renderGroundGlow(s),s.save(),s.translate(this.centerX,this.baseY),s.scale(this.groveState.zoom*this.groveState.breath,this.groveState.zoom*this.groveState.breath),s.rotate(this.groveState.lean),s.translate(-this.centerX,-this.baseY),this._renderRootBands(s),this._renderTrunk(s),this._renderPulseWaves(s),this._renderCanopy(s),this._renderFireflies(s),s.restore()}_renderGroundGlow(t){const e=.45*Math.max(this.width,this.height),s=t.createRadialGradient(this.centerX,this.baseY,.1*e,this.centerX,this.baseY,e);s.addColorStop(0,`hsla(${this.palette.baseHue}, 70%, 36%, ${.18+.4*this.groveState.glow})`),s.addColorStop(1,"rgba(8, 10, 16, 0)"),t.globalCompositeOperation="lighter",t.fillStyle=s,t.fillRect(this.centerX-e,this.baseY-e,2*e,2*e),t.globalCompositeOperation="source-over"}_renderRootBands(t){t.save(),t.globalCompositeOperation="lighter",t.translate(0,0);const e=this.baseY+.02*this.height;for(const s of this.rootBands){const i=(this.palette.baseHue-40+s.hueShift)%360;t.beginPath();for(let i=0;i<=40;i++){const a=i/40,r=this.centerX-s.radius+a*s.radius*2,h=Math.sin(Math.PI*a),o=Math.sin(a*Math.PI*4+s.phase)*s.amplitude*.3,n=e+h*s.amplitude+o;0===i?t.moveTo(r,n):t.lineTo(r,n)}const a=t.createLinearGradient(this.centerX,e,this.centerX,e+s.amplitude+40);a.addColorStop(0,`hsla(${i}, 50%, 26%, ${.18+.4*this.metrics.bass})`),a.addColorStop(1,"rgba(10, 12, 16, 0)"),t.strokeStyle=a,t.lineWidth=Math.max(1,s.thickness),t.lineCap="round",t.shadowBlur=16,t.shadowColor=`hsla(${i}, 70%, 40%, ${.2+.4*this.metrics.bass})`,t.stroke()}t.restore()}_renderTrunk(t){t.save(),t.globalCompositeOperation="lighter";const e=.48*this.height,s=[],i=[];for(let t=0;t<=48;t++){const a=t/48,r=this.baseY-a*e,h=Math.pow(1-a,1.4),o=Math.sin(a*Math.PI*3+1.4*this.time)*this.metrics.upperMid*18,n=Math.sin(a*Math.PI*1.2+.8*this.time)*this.groveState.sway*this.width*.5,l=this.groveState.trunkWidth*h*(1+.4*this.metrics.lowMid)+12+o;s.push({x:this.centerX-l+n,y:r}),i.push({x:this.centerX+l+n,y:r})}t.beginPath(),t.moveTo(s[0].x,s[0].y);for(const e of s)t.lineTo(e.x,e.y);for(let e=i.length-1;e>=0;e--)t.lineTo(i[e].x,i[e].y);t.closePath();const a=t.createLinearGradient(this.centerX,this.baseY-e,this.centerX,this.baseY);a.addColorStop(0,`hsla(${this.palette.baseHue+20}, 60%, 40%, ${.22+.3*this.groveState.glow})`),a.addColorStop(1,`hsla(${this.palette.baseHue-10}, 50%, 22%, 0.8)`),t.fillStyle=a,t.shadowBlur=25,t.shadowColor=`hsla(${this.palette.baseHue+20}, 70%, 40%, ${.25+.4*this.metrics.lowMid})`,t.fill();for(const s of this.trunkVeins){const i=.35*this.groveState.trunkWidth,a=26;t.beginPath();for(let r=0;r<=a;r++){const h=r/a,o=this.baseY-h*e,n=Math.sin(1.2*this.time+6*h+4*s.offset)*i*.15,l=this.groveState.sway*this.width*.2*Math.sin(h*Math.PI),d=Math.sin(h*Math.PI)*s.wobble*i,c=this.centerX+(s.offset*i+n+d+l);0===r?t.moveTo(c,o):t.lineTo(c,o)}t.strokeStyle=`hsla(${(this.palette.baseHue+30)%360}, 80%, 60%, ${.18+.4*this.metrics.presence+.4*this.groveState.trunkPulse})`,t.lineWidth=Math.max(.8,s.thickness),t.shadowBlur=14,t.shadowColor=`hsla(${(this.palette.baseHue+30)%360}, 90%, 55%, 0.3)`,t.stroke()}t.restore()}_renderCanopy(t){t.save(),t.globalCompositeOperation="lighter";const e=this.baseY-.32*this.height;for(const s of this.canopyLayers){const i=(this.palette.canopyHue+s.hueShift)%360;t.beginPath();for(let i=0;i<=64;i++){const a=i/64,r=this.centerX-s.radius+a*s.radius*2,h=Math.pow(Math.sin(Math.PI*a),.9+.8*s.depth),o=Math.sin(a*s.density*Math.PI*2+s.phase)*s.amplitude,n=this.groveState.sway*this.width*.3*(a-.5),l=e-h*s.height-o+n;0===i?t.moveTo(r,l):t.lineTo(r,l)}t.lineTo(this.centerX+s.radius,e+30),t.lineTo(this.centerX-s.radius,e+30),t.closePath();const a=t.createLinearGradient(this.centerX,e-s.height-s.amplitude,this.centerX,e+30);a.addColorStop(0,`hsla(${i}, 70%, 60%, ${s.alpha})`),a.addColorStop(.5,`hsla(${(i+30)%360}, 80%, 70%, ${.6*s.alpha})`),a.addColorStop(1,"rgba(10, 12, 18, 0)"),t.fillStyle=a,t.shadowBlur=35,t.shadowColor=`hsla(${i}, 70%, 60%, ${s.alpha*(.6+.6*this.metrics.presence)})`,t.fill()}t.restore()}_renderPulseWaves(t){if(this.pulseWaves.length){t.save(),t.globalCompositeOperation="screen",t.translate(this.centerX,this.baseY-.22*this.height);for(const e of this.pulseWaves){const s=this.constrain(e.age/e.duration,0,1),i=Math.pow(s,.6),a=e.maxRadius*i,r=(1-s)*e.amplitude,h=(this.palette.canopyHue+e.hueShift)%360;if(t.lineWidth=Math.max(1.5,12-10*i),t.strokeStyle=`hsla(${h}, 90%, 70%, ${r})`,t.beginPath(),"arc"===e.pattern?t.arc(0,0,a,.6*-Math.PI,.6*Math.PI):t.arc(0,0,a,0,2*Math.PI),t.stroke(),"petal"===e.pattern){t.save(),t.rotate(e.rotation+i*Math.PI*.4),t.lineWidth=Math.max(1,.6*t.lineWidth),t.strokeStyle=`hsla(${(h+30)%360}, 90%, 75%, ${.6*r})`,t.beginPath();const s=6;for(let e=0;e<=s;e++){const i=e/s*Math.PI*2,r=Math.cos(i)*a*.75,h=Math.sin(i)*a*.45;0===e?t.moveTo(r,h):t.lineTo(r,h)}t.closePath(),t.stroke(),t.restore()}else if("burst"===e.pattern){t.save(),t.rotate(e.rotation+i*Math.PI*.3),t.strokeStyle=`hsla(${(h+90)%360}, 90%, 75%, ${.5*r})`,t.lineWidth=Math.max(.8,.35*t.lineWidth),t.beginPath();const s=10;for(let e=0;e<s;e++){const i=e/s*Math.PI*2;t.moveTo(Math.cos(i)*a*.4,Math.sin(i)*a*.4),t.lineTo(Math.cos(i)*a,Math.sin(i)*a)}t.stroke(),t.restore()}}t.restore()}}_renderFireflies(t){t.save(),t.globalCompositeOperation="screen";for(const e of this.fireflies){const s=this.centerX+Math.cos(e.phase)*e.radius+this.groveState.sway*this.width*.15,i=e.height+40*Math.sin(.6*e.phase),a=e.alpha*(.6+.4*Math.sin(e.twinkle)+.6*this.metrics.brilliance),r=e.size*(1+.6*this.metrics.treble+.4*this.metrics.brilliance),h=(this.palette.accentHue+20*Math.sin(e.phase+e.layer))%360,o=t.createRadialGradient(s,i,0,s,i,3*r);o.addColorStop(0,`hsla(${h}, 90%, 78%, ${a})`),o.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=o,t.beginPath(),t.arc(s,i,3*r,0,2*Math.PI),t.fill()}t.restore()}_lerpHue(t,e,s){return t+((e-t+540)%360-180)*s}}"undefined"!=typeof window&&(window.DreamingGroveVisualizer=DreamingGroveVisualizer);