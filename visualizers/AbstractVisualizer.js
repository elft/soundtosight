class AbstractVisualizer extends BaseVisualizer{static meta={description:"Evolving geometric bloom that drifts between ribbons, arcs, and pulses.",tags:["chill","ambient","geometry","downtempo"]};constructor(t,s){super(t,{backgroundColor:"#060015",force2d:!0,smoothing:.75,...s}),this.LSD_DB_FLOOR=-60}async init(){this._updateDimensions(),this.globalTime=0,this.frameDt=1/60,this._lastUpdateTime=.001*performance.now(),this.spectrumSamples=new Float32Array(64),this._fluxFallback=new Float32Array(10),this.smooth={loud:0,perc:0,harm:0,brightness:0,entropy:0,slope:0,spread:0,width:0,correlation:0,zcr:0,crest:0,beatPulse:0,tempoConfidence:0,kick:0,snare:0,hat:0},this.colorState={baseHue:220,targetBaseHue:220,accentHue:320,targetAccentHue:320,saturation:70,targetSaturation:70,lightness:45,targetLightness:45},this.scene={seed:9999*Math.random(),motif:0,sectionBeats:18,beatCounter:0,sinceChange:0,paletteShift:0,paletteShiftTarget:0,cameraRollTarget:0},this.camera={roll:0,zoom:1,tilt:0},this.layers=this._createLayers(3),this.bursts=[],this.ripples=[],this.events={kickCooldown:0,snareCooldown:0,hatCooldown:0},this.backdropPhase=0,this.warp={phase:Math.random()*Math.PI*2,offsets:new Float32Array(3),speeds:new Float32Array(3)};for(let t=0;t<this.warp.offsets.length;t++)this.warp.offsets[t]=Math.random()*Math.PI*2,this.warp.speeds[t]=.5+.9*Math.random();this.chromaticGhost={phase:0,intensity:0},this.shapeMode="wave",this.shapeTimer=0,this.shapeMorph=0,this.shapeMorphTarget=0,this.polygonSides=6,this.fractureSeed=1e3*Math.random(),this.orbitals=this._createOrbitals(48)}onResize(){this._updateDimensions()}_updateDimensions(){const t="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches;this.centerX=this.width/2,this.centerY=t?.48*this.height:this.height/2,this.maxRadius=.5*Math.min(this.width,this.height)}onUpdate(t){if(!t)return;const s=.001*performance.now(),e=Math.min(.12,Math.max(1/240,s-this._lastUpdateTime));this._lastUpdateTime=s,this.frameDt=e,this.globalTime+=e,this._sampleSpectrum(t);const h=t.loudnessShortDb??t.aWeighted?.mono?.db??this.LSD_DB_FLOOR;this.smooth.loud=this.attackRelease(this.smooth.loud,this.dbTo01(h),e,.03,.3);const a=this.constrain(t.tempoConfidence??0,0,1);this.smooth.tempoConfidence=this.attackRelease(this.smooth.tempoConfidence,a,e,.12,.35);const o=this.constrain(t.percussiveRatio??t.percussiveEnergy??0,0,1);this.smooth.perc=this.attackRelease(this.smooth.perc,o,e,.08,.4);const i=this.constrain(t.harmonicEnergy??0,0,1);this.smooth.harm=this.attackRelease(this.smooth.harm,i,e,.12,.45);const n=this.constrain((t.spectralRolloff85??t.centroid??2e3)/2e4,0,1);this.smooth.brightness=this.attackRelease(this.smooth.brightness,n,e,.09,.4);const r=this.constrain(t.spectralEntropy??t.spectralFlatnessTrue??t.flatness??0,0,1);this.smooth.entropy=this.attackRelease(this.smooth.entropy,r,e,.1,.38);const l=isFinite(t.spectralSlope)?t.spectralSlope:0;this.smooth.slope=this.attackRelease(this.smooth.slope,l,e,.16,.45);const c=this.constrain((t.spectralSpreadHz??0)/12e3,0,1);this.smooth.spread=this.attackRelease(this.smooth.spread,c,e,.12,.45);const m=this.constrain(1-Math.exp(-Math.max(0,t.midSideRatio??0)),0,1);this.smooth.width=this.attackRelease(this.smooth.width,m,e,.1,.4);const p=this.constrain(t.interchannelCorrelation??0,-1,1);this.smooth.correlation=this.attackRelease(this.smooth.correlation,p,e,.12,.5);const d=this.constrain(t.zcr??0,0,1);this.smooth.zcr=this.attackRelease(this.smooth.zcr,d,e,.2,.5);const u=this.constrain(((t.crestTime??1)-1)/10,0,1);this.smooth.crest=this.attackRelease(this.smooth.crest,u,e,.15,.45);const g=t.fluxByBand&&t.fluxByBand.length>=8?t.fluxByBand:this._fallbackFlux(t.spectralFlux??0),f=.5*(g[0]+g[1]),M=.5*(g[4]+g[5]),S=.5*(g[6]+g[7]);this.smooth.kick=this.attackRelease(this.smooth.kick,f,e,.02,.4),this.smooth.snare=this.attackRelease(this.smooth.snare,M,e,.03,.45),this.smooth.hat=this.attackRelease(this.smooth.hat,S,e,.04,.5);const b=this.constrain((t.dominantFreqPrecise??t.dominantFreq??0)/2e4,0,1);this.colorState.targetBaseHue=(360*b+this.scene.paletteShift)%360,this.colorState.targetAccentHue=(this.colorState.targetBaseHue+100+40*this.smooth.slope)%360,this.colorState.targetSaturation=this.constrain(50+26*this.smooth.perc+18*this.smooth.entropy,40,92),this.colorState.targetLightness=this.constrain(25+12*this.smooth.harm+16*this.smooth.loud,16,65),this.colorState.baseHue=this.attackRelease(this.colorState.baseHue,this.colorState.targetBaseHue,e,.08,.6),this.colorState.accentHue=this.attackRelease(this.colorState.accentHue,this.colorState.targetAccentHue,e,.08,.6),this.colorState.saturation=this.attackRelease(this.colorState.saturation,this.colorState.targetSaturation,e,.1,.4),this.colorState.lightness=this.attackRelease(this.colorState.lightness,this.colorState.targetLightness,e,.12,.45);const w=!!t.isBeat,k=w?1:0;this.smooth.beatPulse=this.attackRelease(this.smooth.beatPulse,k,e,.03,.38),this._updateScene(t,e,w),this._updateCamera(t,e),this._handleBursts(t,e,{beat:w,kick:f,snare:M,hat:S}),this.warp.phase+=e*(.55+1.4*this.smooth.entropy);for(let t=0;t<this.warp.offsets.length;t++)this.warp.offsets[t]+=e*this.warp.speeds[t]*(.6+.9*this.smooth.perc+.4*this.smooth.entropy);this.chromaticGhost.phase+=e*(.45+.6*this.smooth.harm+1.2*this.smooth.hat);const y=this.constrain(.8*this.smooth.hat+.4*this.smooth.perc+.3*this.smooth.entropy,0,1);this.chromaticGhost.intensity=this.attackRelease(this.chromaticGhost.intensity,y,e,.18,.55),this.shapeTimer=Math.max(0,this.shapeTimer-e);const x=this.smooth.flux,R=this.smooth.loud;(w&&this.shapeTimer<=0&&this.smooth.tempoConfidence>.35||x>.65&&this.shapeTimer<=.1||R>.72&&x>.5&&this.shapeTimer<=.2)&&this._selectNextShapeMode(),this.shapeMorph=this.attackRelease(this.shapeMorph,this.shapeMorphTarget,e,.08,.32),this._updateOrbitals(e)}onRender(){const t=this.ctx;if(!t)return;const s=this.frameDt||1/60;t.fillStyle=`rgba(4, 0, 18, ${.16+.08*this.smooth.harm})`,t.fillRect(0,0,this.width,this.height);const e=t.createRadialGradient(this.centerX,this.centerY,0,this.centerX,this.centerY,1.3*this.maxRadius);e.addColorStop(0,`hsla(${(this.colorState.baseHue+.6*this.scene.paletteShift)%360}, ${Math.min(100,this.colorState.saturation+8)}%, ${Math.max(5,this.colorState.lightness-28)}%, 0.42)`),e.addColorStop(1,`hsla(${(this.colorState.accentHue+.2*this.scene.paletteShift)%360}, ${Math.max(30,.55*this.colorState.saturation)}%, 3%, 0.06)`),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),t.save(),t.translate(this.centerX,this.centerY);const h=this.camera.tilt*this.maxRadius*.25;t.translate(h,0),t.rotate(this.camera.roll),t.scale(this.camera.zoom,this.camera.zoom),this._drawLayers(t,s),this._drawOrbitals(t,s),this._drawBursts(t,s),this._drawRipples(t,s),this._drawChromaticGhost(t),t.restore(),this.backdropPhase+=s*(.3+1.2*this.smooth.entropy);const a=this.maxRadius*(.55+.12*Math.sin(1.5*this.backdropPhase)+.6*this.smooth.crest);t.save(),t.globalCompositeOperation="lighter",t.globalAlpha=Math.min(.28,.15+.35*this.smooth.zcr),t.fillStyle=`hsla(${(this.colorState.accentHue+60*Math.sin(this.backdropPhase))%360}, ${Math.min(100,this.colorState.saturation+14)}%, ${38+28*this.smooth.brightness}%, 0.18)`,t.beginPath(),t.arc(this.centerX,this.centerY,a,0,2*Math.PI),t.fill(),t.restore()}_sampleSpectrum(t){const s=this.spectrumSamples,e=s.length;if(!e)return;const h=t.smoothedSpectrum;if(h&&h.length>=e){const t=(h.length-1)/(e-1);for(let a=0;a<e;a++)s[a]=h[Math.round(a*t)]??0;return}const a=t.frequencyLeft||t.frequency||null;if(a&&a.length){const t=(a.length-1)/(e-1),h=1/255;for(let o=0;o<e;o++)s[o]=(a[Math.round(o*t)]??0)*h;return}for(let t=0;t<e;t++)s[t]=0}_fallbackFlux(t){const s=Math.max(0,t||0);for(let t=0;t<this._fluxFallback.length;t++)this._fluxFallback[t]=s;return this._fluxFallback}_updateScene(t,s,e){this.scene.sinceChange+=s;const h=this.smooth.tempoConfidence;e&&h>.45&&(this.scene.beatCounter+=1);const a=Math.max(60,Math.min(180,t.tempo??120)),o=this.scene.sectionBeats/a*60;this.scene.beatCounter>=this.scene.sectionBeats&&h>.4||t.bassDrop&&(t.bassDropIntensity??0)>.35||this.scene.sinceChange>1.8*o?(this.scene.motif=(this.scene.motif+1)%3,this.scene.sectionBeats=14+Math.floor(18*Math.random()),this.scene.beatCounter=0,this.scene.sinceChange=0,this.scene.seed=9999*Math.random(),this.scene.paletteShiftTarget=360*Math.random(),this.scene.cameraRollTarget=.6*(Math.random()-.5),this._applyMotifSettings(this.scene.motif)):this.scene.paletteShift=this.attackRelease(this.scene.paletteShift,this.scene.paletteShiftTarget,s,.2,.5)}_updateCamera(t,s){const e=this.constrain(t.stereoBalance??0,-1,1),h=this.smooth.width,a=this.scene.cameraRollTarget+e*(.2+.2*h);this.camera.roll=this.attackRelease(this.camera.roll,a,s,.18,.55);const o=this.constrain(.9+.35*this.smooth.harm+.25*this.smooth.loud,.85,1.8);this.camera.zoom=this.attackRelease(this.camera.zoom,o,s,.2,.6);const i=e*(.4+.6*h);this.camera.tilt=this.attackRelease(this.camera.tilt,i,s,.2,.5)}_handleBursts(t,s,{beat:e,kick:h,snare:a,hat:o}){this.events.kickCooldown=Math.max(0,this.events.kickCooldown-s),this.events.snareCooldown=Math.max(0,this.events.snareCooldown-s),this.events.hatCooldown=Math.max(0,this.events.hatCooldown-s);const i=this.colorState.baseHue+this.scene.paletteShift;h>.32+.4*this.smooth.loud&&0===this.events.kickCooldown&&(this._spawnBurst("kick",this.constrain(h,0,1),i),this.events.kickCooldown=.18),a>.28+.3*this.smooth.perc&&0===this.events.snareCooldown&&(this._spawnBurst("snare",this.constrain(a,0,1),i+60),this.events.snareCooldown=.22),o>.24+.3*this.smooth.entropy&&0===this.events.hatCooldown&&(this._spawnBurst("hat",this.constrain(o,0,1),i-40),this.events.hatCooldown=.18),e&&this._spawnRipple({strength:this.constrain(.8*this.smooth.loud+.4*this.smooth.perc,0,1),hue:i+90});for(let t=this.bursts.length-1;t>=0;t--){const e=this.bursts[t];e.age+=s,e.age>=e.life&&this.bursts.splice(t,1)}for(let t=this.ripples.length-1;t>=0;t--){const e=this.ripples[t];e.age+=s,e.age>=e.life&&this.ripples.splice(t,1)}}_createLayers(t){const s=[];for(let e=0;e<t;e++){const t=22+6*e,h={index:e,base:{segmentCount:t,twist:.5+.18*e,noiseDepth:.7+.22*e,radiusFactor:.7+.22*e,radiusMod:.55+.22*e,rotationSpeed:.35+.12*e,lineWidth:1.6+.6*e,spectrumInfluence:.7+.25*e,percShape:.45+.18*e,harmShape:.35+.16*e,blend:0===e?"screen":1===e?"lighter":"source-over"},segmentCount:t,angleStep:2*Math.PI/t,twist:.5+.18*e,noiseDepth:.7+.22*e,radiusFactor:.7+.22*e,radiusMod:.55+.22*e,rotation:Math.random()*Math.PI*2,rotationSpeed:.35+.12*e,lineWidth:1.6+.6*e,spectrumInfluence:.7+.25*e,percShape:.45+.18*e,harmShape:.35+.16*e,noiseRate:.8+.25*e,widthInfluence:.4+.22*e,blend:0===e?"screen":1===e?"lighter":"source-over",hueShift:160*(Math.random()-.5),noiseOffsets:this._makeNoiseOffsets(t)};s.push(h)}return s}_makeNoiseOffsets(t){const s=new Float32Array(t);for(let e=0;e<t;e++)s[e]=Math.random()*Math.PI*2;return s}_createOrbitals(t){const s=[];for(let e=0;e<t;e++){const t=this._makeOrbitalAnchor(e);s.push({angle:Math.random()*Math.PI*2,radius:.25+.65*Math.random(),depth:Math.random(),speed:.35+1.2*Math.random(),hueOffset:120*(Math.random()-.5),size:2+6*Math.random(),sparkle:Math.random(),layer:Math.floor(3*Math.random()),widthBias:0,anchor:t,posX:t.nx*this.width,posY:t.ny*this.height})}return s}_makeOrbitalAnchor(t){const s=[{nx:0,ny:0},{nx:1,ny:0},{nx:1,ny:1},{nx:0,ny:1}],e=.35+.2*Math.random();if(t<4)return s[t%s.length];const h=Math.floor(4*Math.random()),a=this.clamp(Math.random()*e+(1-e)*Math.random(),0,1);switch(h){case 0:return{nx:a,ny:0};case 1:return{nx:1,ny:a};case 2:return{nx:a,ny:1};default:return{nx:0,ny:a}}}_applyMotifSettings(t){const s=[{segmentScale:[1.2,1,.9],twistScale:1.4,noiseScale:1.2,radiusScale:1.05,blend:["screen","lighter","source-over"]},{segmentScale:[1.6,1.3,1.1],twistScale:2.1,noiseScale:1.6,radiusScale:1.25,blend:["lighter","screen","lighter"]},{segmentScale:[.9,.85,1.4],twistScale:.75,noiseScale:.9,radiusScale:.95,blend:["screen","overlay","lighter"]}],e=s[t%s.length];this.layers.forEach(t=>{const s=e.segmentScale[t.index]??1,h=Math.max(8,Math.floor(t.base.segmentCount*s));h!==t.segmentCount&&(t.segmentCount=h,t.angleStep=2*Math.PI/h,t.noiseOffsets=this._makeNoiseOffsets(h)),t.twist=t.base.twist*e.twistScale,t.noiseDepth=t.base.noiseDepth*e.noiseScale,t.radiusFactor=t.base.radiusFactor*e.radiusScale,t.radiusMod=t.base.radiusMod*e.radiusScale,t.rotationSpeed=t.base.rotationSpeed*(1+.4*(Math.random()-.5)),t.spectrumInfluence=t.base.spectrumInfluence*(.9+.4*Math.random()),t.percShape=t.base.percShape*(.9+.6*Math.random()),t.harmShape=t.base.harmShape*(.9+.5*Math.random()),t.blend=e.blend[t.index]??t.base.blend,t.hueShift=180*(Math.random()-.5)})}_drawLayers(t,s){const e=.22*Math.min(this.width,this.height),h=this.spectrumSamples,a=h.length-1;this.layers.forEach(o=>{o.rotation+=s*(o.rotationSpeed+this.smooth.perc*(.8+.3*o.index)+this.smooth.harm*(.2+.15*o.index)),t.save(),t.globalCompositeOperation=o.blend,t.globalAlpha=this.constrain(1-.15*o.index+.24+.24*this.smooth.harm-.1*this.smooth.correlation,.08,.75),t.lineWidth=o.lineWidth*(1+.5*this.smooth.perc),t.shadowBlur=18*(.35+1.4*this.smooth.entropy);const i=(this.colorState.baseHue+o.hueShift+this.scene.paletteShift)%360,n=(this.colorState.accentHue+.5*o.hueShift+.3*this.scene.paletteShift)%360,r=this.constrain(this.colorState.saturation+5*o.index+16*this.smooth.perc,38,95),l=this.constrain(this.colorState.lightness+26*this.smooth.brightness-5*o.index,16,70);t.shadowColor=`hsla(${n}, ${Math.min(100,r+10)}%, ${Math.min(80,l+14)}%, 0.75)`,t.fillStyle=`hsla(${i}, ${r}%, ${l}%, ${.24+.36*this.smooth.harm})`,t.strokeStyle=`hsla(${n}, ${Math.min(100,r+10)}%, ${Math.min(85,l+10)}%, 0.85)`;const c=o.segmentCount;t.beginPath();for(let s=0;s<=c;s++){const i=s%c,n=i/Math.max(1,c-1),r=Math.min(a,Math.round(n*a)),l=(h[r]??0)*o.spectrumInfluence,m=this.smooth.perc*o.percShape,p=this.smooth.harm*o.harmShape,d=Math.sin(this.globalTime*o.noiseRate+o.noiseOffsets[i])*(this.smooth.entropy*o.noiseDepth),u=Math.sin(this.warp.phase+o.noiseOffsets[i]*(1.4+.8*this.smooth.entropy)+this.warp.offsets[o.index%this.warp.offsets.length])*(.35+.9*this.smooth.entropy),g=Math.sin(this.warp.offsets[(o.index+1)%this.warp.offsets.length]+.32*i+.7*this.chromaticGhost.phase)*(.2+.45*this.smooth.perc);let f=o.rotation+i*o.angleStep*(1+o.twist*(.7*this.smooth.perc+.5*this.smooth.entropy))+.5*d+.6*u+.4*g,M=e*(o.radiusFactor+l+m+p+.22*d+.25*u+.18*g);if("polygon"===this.shapeMode){const t=2*Math.PI/Math.max(3,this.polygonSides),s=Math.round(f/t)*t;f=f*(1-.7*this.shapeMorph)+s*(.7*this.shapeMorph),M*=.9+.1*this.shapeMorph}else"kaleido"===this.shapeMode?(f*=1+2.2*this.shapeMorph,M*=1+.18*Math.sin(1.4*this.globalTime+.4*i)*this.shapeMorph):"fracture"===this.shapeMode?(f+=Math.sin(.43*i+1.9*this.globalTime+this.fractureSeed)*this.shapeMorph*.5,M*=1+Math.sin(1.1*i+2.2*this.globalTime)*this.shapeMorph*.25):"orbital"===this.shapeMode&&(f+=Math.sin(this.globalTime*(.8+.3*o.index)+.7*i)*this.shapeMorph*.5,M+=.12*this.maxRadius*this.shapeMorph*Math.sin(1.1*this.globalTime+.6*i));const S=1+this.smooth.width*o.widthInfluence,b=Math.cos(f)*M*S,w=Math.sin(f)*M/Math.max(.3,S);0===s?t.moveTo(b,w):t.lineTo(b,w)}t.closePath(),t.fill(),t.stroke(),t.restore()})}_spawnBurst(t,s,e){const h={type:t,age:0,life:.8+.7*s,strength:s,radius:this.maxRadius*(.12+.36*s),expansion:1.2+1.8*s,rotation:Math.random()*Math.PI*2,rotationSpeed:("hat"===t?2.2:"snare"===t?-1.6:1.2)*(.6+1.1*this.smooth.entropy),lobes:"hat"===t?9+Math.floor(4*Math.random()):"snare"===t?6+Math.floor(3*Math.random()):5+Math.floor(2*Math.random()),lobeCurves:"hat"===t?4:"snare"===t?3:2,noiseRate:1.2+this.smooth.entropy,noisePhase:Math.random()*Math.PI*2,modDepth:.6+.8*this.smooth.spread,hue:e,saturation:this.colorState.saturation,lightness:this.colorState.lightness};this.bursts.push(h),this.bursts.length>28&&this.bursts.shift()}_drawBursts(t,s){if(!this.bursts.length)return;const e=t.globalCompositeOperation;t.globalCompositeOperation="lighter";for(let s=0;s<this.bursts.length;s++){const e=this.bursts[s],h=this.constrain(e.age/e.life,0,1),a=1-h;t.save(),t.rotate(e.rotation+h*e.rotationSpeed);const o=e.radius*(1+e.expansion*h*(.7+.8*this.smooth.crest)),i=e.lobes;t.beginPath();for(let s=0;s<=i;s++){const h=s/i*Math.PI*2,a=o*(1+Math.sin(h*e.lobeCurves+this.globalTime*e.noiseRate+e.noisePhase)*e.modDepth*(.8+1.2*this.smooth.entropy)),n=Math.cos(h)*a,r=Math.sin(h)*a;0===s?t.moveTo(n,r):t.lineTo(n,r)}t.closePath();const n=(e.hue+this.scene.paletteShift)%360,r=this.constrain(e.saturation+25*this.smooth.perc,40,100),l=this.constrain(e.lightness+40*this.smooth.brightness,25,90);t.globalAlpha=a*(.45+.3*e.strength),t.fillStyle=`hsla(${n}, ${r}%, ${l}%, ${.26+.32*e.strength})`,t.strokeStyle=`hsla(${(n+40)%360}, ${Math.min(100,r+14)}%, ${Math.min(86,l+10)}%, ${.5+.26*e.strength})`,t.lineWidth=1+5.5*e.strength,t.shadowBlur=24*(.3+1.3*e.strength),t.shadowColor=`hsla(${n}, ${Math.min(100,r+10)}%, ${Math.min(85,l+10)}%, 0.85)`,t.fill(),t.stroke(),t.restore()}t.globalCompositeOperation=e}_spawnRipple({strength:t,hue:s}){const e={age:0,life:.9+.7*t,startRadius:.04*this.maxRadius,speed:this.maxRadius*(.8+1.4*t),lineWidth:2+12*t,alpha:.55+.4*t,rotation:Math.random()*Math.PI*2,hue:s,saturation:this.colorState.saturation,lightness:this.colorState.lightness};this.ripples.push(e),this.ripples.length>14&&this.ripples.shift()}_drawRipples(t,s){if(this.ripples.length)for(let s=0;s<this.ripples.length;s++){const e=this.ripples[s],h=this.constrain(e.age/e.life,0,1),a=e.startRadius+e.speed*h;t.save(),t.rotate(e.rotation),t.globalAlpha=Math.max(0,e.alpha*(1-h)),t.lineWidth=e.lineWidth*(.5+.8*this.smooth.crest);const o=(e.hue+this.scene.paletteShift)%360,i=this.constrain(e.saturation+18*this.smooth.perc,40,100),n=this.constrain(e.lightness+32*this.smooth.brightness,25,85);t.strokeStyle=`hsla(${o}, ${i}%, ${n}%, ${Math.max(.16,.8*t.globalAlpha)})`,t.beginPath(),t.arc(0,0,a*(1+.4*this.smooth.width),0,2*Math.PI),t.stroke(),t.restore()}}_drawChromaticGhost(t){const s=this.chromaticGhost,e=this.maxRadius*(.48+.25*this.smooth.harm+.08*Math.sin(.7*s.phase)),h=Math.sin(s.phase)*this.maxRadius*.08;t.save(),t.translate(h*(.6+.5*this.smooth.width),.35*h),t.globalCompositeOperation="screen";const a=Math.min(.2,.06+.28*s.intensity+.12*this.smooth.entropy);t.globalAlpha=a;const o=(this.colorState.baseHue+140+50*Math.sin(1.3*s.phase))%360,i=(o+70+20*this.smooth.slope)%360;t.lineWidth=1.4+2.4*this.smooth.width,t.beginPath(),t.arc(0,0,e,0,2*Math.PI),t.strokeStyle=`hsla(${o}, ${Math.min(100,this.colorState.saturation+28)}%, 58%, 0.45)`,t.stroke(),t.beginPath(),t.arc(0,0,e*(.7+.35*this.smooth.entropy),0,2*Math.PI),t.strokeStyle=`hsla(${i}, ${Math.min(100,this.colorState.saturation+16)}%, 32%, 0.4)`,t.stroke(),t.restore()}_updateOrbitals(t){const s=.6+.8*this.smooth.loud+.4*this.smooth.harm,e=this.smooth.width,h=this.centerX,a=this.centerY,o=this.clamp(.6*this.smooth.loud+.3*this.smooth.perc+.25*this.smooth.entropy,0,1);for(let i=0;i<this.orbitals.length;i++){const n=this.orbitals[i],r=s+.6*n.depth;n.angle+=t*n.speed*r;const l=.18+.7*n.depth,c=.18*this.shapeMorph+.12*this.smooth.perc;n.radius=l+c*Math.sin(this.globalTime*(1.4+n.depth)+.3*i),n.sparkle=this.attackRelease(n.sparkle,.8*this.smooth.hat+.6*this.smooth.kick,t,.04,.5),Math.random()<.6*t*s&&(n.hueOffset=(n.hueOffset+90+120*Math.random())%360),Math.random()<t*(.1+.5*this.smooth.entropy)&&(n.size=2+6*Math.random()+4*this.smooth.loud),n.widthBias=e;const m=this.maxRadius*n.radius,p=h+Math.cos(n.angle)*m,d=a+Math.sin(n.angle)*m,u=n.anchor.nx*this.width,g=n.anchor.ny*this.height,f=Math.pow(o,.6+.4*n.depth);n.posX=u*(1-f)+p*f,n.posY=g*(1-f)+d*f}}_drawOrbitals(t,s){if(!this.orbitals.length)return;t.save(),t.globalCompositeOperation="lighter";const e=(this.colorState.baseHue+this.scene.paletteShift)%360;for(let s=0;s<this.orbitals.length;s++){const h=this.orbitals[s],a=(h.widthBias,h.posX),o=h.posY,i=h.size*(.8+.4*this.smooth.loud),n=this.constrain(.18+.3*this.smooth.entropy+.6*h.sparkle,.05,.85),r=(e+h.hueOffset+40*Math.sin(.9*this.globalTime+.3*s))%360,l=t.createRadialGradient(a,o,0,a,o,4.2*i);l.addColorStop(0,`hsla(${r}, 100%, 78%, ${n})`),l.addColorStop(.35,`hsla(${(r+24)%360}, 90%, 58%, ${.55*n})`),l.addColorStop(1,`hsla(${(r+48)%360}, 80%, 42%, 0)`),t.fillStyle=l,t.globalAlpha=n,t.beginPath(),t.arc(a,o,2.2*i,0,2*Math.PI),t.fill(),t.globalAlpha=Math.min(1,1.4*n),t.fillStyle=`hsla(${(r+20)%360}, 100%, 88%, 1)`,t.beginPath(),t.arc(a,o,Math.max(.8,.6*i),0,2*Math.PI),t.fill()}t.restore()}_selectNextShapeMode(){const t=["wave","polygon","kaleido","fracture","orbital"];let s=this.shapeMode;for(let e=0;e<6;e++){const e=t[Math.floor(Math.random()*t.length)];if(e!==this.shapeMode){s=e;break}}this.shapeMode=s,this.shapeTimer=1.6+1.8*Math.random(),this.shapeMorphTarget="wave"===s?.25:1,"polygon"===s?this.polygonSides=3+Math.floor(7*Math.random()):"fracture"===s&&(this.fractureSeed=2e3*Math.random())}}"undefined"!=typeof window&&(window.AbstractVisualizer=AbstractVisualizer);