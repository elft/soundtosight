class Over9000Visualizer extends BaseVisualizer{constructor(t,e={}){super(t,{backgroundColor:"#04040a",force2d:!0,...e})}async init(){this.isMobile="undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 768px)").matches,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.center={x:.5*this.width,y:.5*this.height},this.targetPos={x:this.center.x,y:this.center.y},this.targetVelocity={x:0,y:0},this.targetDriftTimer=0;const t=Math.min(this.width,this.height)*(this.isMobile?.075:.095);this.target={baseRadius:t,radius:t,auraRadius:1.6*t,hue:210},this.superMeter=0,this.superActive=0,this.loudnessTrend=0,this.volumeVariance=0,this.globalTime=.001*("undefined"!=typeof performance?performance.now():Date.now()),this.beatPulse=0,this.superColorTimer=0,this.laserPalette=[0,90,180,270],this.laserPaletteIndex=0,this.laserPaletteHue=0,this.trail=[],this.maxTrail=this.isMobile?32:56,this.lasers=[],this._ensureLasers(this.isMobile?8:14),this.backgroundGradient=null,this._refreshBackgroundGradient()}onResize(){this.init()}onUpdate(t){const e=Number.isFinite(t?.time)?t.time:"undefined"!=typeof performance?.001*performance.now():.001*Date.now(),s=Math.min(.12,Math.max(1/240,e-(this._lastAudioTime||e)));this._lastAudioTime=e;const i=this.dbTo01(t?.loudnessShortDb??t?.aWeighted?.mono?.db??-60),a=this.dbTo01(t?.loudnessIntegratedDb??t?.aWeighted?.mono?.db??-60),h=this.clamp(t?.energyChangeIntensity??0,0,1);this.loudnessTrend=this.attackRelease(this.loudnessTrend,a,s,.35,2.5);const r=Math.max(0,i-this.loudnessTrend);this.volumeVariance=this.attackRelease(this.volumeVariance,r,s,.08,.6),this.superMeter=this.attackRelease(this.superMeter,i,s,.06,.45),this.beatPulse=this.attackRelease(this.beatPulse,t?.isBeat?1:0,s,.04,.5),this.globalTime+=s*(.9+1.6*this.superMeter),r>.18||h>.22||t?.bassDrop&&i>.65?(this.superActive=1,this.superColorTimer=0):this.superActive=Math.max(0,this.superActive-.5*s),this.superActive>0&&(this.superActive=Math.max(0,this.superActive-.5*s)),Number.isFinite(t?.tempo)&&(this._lastTempo=this.attackRelease(this._lastTempo??t.tempo,t.tempo,s,.4,1.2)),this.superActive>.1?(this.superColorTimer+=s,this.superColorTimer>=1&&(this.superColorTimer-=1,this.laserPaletteIndex=(this.laserPaletteIndex+1)%this.laserPalette.length,this.laserPaletteHue=this.laserPalette[this.laserPaletteIndex])):this.superColorTimer=0,this.updateTargetState(t,s),this._updateTargetPosition(s),this._updateLasers(s,t),this.trail.push({radius:this.target.radius,aura:this.target.auraRadius,alpha:.32+.4*this.superActive,hue:this.target.hue}),this.trail.length>this.maxTrail&&this.trail.shift()}updateTargetState(t,e){const s=this.clamp(t?.spectralCentroidNormalized??.3,0,1),i=this.clamp(t?.spectralFlux??0,0,1),a=this.clamp(t?.spectralEntropy??0,0,1),h=this.map(s,0,1,30,260);this.target.hue=(h+80*i+120*this.superActive)%360;const r=1+2.4*this.superActive,o=.12+.6*this.beatPulse,l=.25+.5*a;this.target.radius=this.target.baseRadius*(.85+1.15*this.superMeter+o),this.target.auraRadius=this.target.radius*(1.7+.8*this.superMeter+1.8*this.superActive),this.target.superAuraRadius=this.target.radius*r*(1.35+l),this._refreshBackgroundGradient()}_updateTargetPosition(t){const e=Math.max(40,1.5*this.target.radius);if(this.superActive>.08){if(this.targetDriftTimer-=t,this.targetDriftTimer<=0){const t=120+260*this.superMeter+60*Math.random(),e=Math.random()*Math.PI*2;this.targetVelocity.x=Math.cos(e)*t,this.targetVelocity.y=Math.sin(e)*t,this.targetDriftTimer=.35+.45*Math.random()}}else{const e=((.5-.5*this.volumeVariance)*this.height-this.targetPos.y)*Math.min(1,3.2*t),s=this.clamp((this._lastTempo??0)/240,0,1),i=Math.sin(this.globalTime*Math.PI*(1+3*s))*this.width*.12*(.3+.7*s),a=.5*this.width+i;this.targetVelocity.x+=(a-this.targetPos.x)*Math.min(1,1.8*t),this.targetVelocity.y+=e,this.targetVelocity.x*=.55,this.targetVelocity.y*=.58,this.targetDriftTimer=0}this.targetPos.x+=this.targetVelocity.x*t,this.targetPos.y+=this.targetVelocity.y*t,this.targetPos.x<e?(this.targetPos.x=e,this.targetVelocity.x=Math.abs(this.targetVelocity.x)):this.targetPos.x>this.width-e&&(this.targetPos.x=this.width-e,this.targetVelocity.x=-Math.abs(this.targetVelocity.x)),this.targetPos.y<e?(this.targetPos.y=e,this.targetVelocity.y=Math.abs(this.targetVelocity.y)):this.targetPos.y>this.height-e&&(this.targetPos.y=this.height-e,this.targetVelocity.y=-Math.abs(this.targetVelocity.y)),this.center.x=this.targetPos.x,this.center.y=this.targetPos.y,this._refreshBackgroundGradient()}_ensureLasers(t){for(this.lasers||(this.lasers=[]),t=Math.max(0,0|t);this.lasers.length<t;){const e=this._createLaserAnchor(this.lasers.length);this.lasers.push({anchor:e,angleOffset:2*Math.PI*(this.lasers.length/Math.max(1,t))+.4*Math.random(),radiusScale:.8+.4*Math.random(),sweepSpeed:.5+.8*Math.random(),hueOffset:85*(Math.random()-.5),intensity:0,currentX:e.nx*this.width,currentY:e.ny*this.height,targetX:e.nx*this.width,targetY:e.ny*this.height,edgePos:Math.random(),edgeVelocity:(.5*Math.random()+.2)*(Math.random()>.5?1:-1)})}this.lasers.length>t&&(this.lasers.length=t)}_createLaserAnchor(t){const e=[{nx:0,ny:0},{nx:1,ny:0},{nx:1,ny:1},{nx:0,ny:1}];if(t<e.length)return e[t];const s=Math.floor(4*Math.random()),i=this.clamp(.1+.8*Math.random(),0,1);switch(s){case 0:return{nx:i,ny:0};case 1:return{nx:1,ny:i};case 2:return{nx:i,ny:1};default:return{nx:0,ny:i}}}_updateLasers(t,e){if(!this.lasers)return;const s=(this.globalTime,Math.PI,this.center.x),i=this.center.y,a=(Math.min(this.width,this.height),this.isMobile,this.superActive>.05),h=Math.max(.01,this.volumeVariance);for(const e of this.lasers){const r=e.anchor.nx*this.width,o=e.anchor.ny*this.height;let l,n;if(a)l=s,n=i;else{const s=(.05+1.6*h+.25*this.superMeter+.3*this.beatPulse)*e.sweepSpeed;e.edgePos+=e.edgeVelocity*s*t,(e.edgePos<=0||e.edgePos>=1)&&(e.edgePos=this.clamp(e.edgePos,0,1),e.edgeVelocity*=-1),0===e.anchor.ny||1===e.anchor.ny?(l=this.clamp(e.edgePos,0,1)*this.width,n=o):(l=r,n=this.clamp(e.edgePos,0,1)*this.height)}const d=this.clamp((this.isMobile?7.5:9.5)*t*(1+.9*this.superMeter+1.4*this.superActive),0,1);e.currentX+=(l-e.currentX)*d,e.currentY+=(n-e.currentY)*d;const c=this.clamp((a?1.2:.5)+.9*this.superMeter+.8*this.beatPulse+1.4*this.superActive,0,2.2);e.intensity=this.attackRelease(e.intensity,c,t,.08,.5)}}onRender(){const t=this.ctx;t&&(this.drawBackground(t),this.drawTrail(t),this.drawLasers(t),this.drawTarget(t))}drawBackground(t){this.backgroundGradient||this._refreshBackgroundGradient(),t.save(),t.fillStyle="rgba(10, 8, 16, 0.28)",t.fillRect(0,0,this.width,this.height),t.globalCompositeOperation="lighter",t.globalAlpha=.5+.35*this.superMeter,t.fillStyle=this.backgroundGradient,t.fillRect(0,0,this.width,this.height),t.restore()}_refreshBackgroundGradient(){if(!this.ctx)return;const t=this.ctx.createRadialGradient(this.center.x,this.center.y,.05*Math.min(this.width,this.height),this.center.x,this.center.y,.8*Math.max(this.width,this.height));t.addColorStop(0,`hsla(${(this.target.hue+40)%360}, 85%, 18%, 0.45)`),t.addColorStop(.5,`hsla(${(this.target.hue+120)%360}, 70%, 10%, 0.25)`),t.addColorStop(1,"rgba(4, 4, 10, 0)"),this.backgroundGradient=t}drawTrail(t){if(this.trail.length){t.save(),t.globalCompositeOperation="screen";for(let e=this.trail.length-1;e>=0;e--){const s=this.trail[e];if(s.radius*=1.012,s.aura*=1.018,s.alpha*=.9,s.alpha<.04)continue;const i=t.createRadialGradient(this.center.x,this.center.y,.2*s.radius,this.center.x,this.center.y,s.aura);i.addColorStop(0,`hsla(${s.hue}, 95%, 60%, ${s.alpha})`),i.addColorStop(.45,`hsla(${(s.hue+30)%360}, 80%, 40%, ${.45*s.alpha})`),i.addColorStop(1,`hsla(${(s.hue+160)%360}, 65%, 10%, 0)`),t.globalAlpha=s.alpha,t.fillStyle=i,t.beginPath(),t.arc(this.center.x,this.center.y,s.aura,0,2*Math.PI),t.fill()}t.restore()}}drawLasers(t){if(this.lasers.length){t.save(),t.globalCompositeOperation="lighter";for(const e of this.lasers){const s=e.anchor.nx*this.width,i=e.anchor.ny*this.height,a=this.clamp(e.intensity,0,2),h=this.superActive>.1?this.laserPaletteHue:0,r=(this.target.hue+h+e.hueOffset+120*this.superActive)%360,o=(this.isMobile?1.6:2.4)+5.8*a;t.lineWidth=o;const l=t.createLinearGradient(s,i,e.currentX,e.currentY);l.addColorStop(0,`hsla(${(r+210)%360}, 95%, 40%, 0)`),l.addColorStop(.2,`hsla(${(r+90)%360}, 95%, 55%, ${.3+.18*a})`),l.addColorStop(1,`hsla(${r}, 98%, 70%, ${.55+.4*a})`),t.strokeStyle=l,t.shadowColor=`hsla(${r}, 95%, 70%, ${.4+.3*a})`,t.shadowBlur=22+56*a,t.beginPath(),t.moveTo(s,i),t.lineTo(e.currentX,e.currentY),t.stroke()}t.restore()}}drawTarget(t){t.save(),t.translate(this.center.x,this.center.y),t.globalCompositeOperation="lighter";const e=(t,e)=>Number.isFinite(t)?t:e,s=e(this.target.baseRadius,.08*Math.min(this.width,this.height)),i=Math.max(4,e(this.target.radius,s)),a=Math.max(i+2,e(this.target.auraRadius,1.8*i)),h=Math.max(a+2,e(this.target.superAuraRadius,1.3*a)),r=e(this.target.hue,200),o=t.createRadialGradient(0,0,i,0,0,h);if(o.addColorStop(0,`hsla(${(r+10)%360}, 85%, 48%, ${.18+.18*this.superActive})`),o.addColorStop(.5,`hsla(${(r+45)%360}, 75%, 36%, ${.14+.14*this.superMeter})`),o.addColorStop(1,`hsla(${(r+180)%360}, 55%, 16%, 0)`),t.globalAlpha=.55+.12*this.superMeter,t.fillStyle=o,t.beginPath(),t.arc(0,0,h,0,2*Math.PI),t.fill(),this.superActive>.05){t.strokeStyle=`hsla(${(r+10)%360}, 95%, 20%, ${.24+.22*this.superActive})`,t.lineWidth=Math.max(1.4,.06*i),t.beginPath();const e=9;for(let s=0;s<=e;s++){const a=2*Math.PI*s/e,h=i*(1.4+.35*Math.sin(4*this.globalTime+3*a)*(.3+this.superActive)),r=Math.cos(a)*h,o=Math.sin(a)*h;0===s?t.moveTo(r,o):t.lineTo(r,o)}t.closePath(),t.stroke()}const l=t.createRadialGradient(0,0,.35*i,0,0,a);l.addColorStop(0,`hsla(${r}, 85%, 52%, ${.48+.18*this.superMeter+.12*this.superActive})`),l.addColorStop(.6,`hsla(${(r+30)%360}, 72%, 42%, ${.24+.16*this.superMeter})`),l.addColorStop(1,`hsla(${(r+150)%360}, 55%, 18%, 0)`),t.fillStyle=l,t.beginPath(),t.arc(0,0,a,0,2*Math.PI),t.fill();const n=t.createRadialGradient(0,0,.15*i,0,0,i);n.addColorStop(0,"rgba(255,255,255,0.75)"),n.addColorStop(.4,`hsla(${(r+10)%360}, 85%, 52%, 0.48)`),n.addColorStop(1,`hsla(${(r+90)%360}, 75%, 38%, ${.22+.16*this.superMeter})`),t.fillStyle=n,t.beginPath(),t.arc(0,0,i,0,2*Math.PI),t.fill(),t.restore()}}"undefined"!=typeof window&&(window.Over9000Visualizer=Over9000Visualizer);