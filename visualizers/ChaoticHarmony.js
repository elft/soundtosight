class ChaoticHarmonyVisualizer extends BaseVisualizer{constructor(t=null,e={}){super(t,{backgroundColor:"rgba(0, 0, 0, 0.12)",smoothing:.85,force2d:!0,debug:!1,...e}),this.audio=null,this.shapes=[],this.maxShapes=220,this.spawnCoolDown=0,this.globalRotation=0,this.globalRotationTarget=0,this.globalScale=1,this.globalScaleTarget=1,this.globalSpeedMul=1,this.lastTime=performance.now(),this.bgOverlay=this.createOverlay("chaotic-bg",-2),this.bgCtx=this.bgOverlay.ctx,this.bgCanvas=this.bgOverlay.canvas,this.bgFadeAlpha=.06,this.shapeTypes=["circle","triangle","poly","squiggle","star"],this.spawnOnFluxThreshold=.015,this.spawnOnBeatCount=1,this._rng=()=>Math.random(),this.start()}onUpdate(t){if(this.audio=t,!t)return;if(t.spectralFlux>this.spawnOnFluxThreshold){const e=1+Math.round(this.map(t.spectralFlux,0,.5,0,6));for(let s=0;s<e;s++)this._spawnShape(t,"flux")}if(t.isBeat){const e=1+Math.round(this.map(t.energyChangeIntensity||0,0,.4,1,6));for(let s=0;s<e;s++)this._spawnShape(t,"beat")}if(t.bassDrop){this.globalRotationTarget+=(2*this._rng()-1)*Math.PI*.5,this.globalScaleTarget=1+Math.min(1.6,.6+6*(t.bassDropIntensity||0));for(let e=0;e<8;e++)this._spawnShape(t,"bassdrop")}const e=t.energy??t.overallEnergy??0,s=Math.abs(t.energyChange||0),i=this.constrain(.6+1.8*e+4*s,.5,3);this.globalSpeedMul=this.globalSpeedMul+.06*(i-this.globalSpeedMul);const a=.5*(t.subBassEnergy||0)+.6*(t.bassEnergy||0);if(this.globalRotationTarget+=(this._rng()-.5)*a*.02,t.tempo&&void 0!==t.beatPhase){const e=1+.06*Math.sin(t.beatPhase*Math.PI*2);this.globalScaleTarget=.95+e*(.05+.25*(t.energy||0))}(t.ultrassonicEnergy||0)>.12&&this._rng()>.6&&(this.globalRotationTarget+=.25*(this._rng()-.5)*(t.ultrassonicEnergy||0))}onRender(){const t=performance.now(),e=(t-this.lastTime)/1e3;this.lastTime=t,this.globalRotation+=(this.globalRotationTarget-this.globalRotation)*Math.min(1,6*e),this.globalScale+=(this.globalScaleTarget-this.globalScale)*Math.min(1,6*e),this._fadeBackgroundOverlay();const s=this.ctx;s.save(),s.clearRect(0,0,this.width,this.height),s.translate(this.width/2,this.height/2),s.rotate(this.globalRotation),s.scale(this.globalScale,this.globalScale);const i=.002*(6*(this.audio&&this.audio.presenceEnergy||0)+8*(this.audio&&this.audio.trebleEnergy||0))*Math.sin(t/1e3);s.rotate(i),this._updateShapes(e*this.globalSpeedMul),this._renderShapes(s),s.restore(),this._maybeSparkleBackground()}_spawnShape(t={},e="random"){if(this.shapes.length>this.maxShapes){const t=Math.floor(this._rng()*this.shapes.length);this.shapes.splice(t,1)}const s=this.width,i=this.height,a=s/2,h=i/2,o=this._rng,n=((t.centroid?this.map(t.centroid,0,(this.audioContextSampleRate??48e3)/2,0,360):360*o())%360+80*(t.trebleEnergy||0)+40*(t.brillianceEnergy||0))%360,l=this.constrain(.6*(t.lowMidEnergy||0)+.4*(t.midEnergy||0)+.3*o(),0,1),r=6+80*l+140*(t.bassEnergy||0),g=r*(.2+.9*o()),d=t.stereoBalance??0,c=a+(o()-.5)*s*(.8-.7*l)+d*s*.3,p=h+(o()-.5)*i*(.8-.7*l),y=(o()-.5)*(.2+6*(t.energy||0))*(1+3*l),b=(o()-.5)*(.2+6*(t.energy||0))*(1+3*l),u=o()*Math.PI*2,M=(o()-.5)*(.2+6*(t.subBassEnergy||0));let f=o();(t.bassEnergy||0)>.14&&(f-=.3),(t.trebleEnergy||0)>.12&&(f+=.3);const m=this.shapeTypes[Math.floor(this.constrain(f*this.shapeTypes.length,0,this.shapeTypes.length-1))],S=this.constrain(1+8*(t.presenceEnergy||0),.2,10),w=this.constrain(.3+.9*(t.energy||0)+.4*(1-l),.05,1),x=Math.floor(1e5*o()),E={x:c,y:p,vx:y,vy:b,size:g,baseSize:r,rot:u,spin:M,type:m,hue:n,strokeWidth:S,alpha:w,life:1,depth:l,createdAt:performance.now(),ttl:4+8*o(),seed:x};this.shapes.push(E)}_updateShapes(t){if(!t)return;const e=performance.now(),s=this.audio&&this.audio.bassEnergy?this.constrain(this.audio.bassEnergy,0,1):0,i=this.audio&&this.audio.brillianceEnergy?this.constrain(this.audio.brillianceEnergy,0,1):0,a=this.audio&&this.audio.ultrassonicEnergy?this.audio.ultrassonicEnergy:0;for(let h=this.shapes.length-1;h>=0;h--){const o=this.shapes[h];o.vx+=(.2*Math.sin(.01*(o.seed+.001*e))+.6*(this._rng()-.5))*(.5+s),o.vy+=(.2*Math.cos(.01*(o.seed+.001*e))+.6*(this._rng()-.5))*(.5+i),o.x+=o.vx*t+(this._rng()-.5)*a*6,o.y+=o.vy*t+(this._rng()-.5)*a*6,o.rot+=o.spin*t*(1+1.5*o.depth);const n=t*(.08+.8*(1-(this.audio&&this.audio.midEnergy?this.audio.midEnergy:0)));o.life-=n;const l=1+(this.audio&&this.audio.bassEnergy?this.audio.bassEnergy*(1+o.depth):0);o.size=o.baseSize*l*(.6+Math.abs(.6*Math.sin(e/400+o.seed%100))),o.x<-this.width&&(o.x=this.width+(o.x+this.width)),o.x>2*this.width&&(o.x=o.x-2*this.width),o.y<-this.height&&(o.y=this.height+(o.y+this.height)),o.y>2*this.height&&(o.y=o.y-2*this.height),o.life<=0&&this.shapes.splice(h,1)}}_renderShapes(t){for(let e=0;e<this.shapes.length;e++){const s=this.shapes[e];t.save();const i=1+.6*(1-s.depth),a=s.x-this.width/2,h=s.y-this.height/2;t.translate(a,h),t.rotate(s.rot);const o=s.size*i,n=Math.floor(s.hue+40*s.depth),l=Math.floor(40+45*(1-s.depth)+(this.audio?40*this.audio.energy:0)),r=this.constrain(s.alpha*(.6+.8*(1-s.depth)),.02,1);if("circle"===s.type)t.globalCompositeOperation="lighter",t.beginPath(),t.arc(0,0,Math.max(1,o/2),0,2*Math.PI),t.fillStyle=`hsla(${n}, 90%, ${l}%, ${.9*r})`,t.fill(),t.beginPath(),t.arc(0,0,Math.max(1,.9*o),0,2*Math.PI),t.strokeStyle=`hsla(${(n+30)%360}, 80%, ${Math.min(80,l+10)}%, ${.25*r})`,t.lineWidth=.6*s.strokeWidth,t.stroke();else if("triangle"===s.type||"poly"===s.type){t.globalCompositeOperation="lighter";const e="triangle"===s.type?3:3+Math.floor(s.seed%5);t.beginPath();for(let s=0;s<e;s++){const i=s/e*Math.PI*2,a=Math.cos(i)*o*.5,h=Math.sin(i)*o*.5;0===s?t.moveTo(a,h):t.lineTo(a,h)}t.closePath(),t.fillStyle=`hsla(${n}, 85%, ${Math.min(75,l)}%, ${r})`,t.fill(),t.strokeStyle=`hsla(${(n+120)%360}, 70%, ${Math.max(40,l-10)}%, ${.6*r})`,t.lineWidth=.8*s.strokeWidth,t.stroke()}else if("squiggle"===s.type){t.globalCompositeOperation="lighter",t.beginPath();const e=6+s.seed%6;for(let i=0;i<e;i++){const a=i/e,h=a*Math.PI*2+.01*s.seed,n=o*(.15+.85*Math.sin(a*Math.PI+.001*s.seed)),l=Math.cos(h)*n,r=Math.sin(h)*n*(.6+.3*Math.sin(6*a+s.seed));0===i?t.moveTo(l,r):t.lineTo(l,r)}t.strokeStyle=`hsla(${n}, 92%, ${l}%, ${r})`,t.lineWidth=.6*s.strokeWidth,t.stroke()}else if("star"===s.type){t.globalCompositeOperation="lighter";const e=4+s.seed%6,i=.6*o,a=.45*i;t.beginPath();for(let s=0;s<e;s++){const h=s/e*Math.PI*2;t.lineTo(Math.cos(h)*i,Math.sin(h)*i);const o=h+Math.PI/e;t.lineTo(Math.cos(o)*a,Math.sin(o)*a)}t.closePath(),t.fillStyle=`hsla(${n}, 90%, ${l}%, ${.9*r})`,t.fill()}t.restore()}}_fadeBackgroundOverlay(){const t=this.bgCtx,e=this.bgCanvas.width/(window.devicePixelRatio||1),s=this.bgCanvas.height/(window.devicePixelRatio||1);t.save(),t.globalCompositeOperation="source-over",t.fillStyle=`rgba(0,0,0,${this.bgFadeAlpha})`,t.fillRect(0,0,e,s),t.restore()}_maybeSparkleBackground(){if(!this.audio)return;const t=this.audio.brillianceEnergy||0,e=this.audio.trebleEnergy||0,s=this.audio.ultrassonicEnergy||0,i=this.constrain(.6*t+.3*e+.2*s,0,1),a=Math.round(12*i*(1+2*this._rng())),h=this.bgCtx,o=this.width,n=this.height;for(let t=0;t<a;t++){const t=Math.random()*o,e=Math.random()*n,s=3*Math.random()+(Math.random()<.2?5:0);h.beginPath(),h.globalCompositeOperation="lighter",h.fillStyle=`hsla(${Math.floor(80*Math.random()+(this.audio.centroid||180))%360}, 90%, 60%, ${.5+.5*Math.random()})`,h.arc(t,e,s,0,2*Math.PI),h.fill()}}destroy(){try{this.removeOverlay("chaotic-bg")}catch(t){}super.destroy?.()}}"undefined"!=typeof window&&(window.ChaoticHarmonyVisualizer=ChaoticHarmonyVisualizer);