class RolloffMirageVisualizer extends BaseVisualizer{constructor(t,e){super(t,{backgroundColor:"#030309",force2d:!0,...e})}init(){this.lastAudioTime=null,this.elapsed=0,this.horizonY=.6*this.height,this.horizonTarget=this.horizonY,this.horizonBow=0,this.bowEnergy=0,this.glowStrength=0,this.rippleWidth=28,this.rippleBlur=6,this.shimmerAmount=0,this.shimmerPhase=0,this.rolloffNorm=0,this.spreadNorm=0,this.barCount=32,this.heatBars=new Float32Array(this.barCount),this.barOffsets=new Float32Array(this.barCount),this._pathY=new Float32Array(this.barCount);for(let t=0;t<this.barCount;t++)this.barOffsets[t]=Math.random()*Math.PI*2;this.barAttack=.04,this.barRelease=.28,this.beatCounter=0,this.sectionBeats=0,this.sectionSeed=Math.random()*Math.PI*2,this.palettes=[this._palette(210,260,32,180),this._palette(12,38,24,48),this._palette(280,320,40,200),this._palette(150,190,28,100),this._palette(330,10,36,260)],this.paletteIndex=0,this.currentPalette=this.palettes[this.paletteIndex],this.flatness=0,this.tempo=120,this.tempoConfidence=0,this.waterPulse=0,this.waterWaveEnergy=0,this.waterBeatAngle=0,this.boat={xNorm:.5,sectionOffset:0,sectionTarget:.4*(Math.random()-.5),bobStrength:0,verticalOffset:0,phase:Math.random()*Math.PI*2,impulse:0,angle:0,sailLean:0,wakeStrength:0,size:0},this.whale={active:!1,progress:0,duration:2.6,xNorm:.5,originX:.5,targetX:.5,y:.6*this.height,baseY:.6*this.height,dir:1,mouth:0,cooldown:0,hasEaten:!1},this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this._resizeBoat()}onUpdate(t){if(!t)return;const e="number"==typeof t.time?t.time:.001*performance.now();null===this.lastAudioTime&&(this.lastAudioTime=e);let i=e-this.lastAudioTime;this.lastAudioTime=e,(!Number.isFinite(i)||i<=0)&&(i=1/60),i=Math.min(.12,Math.max(1/240,i)),this.elapsed+=i;let s=0;s="number"==typeof t.spectralRolloff85&&t.spectralRolloff85>0?this._clamp(t.spectralRolloff85/2e4,0,1):"number"==typeof t.spectralCentroidNormalized?this._clamp(t.spectralCentroidNormalized,0,1):this._clamp((t.centroid||0)/2e4,0,1),this.rolloffNorm=this._ar(this.rolloffNorm,s,i,.05,.22);let h=0;h="number"==typeof t.spectralSpreadHz?this._clamp(t.spectralSpreadHz/6e3,0,1):this._clamp(t.flatness||0,0,1),this.spreadNorm=this._ar(this.spreadNorm,h,i,.06,.28);const a=void 0!==t.loudnessShortDb?t.loudnessShortDb:t.aWeighted?.mono?.db??-60,o=this._dbToNorm(a);this.glowStrength=this._ar(this.glowStrength,o,i,.08,.35),this.flatness=this._ar(this.flatness,t.spectralFlatnessTrue??t.flatness??0,i,.12,.35),this.tempo=this._ar(this.tempo,t.tempo||this.tempo||120,i,.12,.6),this.tempoConfidence=this._ar(this.tempoConfidence,t.tempoConfidence??this.tempoConfidence,i,.1,.5);const r=this.height*this._mix(.76,.34,this.rolloffNorm);this.horizonTarget=r,this.horizonY=this._ar(this.horizonY,this.horizonTarget,i,.04,.25);const l=20+120*this.spreadNorm;this.rippleWidth=this._ar(this.rippleWidth,l,i,.05,.3);const n=4+22*this.flatness;this.rippleBlur=this._ar(this.rippleBlur,n,i,.06,.4);const g=this._clamp(t.beatPhase??0,0,1),m=Math.sin(g*Math.PI*2+this.sectionSeed),u=Math.abs(m)*(.35+.9*this.glowStrength)*(.5+.5*this.tempoConfidence);this.shimmerAmount=this._ar(this.shimmerAmount,u,i,.1,.5),this.shimmerPhase+=i*(this.tempo/30);let d=0;d=t.fluxByBand&&t.fluxByBand.length>=3?(t.fluxByBand[0]+t.fluxByBand[1]+t.fluxByBand[2])/3:t.spectralFlux??t.rms??0,d=this._clamp(d,0,1),this.waterWaveEnergy=this._ar(this.waterWaveEnergy,d,i,.07,.4),t.isBeat&&(this.waterPulse=Math.min(1.8,this.waterPulse+.9)),t.bassDrop&&(this.waterPulse=Math.min(2.1,this.waterPulse+.6)),this.waterPulse=Math.max(0,this.waterPulse-2.1*i);const c=.8+1.8*this.waterWaveEnergy+.6*this.glowStrength;this.waterBeatAngle+=i*(2.2+(this.tempo||120)/90+1.8*c),t.isBeat&&(this.beatCounter+=1,this.sectionBeats+=1,this.sectionBeats>=32&&(this.sectionBeats=0,this._advancePalette())),t.bassDrop&&(this.bowEnergy=1),this.bowEnergy>0&&(this.bowEnergy=Math.max(0,this.bowEnergy-2.8*i)),this.horizonBow=48*-Math.sin(this.bowEnergy*Math.PI)*(.4+.6*this.glowStrength),this._updateBoat(t,i),this._updateWhale(t,i,o),this._updateHeatBars(t,i)}onRender(){const t=this.ctx;if(!t)return;const{width:e,height:i}=this;t.clearRect(0,0,e,i);const s=this.currentPalette,h=this.glowStrength,a=this._hsl(s.skyTopHue,s.skyTopSat,s.skyTopLight+12*h),o=(this._hsl(s.skyBottomHue,s.skyBottomSat,s.skyBottomLight+16*h),this._hsl(s.groundHue,s.groundSat,s.groundLight+8*h)),r=this._mix(s.skyTopHue,s.skyBottomHue,.5),l=this._mix(s.skyTopSat,s.skyBottomSat,.5),n=this._mix(s.skyTopLight+12*h,s.skyBottomLight+16*h,.5),g=this._hsl(r,l,n),m=t.createLinearGradient(0,0,0,i);m.addColorStop(0,a),m.addColorStop(.55,g),m.addColorStop(1,o),t.fillStyle=m,t.fillRect(0,0,e,i);const u=this.horizonY+this.horizonBow,d=this.rippleWidth*(.45+1.4*h)*(this.isMobile?.82:1);t.save(),t.beginPath(),t.moveTo(0,u);const c=1/Math.max(1,this.barCount-1);for(let i=0;i<this.barCount;i++){const s=i*c,h=s*e,a=this.heatBars[i],o=this.barOffsets[i],r=a**1.2*d,l=Math.sin(.4*this.shimmerPhase+o+s*Math.PI*6)*this.shimmerAmount*d*.3,n=Math.sin(o+.6*this.elapsed+5*s)*this.spreadNorm*18,g=(10+.25*this.rippleWidth)*(.35+.9*this.waterWaveEnergy),m=u-r-l-n-Math.sin(this.waterBeatAngle+s*Math.PI*(4.5+5*this.waterWaveEnergy))*this.waterPulse*g-Math.sin(this.elapsed*(.9+.8*this.waterWaveEnergy)+12*s)*this.waterWaveEnergy*g*.5;this._pathY[i]=m,t.lineTo(h,m)}t.lineTo(e,i),t.lineTo(0,i),t.closePath(),t.shadowBlur=(this.rippleBlur+6*this.waterPulse)*(this.isMobile?.7:1),t.shadowColor=this._hsla(s.glowHue,s.glowSat,s.glowLight+20*h,.7),t.fillStyle=this._hsla(s.glowHue,s.glowSat,s.glowLight+25*h,.5),t.fill(),t.restore(),t.save(),t.lineWidth=2+6*h+2.2*this.waterPulse,t.shadowBlur=(12+40*h+18*this.waterPulse)*(this.isMobile?.75:1),t.shadowColor=this._hsla(s.glowHue,s.glowSat,Math.min(90,s.glowLight+35*h),.8),t.strokeStyle=this._hsla(s.glowHue,s.glowSat+10*h,s.glowLight+30*h,.9),t.beginPath(),t.moveTo(0,u);for(let i=0;i<this.barCount;i++){const s=i*c*e;t.lineTo(s,this._pathY[i])}t.stroke(),t.restore(),t.save(),t.globalCompositeOperation="lighter",t.lineWidth=1+.6*this.waterPulse,t.strokeStyle=this._hsla(s.highlightHue,s.highlightSat,s.highlightLight,.25+.35*h),t.beginPath(),t.moveTo(0,u-6);for(let i=0;i<this.barCount;i++){const s=i*c*e,a=Math.sin(this.shimmerPhase+.3*i)*(6+10*h),o=this.waterPulse*(4+8*this.waterWaveEnergy),r=this._pathY[i]-6-a-o;t.lineTo(s,r)}t.stroke(),t.restore(),this._drawBoat(t,u,s,h),this._drawWhale(t,s,h)}onResize(){this.horizonY=.6*this.height,this.horizonTarget=this.horizonY,this._resizeBoat()}destroy(){super.destroy()}_resizeBoat(){if(!this.boat)return;const t=Math.max(32,Math.min(this.width,this.height));this.boat.size=t*(this.isMobile?.08:.11)}_updateHeatBars(t,e){const i=t.frequencyLeft;if(!i||0===i.length)return;const s=t.frequencyRight||i,h=i.length,a=h/this.barCount;for(let t=0;t<this.barCount;t++){const o=Math.floor(t*a),r=Math.min(h,Math.floor((t+1)*a));let l=0,n=0;for(let t=o;t<r;t++)l+=i[t],l+=s[t],n+=2;const g=(n>0?l/n:0)/255,m=this.heatBars[t];this.heatBars[t]=this._ar(m,g,e,this.barAttack,this.barRelease)}}_updateBoat(t,e){const i=this.boat;if(!i)return;const s=this._clamp(t.stereoBalance??0,-1,1);i.sectionOffset=this._ar(i.sectionOffset,i.sectionTarget,e,.18,.5);const h=.05*Math.sin(.12*this.elapsed+.3*i.phase),a=this._clamp(.5+i.sectionOffset+.25*s+h,.12,.88);i.xNorm=this._ar(i.xNorm,a,e,.12,.4);let o=0;o=t.fluxByBand&&t.fluxByBand.length>=2?.5*(t.fluxByBand[0]+t.fluxByBand[1]):t.bassEnergy??t.rms??0,o=this._clamp(o,0,1),i.bobStrength=this._ar(i.bobStrength,o,e,.08,.45),t.isBeat&&(i.impulse=Math.min(1.25,i.impulse+.6)),t.bassDrop&&(i.impulse=1.4),i.impulse=Math.max(0,i.impulse-2.4*e);const r=.7+this.tempo/160+1.4*i.bobStrength;i.phase+=e*r;const l=Math.sin(i.phase+.5*this.sectionSeed);i.verticalOffset=l*(6+26*i.bobStrength)+16*i.impulse;let n=0;n=t.fluxByBand&&t.fluxByBand.length>=8?.5*(t.fluxByBand[6]+t.fluxByBand[7]):t.trebleEnergy??0,n=this._clamp(n,0,1);const g=t.midSideRatio??1,m=(g-1)/(g+1+1e-6),u=t.interchannelCorrelation??0,d=this._clamp(.45*m-.25*u+.35*(n-.3),-.55,.55);i.angle=this._ar(i.angle,d,e,.12,.5);const c=this._clamp(.6*(n-.4)+.2*s,-.5,.5);i.sailLean=this._ar(i.sailLean,c,e,.15,.5);const p=t.percussiveEnergy??0,w=this._clamp(.6*o+.6*p+.3*this.glowStrength,0,1.6);i.wakeStrength=this._ar(i.wakeStrength,w,e,.1,.5)}_drawBoat(t,e,i,s){const h=this.boat;if(!h||!this._pathY||0===this._pathY.length)return;const a=Math.max(0,Math.min(this.barCount-1,Math.round(h.xNorm*(this.barCount-1)))),o=h.xNorm*this.width,r=this._pathY[a]??e,l=Math.max(26,h.size*(this.isMobile?.82:1)*(.85+.3*s)),n=.25*l,g=r-.6*n-6+h.verticalOffset;t.save(),t.translate(o,g),t.rotate(h.angle),t.shadowBlur=8+18*s,t.shadowColor=this._hsla(i.glowHue,i.glowSat,i.glowLight+25*s,.45);const m=this._hsla(i.groundHue,i.groundSat+8,Math.max(8,i.groundLight+14+10*s),.92);t.fillStyle=m,t.beginPath(),t.moveTo(.48*-l,0),t.quadraticCurveTo(0,n,.48*l,0),t.quadraticCurveTo(.34*l,.22*-n,0,.18*-n),t.quadraticCurveTo(.34*-l,.22*-n,.48*-l,0),t.closePath(),t.fill(),t.lineWidth=Math.max(1.2,.015*l),t.strokeStyle=this._hsla(i.glowHue,i.glowSat,Math.min(92,i.glowLight+28*s),.6),t.beginPath(),t.moveTo(.42*-l,.1*-n),t.lineTo(.42*l,.1*-n),t.stroke();const u=1.05*l;t.lineWidth=Math.max(1.2,.012*l),t.strokeStyle=this._hsla(i.glowHue,.75*i.glowSat,Math.min(95,70+20*s),.8),t.beginPath(),t.moveTo(0,.1*-n),t.lineTo(0,-u),t.stroke(),t.save(),t.translate(0,-u),t.rotate(.6*h.sailLean),t.fillStyle=this._hsla((i.highlightHue+30)%360,i.highlightSat,92,.75),t.beginPath(),t.moveTo(0,0),t.lineTo(.45*l,.55*u),t.lineTo(.12*l,.95*u),t.closePath(),t.fill(),t.restore(),t.restore(),this._drawBoatWake(t,o,r,l,h,i,s)}_updateWhale(t,e,i){const s=this.whale;if(!s)return;s.baseY=this.horizonY+this.horizonBow,s.cooldown>0&&(s.cooldown=Math.max(0,s.cooldown-e));const h=i>.9||(t.energyChangeIntensity??0)>.22;if(!s.active&&0===s.cooldown&&h){const t=this.boat,e=t?t.xNorm:.5;s.active=!0,s.progress=0,s.duration=2.2+.6*Math.random(),s.dir=Math.random()<.5?-1:1,s.originX=this._clamp(e+.45*s.dir,.05,.95),s.targetX=this._clamp(e-.05*s.dir,.05,.95),s.xNorm=s.originX,s.y=s.baseY+40,s.mouth=0,s.hasEaten=!1}if(!s.active)return;s.progress+=e/s.duration;const a=this._clamp(s.progress,0,1);s.xNorm=this._mix(s.originX,s.targetX,a);const o=Math.sin(Math.PI*Math.min(1,a)),r=Math.pow(o,.85)*(120+140*this.glowStrength);s.y=s.baseY-r+12*Math.sin(a*Math.PI*2),s.mouth=Math.sin(Math.min(Math.PI,a*Math.PI*1.4)),s.progress>=1&&(s.active=!1,s.progress=0,s.cooldown=4+3.5*Math.random(),s.hasEaten=!1)}_drawWhale(t,e,i){const s=this.whale;if(!s||!s.active)return;const h=s.xNorm*this.width,a=s.y,o=Math.max(80,1.6*(this.boat?.size||80)*(this.isMobile?.85:1));t.save(),t.translate(h,a),t.scale(s.dir,1),t.rotate(.05*s.mouth-.2);const r=this._hsla((e.glowHue+180)%360,Math.min(90,.8*e.glowSat),Math.min(70,40+25*i),.95),l=this._hsla((e.highlightHue+200)%360,Math.max(10,.45*e.highlightSat),85,.9);t.shadowBlur=14+30*i,t.shadowColor=this._hsla(e.glowHue,e.glowSat,Math.min(92,e.glowLight+35*i),.5),t.fillStyle=r,t.beginPath(),t.moveTo(.55*-o,.18*-o),t.quadraticCurveTo(.1*-o,.55*-o,.4*o,.1*-o),t.quadraticCurveTo(.55*o,.25*o,0,.28*o),t.quadraticCurveTo(.42*-o,.35*o,.55*-o,.18*-o),t.closePath(),t.fill(),t.fillStyle=l,t.beginPath(),t.moveTo(.3*-o,.1*o),t.quadraticCurveTo(.05*-o,.2*o,.1*o,.16*o),t.quadraticCurveTo(.15*o,.05*o,.18*-o,.02*-o),t.closePath(),t.fill(),t.fillStyle=this._hsla(0,0,8,.9),t.beginPath(),t.moveTo(.1*o,.02*-o),t.quadraticCurveTo(.32*o,s.mouth*o*.18,.05*o,s.mouth*o*.22),t.quadraticCurveTo(.05*-o,s.mouth*o*.12,.02*-o,.02*-o),t.closePath(),t.fill(),t.fillStyle=this._hsla(0,0,15,.9),t.beginPath(),t.arc(.18*o,.08*-o,.06*o,0,2*Math.PI),t.fill(),t.restore()}_drawBoatWake(t,e,i,s,h,a,o){const r=h.wakeStrength||0;if(r<=.02)return;const l=Math.min(.55,.18+.18*r);t.save(),t.globalCompositeOperation="screen",t.lineWidth=Math.max(.6,.01*s),t.strokeStyle=this._hsla(a.glowHue,a.glowSat,Math.min(95,a.glowLight+35*o),.9*l);const n=s*(1.2+.9*r),g=14*r;t.beginPath(),t.moveTo(e-n,i+3+.15*g),t.quadraticCurveTo(e-.5*n,i+.05*g,e-.08*n,i+.2*g),t.stroke(),t.beginPath(),t.moveTo(e+.1*n,i+4+.2*g),t.quadraticCurveTo(e+.38*n,i+.45*g,e+.8*n,i+.32*g),t.stroke(),t.lineWidth*=.6,t.beginPath(),t.moveTo(e-.6*n,i+6+.3*g),t.quadraticCurveTo(e-.3*n,i+.55*g,e-.05*n,i+.42*g),t.stroke(),t.restore()}_advancePalette(){this.paletteIndex=(this.paletteIndex+1)%this.palettes.length,this.currentPalette=this.palettes[this.paletteIndex],this.sectionSeed=Math.random()*Math.PI*2,this.boat&&(this.boat.sectionTarget=.4*(Math.random()-.5))}_palette(t,e,i,s){return{skyTopHue:t,skyTopSat:68,skyTopLight:9,skyBottomHue:e,skyBottomSat:62,skyBottomLight:19,groundHue:i,groundSat:48,groundLight:12,glowHue:s,glowSat:85,glowLight:60,highlightHue:s,highlightSat:70,highlightLight:65}}_dbToNorm(t){return(Math.max(-60,Math.min(0,t??-60))+60)/60}_clamp(t,e,i){return Math.min(i,Math.max(e,t))}_mix(t,e,i){return t+(e-t)*i}_hsla(t,e,i,s=1){return`hsla(${(t%360+360)%360}, ${Math.max(0,e)}%, ${Math.max(0,i)}%, ${this._clamp(s,0,1)})`}_hsl(t,e,i){return this._hsla(t,e,i,1)}_ar(t,e,i,s,h){const a=Number.isFinite(e)?e:0,o=Number.isFinite(t)?t:0,r=a>o?s||.05:h||.2;return o+(a-o)*(1-Math.exp(-i/Math.max(r,.001)))}}"undefined"!=typeof window&&(window.RolloffMirageVisualizer=RolloffMirageVisualizer);