class KaleidoscopeVisualizer extends BaseVisualizer{static meta={description:"Prismatic kaleidoscope: mirrored wedges that breathe with loudness and bloom on drops.",tags:["kaleidoscope","psychedelic","symmetric","mesmerizing","mobile-friendly"]};constructor(t=null,e={}){super(t,{backgroundColor:"#05060a",force2d:!0,...e}),this.prevT=.001*performance.now(),this.loud=0,this.texture=0,this.brightness=0,this.sectionHue=360*Math.random()|0,this.sliceCountBase=8,this.sliceCountTarget=8,this.sliceCount=8,this.sliceMorph=0,this.sliceMorphTarget=.25,this.sliceCountSlew=8,this.zoom=1,this.rotation=0,this.rotSpeed=.12,this.parallax=0,this.swirlPhase=0,this.entropyPulse=0,this.sliceOverdrive=0,this.breathPhase=0,this.breathDepth=0,this.breathGate=0,this.breathVisual=0,this.paletteLUT=[{baseShift:0,accentShift:150,shadowShift:280,bloomShift:70,baseSat:.9,accentSat:.86,accentLight:36,shadowSat:.96},{baseShift:-45,accentShift:210,shadowShift:120,bloomShift:110,baseSat:.88,accentSat:.94,accentLight:40,shadowSat:.9},{baseShift:60,accentShift:260,shadowShift:180,bloomShift:-30,baseSat:.92,accentSat:.8,accentLight:28,shadowSat:.98},{baseShift:25,accentShift:320,shadowShift:230,bloomShift:160,baseSat:.95,accentSat:.88,accentLight:34,shadowSat:.92}],this.paletteIndex=Math.floor(Math.random()*this.paletteLUT.length),this.paletteNoisePhase=Math.random()*Math.PI*2,this.paletteSeed=Math.random()*Math.PI*2,this.paletteWarpValue=0,this._palette={baseHue:0,accentHue:0,shadowHue:0,scheme:null},this._prevDropStart=!1,this.dropGlow=0,this.paletteShiftCooldown=0,this.buffer=document.createElement("canvas"),this.bctx=this.buffer.getContext("2d"),this.bctx.imageSmoothingEnabled=!1,this.bctx.lineJoin="round",this.bctx.lineCap="round",this._bufferLogicalWidth=0,this._bufferLogicalHeight=0,this._bufferScale=1,this._bars=new Float32Array(64),this._resizeBuffer()}onResize(){this._resizeBuffer()}_resizeBuffer(){const t=Math.max(1,Math.min(this.width,this.height)),e=Math.min(1024,Math.max(320,Math.round(.72*t)));this._bufferLogicalWidth=e,this._bufferLogicalHeight=e,this._bufferScale=this._computeBufferScale(),this.buffer.width=Math.floor(e*this._bufferScale),this.buffer.height=Math.floor(e*this._bufferScale),this._applyBufferTransform()}_computeBufferScale(){const t="undefined"!=typeof window&&Number(window.devicePixelRatio)||1;return t>1?Math.min(2,t):1.35}_applyBufferTransform(){const t=this._bufferScale||1;this.bctx.setTransform(t,0,0,t,0,0),this.bctx.imageSmoothingEnabled=!1,this.bctx.lineJoin="round",this.bctx.lineCap="round"}_db01(t,e=-60,s=0){return this.dbTo01(Number.isFinite(t)?t:e,e,s)}_downsample(t,e=64){if(!t||!t.length)return this._bars.fill(0),this._bars;const s=t.length,h=Math.floor(s/e);for(let i=0;i<e;i++){let a=0;const o=i*h,r=i===e-1?s:o+h;for(let e=o;e<r;e++)t[e]>a&&(a=t[e]);this._bars[i]=a/255}return this._bars}_paintBuffer(t){const e=this.bctx,s=this._bufferLogicalWidth,h=this._bufferLogicalHeight;if(!s||!h)return;this._applyBufferTransform(),e.clearRect(0,0,s,h),e.globalCompositeOperation="source-over";const i=Math.max(32,Math.hypot(.5*s,.5*h)),a=.5*s,o=.5*h,r=e.createRadialGradient(a,o,0,a,o,i),l=Array.isArray(this.paletteLUT)&&this.paletteLUT.length?this.paletteLUT[this.paletteIndex%this.paletteLUT.length]:{baseShift:0,accentShift:150,shadowShift:280,bloomShift:70,baseSat:.9,accentSat:.84,accentLight:34,shadowSat:.94},n=(this.sectionHue+24*this.brightness+140*this.entropyPulse+(l.baseShift??0)+(this.paletteWarpValue||0))%360,c=(n+(l.accentShift??150)+25*this.texture)%360,d=(n+(l.shadowShift??280)+35*this.breathGate)%360,p=Math.round(100*(l.baseSat??.9)),u=Math.round(100*(l.accentSat??.84)),f=Math.round(100*(l.shadowSat??.94)),b=Math.min(92,24+44*this.loud),m=Math.min(72,Math.max(20,(l.accentLight??34)+12*this.brightness));this._palette=this._palette||{},this._palette.baseHue=n,this._palette.accentHue=c,this._palette.shadowHue=d,this._palette.scheme=l,r.addColorStop(0,`hsl(${n} ${p}% ${b}% / 0.22)`),r.addColorStop(.45,`hsl(${c} ${u}% ${m}% / 0.35)`),r.addColorStop(1,`hsl(${d} ${f}% 6% / 0.92)`),e.fillStyle=r,e.fillRect(0,0,s,h);const S=t?.smoothedSpectrum?.length?t.smoothedSpectrum:this._downsample(t?.frequencyLeft,this._bars.length),M=t?.peakSpectrum&&t.peakSpectrum.length===S.length?t.peakSpectrum:null,g=a,P=o,w=24+Math.round(24*this.sliceMorph),_=Math.min(s,h)*(.28+.18*this.loud+.1*this.texture);e.save(),e.translate(g,P),e.rotate(.8*this.rotation),e.lineWidth=1+2.5*(.4+this.loud),e.shadowBlur=10+28*(this.dropGlow+this.loud),e.shadowColor=`hsl(${(n+90)%360} 95% 68%)`;const y=72+20*this.entropyPulse,x=40+25*this.loud;e.strokeStyle=`hsl(${(c+30)%360} ${y}% ${x}%)`,e.beginPath();for(let t=0;t<=w;t++){const s=t/w,h=Math.floor(s*(S.length-1)),i=S[h]??0,a=M?Math.max(i,M[h]||0):i,o=3+5*this.sliceMorph,r=s*Math.PI*2,l=_*(1+.35*Math.cos(o*r))*(.55+.75*a),n=l*Math.cos(r),c=l*Math.sin(r);0===t?e.moveTo(n,c):e.lineTo(n,c)}e.closePath(),e.stroke();const C=2+Math.round(4*this.entropyPulse+2*this.breathGate);if(C>0){const t=3+5*this.sliceMorph,s=.12+.22*(this.loud+this.entropyPulse);e.save(),e.globalCompositeOperation="screen";for(let h=0;h<C;h++){const i=this.swirlPhase+.85*h,a=(n+40*h+180*this.entropyPulse)%360,o=70+20*this.entropyPulse,r=Math.min(88,44+30*(this.brightness+this.breathGate)),l=Math.min(.88,s*(.6+h/C));e.lineWidth=.8+1.6*(h/C+.5*this.texture),e.strokeStyle=`hsla(${a} ${o}% ${r}% / ${l})`,e.shadowColor=`hsla(${(a+160)%360} 95% 68% / ${.35+.35*this.breathGate})`,e.shadowBlur=12+24*(this.breathGate+this.entropyPulse),e.beginPath();const c=84;for(let s=0;s<=c;s++){const h=s/c,a=h*Math.PI*2,o=S[Math.floor(h*(S.length-1))]??0,r=Math.sin(a*t+i)*(.3+.45*this.entropyPulse),l=_*(.4+.38*o+.22*this.texture)+r*_,n=l*Math.cos(a),d=l*Math.sin(a);0===s?e.moveTo(n,d):e.lineTo(n,d)}e.closePath(),e.stroke()}e.restore()}const v=this.clamp(this.breathVisual,0,1);if(v>.02){const t=3+Math.round(4*v),s=.5+.5*this.clamp(.5*Math.sin(this.breathPhase)+.5,0,1);e.save(),e.globalCompositeOperation="screen";for(let h=0;h<t;h++){const i=h/Math.max(1,t-1),a=h%2==0?1:-1,o=this.breathPhase*(1.2+.15*h),r=.22*Math.sin(o+i*Math.PI*1.5)*v,l=_*(.35+.4*i+.18*s+.22*r),n=4+16*v*(.35+.65*(1-i)),d=(c+95*i+55*r)%360,p=.14+.26*v*(1-.6*i);e.strokeStyle=`hsla(${d} ${78+18*this.entropyPulse}% ${58+22*(1-i)}% / ${p})`,e.lineWidth=n,e.shadowBlur=16+36*v*(1-i),e.shadowColor=`hsla(${(d+100)%360} 95% 76% / ${.35+.3*v})`,e.beginPath();for(let t=0;t<=96;t++){const s=t/96*Math.PI*2,h=l*(1+.05*Math.sin(s*(2.6+1.3*this.sliceMorph)+o*a)*(.4+v)),i=h*Math.cos(s),r=h*Math.sin(s);0===t?e.moveTo(g+i,P+r):e.lineTo(g+i,P+r)}e.closePath(),e.stroke()}e.restore()}e.restore()}onUpdate(t){const e=.001*performance.now(),s=this.clamp(e-this.prevT,1/240,.1);this.prevT=e;const h=this.audioTriggers||{},i=h.dropStart||h.dropBloom,a=Boolean(h.dropStart);a&&!this._prevDropStart&&this._advancePalette(),this._prevDropStart=a;const o=Number.isFinite(t?.loudnessShortDb)?t.loudnessShortDb:t?.aWeighted?.mono?.db??-60,r=this._db01(o);this.loud=this.attackRelease(this.loud,r,s,.06,.45);const l=t?.tempo??120,n=t?.tempoConfidence??0,c=t?.percussiveRatio??0;this.texture=this.attackRelease(this.texture,c,s,.06,.35);const d=(t?.spectralRolloff85??t?.centroid??0)/(this.width,2e4);this.brightness=this.attackRelease(this.brightness,this.clamp(d,0,1),s,.1,.65);const p=this.clamp(Number(t?.spectralEntropy)||0,0,1);this.entropyPulse=this.attackRelease(this.entropyPulse,p,s,.08,.6);const u=i?1:0,f=this.clamp(Number(t?.energyChangeIntensity)||0,0,1),b=Boolean(t?.isMassiveEnergyChange)||f>.12||u>0;this.breathGate=this.attackRelease(this.breathGate,b?1:0,s,.08,.8),this.paletteNoisePhase+=s*(.25+.7*this.entropyPulse+.45*this.loud);const m=Math.sin(this.paletteNoisePhase+this.paletteSeed)+.45*Math.sin(.63*this.paletteNoisePhase+1.7*this.paletteSeed)+.32*Math.sin(1.27*this.paletteNoisePhase+2.3*this.paletteSeed),S=(28+60*this.entropyPulse)*(.25+.75*this.breathGate);this.paletteWarpValue=this.clamp(m*S,-180,180),this.sliceOverdrive=this.attackRelease(this.sliceOverdrive,.45*this.entropyPulse+.35*this.texture,s,.25,1.2);const M=(n>.6?l>=140?14:l>=110?12:10:8)+Math.round(2*this.brightness)+Math.round(4*this.sliceOverdrive);this.sliceCountTarget=this.clamp(M,6,22),this.sliceCountSlew=this.attackRelease(this.sliceCountSlew,this.sliceCountTarget,s,.45,1.8);const g=Math.max(3,Math.round(this.sliceCountSlew));g!==this.sliceCount&&(this.sliceCount=g);const P=1+.08*(t?.isBeat?1:0)+.18*this.loud;this.zoom=this.attackRelease(this.zoom,P,s,.12,.8);const w=(.08+.35*this.brightness+.25*this.loud)*(1+.3*this.texture);this.rotSpeed=this.attackRelease(this.rotSpeed,w,s,.3,1.35),this.rotation+=this.rotSpeed*s;const _=this.clamp((Number(t?.dominantFreqPrecise??t?.dominantFreq)||0)/800,0,4),y=.35+.85*this.loud+1*this.brightness+.7*this.texture+.5*this.entropyPulse+.4*_;this.swirlPhase+=y*s,this.swirlPhase>2e3*Math.PI&&(this.swirlPhase-=2e3*Math.PI),this.rotation>2e3*Math.PI&&(this.rotation-=2e3*Math.PI);const x=this.clamp(Number(t?.beatPhase)||0,0,1),C=.5-.5*Math.cos(x*Math.PI*2),v=this.clamp(.45*this.loud+.25*this.texture+.35*this.entropyPulse+.15*C,0,1)*this.breathGate;this.breathDepth=this.attackRelease(this.breathDepth,v,s,.18,.55),this.breathVisual=this.attackRelease(this.breathVisual,this.breathDepth,s,.28,1.4);const T=((l>0?l/60:2)*(.45+.4*this.entropyPulse)+.6*this.loud+.3*this.texture)*(.2+.8*this.breathGate);this.breathPhase+=s*T*Math.PI*2,this.breathPhase>4e3*Math.PI&&(this.breathPhase-=4e3*Math.PI);const R=.07*(t?.stereoBalance??0)*(.7+.2*this.clamp(Number(t?.midSideRatio)||0,0,3)+.3*this.entropyPulse);this.parallax=this.attackRelease(this.parallax,R,s,.08,.6),this.dropGlow=this.attackRelease(this.dropGlow,i?1:0,s,.04,.8),this.paletteShiftCooldown=Math.max(0,this.paletteShiftCooldown-s),(h.melodyChange&&h.melodyChangeScore>.9||t?.snareHit&&this.paletteShiftCooldown<=0)&&(this.sectionHue=(this.sectionHue+50+Math.round(100*Math.random()))%360,this.paletteShiftCooldown=.45,this._advancePalette());const $=this.clamp(.18+.55*this.loud+.2*this.texture,.18,.78);this.sliceMorph=this.attackRelease(this.sliceMorph,$,s,.25,1.2),this._paintBuffer(t)}onRender(){const t=this.ctx,e=this.width,s=this.height;if(!t)return;const h=this._palette||{},i=Number.isFinite(h.baseHue)?h.baseHue:this.sectionHue%360;t.fillStyle=this.config.backgroundColor,t.fillRect(0,0,e,s),t.imageSmoothingEnabled=!1;const a=.5*e+this.parallax*e*.15,o=.5*s,r=this.breathVisual,l=r*Math.cos(this.breathPhase)*Math.min(e,s)*.06,n=1+.16*r*Math.sin(this.breathPhase),c=1+.11*r*Math.sin(this.breathPhase+.33*Math.PI);t.save(),t.translate(a,o+l),t.scale(this.zoom*n,this.zoom*c),t.rotate(this.rotation+.06*r*Math.sin(.5*this.breathPhase));const d=Math.max(3,0|this.sliceCount),p=2*Math.PI/d,u=.5*p,f=this.buffer,b=this._bufferLogicalWidth||f.width,m=this._bufferLogicalHeight||f.height;if(!b||!m)return void t.restore();const S=Math.min(e,s)/Math.min(b,m)*1.15;for(let e=0;e<d;e++){const s=e*p;t.save(),t.rotate(s),this._drawWedge(t,f,b,m,S,u,!1),t.restore(),t.save(),t.rotate(s+p),this._drawWedge(t,f,b,m,S,u,!0),t.restore()}t.restore();const M=.75*Math.max(e,s),g=.5*e,P=.5*s,w=(h.scheme||{}).bloomShift??60,_=this.clamp(.6*this.dropGlow+.5*this.entropyPulse+.2*this.loud+.3*r,0,1);if(_>.02){const h=t.createRadialGradient(g,P,0,g,P,M*(.7+.3*this.zoom*n)),a=(i+w+60*this.dropGlow+80*this.entropyPulse)%360;h.addColorStop(0,`hsla(${a} 94% 78% / ${.22*_})`),h.addColorStop(.6,`hsla(${(a+150)%360} 88% 58% / ${.16*_})`),h.addColorStop(1,"rgba(0,0,0,0)"),t.save(),t.globalCompositeOperation="screen",t.fillStyle=h,t.fillRect(0,0,e,s),t.restore()}const y=this.clamp(.28+.1*this.dropGlow-.05*Math.sin(this.breathPhase)*r,.12,.55),x=t.createRadialGradient(g,P,M*y,g,P,M);x.addColorStop(0,"rgba(0,0,0,0)"),x.addColorStop(1,"rgba(0,0,0,0.65)"),t.fillStyle=x,t.fillRect(0,0,e,s)}_advancePalette(){if(!Array.isArray(this.paletteLUT)||0===this.paletteLUT.length)return;if(1===this.paletteLUT.length)return void(this.paletteIndex=0);const t=this.paletteLUT.length;let e=this.paletteIndex;const s=1+Math.floor(Math.random()*(t-1));e=(this.paletteIndex+s)%t,this.paletteIndex=e}_drawWedge(t,e,s,h,i,a,o=!1){t.beginPath(),t.moveTo(0,0);const r=Math.max(this.width,this.height);t.lineTo(Math.cos(-a)*r,Math.sin(-a)*r),t.lineTo(Math.cos(+a)*r,Math.sin(+a)*r),t.closePath(),t.save(),t.clip(),t.translate(0,0),t.rotate(-a),o&&t.scale(1,-1),t.rotate(a),t.save(),t.translate(.5*-s,.5*-h),t.scale(i,i),t.drawImage(e,0,0,e.width,e.height,0,0,s,h),t.restore(),t.restore()}}window.KaleidoscopeVisualizer=KaleidoscopeVisualizer;