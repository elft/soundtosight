class KaleidoscopeVisualizer extends BaseVisualizer{static meta={description:"Prismatic kaleidoscope: mirrored wedges that breathe with loudness and bloom on drops.",tags:["kaleidoscope","psychedelic","symmetric","mesmerizing","mobile-friendly"]};constructor(t=null,e={}){super(t,{backgroundColor:"#05060a",force2d:!0,...e}),this.prevT=.001*performance.now(),this.loud=0,this.texture=0,this.brightness=0,this.sectionHue=360*Math.random()|0,this.sliceCountBase=8,this.sliceCountTarget=8,this.sliceCount=8,this.sliceMorph=0,this.sliceMorphTarget=.25,this.sliceCountSlew=8,this.zoom=1,this.rotation=0,this.rotSpeed=.12,this.parallax=0,this.swirlPhase=0,this.entropyPulse=0,this.sliceOverdrive=0,this.breathPhase=0,this.breathDepth=0,this.breathGate=0,this.breathVisual=0,this.paletteLUT=[{baseShift:0,accentShift:150,shadowShift:280,bloomShift:70,baseSat:.9,accentSat:.86,accentLight:36,shadowSat:.96},{baseShift:-45,accentShift:210,shadowShift:120,bloomShift:110,baseSat:.88,accentSat:.94,accentLight:40,shadowSat:.9},{baseShift:60,accentShift:260,shadowShift:180,bloomShift:-30,baseSat:.92,accentSat:.8,accentLight:28,shadowSat:.98},{baseShift:25,accentShift:320,shadowShift:230,bloomShift:160,baseSat:.95,accentSat:.88,accentLight:34,shadowSat:.92}],this.paletteIndex=Math.floor(Math.random()*this.paletteLUT.length),this.paletteNoisePhase=Math.random()*Math.PI*2,this.paletteSeed=Math.random()*Math.PI*2,this.paletteWarpValue=0,this._palette={baseHue:0,accentHue:0,shadowHue:0,scheme:null},this._prevDropStart=!1,this.dropGlow=0,this.paletteShiftCooldown=0,this.buffer=document.createElement("canvas"),this.bctx=this.buffer.getContext("2d"),this._bars=new Float32Array(64),this._resizeBuffer()}onResize(){this._resizeBuffer()}_resizeBuffer(){const t=Math.max(256,Math.floor(.35*this.width)),e=Math.max(256,Math.floor(.35*this.height));this.buffer.width=t,this.buffer.height=e,this.bctx.setTransform(1,0,0,1,0,0)}_db01(t,e=-60,s=0){return this.dbTo01(Number.isFinite(t)?t:e,e,s)}_downsample(t,e=64){if(!t||!t.length)return this._bars.fill(0),this._bars;const s=t.length,h=Math.floor(s/e);for(let a=0;a<e;a++){let i=0;const o=a*h,r=a===e-1?s:o+h;for(let e=o;e<r;e++)t[e]>i&&(i=t[e]);this._bars[a]=i/255}return this._bars}_paintBuffer(t){const e=this.bctx,s=this.buffer.width,h=this.buffer.height;e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,s,h);const a=Math.max(32,Math.hypot(.5*s,.5*h)),i=.5*s,o=.5*h,r=e.createRadialGradient(i,o,0,i,o,a),l=Array.isArray(this.paletteLUT)&&this.paletteLUT.length?this.paletteLUT[this.paletteIndex%this.paletteLUT.length]:{baseShift:0,accentShift:150,shadowShift:280,bloomShift:70,baseSat:.9,accentSat:.84,accentLight:34,shadowSat:.94},n=(this.sectionHue+24*this.brightness+140*this.entropyPulse+(l.baseShift??0)+(this.paletteWarpValue||0))%360,c=(n+(l.accentShift??150)+25*this.texture)%360,d=(n+(l.shadowShift??280)+35*this.breathGate)%360,p=Math.round(100*(l.baseSat??.9)),u=Math.round(100*(l.accentSat??.84)),b=Math.round(100*(l.shadowSat??.94)),m=Math.min(92,24+44*this.loud),f=Math.min(72,Math.max(20,(l.accentLight??34)+12*this.brightness));this._palette=this._palette||{},this._palette.baseHue=n,this._palette.accentHue=c,this._palette.shadowHue=d,this._palette.scheme=l,r.addColorStop(0,`hsl(${n} ${p}% ${m}% / 0.22)`),r.addColorStop(.45,`hsl(${c} ${u}% ${f}% / 0.35)`),r.addColorStop(1,`hsl(${d} ${b}% 6% / 0.92)`),e.fillStyle=r,e.fillRect(0,0,s,h);const M=t?.smoothedSpectrum?.length?t.smoothedSpectrum:this._downsample(t?.frequencyLeft,this._bars.length),S=t?.peakSpectrum&&t.peakSpectrum.length===M.length?t.peakSpectrum:null,P=i,g=o,w=24+Math.round(24*this.sliceMorph),y=Math.min(s,h)*(.28+.18*this.loud+.1*this.texture);e.save(),e.translate(P,g),e.rotate(.8*this.rotation),e.lineWidth=1+2.5*(.4+this.loud),e.shadowBlur=10+28*(this.dropGlow+this.loud),e.shadowColor=`hsl(${(n+90)%360} 95% 68%)`;const x=72+20*this.entropyPulse,C=40+25*this.loud;e.strokeStyle=`hsl(${(c+30)%360} ${x}% ${C}%)`,e.beginPath();for(let t=0;t<=w;t++){const s=t/w,h=Math.floor(s*(M.length-1)),a=M[h]??0,i=S?Math.max(a,S[h]||0):a,o=3+5*this.sliceMorph,r=s*Math.PI*2,l=y*(1+.35*Math.cos(o*r))*(.55+.75*i),n=l*Math.cos(r),c=l*Math.sin(r);0===t?e.moveTo(n,c):e.lineTo(n,c)}e.closePath(),e.stroke();const v=2+Math.round(4*this.entropyPulse+2*this.breathGate);if(v>0){const t=3+5*this.sliceMorph,s=.12+.22*(this.loud+this.entropyPulse);e.save(),e.globalCompositeOperation="screen";for(let h=0;h<v;h++){const a=this.swirlPhase+.85*h,i=(n+40*h+180*this.entropyPulse)%360,o=70+20*this.entropyPulse,r=Math.min(88,44+30*(this.brightness+this.breathGate)),l=Math.min(.88,s*(.6+h/v));e.lineWidth=.8+1.6*(h/v+.5*this.texture),e.strokeStyle=`hsla(${i} ${o}% ${r}% / ${l})`,e.shadowColor=`hsla(${(i+160)%360} 95% 68% / ${.35+.35*this.breathGate})`,e.shadowBlur=12+24*(this.breathGate+this.entropyPulse),e.beginPath();const c=84;for(let s=0;s<=c;s++){const h=s/c,i=h*Math.PI*2,o=M[Math.floor(h*(M.length-1))]??0,r=Math.sin(i*t+a)*(.3+.45*this.entropyPulse),l=y*(.4+.38*o+.22*this.texture)+r*y,n=l*Math.cos(i),d=l*Math.sin(i);0===s?e.moveTo(n,d):e.lineTo(n,d)}e.closePath(),e.stroke()}e.restore()}const _=this.clamp(this.breathVisual,0,1);if(_>.02){const t=3+Math.round(4*_),s=.5+.5*this.clamp(.5*Math.sin(this.breathPhase)+.5,0,1);e.save(),e.globalCompositeOperation="screen";for(let h=0;h<t;h++){const a=h/Math.max(1,t-1),i=h%2==0?1:-1,o=this.breathPhase*(1.2+.15*h),r=.22*Math.sin(o+a*Math.PI*1.5)*_,l=y*(.35+.4*a+.18*s+.22*r),n=4+16*_*(.35+.65*(1-a)),d=(c+95*a+55*r)%360,p=.14+.26*_*(1-.6*a);e.strokeStyle=`hsla(${d} ${78+18*this.entropyPulse}% ${58+22*(1-a)}% / ${p})`,e.lineWidth=n,e.shadowBlur=16+36*_*(1-a),e.shadowColor=`hsla(${(d+100)%360} 95% 76% / ${.35+.3*_})`,e.beginPath();for(let t=0;t<=96;t++){const s=t/96*Math.PI*2,h=l*(1+.05*Math.sin(s*(2.6+1.3*this.sliceMorph)+o*i)*(.4+_)),a=h*Math.cos(s),r=h*Math.sin(s);0===t?e.moveTo(P+a,g+r):e.lineTo(P+a,g+r)}e.closePath(),e.stroke()}e.restore()}e.restore()}onUpdate(t){const e=.001*performance.now(),s=this.clamp(e-this.prevT,1/240,.1);this.prevT=e;const h=this.audioTriggers||{},a=h.dropStart||h.dropBloom,i=Boolean(h.dropStart);i&&!this._prevDropStart&&this._advancePalette(),this._prevDropStart=i;const o=Number.isFinite(t?.loudnessShortDb)?t.loudnessShortDb:t?.aWeighted?.mono?.db??-60,r=this._db01(o);this.loud=this.attackRelease(this.loud,r,s,.06,.45);const l=t?.tempo??120,n=t?.tempoConfidence??0,c=t?.percussiveRatio??0;this.texture=this.attackRelease(this.texture,c,s,.06,.35);const d=(t?.spectralRolloff85??t?.centroid??0)/(this.width,2e4);this.brightness=this.attackRelease(this.brightness,this.clamp(d,0,1),s,.1,.65);const p=this.clamp(Number(t?.spectralEntropy)||0,0,1);this.entropyPulse=this.attackRelease(this.entropyPulse,p,s,.08,.6);const u=a?1:0,b=this.clamp(Number(t?.energyChangeIntensity)||0,0,1),m=Boolean(t?.isMassiveEnergyChange)||b>.12||u>0;this.breathGate=this.attackRelease(this.breathGate,m?1:0,s,.08,.8),this.paletteNoisePhase+=s*(.25+.7*this.entropyPulse+.45*this.loud);const f=Math.sin(this.paletteNoisePhase+this.paletteSeed)+.45*Math.sin(.63*this.paletteNoisePhase+1.7*this.paletteSeed)+.32*Math.sin(1.27*this.paletteNoisePhase+2.3*this.paletteSeed),M=(28+60*this.entropyPulse)*(.25+.75*this.breathGate);this.paletteWarpValue=this.clamp(f*M,-180,180),this.sliceOverdrive=this.attackRelease(this.sliceOverdrive,.45*this.entropyPulse+.35*this.texture,s,.25,1.2);const S=(n>.6?l>=140?14:l>=110?12:10:8)+Math.round(2*this.brightness)+Math.round(4*this.sliceOverdrive);this.sliceCountTarget=this.clamp(S,6,22),this.sliceCountSlew=this.attackRelease(this.sliceCountSlew,this.sliceCountTarget,s,.45,1.8);const P=Math.max(3,Math.round(this.sliceCountSlew));P!==this.sliceCount&&(this.sliceCount=P);const g=1+.08*(t?.isBeat?1:0)+.18*this.loud;this.zoom=this.attackRelease(this.zoom,g,s,.12,.8);const w=(.08+.35*this.brightness+.25*this.loud)*(1+.3*this.texture);this.rotSpeed=this.attackRelease(this.rotSpeed,w,s,.3,1.35),this.rotation+=this.rotSpeed*s;const y=this.clamp((Number(t?.dominantFreqPrecise??t?.dominantFreq)||0)/800,0,4),x=.35+.85*this.loud+1*this.brightness+.7*this.texture+.5*this.entropyPulse+.4*y;this.swirlPhase+=x*s,this.swirlPhase>2e3*Math.PI&&(this.swirlPhase-=2e3*Math.PI),this.rotation>2e3*Math.PI&&(this.rotation-=2e3*Math.PI);const C=this.clamp(Number(t?.beatPhase)||0,0,1),v=.5-.5*Math.cos(C*Math.PI*2),_=this.clamp(.45*this.loud+.25*this.texture+.35*this.entropyPulse+.15*v,0,1)*this.breathGate;this.breathDepth=this.attackRelease(this.breathDepth,_,s,.18,.55),this.breathVisual=this.attackRelease(this.breathVisual,this.breathDepth,s,.28,1.4);const T=((l>0?l/60:2)*(.45+.4*this.entropyPulse)+.6*this.loud+.3*this.texture)*(.2+.8*this.breathGate);this.breathPhase+=s*T*Math.PI*2,this.breathPhase>4e3*Math.PI&&(this.breathPhase-=4e3*Math.PI);const $=.07*(t?.stereoBalance??0)*(.7+.2*this.clamp(Number(t?.midSideRatio)||0,0,3)+.3*this.entropyPulse);this.parallax=this.attackRelease(this.parallax,$,s,.08,.6),this.dropGlow=this.attackRelease(this.dropGlow,a?1:0,s,.04,.8),this.paletteShiftCooldown=Math.max(0,this.paletteShiftCooldown-s),(h.melodyChange&&h.melodyChangeScore>.9||t?.snareHit&&this.paletteShiftCooldown<=0)&&(this.sectionHue=(this.sectionHue+50+Math.round(100*Math.random()))%360,this.paletteShiftCooldown=.45,this._advancePalette());const k=this.clamp(.18+.55*this.loud+.2*this.texture,.18,.78);this.sliceMorph=this.attackRelease(this.sliceMorph,k,s,.25,1.2),this._paintBuffer(t)}onRender(){const t=this.ctx,e=this.width,s=this.height;if(!t)return;const h=this._palette||{},a=Number.isFinite(h.baseHue)?h.baseHue:this.sectionHue%360;t.fillStyle=this.config.backgroundColor,t.fillRect(0,0,e,s);const i=.5*e+this.parallax*e*.15,o=.5*s,r=this.breathVisual,l=r*Math.cos(this.breathPhase)*Math.min(e,s)*.06,n=1+.16*r*Math.sin(this.breathPhase),c=1+.11*r*Math.sin(this.breathPhase+.33*Math.PI);t.save(),t.translate(i,o+l),t.scale(this.zoom*n,this.zoom*c),t.rotate(this.rotation+.06*r*Math.sin(.5*this.breathPhase));const d=Math.max(3,0|this.sliceCount),p=2*Math.PI/d,u=.5*p,b=this.buffer,m=b.width,f=b.height,M=Math.min(e,s)/Math.min(m,f)*1.15;for(let e=0;e<d;e++){const s=e*p;t.save(),t.rotate(s),this._drawWedge(t,b,m,f,M,u,!1),t.restore(),t.save(),t.rotate(s+p),this._drawWedge(t,b,m,f,M,u,!0),t.restore()}t.restore();const S=.75*Math.max(e,s),P=.5*e,g=.5*s,w=(h.scheme||{}).bloomShift??60,y=this.clamp(.6*this.dropGlow+.5*this.entropyPulse+.2*this.loud+.3*r,0,1);if(y>.02){const h=t.createRadialGradient(P,g,0,P,g,S*(.7+.3*this.zoom*n)),i=(a+w+60*this.dropGlow+80*this.entropyPulse)%360;h.addColorStop(0,`hsla(${i} 94% 78% / ${.22*y})`),h.addColorStop(.6,`hsla(${(i+150)%360} 88% 58% / ${.16*y})`),h.addColorStop(1,"rgba(0,0,0,0)"),t.save(),t.globalCompositeOperation="screen",t.fillStyle=h,t.fillRect(0,0,e,s),t.restore()}const x=this.clamp(.28+.1*this.dropGlow-.05*Math.sin(this.breathPhase)*r,.12,.55),C=t.createRadialGradient(P,g,S*x,P,g,S);C.addColorStop(0,"rgba(0,0,0,0)"),C.addColorStop(1,"rgba(0,0,0,0.65)"),t.fillStyle=C,t.fillRect(0,0,e,s)}_advancePalette(){if(!Array.isArray(this.paletteLUT)||0===this.paletteLUT.length)return;if(1===this.paletteLUT.length)return void(this.paletteIndex=0);const t=this.paletteLUT.length;let e=this.paletteIndex;const s=1+Math.floor(Math.random()*(t-1));e=(this.paletteIndex+s)%t,this.paletteIndex=e}_drawWedge(t,e,s,h,a,i,o=!1){t.beginPath(),t.moveTo(0,0);const r=Math.max(this.width,this.height);t.lineTo(Math.cos(-i)*r,Math.sin(-i)*r),t.lineTo(Math.cos(+i)*r,Math.sin(+i)*r),t.closePath(),t.save(),t.clip(),t.translate(0,0),t.rotate(-i),o&&t.scale(1,-1),t.rotate(i),t.save(),t.translate(.5*-s,.5*-h),t.scale(a,a),t.drawImage(e,0,0),t.restore(),t.restore()}}window.KaleidoscopeVisualizer=KaleidoscopeVisualizer;